<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AllergyAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.allergies</a> &gt; <span class="el_source">AllergyAction.java</span></div><h1>AllergyAction.java</h1><pre class="source lang-java linenums">package com.pkb.action.allergies;

import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.action.ConsentCategoryBaseAction;
import com.pkb.action.message.ComposeMessageAction;
import com.pkb.action.support.AllergyGroupTransformer;
import com.pkb.allergy.entity.Allergy;
import com.pkb.allergy.entity.AllergyReaction;
import com.pkb.allergy.entity.AllergySeverity;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.bean.IMessageWebBean;
import com.pkb.code.Coded;
import com.pkb.coding.entity.CodeableConcept;
import com.pkb.coding.entity.Coding;
import com.pkb.dto.AllergyGroupDto;
import com.pkb.entities.enums.MenuDataType;
import com.pkb.institute.entity.Team;
import com.pkb.notification.entity.Activity;
import com.pkb.service.allergy.impl.AllergyManager;
import com.pkb.service.datapoint.DataWithUIPermissions;
import com.pkb.service.user.impl.UserManager;
import io.vavr.control.Either;
import org.apache.struts2.interceptor.validation.SkipValidation;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import java.lang.invoke.MethodHandles;
import java.text.ParseException;
import java.time.Instant;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.Date;
import java.util.List;
import java.util.Objects;
import java.util.Optional;
import java.util.UUID;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import static com.pkb.user.entity.PKBPerson.Lazy.CONTACTS;
import static java.util.stream.Collectors.toList;
import static org.apache.commons.collections4.CollectionUtils.isEmpty;
import static org.apache.commons.lang3.StringUtils.isBlank;


<span class="fc" id="L54">public class AllergyAction extends ConsentCategoryBaseAction {</span>

    private static final long serialVersionUID = 1L;

<span class="fc" id="L58">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>
<span class="fc" id="L59">    private static final Pattern ALLERGEN_CODE_PATTERN = Pattern.compile(Allergy.ALLERGEN_CODE, Pattern.LITERAL);</span>
<span class="fc" id="L60">    private static final Pattern REACTION_CODE_PATTERN = Pattern.compile(Allergy.REACTION_CODE, Pattern.LITERAL);</span>
<span class="fc" id="L61">    private static final Pattern SEVERITY_CODE_PATTERN = Pattern.compile(Allergy.SEVERITY_CODE, Pattern.LITERAL);</span>

    private AllergyManager allergyManager;
    private IMessageWebBean messageWebBean;
    @Autowired
    private AllergyGroupTransformer allergyGroupTransformer;

    // Tabs
    public String getTab() {
<span class="fc" id="L70">        return &quot;health&quot;;</span>
    }

    public String getSubTab() {
<span class="fc" id="L74">        return &quot;allergies&quot;;</span>
    }

    private String discussMessage;
    private String discussTopic;

    // To viewAllergies.jsp
    private List&lt;DataWithUIPermissions&lt;Allergy&gt;&gt; allergies;
    private List&lt;AllergyGroupDto&gt; allergyGroups;
    // From viewAllergies.jsp
    private List&lt;Long&gt; allergyIds;
    // To addAllergy.jsp
    private List&lt;String&gt; reactions;
    private List&lt;String&gt; severities;
    // From addAllergy.jsp
    private Long id;
    // From editPrivacyFlags.jsp
    private Long dataPointId;
    private Allergy allergy;
    private String onsetOfSymptoms;
    private String allergen;
    private String reaction;
    private String severity;
    private UUID uniqueId;
    private DateTimeFormatter dateFormat;
    private Long loggedUserId;
    private Long patientId;
    private Long patientAccountId;
    private boolean callerIsClinician;
    private Long callerTeamId;

    private BaseAction.Users findUsers() {
<span class="fc" id="L106">        var users = getContextAndLoggedInUsers(CONTACTS);</span>
<span class="fc" id="L107">        loggedUserId = users.loggedInUser().getId();</span>
<span class="fc" id="L108">        patientId = users.contextUser().getId();</span>
<span class="fc" id="L109">        patientAccountId = userManager.getDefaultAccountId(patientId);</span>

<span class="fc" id="L111">        callerIsClinician = isLoggedInUserProfessional();</span>

<span class="fc" id="L113">        Team callerTeam = loggedInUserUtil.getLoggedInUserPrimaryTeam();</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">        callerTeamId = callerTeam == null ? null : callerTeam.getId();</span>
<span class="fc" id="L115">        return users;</span>
    }

    public String viewAllergies() throws Exception {
<span class="fc" id="L119">        var users = findUsers();</span>

<span class="fc" id="L121">        LoggedInEHRRequestContext context = getLoggedInEHRRequestContext();</span>

<span class="fc" id="L123">        List&lt;Allergy&gt; allAllergies = allergyGroupTransformer.transformAllergy(allergyManager</span>
<span class="fc" id="L124">                .getAllergies(context, patientId, patientAccountId, 0, -1, false/*includeNegativeAllergies*/));</span>

<span class="fc" id="L126">        List&lt;DataWithUIPermissions&lt;Allergy&gt;&gt; allergiesWithPermissions = dataPointManager.getPermissions(allAllergies, context);</span>

<span class="fc" id="L128">        allergies = allergiesWithPermissions.stream()</span>
<span class="fc" id="L129">                .sorted(BY_SYMPTOM_ONSET_OR_NOTED.reversed())</span>
<span class="fc" id="L130">                .collect(toList());</span>

<span class="fc" id="L132">        allergyGroups = allergyGroupTransformer.groupByReverseLastActiveDateAndAlphabetical(allergiesWithPermissions);</span>

<span class="fc" id="L134">        return Action.SUCCESS;</span>
    }

<span class="fc" id="L137">    public static final Comparator&lt;DataWithUIPermissions&lt;Allergy&gt;&gt; BY_SYMPTOM_ONSET_OR_NOTED = AllergyAction::compareAllergiesByActivity;</span>

    private static int compareAllergiesByActivity(DataWithUIPermissions&lt;Allergy&gt; a, DataWithUIPermissions&lt;Allergy&gt; b) {
<span class="fc" id="L140">        Instant dateA = getInstantForSymptomComparison(a);</span>
<span class="fc" id="L141">        Instant dateB = getInstantForSymptomComparison(b);</span>
<span class="fc" id="L142">        int dateComparison = date(dateA).compareTo(date(dateB));</span>

<span class="fc bfc" id="L144" title="All 2 branches covered.">        if (dateComparison == 0) {</span>
<span class="fc" id="L145">            return a.getData().getId().compareTo(b.getData().getId());</span>
        }

<span class="fc" id="L148">        return dateComparison;</span>
    }

    private static Instant getInstantForSymptomComparison(DataWithUIPermissions&lt;Allergy&gt; input) {
<span class="fc" id="L152">        return Optional.ofNullable(input.getData().getDateAsserted())</span>
<span class="fc" id="L153">                .map(Date::toInstant)</span>
<span class="fc" id="L154">                .orElse(Optional.ofNullable(input.getData().getOnsetOfSymptoms())</span>
<span class="fc" id="L155">                        .map(Date::toInstant)</span>
<span class="fc" id="L156">                        .orElse(null));</span>
    }

    private static Instant date(Instant d) {
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        if (d != null) {</span>
<span class="fc" id="L161">            return d;</span>
        }
<span class="nc" id="L163">        return Instant.MIN;</span>
    }

    public String getAllergyForm() {
<span class="fc" id="L167">        id = null;</span>
<span class="fc" id="L168">        onsetOfSymptoms = dateFormat.format(dateTimeService.nowLocalDateTime());</span>
<span class="fc" id="L169">        setDefaultFlag();</span>
<span class="fc" id="L170">        return Action.SUCCESS;</span>
    }

    public String discussAllergies() {
<span class="fc" id="L174">        findUsers();</span>

<span class="pc bpc" id="L176" title="1 of 2 branches missed.">        if (isEmpty(allergyIds)) {</span>
<span class="nc" id="L177">            addActionError(getText(&quot;allergyAction.err.select_at_least_one&quot;));</span>
<span class="nc" id="L178">            return RELOAD;</span>
        }

<span class="fc" id="L181">        allergies = allergyManager.getAllergies(getLoggedInEHRRequestContext(), patientId, patientAccountId, allergyIds)</span>
<span class="fc" id="L182">                .stream().map(DataWithUIPermissions::new).collect(toList());</span>

<span class="fc" id="L184">        StringBuilder messageText = new StringBuilder();</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">        for (DataWithUIPermissions&lt;Allergy&gt; allergy : allergies) {</span>
<span class="fc" id="L186">            String onsetDateText = Optional.ofNullable(allergy.getData().getOnsetOfSymptoms())</span>
<span class="fc" id="L187">                    .map(date -&gt; dateFormat.format(date.toInstant()))</span>
<span class="fc" id="L188">                    .orElse(getText(&quot;global.txt.unavailable&quot;));</span>
<span class="fc" id="L189">            String allergenText = Optional.ofNullable(allergy.getData().getAllergen())</span>
<span class="fc" id="L190">                    .map(concept -&gt; &quot;\n&quot; + getText(&quot;allergyAction.msg.allergen&quot;) + &quot;: &quot; + concept.getTextForDisplay())</span>
<span class="fc" id="L191">                    .orElse(&quot;&quot;);</span>
<span class="fc" id="L192">            String disorderText = Optional.ofNullable(allergy.getData().getDisorder())</span>
<span class="pc" id="L193">                    .map(concept -&gt; &quot;\n&quot; + concept.getTextForDisplay())</span>
<span class="fc" id="L194">                    .orElse(&quot;&quot;);</span>
<span class="fc" id="L195">            String severityText = Optional.ofNullable(allergy.getData().getSeverity())</span>
<span class="fc" id="L196">                    .map(concept -&gt; &quot;\n&quot; + getText(&quot;allergyAction.msg.severity&quot;) + &quot;: &quot; + concept.getTextForDisplay())</span>
<span class="fc" id="L197">                    .orElse(&quot;&quot;);</span>

<span class="fc" id="L199">            messageText.append(&quot;\n\n&quot; + getText(&quot;allergyAction.msg.started&quot;) + &quot;: &quot; + onsetDateText);</span>
<span class="fc" id="L200">            messageText.append(allergenText);</span>
<span class="fc" id="L201">            messageText.append(disorderText);</span>
<span class="pc bpc" id="L202" title="1 of 2 branches missed.">            if (allergy.getData().getReactions() != null) { // todo: some old data seems to have null instead of an empty list</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">                for (CodeableConcept reaction : allergy.getData().getReactions()) {</span>
<span class="fc" id="L204">                    messageText.append(&quot;\n&quot; + getText(&quot;allergyAction.msg.reaction&quot;) + &quot;: &quot; + reaction.getDisplayText());</span>
<span class="fc" id="L205">                }</span>
            }
<span class="fc" id="L207">            messageText.append(severityText);</span>
<span class="fc" id="L208">        }</span>

<span class="fc" id="L210">        discussMessage = messageText.toString();</span>
<span class="fc" id="L211">        discussTopic = ComposeMessageAction.TOPIC_ALLERGIES;</span>
<span class="fc" id="L212">        sessionUtil.setContextRecipientId(getLoggedInEHRRequestContext());</span>
<span class="fc" id="L213">        return DISCUSS;</span>
    }

    public String deleteAllergy() {
<span class="pc bpc" id="L217" title="2 of 4 branches missed.">        if ((id == null) || (id == 0)) {</span>
<span class="nc" id="L218">            return RELOAD;</span>
        }

<span class="fc" id="L221">        findUsers();</span>
<span class="fc" id="L222">        List&lt;Long&gt; idAsList = Collections.singletonList(id);</span>
<span class="fc" id="L223">        allergies = allergyManager.getAllergies(getLoggedInEHRRequestContext(), patientId, patientAccountId, idAsList)</span>
<span class="fc" id="L224">                .stream().map(DataWithUIPermissions::new).collect(toList());</span>
<span class="fc" id="L225">        return &quot;confirmDelete&quot;;</span>
    }

    public String confirmDeleteAllergies() {
<span class="fc" id="L229">        findUsers();</span>
<span class="fc" id="L230">        SourceDetails deletedBy = new SourceDetails();</span>
<span class="fc" id="L231">        deletedBy.init(getEHRRequestContext());</span>
<span class="fc" id="L232">        Instant deletionDate = dateTimeService.now();</span>
<span class="fc" id="L233">        allergyManager.transactional(() -&gt; {</span>
<span class="fc" id="L234">            List&lt;Allergy&gt; allergies = allergyManager.deleteAllergies(getLoggedInEHRRequestContext(), patientAccountId, allergyIds, deletedBy, deletionDate);</span>
<span class="fc" id="L235">            allergies.forEach(allergy -&gt; logActivityByOthers(Activity.Action.DELETED_ALLERGY, dateTimeService.now(), true, allergy, getLoggedInEHRRequestContext()));</span>
<span class="fc" id="L236">        });</span>
<span class="fc" id="L237">        return Action.SUCCESS;</span>
    }

    public String cancelDeleteAllergies() {
<span class="fc" id="L241">        return Action.SUCCESS;</span>
    }

    public String addAllergy() {
<span class="fc" id="L245">        findUsers();</span>
<span class="fc" id="L246">        refillPrivacyFlags();</span>

<span class="fc" id="L248">        boolean errors = false;</span>

<span class="fc" id="L250">        Date onset = null;</span>
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">        if (isBlank(onsetOfSymptoms)) {</span>
<span class="nc" id="L252">            addFieldError(&quot;onsetOfSymptoms&quot;, getText(&quot;allergyAction.err.invalid_date&quot;));</span>
<span class="nc" id="L253">            errors = true;</span>
        } else {
            try {
<span class="fc" id="L256">                onset = parseDate(onsetOfSymptoms);</span>
<span class="fc" id="L257">            } catch (ParseException ignored) {</span>
<span class="fc" id="L258">                addFieldError(&quot;onsetOfSymptoms&quot;, getText(&quot;allergyAction.err.invalid_date&quot;));</span>
<span class="fc" id="L259">                errors = true;</span>
<span class="fc" id="L260">            }</span>
        }

<span class="fc bfc" id="L263" title="All 2 branches covered.">        if (isBlank(allergen)) {</span>
<span class="fc" id="L264">            addFieldError(&quot;allergen&quot;, getText(&quot;allergyAction.err.enter_allergen&quot;));</span>
<span class="fc" id="L265">            errors = true;</span>
        }

<span class="fc bfc" id="L268" title="All 2 branches covered.">        if (isBlank(reaction)) {</span>
<span class="fc" id="L269">            addFieldError(&quot;reaction&quot;, getText(&quot;allergyAction.err.enter_reaction&quot;));</span>
<span class="fc" id="L270">            errors = true;</span>
        }

<span class="fc bfc" id="L273" title="All 2 branches covered.">        if (isBlank(severity)) {</span>
<span class="fc" id="L274">            addFieldError(&quot;severity&quot;, getText(&quot;allergyAction.err.enter_severity&quot;));</span>
<span class="fc" id="L275">            errors = true;</span>
        }

<span class="fc bfc" id="L278" title="All 2 branches covered.">        if (errors) {</span>
<span class="fc" id="L279">            disablePrivacyFlagEditForm();</span>
<span class="fc" id="L280">            return &quot;input&quot;;</span>
        }
<span class="fc" id="L282">        EHRRequestContext requestContext = getEHRRequestContext();</span>

<span class="fc" id="L284">        Allergy allergy = new Allergy(new SourceDetails(requestContext));</span>
<span class="fc" id="L285">        allergy.setId(id);</span>
<span class="fc" id="L286">        allergy.setOnsetOfSymptoms(onset);</span>
<span class="fc" id="L287">        allergy.setAllergen(new CodeableConcept.Builder(allergen).build());</span>
<span class="fc" id="L288">        allergy.setReactions(Collections.singletonList(codeableConceptFromString(Arrays.asList(AllergyReaction.values()), reaction)));</span>
<span class="fc" id="L289">        allergy.setSeverity(codeableConceptFromString(Arrays.asList(AllergySeverity.values()), severity));</span>
<span class="fc" id="L290">        allergy.setPatientAccountId(patientAccountId);</span>
<span class="fc" id="L291">        allergy.setAuthorLdapUID(loggedUserId.toString());</span>
<span class="fc" id="L292">        allergy.getBaseFields().setUniqueId(uniqueId);</span>
        // from webapp , the data will be positive
        // the data entered will mean patient is allergic
        // negative data will have a different view
<span class="fc" id="L296">        allergy.setPatientIsAllergic(Boolean.TRUE);</span>

<span class="fc bfc" id="L298" title="All 2 branches covered.">        if (id == null) {</span>
<span class="fc" id="L299">            fillPrivacyFlagIn(allergy);</span>
<span class="fc" id="L300">            allergyManager.transactional(() -&gt; {</span>
<span class="fc" id="L301">                Either&lt;String, UUID&gt; maybeAllergy = allergyManager.saveAllergy(requestContext, allergy);</span>
<span class="fc" id="L302">                maybeAllergy.left().forEach(this::handleExcludedDataPoint);</span>
<span class="fc" id="L303">                maybeAllergy.right().forEach(uniqueId -&gt; {</span>
<span class="fc" id="L304">                    logActivityByOthers(Activity.Action.ADDED_ALLERGY, dateTimeService.now(), true, allergy, getLoggedInEHRRequestContext());</span>
<span class="fc" id="L305">                });</span>
<span class="fc" id="L306">            });</span>
        } else {
<span class="fc" id="L308">            Allergy originalAllergy = allergyManager.getAllergy(requestContext.getLoggedInContext().orElseThrow(), id);</span>
<span class="pc bpc" id="L309" title="1 of 2 branches missed.">            if (hasNotPermissionsToEditDatapoint(allergy, requestContext)) {</span>
<span class="nc" id="L310">                return CANCEL;</span>
            }
<span class="fc" id="L312">            allergy.setPrivacyFlagsFrom(originalAllergy);</span>
<span class="fc" id="L313">            allergyManager.transactional(() -&gt; {</span>
<span class="fc" id="L314">                Either&lt;String, UUID&gt; maybeAllergy = allergyManager.updateAllergy(requestContext, allergy);</span>
<span class="fc" id="L315">                maybeAllergy.left().forEach(this::handleExcludedDataPoint);</span>
<span class="fc" id="L316">                maybeAllergy.right().forEach(uniqueId -&gt; {</span>
<span class="fc" id="L317">                    logActivityByOthers(Activity.Action.UPDATED_ALLERGY, dateTimeService.now(), true, allergy, getLoggedInEHRRequestContext());</span>
<span class="fc" id="L318">                });</span>
<span class="fc" id="L319">            });</span>
        }

        // END transaction
<span class="fc" id="L323">        return Action.SUCCESS;</span>
    }

    private CodeableConcept codeableConceptFromString(Collection&lt;Coded&gt; values, String text) {
<span class="fc" id="L327">        return values.stream()</span>
<span class="fc" id="L328">                .filter(coded -&gt; Objects.equals(getText(coded.getName()), text))</span>
<span class="fc" id="L329">                .map(coded -&gt; new CodeableConcept.Builder(text)</span>
<span class="fc" id="L330">                        .coding(new Coding.Builder(coded.getCode(), coded.getCodeSystemName()).displayText(text).build())</span>
<span class="fc" id="L331">                        .build())</span>
<span class="fc" id="L332">                .findFirst()</span>
<span class="fc" id="L333">                .orElse(new CodeableConcept.Builder(text).build()); // didn't match any enum text; just capture text</span>
    }

    public String editAllergy() {
<span class="fc" id="L337">        findUsers();</span>
<span class="fc" id="L338">        LoggedInEHRRequestContext loggedInEHRRequestContext = getLoggedInEHRRequestContext();</span>
<span class="fc" id="L339">        allergy = allergyManager.getAllergy(loggedInEHRRequestContext, id);</span>
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">        if (hasNotPermissionsToEditDatapoint(allergy, loggedInEHRRequestContext)) {</span>
<span class="nc" id="L341">            return CANCEL;</span>
        }

<span class="pc bpc" id="L344" title="1 of 2 branches missed.">        if (allergy.getOnsetOfSymptoms() == null) {</span>
<span class="nc" id="L345">            onsetOfSymptoms = getText(&quot;global.txt.unavailable&quot;);</span>
        } else {
<span class="fc" id="L347">            onsetOfSymptoms = dateFormat.format(allergy.getOnsetOfSymptoms().toInstant());</span>
        }
<span class="fc" id="L349">        allergen = allergy.getAllergen().getTextForDisplay();</span>
        //        reaction = allergy.getReactions().get(0); // FE can't handle multiple reactions   TODO uh what
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">        if (!allergy.getReactions().isEmpty()) {</span>
<span class="fc" id="L352">            reaction = allergy.getReactions().get(0).getDisplayText();</span>
        }
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">        if (allergy.getSeverity() != null) {</span>
<span class="fc" id="L355">            severity = allergy.getSeverity().getDisplayText();</span>
        }
<span class="fc" id="L357">        uniqueId = allergy.getBaseFields().getUniqueId();</span>
<span class="fc" id="L358">        disablePrivacyFlagEditForm();</span>
<span class="fc" id="L359">        return SUCCESS;</span>
    }

    public String editPrivacyForm() {
<span class="fc" id="L363">        var users = findUsers();</span>
<span class="fc" id="L364">        allergy = allergyManager.getAllergy(getLoggedInEHRRequestContext(), dataPointId);</span>
<span class="pc bpc" id="L365" title="1 of 2 branches missed.">        if (hasNotPermissionsToEditPrivacyLabels(allergy, users.loggedInUser(), loggedInUserUtil.getLoggedInUserPrimaryTeam())) {</span>
<span class="nc" id="L366">            return CANCEL;</span>
        }
<span class="fc" id="L368">        fillPrivacyFlagsFrom(allergy);</span>
<span class="fc" id="L369">        return INPUT;</span>
    }

    @SkipValidation
    public String editPrivacySave() {
<span class="fc" id="L374">        var users = findUsers();</span>
<span class="fc" id="L375">        LoggedInEHRRequestContext context = getLoggedInEHRRequestContext();</span>
<span class="fc" id="L376">        allergy = allergyManager.getAllergy(context, dataPointId);</span>
<span class="pc bpc" id="L377" title="1 of 2 branches missed.">        if (hasNotPermissionsToEditPrivacyLabels(allergy, users.loggedInUser(), loggedInUserUtil.getLoggedInUserPrimaryTeam())) {</span>
<span class="nc" id="L378">            return CANCEL;</span>
        }
<span class="fc" id="L380">        privacyService.handlePrivacyChange(allergy, MenuDataType.allergy, getNewFlag(), context, patientAccountId,</span>
<span class="fc" id="L381">                users.contextUser(), users.loggedInUser());</span>
<span class="fc" id="L382">        return SUCCESS;</span>
    }

    @SkipValidation
    public String editPrivacyCancel() {
<span class="fc" id="L387">        return CANCEL;</span>
    }

    public String cancel() {
<span class="fc" id="L391">        return Action.SUCCESS;</span>
    }

    public void setAllergyManager(AllergyManager allergyManager) {
<span class="fc" id="L395">        this.allergyManager = allergyManager;</span>
<span class="fc" id="L396">    }</span>

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L399">        this.userManager = userManager;</span>
<span class="fc" id="L400">    }</span>

    public List&lt;DataWithUIPermissions&lt;Allergy&gt;&gt; getAllergies() {
<span class="fc" id="L403">        return allergies;</span>
    }

    public void setAllergies(List&lt;DataWithUIPermissions&lt;Allergy&gt;&gt; allergies) {
<span class="nc" id="L407">        this.allergies = allergies;</span>
<span class="nc" id="L408">    }</span>

    public List&lt;AllergyGroupDto&gt; getAllergyGroups() {
<span class="fc" id="L411">        return allergyGroups;</span>
    }

    public List&lt;String&gt; getReactions() {
<span class="fc" id="L415">        reactions = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L416" title="All 2 branches covered.">        for (AllergyReaction allergyReaction : AllergyReaction.values()) {</span>
<span class="fc" id="L417">            reactions.add(getText(allergyReaction.getName()));</span>
        }
<span class="fc" id="L419">        Collections.sort(reactions);</span>
<span class="fc" id="L420">        return reactions;</span>
    }

    public List&lt;String&gt; getSeverities() {
<span class="fc" id="L424">        severities = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L425" title="All 2 branches covered.">        for (AllergySeverity allergySeverity : AllergySeverity.values()) {</span>
<span class="fc" id="L426">            severities.add(getText(allergySeverity.getName()));</span>
        }
<span class="fc" id="L428">        Collections.sort(severities);</span>
<span class="fc" id="L429">        return severities;</span>
    }

    public Allergy getAllergy() {
<span class="fc" id="L433">        return allergy;</span>
    }

    public void setAllergy(Allergy allergy) {
<span class="nc" id="L437">        this.allergy = allergy;</span>
<span class="nc" id="L438">    }</span>

    public String getOnsetOfSymptoms() {
<span class="fc" id="L441">        return onsetOfSymptoms;</span>
    }

    public void setOnsetOfSymptoms(String onsetOfSymptoms) {
<span class="fc" id="L445">        this.onsetOfSymptoms = onsetOfSymptoms;</span>
<span class="fc" id="L446">    }</span>

    public String getAllergen() {
<span class="fc" id="L449">        return allergen;</span>
    }

    public void setAllergen(String allergen) {
<span class="fc" id="L453">        this.allergen = allergen;</span>
<span class="fc" id="L454">    }</span>

    public String getReaction() {
<span class="fc" id="L457">        return reaction;</span>
    }

    public void setReaction(String reaction) {
<span class="fc" id="L461">        this.reaction = reaction;</span>
<span class="fc" id="L462">    }</span>

    public String getSeverity() {
<span class="fc" id="L465">        return severity;</span>
    }

    public void setSeverity(String severity) {
<span class="fc" id="L469">        this.severity = severity;</span>
<span class="fc" id="L470">    }</span>

    public List&lt;Long&gt; getAllergyIds() {
<span class="fc" id="L473">        return allergyIds;</span>
    }

    public void setAllergyIds(List&lt;Long&gt; allergyIds) {
<span class="fc" id="L477">        this.allergyIds = allergyIds;</span>
<span class="fc" id="L478">    }</span>

    public void setMessageWebBean(IMessageWebBean messageWebBean) {
<span class="fc" id="L481">        this.messageWebBean = messageWebBean;</span>
<span class="fc" id="L482">    }</span>

    public Long getId() {
<span class="fc" id="L485">        return id;</span>
    }

    public void setId(Long id) {
<span class="fc" id="L489">        this.id = id;</span>
<span class="fc" id="L490">    }</span>

    public UUID getUniqueId() {
<span class="fc" id="L493">        return uniqueId;</span>
    }

    public void setUniqueId(UUID uniqueId) {
<span class="fc" id="L497">        this.uniqueId = uniqueId;</span>
<span class="fc" id="L498">    }</span>

    public String getLocalizedClinicalCodes(String clinicalCodes) {

<span class="pc bpc" id="L502" title="1 of 2 branches missed.">        if (clinicalCodes == null) {</span>
<span class="nc" id="L503">            return &quot;&quot;;</span>
        }

<span class="fc" id="L506">        return SEVERITY_CODE_PATTERN</span>
<span class="fc" id="L507">                .matcher(REACTION_CODE_PATTERN.matcher(ALLERGEN_CODE_PATTERN.matcher(clinicalCodes).replaceAll(Matcher.quoteReplacement(getText(&quot;listAllergies.txt.allergen&quot;))))</span>
<span class="fc" id="L508">                        .replaceAll(Matcher.quoteReplacement(getText(&quot;listAllergies.txt.reaction&quot;))))</span>
<span class="fc" id="L509">                .replaceAll(Matcher.quoteReplacement(getText(&quot;listAllergies.txt.severity&quot;)));</span>
    }

    @Override
    public void prepare() throws Exception {
<span class="fc" id="L514">        super.prepare();</span>
<span class="fc" id="L515">        dateFormat = getGlobalDateInputFormatter();</span>
<span class="fc" id="L516">    }</span>

    public Long getDataPointId() {
<span class="fc" id="L519">        return dataPointId;</span>
    }

    public void setDataPointId(Long dataPointId) {
<span class="fc" id="L523">        this.dataPointId = dataPointId;</span>
<span class="fc" id="L524">    }</span>

    public String getDiscussMessage() {
<span class="fc" id="L527">        return discussMessage;</span>
    }

    public void setDiscussMessage(String discussMessage) {
<span class="nc" id="L531">        this.discussMessage = discussMessage;</span>
<span class="nc" id="L532">    }</span>

    public String getDiscussTopic() {
<span class="fc" id="L535">        return discussTopic;</span>
    }

    public void setDiscussTopic(String discussTopic) {
<span class="nc" id="L539">        this.discussTopic = discussTopic;</span>
<span class="nc" id="L540">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>