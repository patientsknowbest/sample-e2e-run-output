<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DeprecatedPatientConsentManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.patientconsent</a> &gt; <span class="el_source">DeprecatedPatientConsentManager.java</span></div><h1>DeprecatedPatientConsentManager.java</h1><pre class="source lang-java linenums">package com.pkb.service.patientconsent;

import com.pkb.app.entity.EHRData;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.consent.entity.PatientConsent;
import com.pkb.consent.entity.PatientConsentReason;
import com.pkb.data.EHRRemote;
import com.pkb.domain.CryptoModelSynchronisationService;
import com.pkb.entities.enums.AccessingEntityType;
import com.pkb.entities.enums.SponsorshipStatus;
import com.pkb.exception.PKBException;
import com.pkb.institute.entity.InstituteUser;
import com.pkb.repository.legacy.LegacyPatientConsentRepository;
import com.pkb.service.instituteuser.InstituteUserManager;
import com.pkb.user.PKBPersonRemote;
import com.pkb.util.tolven.TolvenBeanFactory;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.invoke.MethodHandles;
import java.util.EnumSet;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.UUID;
import java.util.function.Function;

import static org.apache.commons.collections4.CollectionUtils.isNotEmpty;

/**
 * @deprecated Replaced by {@link PatientConsentManager}
 */
@Deprecated
public class DeprecatedPatientConsentManager {
<span class="fc" id="L40">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

    private final DateTimeService dateTimeService;
    private TolvenBeanFactory beanFactory;
    private final LegacyPatientConsentRepository patientConsentRepository;
    private final CryptoModelSynchronisationService cryptoModelSynchronisationService;
    private final InstituteUserManager instituteUserManager;

    public DeprecatedPatientConsentManager(DateTimeService dateTimeService,
                                           TolvenBeanFactory beanFactory,
                                           LegacyPatientConsentRepository patientConsentRepository,
                                           CryptoModelSynchronisationService cryptoModelSynchronisationService,
<span class="fc" id="L52">                                           InstituteUserManager instituteUserManager) {</span>
<span class="fc" id="L53">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L54">        this.beanFactory = beanFactory;</span>
<span class="fc" id="L55">        this.patientConsentRepository = patientConsentRepository;</span>
<span class="fc" id="L56">        this.cryptoModelSynchronisationService = cryptoModelSynchronisationService;</span>
<span class="fc" id="L57">        this.instituteUserManager = instituteUserManager;</span>
<span class="fc" id="L58">    }</span>



    public Long ensureTeamLinkAndUpdatePatientConsentLegacy(@NotNull EHRRequestContext requestContext, PatientConsent consent) {
<span class="fc bfc" id="L63" title="All 2 branches covered.">        if (consent.getAccessingEntityType() == AccessingEntityType.TEAM) {</span>
<span class="fc" id="L64">            long userId = consent.getPatientPersonId();</span>
<span class="fc" id="L65">            Long teamId = consent.getAccessingTeamSlashPersonId();</span>

<span class="fc" id="L67">            InstituteUser instituteUser = instituteUserManager.getInstituteUser(teamId, userId);</span>
<span class="fc bfc" id="L68" title="All 2 branches covered.">            if (instituteUser == null) {</span>
                // Create institute user with appropriate sponsorship status
<span class="fc" id="L70">                instituteUserManager.createInstituteUser(userId, teamId, SponsorshipStatus.ACTIVE);</span>
            }
        }
<span class="fc" id="L73">        long result = updatePatientConsentLegacy(requestContext, consent);</span>
<span class="fc" id="L74">        cryptoModelSynchronisationService.syncCryptoAccessForPerson(consent.getPatientPersonId());</span>
<span class="fc" id="L75">        return result;</span>
    }

    private long updatePatientConsentLegacy(@NotNull EHRRequestContext requestContext, @NotNull PatientConsent consent) {
<span class="fc" id="L79">        PKBPersonRemote personBean = beanFactory.getPKBPersonBean();</span>
<span class="fc" id="L80">        Long patientAccountId = personBean.getDefaultAccountId(consent.getPatientPersonId());</span>

        // be sure the ID is set for a matching PatientConsent for this patient/linktype/entity
<span class="fc bfc" id="L83" title="All 2 branches covered.">        if (consent.getId() == null) {</span>

<span class="fc" id="L85">            findPatientConsentWithoutReasons(</span>
<span class="fc" id="L86">                    consent.getPatientPersonId(), consent.getAccessingTeamSlashPersonId(),</span>
<span class="fc" id="L87">                    consent.getAccessingEntityType()</span>
<span class="fc" id="L88">            ).ifPresent(</span>
                    consenting -&gt; {
<span class="nc" id="L90">                        consent.setId(consenting.getId());</span>
<span class="nc" id="L91">                        consent.setUniqueId(consenting.getUniqueId());</span>
<span class="nc" id="L92">                    });</span>
        }

        // must have a valid uniqueId (some old consent records don't; fix here)
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">        if (consent.getUniqueId() == null) {</span>
<span class="nc" id="L97">            consent.setUniqueId(UUID.randomUUID());</span>
        }

        // save reasons fresh, regardless
<span class="fc bfc" id="L101" title="All 2 branches covered.">        if (consent.getId() != null) {</span>
<span class="fc" id="L102">            consent.setUpdated(dateTimeService.now());</span>
<span class="pc bpc" id="L103" title="2 of 4 branches missed.">        } else if (consent.getAdded() == null || consent.getUpdated() == null) {</span>
<span class="nc" id="L104">            throw new IllegalArgumentException(&quot;PHRZ-263 Added and updated timestamps must not be null!&quot;);</span>
        }

<span class="fc" id="L107">        EHRRemote ehrBean = beanFactory.getEhrRemote();</span>
<span class="fc" id="L108">        EHRData ehrData = ehrBean.populateEHRData(</span>
<span class="fc" id="L109">                consent.getReasons(),</span>
<span class="fc" id="L110">                patientAccountId,</span>
                PatientConsentReason.MS_PATH,
                requestContext);
<span class="fc" id="L113">        ehrData.setDefaultGeneralConsentIfNoneSet();</span>
<span class="fc" id="L114">        ehrBean.saveEHRData(requestContext, ehrData);</span>

<span class="fc" id="L116">        Set&lt;AccessingEntityType&gt; entityTypeFilter = EnumSet.of(AccessingEntityType.CARER, AccessingEntityType.INDIVIDUAL);</span>

<span class="fc bfc" id="L118" title="All 2 branches covered.">        if (entityTypeFilter.contains(consent.getAccessingEntityType())) {</span>

<span class="fc bfc" id="L120" title="All 2 branches covered.">            consent.setDischarged(!consent.anyConsentGranted());</span>
        }
<span class="fc" id="L122">        patientConsentRepository.saveAndFlush(consent);</span>
<span class="fc" id="L123">        return consent.getId();</span>
    }


    public Optional&lt;PatientConsent&gt; getPatientConsent(@NotNull LoggedInEHRRequestContext requestContext, Long clinicianId, Long carerId,
                                            long patientId, boolean includeReasons) {


        AccessingEntityType entityType;
        long entityId;

<span class="fc bfc" id="L134" title="All 2 branches covered.">        if (clinicianId != null) {</span>
<span class="fc" id="L135">            entityType = AccessingEntityType.INDIVIDUAL;</span>
<span class="fc" id="L136">            entityId = clinicianId;</span>
<span class="pc bpc" id="L137" title="1 of 2 branches missed.">        } else if (carerId != null) {</span>
<span class="fc" id="L138">            entityType = AccessingEntityType.CARER;</span>
<span class="fc" id="L139">            entityId = carerId;</span>
        } else {
<span class="nc" id="L141">            LOGGER.warn(&quot;tried to view individual consent without providing a clinician/carer id&quot;);</span>
<span class="nc" id="L142">            throw new PKBException(&quot;could not display unspecified individual&quot;);</span>
        }
<span class="fc bfc" id="L144" title="All 2 branches covered.">        return (includeReasons ?</span>
<span class="fc" id="L145">                findPatientConsentWithReasons(requestContext, patientId, entityId, entityType) :</span>
<span class="fc" id="L146">                findPatientConsentWithoutReasons(patientId, entityId, entityType));</span>
    }

    public boolean updateOrCreateConsentRecord(@NotNull EHRRequestContext requestContext,
                                               @Nullable Long patientId,
                                               Long accessingId,
                                               AccessingEntityType entityType,
                                               Optional&lt;PatientConsent&gt; original,
                                               PatientConsent modified) {

<span class="fc" id="L156">        PatientConsent patientConsent = original.orElse(null);</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">        if (patientConsent != null) {</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">            if (!patientConsent.merge(modified)) {</span>
                // Nothing changed!
<span class="nc" id="L160">                return false;</span>
            }
<span class="fc" id="L162">            patientConsent.setUpdated(dateTimeService.now());</span>
        } else {
            // If no consent record exists, just use the one passed in (but need
            // to fill in a few blanks first...)
<span class="fc" id="L166">            patientConsent = modified;</span>
<span class="fc" id="L167">            patientConsent.setAccessingTeamSlashPersonId(accessingId);</span>
<span class="fc" id="L168">            patientConsent.setPatientPersonId(patientId);</span>
<span class="fc" id="L169">            patientConsent.setAccessingEntityType(entityType);</span>
<span class="fc bfc" id="L170" title="All 2 branches covered.">            if (patientConsent.getAdded() == null) {</span>
<span class="fc" id="L171">                patientConsent.setAdded(dateTimeService.now());</span>
            }
        }
        // Make sure a new reasons entry is persisted
<span class="fc" id="L175">        patientConsent.getReasons().setId(null);</span>
<span class="fc" id="L176">        ensureTeamLinkAndUpdatePatientConsentLegacy(requestContext, patientConsent);</span>
<span class="fc" id="L177">        return true;</span>
    }


    private Optional&lt;PatientConsent&gt; findPatientConsent(Long patientId, Long accessingPersonId, AccessingEntityType accessingEntityType,
                                                       Function&lt;PatientConsent, Optional&lt;PatientConsentReason&gt;&gt; reasonGetter) {
<span class="fc" id="L183">        List&lt;PatientConsent&gt; patientConsents =</span>
<span class="fc" id="L184">                patientConsentRepository.findByPatientPersonIdAndAccessingTeamSlashPersonIdAndAccessingEntityType(</span>
                        patientId, accessingPersonId, accessingEntityType);

<span class="fc bfc" id="L187" title="All 2 branches covered.">        if (isNotEmpty(patientConsents)) {</span>
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">            if (patientConsents.size() &gt; 1) {</span>
<span class="nc" id="L189">                LOGGER.error(&quot;Found more than one patient consent for &quot; +</span>
                                &quot;patientId {}, accessingPersonId {}, accessingEntityType {}&quot;,
                        patientId, accessingPersonId, accessingEntityType);
            }
<span class="fc" id="L193">            return patientConsents.stream().findFirst().map(patientConsent -&gt; {</span>
<span class="fc" id="L194">                patientConsent.setReasons(reasonGetter.apply(patientConsent).orElse(new PatientConsentReason(new SourceDetails())));</span>
<span class="fc" id="L195">                return patientConsent;</span>
            });
        }
<span class="fc" id="L198">        return Optional.empty();</span>
    }

    public Optional&lt;PatientConsent&gt; findPatientConsentWithoutReasons(Long patientPersonId, Long accessingPersonId, AccessingEntityType accessingEntityType) {
<span class="fc" id="L202">        return findPatientConsent(patientPersonId, accessingPersonId, accessingEntityType, consent -&gt; Optional.empty());</span>
    }

    public Optional&lt;PatientConsent&gt; findPatientConsentWithReasons(@NotNull LoggedInEHRRequestContext requestContext, Long patientPersonId, Long accessingPersonId,
                                                                  AccessingEntityType accessingEntityType) {
<span class="fc" id="L207">        return findPatientConsent(patientPersonId, accessingPersonId, accessingEntityType, consent -&gt; findPatientConsentReason(requestContext, consent));</span>
    }

    @NotNull
    private Optional&lt;PatientConsentReason&gt; findPatientConsentReason(@NotNull LoggedInEHRRequestContext requestContext,
                                                                   @NotNull PatientConsent patientConsent) {

<span class="fc" id="L214">        PKBPersonRemote personBean = beanFactory.getPKBPersonBean();</span>
<span class="fc" id="L215">        EHRRemote ehrBean = beanFactory.getEhrRemote();</span>
<span class="fc" id="L216">        Long accountId = personBean.getDefaultAccountId(patientConsent.getPatientPersonId());</span>
<span class="fc" id="L217">        return Optional.ofNullable(ehrBean.findAndDecryptTypedDataByUniqueId(</span>
                requestContext,
<span class="fc" id="L219">                patientConsent.getUniqueId(),</span>
<span class="fc" id="L220">                accountId,</span>
                PatientConsentReason.class,
                PatientConsentReason.MS_PATH));
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>