<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PatientConsentManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.patientconsent</a> &gt; <span class="el_source">PatientConsentManager.java</span></div><h1>PatientConsentManager.java</h1><pre class="source lang-java linenums">package com.pkb.service.patientconsent;

import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableMap;
import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.google.common.collect.Table;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.consent.entity.PatientConsentReason;
import com.pkb.datamodel.consent.ConsentExpiryDecision;
import com.pkb.datamodel.consent.ConsentExpiryDecisionExisting;
import com.pkb.datamodel.consent.ImmutablePatientConsentUpdateDTO;
import com.pkb.datamodel.consent.ImmutableSourceDTO;
import com.pkb.datamodel.consent.ModifiablePatientConsentDTO;
import com.pkb.datamodel.consent.PatientConsentDTO;
import com.pkb.datamodel.consent.PatientConsentUpdateDTO;
import com.pkb.datamodel.consent.SourceDTO;
import com.pkb.domain.CryptoModelSynchronisationService;
import com.pkb.domain.consent.ConsentService;
import com.pkb.entities.enums.AccessingEntityType;
import com.pkb.entities.enums.CarerRemovalAge;
import com.pkb.entities.enums.ConsentReason;
import com.pkb.entities.enums.Route;
import com.pkb.entities.enums.SponsorshipStatus;
import com.pkb.institute.entity.InstituteUser;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.PatientSearchOptionsDto;
import com.pkb.institute.entity.Team;
import com.pkb.mappers.SourceDetailsMapper;
import com.pkb.service.dataupload.hl7.HL7ConnContext;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.user.PKBPersonRemote;
import com.pkb.user.entity.PKBPerson;
import com.pkb.util.tolven.TolvenBeanFactory;
import com.pkb.util.tolven.TransactionManager;
import io.vavr.collection.HashSet;
import org.apache.commons.lang3.builder.CompareToBuilder;
import org.jetbrains.annotations.NotNull;

import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.UUID;
import java.util.function.Function;
import java.util.stream.Collectors;

import static com.pkb.entities.enums.AccessingEntityType.TEAM;
import static com.pkb.entities.enums.ConsentReason.DISCHARGE;
import static com.pkb.entities.enums.ConsentReason.EXPLICIT_CONSENT;
import static com.pkb.user.entity.PKBPerson.Lazy.CONTACTS;
import static java.lang.String.format;
import static java.util.Collections.emptySet;
import static java.util.Optional.ofNullable;
import static java.util.stream.Collectors.toUnmodifiableSet;

/**
 * Equivalent to the Service layer in new code
 */
public class PatientConsentManager extends TransactionManager {
    private final TolvenBeanFactory tolvenBeanFactory;
    private final ConsentService consentService;
    private final SourceDetailsMapper sourceDetailsMapper;
    private final CryptoModelSynchronisationService cryptoModelSynchronisationService;
    private final TeamUserManager teamUserManager;

    public PatientConsentManager(PhrConfig phrConfig, TolvenBeanFactory tolvenBeanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider,
                                 ConsentService consentService, SourceDetailsMapper sourceDetailsMapper,
                                 CryptoModelSynchronisationService cryptoModelSynchronisationService,
                                 TeamUserManager teamUserManager) {
<span class="fc" id="L77">        super(phrConfig, tolvenBeanFactory, dateTimeService, uuidProvider);</span>
<span class="fc" id="L78">        this.tolvenBeanFactory = tolvenBeanFactory;</span>
<span class="fc" id="L79">        this.consentService = consentService;</span>
<span class="fc" id="L80">        this.sourceDetailsMapper = sourceDetailsMapper;</span>
<span class="fc" id="L81">        this.cryptoModelSynchronisationService = cryptoModelSynchronisationService;</span>
<span class="fc" id="L82">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L83">    }</span>

    public void ensureTeamLinkAndUpdatePatientConsent(EHRRequestContext requestContext, PatientConsentUpdateDTO consentUpdate) {
<span class="fc" id="L86">        long userId = consentUpdate.patientPersonId();</span>
        // Ensure an instituteuser record exists as well
<span class="fc bfc" id="L88" title="All 2 branches covered.">        if (consentUpdate.accessingEntityType() == TEAM) {</span>

<span class="fc" id="L90">            long teamId = consentUpdate.requireAccessingTeamId();</span>
<span class="fc" id="L91">            InstituteUser instituteUser = teamUserManager.getInstituteUser(teamId, userId);</span>
<span class="fc bfc" id="L92" title="All 2 branches covered.">            if (instituteUser == null) {</span>
<span class="fc" id="L93">                teamUserManager.createInstituteUser(userId, teamId, SponsorshipStatus.ACTIVE);</span>
            }

        }
<span class="fc" id="L97">        updatePatientConsent(requestContext, consentUpdate);</span>
<span class="fc" id="L98">    }</span>

    public Optional&lt;PatientConsentDTO&gt; findPatientConsent(long patientId, long accessingEntityId, AccessingEntityType accessingEntityType) {
<span class="fc" id="L101">        return consentService.findPatientConsent(patientId, accessingEntityId, accessingEntityType);</span>
    }

    public List&lt;PatientConsentDTO&gt; findPatientConsents(long patientId, AccessingEntityType accessingEntityType, boolean includeDischarged) {
<span class="fc" id="L105">        return consentService.getConsentsForPatient(patientId, Set.of(accessingEntityType),  includeDischarged);</span>
    }

    public boolean dischargePatientFromTeam(EHRRequestContext requestContext, long patientId, long teamId) {
<span class="fc" id="L109">        return findPatientConsent(patientId, teamId, AccessingEntityType.TEAM)</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">                .filter(consent -&gt; !consent.discharged())</span>
<span class="fc" id="L111">                .map(consent -&gt; PatientConsentUpdateDTO.revocationOf(consent, sourceDetailsMapper.mapFromEHRRequestContext(requestContext), DISCHARGE))</span>
<span class="fc" id="L112">                .map(update -&gt; {</span>
<span class="fc" id="L113">                    updatePatientConsent(requestContext, update);</span>
<span class="fc" id="L114">                    return true;</span>
                })
<span class="fc" id="L116">                .orElse(false);</span>
    }

    public boolean hasActiveConsentRecord(PKBPerson patient, Team team) {
<span class="fc" id="L120">        return consentService.findPatientConsent(patient.getId(), team.getId(), TEAM)</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">                .map(consent -&gt; !consent.discharged())</span>
<span class="fc" id="L122">                .orElse(false);</span>
    }

    /**
     * @param patientIds
     * @param teamIds
     * @return Table&lt;patientId, teamId, hasActiveTeamConsent&gt;
     */
    public Table&lt;Long, Long, Boolean&gt; hasActiveTeamConsent(Set&lt;Long&gt; patientIds, Set&lt;Long&gt; teamIds) {
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">        return consentService.findPatientConsent(patientIds, teamIds, TEAM, pcdto -&gt; !pcdto.discharged());</span>
    }

    public boolean hasActiveConsentRecord(PKBPerson patient, Org org) {
<span class="fc" id="L135">        var teamIdsAtOrg = HashSet.ofAll(org.getTeams()).map(Team::getId);</span>
<span class="fc" id="L136">        return consentService.findAllActivePatientConsents(patient.getId())</span>
<span class="fc" id="L137">                .stream()</span>
<span class="fc" id="L138">                .anyMatch(consentDto -&gt; consentDto.accessingTeamId().map(teamIdsAtOrg::contains).orElse(false));</span>
    }

    public void updatePatientConsent(EHRRequestContext requestContext, PatientConsentUpdateDTO update) {
<span class="fc" id="L142">        transactional(() -&gt; {</span>
<span class="fc" id="L143">            UUID uniqueId = consentService.updatePatientConsent(update.patientPersonId(),</span>
<span class="fc" id="L144">                    update.accessingPersonOrTeamId(), update.accessingEntityType(), update);</span>

<span class="fc" id="L146">            PatientConsentReason consentReason = new PatientConsentReason(sourceDetailsMapper.mapFromSourceDTO(update.source()));</span>
<span class="fc" id="L147">            consentReason.setGeneralHealthConsentGranted(update.generalHealthConsentGranted());</span>
<span class="fc" id="L148">            consentReason.setGeneralHealthConsentGrantedReason(update.generalHealthConsentGrantedReason());</span>
<span class="fc" id="L149">            consentReason.setGeneralHealthConsentGrantedReasonText(update.generalHealthConsentGrantedReasonText().orElse(null));</span>

<span class="fc" id="L151">            consentReason.setMentalHealthConsentGranted(update.mentalHealthConsentGranted());</span>
<span class="fc" id="L152">            consentReason.setMentalHealthConsentGrantedReason(update.mentalHealthConsentGrantedReason());</span>
<span class="fc" id="L153">            consentReason.setMentalHealthConsentGrantedReasonText(update.mentalHealthConsentGrantedReasonText().orElse(null));</span>

<span class="fc" id="L155">            consentReason.setSexualHealthConsentGranted(update.sexualHealthConsentGranted());</span>
<span class="fc" id="L156">            consentReason.setSexualHealthConsentGrantedReason(update.sexualHealthConsentGrantedReason());</span>
<span class="fc" id="L157">            consentReason.setSexualHealthConsentGrantedReasonText(update.sexualHealthConsentGrantedReasonText().orElse(null));</span>

<span class="fc" id="L159">            consentReason.setSocialCareConsentGranted(update.socialCareConsentGranted());</span>
<span class="fc" id="L160">            consentReason.setSocialCareConsentGrantedReason(update.socialCareConsentGrantedReason());</span>
<span class="fc" id="L161">            consentReason.setSocialCareConsentGrantedReasonText(update.socialCareConsentGrantedReasonText().orElse(null));</span>
<span class="fc" id="L162">            consentReason.setProEditOnlyForChild(update.proEditOnlyForChild());</span>
<span class="fc" id="L163">            consentReason.setProEditOnlyForChildReasonText(update.proEditOnlyForChildReasonText().orElse(null));</span>
<span class="fc" id="L164">            consentReason.getBaseFields().setUniqueId(uniqueId);</span>
<span class="fc" id="L165">            update.eventText().ifPresent(consentReason::setEventText);</span>
<span class="fc" id="L166">            update.uploadedDataId().ifPresent(uploadedDataId -&gt; consentReason.getBaseFields().setUploadedDataId(uploadedDataId));</span>
            // It shouldn't be necessary to put a consent on a consent change reason
            // but this is how the data is stored, it's mandatory to set a consent flag.
<span class="fc" id="L169">            consentReason.getBaseFields().setGeneralHealthConsentRequired(true);</span>

            // Also save the menu_data record for consent change reason
<span class="fc" id="L172">            tolvenBeanFactory.getEhrRemote().saveEHRData(requestContext, tolvenBeanFactory.getEhrRemote().populateEHRData(</span>
                    consentReason,
<span class="fc" id="L174">                    tolvenBeanFactory.getPKBPersonBean().getDefaultAccountId(update.patientPersonId()),</span>
                    PatientConsentReason.MS_PATH,
                    requestContext));

<span class="fc" id="L178">            cryptoModelSynchronisationService.syncCryptoAccessForPerson(update.patientPersonId());</span>
<span class="fc" id="L179">        });</span>
<span class="fc" id="L180">    }</span>

    public void grantDefaultConsentToTeam(HL7ConnContext context, PKBPerson person, Team team, Long uploadedDataId, Route route) {
<span class="fc" id="L183">        var source = ImmutableSourceDTO.builder()</span>
<span class="fc" id="L184">                .route(route)</span>
<span class="fc" id="L185">                .teamId(context.getSourceTeamId())</span>
<span class="fc" id="L186">                .orgId(context.getSourceOrgId())</span>
<span class="fc" id="L187">                .connectingOrgId(context.getConnectingOrg().getId())</span>
<span class="fc" id="L188">                .hl7PartnerId(context.getHl7Partner().flatMap(partner -&gt; partner.getId().toJavaOptional()))</span>
<span class="fc" id="L189">                .build();</span>
<span class="fc" id="L190">        var consent = buildPatientConsent(person.getId(), team, source, ofNullable(uploadedDataId));</span>

<span class="fc" id="L192">        ensureTeamLinkAndUpdatePatientConsent(context.getEHRRequestContext(), consent);</span>
<span class="fc" id="L193">    }</span>

    public PatientConsentUpdateDTO grantDefaultConsentToTeam(EHRRequestContext requestContext, PKBPerson person,
                                                             Team team, Route sourceRoute) {
<span class="fc" id="L197">        var source = ImmutableSourceDTO.builder()</span>
<span class="fc" id="L198">                .route(sourceRoute)</span>
<span class="fc" id="L199">                .orgId(team.getOrg().getId())</span>
<span class="fc" id="L200">                .teamId(team.getId())</span>
<span class="fc" id="L201">                .personId(person.getId())</span>
<span class="fc" id="L202">                .build();</span>
<span class="fc" id="L203">        var consent = buildPatientConsent(person.getId(), team, source, Optional.empty());</span>

<span class="fc" id="L205">        ensureTeamLinkAndUpdatePatientConsent(requestContext, consent);</span>

<span class="fc" id="L207">        return consent;</span>
    }

    public PatientConsentUpdateDTO grantDefaultConsentToTeam(EHRRequestContext requestContext, PKBPerson person, Team team) {
<span class="fc" id="L211">        var consent = buildPatientConsent(person.getId(), team, sourceDetailsMapper.mapFromEHRRequestContext(requestContext), Optional.empty());</span>

<span class="fc" id="L213">        ensureTeamLinkAndUpdatePatientConsent(requestContext, consent);</span>
<span class="fc" id="L214">        return consent;</span>
    }


    public boolean hasConsent(LoggedInEHRRequestContext context, long patientId) {
<span class="fc" id="L219">        long userId = context.getAccessingUserId();</span>
<span class="fc" id="L220">        return consentService.findAllActivePatientConsents(patientId)</span>
<span class="fc" id="L221">                        .stream()</span>
<span class="fc" id="L222">                        .anyMatch(it -&gt;</span>
<span class="pc bpc" id="L223" title="2 of 4 branches missed.">                                it.accessingPersonId().map(accessingPersonId -&gt; accessingPersonId == userId).orElse(false)</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">                                        || it.accessingTeamId().equals(context.getTeamId())</span>
                        );

    }


    private PatientConsentUpdateDTO buildPatientConsent(long patientId, Team team, com.pkb.datamodel.consent.SourceDTO source, Optional&lt;Long&gt; uploadedDataId) {
<span class="fc" id="L231">        return ImmutablePatientConsentUpdateDTO.builder()</span>
<span class="fc" id="L232">                .generalHealthConsentGranted(team.isDefaultRequestGeneral())</span>
<span class="fc" id="L233">                .sexualHealthConsentGranted(team.isDefaultRequestSexualHealth())</span>
<span class="fc" id="L234">                .mentalHealthConsentGranted(team.isDefaultRequestMentalHealth())</span>
<span class="fc" id="L235">                .socialCareConsentGranted(team.isDefaultRequestSocialCare())</span>
<span class="fc" id="L236">                .proEditOnlyForChild(false)</span>
<span class="fc" id="L237">                .discharged(false)</span>
<span class="fc" id="L238">                .accessingEntityType(TEAM)</span>
<span class="fc" id="L239">                .patientPersonId(patientId)</span>
<span class="fc" id="L240">                .source(source)</span>
<span class="fc" id="L241">                .generalHealthConsentGrantedReason(EXPLICIT_CONSENT)</span>
<span class="fc" id="L242">                .sexualHealthConsentGrantedReason(EXPLICIT_CONSENT)</span>
<span class="fc" id="L243">                .mentalHealthConsentGrantedReason(EXPLICIT_CONSENT)</span>
<span class="fc" id="L244">                .socialCareConsentGrantedReason(EXPLICIT_CONSENT)</span>
<span class="fc" id="L245">                .uploadedDataId(uploadedDataId)</span>
<span class="fc" id="L246">                .accessingTeamId(team.getId())</span>
<span class="fc" id="L247">                .build();</span>
    }

    public List&lt;ConsentExpiryDecisionExisting&gt; findConsentExpiryDecisionsByConsentId(long consentId) {
<span class="fc" id="L251">        return consentService.findConsentExpiryDecisionsByConsentId(consentId);</span>
    }

    public void updateConsentExpiryDecision(ConsentExpiryDecisionExisting consentExpiryDecision) {
<span class="fc" id="L255">        consentService.updateConsentExpiryDecision(consentExpiryDecision);</span>
<span class="fc" id="L256">    }</span>

    public void saveConsentExpiryDecision(ConsentExpiryDecision consentExpiryDecision) {
<span class="fc" id="L259">        consentService.saveConsentExpiryDecision(consentExpiryDecision);</span>
<span class="fc" id="L260">    }</span>

    @NotNull
    public Set&lt;Long&gt; findConsentingPatientIdsForTeam(Long teamId,  PatientSearchOptionsDto options) {
<span class="fc" id="L264">        PKBPersonRemote personBean = beanFactory.getPKBPersonBean();</span>
<span class="fc" id="L265">        List&lt;Long&gt; personIdsByIdentifier = personBean.findPersonIdsByIdentifier(options);</span>
<span class="fc bfc" id="L266" title="All 4 branches covered.">        if (personIdsByIdentifier.isEmpty() &amp;&amp; options.searchId() != null) {</span>
            //Short-cicuit. You provided an id and nothing matched.
<span class="fc" id="L268">            return Set.of();</span>
        }

<span class="fc" id="L271">        List&lt;Long&gt; personIdsWithConsentInTeam = consentService.getPatientIdsForConsentsInTeam(teamId, personIdsByIdentifier);</span>
        // https://pkbdev.atlassian.net/browse/PHR-10395 Convert to an ArrayList to ensure serializability
        // before passing to an EJB method. It appears that hibernate may decide to return a non-serializable list
        // occasionally. This is fine, List doesn't extend serializable. EJB remoting interfaces require
        // everything to be serializable, and have no way to enforce that except at runtime.
<span class="fc" id="L276">        personIdsWithConsentInTeam = new ArrayList&lt;&gt;(personIdsWithConsentInTeam);</span>
<span class="fc" id="L277">        List&lt;Long&gt; results = personBean.findPatientIdListByPatientSearchOptions(personIdsWithConsentInTeam, options);</span>

<span class="fc" id="L279">        return results.stream().collect(toUnmodifiableSet());</span>
    }

    public List&lt;PKBPerson&gt; findConsentingPatientsForTeam(long teamId, PatientSearchOptionsDto searchOptionsDto) {

<span class="fc" id="L284">        PKBPersonRemote personBean = beanFactory.getPKBPersonBean();</span>

<span class="fc" id="L286">        List&lt;Long&gt; personIdsByIdentifier = personBean.findPersonIdsByIdentifier(searchOptionsDto);</span>
<span class="fc bfc" id="L287" title="All 4 branches covered.">        if (personIdsByIdentifier.isEmpty() &amp;&amp; searchOptionsDto.searchId() != null) {</span>
            //Short-cicuit. You provided an id and nothing matched.
<span class="fc" id="L289">            return List.of();</span>
        }

        // Get all the consents for this team and get the patient ids off them
<span class="fc" id="L293">        List&lt;Long&gt; personIdsWithConsentInTeam = getPatientIdsForConsentsInTeam(teamId, personIdsByIdentifier);</span>

        //Then hit pkbperson for the list of persons
<span class="fc" id="L296">        return personBean.findPatientListByPersonIdsAndPatientSearchOptions(personIdsWithConsentInTeam, searchOptionsDto);</span>
    }

    public List&lt;PKBPerson&gt; findConsentingPatientsForIndividualProfessional(long professionalId, PatientSearchOptionsDto searchOptionsDto) {
<span class="fc" id="L300">        PKBPersonRemote personBean = beanFactory.getPKBPersonBean();</span>
<span class="fc" id="L301">        List&lt;Long&gt; personIdsByIdentifier = personBean.findPersonIdsByIdentifier(searchOptionsDto);</span>
<span class="fc bfc" id="L302" title="All 4 branches covered.">        if (personIdsByIdentifier.isEmpty() &amp;&amp; searchOptionsDto.searchId() != null) {</span>
            //Short-cicuit. You provided an id and nothing matched.
<span class="fc" id="L304">            return List.of();</span>
        }

<span class="fc" id="L307">        List&lt;Long&gt; personIdsWithConsentInTeam = consentService.getPatientIdsForConsentsForIndividual(professionalId, personIdsByIdentifier);</span>

        //Then hit pkbperson for the list of persons
<span class="fc" id="L310">        return personBean.findPatientListByPersonIdsAndPatientSearchOptions(personIdsWithConsentInTeam, searchOptionsDto);</span>
    }

    public List&lt;Long&gt; getPatientIdsForConsentsInTeam(long teamId, List&lt;Long&gt; limitingPatientIds) {
<span class="fc" id="L314">        return  consentService.getPatientIdsForConsentsInTeam(teamId, limitingPatientIds);</span>
    }


    public List&lt;PKBPerson&gt; findConsentingPatientsForTeam(long teamId) {
<span class="fc" id="L319">        List&lt;Long&gt; personIds = consentService.findConsentingPatientIdsForEntity(teamId, TEAM);</span>
<span class="fc" id="L320">        PKBPersonRemote personBean = beanFactory.getPKBPersonBean();</span>
<span class="fc" id="L321">        return personBean.findPKBPersonListOrderedByFirstAndLastNameAscending(personIds,</span>
                PKBPerson.Lazy.NATIONAL_AND_LOCAL_IDS, PKBPerson.Lazy.PROPERTIES);
    }

    public List&lt;PKBPerson&gt; findPastConsentingPatientsForTeam(long teamId) {
<span class="nc" id="L326">        List&lt;Long&gt; personIds = findPastConsentingPatientIdsForTeam(teamId);</span>
<span class="nc" id="L327">        PKBPersonRemote personBean = beanFactory.getPKBPersonBean();</span>
<span class="nc" id="L328">        return personBean.findPKBPersonList(personIds);</span>
    }

    public List&lt;PKBPerson&gt; findPastConsentingPatientsForIndividual(long userId, AccessingEntityType accessingEntityType) {
<span class="fc" id="L332">        List&lt;Long&gt; personIds = consentService.findPastConsentingPatientIdsForEntity(userId, accessingEntityType);</span>
<span class="fc" id="L333">        PKBPersonRemote personBean = beanFactory.getPKBPersonBean();</span>
<span class="fc" id="L334">        return personBean.findPKBPersonListOrderedByFirstAndLastNameAscending(personIds);</span>
    }


    public List&lt;Long&gt; findPastConsentingPatientIdsForTeam(long entityId) {
<span class="nc" id="L339">        return consentService.findPastConsentingPatientIdsForEntity(entityId, TEAM);</span>
    }

    public List&lt;PatientConsentDTO&gt; findAllPatientConsentsForIndividual(long accessingPersonId, AccessingEntityType accessingEntityType) {
<span class="fc" id="L343">        return consentService.findAllPatientConsentsForIndividual(accessingPersonId, accessingEntityType);</span>
    }

    public List&lt;PatientConsentDTO&gt; getExpiredConsents(CarerRemovalAge age) {
<span class="fc" id="L347">        return consentService.getExpiredConsents(age);</span>
    }

    public void expireConsent(PatientConsentDTO existingConsent) {
<span class="fc" id="L351">        consentService.expireConsent(existingConsent);</span>
<span class="fc" id="L352">        cryptoModelSynchronisationService.syncCryptoAccessForPerson(existingConsent.patientPersonId());</span>
<span class="fc" id="L353">    }</span>

    public List&lt;PKBPerson&gt; getCaregivers(long patientId, PKBPerson.Lazy... fields) {
<span class="fc" id="L356">        var carerIds = consentService.getConsentsForPatient(patientId, Set.of(AccessingEntityType.CARER), false)</span>
<span class="fc" id="L357">                .stream().map(PatientConsentDTO::getAccessingTeamOrPersonId).collect(Collectors.toUnmodifiableList());</span>

<span class="fc" id="L359">        return getBeanFactory().getPKBPersonBean().findPKBPersonListOrderedByFirstAndLastNameAscending(carerIds, fields);</span>
    }

    public ConsentLinks getConsentLinks(@NotNull EHRRequestContext requestContext, long patientId, boolean includeDischarged,
                                                                        Set&lt;AccessingEntityType&gt; entityTypes) {
<span class="fc" id="L364">        ConsentLinks.Builder builder = ConsentLinks.builder();</span>

        // Loop through consents and break them up into team/clinician/carer
<span class="fc" id="L367">        consentService.getConsentsForPatient(patientId, entityTypes, includeDischarged)</span>
<span class="fc" id="L368">                .forEach(consent -&gt; {</span>
<span class="pc bpc" id="L369" title="1 of 4 branches missed.">                    switch(consent.accessingEntityType()) {</span>
                        case INDIVIDUAL:
<span class="fc" id="L371">                            builder.addIndividualConsent(consent);</span>
<span class="fc" id="L372">                            break;</span>
                        case CARER:
<span class="fc" id="L374">                            builder.addCarerConsent(consent);</span>
<span class="fc" id="L375">                            break;</span>
                        case TEAM:
<span class="fc" id="L377">                            builder.addTeamConsent(consent);</span>
                    }
<span class="fc" id="L379">                });</span>

<span class="fc" id="L381">        PKBPersonRemote personBean = beanFactory.getPKBPersonBean();</span>

<span class="fc" id="L383">        List&lt;PKBPerson&gt; clinicians = personBean.findPKBPersonListOrderedByFirstAndLastNameAscending(builder.getClinicianIds(), CONTACTS);</span>
<span class="fc" id="L384">        builder.clinicians(clinicians);</span>

<span class="fc" id="L386">        List&lt;PKBPerson&gt; carers = personBean.findPKBPersonListOrderedByFirstAndLastNameAscending(builder.getCarerIds(), CONTACTS);</span>
<span class="fc" id="L387">        builder.carers(carers);</span>

        // Load all the teams that we found consent for
<span class="fc" id="L390">        builder.teams(teamUserManager.getTeams(requestContext, builder.getTeamIds()));</span>
<span class="fc" id="L391">        return builder.build();</span>
    }

    public ConsentLinks getConsentLinks(@NotNull EHRRequestContext requestContext, long patientId, boolean includeDischarged) {
<span class="fc" id="L395">        return getConsentLinks(requestContext, patientId, includeDischarged, emptySet());</span>
    }

    public void updatePatientConsentsForTeam(EHRRequestContext requestContext, long patientid, long teamId, ModifiablePatientConsentDTO patientConsentSettings, ConsentReason consentReason, String consentReasonText) {
<span class="fc" id="L399">        SourceDTO source = sourceDetailsMapper.mapFromEHRRequestContext(requestContext);</span>
<span class="fc" id="L400">        var update = consentService.findPatientConsent(patientid,teamId, TEAM)</span>
<span class="fc" id="L401">                .map(existing -&gt; PatientConsentUpdateDTO.updateFor(existing, patientConsentSettings, source, consentReason, consentReasonText))</span>
<span class="pc" id="L402">                .orElseThrow(() -&gt; new RuntimeException(format(&quot;No existing consent to update for patient %d and team %d&quot;, patientid, teamId)));</span>

<span class="fc" id="L404">        ensureTeamLinkAndUpdatePatientConsent(requestContext, update);</span>
<span class="fc" id="L405">    }</span>

    public boolean consentExistsInOrgNetwork(long patientId, long teamId) {
<span class="fc" id="L408">        return consentService.consentExistsInOrgNetwork(patientId, teamId);</span>
    }

    public boolean hasAccessToUser(EHRRequestContext requestContext, long userId) {
<span class="fc bfc" id="L412" title="All 2 branches covered.">        return hasIndividualAccessToUser(requestContext, userId) ||</span>
<span class="fc bfc" id="L413" title="All 2 branches covered.">                requestContext.getTeamId().map(teamId -&gt; consentExistsInOrgNetwork(userId, teamId)).orElse(false);</span>
    }

    public boolean hasIndividualAccessToUser(EHRRequestContext requestContext, long userId) {
<span class="fc bfc" id="L417" title="All 4 branches covered.">        return requestContext.getMaybeAccessingUserId().map(loggedInUserId -&gt; loggedInUserId == userId).orElse(false) ||</span>
<span class="fc bfc" id="L418" title="All 2 branches covered.">                requestContext.getMaybeAccessingUserId().flatMap(loggedInUserId -&gt; consentService.findActivePatientConsentForPerson(userId, loggedInUserId)).isPresent();</span>
    }

    public boolean hasIndividualAccessToUser(long accessingUserId, long userId) {
<span class="pc bpc" id="L422" title="1 of 4 branches missed.">        return accessingUserId == userId || consentService.findActivePatientConsentForPerson(userId, accessingUserId).isPresent();</span>
    }

    public static final class ConsentLinks {

        private final ImmutableList&lt;Team&gt; teams;
        private final ImmutableMap&lt;Long, PatientConsentDTO&gt; teamConsents;

        private final ImmutableList&lt;PKBPerson&gt; clinicians;
        private final ImmutableMap&lt;Long, PatientConsentDTO&gt; clinicianConsents;

        private final ImmutableList&lt;PKBPerson&gt; carers;
        private final ImmutableMap&lt;Long, PatientConsentDTO&gt; carerConsents;

        public ImmutableList&lt;Team&gt; getTeams() {
<span class="fc" id="L437">            return teams;</span>
        }

        public ImmutableMap&lt;Long, PatientConsentDTO&gt; getTeamConsents() {
<span class="fc" id="L441">            return teamConsents;</span>
        }

        public ImmutableList&lt;PKBPerson&gt; getIndividuals() {
<span class="fc" id="L445">            return clinicians;</span>
        }

        public ImmutableMap&lt;Long, PatientConsentDTO&gt; getIndividualConsents() {
<span class="fc" id="L449">            return clinicianConsents;</span>
        }

        public ImmutableList&lt;PKBPerson&gt; getCarers() {
<span class="fc" id="L453">            return carers;</span>
        }

        public ImmutableMap&lt;Long, PatientConsentDTO&gt; getCarerConsents() {
<span class="fc" id="L457">            return carerConsents;</span>
        }

<span class="fc" id="L460">        private static final Comparator&lt;Team&gt; PREVIOUS_TEAM_COMPARATOR = (t1, t2) -&gt; new CompareToBuilder().append(t1.getName(), t2.getName()).append(t1.getId(), t2.getId()).build();</span>

        public ImmutableList&lt;Team&gt; getPreviouslySharedTeams() {
<span class="fc" id="L463">            return getPreviouslySharedList(teams, teamConsents, Team::getId, PREVIOUS_TEAM_COMPARATOR);</span>

        }

<span class="fc" id="L467">        private static final Comparator&lt;PKBPerson&gt; PREVIOUS_PERSON_COMPARATOR = (p1, p2) -&gt;</span>
<span class="fc" id="L468">                new CompareToBuilder().append(p1.getFirstName(), p2.getFirstName()).append(p1.getLastName(), p2.getLastName()).append(p1.getId(), p2.getId()).build();</span>

        public ImmutableList&lt;PKBPerson&gt; getPreviouslySharedCarers() {
<span class="fc" id="L471">            return getPreviouslySharedList(carers, carerConsents, PKBPerson::getId, PREVIOUS_PERSON_COMPARATOR);</span>
        }

        public ImmutableList&lt;PKBPerson&gt; getPreviouslySharedClinicians() {
<span class="fc" id="L475">            return getPreviouslySharedList(clinicians, clinicianConsents, PKBPerson::getId, PREVIOUS_PERSON_COMPARATOR);</span>
        }

        private &lt;T&gt; ImmutableList&lt;T&gt; getPreviouslySharedList(List&lt;T&gt; unfiltered, Map&lt;Long, PatientConsentDTO&gt; consentMap, Function&lt;T, Long&gt; idGetter, Comparator&lt;T&gt; comparator) {
<span class="fc" id="L479">            return unfiltered.stream()</span>
<span class="fc" id="L480">                    .filter(entity -&gt; Optional.ofNullable(consentMap.get(idGetter.apply(entity))).map(PatientConsentDTO::discharged).orElse(false))</span>
<span class="fc" id="L481">                    .sorted(comparator)</span>
<span class="fc" id="L482">                    .collect(ImmutableList.toImmutableList());</span>
        }

        public static final class Builder {

            private List&lt;Team&gt; teams;
            private List&lt;PKBPerson&gt; individuals;
            private List&lt;PKBPerson&gt; carers;

            private final Map&lt;Long, PatientConsentDTO&gt; teamConsents;
            private final Map&lt;Long, PatientConsentDTO&gt; clinicianConsents;
            private final Map&lt;Long, PatientConsentDTO&gt; carerConsents;

<span class="fc" id="L495">            private Builder() {</span>
<span class="fc" id="L496">                teams = Lists.newArrayList();</span>
<span class="fc" id="L497">                individuals = Lists.newArrayList();</span>
<span class="fc" id="L498">                carers = Lists.newArrayList();</span>
<span class="fc" id="L499">                teamConsents = Maps.newHashMap();</span>
<span class="fc" id="L500">                clinicianConsents = Maps.newHashMap();</span>
<span class="fc" id="L501">                carerConsents = Maps.newHashMap();</span>
<span class="fc" id="L502">            }</span>

            public Builder addTeamConsent(PatientConsentDTO consent) {
<span class="fc" id="L505">                this.teamConsents.put(consent.getAccessingTeamOrPersonId(), consent);</span>
<span class="fc" id="L506">                return this;</span>
            }

            public Builder addIndividualConsent(PatientConsentDTO consent) {
<span class="fc" id="L510">                this.clinicianConsents.put(consent.getAccessingTeamOrPersonId(), consent);</span>
<span class="fc" id="L511">                return this;</span>
            }

            public Builder addCarerConsent(PatientConsentDTO consent) {
<span class="fc" id="L515">                this.carerConsents.put(consent.getAccessingTeamOrPersonId(), consent);</span>
<span class="fc" id="L516">                return this;</span>
            }

            public ConsentLinks.Builder teams(List&lt;Team&gt; teams) {
<span class="pc bpc" id="L520" title="1 of 2 branches missed.">                if (teams != null) {</span>
<span class="fc" id="L521">                    this.teams = teams;</span>
                }
<span class="fc" id="L523">                return this;</span>
            }

            public ConsentLinks.Builder clinicians(List&lt;PKBPerson&gt; individuals) {
<span class="pc bpc" id="L527" title="1 of 2 branches missed.">                if (individuals != null) {</span>
<span class="fc" id="L528">                    this.individuals = individuals;</span>
                }
<span class="fc" id="L530">                return this;</span>
            }

            public ConsentLinks.Builder carers(List&lt;PKBPerson&gt; carers) {
<span class="pc bpc" id="L534" title="1 of 2 branches missed.">                if (carers != null) {</span>
<span class="fc" id="L535">                    this.carers = carers;</span>
                }
<span class="fc" id="L537">                return this;</span>
            }

            public ImmutableList&lt;Long&gt; getTeamIds() {
<span class="fc" id="L541">                return ImmutableList.copyOf(this.teamConsents.keySet());</span>
            }

            public ImmutableList&lt;Long&gt; getClinicianIds() {
<span class="fc" id="L545">                return ImmutableList.copyOf(this.clinicianConsents.keySet());</span>
            }

            public ImmutableList&lt;Long&gt; getCarerIds() {
<span class="fc" id="L549">                return ImmutableList.copyOf(this.carerConsents.keySet());</span>
            }

            public ConsentLinks build() {
<span class="fc" id="L553">                return new ConsentLinks(</span>
<span class="fc" id="L554">                        ImmutableList.copyOf(teams),</span>
<span class="fc" id="L555">                        ImmutableMap.copyOf(teamConsents),</span>
<span class="fc" id="L556">                        ImmutableList.copyOf(individuals),</span>
<span class="fc" id="L557">                        ImmutableMap.copyOf(clinicianConsents),</span>
<span class="fc" id="L558">                        ImmutableList.copyOf(carers),</span>
<span class="fc" id="L559">                        ImmutableMap.copyOf(carerConsents));</span>
            }
        }

        public static ConsentLinks.Builder builder() {
<span class="fc" id="L564">            return new ConsentLinks.Builder();</span>
        }

        private ConsentLinks(ImmutableList&lt;Team&gt; teams, ImmutableMap&lt;Long, PatientConsentDTO&gt; teamConsents,
                             ImmutableList&lt;PKBPerson&gt; clinicians, ImmutableMap&lt;Long, PatientConsentDTO&gt; clinicianConsents,
<span class="fc" id="L569">                             ImmutableList&lt;PKBPerson&gt; carers, ImmutableMap&lt;Long, PatientConsentDTO&gt; carerConsents) {</span>
<span class="fc" id="L570">            this.teams = teams;</span>
<span class="fc" id="L571">            this.teamConsents = teamConsents;</span>
<span class="fc" id="L572">            this.clinicians = clinicians;</span>
<span class="fc" id="L573">            this.clinicianConsents = clinicianConsents;</span>
<span class="fc" id="L574">            this.carers = carers;</span>
<span class="fc" id="L575">            this.carerConsents = carerConsents;</span>
<span class="fc" id="L576">        }</span>

    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>