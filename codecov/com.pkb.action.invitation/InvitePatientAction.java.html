<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InvitePatientAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.invitation</a> &gt; <span class="el_source">InvitePatientAction.java</span></div><h1>InvitePatientAction.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------
//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: InviteClinicianAction.java Jun 2, 2009 3:12:10 PM mahendera$
//
//------------------------------------------------------------------------------

package com.pkb.action.invitation;

import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.bean.IUserWebBean;
import com.pkb.consent.model.NoConsentsRequired;
import com.pkb.datamodel.Email;
import com.pkb.encounter.entity.PKBInvitation;
import com.pkb.entities.enums.InvitationType;
import com.pkb.entities.enums.PrivacyFlag;
import com.pkb.entities.enums.UserStatus;
import com.pkb.exception.PKBException;
import com.pkb.service.invitation.impl.InvitationManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PersonContact;
import io.vavr.control.Option;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.EnumSet;
import java.util.Objects;
import java.util.UUID;

/**
 * Only used now for askAccessAsCarer flow! Should rename.
 *
 * @author mahendera
 * @author pravinam Added code for patient inviting another patient for access to records to provide care
 */
<span class="fc" id="L40">public class InvitePatientAction extends BaseAction {</span>
    private static final long serialVersionUID = 1L;

    private UUID invitationId;

    private String firstName;

    private String lastName;

    private Email emailId;

    private String domain;

    private String message;

    private String title;

    private String patientId;

<span class="fc" id="L59">    private boolean readonly = false;</span>

    private IUserWebBean userWebBean;

    private TeamUserManager teamUserManager;

    private InvitationManager invitationManager;

<span class="fc" id="L67">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    @Override
    public void validate() {
<span class="pc bpc" id="L71" title="3 of 6 branches missed.">        if ((getTitle() == null) || (getTitle().trim().isEmpty()) || &quot;-1&quot;.equals(getTitle().trim())) {</span>
<span class="nc" id="L72">            addFieldError(&quot;title&quot;,</span>
<span class="nc" id="L73">                    getText(&quot;invitePatientAction.err.enter_title&quot;));</span>
        }
<span class="fc" id="L75">    }</span>

    public String askAccessAsCarerForm() {
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">        if ((patientId != null)) {</span>
            try {
<span class="nc" id="L80">                PKBPerson person = userManager.getPKBPerson(Long.parseLong(patientId), PKBPerson.Lazy.CONTACTS);</span>
<span class="nc" id="L81">                firstName = person.getFirstName();</span>
<span class="nc" id="L82">                lastName = person.getLastName();</span>
<span class="nc" id="L83">                emailId = person.getEmail();</span>
<span class="nc" id="L84">                title = person.getTitle();</span>
<span class="nc" id="L85">                readonly = true;</span>
<span class="nc" id="L86">            } catch (NumberFormatException | PKBException e) {</span>
                // Ignoring the exception
<span class="nc" id="L88">                LOGGER.error(&quot;Error during ask access&quot;, e);</span>
<span class="nc" id="L89">            }</span>
        }
<span class="fc" id="L91">        return SUCCESS;</span>
    }

    public String cancel() {
<span class="nc" id="L95">        return &quot;cancel&quot;;</span>
    }


    public String askAccessAsCarer() {
<span class="fc" id="L100">        String result = Action.SUCCESS;</span>
        try {
<span class="fc" id="L102">            Email emailId = this.emailId;</span>
<span class="fc" id="L103">            PKBPerson invitee = userManager.getSinglePersonByEmail(emailId, PersonContact.Lazy.PERSON_W_CONTACTS);</span>
<span class="fc" id="L104">            PKBPerson loggedUser = userManager.getPKBPerson(loggedInUserUtil.getLoggedInUserId());</span>
<span class="fc" id="L105">            PKBPerson contextUser = contextUserUtil.getContextUser();</span>

<span class="pc bpc" id="L107" title="1 of 2 branches missed.">            if (invitee == null) {</span>
                // patient or clinician in context of patient should not be able to ask for access to
                // a non existing patient otherwise this will result in non-team patient
<span class="nc" id="L110">                addActionError(getText(&quot;invitePatientAction.err.patient_not_exist&quot;, new String[]{Option.of(this.emailId).map(Email::address).getOrNull()}));</span>
<span class="nc" id="L111">                return Action.INPUT;</span>
            } else {

<span class="pc bpc" id="L114" title="1 of 2 branches missed.">                if (!invitee.isPatient()) {</span>
                    // patient/clinician should not be able to ask for access to a non patient
<span class="nc" id="L116">                    String fullName = invitee.getTitle() + &quot; &quot; + invitee.getFirstName() + &quot; &quot;</span>
<span class="nc" id="L117">                            + invitee.getLastName();</span>
<span class="nc" id="L118">                    addActionError(getText(&quot;invitePatientAction.err.invitee_not_patient&quot;, new String[]{fullName}));</span>
<span class="nc" id="L119">                    return Action.INPUT;</span>
                }

<span class="fc" id="L122">                boolean inviteeVerified = teamUserManager.isUserIdentified(invitee.getId());</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">                if (!inviteeVerified) {</span>
                    // patient/clinician should not be able to ask for access to a non activated patient
<span class="nc" id="L125">                    String fullName = invitee.getTitle() + &quot; &quot; + invitee.getFirstName() + &quot; &quot;</span>
<span class="nc" id="L126">                            + invitee.getLastName();</span>
<span class="nc" id="L127">                    addActionError(getText(&quot;invitePatientAction.err.invitee_not_verified&quot;, new String[]{fullName}));</span>
<span class="nc" id="L128">                    return Action.INPUT;</span>
                }
            }

<span class="pc bpc" id="L132" title="1 of 2 branches missed.">            if (userWebBean.isSameUser(emailId)) {</span>
<span class="nc" id="L133">                result = Action.INPUT;</span>
<span class="nc" id="L134">                String fullName = invitee.getTitle() + &quot; &quot; + invitee.getFirstName() + &quot; &quot; + invitee.getLastName();</span>
<span class="nc" id="L135">                addActionError(getText(&quot;invitePatientAction.err.cannot_invite_yourself&quot;, new String[]{fullName}));</span>
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">            } else if (userWebBean.invitedAlready(emailId)) {</span>
<span class="nc" id="L137">                result = Action.INPUT;</span>
<span class="nc" id="L138">                String fullName = invitee.getTitle() + &quot; &quot; + invitee.getFirstName() + &quot; &quot; + invitee.getLastName();</span>
<span class="nc" id="L139">                addActionError(getText(&quot;invitePatientAction.err.already_invited_patient&quot;, new String[]{fullName}));</span>
<span class="nc" id="L140">            } else {</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">                if (invitee.getStatus() == UserStatus.EMAIL_CONFIRMED) {</span>
                    // Check if the inviter already has access to invited user
<span class="fc" id="L143">                    boolean hasAccess = userWebBean.hasIndivAccountAccess(</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">                            contextUser != null ? contextUser : loggedUser, invitee);</span>
<span class="fc" id="L145">                    LOGGER.info(&quot;hasAccess-{}&quot;, hasAccess);</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">                    if (hasAccess) {</span>
<span class="nc" id="L147">                        result = Action.INPUT;</span>
<span class="nc" id="L148">                        addActionError(getText(&quot;invitePatientAction.err.already_has_access&quot;,</span>
<span class="nc" id="L149">                                new String[]{invitee.getTitle(), invitee.getLastName()}));</span>
<span class="nc" id="L150">                        return result;</span>
                    }
<span class="pc bpc" id="L152" title="1 of 4 branches missed.">                } else if (config.getEnableNotWorkingInvitationError() &amp;&amp; invitee.getStatus() == UserStatus.CREATED) {</span>
<span class="fc" id="L153">                    result = Action.INPUT;</span>
<span class="fc" id="L154">                    LOGGER.error(&quot;Error while inviting non registered patient. Issue will be solved in PHR-11113&quot;);</span>
<span class="fc" id="L155">                    addActionError(getText(&quot;invitePatientAction.err.cannot_invite_non_registered_patient&quot;,</span>
<span class="fc" id="L156">                            new String[]{Objects.requireNonNull(invitee.getEmail()).toString()}));</span>
<span class="fc" id="L157">                    return result;</span>
                }

<span class="fc" id="L160">                var requestContext = getLoggedInEHRRequestContext();</span>
<span class="fc" id="L161">                Long pkbAccountId = userManager.getDefaultAccountId(invitee.getId());</span>
<span class="fc" id="L162">                PKBInvitation invitation = userWebBean.populateInvitation(message, pkbAccountId, loggedUser.getId(), loggedUser.getUserType(), EnumSet.of(PrivacyFlag.GENERAL), requestContext);</span>
<span class="fc" id="L163">                invitation.setInvitationType(InvitationType.PATIENT_INVITATION);</span>
                try {
<span class="fc" id="L165">                    invitationManager.beginTransaction();</span>
<span class="fc" id="L166">                    invitationId = invitationManager.invitePatient(requestContext, invitee,</span>
<span class="fc" id="L167">                            invitation, loggedUser.getId(), false);</span>
<span class="fc" id="L168">                    invitationManager.commitTransaction();</span>
<span class="nc" id="L169">                } catch (PKBException e) {</span>
<span class="nc" id="L170">                    LOGGER.info(&quot;Error while inviting patient asking for access to records&quot;, e);</span>
<span class="nc" id="L171">                    addActionError(getText(&quot;invitePatientAction.err.error_inviting_patient&quot;));</span>
<span class="nc" id="L172">                    return Action.INPUT;</span>
                } finally {
<span class="fc" id="L174">                    invitationManager.rollbackIfNotCommitted();</span>
                }

                try {
                    // Log the activity
<span class="fc" id="L179">                    PKBPerson invitedPatient = userManager.getSinglePersonByEmail(emailId, PersonContact.Lazy.PERSON);</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">                    if (contextUser != null) {</span>
<span class="fc" id="L181">                        logActivityByOthers(com.pkb.notification.entity.Activity.Action.SENT_INVITATION, dateTimeService.now(), true, new NoConsentsRequired());</span>
                    } else {
<span class="nc" id="L183">                        logSelfActivity(invitedPatient.getId(), new NoConsentsRequired());</span>
                    }

<span class="fc" id="L186">                    addActionMessage(getText(&quot;invitePatientAction.msg.sent_invitation&quot;, new String[]{</span>
<span class="fc" id="L187">                            invitedPatient.getTitle(), invitedPatient.getFirstName(),</span>
<span class="fc" id="L188">                            invitedPatient.getLastName()}));</span>
<span class="nc" id="L189">                } catch (Exception e) {</span>
                    // Invitation succeeds but logging fails ; log the error and return success
<span class="nc" id="L191">                    LOGGER.info(&quot;Error while logging the activity of inviting patient asking for access to records&quot;, e);</span>
<span class="nc" id="L192">                    return Action.SUCCESS;</span>
<span class="fc" id="L193">                }</span>
            }
<span class="nc" id="L195">        } catch (Exception e) {</span>
<span class="nc" id="L196">            LOGGER.info(&quot;Error while inviting patient asking for access to records&quot;, e);</span>
<span class="nc" id="L197">            addActionError(getText(&quot;invitePatientAction.err.error_inviting_patient&quot;));</span>
<span class="fc" id="L198">        }</span>
<span class="fc" id="L199">        return result;</span>
    }

    public String getMessage() {
<span class="fc" id="L203">        return message;</span>
    }

    public void setMessage(String message) {
<span class="fc" id="L207">        this.message = message;</span>
<span class="fc" id="L208">    }</span>

    public String getFirstName() {
<span class="fc" id="L211">        return firstName;</span>
    }

    public void setFirstName(String firstName) {
<span class="fc" id="L215">        this.firstName = firstName.trim();</span>
<span class="fc" id="L216">    }</span>

    public String getLastName() {
<span class="fc" id="L219">        return lastName;</span>
    }

    public void setLastName(String lastName) {
<span class="fc" id="L223">        this.lastName = lastName.trim();</span>
<span class="fc" id="L224">    }</span>

    public Email getEmailId() {
<span class="fc" id="L227">        return emailId;</span>
    }

    public void setEmailId(Email emailId) {
<span class="fc" id="L231">        this.emailId = emailId;</span>
<span class="fc" id="L232">    }</span>

    public void setUserWebBean(IUserWebBean userWebBean) {
<span class="fc" id="L235">        this.userWebBean = userWebBean;</span>
<span class="fc" id="L236">    }</span>

    public String getDomain() {
<span class="fc" id="L239">        return domain;</span>
    }

    public void setDomain(String domain) {
<span class="fc" id="L243">        this.domain = domain;</span>
<span class="fc" id="L244">    }</span>

    public String getEmailAddress() {
<span class="nc" id="L247">        return emailId + domain;</span>
    }

    public UUID getInvitationId() {
<span class="fc" id="L251">        return invitationId;</span>
    }

    public void setInvitationId(UUID invitationId) {
<span class="fc" id="L255">        this.invitationId = invitationId;</span>
<span class="fc" id="L256">    }</span>

    public String getTitle() {
<span class="fc" id="L259">        return title;</span>
    }

    public void setTitle(String title) {
<span class="fc" id="L263">        this.title = title;</span>
<span class="fc" id="L264">    }</span>

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L267">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L268">    }</span>

    public void setInvitationManager(InvitationManager invitationManager) {
<span class="fc" id="L271">        this.invitationManager = invitationManager;</span>
<span class="fc" id="L272">    }</span>

    public String getPatientId() {
<span class="fc" id="L275">        return patientId;</span>
    }

    public void setPatientId(String patientId) {
<span class="fc" id="L279">        this.patientId = patientId;</span>
<span class="fc" id="L280">    }</span>

    public boolean isReadonly() {
<span class="fc" id="L283">        return readonly;</span>
    }

    public void setReadonly(boolean readonly) {
<span class="fc" id="L287">        this.readonly = readonly;</span>
<span class="fc" id="L288">    }</span>

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L291">        this.userManager = userManager;</span>
<span class="fc" id="L292">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>