<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GetInvitationsAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.invitation</a> &gt; <span class="el_source">GetInvitationsAction.java</span></div><h1>GetInvitationsAction.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------

//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: GetInvitatonsAction.java Jun 3, 2009 2:35:47 PM mahendera$
//
//------------------------------------------------------------------------------

package com.pkb.action.invitation;


import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.dto.PKBInvitationDTO;
import com.pkb.encounter.entity.PKBInvitation;
import com.pkb.entities.enums.SponsorshipStatus;
import com.pkb.entities.enums.InvitationType;
import com.pkb.exception.PKBException;
import com.pkb.institute.entity.Team;
import com.pkb.service.invitation.impl.InvitationManager;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

import static com.pkb.entities.enums.InvitationStatus.NEW;


/**
 * Gets the invitations for a user

import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;
import java.util.List;

/**
 * Gets the invitations for a user


import java.util.ArrayList;
import java.util.List;

/**
 * Gets the invitations for a user
 *
 * @author mahendera
 */
<span class="fc" id="L59">public class GetInvitationsAction extends BaseAction {</span>

    private static final long serialVersionUID = 1L;

    private TeamUserManager teamUserManager;

    private boolean showInviteSuccessMessage;

    private boolean showResendSuccessMessage;

    private boolean showRemindSuccessMessage;

    private boolean showAcceptUpgradeAccountSuccessMessage;

    private boolean showSwitchAccountSuccessMessage;

    private boolean showRejectedSwitchAccountSuccessMessage;

    private boolean showAutomaticResendSuccessMessage;

    private String invitationId;

    private List&lt;PKBInvitationDTO&gt; invitationList;

    private TeamManager teamManager;

    private InvitationManager invitationManager;

    private PKBPerson instituteAdmin;

<span class="fc" id="L89">    private String tab = &quot;invitations&quot;;</span>

<span class="fc" id="L91">    private String subTab = &quot;invitationList&quot;;</span>

<span class="fc" id="L93">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    /**
     * API is to fetch the invitation list and total count from database Set the
     * page size and offset for pagination
     */
    @Override
    public String execute() {
<span class="fc" id="L101">        LOGGER.info(&quot;Entering execute&quot;);</span>
<span class="fc" id="L102">        String result = Action.SUCCESS;</span>

        try {
<span class="fc" id="L105">            invitationList = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">            if (loggedInUserUtil.isLoggedInUserTeamProfessional()</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">                    || loggedInUserUtil.isIdentityVerifiedPatientOrOnBehalfOfOne(contextUserUtil.getContextUser())) {</span>

<span class="fc" id="L109">                long authorUserId = contextUserUtil.getContextOrLoggedInUserId();</span>
<span class="fc" id="L110">                Long contextUserId = contextUserUtil.getContextUserId();</span>
<span class="fc" id="L111">                List&lt;PKBInvitation&gt; invitations = invitationManager.getInvitations(authorUserId);</span>
                PKBInvitationDTO dto;
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">                if (invitations != null) {</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">                    for (PKBInvitation pkbInvitation : invitations) {</span>
                        // filter to include ONLY active invitations
<span class="fc bfc" id="L116" title="All 2 branches covered.">                        if (pkbInvitation.getInvitationStatus() == NEW) {</span>
<span class="fc" id="L117">                            dto = toDTO(pkbInvitation);</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">                            if (dto == null) {</span>
<span class="nc" id="L119">                                continue;</span>
                            }
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">                            if (contextUserId != null) {</span>
                                // for a clinician/caregiver viewing patients account
                                // show only those invitations where patient is the author for reminding purpose
                                // not the invitations sent to patient which will require patient's acceptance
<span class="nc bnc" id="L125" title="All 2 branches missed.">                                if (dto.getAuthorUser().getId().equals(contextUserId)) {</span>
<span class="nc" id="L126">                                    invitationList.add(dto);</span>
                                }
                            } else {
<span class="fc" id="L129">                                invitationList.add(dto);</span>
                            }
                        }
<span class="fc" id="L132">                    }</span>
                }
<span class="fc" id="L134">                String msg = getSuccessMessage();</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">                if (msg != null) {</span>
                    //noinspection StrutsI18nError,SSBasedInspection
<span class="fc" id="L137">                    addActionMessage(msg);</span>
                }
            }
<span class="nc" id="L140">        } catch (Exception exception) {</span>
<span class="nc" id="L141">            result = Action.ERROR;</span>
<span class="nc" id="L142">            LOGGER.error(&quot;Error while getting invitations&quot;, exception);</span>
<span class="fc" id="L143">        }</span>

<span class="fc" id="L145">        LOGGER.info(&quot;Exiting execute result : {}&quot;, result);</span>
<span class="fc" id="L146">        return result;</span>
    }

    /**
     * Convert PKBInvitation into PKBInvitationDTO.
     * Set senderUserType and receiverUserType and check if the user is an institute
     * user or not.
     */
    private PKBInvitationDTO toDTO(PKBInvitation pkbInvitation) {
<span class="fc" id="L155">        PKBInvitationDTO pkbInvitationDTO = new PKBInvitationDTO();</span>
<span class="fc" id="L156">        pkbInvitationDTO.setInvitation(pkbInvitation);</span>
<span class="fc" id="L157">        PKBPerson author = userManager.getPKBPerson(pkbInvitation.getAuthorUserId(), PKBPerson.Lazy.CONTACTS);</span>
<span class="fc" id="L158">        pkbInvitationDTO.setAuthorUser(author);</span>

        //skip the invitation with no author
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">        if (author == null) {</span>
<span class="nc" id="L162">            return null;</span>
        }

<span class="pc bpc" id="L165" title="1 of 2 branches missed.">        if (pkbInvitation.getInvitationType() == InvitationType.CLINICIAN_INVITATION_TO_UPGRADE_ACCOUNT) {</span>
<span class="nc" id="L166">            pkbInvitationDTO.setInvitationDTOType(&quot;UPGRADE_ACCOUNT&quot;);</span>
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">        } else if (pkbInvitation.getInvitationType() == InvitationType.PATIENT_INVITATION_TO_JOIN_TEAM) {</span>
<span class="nc" id="L168">            pkbInvitationDTO.setInvitationDTOType(&quot;JOIN_TEAM&quot;);</span>
            //institute code of the author
        }

<span class="fc" id="L172">        List&lt;Team&gt; instList = teamUserManager.getUserTeams(getEHRRequestContext(), author.getId(), true);</span>
<span class="pc bpc" id="L173" title="2 of 4 branches missed.">        if ((instList != null) &amp;&amp; (instList.size() == 1)) {</span>
            // Baaad - should have been set when the invitation was created
<span class="fc" id="L175">            pkbInvitationDTO.getInvitation().getInvitationDetail().setInstituteCode(instList.get(0).getCode());</span>
<span class="fc" id="L176">            pkbInvitationDTO.getInvitation().getInvitationDetail().setTeamName(instList.get(0).getName());</span>
        }

<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        if (teamUserManager.isTeamUser(author.getId())</span>
<span class="pc bpc" id="L180" title="1 of 2 branches missed.">                &amp;&amp; checkInstituteUserStatus(author.getId())) {</span>
<span class="fc" id="L181">            pkbInvitationDTO.setSenderUserType(&quot;INSTITUTE_USER&quot;);</span>
        } else {
<span class="nc" id="L183">            pkbInvitationDTO.setSenderUserType(author.getUserType()</span>
<span class="nc" id="L184">                    .toString());</span>
        }

<span class="fc" id="L187">        pkbInvitationDTO.setTargetEmail(pkbInvitation.getTargetEmail());</span>

        // Rare case : if the target user is deleted
<span class="fc" id="L190">        PKBPerson targetUser = pkbInvitation.getTargetUser();</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">        if (targetUser != null) {</span>
<span class="fc bfc" id="L192" title="All 2 branches covered.">            if (teamUserManager.isTeamUser(targetUser.getId())</span>
<span class="fc bfc" id="L193" title="All 2 branches covered.">                    &amp;&amp; checkInstituteUserStatus(pkbInvitation</span>
<span class="fc" id="L194">                    .getTargetUser().getId())) {</span>
<span class="fc" id="L195">                pkbInvitationDTO.setReceiverUserType(&quot;INSTITUTE_USER&quot;);</span>
            } else {
<span class="fc" id="L197">                pkbInvitationDTO.setReceiverUserType(pkbInvitation</span>
<span class="fc" id="L198">                        .getTargetUser().getUserType().toString());</span>
            }
        }
<span class="fc" id="L201">        return pkbInvitationDTO;</span>
    }

    private boolean checkInstituteUserStatus(long userId) {
        try {
<span class="fc" id="L206">            return userManager.findIdentityVerification(userId).isPresent();</span>
<span class="nc" id="L207">        } catch (Exception e) {</span>
<span class="nc" id="L208">            LOGGER.error(&quot;Exception while checking the verification status for {}&quot;, userId, e);</span>
        }
<span class="nc" id="L210">        return false;</span>
    }

    /**
     * Customize the success message based the action performed by the user 1)
     * Sent a new invitation 2) Resend the previous invitation 3) Accept the
     * invitation
     * &lt;p&gt;
     * TODO: These should be addActionMessage() calls in the originating actions.
     * There was once a bug where action messages were lost in redirects; it was fixed.
     * When possible, please refactor this to use normal action messages.
     */
    private String getSuccessMessage() throws NumberFormatException {
<span class="fc bfc" id="L223" title="All 2 branches covered.">        if (StringUtils.isEmpty(invitationId)) {</span>
<span class="fc" id="L224">            return null;</span>
        }

<span class="fc" id="L227">        PKBPerson user = null;</span>
<span class="fc" id="L228">        String successMsg = null;</span>
<span class="fc" id="L229">        UUID invitationPublicId = invitationManager.getInvitationIdByString(invitationId);</span>
<span class="fc" id="L230">        PKBInvitation pkbInvitation = invitationManager.getInvitation(getLoggedInEHRRequestContext(),invitationPublicId);</span>

<span class="pc bpc" id="L232" title="1 of 2 branches missed.">        if (showInviteSuccessMessage) {</span>
<span class="nc" id="L233">            user = pkbInvitation.getTargetUser();</span>
<span class="nc" id="L234">            successMsg = &quot;getInvitationsAction.msg.sent_invitation&quot;;</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">        } else if (showResendSuccessMessage) {</span>
<span class="fc" id="L236">            user = pkbInvitation.getTargetUser();</span>
<span class="fc" id="L237">            successMsg = &quot;getInvitationsAction.msg.resent_invitation&quot;;</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        } else if (showAutomaticResendSuccessMessage) {</span>
<span class="nc" id="L239">            user = pkbInvitation.getTargetUser();</span>
<span class="nc" id="L240">            successMsg = &quot;getInvitationsAction.msg.sent_reminder&quot;;</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">        } else if (showRemindSuccessMessage) {</span>
<span class="nc" id="L242">            user = userManager.getPKBPerson(pkbInvitation.getAuthorUserId());</span>
<span class="nc" id="L243">            successMsg = &quot;getInvitationsAction.msg.sent_reminder&quot;;</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">        } else if (showAcceptUpgradeAccountSuccessMessage) {</span>
<span class="fc" id="L245">            user = userManager.getPKBPerson(pkbInvitation.getAuthorUserId());</span>
<span class="fc" id="L246">            successMsg = &quot;getInvitationsAction.msg.accepted_invitation&quot;;</span>
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">        } else if (showSwitchAccountSuccessMessage) {</span>
<span class="nc" id="L248">            user = userManager.getPKBPerson(pkbInvitation.getAuthorUserId());</span>
<span class="nc" id="L249">            successMsg = &quot;getInvitationsAction.msg.accepted_invitation&quot;;</span>
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">        } else if (showRejectedSwitchAccountSuccessMessage) {</span>
<span class="nc" id="L251">            user = userManager.getPKBPerson(pkbInvitation.getAuthorUserId());</span>
<span class="nc" id="L252">            successMsg = &quot;getInvitationsAction.msg.rejected_invitation&quot;;</span>
        }

<span class="pc bpc" id="L255" title="1 of 4 branches missed.">        if ((successMsg != null) &amp;&amp; (user != null)) {</span>
<span class="fc" id="L256">            return getText(successMsg, new String[]{user.getTitle(), user.getFirstName(), user.getLastName()});</span>
        } else {
<span class="fc" id="L258">            return null;</span>
        }

    }

    /**
     * used for /patient/becomeInstituteUser.action
     */
    public String nonInstituteClinician() {
<span class="fc" id="L267">        long loggedInUserID = loggedInUserUtil.getLoggedInUserId();</span>
        try {
<span class="fc bfc" id="L269" title="All 2 branches covered.">            if (teamUserManager.isTeamUser(loggedInUserID)) {</span>
<span class="fc" id="L270">                List&lt;Team&gt; userInstitutes = teamUserManager.getUserTeams(getEHRRequestContext(), loggedInUserID, false/*activeOnly*/);</span>
<span class="pc bpc" id="L271" title="1 of 2 branches missed.">                if (userInstitutes.isEmpty()) {</span>
<span class="nc" id="L272">                    userInstitutes = teamManager.getUserTeamsByStatus(loggedInUserID,</span>
                            SponsorshipStatus.INACTIVE);
<span class="nc bnc" id="L274" title="All 4 branches missed.">                    if ((userInstitutes != null) &amp;&amp; (userInstitutes.size() == 1)) {</span>
                        // just grab first admin for now
<span class="nc" id="L276">                        List&lt;PKBPerson&gt; adminList = teamManager.getTeamCoord(userInstitutes.get(0).getId());</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">                        instituteAdmin = (adminList.isEmpty()) ? null : adminList.get(0);</span>
<span class="nc" id="L278">                    }</span>
                } else {
                    // just grab first admin for now
<span class="fc" id="L281">                    List&lt;PKBPerson&gt; adminList = teamManager.getTeamCoord(userInstitutes.get(0).getId());</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">                    instituteAdmin = (adminList.isEmpty()) ? null : adminList.get(0);</span>
                }
            }

<span class="nc" id="L286">        } catch (PKBException exception) {</span>
<span class="nc" id="L287">            LOGGER.error(&quot;error getting institutes for {}&quot;, loggedInUserID, exception);</span>
<span class="nc" id="L288">            addActionError(getText(&quot;getInvitationsAction.err.error_getting_teams&quot;));</span>
<span class="fc" id="L289">        }</span>

<span class="fc" id="L291">        return SUCCESS;</span>
    }

    public void setShowInviteSuccessMessage(boolean showInviteSuccessMessage) {
<span class="nc" id="L295">        this.showInviteSuccessMessage = showInviteSuccessMessage;</span>
<span class="nc" id="L296">    }</span>

    public void setShowResendSuccessMessage(boolean showResendSuccessMessage) {
<span class="fc" id="L299">        this.showResendSuccessMessage = showResendSuccessMessage;</span>
<span class="fc" id="L300">    }</span>

    public List&lt;PKBInvitationDTO&gt; getInvitationList() {
<span class="fc" id="L303">        return invitationList;</span>
    }

    public void setInvitationList(List&lt;PKBInvitationDTO&gt; invitationList) {
<span class="nc" id="L307">        this.invitationList = invitationList;</span>
<span class="nc" id="L308">    }</span>

    public void setTeamUserManager(
            TeamUserManager teamUserManager) {
<span class="fc" id="L312">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L313">    }</span>

    public void setShowRemindSuccessMessage(boolean showRemindSuccessMessage) {
<span class="nc" id="L316">        this.showRemindSuccessMessage = showRemindSuccessMessage;</span>
<span class="nc" id="L317">    }</span>

    public String getInvitationId() {
<span class="nc" id="L320">        return invitationId;</span>
    }

    public void setInvitationId(String invitationId) {
<span class="fc" id="L324">        this.invitationId = invitationId;</span>
<span class="fc" id="L325">    }</span>

    public PKBPerson getInstituteAdmin() {
<span class="fc" id="L328">        return instituteAdmin;</span>
    }

    public void setInstituteAdmin(PKBPerson instituteAdmin) {
<span class="nc" id="L332">        this.instituteAdmin = instituteAdmin;</span>
<span class="nc" id="L333">    }</span>

    public void setTeamManager(TeamManager teamManager) {
<span class="fc" id="L336">        this.teamManager = teamManager;</span>
<span class="fc" id="L337">    }</span>

    public void setShowAcceptUpgradeAccountSuccessMessage(
            boolean showAcceptUpgradeAccountSuccessMessage) {
<span class="fc" id="L341">        this.showAcceptUpgradeAccountSuccessMessage = showAcceptUpgradeAccountSuccessMessage;</span>
<span class="fc" id="L342">    }</span>

    public void setShowSwitchAccountSuccessMessage(
            boolean showSwitchAccountSuccessMessage) {
<span class="nc" id="L346">        this.showSwitchAccountSuccessMessage = showSwitchAccountSuccessMessage;</span>
<span class="nc" id="L347">    }</span>

    public void setShowRejectedSwitchAccountSuccessMessage(
            boolean showRejectedSwitchAccountSuccessMessage) {
<span class="nc" id="L351">        this.showRejectedSwitchAccountSuccessMessage = showRejectedSwitchAccountSuccessMessage;</span>
<span class="nc" id="L352">    }</span>

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L355">        this.userManager = userManager;</span>
<span class="fc" id="L356">    }</span>

    public void setInvitationManager(InvitationManager invitationManager) {
<span class="fc" id="L359">        this.invitationManager = invitationManager;</span>
<span class="fc" id="L360">    }</span>

    public String getTab() {
<span class="fc" id="L363">        return tab;</span>
    }

    public String getSubTab() {
<span class="fc" id="L367">        return subTab;</span>
    }

    public void setShowAutomaticResendSuccessMessage(boolean showAutomaticResendSuccessMessage) {
<span class="nc" id="L371">        this.showAutomaticResendSuccessMessage = showAutomaticResendSuccessMessage;</span>
<span class="nc" id="L372">    }</span>

    public void setTab(String tab) {
<span class="fc" id="L375">        this.tab = tab;</span>
<span class="fc" id="L376">    }</span>

    public void setSubTab(String subTab) {
<span class="fc" id="L379">        this.subTab = subTab;</span>
<span class="fc" id="L380">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>