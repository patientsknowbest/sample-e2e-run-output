<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InviteClinicianAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.invitation</a> &gt; <span class="el_source">InviteClinicianAction.java</span></div><h1>InviteClinicianAction.java</h1><pre class="source lang-java linenums">package com.pkb.action.invitation;

import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.bean.IUserWebBean;
import com.pkb.datamodel.Email;
import com.pkb.entities.enums.PrivacyFlag;
import com.pkb.entities.enums.UserType;
import com.pkb.exception.PKBException;
import com.pkb.exception.PatientAlreadyInTeamException;
import com.pkb.service.invitation.impl.InvitationManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.PersonContactManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PersonContact;
import com.pkb.util.PKBConstants;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.EnumSet;
import java.util.List;
import java.util.UUID;

import static org.apache.commons.lang3.StringUtils.isBlank;

/**
 * This class is only used for admins inviting an individual professional for a patient.
 * It should probably be replaced by some more intelligent logic in PatientConsentTeamAction
 */
<span class="fc" id="L31">public class InviteClinicianAction extends BaseAction {</span>

<span class="fc" id="L33">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>
    private static final long serialVersionUID = 1L;

    private IUserWebBean userWebBean;
    private TeamUserManager teamUserManager;
    private PersonContactManager personContactManager;
    private InvitationManager invitationManager;

    private UUID invitationId;

    private String title;

    private String firstName;

    private String lastName;

    private Email emailId;

    private String message;

    private String clinicianId;

    private String tab;

    private boolean hideEmail;

    private Long patientId;
    private Long userId;

    private PKBPerson patient;

    //For returning to activatedPatients.action after error
    private String searchString;
    private String searchIdType; // national/org/team
    private String searchId;
    private String searchName;
    private String searchDobYear;
    private String searchDobMonth;
    private String searchDobDay;
    private String searchLevel;

    private String from;

    private boolean generalHealthConsentGranted;
    private boolean sexualHealthConsentGranted;
    private boolean mentalHealthConsentGranted;
    private boolean socialCareConsentGranted;

    private boolean canGrantGeneralHealthConsent;
    private boolean canGrantSexualHealthConsent;
    private boolean canGrantMentalHealthConsent;
    private boolean canGrantSocialCareConsent;

    /**
     * An invitation will be sent to the specified clinician if the given email
     * id is valid with respect to the following conditions. Check if the
     * clinician is already invited. If yes show an error message and exit.
     * Check if the entered email id matches with the currently logged in user.
     * If yes show an error message and exit. Check if the invitee is already
     * registered with the system as a clinician. If yes show an error message
     * and exit as a clinician can not invite another clinician. If any
     * exception comes while sending the invitation show a generalized error
     * message.
     */

    // Called to invite a clinician for a specific patient
    public String inviteClinicianForPatient() {
        try {
<span class="fc bfc" id="L101" title="All 2 branches covered.">            if (patientId != null) {</span>
<span class="fc" id="L102">                patient = userManager.getPKBPerson(patientId, PKBPerson.Lazy.CONTACTS, PKBPerson.Lazy.PROPERTIES);</span>
            } else {
<span class="fc" id="L104">                patient = contextUserUtil.getContextUser();</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">                if (patient == null) {</span>
<span class="fc" id="L106">                    patient = loggedInUserUtil.getLoggedInUser(PKBPerson.Lazy.PROPERTIES);</span>
                }
<span class="fc" id="L108">                patientId = patient.getId();</span>
            }

<span class="fc" id="L111">            PKBPerson author = loggedInUserUtil.getLoggedInUser();</span>

            PKBPerson clinician;
<span class="fc" id="L114">            Email emailId = this.emailId;</span>
<span class="fc" id="L115">            List&lt;PersonContact&gt; clinicianContacts = personContactManager.findPersonByConfirmedOrPrimaryEmail(emailId, PersonContact.Lazy.PERSON_W_CONTACTS);</span>

<span class="fc bfc" id="L117" title="All 2 branches covered.">            if (clinicianContacts.isEmpty()) {</span>
<span class="fc" id="L118">                clinician = userWebBean.populateInvitee(</span>
<span class="fc" id="L119">                        getEHRRequestContext(), firstName, lastName, emailId, title, patient.getLanguageCode());</span>
<span class="fc" id="L120">                clinician.setUserType(UserType.REG_CLINICIAN);</span>
            } else {
                // TODO - intelligently pick the right person to process (based on...what?)
<span class="fc" id="L123">                clinician = clinicianContacts.get(0).getPerson();</span>

<span class="pc bpc" id="L125" title="1 of 2 branches missed.">                if (clinician.getId().equals(patient.getId())) {</span>
<span class="nc" id="L126">                    addActionError(getText(&quot;inviteClinicianAction.err.cannot_invite_yourself&quot;, new String[]{clinician.getFullName()}));</span>
<span class="nc" id="L127">                    return INPUT;</span>
                }

<span class="pc bpc" id="L130" title="1 of 2 branches missed.">                if (!clinician.isPro()) {</span>
<span class="nc" id="L131">                    addFieldError(&quot;emailId&quot;,</span>
<span class="nc" id="L132">                            getText(&quot;inviteClinicianAction.err.invitee_not_clinician&quot;, new String[]{clinician.getFullName()}));</span>
<span class="nc" id="L133">                    return INPUT;</span>
                }

<span class="pc bpc" id="L136" title="1 of 2 branches missed.">                if (userWebBean.hasIndivAccountAccess(clinician, patient)) {</span>
<span class="nc" id="L137">                    addFieldError(&quot;emailId&quot;, getText(&quot;inviteClinicianAction.err.already_has_access&quot;,</span>
<span class="nc" id="L138">                            new String[]{clinician.getTitle(), clinician.getLastName()}));</span>
<span class="nc" id="L139">                    return Action.INPUT;</span>
                }
            }

            try {
<span class="fc" id="L144">                userWebBean.inviteClinicianForPatient(getLoggedInEHRRequestContext(), patient, author, clinician, message, getConsentSettings());</span>
<span class="fc" id="L145">            } catch (PatientAlreadyInTeamException e) {</span>
<span class="fc" id="L146">                LOGGER.warn(e.getMessage(), e);</span>
<span class="fc" id="L147">                addFieldError(&quot;emailId&quot;, getText(&quot;inviteClinicianAction.err.already_has_access_via_team&quot;,</span>
<span class="fc" id="L148">                        new String[]{e.getTeamName()}));</span>
<span class="fc" id="L149">                return INPUT;</span>
<span class="fc" id="L150">            }</span>

<span class="fc" id="L152">            addActionMessage(getText(&quot;inviteClinicianAction.msg.sent_invitation_to_email&quot;, new String[]{emailId.address()}));</span>
<span class="fc" id="L153">            return SUCCESS;</span>

<span class="nc" id="L155">        } catch (Exception exception) {</span>
<span class="nc" id="L156">            throw new PKBException(&quot;Exception while inviting clinician-&quot; + clinicianId + &quot; for patient-&quot; + patientId, exception);</span>
        }
    }

    private EnumSet&lt;PrivacyFlag&gt; getConsentSettings() {
        // Normally we can grant any consents (coord/patient granting consent)
<span class="fc bfc" id="L162" title="All 2 branches covered.">        if (!getLoggedInEHRRequestContext().isPro()) {</span>
<span class="fc" id="L163">            canGrantGeneralHealthConsent = true;</span>
<span class="fc" id="L164">            canGrantSexualHealthConsent = true;</span>
<span class="fc" id="L165">            canGrantMentalHealthConsent = true;</span>
<span class="fc" id="L166">            canGrantSocialCareConsent = true;</span>
        }

<span class="fc" id="L169">        EnumSet&lt;PrivacyFlag&gt; consentSettings = EnumSet.noneOf(PrivacyFlag.class);</span>
<span class="pc bpc" id="L170" title="1 of 4 branches missed.">        if (canGrantGeneralHealthConsent &amp;&amp; generalHealthConsentGranted) {</span>
<span class="fc" id="L171">            consentSettings.add(PrivacyFlag.GENERAL);</span>
        }
<span class="fc bfc" id="L173" title="All 4 branches covered.">        if (canGrantSexualHealthConsent &amp;&amp; sexualHealthConsentGranted) {</span>
<span class="fc" id="L174">            consentSettings.add(PrivacyFlag.SEXUAL_HEALTH);</span>
        }
<span class="fc bfc" id="L176" title="All 4 branches covered.">        if (canGrantMentalHealthConsent &amp;&amp; mentalHealthConsentGranted) {</span>
<span class="fc" id="L177">            consentSettings.add(PrivacyFlag.MENTAL_HEALTH);</span>
        }
<span class="fc bfc" id="L179" title="All 4 branches covered.">        if(canGrantSocialCareConsent &amp;&amp; socialCareConsentGranted) {</span>
<span class="fc" id="L180">            consentSettings.add(PrivacyFlag.SOCIAL_CARE);</span>
        }
<span class="fc" id="L182">        return consentSettings;</span>
    }

    @Override
    public void validate() {
<span class="fc" id="L187">        tab = PKBConstants.INSTITUTE_TEAM;</span>

        // reminder: validation could also live in a file called InviteClinicianAction-validation.xml
<span class="pc bpc" id="L190" title="2 of 4 branches missed.">        if (isBlank(getTitle()) || &quot;-1&quot;.equals(getTitle())) {</span>
<span class="nc" id="L191">            addFieldError(&quot;title&quot;, getText(&quot;inviteClinicianAction.err.enter_title&quot;));</span>
        }
<span class="fc" id="L193">    }</span>


    public String inviteClinicianForPatientForm() {
<span class="fc" id="L197">        String returnCode = SUCCESS;</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">        if (patientId == null) {</span>
<span class="fc" id="L199">            patientId = userId; // Hack for userId coming from activatedPatients.jsp</span>
        }

<span class="pc bpc" id="L202" title="1 of 2 branches missed.">        if (patientId == null) {</span>
<span class="nc" id="L203">            addActionError(getText(&quot;inviteClinicianAction.err.please_select_patient&quot;));</span>
<span class="nc" id="L204">            returnCode = CANCEL;</span>
        } else {
<span class="fc" id="L206">            patient = userManager.getPKBPerson(patientId, PKBPerson.Lazy.CONTACTS, PKBPerson.Lazy.PROPERTIES);</span>
        }

<span class="fc" id="L209">        return returnCode;</span>
    }

    public String cancel() {
<span class="fc" id="L213">        contextUserId = contextUserUtil.getContextOrLoggedInUserId();</span>
<span class="fc" id="L214">        return from;</span>
    }

    public String getMessage() {
<span class="fc" id="L218">        return message;</span>
    }

    public void setMessage(String message) {
<span class="fc" id="L222">        this.message = message;</span>
<span class="fc" id="L223">    }</span>

    public String getFirstName() {
<span class="fc" id="L226">        return firstName;</span>
    }

    public void setFirstName(String firstName) {
<span class="fc" id="L230">        this.firstName = firstName.trim();</span>
<span class="fc" id="L231">    }</span>

    public String getLastName() {
<span class="fc" id="L234">        return lastName;</span>
    }

    public void setLastName(String lastName) {
<span class="fc" id="L238">        this.lastName = lastName.trim();</span>
<span class="fc" id="L239">    }</span>

    public Email getEmailId() {
<span class="fc" id="L242">        return emailId;</span>
    }

    public void setEmailId(Email emailId) {
<span class="fc" id="L246">        this.emailId = emailId;</span>
<span class="fc" id="L247">    }</span>

    public IUserWebBean getUserWebBean() {
<span class="nc" id="L250">        return userWebBean;</span>
    }

    public void setUserWebBean(IUserWebBean userWebBean) {
<span class="fc" id="L254">        this.userWebBean = userWebBean;</span>
<span class="fc" id="L255">    }</span>

    public UUID getInvitationId() {
<span class="nc" id="L258">        return invitationId;</span>
    }

    public void setInvitationId(UUID invitationId) {
<span class="nc" id="L262">        this.invitationId = invitationId;</span>
<span class="nc" id="L263">    }</span>

    public String getTitle() {
<span class="fc" id="L266">        return title;</span>
    }

    public void setTitle(String title) {
<span class="fc" id="L270">        this.title = title;</span>
<span class="fc" id="L271">    }</span>

    public UserManager getUserManager() {
<span class="nc" id="L274">        return userManager;</span>
    }

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L278">        this.userManager = userManager;</span>
<span class="fc" id="L279">    }</span>

    public String getClinicianId() {
<span class="nc" id="L282">        return clinicianId;</span>
    }

    public void setClinicianId(String clinicianId) {
<span class="nc" id="L286">        this.clinicianId = clinicianId;</span>
<span class="nc" id="L287">    }</span>

    public TeamUserManager getTeamUserManager() {
<span class="nc" id="L290">        return teamUserManager;</span>
    }

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L294">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L295">    }</span>

    public InvitationManager getInvitationManager() {
<span class="nc" id="L298">        return invitationManager;</span>
    }

    public void setInvitationManager(InvitationManager invitationManager) {
<span class="fc" id="L302">        this.invitationManager = invitationManager;</span>
<span class="fc" id="L303">    }</span>

    public PersonContactManager getPersonContactManager() {
<span class="nc" id="L306">        return personContactManager;</span>
    }

    public void setPersonContactManager(PersonContactManager personContactManager) {
<span class="fc" id="L310">        this.personContactManager = personContactManager;</span>
<span class="fc" id="L311">    }</span>

    public String getTab() {
<span class="fc" id="L314">        return tab;</span>
    }

    public void setTab(String tab) {
<span class="fc" id="L318">        this.tab = tab;</span>
<span class="fc" id="L319">    }</span>

    public boolean getHideEmail() {
<span class="fc" id="L322">        return hideEmail;</span>
    }

    public void setHideEmail(boolean hideEmail) {
<span class="nc" id="L326">        this.hideEmail = hideEmail;</span>
<span class="nc" id="L327">    }</span>

    public Long getPatientId() {
<span class="fc" id="L330">        return patientId;</span>
    }

    public void setPatientId(Long patientId) {
<span class="fc" id="L334">        this.patientId = patientId;</span>
<span class="fc" id="L335">    }</span>

    public PKBPerson getPatient() {
<span class="fc" id="L338">        return patient;</span>
    }

    public void setPatient(PKBPerson patient) {
<span class="nc" id="L342">        this.patient = patient;</span>
<span class="nc" id="L343">    }</span>

    public Long getUserId() {
<span class="nc" id="L346">        return userId;</span>
    }

    public void setUserId(Long userId) {
<span class="fc" id="L350">        this.userId = userId;</span>
<span class="fc" id="L351">    }</span>

    public String getSearchString() {
<span class="fc" id="L354">        return searchString;</span>
    }

    public void setSearchString(String searchString) {
<span class="fc" id="L358">        this.searchString = searchString;</span>
<span class="fc" id="L359">    }</span>

    public String getSearchIdType() {
<span class="fc" id="L362">        return searchIdType;</span>
    }

    public void setSearchIdType(String searchIdType) {
<span class="fc" id="L366">        this.searchIdType = searchIdType;</span>
<span class="fc" id="L367">    }</span>

    public String getSearchId() {
<span class="fc" id="L370">        return searchId;</span>
    }

    public void setSearchId(String searchId) {
<span class="fc" id="L374">        this.searchId = searchId;</span>
<span class="fc" id="L375">    }</span>

    public String getSearchName() {
<span class="fc" id="L378">        return searchName;</span>
    }

    public void setSearchName(String searchName) {
<span class="fc" id="L382">        this.searchName = searchName;</span>
<span class="fc" id="L383">    }</span>

    public String getSearchDobYear() {
<span class="fc" id="L386">        return searchDobYear;</span>
    }

    public void setSearchDobYear(String searchDobYear) {
<span class="fc" id="L390">        this.searchDobYear = searchDobYear;</span>
<span class="fc" id="L391">    }</span>

    public String getSearchDobMonth() {
<span class="fc" id="L394">        return searchDobMonth;</span>
    }

    public void setSearchDobMonth(String searchDobMonth) {
<span class="fc" id="L398">        this.searchDobMonth = searchDobMonth;</span>
<span class="fc" id="L399">    }</span>

    public String getSearchDobDay() {
<span class="fc" id="L402">        return searchDobDay;</span>
    }

    public void setSearchDobDay(String searchDobDay) {
<span class="fc" id="L406">        this.searchDobDay = searchDobDay;</span>
<span class="fc" id="L407">    }</span>

    public String getSearchLevel() {
<span class="fc" id="L410">        return searchLevel;</span>
    }

    public void setSearchLevel(String searchLevel) {
<span class="fc" id="L414">        this.searchLevel = searchLevel;</span>
<span class="fc" id="L415">    }</span>

    public String getFrom() {
<span class="fc" id="L418">        return from;</span>
    }

    public void setFrom(String from) {
<span class="fc" id="L422">        this.from = from;</span>
<span class="fc" id="L423">    }</span>

    public boolean isGeneralHealthConsentGranted() {
<span class="fc" id="L426">        return generalHealthConsentGranted;</span>
    }

    public void setGeneralHealthConsentGranted(boolean generalHealthConsentGranted) {
<span class="fc" id="L430">        this.generalHealthConsentGranted = generalHealthConsentGranted;</span>
<span class="fc" id="L431">    }</span>

    public boolean isSexualHealthConsentGranted() {
<span class="fc" id="L434">        return sexualHealthConsentGranted;</span>
    }

    public void setSexualHealthConsentGranted(boolean sexualHealthConsentGranted) {
<span class="fc" id="L438">        this.sexualHealthConsentGranted = sexualHealthConsentGranted;</span>
<span class="fc" id="L439">    }</span>

    public boolean isMentalHealthConsentGranted() {
<span class="fc" id="L442">        return mentalHealthConsentGranted;</span>
    }

    public void setMentalHealthConsentGranted(boolean mentalHealthConsentGranted) {
<span class="fc" id="L446">        this.mentalHealthConsentGranted = mentalHealthConsentGranted;</span>
<span class="fc" id="L447">    }</span>

    public boolean isSocialCareConsentGranted() {
<span class="fc" id="L450">        return socialCareConsentGranted;</span>
    }

    public void setSocialCareConsentGranted(boolean socialCareConsentGranted) {
<span class="fc" id="L454">        this.socialCareConsentGranted = socialCareConsentGranted;</span>
<span class="fc" id="L455">    }</span>

    public boolean isCanGrantGeneralHealthConsent() {
<span class="fc" id="L458">        return canGrantGeneralHealthConsent;</span>
    }

    public void setCanGrantGeneralHealthConsent(boolean canGrantGeneralHealthConsent) {
<span class="fc" id="L462">        this.canGrantGeneralHealthConsent = canGrantGeneralHealthConsent;</span>
<span class="fc" id="L463">    }</span>

    public boolean isCanGrantSexualHealthConsent() {
<span class="fc" id="L466">        return canGrantSexualHealthConsent;</span>
    }

    public void setCanGrantSexualHealthConsent(boolean canGrantSexualHealthConsent) {
<span class="fc" id="L470">        this.canGrantSexualHealthConsent = canGrantSexualHealthConsent;</span>
<span class="fc" id="L471">    }</span>

    public boolean isCanGrantMentalHealthConsent() {
<span class="fc" id="L474">        return canGrantMentalHealthConsent;</span>
    }

    public void setCanGrantMentalHealthConsent(boolean canGrantMentalHealthConsent) {
<span class="fc" id="L478">        this.canGrantMentalHealthConsent = canGrantMentalHealthConsent;</span>
<span class="fc" id="L479">    }</span>

    public boolean isCanGrantSocialCareConsent() {
<span class="fc" id="L482">        return canGrantSocialCareConsent;</span>
    }

    public void setCanGrantSocialCareConsent(boolean canGrantSocialCareConsent) {
<span class="fc" id="L486">        this.canGrantSocialCareConsent = canGrantSocialCareConsent;</span>
<span class="fc" id="L487">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>