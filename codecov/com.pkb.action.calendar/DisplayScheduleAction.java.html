<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DisplayScheduleAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.calendar</a> &gt; <span class="el_source">DisplayScheduleAction.java</span></div><h1>DisplayScheduleAction.java</h1><pre class="source lang-java linenums">package com.pkb.action.calendar;

import com.google.common.annotations.VisibleForTesting;
import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.calendar.entity.Event;
import com.pkb.dto.DayDTO;
import com.pkb.dto.MonthDTO;
import com.pkb.exception.PKBException;
import com.pkb.service.calendar.impl.CalendarManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.util.Constants;
import com.pkb.util.PKBConstants;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.text.ParseException;
import java.time.Instant;
import java.time.Month;
import java.time.YearMonth;
import java.time.ZonedDateTime;
import java.time.format.TextStyle;
import java.time.temporal.ChronoUnit;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.TimeZone;

/**
 * Action class to fetch and display user's schedule
 *
 * @author pravinam
 */
<span class="fc" id="L41">public class DisplayScheduleAction extends BaseAction {</span>
    private static final long serialVersionUID = 1L;

<span class="fc" id="L44">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private List&lt;MonthDTO&gt; months;
    private ZonedDateTime startDateInternal;
    private ZonedDateTime endDateInternal;

    private HashMap&lt;String, Event&gt; eventMap;

    private CalendarManager calendarManager;

    @Override
    public void validate() {
<span class="fc" id="L56">        super.validate();</span>
<span class="fc" id="L57">    }</span>

    private void getUserScheduleForDisplay() {
<span class="fc" id="L60">        getDateInterval();</span>
<span class="fc" id="L61">        List&lt;Event&gt; events = calendarManager.getSchedule(getLoggedInEHRRequestContext(), startDateInternal.toInstant(),</span>
<span class="fc" id="L62">                endDateInternal.toInstant());</span>
<span class="fc" id="L63">        months = prepareScheduleForDisplay(events, startDateInternal);</span>
<span class="fc" id="L64">    }</span>

    private void getDateInterval() {
<span class="fc" id="L67">        startDateInternal = dateTimeService.firstDayOfMonth();</span>
<span class="fc" id="L68">        endDateInternal = startDateInternal.plus(PKBConstants.SCHEDULE_MONTH_INTERVAL, ChronoUnit.MONTHS);</span>
<span class="fc" id="L69">    }</span>

    @Override
    public String input() {
        try {
<span class="fc" id="L74">            LOGGER.info(&quot;Entering -&gt; input schedule action&quot;);</span>
<span class="fc" id="L75">            getUserScheduleForDisplay();</span>
<span class="nc" id="L76">        } catch (PKBException exception) {</span>
<span class="nc" id="L77">            LOGGER.error(&quot;Exiting -&gt; while getting the schedule &quot;, exception);</span>
<span class="fc" id="L78">        }</span>
<span class="fc" id="L79">        return SUCCESS;</span>
    }

    public String update() {
<span class="fc" id="L83">        LOGGER.info(&quot;Entering -&gt; update schedule action&quot;);</span>
<span class="fc" id="L84">        String result = Action.SUCCESS;</span>
        try {
<span class="fc" id="L86">            LoggedInEHRRequestContext requestContext = getLoggedInEHRRequestContext();</span>
<span class="fc" id="L87">            List&lt;Event&gt; events = null;</span>
<span class="fc" id="L88">            getDateInterval();</span>
            // Get the checked dates
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">            if (getRequest().getParameterValues(&quot;daysAvailable&quot;) != null) {</span>
<span class="fc" id="L91">                String[] dates = getRequest().getParameterValues(&quot;daysAvailable&quot;);</span>
<span class="fc" id="L92">                events = convertToEventDTOs(dates, requestContext);</span>
            }

            // Update the schedule
<span class="fc" id="L96">            calendarManager.updateSchedule(requestContext, events, startDateInternal.toInstant(), endDateInternal.toInstant());</span>

<span class="fc" id="L98">            addActionMessage(getText(&quot;updateSchedule.txt.schedule_updated&quot;));</span>
<span class="nc" id="L99">        } catch (PKBException exception) {</span>
<span class="nc" id="L100">            result = Action.ERROR;</span>
<span class="nc" id="L101">            LOGGER.error(&quot;Error while updating schedule &quot;, exception);</span>
<span class="nc" id="L102">            addActionError(getText(&quot;displayScheduleAction.err.error_updating_schedule&quot;));</span>
<span class="nc" id="L103">        } catch (ParseException e) {</span>
<span class="nc" id="L104">            result = Action.ERROR;</span>
<span class="nc" id="L105">            LOGGER.error(&quot;Date parse error while creating events for updating schedule&quot;, e);</span>
<span class="nc" id="L106">            addActionError(getText(&quot;displayScheduleAction.err.error_updating_schedule&quot;));</span>
<span class="pc" id="L107">        }</span>
<span class="fc" id="L108">        LOGGER.info(&quot;Exiting -&gt; update schedule action&quot;);</span>
<span class="fc" id="L109">        return result;</span>
    }

    private int getFirstDayOfMonth(int month, int year) {
<span class="fc" id="L113">        Calendar cal = Calendar.getInstance();</span>
<span class="fc" id="L114">        cal.set(Calendar.DAY_OF_MONTH, 1);</span>
<span class="fc" id="L115">        cal.set(Calendar.MONTH, month);</span>
<span class="fc" id="L116">        cal.set(Calendar.YEAR, year);</span>
<span class="fc" id="L117">        int weekday = cal.get(Calendar.DAY_OF_WEEK);</span>
<span class="fc" id="L118">        return weekday;</span>
    }

    private Event convertToOutOfOfficeDTO(Instant date, EHRRequestContext requestContext) {
        Event event;
<span class="fc" id="L123">        event = new Event(new SourceDetails(requestContext));</span>
        //event.setEventType(EventType.OUT_OF_OFFICE);
<span class="fc" id="L125">        event.setStartDate(Date.from(date));</span>
<span class="fc" id="L126">        event.setEndDate(Date.from(date));</span>
<span class="fc" id="L127">        event.generateNewRandomUniqueId();</span>
<span class="fc" id="L128">        return event;</span>
    }

    // Take the list of dates available and make a list of corresponding events
    private List&lt;Event&gt; convertToEventDTOs(String[] dates, EHRRequestContext requestContext) throws ParseException {
<span class="fc" id="L133">        List&lt;Event&gt; events = new ArrayList&lt;&gt;();</span>
        Instant date;
        Event event;
<span class="fc" id="L136">        eventMap = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">        for (String d : dates) {</span>
<span class="fc" id="L138">            date = parseScheduleDate(d);</span>
<span class="fc" id="L139">            event = convertToOutOfOfficeDTO(date, requestContext);</span>
<span class="fc" id="L140">            events.add(event);</span>
<span class="fc" id="L141">            eventMap.put(toScheduleDate(date), event);</span>
        }
<span class="fc" id="L143">        return events;</span>
    }

    Instant parseScheduleDate(String input) {
<span class="fc" id="L147">        return dateTimeService.parseToInstantBackwardCompatibleWay(input, DayDTO.DATE_FORMATTER)._1;</span>
    }

    String toScheduleDate(Instant input) {
<span class="fc" id="L151">        return DayDTO.DATE_FORMATTER.format(input);</span>
    }

    /**
     * Compute the information necessary for display from the list of events
     *
     * @param events
     */
    @VisibleForTesting
    List&lt;MonthDTO&gt; prepareScheduleForDisplay(List&lt;Event&gt; events, ZonedDateTime start) {
<span class="fc" id="L161">        LOGGER.info(&quot;prepareScheduleForDisplay - Start&quot;);</span>
<span class="fc" id="L162">        List&lt;MonthDTO&gt; result = new ArrayList&lt;&gt;();</span>
        // Get current month
<span class="fc" id="L164">        Month currentMonth = start.getMonth();</span>
<span class="fc" id="L165">        int year = start.getYear();</span>
        MonthDTO monthDTO;
<span class="fc" id="L167">        Map&lt;YearMonth, Map&lt;Integer, DayDTO&gt;&gt; monthAvailabilityMap = getAvailabilityByMonth(events);</span>
<span class="fc" id="L168">        Locale currentLocale = getLocale();</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">        for (int i = 0; i &lt; PKBConstants.SCHEDULE_MONTH_INTERVAL; i++) {</span>
<span class="fc" id="L170">            monthDTO = new MonthDTO();</span>
<span class="fc" id="L171">            YearMonth yearMonth = YearMonth.of(year, currentMonth);</span>
<span class="fc" id="L172">            int daysInMonth = yearMonth.lengthOfMonth();</span>
<span class="fc" id="L173">            monthDTO.setDaysInMonth(daysInMonth);</span>
<span class="fc" id="L174">            monthDTO.setName(currentMonth.getDisplayName(TextStyle.FULL, currentLocale));</span>
<span class="fc" id="L175">            int firstDayOfMonth = getFirstDayOfMonth(currentMonth.ordinal(), year);</span>
<span class="fc" id="L176">            monthDTO.setFirstDayOfMonth(firstDayOfMonth);</span>
            // get events for month
<span class="fc" id="L178">            Map&lt;Integer, DayDTO&gt; monthMap = monthAvailabilityMap.get(yearMonth);</span>

<span class="fc" id="L180">            List&lt;DayDTO&gt; days = getAvailabilityForEachDay(monthDTO, monthMap, year, currentMonth.ordinal());</span>
<span class="fc" id="L181">            monthDTO.setDays(days);</span>
<span class="fc" id="L182">            result.add(monthDTO);</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">            if (currentMonth == Month.DECEMBER) {</span>
<span class="fc" id="L184">                year++;</span>
                // reset next month to January if the current one is December
<span class="fc" id="L186">                currentMonth = Month.JANUARY;</span>
            } else {
<span class="fc" id="L188">                currentMonth = currentMonth.plus(1L);</span>
            }
        }
<span class="fc" id="L191">        LOGGER.info(&quot;prepareScheduleForDisplay - End&quot;);</span>
<span class="fc" id="L192">        return result;</span>
    }

    private List&lt;DayDTO&gt; getAvailabilityForEachDay(MonthDTO monthDTO,
                                                   Map&lt;Integer, DayDTO&gt; monthMap, int year, int month) {
<span class="fc" id="L197">        int daysInMonth = monthDTO.getDaysInMonth();</span>
<span class="fc" id="L198">        List&lt;DayDTO&gt; days = new ArrayList&lt;&gt;();</span>
        DayDTO dayDTO;
<span class="fc" id="L200">        int totalVoidDays = monthDTO.getFirstDayOfMonth() - 1;</span>
        // Fill in the void days for each month for display purpose
<span class="fc bfc" id="L202" title="All 2 branches covered.">        for (int i = 0; i &lt; totalVoidDays; i++) {</span>
<span class="fc" id="L203">            dayDTO = new DayDTO();</span>
<span class="fc" id="L204">            dayDTO.setDayOfMonth(0);</span>
<span class="fc" id="L205">            dayDTO.setAvailable(true);</span>
<span class="fc" id="L206">            days.add(dayDTO);</span>
        }
        int day;
<span class="fc bfc" id="L209" title="All 2 branches covered.">        if (monthMap != null) {</span>
            // Set the user's availability for each day in month
<span class="fc bfc" id="L211" title="All 2 branches covered.">            for (int i = 0; i &lt; daysInMonth; i++) {</span>
<span class="fc" id="L212">                day = i + 1;</span>
<span class="fc" id="L213">                dayDTO = monthMap.get(day);</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">                if (dayDTO == null) {</span>
<span class="fc" id="L215">                    dayDTO = getDayDTO(year, month, day);</span>
                }
<span class="fc" id="L217">                days.add(dayDTO);</span>
            }
        } else {
            // By default the user is available for the month
<span class="fc bfc" id="L221" title="All 2 branches covered.">            for (int i = 0; i &lt; daysInMonth; i++) {</span>
<span class="fc" id="L222">                day = i + 1;</span>
<span class="fc" id="L223">                dayDTO = getDayDTO(year, month, day);</span>
<span class="fc" id="L224">                days.add(dayDTO);</span>
            }
        }
<span class="fc" id="L227">        return days;</span>
    }

    private DayDTO getDayDTO(int year, int month, int day) {
        DayDTO dayDTO;
<span class="fc" id="L232">        dayDTO = new DayDTO();</span>
<span class="fc" id="L233">        dayDTO.setDayOfMonth(day);</span>
<span class="fc" id="L234">        dayDTO.setAvailable(true);</span>
<span class="fc" id="L235">        Calendar cal = Calendar.getInstance();</span>
<span class="fc" id="L236">        cal.set(Calendar.DAY_OF_MONTH, day);</span>
<span class="fc" id="L237">        cal.set(Calendar.YEAR, year);</span>
<span class="fc" id="L238">        cal.set(Calendar.MONTH, month);</span>
<span class="fc" id="L239">        cal.set(Calendar.HOUR_OF_DAY, 0);</span>
<span class="fc" id="L240">        cal.set(Calendar.MINUTE, 0);</span>
<span class="fc" id="L241">        cal.set(Calendar.SECOND, 0);</span>
<span class="fc" id="L242">        cal.set(Calendar.MILLISECOND, 0);</span>
<span class="fc" id="L243">        cal.setTimeZone(TimeZone.getTimeZone(Constants.APPLICATION_TZ.getId()));</span>
<span class="fc" id="L244">        dayDTO.setDate(cal.getTime());</span>
<span class="fc" id="L245">        dayDTO.setDayOfWeek(cal.get(Calendar.DAY_OF_WEEK));</span>
<span class="fc" id="L246">        return dayDTO;</span>
    }

    @VisibleForTesting
    Map&lt;YearMonth, Map&lt;Integer, DayDTO&gt;&gt; getAvailabilityByMonth(List&lt;Event&gt; events) {
<span class="fc" id="L251">        LOGGER.info(&quot;getAvailabilityByMonth - Start&quot;);</span>
<span class="fc" id="L252">        Map&lt;YearMonth, Map&lt;Integer, DayDTO&gt;&gt; monthAvailabilityMap = new HashMap&lt;&gt;();</span>
        DayDTO dayDTO;
<span class="fc bfc" id="L254" title="All 2 branches covered.">        for (Event event : events) {</span>
<span class="fc" id="L255">            Instant date = event.getStartDate().toInstant();</span>
<span class="fc" id="L256">            ZonedDateTime zdt = ZonedDateTime.ofInstant(date, Constants.APPLICATION_TZ);</span>
<span class="fc" id="L257">            Month month = zdt.getMonth();</span>
<span class="fc" id="L258">            int day = zdt.getDayOfMonth();</span>
<span class="fc" id="L259">            int year = zdt.getYear();</span>
<span class="fc" id="L260">            int dayOfWeek = zdt.getDayOfWeek().ordinal();</span>

<span class="fc" id="L262">            Map&lt;Integer, DayDTO&gt; dayMap = monthAvailabilityMap.computeIfAbsent(YearMonth.of(year, month), k -&gt; new HashMap&lt;&gt;());</span>
<span class="fc" id="L263">            dayDTO = new DayDTO();</span>
<span class="fc" id="L264">            dayDTO.setDayOfMonth(day);</span>
<span class="fc" id="L265">            dayDTO.setAvailable(false);</span>
<span class="fc" id="L266">            dayDTO.setDayOfWeek(dayOfWeek);</span>
<span class="fc" id="L267">            dayDTO.setDate(event.getStartDate());</span>
<span class="fc" id="L268">            dayMap.put(day, dayDTO);</span>
<span class="fc" id="L269">        }</span>
<span class="fc" id="L270">        return monthAvailabilityMap;</span>
    }

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L274">        this.userManager = userManager;</span>
<span class="fc" id="L275">    }</span>

    public void setCalendarManager(CalendarManager calendarManager) {
<span class="fc" id="L278">        this.calendarManager = calendarManager;</span>
<span class="fc" id="L279">    }</span>

    public List&lt;MonthDTO&gt; getMonths() {
<span class="fc" id="L282">        return months;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>