<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AccessFilterMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.domain.repository.mapper</a> &gt; <span class="el_source">AccessFilterMapper.java</span></div><h1>AccessFilterMapper.java</h1><pre class="source lang-java linenums">package com.pkb.domain.repository.mapper;

import com.pkb.authentication.principal.team.BaseTeam;
import com.pkb.authentication.principal.user.AuthenticatedSystemUser;
import com.pkb.authentication.principal.user.AuthenticatedUser;
import com.pkb.authz.data.AuthorizationData;
import com.pkb.authz.data.AuthorizationInputs;
import com.pkb.datamodel.Identifiable;
import com.pkb.datamodel.authorization.TargetOwnerData;
import com.pkb.datamodel.consent.PatientConsent;
import com.pkb.datamodel.user.Person;
import com.pkb.datamodel.usertype.PatientType;
import com.pkb.datamodel.usertype.TeamProfessionalType;
import com.pkb.ehrdata.AccessFilter;
import com.pkb.ehrdata.ImmutableAccessFilter;
import com.pkb.ehrdata.ImmutablePrivacyFilter;
import io.vavr.control.Option;
import org.jetbrains.annotations.NotNull;

import static com.pkb.entities.enums.PrivacyFlag.GENERAL;
import static com.pkb.entities.enums.PrivacyFlag.MENTAL_HEALTH;
import static com.pkb.entities.enums.PrivacyFlag.SEXUAL_HEALTH;
import static com.pkb.entities.enums.PrivacyFlag.SOCIAL_CARE;

<span class="fc" id="L25">public class AccessFilterMapper {</span>
    @NotNull
    public AccessFilter buildAccessFilter(@NotNull AuthorizationData authData) {
<span class="fc" id="L28">        AuthorizationInputs inputs = authData.inputs();</span>
<span class="fc" id="L29">        AuthenticatedUser actor = inputs.authenticatedUser();</span>
<span class="fc" id="L30">        TargetOwnerData targetOwnerData = authData.requireSingleTargetData();</span>
<span class="fc" id="L31">        Person owner = targetOwnerData.person();</span>

<span class="fc" id="L33">        Option&lt;PatientConsent&gt; patientConsent = targetOwnerData.consent();</span>
<span class="fc" id="L34">        boolean actorIsOwner = inputs.findAuthenticatedUserWithActorPublicId()</span>
<span class="fc" id="L35">                .map(actorPublicId -&gt; actorPublicId.equals(owner.getPublicId()))</span>
<span class="fc" id="L36">                .getOrElse(false);</span>
<span class="fc" id="L37">        boolean actorIsTeamPro = actor instanceof TeamProfessionalType;</span>
<span class="fc" id="L38">        boolean ownerIsPatient = owner instanceof PatientType;</span>
<span class="fc" id="L39">        boolean systemUser = actor instanceof AuthenticatedSystemUser;</span>
<span class="fc" id="L40">        Option&lt;BaseTeam&gt; actorTeam = authData.inputs().authenticatedUserTeam();</span>

        // TODO: https://pkbdev.atlassian.net/browse/PHR-7728
        // System user is not catered for in this query
<span class="pc bpc" id="L44" title="1 of 4 branches missed.">        return ImmutableAccessFilter.builder()</span>
<span class="fc" id="L45">                .isTeamDataViewApplicable(actorIsTeamPro &amp;&amp; ownerIsPatient)</span>
<span class="pc bpc" id="L46" title="1 of 4 branches missed.">                .isPiggyback(false) // always false for now, see com.pkb.app.entity.EHRRequestContext#isPiggyback for more.</span>
<span class="fc" id="L47">                .isConsentNotRequired(systemUser || actorIsOwner)</span>
<span class="fc bfc" id="L48" title="All 2 branches covered.">                .isBreakTheGlassActive(false) // BTG not yet supported on FHIR</span>
<span class="fc" id="L49">                .isPatientViewSuspendedRequired(!actorIsTeamPro)</span>
<span class="fc" id="L50">                .actorPersonId(inputs.findAuthenticatedUserWithActorId().toJavaOptional())</span>
<span class="fc" id="L51">                .privacyFilter(buildPrivacyFilter(patientConsent))</span>
<span class="fc" id="L52">                .actorTeamId(actorTeam.map(Identifiable::getId).toJavaOptional())</span>
<span class="fc" id="L53">                .actorOrgId(actorTeam.map(BaseTeam::getOrgId).toJavaOptional())</span>
<span class="fc" id="L54">                .build();</span>
    }

    @NotNull
    private ImmutablePrivacyFilter buildPrivacyFilter(@NotNull Option&lt;PatientConsent&gt; patientConsent) {
<span class="fc" id="L59">        return ImmutablePrivacyFilter.builder()</span>
<span class="fc" id="L60">                .isGeneralConsentGranted(patientConsent.map(it -&gt; it.isGranted(GENERAL)).getOrElse(false))</span>
<span class="fc" id="L61">                .isMentalHealthConsentGranted(patientConsent.map(it -&gt; it.isGranted(MENTAL_HEALTH)).getOrElse(false))</span>
<span class="fc" id="L62">                .isSexualHealthConsentGranted(patientConsent.map(it -&gt; it.isGranted(SEXUAL_HEALTH)).getOrElse(false))</span>
<span class="fc" id="L63">                .isSocialCareConsentGranted(patientConsent.map(it -&gt; it.isGranted(SOCIAL_CARE)).getOrElse(false))</span>
<span class="fc" id="L64">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>