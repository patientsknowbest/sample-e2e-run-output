<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AppointmentMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.fhir.appointment</a> &gt; <span class="el_source">AppointmentMapper.java</span></div><h1>AppointmentMapper.java</h1><pre class="source lang-java linenums">package com.pkb.api.fhir.appointment;

import com.pkb.api.fhir.PrivacyFlagsMapper;
import com.pkb.api.fhir.SpecialtyMapper;
import com.pkb.api.fhir.TemporalMapper;
import com.pkb.api.fhir.foundation.ReferenceMapper;
import com.pkb.api.fhir.person.RelatedPersonMapper;
import com.pkb.datamodel.ClinicalCoding;
import com.pkb.datamodel.confidential.SensitiveString;
import com.pkb.datamodel.user.Patient;
import com.pkb.domain.criteria.CriteriaResult;
import com.pkb.domain.criteria.ImmutableCriteriaResult;
import com.pkb.entities.enums.UserType;
import io.vavr.Tuple2;
import io.vavr.collection.List;
import io.vavr.control.Option;
import org.hl7.fhir.dstu3.model.Appointment;
import org.hl7.fhir.dstu3.model.CodeableConcept;
import org.hl7.fhir.dstu3.model.Coding;
import org.hl7.fhir.dstu3.model.HumanName;
import org.hl7.fhir.dstu3.model.Location;
import org.hl7.fhir.dstu3.model.Meta;
import org.hl7.fhir.dstu3.model.Practitioner;
import org.hl7.fhir.dstu3.model.Reference;
import org.hl7.fhir.dstu3.model.RelatedPerson;
import org.jetbrains.annotations.NotNull;

import static com.pkb.api.fhir.DataAbsentReasonUtil.missingInstantType;
import static com.pkb.api.fhir.IdGeneratorUtil.generateIdsFor;
import static io.vavr.API.List;
import static java.lang.String.format;
import static java.util.Collections.singletonList;

public class AppointmentMapper {

    private static final String ID_PREFIX_PRACTITIONER = &quot;Practitioner/&quot;;
    private static final String ID_PREFIX_CONTAINED_CARER = &quot;#carer-&quot;;
    private static final String ID_PREFIX_CONTINED_LOCATION = &quot;#location-&quot;;
    private static final String ID_PREFIX_CONTAINED_PRACTITIONER = &quot;#practitioner-&quot;;

    private final TemporalMapper timeMapper;
    private final PrivacyFlagsMapper privacyFlagsMapper;
    private final ReferenceMapper referenceMapper;
    private final RelatedPersonMapper relatedPersonMapper;
    private final SpecialtyMapper specialtyMapper;

    public AppointmentMapper(TemporalMapper timeMapper, PrivacyFlagsMapper privacyFlagsMapper, ReferenceMapper referenceMapper,
<span class="fc" id="L48">                             RelatedPersonMapper relatedPersonMapper, SpecialtyMapper specialtyMapper) {</span>
<span class="fc" id="L49">        this.timeMapper = timeMapper;</span>
<span class="fc" id="L50">        this.privacyFlagsMapper = privacyFlagsMapper;</span>
<span class="fc" id="L51">        this.referenceMapper = referenceMapper;</span>
<span class="fc" id="L52">        this.relatedPersonMapper = relatedPersonMapper;</span>
<span class="fc" id="L53">        this.specialtyMapper = specialtyMapper;</span>
<span class="fc" id="L54">    }</span>

    public @NotNull CriteriaResult&lt;Appointment&gt; toAppointments(
            @NotNull CriteriaResult&lt;com.pkb.datamodel.Appointment&gt; modelAppointments) {
<span class="nc" id="L58">        return ImmutableCriteriaResult.&lt;Appointment&gt; builder()</span>
<span class="nc" id="L59">                .addAllPage(modelAppointments.getPage().map(this::toAppointment))</span>
<span class="nc" id="L60">                .total(modelAppointments.getTotal())</span>
<span class="nc" id="L61">                .build();</span>

    }

    public @NotNull Appointment toAppointment(@NotNull com.pkb.datamodel.Appointment modelAppointment) {
<span class="fc" id="L66">        Appointment fhirAppointment = new Appointment();</span>
<span class="fc" id="L67">        fhirAppointment.setId(modelAppointment.uniqueId().toString());</span>
<span class="fc" id="L68">        fhirAppointment.setMeta(extractMetadata(modelAppointment));</span>
<span class="fc" id="L69">        fhirAppointment.setStatus(extractStatus(modelAppointment));</span>
<span class="fc" id="L70">        fhirAppointment.setStartElement(timeMapper.toInstantTypeInUTC(modelAppointment.start()));</span>
<span class="fc" id="L71">        fhirAppointment.setEndElement(timeMapper.toInstantTypeInUTC(modelAppointment.end()).getOrElse(missingInstantType()));</span>

<span class="fc" id="L73">        modelAppointment.location()</span>
<span class="fc" id="L74">                .peek(modelLocation -&gt; {</span>
<span class="fc" id="L75">                    Location location = new Location();</span>
<span class="fc" id="L76">                    location.setId(&quot;#location&quot;);</span>
<span class="fc" id="L77">                    location.setDescription(modelLocation.value());</span>
<span class="fc" id="L78">                    fhirAppointment.addContained(location);</span>

<span class="fc" id="L80">                    Reference reference = toReferenceWithId(location.getId());</span>

<span class="fc" id="L82">                    Appointment.AppointmentParticipantComponent participant =</span>
<span class="fc" id="L83">                            toAppointmentParticipantComponentWithStatusAccepted(reference);</span>
<span class="fc" id="L84">                    fhirAppointment.addParticipant(participant);</span>
<span class="fc" id="L85">                });</span>

<span class="fc" id="L87">        fhirAppointment.setReason(extractReason(modelAppointment).toJavaList());</span>

        // GDE-915: Temporarily disable until mappings are fixed
        //extractAppointmentType(modelAppointment).ifPresent(fhirAppointment::setAppointmentType);

<span class="fc" id="L92">        modelAppointment.description().peek(d -&gt; fhirAppointment.setComment(d.value()));</span>

<span class="fc" id="L94">        modelAppointment.specialty().peek(s -&gt; fhirAppointment.addExtension(specialtyMapper.toExtension(s)));</span>

<span class="fc bfc" id="L96" title="All 2 branches covered.">        for (RelatedPerson rp : extractRelatedPersons(modelAppointment)) {</span>
<span class="fc" id="L97">            fhirAppointment.addContained(rp);</span>
<span class="fc" id="L98">        }</span>

<span class="fc bfc" id="L100" title="All 2 branches covered.">        for (Appointment.AppointmentParticipantComponent apc : extractParticipantReferences(modelAppointment)) {</span>
<span class="fc" id="L101">            fhirAppointment.addParticipant(apc);</span>
<span class="fc" id="L102">        }</span>

<span class="fc bfc" id="L104" title="All 2 branches covered.">        if (!modelAppointment.nonPKBParticipants().isEmpty()) {</span>
<span class="fc" id="L105">            List&lt;Tuple2&lt;SensitiveString, String&gt;&gt; generatedIds = generateIdsFor(modelAppointment.nonPKBParticipants(), SensitiveString::hashCode);</span>
<span class="fc" id="L106">            generatedIds.forEach( sensitiveStringAndUuid -&gt; {</span>
<span class="fc" id="L107">                Practitioner practitioner = this.toFhirPractitioner(sensitiveStringAndUuid._1, sensitiveStringAndUuid._2);</span>
<span class="fc" id="L108">                fhirAppointment.addContained(practitioner);</span>
<span class="fc" id="L109">                Reference reference = toReferenceWithId(practitioner.getId());</span>
<span class="fc" id="L110">                Appointment.AppointmentParticipantComponent participantComponent = toAppointmentParticipantComponentWithStatusAccepted(reference);</span>
<span class="fc" id="L111">                fhirAppointment.addParticipant(participantComponent);</span>
<span class="fc" id="L112">            });</span>
        }

<span class="fc" id="L115">        return fhirAppointment;</span>
    }

    private @NotNull Meta extractMetadata(com.pkb.datamodel.Appointment modelAppointment) {
<span class="fc" id="L119">        Meta meta = new Meta();</span>
<span class="fc" id="L120">        modelAppointment.persisted().map(timeMapper::toDate).peek(meta::setLastUpdated);</span>
<span class="fc" id="L121">        meta.setSecurity(privacyFlagsMapper.toCodingList(modelAppointment.getPrivacyFlags()).asJava());</span>
<span class="fc" id="L122">        return meta;</span>
    }

    private @NotNull Appointment.AppointmentStatus extractStatus(com.pkb.datamodel.Appointment modelAppointment) {
<span class="pc bpc" id="L126" title="1 of 4 branches missed.">        switch (modelAppointment.status()) {</span>
        case ACTIVE:
<span class="fc" id="L128">            return Appointment.AppointmentStatus.BOOKED;</span>
        case CANCELLED:
<span class="fc" id="L130">            return Appointment.AppointmentStatus.CANCELLED;</span>
        case DNA:
<span class="fc" id="L132">            return Appointment.AppointmentStatus.NOSHOW;</span>
        default:
<span class="nc" id="L134">            throw new RuntimeException(format(&quot;Unsupported appointment status code [%s]&quot;, modelAppointment.status().toString()));</span>
        }
    }

    private List&lt;CodeableConcept&gt; extractReason(com.pkb.datamodel.Appointment modelAppointment) {
<span class="fc" id="L139">        return modelAppointment.subject().map(s -&gt; {</span>
<span class="fc" id="L140">            Coding coding = new Coding();</span>
<span class="fc" id="L141">            coding.setDisplay(s.value());</span>
<span class="fc" id="L142">            CodeableConcept codeableConcept = new CodeableConcept();</span>
<span class="fc" id="L143">            codeableConcept.setCoding(singletonList(coding));</span>
<span class="fc" id="L144">            return List(codeableConcept);</span>
<span class="fc" id="L145">        }).getOrElse(List());</span>
    }

    private Option&lt;CodeableConcept&gt; extractAppointmentType(com.pkb.datamodel.Appointment modelAppointment) {
<span class="nc" id="L149">        return modelAppointment.type().map(mcc -&gt; {</span>
<span class="nc" id="L150">            CodeableConcept codeableConcept = new CodeableConcept();</span>
<span class="nc" id="L151">            codeableConcept.setCoding(mcc.getCodings().map(this::toCoding).asJava());</span>
<span class="nc" id="L152">            return codeableConcept;</span>
        });
    }

    private Coding toCoding(String codeString) {
<span class="nc" id="L157">        Coding coding = new Coding();</span>
<span class="nc" id="L158">        coding.setCode(codeString);</span>
<span class="nc" id="L159">        return coding;</span>
    }

    private Coding toCoding(ClinicalCoding cc) {
<span class="nc" id="L163">        Coding coding = new Coding();</span>
<span class="nc" id="L164">        coding.setCode(cc.getCode());</span>
<span class="nc" id="L165">        cc.getCodeSystem().peek(coding::setSystem);</span>
<span class="nc" id="L166">        cc.getDisplayText().map(SensitiveString::value).map(coding::setDisplay);</span>
<span class="nc" id="L167">        return coding;</span>
    }

    private List&lt;Appointment.AppointmentParticipantComponent&gt; extractParticipantReferences(com.pkb.datamodel.Appointment modelAppointment) {
<span class="fc" id="L171">        Reference patientReference = referenceMapper.toReferenceWithName(modelAppointment.patient());</span>
<span class="fc" id="L172">        Appointment.AppointmentParticipantComponent fhirPatientParticipant = new Appointment.AppointmentParticipantComponent();</span>
<span class="fc" id="L173">        fhirPatientParticipant.setActor(patientReference);</span>
<span class="fc" id="L174">        fhirPatientParticipant.setStatus(Appointment.ParticipationStatus.ACCEPTED);</span>
<span class="fc" id="L175">        List&lt;Appointment.AppointmentParticipantComponent&gt; participants = List(fhirPatientParticipant);</span>

<span class="fc" id="L177">        var otherParticipants = modelAppointment.participants().map(p -&gt; {</span>
<span class="fc" id="L178">            Reference reference = new Reference();</span>
<span class="fc" id="L179">            reference.setDisplay(referenceMapper.toDisplay(p));</span>

<span class="fc bfc" id="L181" title="All 2 branches covered.">            if (p.getUserType() == UserType.PATIENT) {</span>
<span class="fc" id="L182">                RelatedPerson relatedPerson = relatedPersonMapper.toRelatedPerson(modelAppointment.patient(), (Patient) p);</span>
<span class="fc" id="L183">                relatedPerson.setId(ID_PREFIX_CONTAINED_CARER + p.getPublicId());</span>
<span class="fc" id="L184">                reference.setReference(relatedPerson.getId());</span>
<span class="fc" id="L185">            } else { // Assume pro</span>
<span class="fc" id="L186">                reference.setReference(ID_PREFIX_PRACTITIONER + p.getPublicId().toString());</span>
            }

<span class="fc" id="L189">            Appointment.AppointmentParticipantComponent fhirOtherParticipant = new Appointment.AppointmentParticipantComponent();</span>
<span class="fc" id="L190">            fhirOtherParticipant.setActor(reference);</span>
<span class="fc" id="L191">            fhirOtherParticipant.setStatus(Appointment.ParticipationStatus.ACCEPTED);</span>
<span class="fc" id="L192">            return fhirOtherParticipant;</span>
        });
<span class="fc" id="L194">        return participants.appendAll(otherParticipants);</span>
    }

    private List&lt;RelatedPerson&gt; extractRelatedPersons(com.pkb.datamodel.Appointment modelAppointment) {
<span class="fc bfc" id="L198" title="All 2 branches covered.">        return modelAppointment.participants().filter(p -&gt; p.getUserType() == UserType.PATIENT).map(p -&gt; {</span>
<span class="fc" id="L199">            RelatedPerson relatedPerson = relatedPersonMapper.toRelatedPerson(modelAppointment.patient(), (Patient) p);</span>
<span class="fc" id="L200">            relatedPerson.setId(ID_PREFIX_CONTAINED_CARER + p.getPublicId());</span>
<span class="fc" id="L201">            return relatedPerson;</span>
        });
    }

    @NotNull
    private Practitioner toFhirPractitioner(SensitiveString nonPKBParticipant, String participantId) {
<span class="fc" id="L207">        Practitioner practitioner = new Practitioner();</span>
<span class="fc" id="L208">        practitioner.setId(ID_PREFIX_CONTAINED_PRACTITIONER + participantId);</span>
<span class="fc" id="L209">        HumanName humanName = new HumanName();</span>
<span class="fc" id="L210">        humanName.setText(nonPKBParticipant.value());</span>
<span class="fc" id="L211">        practitioner.addName(humanName);</span>
<span class="fc" id="L212">        return practitioner;</span>
    }

    private Reference toReferenceWithId(String id) {
<span class="fc" id="L216">        Reference reference = new Reference();</span>
<span class="fc" id="L217">        return reference.setReference(id);</span>
    }

    private Appointment.AppointmentParticipantComponent toAppointmentParticipantComponentWithStatusAccepted(
            Reference reference) {
<span class="fc" id="L222">        Appointment.AppointmentParticipantComponent participantComponent = new Appointment.AppointmentParticipantComponent();</span>
<span class="fc" id="L223">        participantComponent.setActor(reference);</span>
<span class="fc" id="L224">        participantComponent.setStatus(Appointment.ParticipationStatus.ACCEPTED);</span>
<span class="fc" id="L225">        return participantComponent;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>