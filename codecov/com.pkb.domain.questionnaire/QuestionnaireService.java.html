<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuestionnaireService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.domain.questionnaire</a> &gt; <span class="el_source">QuestionnaireService.java</span></div><h1>QuestionnaireService.java</h1><pre class="source lang-java linenums">package com.pkb.domain.questionnaire;

import com.pkb.authentication.principal.user.AuthenticatedSystemUser;
import com.pkb.authz.AuthorizationService;
import com.pkb.authz.data.AuthorizationData;
import com.pkb.datamodel.team.Team;
import com.pkb.domain.criteria.CriteriaResult;
import com.pkb.domain.criteria.ImmutableCriteriaResult;
import com.pkb.questionnaireservice.client.QuestionnaireServiceClient;
import com.pkb.questionnaireservice.modelv2.Questionnaire;
import com.pkb.questionnaireservice.modelv2.QuestionnaireRequest;
import com.pkb.questionnaireservice.modelv2.QuestionnaireServiceError;
import com.pkb.questionnaireservice.modelv2.QuestionnaireTeam;
import com.pkb.util.CorrelationIdUtil;
import io.vavr.collection.Stream;
import io.vavr.control.Either;
import io.vavr.control.Option;
import org.slf4j.Logger;

import java.util.List;
import java.util.Optional;
import java.util.UUID;
import java.util.stream.Collectors;

import static com.pkb.authz.NotFoundException.notFoundTarget;
import static com.pkb.domain.criteria.CriteriaResult.emptyCriteriaResult;
import static io.vavr.control.Either.left;
import static java.lang.String.format;
import static java.lang.invoke.MethodHandles.lookup;
import static java.util.function.Function.identity;
import static java.util.stream.Collectors.toSet;
import static org.slf4j.LoggerFactory.getLogger;

public class QuestionnaireService {

    private final AuthorizationService authorizationService;

    private final QuestionnaireServiceClient questionnaireServiceClient;
    private final CorrelationIdUtil correlationIdUtil;

<span class="fc" id="L41">    private static final Logger LOGGER = getLogger(lookup().lookupClass());</span>

<span class="fc" id="L43">    public QuestionnaireService(AuthorizationService authorizationService, QuestionnaireServiceClient questionnaireServiceClient, CorrelationIdUtil correlationIdUtil) {</span>
<span class="fc" id="L44">        this.authorizationService = authorizationService;</span>
<span class="fc" id="L45">        this.questionnaireServiceClient = questionnaireServiceClient;</span>
<span class="fc" id="L46">        this.correlationIdUtil = correlationIdUtil;</span>
<span class="fc" id="L47">    }</span>

    public Either&lt;RuntimeException, CriteriaResult&lt;Questionnaire&gt;&gt; getQuestionnaires(AuthorizationData authorisationData,
            QuestionnaireSearchCriteria questionnaireSearchCriteria) {


<span class="fc" id="L53">        return authorizationService.authorize(authorisationData)</span>
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">                .checkFilteredSingleResult(tm -&gt; tm.targetType() == Questionnaire.class, () -&gt; {</span>
<span class="fc" id="L55">                    AuthenticatedSystemUser systemUser = authorisationData.inputs().requireAuthenticatedSystemUser();</span>
<span class="fc" id="L56">                    var teamIds = systemUser.getTeamsWithOrg().map(Team::getPublicId).collect(Collectors.toList());</span>

<span class="fc" id="L58">                    return  questionnaireServiceClient.getQuestionnairesInTeams(correlationIdUtil.get(), teamIds, true, questionnaireSearchCriteria.getPageSize())</span>

<span class="fc" id="L60">                            .fold(</span>
<span class="nc" id="L61">                                    qsError -&gt; Either.&lt;RuntimeException, CriteriaResult&lt;Questionnaire&gt;&gt; left(new RuntimeException(qsError.getMessage())),</span>
<span class="fc" id="L62">                                    questionnaires -&gt; Either.&lt;RuntimeException, CriteriaResult&lt;Questionnaire&gt;&gt; right(</span>
<span class="fc" id="L63">                                            ImmutableCriteriaResult.&lt;Questionnaire&gt;builder()</span>
<span class="fc" id="L64">                                                    .page(Stream.ofAll(questionnaires.getResultsPage()).toList())</span>
<span class="fc" id="L65">                                                    .total(questionnaires.getTotalResults())</span>
<span class="fc" id="L66">                                                    .build())</span>
                            );
                })
                //ignore auth errors for search - just return empty list
<span class="fc" id="L70">                .fold(</span>
                        ignored -&gt; {
<span class="fc" id="L72">                            LOGGER.error(&quot;User not authorised for questionnaire search. Returning empty results. Error was: &quot;, ignored);</span>
<span class="fc" id="L73">                            return Either.&lt;RuntimeException, CriteriaResult&lt;Questionnaire&gt;&gt;right(emptyCriteriaResult());</span>
<span class="fc" id="L74">                        }, identity());</span>
    }

    @SuppressWarnings(&quot;unchecked&quot;)
    public Either&lt;RuntimeException, QuestionnaireTeam&gt; getQuestionnaireTeam(AuthorizationData authData, UUID publicId) {
<span class="fc" id="L79">        return authorizationService.authorize(authData)</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">                .checkFilteredSingleResult(tm -&gt; tm.targetType() == Questionnaire.class</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">                        &amp;&amp; tm.findIdentifier(UUID.class).equals(Option.of(publicId)), () -&gt; {</span>
                            //We would expect to just call questionnaireServiceClient.getQuestionnaireById()
                            //But we need to make sure that the questionnaire belongs to one of the teams within the system user's org
                            //At the moment, the only way to do that is to fetch all questionnaires for the system user's teams and compare

<span class="fc" id="L86">                            var teamIds = authData.inputs().requireAuthenticatedSystemUser().getTeamsWithOrg().map(Team::getPublicId).collect(Collectors.toList());</span>
<span class="fc" id="L87">                            return questionnaireServiceClient.getQuestionnaireTeamsInTeams(correlationIdUtil.get(), teamIds, true)</span>
<span class="fc" id="L88">                                    .map(</span>
<span class="fc" id="L89">                                            quesTeamsInTeams -&gt; quesTeamsInTeams.stream().filter(q -&gt; q.getQuestionnaire().getId().equals(publicId))</span>
<span class="fc" id="L90">                                                    .collect(Collectors.collectingAndThen(</span>
<span class="fc" id="L91">                                                        Collectors.toList(),</span>
                                                        questionnaireTeamsMatchingId -&gt; {
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">                                                            if (questionnaireTeamsMatchingId.size() &gt; 1) {</span>
<span class="nc" id="L94">                                                                throw new IllegalStateException(&quot;Multiple questionnaire teams for questionnaire with same public id!: &quot;+publicId);</span>
                                                            }
<span class="fc bfc" id="L96" title="All 2 branches covered.">                                                            else if (questionnaireTeamsMatchingId.isEmpty()) {</span>
<span class="fc" id="L97">                                                                return Optional.&lt;QuestionnaireTeam&gt; empty();</span>
                                                            }
<span class="fc" id="L99">                                                            else { return Optional.of(questionnaireTeamsMatchingId.get(0)); }</span>
                                                        })));
                        })
<span class="fc" id="L102">                .flatMap(either -&gt; either.fold(</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">                        qsError -&gt; (qsError instanceof QuestionnaireServiceError.NotFoundError)</span>
<span class="nc" id="L104">                                ? left(notFoundTarget(publicId, Questionnaire.class))</span>
<span class="fc" id="L105">                                : left(new RuntimeException(qsError.getMessage())),</span>
<span class="fc" id="L106">                        maybeQuestionnaire -&gt; maybeQuestionnaire.map(Either::&lt;RuntimeException, QuestionnaireTeam&gt;right)</span>
<span class="fc" id="L107">                                .orElse(left(notFoundTarget(publicId, Questionnaire.class)))));</span>
    }

    public Either&lt;RuntimeException, QuestionnaireRequest&gt; getQuestionnaireRequests(AuthorizationData authData, UUID publicId) {
        // Authz: system user can only see requests from teams in his own org
        // Can't do this in a Policy because reasons
        // Can't do it further on because QuestionnaireService cannot see PublicTeam
<span class="fc" id="L114">        return authorizationService.authorize(authData)</span>
<span class="pc bpc" id="L115" title="2 of 4 branches missed.">                .checkFilteredSingleResult(tm -&gt; tm.targetType() == QuestionnaireRequest.class &amp;&amp; tm.findIdentifier(UUID.class).equals(Option.of(publicId)), () -&gt; {</span>
<span class="fc" id="L116">                    var teamIds = authData.inputs().requireAuthenticatedSystemUser().getTeamsWithOrg().map(Team::getPublicId).collect(toSet());</span>
<span class="fc" id="L117">                    return questionnaireServiceClient.getQuestionnaireRequest(correlationIdUtil.get(), publicId)</span>
<span class="fc" id="L118">                            .filter(req -&gt; teamIds.contains(req.getRequestingTeamId()))</span>
<span class="fc" id="L119">                            .getOrElse(left(new QuestionnaireServiceError.NotFoundError(format(&quot;Unable to find ProcedureRequest -%s&quot;, publicId))));</span>
                })
<span class="fc" id="L121">                .flatMap(either -&gt; either.fold(</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">                        qsError -&gt; (qsError instanceof QuestionnaireServiceError.NotFoundError) ?</span>
<span class="fc" id="L123">                                left(notFoundTarget(publicId, Questionnaire.class)) :</span>
<span class="nc" id="L124">                                left(new RuntimeException(qsError.getMessage())),</span>
                        Either::right));
    }
    
    // In order to post a questionnaire request we have to retrieve the questionnaire, so we assume authorization has been checked before in the code here
    public Either&lt;QuestionnaireServiceError,List&lt;QuestionnaireRequest&gt;&gt; postQuestionnaireRequestsBatch(List&lt;QuestionnaireRequest&gt; questionnaireRequests){
<span class="fc" id="L130">        return questionnaireServiceClient.postQuestionnaireRequestsBatch(correlationIdUtil.getOrDefault(), questionnaireRequests);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>