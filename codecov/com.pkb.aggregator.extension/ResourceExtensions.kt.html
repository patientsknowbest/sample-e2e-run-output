<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ResourceExtensions.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.aggregator.extension</a> &gt; <span class="el_source">ResourceExtensions.kt</span></div><h1>ResourceExtensions.kt</h1><pre class="source lang-java linenums">package com.pkb.aggregator.extension

import com.pkb.aggregator.Dstu3Organization
import com.pkb.aggregator.Dstu3Practitioner
import com.pkb.aggregator.Dstu3PractitionerRole
import com.pkb.aggregator.Dstu3Resource
import com.pkb.aggregator.R4DomainResource
import com.pkb.aggregator.R4Element
import com.pkb.aggregator.R4Extension
import com.pkb.aggregator.R4Organization
import com.pkb.aggregator.R4Practitioner
import com.pkb.aggregator.R4PractitionerRole
import com.pkb.aggregator.R4Reference
import com.pkb.aggregator.R4Resource
import com.pkb.aggregator.persistence.entity.embeddable.UpstreamResource
import com.pkb.aggregator.service.enrichment.CanonicalExtensionURLs.upstreamResourceId
import com.pkb.aggregator.service.enrichment.CanonicalExtensionURLs.upstreamSourceId
import com.pkb.aggregator.service.enrichment.CanonicalExtensionURLs.upstreamTag
import com.pkb.aggregator.service.reference.UpstreamDownstreamIdPair
import io.micrometer.core.instrument.Metrics.timer
import org.hl7.fhir.convertors.factory.VersionConvertorFactory_30_40
import org.hl7.fhir.instance.model.api.IBaseHasExtensions
import org.hl7.fhir.instance.model.api.IBaseResource
import org.hl7.fhir.instance.model.api.IDomainResource
import org.hl7.fhir.r4.model.Extension
import org.slf4j.Logger
import org.slf4j.LoggerFactory
import java.lang.invoke.MethodHandles

<span class="fc" id="L30">private val log: Logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass())</span>

<span class="nc bnc" id="L32" title="All 4 branches missed.">fun IDomainResource.isOrganization() = this is Dstu3Organization || this is R4Organization</span>

<span class="nc bnc" id="L34" title="All 4 branches missed.">fun IDomainResource.isPractitioner() = this is Dstu3Practitioner || this is R4Practitioner</span>

<span class="nc bnc" id="L36" title="All 4 branches missed.">fun IDomainResource.isPractitionerRole() = this is Dstu3PractitionerRole || this is R4PractitionerRole</span>

fun IBaseResource.simpleResourceId() =
<span class="fc" id="L39">    &quot;${this.fhirType()}/${this.idElement.idPart}&quot;</span>

fun IBaseHasExtensions.simpleDownstreamResourceId(): String {
<span class="fc" id="L42">    val source = this.getSourcedReference()</span>
<span class="fc" id="L43">    return &quot;${this.fhirType()}/${source.toDownstreamResourceId()}&quot;</span>
}

fun IBaseHasExtensions.simpleUpstreamResourceId(): String {
<span class="fc" id="L47">    val source = this.getSourcedReference()</span>
<span class="fc" id="L48">    return &quot;${source.upstreamSource}:${source.upstreamResourceId}&quot;</span>
}

/**
 * Builds an [UpstreamDownstreamIdPair] from a resource using the current id and source extension(s)
 */
fun IDomainResource.aggregatedResourceId(): String {
<span class="fc" id="L55">    val sources = this.findAllSourcedReference()</span>
<span class="pc bpc" id="L56" title="2 of 4 branches missed.">    return if (sources.isNotEmpty()) {</span>
<span class="fc" id="L57">        sources.joinToString(&quot;,&quot;) { &quot;${it.upstreamSource}:${it.upstreamResourceId}&quot; }</span>
    } else {
<span class="nc" id="L59">        &quot;unknown&quot;</span>
<span class="fc" id="L60">    }.plus(&quot; -&gt; ${this.simpleResourceId()}&quot;)</span>
}

fun IBaseHasExtensions.findSingleR4UpstreamTagExtension() =
<span class="pc bpc" id="L64" title="3 of 6 branches missed.">    extension.firstOrNull { it?.url == upstreamTag() } as? R4Extension</span>
<span class="pc" id="L65">        ?: throw RuntimeException(&quot;Could not find single upstream tag in $extension&quot;)</span>

fun IBaseHasExtensions.findAllR4UpstreamTagExtensions() =
<span class="pc bpc" id="L68" title="2 of 4 branches missed.">    extension.filter { it?.url == upstreamTag() }.mapNotNull { it as? R4Extension }</span>

fun IBaseHasExtensions.findR4SourceIdExtension() =
<span class="pc bpc" id="L71" title="2 of 4 branches missed.">    extension.firstOrNull { it?.url == upstreamSourceId() } as? R4Extension</span>

fun IBaseHasExtensions.findR4UpstreamResourceIdExtension() =
<span class="pc bpc" id="L74" title="2 of 4 branches missed.">    extension.firstOrNull { it?.url == upstreamResourceId() } as? R4Extension</span>

fun IBaseHasExtensions.getSourcedReference() =
<span class="fc" id="L77">    this.findSingleR4UpstreamTagExtension().toSourcedReference()</span>

fun R4Extension.toSourcedReference(): UpstreamResource {
<span class="fc" id="L80">    val sourceId = this.findR4SourceIdExtension()!!.value!!.toString()</span>
<span class="fc" id="L81">    val resourceId = this.findR4UpstreamResourceIdExtension()!!.value!!.toString()</span>
<span class="fc" id="L82">    return UpstreamResource(sourceId, resourceId)</span>
}

fun IBaseHasExtensions.findAllSourcedReference() =
<span class="fc" id="L86">    this.findAllR4UpstreamTagExtensions()</span>
<span class="fc" id="L87">        .map { it.toSourcedReference() }</span>

fun R4Element.tagWithSource(sourceExtension: R4Extension) {
<span class="fc bfc" id="L90" title="All 2 branches covered.">    if (!this.isSourceTaggedWith(sourceExtension)) {</span>
<span class="fc" id="L91">        this.extension.add(sourceExtension)</span>
    }
<span class="fc" id="L93">}</span>

fun R4DomainResource.tagWithSource(sourceExtension: R4Extension) {
<span class="nc bnc" id="L96" title="All 2 branches missed.">    if (!this.isSourceTaggedWith(sourceExtension)) {</span>
<span class="nc" id="L97">        this.extension.add(sourceExtension)</span>
    }
<span class="nc" id="L99">}</span>

<span class="fc" id="L101">fun Dstu3Resource.toR4(): R4Resource = timer(&quot;r4.mapping&quot;, &quot;type&quot;, &quot;resource&quot;).recordCallable {</span>
<span class="fc" id="L102">    VersionConvertorFactory_30_40.convertResource(this).also {</span>
<span class="fc" id="L103">        log.debug(&quot;Converted resource {} to R4&quot;, this.simpleResourceId())</span>
<span class="fc" id="L104">    }</span>
<span class="fc" id="L105">}!!</span>

/**
 * Returns true if the given element has any source tag that matches the given one
 */
fun IBaseHasExtensions.isSourceTaggedWith(sourceExtension: R4Extension) =
<span class="fc" id="L111">    this.findAllR4UpstreamTagExtensions().any { it.equalsDeep(sourceExtension) }</span>

/**
 * Returns true if the given element has exactly one source tag and it matches the given one
 */
fun IBaseHasExtensions.isOnlySourceTaggedWith(sourceExtension: R4Extension): Boolean {
<span class="fc" id="L117">    val tagExtensions = this.findAllR4UpstreamTagExtensions()</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">    return tagExtensions.size == 1 &amp;&amp;  tagExtensions.any { it.equalsDeep(sourceExtension) }</span>
}

/**
 * Removes all elements or tags for the given source. If the source is the only source for an element then the element
 * is removed; if there are other sources, then this source is removed from them
 */
fun &lt;T&gt; MutableList&lt;T&gt;.untagSource(sourceTag: R4Extension) where T : R4Element {

    // Remove any element where the provided source is the only source
<span class="fc" id="L128">    this.removeIf { it.isOnlySourceTaggedWith(sourceTag) }</span>

    // Remove the provided source from any other element
<span class="fc" id="L131">    this.forEach {</span>
<span class="fc" id="L132">        it.extension.removeIf { it.equalsDeep(sourceTag) }</span>
<span class="fc" id="L133">    }</span>
<span class="fc" id="L134">}</span>

fun &lt;T&gt; MutableList&lt;T&gt;.safeAdd(other: T) where T : R4Element {
    // Find using shallow equality because we don't want to compare extension yet
<span class="fc bfc" id="L138" title="All 4 branches covered.">    val existing = this.find { it.equalsShallow(other) }</span>
<span class="fc bfc" id="L139" title="All 2 branches covered.">    if (existing !== null) {</span>
<span class="fc" id="L140">        existing.tagWithSource(other.findSingleR4UpstreamTagExtension())</span>
    } else {
<span class="fc" id="L142">        this.add(other)</span>
    }
<span class="fc" id="L144">}</span>

fun &lt;T&gt; MutableList&lt;T&gt;.safeAddAll(others: MutableList&lt;T&gt;, sourceTag: R4Extension) where T : R4Element {

<span class="fc" id="L148">    this.untagSource(sourceTag)</span>

<span class="fc bfc" id="L150" title="All 2 branches covered.">    if (others.isEmpty()) return</span>

    // Now we can add the elements to this list
<span class="fc" id="L153">    others.forEach { this.safeAdd(it) }</span>
<span class="fc" id="L154">}</span>

fun R4DomainResource.safeAddExtensions(others: List&lt;R4Extension&gt;) {
<span class="fc" id="L157">    others.forEach { other: Extension -&gt;</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">        if (this.extension.none { it.equalsDeep(other) }) {</span>
<span class="fc" id="L159">            this.extension.add(other)</span>
        }
<span class="fc" id="L161">    }</span>
<span class="fc" id="L162">}</span>

<span class="pc bpc" id="L164" title="2 of 4 branches missed.">fun R4Reference.isPlainUuidReference() = identifier?.system?.startsWith(&quot;urn:uuid:&quot;) ?: false</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>