<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuestionnaireServiceRetrofit.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.questionnaireservice.client</a> &gt; <span class="el_source">QuestionnaireServiceRetrofit.kt</span></div><h1>QuestionnaireServiceRetrofit.kt</h1><pre class="source lang-java linenums">package com.pkb.questionnaireservice.client

import com.fasterxml.jackson.databind.ObjectMapper
import com.fasterxml.jackson.datatype.jdk8.Jdk8Module
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule
import com.fasterxml.jackson.module.kotlin.KotlinModule
import com.pkb.questionnaireservice.OrgPublicId
import com.pkb.questionnaireservice.PersonPublicId
import com.pkb.questionnaireservice.QuestionnaireId
import com.pkb.questionnaireservice.QuestionnaireRequestId
import com.pkb.questionnaireservice.REQUEST_HEADER
import com.pkb.questionnaireservice.TeamPublicId
import com.pkb.questionnaireservice.modelv2.Questionnaire
import com.pkb.questionnaireservice.modelv2.QuestionnaireRequest
import com.pkb.questionnaireservice.modelv2.QuestionnaireResponse
import com.pkb.questionnaireservice.modelv2.QuestionnaireResponseCount
import com.pkb.questionnaireservice.modelv2.QuestionnaireServiceError
import com.pkb.questionnaireservice.modelv2.QuestionnaireTeam
import com.pkb.questionnaireservice.modelv2.SearchResults
import io.vavr.control.Either
import okhttp3.OkHttpClient
import retrofit2.Call
import retrofit2.CallAdapter
import retrofit2.Retrofit
import retrofit2.converter.jackson.JacksonConverterFactory
import retrofit2.create
import retrofit2.http.Body
import retrofit2.http.GET
import retrofit2.http.Header
import retrofit2.http.Headers
import retrofit2.http.POST
import retrofit2.http.PUT
import retrofit2.http.Path
import retrofit2.http.Query
import java.io.IOException
import java.lang.reflect.ParameterizedType
import java.lang.reflect.Type
import java.time.Instant
import java.util.UUID
import javax.annotation.Nullable


internal interface QuestionnaireServiceRetrofit {
    companion object {
        @JvmStatic
        fun questionnaireServiceRetrofit(baseUrl: String, client: OkHttpClient): QuestionnaireServiceRetrofit {
<span class="fc" id="L47">            return Retrofit.Builder()</span>
<span class="fc" id="L48">                    .baseUrl(baseUrl)</span>
<span class="fc" id="L49">                    .client(client)</span>
<span class="fc" id="L50">                    .addCallAdapterFactory(ErrorHandlingCallAdapterFactory())</span>
<span class="fc" id="L51">                    .addConverterFactory(</span>
<span class="fc" id="L52">                            JacksonConverterFactory.create(</span>
<span class="fc" id="L53">                                    ObjectMapper().registerModules(KotlinModule.Builder().build(), JavaTimeModule(), Jdk8Module())))</span>
<span class="fc" id="L54">                    .build()</span>
<span class="fc" id="L55">                    .create()</span>
        }
    }

    @Headers(&quot;Content-Type: application/json&quot;)
    @POST(&quot;/questionnaire&quot;)
    fun postQuestionnaire(@Header(REQUEST_HEADER) requestID: UUID?,
                                   @Body q: Questionnaire): Either&lt;QuestionnaireServiceError, Questionnaire&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @POST(&quot;/questionnaireteam&quot;)
    fun postQuestionnaireAndLinkToTeam(@Header(REQUEST_HEADER) requestID: UUID?,
                                                @Body questionnaireTeamLink: QuestionnaireTeam): Either&lt;QuestionnaireServiceError, QuestionnaireTeam&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaireteam/{id}&quot;)
    fun getQuestionnaireTeamByQuestionnaireIdAndTeamId(@Header(REQUEST_HEADER) requestID: UUID?,
                                                       @Path(&quot;id&quot;) id: QuestionnaireId,
                                                       @Query(&quot;team_ids&quot;) teamIds: List&lt;TeamPublicId&gt;): Either&lt;QuestionnaireServiceError, List&lt;QuestionnaireTeam&gt;&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaireteam/questionnairerequest/{id}&quot;)
    fun getQuestionnaireTeamByQuestionnaireRequestId(@Header(REQUEST_HEADER) requestID: UUID?,
                                                              @Path(&quot;id&quot;) id: QuestionnaireRequestId): Either&lt;QuestionnaireServiceError, QuestionnaireTeam&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaireteam&quot;)
    fun getQuestionnaireTeamsInTeam(@Header(REQUEST_HEADER) requestID: UUID?,
                                             @Query(&quot;team_id&quot;) id: TeamPublicId,
                                             @Query(&quot;includeHidden&quot;) includeHidden: Boolean): Either&lt;QuestionnaireServiceError, List&lt;QuestionnaireTeam&gt;&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaireteam&quot;)
    fun getQuestionnaireTeamsInTeams(@Header(REQUEST_HEADER) requestID: UUID?,
                                              @Query(&quot;team_ids&quot;) ids: List&lt;TeamPublicId&gt;,
                                              @Query(&quot;includeHidden&quot;) includeHidden: Boolean): Either&lt;QuestionnaireServiceError, List&lt;QuestionnaireTeam&gt;&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaireteam/questionnaireresponsecount/{team_id}&quot;)
    fun getQuestionnaireResponseCountsByTeamId(@Header(REQUEST_HEADER) requestID: UUID?,
                                              @Path(&quot;team_id&quot;) teamId: TeamPublicId): Either&lt;QuestionnaireServiceError, List&lt;QuestionnaireResponseCount&gt;&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @PUT(&quot;/questionnaireteam/update&quot;)
    fun updateTeamLink(@Header(REQUEST_HEADER) requestID: UUID?,
                                @Body questionnaireTeamLink: QuestionnaireTeam): Either&lt;QuestionnaireServiceError, QuestionnaireTeam&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaire/{id}&quot;)
    fun getQuestionnaireById(@Header(REQUEST_HEADER) requestID: UUID?,
                                      @Path(&quot;id&quot;) id: QuestionnaireId): Either&lt;QuestionnaireServiceError, Questionnaire&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaire/testing/components/{id}&quot;)
    fun getQuestionnaireComponentsByQuestionnaireId(@Header(REQUEST_HEADER) requestID: UUID?,
                             @Path(&quot;id&quot;) id: QuestionnaireId): Either&lt;QuestionnaireServiceError, List&lt;String&gt;&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaire&quot;)
    fun getQuestionnairesInTeams(@Header(REQUEST_HEADER) requestID: UUID?,
                                          @Query(&quot;team_id&quot;) ids: List&lt;TeamPublicId&gt;,
                                          @Query(&quot;include_hidden&quot;) includeHidden: Boolean,
            //limit param gets automatically mapped to a Pageable on the server side:
                                          @Query(&quot;limit&quot;) limit: Int): Either&lt;QuestionnaireServiceError, SearchResults&lt;Questionnaire&gt;&gt;


    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaire&quot;)
    fun getQuestionnairesInTeams(@Header(REQUEST_HEADER) requestID: UUID?,
                                          @Query(&quot;team_id&quot;) ids: List&lt;TeamPublicId&gt;,
                                          @Query(&quot;include_hidden&quot;) includeHidden: Boolean): Either&lt;QuestionnaireServiceError, SearchResults&lt;Questionnaire&gt;&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaire&quot;)
    fun getQuestionnairesInTeam(@Header(REQUEST_HEADER) requestID: UUID?,
                                         @Query(&quot;team_id&quot;) id: TeamPublicId,
                                         @Query(&quot;include_hidden&quot;) includeHidden: Boolean,
            //limit param gets automatically mapped to a Pageable on the server side:
                                         @Query(&quot;limit&quot;) limit: Int): Either&lt;QuestionnaireServiceError, SearchResults&lt;Questionnaire&gt;&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaire&quot;)
    fun getQuestionnairesInTeam(@Header(REQUEST_HEADER) requestID: UUID?,
                                         @Query(&quot;team_id&quot;) id: TeamPublicId,
                                         @Query(&quot;include_hidden&quot;) includeHidden: Boolean): Either&lt;QuestionnaireServiceError, SearchResults&lt;Questionnaire&gt;&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @POST(&quot;/questionnaire-request/&quot;)
    fun postQuestionnaireRequest(@Header(REQUEST_HEADER) requestID: UUID?,
                                          @Body q: QuestionnaireRequest):
            Either&lt;QuestionnaireServiceError, QuestionnaireRequest&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @POST(&quot;/questionnaire-request/batch&quot;)
    fun postQuestionnaireRequestsBatch(@Header(REQUEST_HEADER) requestID: UUID?,
                                 @Body requests: List&lt;@JvmSuppressWildcards QuestionnaireRequest&gt;):
            Either&lt;QuestionnaireServiceError,List&lt;QuestionnaireRequest&gt;&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaire-request/{id}&quot;)
    fun getQuestionnaireRequest(@Header(REQUEST_HEADER) requestID: UUID?,
                                         @Path(&quot;id&quot;) id: QuestionnaireRequestId):
            Either&lt;QuestionnaireServiceError, QuestionnaireRequest&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaire-request/&quot;)
    fun getQuestionnaireRequestsForQuestionnaires(@Header(REQUEST_HEADER) requestID: UUID?,
                                                           @Query(&quot;questionnaire_ids&quot;) questionnaireIds: List&lt;QuestionnaireId&gt;,
            //limit param gets automatically mapped to a Pageable on the server side:
                                                           @Query(&quot;limit&quot;) limit: Int):
            Either&lt;QuestionnaireServiceError, SearchResults&lt;QuestionnaireRequest&gt;&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaire-request/&quot;)
    fun getQuestionnaireRequestsForQuestionnaires(@Header(REQUEST_HEADER) requestID: UUID?,
                                                           @Query(&quot;questionnaire_ids&quot;) questionnaireIds: List&lt;QuestionnaireId&gt;):
            Either&lt;QuestionnaireServiceError, SearchResults&lt;QuestionnaireRequest&gt;&gt;


    @Headers(&quot;Content-Type: application/json&quot;)
    @POST(&quot;/questionnaire-response/&quot;)
    fun postQuestionnaireResponse(@Header(REQUEST_HEADER) requestID: UUID?,
                                           @Body q: QuestionnaireResponse):
            Either&lt;QuestionnaireServiceError, QuestionnaireResponse&gt;

    @GET(&quot;/questionnaire-response/{questionnaire_id}&quot;)
    fun getQuestionnaireResponses(@Header(REQUEST_HEADER) requestID: UUID?,
                                           @Path(&quot;questionnaire_id&quot;) id: QuestionnaireId,
                                           @Query(&quot;user_id&quot;) loggedInUserId: PersonPublicId,
            //limit param gets automatically mapped to a Pageable on the server side:
                                           @Query(&quot;limit&quot;) limit: Int):
            Either&lt;QuestionnaireServiceError, SearchResults&lt;QuestionnaireResponse&gt;&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaire-response/{questionnaire_id}&quot;)
    fun getQuestionnaireResponses(@Header(REQUEST_HEADER) requestID: UUID?,
                                           @Path(&quot;questionnaire_id&quot;) id: QuestionnaireId,
                                           @Query(&quot;user_id&quot;) loggedInUserId: PersonPublicId):
            Either&lt;QuestionnaireServiceError, SearchResults&lt;QuestionnaireResponse&gt;&gt;

    @Headers(&quot;Content-Type: application/json&quot;)
    @GET(&quot;/questionnaire-response/&quot;)
    fun getQuestionnaireResponsesWithinOrg(@Header(REQUEST_HEADER) requestID: UUID?,
                                                    @Query(&quot;org_id&quot;) orgId: OrgPublicId,
                                                    @Query(&quot;teamIds&quot;) teamIds: List&lt;TeamPublicId&gt;,
                                                    @Query(&quot;patientIds&quot;) patientIds: List&lt;PersonPublicId&gt;?,
                                                    @Query(&quot;questionnaireId&quot;) questionnaireId: QuestionnaireId?,
                                                    @Query(&quot;ltDate&quot;) ltDate: Instant?,
                                                    @Query(&quot;leDate&quot;) leDate: Instant?,
                                                    @Query(&quot;gtDate&quot;) gtDate: Instant?,
                                                    @Query(&quot;geDate&quot;) geDate: Instant?,
            //limit param gets automatically mapped to a Pageable on the server side:
                                                    @Query(&quot;limit&quot;) limit: Int?):
            Either&lt;QuestionnaireServiceError, SearchResults&lt;QuestionnaireResponse&gt;&gt;

}

/**
 * Adapts Retrofit's Call&lt;&gt; type to an Either&lt;E, R&gt; representing a success or a failure.
 */
<span class="fc" id="L215">private class ErrorHandlingCallAdapterFactory : CallAdapter.Factory() {</span>
    @Nullable
    override fun get(returnType: Type,
                     annotations: Array&lt;Annotation&gt;,
                     retrofit: Retrofit): CallAdapter&lt;*, *&gt;? {
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">        if (getRawType(returnType) != Either::class.java) {</span>
<span class="nc" id="L221">            return null</span>
        }
<span class="pc bpc" id="L223" title="1 of 2 branches missed.">        check(returnType is ParameterizedType) { &quot;return type must have generic type (e.g., Either&lt;QuestionnaireServiceError, Shared model&gt;)&quot; }</span>
<span class="fc" id="L224">        val responseErrorType = getParameterUpperBound(0, returnType)</span>
<span class="pc bpc" id="L225" title="1 of 2 branches missed.">        if (responseErrorType != QuestionnaireServiceError::class.java) {</span>
<span class="nc" id="L226">            return null</span>
        }
<span class="fc" id="L228">        val responseType = getParameterUpperBound(1, returnType)</span>
<span class="fc" id="L229">        return ErrorHandlingCallAdapter&lt;Any&gt;(retrofit, responseType, annotations)</span>
    }
}

<span class="fc" id="L233">private class ErrorHandlingCallAdapter&lt;R&gt;(private val retrofit: Retrofit,</span>
<span class="fc" id="L234">                                          private val responseType: Type,</span>
<span class="fc" id="L235">                                          private val annotations: Array&lt;Annotation&gt;) : CallAdapter&lt;R, Either&lt;QuestionnaireServiceError, R&gt;&gt; {</span>
    override fun responseType(): Type {
<span class="fc" id="L237">        return responseType</span>
    }

    override fun adapt(call: Call&lt;R&gt;): Either&lt;QuestionnaireServiceError, R&gt; {
<span class="fc" id="L241">        return try {</span>
<span class="fc" id="L242">            val response = call.execute()</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">            if (response.isSuccessful) {</span>
<span class="fc" id="L244">                Either.right(response.body())</span>
            } else {
<span class="fc" id="L246">                Either.left(retrofit.responseBodyConverter&lt;QuestionnaireServiceError&gt;(QuestionnaireServiceError::class.java,</span>
<span class="fc" id="L247">                        annotations).convert(response.errorBody()!!))</span>
            }
<span class="fc" id="L249">        } catch (e: IOException) {</span>
<span class="fc" id="L250">            Either.left(QuestionnaireServiceError.IOError(e))</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>