<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CachingTextProviderSupport.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.util.struts</a> &gt; <span class="el_source">CachingTextProviderSupport.java</span></div><h1>CachingTextProviderSupport.java</h1><pre class="source lang-java linenums">package com.pkb.util.struts;

import com.google.common.cache.Cache;
import com.google.common.cache.CacheBuilder;
import com.opensymphony.xwork2.ActionContext;
import com.opensymphony.xwork2.LocaleProvider;
import com.opensymphony.xwork2.ResourceBundleTextProvider;
import com.opensymphony.xwork2.TextProvider;
import com.opensymphony.xwork2.TextProviderSupport;
import com.opensymphony.xwork2.inject.Inject;
import com.opensymphony.xwork2.util.ValueStack;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.AbstractMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.ResourceBundle;

/*
  Created by mvarga on 2016.07.11..
 */

/**
 * This is a wrapper around Struts' TextProviderSupport.
 * It caches translations directly in a map to prevent
 * constant resourceBundle lookups (&amp; etc.)
 * It can be used when the underlying translations are not
 * reloaded without restarting the application.
 * For now, it doesn't cache templated texts, we don't need it atm.
 */
public class CachingTextProviderSupport implements ResourceBundleTextProvider {

<span class="fc" id="L35">    private static Cache&lt;Map.Entry&lt;String, Locale&gt;, String&gt; i18nCache = CacheBuilder.newBuilder().build();</span>

<span class="fc" id="L37">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private LocaleProvider localeProvider;

    private TextProviderSupport delegate;

<span class="fc" id="L43">    public CachingTextProviderSupport(TextProviderSupport delegate) {</span>
<span class="fc" id="L44">        this.delegate = delegate;</span>
<span class="fc" id="L45">    }</span>

    @Override
    public void setBundle(ResourceBundle bundle) {
<span class="fc" id="L49">        delegate.setBundle(bundle);</span>
<span class="fc" id="L50">    }</span>

    @Override
    public void setClazz(Class clazz) {
<span class="fc" id="L54">        delegate.setClazz(clazz);</span>
<span class="fc" id="L55">    }</span>

    @Override
    @Inject
    public void setLocaleProvider(LocaleProvider localeProvider) {
<span class="fc" id="L60">        this.localeProvider = localeProvider;</span>
<span class="fc" id="L61">        this.delegate.setLocaleProvider(localeProvider);</span>
<span class="fc" id="L62">    }</span>

    @Override
    public boolean hasKey(String key) {
<span class="nc" id="L66">        return delegate.hasKey(key);</span>
    }

    @Override
    public String getText(String text) {
<span class="fc" id="L71">        return getText(text, (Locale) null, null);</span>
    }

    @Override
    public String getText(String key, String defaultValue) {
<span class="fc" id="L76">        String ret = getText(key);</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">        return ret != null ? ret : defaultValue;</span>
    }

    @Override
    public String getText(String key, String defaultValue, String arg) {
<span class="nc bnc" id="L82" title="All 2 branches missed.">        return (arg != null) ? delegate.getText(key, defaultValue, arg) : getText(key, (Locale) null, defaultValue);</span>
    }

    @Override
    public String getText(String key, List&lt;?&gt; args) {
<span class="pc bpc" id="L87" title="2 of 4 branches missed.">        return ((args != null) &amp;&amp; !args.isEmpty()) ? delegate.getText(key, args) : getText(key, (Locale) null, null);</span>
    }

    @Override
    public String getText(String key, String[] args) {
<span class="fc bfc" id="L92" title="All 4 branches covered.">        return ((args != null) &amp;&amp; (args.length != 0)) ? delegate.getText(key, args) : getText(key, (Locale) null, null);</span>
    }

    @Override
    public String getText(String key, String defaultValue, List&lt;?&gt; args) {
<span class="pc bpc" id="L97" title="2 of 4 branches missed.">        if ((args != null) &amp;&amp; !args.isEmpty()) {</span>
<span class="nc" id="L98">            return delegate.getText(key, defaultValue, args); // no caching</span>
        } else {
<span class="fc" id="L100">            return getText(key, (Locale) null, defaultValue);</span>
        }
    }

    @Override
    public String getText(String key, String defaultValue, String[] args) {
<span class="nc bnc" id="L106" title="All 4 branches missed.">        if ((args != null) &amp;&amp; (args.length != 0)) {</span>
<span class="nc" id="L107">            return delegate.getText(key, defaultValue, args); // no caching</span>
        } else {
<span class="nc" id="L109">            return getText(key, (Locale) null, defaultValue);</span>
        }
    }

    @Override
    public String getText(String key, String defaultValue, List&lt;?&gt; args, ValueStack stack) {
<span class="pc bpc" id="L115" title="1 of 4 branches missed.">        if ((args != null) &amp;&amp; !args.isEmpty()) {</span>
<span class="fc" id="L116">            return delegate.getText(key, defaultValue, args, stack); // no caching</span>
        }
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">        return getText(key, stack != null ? (Locale) stack.getContext().get(ActionContext.LOCALE) : null, defaultValue);</span>
    }

    @Override
    public String getText(String key, String defaultValue, String[] args, ValueStack stack) {
<span class="nc bnc" id="L123" title="All 4 branches missed.">        if ((args != null) &amp;&amp; (args.length != 0)) {</span>
<span class="nc" id="L124">            return delegate.getText(key, defaultValue, args, stack); // no caching</span>
        }
<span class="nc bnc" id="L126" title="All 2 branches missed.">        return getText(key, stack != null ? (Locale) stack.getContext().get(ActionContext.LOCALE) : null, defaultValue);</span>
    }

    @Override
    public ResourceBundle getTexts(String bundleName) {
<span class="nc" id="L131">        return delegate.getTexts(bundleName);</span>
    }

    @Override
    public ResourceBundle getTexts() {
<span class="nc" id="L136">        return delegate.getTexts();</span>
    }

    public String getText(String text, Locale locale, String defaultValue) {
<span class="fc" id="L140">        return getText(text, locale, defaultValue, this.localeProvider, this.delegate);</span>
    }

    public static String getText(String text, Locale locale, String defaultValue, LocaleProvider localeProvider,
                                 TextProvider textProvider) {
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">        if (text == null) {</span>
<span class="nc" id="L146">            LOGGER.warn(&quot;null key given to getText()&quot;, new Exception(&quot;null key given to getText()&quot;).fillInStackTrace());</span>
<span class="nc" id="L147">            return defaultValue;</span>
        } else {
<span class="fc bfc" id="L149" title="All 2 branches covered.">            if (locale == null) {</span>
<span class="fc" id="L150">                locale = localeProvider.getLocale();</span>
            }
<span class="fc" id="L152">            AbstractMap.SimpleEntry&lt;String, Locale&gt; key = new AbstractMap.SimpleEntry&lt;&gt;(text, locale);</span>
<span class="fc" id="L153">            String ret = i18nCache.getIfPresent(key);</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">            if (ret == null) {</span>
<span class="fc" id="L155">                ret = textProvider.getText(text, defaultValue);</span>
<span class="fc bfc" id="L156" title="All 2 branches covered.">                if (ret != null) {</span>
<span class="fc" id="L157">                    i18nCache.put(key, ret);</span>
                } else {
<span class="fc" id="L159">                    ret = text;</span>
                }
            }
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">            return ret != null ? ret : defaultValue;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>