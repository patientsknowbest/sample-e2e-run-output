<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>JpaKotlinRepositoryFactoryBean.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.questionnaireservice.repositories</a> &gt; <span class="el_source">JpaKotlinRepositoryFactoryBean.kt</span></div><h1>JpaKotlinRepositoryFactoryBean.kt</h1><pre class="source lang-java linenums">package com.pkb.questionnaireservice.repositories

import com.pkb.questionnaireservice.entities.KPersistable
import org.springframework.beans.factory.ObjectProvider
import org.springframework.beans.factory.annotation.Autowired
import org.springframework.data.jpa.repository.query.EscapeCharacter
import org.springframework.data.jpa.repository.query.JpaQueryMethodFactory
import org.springframework.data.jpa.repository.support.JpaEntityInformation
import org.springframework.data.jpa.repository.support.JpaMetamodelEntityInformation
import org.springframework.data.jpa.repository.support.JpaRepositoryFactory
import org.springframework.data.mapping.context.MappingContext
import org.springframework.data.querydsl.EntityPathResolver
import org.springframework.data.querydsl.SimpleEntityPathResolver
import org.springframework.data.repository.Repository
import org.springframework.data.repository.core.support.RepositoryFactorySupport
import org.springframework.data.repository.core.support.TransactionalRepositoryFactoryBeanSupport
import org.springframework.lang.Nullable
import javax.persistence.EntityManager
import javax.persistence.PersistenceContext
import javax.persistence.metamodel.Metamodel


/**
 * Spring data repositories have a generic &quot;save&quot; method that abstracts the difference between insert and update. Internally, it works by
 * checking to see if the entity has already been persisted. The default strategy for this is simply to see if it has an id value or not,
 * which is fine for Hibernate- or DB-generated ids, but no good if you're using a UUID that is set up front before persistence. To get
 * round this, Spring lets you implement an interface [org.springframework.data.domain.Persistable] with your entities to specify explicitly
 * when an entity is &quot;new&quot;. The Spring Data docs explicitly describe using this mechanism for exactly this use case. See [https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.entity-persistence.saving-entites.strategies]
 *
 * Unfortunately, this interface doesn't play nicely with Kotlin entities, because it has a a getId method that
 * can't be overriden by a Kotlin property, so we'd have to either forgo Kotlin-style property access for all our ids, or given them so other
 * name. Since neither of these options are particularly nice, this class reimplements the standard Spring behaviour with a modified interface
 * more suitable for use with Kotlin objects.
 *
 * It would have been a lot neater where it not for the fact that [org.springframework.data.jpa.repository.support.JpaRepositoryFactoryBean] and
 * its superclasses are full of private members that make extension much harder. As a result I had to reimplement a bunch of simple methods
 * just to be able to change the class this instantiates to a trivial subclass. Oh well.
 */
<span class="fc" id="L39">class JpaKotlinRepositoryFactoryBean&lt;T : Repository&lt;S, ID&gt;, S, ID&gt;(clazz: Class&lt;out T&gt;) : TransactionalRepositoryFactoryBeanSupport&lt;T, S, ID&gt;(clazz) {</span>

<span class="pc bpc" id="L41" title="1 of 2 branches missed.">    @PersistenceContext lateinit var entityManager: EntityManager</span>
<span class="pc bpc" id="L42" title="1 of 2 branches missed.">    lateinit var entityPathResolver: EntityPathResolver</span>
<span class="fc" id="L43">    private var _escapeCharacter = EscapeCharacter.DEFAULT</span>
<span class="nc" id="L44">    @Autowired var queryMethodFactory: JpaQueryMethodFactory? = null</span>

    /*
	 * (non-Javadoc)
	 * @see org.springframework.data.repository.core.support.RepositoryFactoryBeanSupport#setMappingContext(org.springframework.data.mapping.context.MappingContext)
	 */
    public override fun setMappingContext(mappingContext: MappingContext&lt;*, *&gt;) {
<span class="fc" id="L51">        super.setMappingContext(mappingContext)</span>
<span class="fc" id="L52">    }</span>


    @Autowired
    fun setEntityPathResolver(resolver: ObjectProvider&lt;EntityPathResolver&gt;) {
<span class="fc" id="L57">        entityPathResolver = resolver.getIfAvailable { SimpleEntityPathResolver.INSTANCE }</span>
<span class="fc" id="L58">    }</span>

    /*
	 * (non-Javadoc)
	 * @see org.springframework.data.repository.core.support.TransactionalRepositoryFactoryBeanSupport#doCreateRepositoryFactory()
	 */
    override fun doCreateRepositoryFactory(): RepositoryFactorySupport {
<span class="fc" id="L65">        val jpaRepositoryFactory = JpaKotlinRepositoryFactory(entityManager)</span>
<span class="fc" id="L66">        jpaRepositoryFactory.setEntityPathResolver(entityPathResolver)</span>
<span class="fc" id="L67">        jpaRepositoryFactory.setEscapeCharacter(_escapeCharacter)</span>
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">        if (queryMethodFactory != null) {</span>
<span class="nc" id="L69">            jpaRepositoryFactory.setQueryMethodFactory(queryMethodFactory!!)</span>
        }
<span class="fc" id="L71">        return jpaRepositoryFactory</span>
    }


    fun setEscapeCharacter(escapeCharacter: Char) {
<span class="fc" id="L76">        this._escapeCharacter = EscapeCharacter.of(escapeCharacter)</span>
<span class="fc" id="L77">    }</span>

}

<span class="fc" id="L81">internal class JpaKotlinRepositoryFactory(private val em: EntityManager) : JpaRepositoryFactory(em) {</span>

    @Suppress(&quot;UNCHECKED_CAST&quot;)
    override fun &lt;T, ID&gt; getEntityInformation(domainClass: Class&lt;T&gt;): JpaEntityInformation&lt;T, ID&gt; {
<span class="fc bfc" id="L85" title="All 2 branches covered.">        if (KPersistable::class.java.isAssignableFrom(domainClass)) {</span>
<span class="fc" id="L86">            val clazz: Class&lt;KPersistable&lt;ID&gt;&gt; = domainClass as Class&lt;KPersistable&lt;ID&gt;&gt;</span>
<span class="fc" id="L87">            return JpaKPersistableEntityInformation(clazz, em.metamodel) as JpaEntityInformation&lt;T, ID&gt;</span>
        }
<span class="fc" id="L89">        return super.getEntityInformation(domainClass)</span>
    }
}


<span class="fc" id="L94">internal class JpaKPersistableEntityInformation&lt;T : KPersistable&lt;ID&gt;, ID&gt;(domainClass: Class&lt;T&gt;, metamodel: Metamodel) : JpaMetamodelEntityInformation&lt;T, ID&gt;(domainClass, metamodel) {</span>
    /*
	 * (non-Javadoc)
	 * @see org.springframework.data.jpa.repository.support.JpaMetamodelEntityInformation#isNew(java.lang.Object)
	 */
    override fun isNew(entity: T): Boolean {
<span class="fc" id="L100">        return entity.new</span>
    }

    /*
	 * (non-Javadoc)
	 * @see org.springframework.data.jpa.repository.support.JpaMetamodelEntityInformation#getId(java.lang.Object)
	 */
    @Nullable
    override fun getId(entity: T): ID {
<span class="nc" id="L109">        return entity.id</span>
    }
}


</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>