<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NhsNumberValidator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.entities.enums</a> &gt; <span class="el_source">NhsNumberValidator.java</span></div><h1>NhsNumberValidator.java</h1><pre class="source lang-java linenums">package com.pkb.entities.enums;

import com.google.common.collect.ImmutableSet;

import java.util.Optional;

import static com.pkb.entities.enums.NationalIdType.CHI_NUMBER;
import static com.pkb.entities.enums.NationalIdType.H_AND_C_NUMBER;
import static com.pkb.entities.enums.NationalIdType.NHS_NUMBER;
import static java.lang.Character.digit;
import static java.lang.Character.isDigit;
import static java.util.Optional.empty;
import static org.apache.commons.lang3.StringUtils.isEmpty;
import static org.apache.commons.lang3.StringUtils.replaceChars;
import static org.apache.commons.lang3.StringUtils.trimToNull;

public class NhsNumberValidator {

    private static final int NHS_NUMBER_LENGTH = 10;

    private NhsNumberValidator() {
    }

    public static String cleanInput(String id) {
        // strip out dashes and spaces
<span class="fc" id="L26">        return trimToNull(replaceChars(id, &quot;- &quot;, &quot;&quot;));</span>
    }

    public static String getCanonicalFormat(String id) {
        // 012-345-6789
<span class="fc" id="L31">        String clean = cleanInput(id);</span>
<span class="pc bpc" id="L32" title="2 of 4 branches missed.">        if (isEmpty(clean) || (clean.length() != 10)) {</span>
<span class="nc" id="L33">            return id;</span>
        }
        // official standard display is separated by spaces; we're ignoring this to make copy/paste easier
        // return clean.substring(0,3) +&quot; &quot;+ clean.substring(3,6) +&quot; &quot;+ clean.substring(6);
<span class="fc" id="L37">        return clean;</span>
    }

    //Invalid CHI numbers which are used in SCI-STORE integration testing and must continue to work
    //as this is the only way at the moment we can ensure the integration still works...
<span class="fc" id="L42">    private static final ImmutableSet&lt;String&gt; SCI_STORE_TEST_NIDS = ImmutableSet.&lt;String&gt;builder().add(&quot;1212730000&quot;, &quot;0505120000&quot;, &quot;0901150000&quot;).build();</span>

    private static boolean isSciStoreTestPatient(String cleanId) {
<span class="fc bfc" id="L45" title="All 4 branches covered.">        return cleanId != null &amp;&amp; SCI_STORE_TEST_NIDS.contains(cleanId);</span>
    }

    public static Optional&lt;NationalIdType&gt; isValid(String cleanId) {
<span class="fc" id="L49">        Optional&lt;NationalIdType&gt; maybeResult = isValidByRules(cleanId);</span>
<span class="fc bfc" id="L50" title="All 4 branches covered.">        if (maybeResult.isEmpty() &amp;&amp; isSciStoreTestPatient(cleanId)) {</span>
<span class="fc" id="L51">            return Optional.of(CHI_NUMBER);</span>
        }
<span class="fc" id="L53">        return maybeResult;</span>
    }

    private static Optional&lt;NationalIdType&gt; isValidByRules(String cleanId) {
<span class="fc bfc" id="L57" title="All 4 branches covered.">        if (cleanId == null || cleanId.length() != NHS_NUMBER_LENGTH) {</span>
<span class="fc" id="L58">            return empty();</span>
        }

<span class="fc" id="L61">        int[] nationalId = new int[NHS_NUMBER_LENGTH];</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">        for (int i = 0; i &lt; NHS_NUMBER_LENGTH; ++i) {</span>
<span class="fc" id="L63">            char current = cleanId.charAt(i);</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">            if (!isDigit(current)) {</span>
<span class="fc" id="L65">                return empty();</span>
            }
<span class="fc" id="L67">            nationalId[i] = digit(current, 10);</span>
        }

<span class="fc" id="L70">        return getValidType(nationalId);</span>
    }

    private static Optional&lt;NationalIdType&gt; getValidType(int[] nationalId) {
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (isModulus11Valid(nationalId)) {</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">            if (nationalId[0] &lt; 4) {</span>
<span class="fc bfc" id="L76" title="All 4 branches covered.">                if (2 &lt; nationalId[0] &amp;&amp; 1 &lt; nationalId[1]) {</span>
                    // validation is like NHS number (random plus the same check digit algorithm)
                    // BUT: The first two characters of the Health and Care Number must always lie within the range 32 - 39
                    // http://www.datadictionary.wales.nhs.uk/WordDocuments/healthandcarenumber.htm
<span class="fc" id="L80">                    return Optional.of(H_AND_C_NUMBER);</span>
                } else {
                    // CHI number: http://www.datadictionaryadmin.scot.nhs.uk/SMR-Datasets/SMR-Validation-Section/Patient-Identification-Section/Community-Health-Index-Number.asp
                    // Source: document rec'd from David Reardon, NHSGGC Health Information &amp; Technology
                    // Validation:
                    // - first 6 digits are patient's date of birth in DDMMYY format (so first 2 digits must be 01-31)
                    // - Digits 1-6 are the patients DOB in DDMMYY format
                    //      (so first 2 must be 01-31, and next 2 must be 01-12)
                    // - Digits 7-8 are random numbers
                    // - Digit 9 is a random number that will be odd for a male and even for a female.
                    // - Digit 10 is a check digit.
                    // - ERK: here: http://www.datadictionary.wales.nhs.uk/WordDocuments/nhsnumber.htm it says (of the NHS check digit
                    //		algo) &quot;This algorithm applies to the Welsh and English NHS Number and the Northern Ireland Health &amp; Care
                    //		Number. The check digit algorithm for the Scottish CHI Number is available on request from the NHS Wales
                    //		Informatics Service.&quot;
                    //   That's not accurate -- the mod 11 calc is exactly the same as the NHS number calc.
<span class="pc bpc" id="L96" title="4 of 12 branches missed.">                    if ((nationalId[0] &lt; 1 &amp;&amp; 0 &lt; nationalId[1]) || (0 &lt; nationalId[0] &amp;&amp; nationalId[0] &lt; 3) || (2 &lt; nationalId[0] &amp;&amp; nationalId[1] &lt; 2)) {</span>
<span class="pc bpc" id="L97" title="2 of 8 branches missed.">                        if ((nationalId[2] &lt; 1 &amp;&amp; 0 &lt; nationalId[3]) || (nationalId[2] == 1 &amp;&amp; nationalId[3] &lt; 3)) {</span>
<span class="fc" id="L98">                            return Optional.of(CHI_NUMBER);</span>
                        }
<span class="fc" id="L100">                        return empty();</span>
                    }
<span class="nc" id="L102">                    return empty();</span>
                }
            }
            // see http://www.datadictionary.nhs.uk/data_dictionary/attributes/n/nhs_number_de.asp
            // NOTE: we're allowing the test ranges (for test patients) -- in future we could disallow in some cases

            // illegal range:
            //   001 000 0010 to 319 999 9999 is the Scottish CHI
            //   320 000 001 to 399 999 999 is the NI H&amp;C number range
            // test ranges:
            //   500 000 000 - 599 999 999
            //   900 000 000 - 999 999 999
<span class="fc" id="L114">            return Optional.of(NHS_NUMBER);</span>
        }
<span class="fc" id="L116">        return empty();</span>
    }

    private static boolean isModulus11Valid(int[] ints) {
<span class="fc" id="L120">        int mod11 = (ints[0] * 10) + (ints[1] * 9) + (ints[2] * 8) + (ints[3] * 7) + (ints[4] * 6) + (ints[5] * 5) + (ints[6] * 4)</span>
                + (ints[7] * 3) + (ints[8] * 2);
<span class="fc" id="L122">        mod11 = 11 - (mod11 % 11);</span>
<span class="pc bpc" id="L123" title="1 of 6 branches missed.">        return (mod11 == ints[9]) || ((mod11 == 11) &amp;&amp; (ints[9] == 0));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>