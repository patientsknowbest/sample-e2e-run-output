<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MedicationApiHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.util</a> &gt; <span class="el_source">MedicationApiHelper.java</span></div><h1>MedicationApiHelper.java</h1><pre class="source lang-java linenums">package com.pkb.api.util;

import com.google.common.base.Objects;
import com.pkb.api.error.ApiAuthError;
import com.pkb.api.error.ApiValidationError;
import com.pkb.api.v1.model.ApiMedication;
import com.pkb.api.v1.model.MedicationFrequency;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.coding.entity.CodeableConcept;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.medication.entity.Medication;
import com.pkb.medication.entity.MedicationUnit;
import com.pkb.medication.entity.PKBMedicationFrequency;
import com.pkb.service.medication.MedicationManager;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import io.vavr.control.Either;
import org.apache.commons.lang3.StringUtils;
import org.jetbrains.annotations.NotNull;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.time.Instant;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

@Component
public class MedicationApiHelper {

    private final MedicationManager medicationManager;

    private final UserManager userManager;

    private final PatientConsentManager patientConsentManager;
    private final DateTimeService dateTimeService;

    @Autowired
    public MedicationApiHelper(MedicationManager medicationManager, UserManager userManager,
<span class="fc" id="L45">                               PatientConsentManager patientConsentManager, @NotNull DateTimeService dateTimeService) {</span>
<span class="fc" id="L46">        this.medicationManager = medicationManager;</span>
<span class="fc" id="L47">        this.userManager = userManager;</span>
<span class="fc" id="L48">        this.patientConsentManager = patientConsentManager;</span>
<span class="fc" id="L49">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L50">    }</span>

    public List&lt;ApiMedication&gt; getMedications(@NotNull LoggedInEHRRequestContext requestContext, PKBPerson patient,
                                              Instant updatedSince, boolean activeOnly,
                                              boolean includeMedicationsNotTaken) {

<span class="fc" id="L56">        List&lt;ApiMedication&gt; results = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L57">        List&lt;MedicationUnit&gt; units = medicationManager.getMedicationUnits();</span>

<span class="fc" id="L59">        List&lt;Medication&gt; dtos = medicationManager.getMedications(requestContext, patient.getId(), patient.getDefaultAccountId(), activeOnly, includeMedicationsNotTaken);</span>

<span class="fc" id="L61">        results.addAll(dtos.stream().map(dto -&gt; convert(dto, units)).collect(Collectors.toList()));</span>

<span class="fc" id="L63">        return results;</span>
    }

    public List&lt;ApiMedication&gt; getMedicationsForPatient(@NotNull LoggedInEHRRequestContext requestContext, PKBPerson user,
                                                        long patientId,
                                                        Instant updatedSince, boolean onlyCurrent,
                                                        boolean includeMedicationsNotTaken) {

<span class="pc bpc" id="L71" title="1 of 2 branches missed.">        if (!patientConsentManager.hasAccessToUser(requestContext, patientId)) {</span>
<span class="nc" id="L72">            throw new ApiAuthError(&quot;current user &quot; + user.getId()</span>
                    + &quot; does not have access to patient &quot; + patientId);
        }
<span class="fc" id="L75">        List&lt;ApiMedication&gt; results = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L77">        List&lt;MedicationUnit&gt; units = medicationManager.getMedicationUnits();</span>

<span class="fc" id="L79">        long patientAccountId = userManager.getDefaultAccountId(patientId);</span>
<span class="fc" id="L80">        List&lt;Medication&gt; dtos = medicationManager.getMedications(requestContext, patientId, patientAccountId, onlyCurrent, includeMedicationsNotTaken);</span>

<span class="fc" id="L82">        results.addAll(dtos.stream().map(dto -&gt; convert(dto, units)).collect(Collectors.toList()));</span>

<span class="fc" id="L84">        return results;</span>
    }

    public Either&lt;String, UUID&gt; createMedication(LoggedInEHRRequestContext requestContext, ApiMedication medication, long patientId,
                                                 PKBPerson loggedInUser) {

<span class="pc bpc" id="L90" title="1 of 2 branches missed.">        if (!patientConsentManager.hasAccessToUser(requestContext, patientId)) {</span>
<span class="nc" id="L91">            throw new ApiAuthError(&quot;current user &quot; + loggedInUser.getId() + &quot; does not have&quot;</span>
                    + &quot; access to patient &quot; + patientId);
        }
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">        if (StringUtils.isBlank(medication.getSubstance())) {</span>
<span class="nc" id="L95">            throw new ApiValidationError(&quot;Please specify the substance property &quot;);</span>
        }
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">        if (medication.getPersistedDate() != null) {</span>
<span class="nc" id="L98">            throw new ApiValidationError(</span>
                    &quot;Please do not set a persisted date - this will be done on the server&quot;);
        }

<span class="fc" id="L102">        Long accountId = userManager.getDefaultAccountId(patientId);</span>
<span class="fc" id="L103">        List&lt;MedicationUnit&gt; units = medicationManager.getMedicationUnits();</span>

<span class="fc" id="L105">        Medication toAdd = convert(medication, units, requestContext);</span>

<span class="fc" id="L107">        toAdd.setPatientAccountId(accountId);</span>
<span class="fc" id="L108">        toAdd.setPatientLdapUID(patientId);</span>
<span class="fc" id="L109">        toAdd.getBaseFields().setPersistedDate(Date.from(dateTimeService.now()));</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">        if (toAdd.getBaseFields().getEnteredDate() == null) {</span>
<span class="fc" id="L111">            toAdd.getBaseFields().setEnteredDate(toAdd.getBaseFields().getPersistedDate());</span>
        }

<span class="fc" id="L114">        Either&lt;String, UUID&gt; uniqueId = medicationManager.addMedication(requestContext, toAdd);</span>

<span class="fc" id="L116">        return uniqueId;</span>
    }

    public Either&lt;String, UUID&gt; updateMedication(@NotNull LoggedInEHRRequestContext requestContext, long patientId, ApiMedication medication,
                                                 PKBPerson user) {
<span class="nc bnc" id="L121" title="All 2 branches missed.">        if (!patientConsentManager.hasAccessToUser(requestContext, patientId)) {</span>
<span class="nc" id="L122">            throw new ApiAuthError(&quot;current user &quot; + user.getId() + &quot; does not have&quot;</span>
                    + &quot; access to patient &quot; + patientId);
        }
<span class="nc" id="L125">        Long accountId = userManager.getDefaultAccountId(patientId);</span>
<span class="nc" id="L126">        Medication existing = medicationManager.getMedicationByUniqueId(requestContext, accountId,</span>
<span class="nc" id="L127">                UUID.fromString(medication.getId()));</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (existing == null) {</span>
<span class="nc" id="L129">            throw new ApiValidationError(&quot;No medication found for that ID&quot;);</span>
        }
<span class="nc bnc" id="L131" title="All 2 branches missed.">        if (StringUtils.isBlank(medication.getSubstance())) {</span>
<span class="nc" id="L132">            throw new ApiValidationError(&quot;Please specify a subtance property&quot;);</span>
        }
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if (medication.getEnteredDate() == null) {</span>
<span class="nc" id="L135">            throw new ApiValidationError(&quot;Please do specify entered date&quot;);</span>
        }
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (medication.getPersistedDate() != null) {</span>
<span class="nc" id="L138">            throw new ApiValidationError(</span>
                    &quot;Please do not set a persisted date - this will be done on the server&quot;);
        }
<span class="nc" id="L141">        List&lt;MedicationUnit&gt; units = medicationManager.getMedicationUnits();</span>

<span class="nc" id="L143">        existing.setMedication(new CodeableConcept.Builder(medication.getSubstance()).build());</span>
<span class="nc bnc" id="L144" title="All 2 branches missed.">        if (medication.getFrequency() != null) {</span>
<span class="nc" id="L145">            MedicationFrequency apiFreq = MedicationFrequency.constructFromValue(medication.getFrequency());</span>
<span class="nc" id="L146">            existing.setFrequency(PKBMedicationFrequency.getFromCode(apiFreq.getCode()));</span>
        }
<span class="nc" id="L148">        existing.setDoseValue(medication.getDoseValue());</span>

<span class="nc" id="L150">        convertDoseUnit(medication, units, existing);</span>

<span class="nc" id="L152">        existing.setPatientAccountId(accountId);</span>
<span class="nc" id="L153">        existing.setStartDate(medication.getStartDate());</span>
<span class="nc" id="L154">        existing.setEndDate(medication.getEndDate());</span>
<span class="nc" id="L155">        existing.setPatientLdapUID(patientId);</span>
<span class="nc" id="L156">        existing.setInstructions(medication.getAdditionalInstructions());</span>
<span class="nc" id="L157">        existing.setSource(new SourceDetails(requestContext));</span>
<span class="nc" id="L158">        existing.getBaseFields().setEnteredDate(medication.getEnteredDate());</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (existing.getBaseFields().getEnteredDate() == null) {</span>
<span class="nc" id="L160">            existing.getBaseFields().setEnteredDate(Date.from(dateTimeService.now()));</span>
        }

<span class="nc" id="L163">        existing.getBaseFields().setPersistedDate(Date.from(dateTimeService.now()));</span>
<span class="nc" id="L164">        existing.setOrderDate(medication.getNotedTimestamp());</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">        if (medication.getPatientOnMedication() != null) {</span>
<span class="nc" id="L166">            existing.setPatientOnMedication(medication.getPatientOnMedication());</span>
        } else {
<span class="nc" id="L168">            existing.setPatientOnMedication(true);</span>
        }

<span class="nc" id="L171">        return medicationManager.updateMedication(requestContext, existing);</span>
    }

    private MedicationUnit getMedicationUnitByApiRef(String medicationDoseUnit, List&lt;MedicationUnit&gt; units) {
<span class="fc" id="L175">        MedicationUnit medicationUnit = null;</span>
<span class="fc bfc" id="L176" title="All 2 branches covered.">        for (MedicationUnit unit : units) {</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">            if (StringUtils.isEmpty(unit.getApiRef())) {</span>
<span class="fc" id="L178">                continue; // not all of them have apiRef</span>
            }

<span class="fc bfc" id="L181" title="All 2 branches covered.">            if (unit.getApiRef().equals(medicationDoseUnit)) {</span>
<span class="fc" id="L182">                medicationUnit = unit;</span>
<span class="fc" id="L183">                break;</span>
            }
<span class="fc" id="L185">        }</span>
<span class="fc" id="L186">        return medicationUnit;</span>
    }

    private String getAllowedMedicationUnits(List&lt;MedicationUnit&gt; units) {
<span class="fc" id="L190">        StringBuilder buffer = new StringBuilder();</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">        for (MedicationUnit unit : units) {</span>
<span class="fc" id="L192">            buffer.append(unit.getApiRef());</span>
<span class="fc" id="L193">            buffer.append(&quot;, &quot;);</span>
<span class="fc" id="L194">        }</span>
<span class="fc" id="L195">        return buffer.toString();</span>
    }

    private ApiMedication convert(Medication dto, List&lt;MedicationUnit&gt; units) {
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">        if (dto == null) {</span>
<span class="nc" id="L200">            return null;</span>
        }

<span class="fc" id="L203">        ApiMedication m = new ApiMedication();</span>
<span class="fc" id="L204">        m.setId(dto.getBaseFields().getUniqueId().toString());</span>
<span class="fc" id="L205">        m.setSubstance(dto.getMedication().getTextForDisplay());</span>

<span class="fc bfc" id="L207" title="All 2 branches covered.">        if (dto.getDoseValue() != null) {</span>
<span class="fc" id="L208">            m.setDoseValue(dto.getDoseValue());</span>

<span class="fc bfc" id="L210" title="All 2 branches covered.">            if (dto.getDoseUnitPkbId() != null) {</span>

<span class="pc bpc" id="L212" title="1 of 2 branches missed.">                for (MedicationUnit unit : units) {</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">                    if (Objects.equal(unit.getId(), dto.getDoseUnitPkbId())) {</span>
<span class="fc" id="L214">                        m.setDoseUnit(unit.getApiRef());</span>
<span class="fc" id="L215">                        break;</span>
                    }
<span class="fc" id="L217">                }</span>
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">            } else if (dto.getDoseUnit() != null) {</span>
<span class="fc" id="L219">                m.setDoseUnit(dto.getDoseUnit().getTextForDisplay());</span>
            }
        }

<span class="pc bpc" id="L223" title="1 of 4 branches missed.">        if ((dto.getFrequency() != null) &amp;&amp; dto.getFrequency() != PKBMedicationFrequency.BLANK) {</span>
<span class="fc" id="L224">            m.setFrequency(MedicationFrequency.getFromCode(dto.getFrequency().getCode()).getValue());</span>
        } else {
<span class="fc" id="L226">            m.setFrequency(dto.getFrequencyDisplayStr());</span>
        }

        //
<span class="fc" id="L230">        m.setPersistedDate(dto.getBaseFields().getPersistedDate());</span>
<span class="fc" id="L231">        m.setEnteredDate(dto.getBaseFields().getEnteredDate());</span>
<span class="fc" id="L232">        m.setAdditionalInstructions(dto.getInstructions());</span>

<span class="fc" id="L234">        m.setStartDate(dto.getStartDate());</span>
<span class="fc" id="L235">        m.setEndDate(dto.getEndDate());</span>

<span class="fc" id="L237">        m.setNotedTimestamp(dto.getOrderDate());</span>
        //        m.setNotedBy();

<span class="pc bpc" id="L240" title="1 of 2 branches missed.">        if (dto.getPatientOnMedication() != null) {</span>
<span class="fc" id="L241">            m.setPatientOnMedication(dto.getPatientOnMedication());</span>
        } else {
<span class="nc" id="L243">            m.setPatientOnMedication(true);</span>
        }

<span class="fc" id="L246">        return m;</span>
    }

    private Medication convert(ApiMedication api, List&lt;MedicationUnit&gt; units, EHRRequestContext requestContext) {
<span class="pc bpc" id="L250" title="1 of 2 branches missed.">        if (api == null) {</span>
<span class="nc" id="L251">            return null;</span>
        }

<span class="fc" id="L254">        Medication m = new Medication(new SourceDetails(requestContext));</span>
<span class="pc bpc" id="L255" title="1 of 2 branches missed.">        if (StringUtils.isNotBlank(api.getId())) {</span>
<span class="nc" id="L256">            m.getBaseFields().setUniqueId(UUID.fromString(api.getId()));</span>
        }
<span class="fc" id="L258">        m.setMedication(new CodeableConcept.Builder(api.getSubstance()).build());</span>
<span class="fc" id="L259">        m.setDoseValue(api.getDoseValue());</span>

<span class="fc" id="L261">        convertDoseUnit(api, units, m);</span>

        //m.setFrequency(PKBMedicationFrequency.getFromCode(api.getFrequencyCode()));
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">        if (api.getFrequency() != null) {</span>
<span class="fc" id="L265">            m.setFrequency(PKBMedicationFrequency.getFromCode(MedicationFrequency.constructFromValue(api.getFrequency()).getCode()));</span>
        } else {
<span class="nc" id="L267">            m.setFrequency(PKBMedicationFrequency.BLANK);</span>
        }

        //        m.setFrequencyText( getText( dto.getFrequency().getValue() ) );
<span class="fc" id="L271">        m.getBaseFields().setPersistedDate(api.getPersistedDate());</span>
<span class="fc" id="L272">        m.getBaseFields().setEnteredDate(api.getEnteredDate());</span>
<span class="fc" id="L273">        m.setInstructions(api.getAdditionalInstructions());</span>

<span class="fc" id="L275">        m.setStartDate(api.getStartDate());</span>
<span class="fc" id="L276">        m.setEndDate(api.getEndDate());</span>

<span class="fc" id="L278">        m.setOrderDate(api.getNotedTimestamp());</span>
        //        m.setNotedBy();
<span class="pc bpc" id="L280" title="1 of 2 branches missed.">        if (api.getPatientOnMedication() == null) {</span>
<span class="nc" id="L281">            m.setPatientOnMedication(true);</span>
        } else {
<span class="fc" id="L283">            m.setPatientOnMedication(api.getPatientOnMedication());</span>
        }

<span class="fc" id="L286">        return m;</span>
    }

    private void convertDoseUnit(ApiMedication api, List&lt;MedicationUnit&gt; units, Medication m) {
<span class="pc bpc" id="L290" title="2 of 4 branches missed.">        if ((api.getDoseUnit() != null) &amp;&amp; !api.getDoseUnit().isEmpty()) {</span>
<span class="fc" id="L291">            MedicationUnit medicationUnit = getMedicationUnitByApiRef(api.getDoseUnit(), units);</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">            if (medicationUnit == null) {</span>
<span class="fc" id="L293">                throw new ApiValidationError(&quot;couldn't find medication unit &quot; + api.getDoseUnit()</span>
<span class="fc" id="L294">                        + &quot;. Allowed values are &quot; + getAllowedMedicationUnits(units));</span>
            } else {
<span class="fc" id="L296">                m.setDoseUnitPkbId(medicationUnit.getId());</span>
            }
        }
<span class="fc" id="L299">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>