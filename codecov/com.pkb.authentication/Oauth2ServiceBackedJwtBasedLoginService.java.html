<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Oauth2ServiceBackedJwtBasedLoginService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.authentication</a> &gt; <span class="el_source">Oauth2ServiceBackedJwtBasedLoginService.java</span></div><h1>Oauth2ServiceBackedJwtBasedLoginService.java</h1><pre class="source lang-java linenums">package com.pkb.authentication;

import com.pkb.crypto.AccountKeyPair;
import com.pkb.datamodel.Account;
import com.pkb.datamodel.entity.mapper.AccountMapper;
import com.pkb.datamodel.entity.mapper.TeamWithOrgMapper;
import com.pkb.datamodel.team.TeamWithOrg;
import com.pkb.domain.repository.AccountRepository;
import com.pkb.domain.repository.OrgRepository;
import com.pkb.domain.repository.TeamRepository;
import com.pkb.entities.pub.PublicOrg;
import com.pkb.oauth2.client.Oauth2Client;
import com.pkb.oauth2.client.model.ThirdPartyClientJwtVerificationRequest;
import com.pkb.oauth2.client.model.ThirdPartyClientOrgAccountPrivateKeyResponse;
import io.vavr.collection.List;
import io.vavr.control.Either;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.security.auth.login.LoginException;
import java.lang.invoke.MethodHandles;
import java.util.Base64;
import java.util.UUID;

import static com.pkb.authentication.ImmutableAuthenticatedIdentity.authenticatedIdentity;
import static com.pkb.authentication.principal.user.ImmutableAuthenticatedSystemUser.authenticatedSystemUser;
import static com.pkb.crypto.AccountPrivateKey.accountPrivateKey;
import static io.vavr.control.Either.left;
import static io.vavr.control.Either.right;

/**
 * Handles authentication with a JWT signed by our oauth2 server.
 */
public class Oauth2ServiceBackedJwtBasedLoginService {

<span class="fc" id="L37">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

    private final Oauth2Client oauth2Client;

    private final AccountRepository accountRepository;
    private final AccountMapper accountMapper;
    private final OrgRepository orgRepository;
    private final TeamRepository teamRepository;
    private final TeamWithOrgMapper teamWithOrgMapper;

    public Oauth2ServiceBackedJwtBasedLoginService(Oauth2Client oauth2Client,
                                                   AccountRepository accountRepository,
                                                   AccountMapper accountMapper,
                                                   OrgRepository orgRepository,
                                                   TeamRepository teamRepository,
<span class="fc" id="L52">                                                   TeamWithOrgMapper teamWithOrgMapper) {</span>
<span class="fc" id="L53">        this.oauth2Client = oauth2Client;</span>
<span class="fc" id="L54">        this.accountRepository = accountRepository;</span>
<span class="fc" id="L55">        this.accountMapper = accountMapper;</span>
<span class="fc" id="L56">        this.orgRepository = orgRepository;</span>
<span class="fc" id="L57">        this.teamRepository = teamRepository;</span>
<span class="fc" id="L58">        this.teamWithOrgMapper = teamWithOrgMapper;</span>
<span class="fc" id="L59">    }</span>

    public @NotNull Either&lt;LoginException, AuthenticatedIdentity&gt; authenticate(ThirdPartyClientJwtVerificationRequest thirdPartyClientJwtVerificationRequest) {
<span class="fc" id="L62">        return oauth2Client.verifyThirdPartyClientJwt(thirdPartyClientJwtVerificationRequest)</span>
<span class="fc" id="L63">                .fold(error -&gt; left(new LoginException(error.getDescription())), this::createAuthenticatedIdentity);</span>
    }

    private Either&lt;LoginException, AuthenticatedIdentity&gt; createAuthenticatedIdentity(ThirdPartyClientOrgAccountPrivateKeyResponse thirdPartyClientOrgAccountPrivateKey) {
<span class="fc" id="L67">        long orgId = getOrgId(thirdPartyClientOrgAccountPrivateKey.getOrgPublicId());</span>
<span class="fc" id="L68">        List&lt;TeamWithOrg&gt; teams = getTeamsWithOrg(thirdPartyClientOrgAccountPrivateKey.getOrgPublicId());</span>

<span class="fc" id="L70">        Account account = accountMapper.entityToDataModel(accountRepository.getOrgAccount(orgId));</span>
<span class="fc" id="L71">        var orgAccountPrivateKey = accountPrivateKey(Base64.getDecoder().decode(thirdPartyClientOrgAccountPrivateKey.getOrgAccountKey()), &quot;RSA&quot;);</span>
<span class="fc" id="L72">        var orgAccountPublicKey = account.getPublicKey();</span>
<span class="fc" id="L73">        AuthenticatedIdentity authenticatedIdentity = authenticatedIdentity()</span>
<span class="fc" id="L74">                .authenticatedUser(authenticatedSystemUser(thirdPartyClientOrgAccountPrivateKey.getClientPublicId(), orgId, thirdPartyClientOrgAccountPrivateKey.getOrgPublicId(), teams))</span>
<span class="fc" id="L75">                .accountKeyPair(AccountKeyPair.accountKeyPair(orgAccountPublicKey, orgAccountPrivateKey))</span>
<span class="fc" id="L76">                .build();</span>
<span class="fc" id="L77">        LOGGER.info(&quot;OAUTH2-API jwt login successful for client: {}&quot;, thirdPartyClientOrgAccountPrivateKey.getClientPublicId());</span>
<span class="fc" id="L78">        return right(authenticatedIdentity);</span>
    }

    private long getOrgId(UUID orgPublicId) {
<span class="fc" id="L82">        return orgRepository.findOptionalByPublicId(orgPublicId)</span>
<span class="fc" id="L83">                .map(PublicOrg::getId)</span>
<span class="pc" id="L84">                .getOrElseThrow(() -&gt; new RuntimeException(&quot;Can't find org id&quot;));</span>
    }

    private List&lt;TeamWithOrg&gt; getTeamsWithOrg(UUID orgPublicId) {
<span class="fc" id="L88">        return teamRepository.findByOrg_publicId(orgPublicId)</span>
<span class="fc" id="L89">                .map(teamWithOrgMapper::entityToDataModel);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>