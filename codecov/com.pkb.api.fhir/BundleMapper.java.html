<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BundleMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.fhir</a> &gt; <span class="el_source">BundleMapper.java</span></div><h1>BundleMapper.java</h1><pre class="source lang-java linenums">package com.pkb.api.fhir;

import ca.uhn.fhir.rest.api.server.RequestDetails;
import ca.uhn.fhir.rest.server.exceptions.BaseServerResponseException;
import com.pkb.domain.criteria.BaseCriteriaResult;
import com.pkb.domain.criteria.CriteriaResult;
import com.pkb.domain.criteria.FhirCriteriaResult;
import io.vavr.API;
import io.vavr.collection.HashMap;
import io.vavr.collection.Seq;
import io.vavr.collection.Set;
import io.vavr.control.Option;
import org.hl7.fhir.dstu3.model.Appointment;
import org.hl7.fhir.dstu3.model.Bundle;
import org.hl7.fhir.dstu3.model.Communication;
import org.hl7.fhir.dstu3.model.Consent;
import org.hl7.fhir.dstu3.model.DiagnosticReport;
import org.hl7.fhir.dstu3.model.DocumentReference;
import org.hl7.fhir.dstu3.model.Encounter;
import org.hl7.fhir.dstu3.model.NamingSystem;
import org.hl7.fhir.dstu3.model.Observation;
import org.hl7.fhir.dstu3.model.OperationOutcome;
import org.hl7.fhir.dstu3.model.OperationOutcome.IssueSeverity;
import org.hl7.fhir.dstu3.model.OperationOutcome.OperationOutcomeIssueComponent;
import org.hl7.fhir.dstu3.model.Patient;
import org.hl7.fhir.dstu3.model.Person;
import org.hl7.fhir.dstu3.model.ProcedureRequest;
import org.hl7.fhir.dstu3.model.Provenance;
import org.hl7.fhir.dstu3.model.Questionnaire;
import org.hl7.fhir.dstu3.model.QuestionnaireResponse;
import org.hl7.fhir.dstu3.model.Resource;

import java.net.URLEncoder;
import java.util.function.Function;
import java.util.regex.Pattern;

import static ca.uhn.fhir.rest.api.Constants.LINK_SELF;
import static io.vavr.API.Seq;
import static java.nio.charset.StandardCharsets.UTF_8;
import static java.util.Comparator.comparing;
import static java.util.stream.Collectors.joining;
import static org.apache.commons.lang3.StringUtils.substringBefore;
import static org.hl7.fhir.dstu3.model.Bundle.BundleType.SEARCHSET;
import static org.hl7.fhir.dstu3.model.Bundle.SearchEntryMode.INCLUDE;
import static org.hl7.fhir.dstu3.model.Bundle.SearchEntryMode.MATCH;
import static org.hl7.fhir.dstu3.model.Bundle.SearchEntryMode.OUTCOME;
import static org.hl7.fhir.dstu3.model.OperationOutcome.IssueSeverity.ERROR;
import static org.hl7.fhir.dstu3.model.OperationOutcome.IssueSeverity.FATAL;

<span class="fc" id="L50">public class BundleMapper {</span>
    //OMNI: 60 - what is this list of resources for? Why do some resources get a full url? Why these ones?
<span class="fc" id="L52">    private static final Seq&lt;Class&lt;? extends Resource&gt;&gt; RESOURCES_TO_GENERATE_FULL_URL_FOR = Seq(</span>
            Appointment.class,
            Communication.class,
            Consent.class,
            DiagnosticReport.class,
            DocumentReference.class,
            Observation.class,
            Person.class,
            Patient.class,
            Encounter.class,
            Provenance.class,
            NamingSystem.class,
            OperationOutcome.class,
            Questionnaire.class,
            QuestionnaireResponse.class,
            ProcedureRequest.class);

<span class="fc" id="L69">    private static final Set&lt;IssueSeverity&gt; ERROR_LIKE_SEVERITY = API.Set(ERROR, FATAL);</span>

    public Bundle toBundle(Seq&lt;? extends Resource&gt; resources, RequestDetails request, Option&lt;Seq&lt;String&gt;&gt; supportedParameters) {
<span class="nc" id="L72">        Bundle bundle = getBundle(resources.size(), request, supportedParameters);</span>
<span class="nc" id="L73">        resources.forEach(resource -&gt; bundle.addEntry(getBundleEntryComponent(request.getFhirServerBase(), resource)));</span>
<span class="nc" id="L74">        return bundle;</span>
    }

    public Bundle toBundle(BaseCriteriaResult&lt;? extends Resource&gt; resources, RequestDetails request, Option&lt;Seq&lt;String&gt;&gt; supportedParameters) {
<span class="fc" id="L78">        Bundle bundle = getBundle(resources.getTotal(), request, supportedParameters);</span>
<span class="fc" id="L79">        resources.getPage().forEach(resource -&gt; bundle.addEntry(getBundleEntryComponent(request.getFhirServerBase(), resource)));</span>
<span class="fc" id="L80">        return bundle;</span>
    }

    public Bundle toBundle(Option&lt;? extends Resource&gt; maybeResource, RequestDetails request, Option&lt;Seq&lt;String&gt;&gt; supportedParameters) {
<span class="nc" id="L84">        return maybeResource</span>
<span class="nc" id="L85">                .map(resource -&gt; toBundle(resource, request, supportedParameters))</span>
<span class="nc" id="L86">                .getOrElse(() -&gt; getBundle(0, request, supportedParameters));</span>
    }

    public Bundle toBundle(Resource resource, RequestDetails request, Option&lt;Seq&lt;String&gt;&gt; supportedParameters) {
<span class="nc" id="L90">        return getBundle(1, request, supportedParameters).addEntry(getBundleEntryComponent(request.getFhirServerBase(), resource));</span>
    }

    public Bundle toBundleWithIncludes(
            FhirCriteriaResult&lt;? extends Resource&gt; result,
            RequestDetails request,
            Option&lt;Seq&lt;String&gt;&gt; presentAndValidParameterNames) {

<span class="fc" id="L98">        Bundle bundle = toBundle(result, request, presentAndValidParameterNames);</span>
<span class="fc" id="L99">        result.includes().forEach(resource -&gt; bundle.addEntry(getBundleEntryComponent(request.getFhirServerBase(), resource, INCLUDE)));</span>
<span class="fc" id="L100">        return bundle;</span>
    }

    public Bundle toEmptyBundle(OperationOutcome outcome, RequestDetails request, Option&lt;Seq&lt;String&gt;&gt; supportedParameters) {
<span class="fc" id="L104">        return getBundle(0, request, supportedParameters)</span>
<span class="fc" id="L105">                .addEntry(getBundleEntryComponent(request.getFhirServerBase(), outcome, OUTCOME));</span>
    }

    /**
     * In HAPI implementation of FHIR official documentation suggest that the only way to influence HTTP status codes are via throwing
     * sub-types of {@link BaseServerResponseException}s.
     */
    public Bundle toEmptyBundleOrThrowException(BaseServerResponseException exception, RequestDetails request, Option&lt;Seq&lt;String&gt;&gt; supportedParameters)
            throws BaseServerResponseException {
<span class="fc" id="L114">        OperationOutcome operationOutcome = (OperationOutcome) exception.getOperationOutcome();</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">        if (operationOutcome == null || operationOutcome.getIssue().stream()</span>
<span class="fc" id="L116">                .map(OperationOutcomeIssueComponent::getSeverity)</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">                .anyMatch(ERROR_LIKE_SEVERITY::contains)) {</span>
<span class="fc" id="L118">            throw exception;</span>
        } else {
            // if we have severity like WARNING we return an empty bundle (HTTP code will be 200)
<span class="fc" id="L121">            return toEmptyBundle(operationOutcome, request, supportedParameters);</span>
        }
    }

    public &lt;R extends Resource&gt; Function&lt;CriteriaResult&lt;? extends R&gt;, Bundle&gt; toBundle(RequestDetails request, Option&lt;Seq&lt;String&gt;&gt; supportedParameters) {
<span class="fc" id="L126">        return resources -&gt; toBundle(resources, request, supportedParameters);</span>
    }

    public &lt;R extends Resource&gt; Function&lt;Option&lt;? extends R&gt;, Bundle&gt; toBundleFromOptional(RequestDetails request, Option&lt;Seq&lt;String&gt;&gt; supportedParameters) {
<span class="nc" id="L130">        return maybeResource -&gt; toBundle(maybeResource, request, supportedParameters);</span>
    }

    public &lt;R extends Resource&gt; Function&lt;BaseServerResponseException, Bundle&gt; toEmptyBundle(RequestDetails request, Option&lt;Seq&lt;String&gt;&gt; supportedParameters) {
<span class="fc" id="L134">        return exception -&gt; toEmptyBundleOrThrowException(exception, request, supportedParameters);</span>
    }

    private Bundle getBundle(long total, RequestDetails request, Option&lt;Seq&lt;String&gt;&gt; supportedParameters) {
<span class="fc" id="L138">        Bundle bundle = new Bundle();</span>
<span class="fc" id="L139">        bundle.setType(SEARCHSET);</span>
<span class="fc" id="L140">        bundle.setTotal((int) total); // :)</span>
<span class="fc" id="L141">        bundle.addLink(getBundleSelfLink(request, supportedParameters));</span>
<span class="fc" id="L142">        return bundle;</span>
    }

    private Bundle.BundleLinkComponent getBundleSelfLink(RequestDetails request, Option&lt;Seq&lt;String&gt;&gt; supportedParameters) {
<span class="fc" id="L146">        Bundle.BundleLinkComponent link = new Bundle.BundleLinkComponent();</span>
<span class="fc" id="L147">        link.setRelation(LINK_SELF);</span>
<span class="fc" id="L148">        link.setUrl(composeSelfLink(request, supportedParameters));</span>
<span class="fc" id="L149">        return link;</span>
    }

    private String composeSelfLink(RequestDetails request, Option&lt;Seq&lt;String&gt;&gt; supportedParameters) {
<span class="fc" id="L153">        String selfLink = &quot;/&quot; + request.getRequestPath();</span>
<span class="fc" id="L154">        String allAllowedUrlParamsWithValues = buildParamsWithValues(request, supportedParameters);</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">        if (allAllowedUrlParamsWithValues.isEmpty()) {</span>
<span class="fc" id="L156">            return selfLink;</span>
        }
<span class="fc" id="L158">        return selfLink + &quot;?&quot; + allAllowedUrlParamsWithValues;</span>
    }

    private String buildParamsWithValues(RequestDetails request, Option&lt;Seq&lt;String&gt;&gt; supportedParameters) {
<span class="fc" id="L162">        var pathAndParams = request.getCompleteUrl().replaceAll(Pattern.quote(request.getFhirServerBase()), &quot;&quot;);</span>
<span class="fc" id="L163">        return HashMap.ofAll(request.getParameters())</span>
<span class="fc" id="L164">                .filter((parameterName, values) -&gt; isParameterSupported(parameterName, supportedParameters))</span>
<span class="fc" id="L165">                .toStream()</span>
<span class="fc" id="L166">                .sorted(comparing(p -&gt; pathAndParams.indexOf(p._1)))</span>
<span class="fc" id="L167">                .flatMap(parameterWithValues -&gt; Seq(parameterWithValues._2)</span>
<span class="fc" id="L168">                        .map(value -&gt; parameterWithValues._1 + &quot;=&quot; + tryUrlEncode(value)))</span>
<span class="fc" id="L169">                .collect(joining(&quot;&amp;&quot;));</span>
    }

    private String tryUrlEncode(String url) {
<span class="fc" id="L173">        return URLEncoder.encode(url, UTF_8);</span>
    }

    private boolean isParameterSupported(String parameter, Option&lt;Seq&lt;String&gt;&gt; supportedParameters) {
<span class="fc" id="L177">        return supportedParameters</span>
<span class="fc" id="L178">                .map(supportedUrlParam -&gt; supportedUrlParam.contains(substringBefore(parameter, &quot;:&quot;)))</span>
<span class="fc" id="L179">                .getOrElse(true);</span>
    }

    private Bundle.BundleEntryComponent getBundleEntryComponent(String basePath, Resource resource) {
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">        Bundle.SearchEntryMode mode = resource instanceof OperationOutcome ? OUTCOME : MATCH;</span>
<span class="fc" id="L184">        return getBundleEntryComponent(basePath, resource, mode);</span>
    }

    private Bundle.BundleEntryComponent getBundleEntryComponent(String basePath, Resource resource, Bundle.SearchEntryMode mode) {
<span class="fc" id="L188">        Option&lt;String&gt; maybePath = RESOURCES_TO_GENERATE_FULL_URL_FOR</span>
<span class="fc" id="L189">                .find(type -&gt; type.isAssignableFrom(resource.getClass()))</span>
<span class="fc" id="L190">                .map(type -&gt; basePath + &quot;/&quot; + type.getSimpleName() + &quot;/&quot; + resource.getId());</span>

<span class="fc" id="L192">        Bundle.BundleEntryComponent component = new Bundle.BundleEntryComponent();</span>
<span class="fc" id="L193">        component.setResource(resource);</span>
<span class="fc" id="L194">        component.setSearch(new Bundle.BundleEntrySearchComponent().setMode(mode));</span>
<span class="fc" id="L195">        maybePath.peek(component::setFullUrl);</span>
<span class="fc" id="L196">        return component;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>