<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AllergyManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.allergy.impl</a> &gt; <span class="el_source">AllergyManager.java</span></div><h1>AllergyManager.java</h1><pre class="source lang-java linenums">package com.pkb.service.allergy.impl;

import com.pkb.allergy.entity.Allergy;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.common.base.Error;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.dataupload.entity.UploadedData;
import com.pkb.emis.es.entity.EmisEsObservationDelta;
import com.pkb.exception.PKBException;
import com.pkb.service.dataupload.emis.esv2.EmisEsDeltaManager;
import com.pkb.service.dataupload.emis.esv2.EmisEsManager;
import com.pkb.service.dataupload.emis.esv2.batch.impl.EmisEsProblemStatusDescriptionHelperMixin;
import com.pkb.service.dataupload.processor.UploadedDataService;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.util.tolven.TolvenBeanFactory;
import io.vavr.control.Either;
import org.jetbrains.annotations.NotNull;

import java.time.Instant;
import java.util.LinkedList;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

import static com.pkb.service.dataupload.processor.ImmutableLoggedInUploadedDataProcessingContext.loggedInUploadedDataProcessingContext;

public class AllergyManager extends EmisEsDeltaManager&lt;Allergy&gt; implements EmisEsProblemStatusDescriptionHelperMixin {

    private final UploadedDataService uploadedDataService;
    private final EHRAllergyManager ehrAllergyManager;

    public AllergyManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider, EmisEsManager emisEsManager,
                          UploadedDataService uploadedDataService, EHRAllergyManager ehrAllergyManager) {
<span class="fc" id="L37">        super(config, beanFactory, dateTimeService, uuidProvider, emisEsManager);</span>
<span class="fc" id="L38">        this.uploadedDataService = uploadedDataService;</span>
<span class="fc" id="L39">        this.ehrAllergyManager = ehrAllergyManager;</span>
<span class="fc" id="L40">    }</span>

    /**
     * Save an allergy record
     *
     * @param allergy
     * @return uniqueId
     */
    public Either&lt;String, UUID&gt; saveAllergy(EHRRequestContext requestContext, Allergy allergy) {
        try {
<span class="fc" id="L50">            return ehrAllergyManager.save(requestContext, allergy);</span>
<span class="nc" id="L51">        } catch (Exception exception) {</span>
<span class="nc" id="L52">            throw new PKBException(&quot;Error while saving Allergy&quot;, exception);</span>
        }
    }

    /**
     * @param allergyList
     */
    public void addAllergies(EHRRequestContext requestContext, List&lt;Allergy&gt; allergyList) {
        try {
<span class="fc" id="L61">            ehrAllergyManager.save(requestContext, allergyList);</span>
<span class="nc" id="L62">        } catch (Exception exception) {</span>
<span class="nc" id="L63">            throw new PKBException(&quot;Error while adding allergies&quot;, exception);</span>
<span class="fc" id="L64">        }</span>
<span class="fc" id="L65">    }</span>

    /**
     * Update an allergy record in-situ
     *
     * @return Either
     *         Either.left = Error message if update detects that datapoint is excluded via CodingMatch entry
     *         Either.right = uniqueId of the allergy
     */
    /**
     * @returns Either
     * Either.left = Error message if update detects that datapoint is excluded via CodingMatch entry
     * Either.right = uniqueId of the allergy
     */
    public Either&lt;String, UUID&gt; updateAllergy(EHRRequestContext requestContext, Allergy allergy) {
<span class="fc" id="L80">        return ehrAllergyManager.update(requestContext, allergy);</span>
    }

    /**
     * Retrieve the full list of allergies for the patient
     *
     * @param requestContext
     * @param patientId
     * @param patientAccountId
     * @param offset
     * @param pageSize
     * @param includeNegativeAllergies
     * @return
     */
    public List&lt;Allergy&gt; getAllergies(@NotNull LoggedInEHRRequestContext requestContext,
                                      long patientId,
                                      Long patientAccountId,
                                      int offset, int pageSize,
                                      boolean includeNegativeAllergies) {
        try {
<span class="fc" id="L100">            syncData(requestContext, patientId, patientAccountId);</span>
<span class="fc" id="L101">            return ehrAllergyManager.getAllergies(requestContext, patientAccountId, offset, pageSize, includeNegativeAllergies);</span>
<span class="nc" id="L102">        } catch (Exception exception) {</span>
<span class="nc" id="L103">            throw new PKBException(&quot;Error while getting Allergy list&quot;, exception);</span>
        }
    }

    private void syncData(@NotNull LoggedInEHRRequestContext requestContext, long patientLdapId, Long patientAccountId) {
<span class="fc" id="L108">        synchUploadedData(requestContext, patientLdapId);</span>
<span class="fc" id="L109">        applyEmisEsDeltas(requestContext, patientLdapId, patientAccountId);</span>
<span class="fc" id="L110">    }</span>

    /**
     * Retrieve the selected allergy records
     *
     * @param requestContext
     * @param patientId
     * @param patientAccountId
     * @param allergyIds
     * @return
     */
    public List&lt;Allergy&gt; getAllergies(@NotNull LoggedInEHRRequestContext requestContext, long patientId, Long patientAccountId,
                                      List&lt;Long&gt; allergyIds) {
        try {
<span class="fc" id="L124">            syncData(requestContext, patientId, patientAccountId);</span>
<span class="fc" id="L125">            return ehrAllergyManager.getByIds(requestContext, patientAccountId, new LinkedList&lt;&gt;(allergyIds));</span>
<span class="nc" id="L126">        } catch (Exception exception) {</span>
<span class="nc" id="L127">            throw new PKBException(&quot;Error while getting Allergy list&quot;, exception);</span>
        }
    }

    /**
     * Retrieve a single allergy record
     *
     * @param patientLdapId
     * @param allergyId
     * @return
     */
    public Optional&lt;Allergy&gt; findAllergy(@NotNull LoggedInEHRRequestContext requestContext, long allergyId) {
<span class="fc" id="L139">        return Optional.ofNullable(ehrAllergyManager.getById(requestContext, allergyId));</span>
    }

    public Allergy getAllergy(@NotNull LoggedInEHRRequestContext requestContext, long allergyId) {
<span class="fc" id="L143">        return findAllergy(requestContext, allergyId)</span>
<span class="pc" id="L144">                .orElseThrow(() -&gt; new IllegalStateException(&quot;Can't find existing allergy for id: &quot; + allergyId));</span>
    }

    /**
     * Mark the selected allergy records as deleted
     *
     * @param patientLdapId
     * @param patientAccountId
     * @param allergyIds
     */
    public List&lt;Allergy&gt; deleteAllergies(@NotNull LoggedInEHRRequestContext requestContext, Long patientAccountId, List&lt;Long&gt; allergyIds,
                                         SourceDetails deletedBy, Instant deletionDate) {
<span class="fc" id="L156">        return ehrAllergyManager</span>
<span class="fc" id="L157">                .deleteByIds(requestContext, patientAccountId, new LinkedList&lt;&gt;(allergyIds), deletedBy, deletionDate);</span>
    }

    /**
     * Get Allergy by code and updated Since date
     *
     * @param patientId
     * @param accountId
     * @param codes        - the list of codes to search on.
     * @param deletionDate
     * @return
     */
    public List&lt;Allergy&gt; getAllergies(
            @NotNull LoggedInEHRRequestContext requestContext,
            long patientId,
            Long patientAccountId,
            Instant updatedSinceDate,
            boolean includeNegativeAllergies) {
        try {
<span class="nc" id="L176">            syncData(requestContext, patientId, patientAccountId);</span>

<span class="nc" id="L178">            return ehrAllergyManager.getAllergies(requestContext, patientAccountId,</span>
                    updatedSinceDate, includeNegativeAllergies);
<span class="nc" id="L180">        } catch (Exception exception) {</span>
<span class="nc" id="L181">            throw new PKBException(&quot;Error while fetching allergy list by apiRefs&quot;, exception);</span>
        }
    }

    /**
     * Uses transactions, and commits after each UploadedData is processed... if this needs to be called from within a
     * transaction in the action, we'll need some fancier coding here (maybe programmatically merge the messages and submit
     * at once?).
     * &lt;p&gt;
     * Doesn't catch/handle any exceptions; just logs errors and sometimes lets them flow out (but more often just logs)
     */
    private void synchUploadedData(@NotNull LoggedInEHRRequestContext requestContext, long patientId) {
<span class="fc" id="L193">        uploadedDataService.synchUploadedData(</span>
<span class="fc" id="L194">                loggedInUploadedDataProcessingContext()</span>
<span class="fc" id="L195">                        .requestContext(requestContext.withPiggyback(true))</span>
<span class="fc" id="L196">                        .patientId(patientId)</span>
<span class="fc" id="L197">                        .destination(UploadedData.Destination.ALLERGY_UPDATE)</span>
<span class="fc" id="L198">                        .build());</span>
<span class="fc" id="L199">    }</span>

    /**
     * Retrieve a single allergy record by uniqueId
     *
     * @param patientAccountId
     * @param uniqueId
     * @return
     */
    public Allergy getAllergyByUniqueId(@NotNull LoggedInEHRRequestContext requestContext, Long patientAccountId, UUID uniqueId) {
        try {
<span class="fc" id="L210">            return ehrAllergyManager.getByUniqueId(requestContext, patientAccountId, uniqueId);</span>
<span class="nc" id="L211">        } catch (Exception exception) {</span>
<span class="nc" id="L212">            throw new PKBException(&quot;Error while fetching Allergy list by uniqueId&quot;, exception);</span>
        }
    }


    @Override
    public Either&lt;Error, Allergy&gt; applyDelta(@NotNull LoggedInEHRRequestContext ehrRequestContext, long patientId, long patientAccountId,
                                             EmisEsObservationDelta delta) {
<span class="fc" id="L220">        Allergy allergy = getAllergyByUniqueId(ehrRequestContext, patientAccountId, delta.getParentUniqueId());</span>
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">        if (delta.isProblemDeleted()) {</span>
<span class="nc" id="L222">            allergy.setEndOfSymptoms(null);</span>
<span class="nc" id="L223">            allergy.setStatus(Allergy.AllergyStatus.ACTIVE);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">            if (allergy.getOnsetOfSymptoms() != null) {</span>
<span class="nc" id="L225">                allergy.setDateAsserted(allergy.getOnsetOfSymptoms());</span>
            }
<span class="nc" id="L227">            allergy.setOnsetOfSymptoms(null);</span>
        } else {
<span class="fc" id="L229">            allergy.setEndOfSymptoms(delta.getEndDate());</span>
<span class="fc" id="L230">            handleProblemStatusDescription(delta,</span>
<span class="fc" id="L231">                    status -&gt; allergy.setStatus(Allergy.AllergyStatus.ACTIVE),</span>
<span class="fc" id="L232">                    status -&gt; allergy.setStatus(Allergy.AllergyStatus.INACTIVE));</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">            if (allergy.getDateAsserted() != null) {</span>
<span class="fc" id="L234">                allergy.setOnsetOfSymptoms(allergy.getDateAsserted());</span>
<span class="fc" id="L235">                allergy.setDateAsserted(null);</span>
            }
        }
<span class="fc" id="L238">        Either&lt;String, UUID&gt; result = updateAllergy(ehrRequestContext, allergy);</span>
<span class="pc" id="L239">        return result.map(uniqueId -&gt; allergy).mapLeft(errorMessage -&gt; new Error(ERROR_APPLYING_DELTA, result.getLeft()));</span>
    }

    @Override
    public EmisEsObservationDelta.DeltaType getDeltaType() {
<span class="fc" id="L244">        return EmisEsObservationDelta.DeltaType.ALLERGY;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>