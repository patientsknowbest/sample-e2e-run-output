<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ParametersToPatientIdentifiersDTOMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.fhir.parameters</a> &gt; <span class="el_source">ParametersToPatientIdentifiersDTOMapper.java</span></div><h1>ParametersToPatientIdentifiersDTOMapper.java</h1><pre class="source lang-java linenums">package com.pkb.api.fhir.parameters;

import com.pkb.api.fhir.FhirCodeSystemToNationalIdTypeMapper;
import com.pkb.api.fhir.util.Issues;
import com.pkb.datamodel.ImmutablePatientIdentifierDTO;
import com.pkb.datamodel.PatientIdentifierDTO;
import com.pkb.entities.enums.NationalIdType;
import com.pkb.entities.enums.ValidNationalId;
import io.vavr.collection.List;
import io.vavr.control.Option;
import io.vavr.control.Validation;
import org.hl7.fhir.dstu3.model.Identifier;
import org.hl7.fhir.dstu3.model.Parameters;
import org.jetbrains.annotations.NotNull;

import java.util.UUID;

import static com.pkb.api.fhir.parameters.ParametersMapper.PKB_ID_SYSTEM;
import static com.pkb.api.fhir.util.Issues.errorFrom;
import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.List;
import static io.vavr.API.Match;
import static io.vavr.Predicates.instanceOf;
import static io.vavr.control.Validation.invalid;
import static io.vavr.control.Validation.valid;
import static java.lang.String.format;
import static org.apache.commons.lang3.StringUtils.isBlank;
import static org.hl7.fhir.dstu3.model.OperationOutcome.IssueType.INVALID;
import static org.hl7.fhir.dstu3.model.OperationOutcome.IssueType.NOTSUPPORTED;
import static org.hl7.fhir.dstu3.model.OperationOutcome.IssueType.REQUIRED;
import static org.hl7.fhir.dstu3.model.OperationOutcome.IssueType.TOOCOSTLY;

public class ParametersToPatientIdentifiersDTOMapper {

    private static final String PATIENT_IDENTIFIER_PART_NAME = &quot;patientIdentifier&quot;;

    private final FhirCodeSystemToNationalIdTypeMapper fhirCodeSystemToNationalIdTypeMapper;

<span class="fc" id="L40">    public ParametersToPatientIdentifiersDTOMapper(FhirCodeSystemToNationalIdTypeMapper fhirCodeSystemToNationalIdTypeMapper) {</span>
<span class="fc" id="L41">        this.fhirCodeSystemToNationalIdTypeMapper = fhirCodeSystemToNationalIdTypeMapper;</span>
<span class="fc" id="L42">    }</span>

    public @NotNull
    Validation&lt;Issues, List&lt;ValidNationalId&gt;&gt; toPatientNationalIdentifiers(@NotNull Parameters parameters, int parametersLimit) {
<span class="fc" id="L46">        Issues validation = validateInput(parameters, parametersLimit);</span>
<span class="fc bfc" id="L47" title="All 2 branches covered.">        if (!validation.isEmpty()) {</span>
<span class="fc" id="L48">            return invalid(validation);</span>
        }
<span class="fc" id="L50">        return getPatientNationalIdentifierDTOs(parameters);</span>
    }

    public @NotNull
    Validation&lt;Issues, List&lt;PatientIdentifierDTO&gt;&gt; toPatientIdentifiers(@NotNull Parameters parameters, int parametersLimit) {
<span class="fc" id="L55">        Issues issue = validateInput(parameters, parametersLimit);</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">        if (!issue.isEmpty()) {</span>
<span class="fc" id="L57">            return invalid(issue);</span>
        }
<span class="fc" id="L59">        List&lt;PatientIdentifierDTO&gt; dtos = List();</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">        for (Parameters.ParametersParameterComponent parameterComponent : parameters.getParameter()) {</span>
<span class="fc" id="L61">            Identifier identifier = (Identifier) parameterComponent.getValue();</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">            if (identifier.getSystem().equals(PKB_ID_SYSTEM)) {</span>
                try {
<span class="fc" id="L64">                    UUID idValue = UUID.fromString(identifier.getValue());</span>
<span class="fc" id="L65">                    dtos = dtos.append(ImmutablePatientIdentifierDTO.builder()</span>
<span class="fc" id="L66">                            .idValue(idValue).build());</span>
<span class="nc" id="L67">                } catch (IllegalArgumentException ignored) {</span>
<span class="nc" id="L68">                    return invalid(errorFrom(format(&quot;The [valueIdentifier.value] '%s' is not a UUID&quot;, identifier.getValue()), INVALID));</span>
<span class="fc" id="L69">                }</span>
            } else {
<span class="fc" id="L71">                Validation&lt;Issues, PatientIdentifierDTO&gt; dtoValidation = validateNationalIdParameter(parameterComponent);</span>
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">                if (dtoValidation.isInvalid()) {</span>
<span class="nc" id="L73">                    return invalid(dtoValidation.getError());</span>
                }
<span class="fc" id="L75">                dtos = dtos.append(dtoValidation.get());</span>
            }

<span class="fc" id="L78">        }</span>
<span class="fc" id="L79">        return valid(dtos);</span>
    }

    private Validation&lt;Issues, List&lt;ValidNationalId&gt;&gt; getPatientNationalIdentifierDTOs(@NotNull Parameters parameters) {
<span class="fc" id="L83">        List&lt;ValidNationalId&gt; identifierDTOValidations = List();</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">        for (Parameters.ParametersParameterComponent parameterComponent : parameters.getParameter()) {</span>
<span class="fc" id="L85">            Validation&lt;Issues, PatientIdentifierDTO&gt; dtoValidation = validateNationalIdParameter(parameterComponent);</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">            if (dtoValidation.isInvalid()) {</span>
<span class="fc" id="L87">                return invalid(dtoValidation.getError());</span>
            }
<span class="fc" id="L89">            identifierDTOValidations = identifierDTOValidations.append(dtoValidation.get().getValidNationalId().get());</span>
<span class="fc" id="L90">        }</span>
<span class="fc" id="L91">        return valid(identifierDTOValidations);</span>
    }

    @NotNull
    private Issues validateInput(@NotNull Parameters parameters, int parametersLimit) {
<span class="fc bfc" id="L96" title="All 2 branches covered.">        if (parameters.getParameter().isEmpty()) {</span>
<span class="fc" id="L97">            return errorFrom(&quot;The [parameter] parameter can not be empty&quot;, REQUIRED);</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">        } else if (parameters.getParameter().size() &gt; parametersLimit) {</span>
<span class="fc" id="L99">            return errorFrom(format(&quot;Maximum limit of '%s' parameters reached&quot;, parametersLimit), TOOCOSTLY);</span>
        } else {
<span class="fc" id="L101">            return Issues.empty();</span>
        }
    }

    private Validation&lt;Issues, PatientIdentifierDTO&gt; convertToPatientNationalIdentifierDTO(Identifier identifier) {
<span class="fc" id="L106">        Option&lt;NationalIdType&gt; maybeNationalIdType = fhirCodeSystemToNationalIdTypeMapper.toNationalIdType(identifier.getSystem());</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        if (maybeNationalIdType.isEmpty()) {</span>
<span class="nc" id="L108">            return invalid(errorFrom(format(&quot;The [valueIdentifier.system] '%s' is not supported&quot;, identifier.getSystem()), NOTSUPPORTED));</span>
        }
<span class="fc" id="L110">        return maybeNationalIdType.flatMap(nationalIdType -&gt; Option.ofOptional(nationalIdType.getValidNationalIdAndType(identifier.getValue())))</span>
<span class="fc" id="L111">                .map(validNationalId -&gt; Validation.&lt;Issues, PatientIdentifierDTO&gt;valid(ImmutablePatientIdentifierDTO.builder()</span>
<span class="fc" id="L112">                        .validNationalId(validNationalId)</span>
<span class="fc" id="L113">                        .build()))</span>
<span class="fc" id="L114">                .getOrElse(invalid(errorFrom(format(&quot;The '%s' is not a valid [valueIdentifier.system] '%s' identifier&quot;, identifier.getValue(), identifier.getSystem()), INVALID)));</span>
    }

    private Validation&lt;Issues, PatientIdentifierDTO&gt; validateNationalIdParameter(Parameters.ParametersParameterComponent parameterComponent) {
<span class="pc bpc" id="L118" title="1 of 4 branches missed.">        if (parameterComponent.getName() == null || !PATIENT_IDENTIFIER_PART_NAME.equals(parameterComponent.getName())) {</span>
<span class="fc" id="L119">            return invalid(errorFrom(format(&quot;The [parameter] part needs to have [name] %s&quot;, PATIENT_IDENTIFIER_PART_NAME), REQUIRED));</span>
        }
<span class="fc" id="L121">        return Match(parameterComponent.getValue()).of(</span>
<span class="fc" id="L122">                Case($(instanceOf(Identifier.class)), identifier -&gt; {</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">                    if (isBlank(identifier.getSystem())) {</span>
<span class="nc" id="L124">                        return invalid(errorFrom(&quot;The [valueIdentifier.system] can not be empty&quot;, REQUIRED));</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">                    } else if (isBlank(identifier.getValue())) {</span>
<span class="nc" id="L126">                        return invalid(errorFrom(&quot;The [valueIdentifier.value] can not be empty&quot;, REQUIRED));</span>
                    }
<span class="fc" id="L128">                    return convertToPatientNationalIdentifierDTO(identifier);</span>
                }),
<span class="pc" id="L130">                Case($(), () -&gt; invalid(errorFrom(&quot;The [parameter] part needs to be [valueIdentifier] type&quot;, REQUIRED))));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>