<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DetectDifferences.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.messagehasher</a> &gt; <span class="el_source">DetectDifferences.java</span></div><h1>DetectDifferences.java</h1><pre class="source lang-java linenums">package com.pkb.messagehasher;

import com.google.common.collect.ImmutableMap;
import com.pkb.crypto.dto.AccountKeysDTO;
import com.pkb.messagehasher.kmsclient.KmsClientHelper;
import com.pkb.messagehasher.repository.MessageRepository;
import org.apache.commons.text.similarity.LevenshteinDistance;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.UUID;
import java.util.function.Function;
import java.util.stream.Collectors;

@Service
<span class="nc" id="L21">public class DetectDifferences {</span>
<span class="nc" id="L22">    static Map&lt;String, ImmutableMap&lt;String, Long&gt;&gt; UNIQUE_ID_TO_PUBLIC_ACCOUNT_ID_AND_MESSAGE_ID = new ImmutableMap.Builder&lt;String, ImmutableMap&lt;String, Long&gt;&gt;()</span>
<span class="nc" id="L23">            .put(&quot;0a6442f8-42b6-42d4-9951-987677f31c6d&quot;,</span>
<span class="nc" id="L24">                    ImmutableMap.of(</span>
<span class="nc" id="L25">                            &quot;ceeb8249-fc4c-4b1d-8c80-4b8eaa106f88&quot;, 271991446L,</span>
<span class="nc" id="L26">                            &quot;51f038d9-8388-44fa-a20f-b94d77876448&quot;, 271991472L</span>
                    )
            )
<span class="nc" id="L29">            .put(&quot;14c00a3e-37de-4791-897e-7ee93a88ecee&quot;,</span>
<span class="nc" id="L30">                    ImmutableMap.of(</span>
<span class="nc" id="L31">                            &quot;9eb730d2-240f-4969-bda1-9e35e5325c2a&quot;, 264952240L,</span>
<span class="nc" id="L32">                            &quot;47b759a0-6f85-47e8-a392-8df8a5b93c05&quot;, 264952237L</span>
                    )
            )
<span class="nc" id="L35">            .put(&quot;162f11ee-f194-4c63-bc80-94dd90afeda5&quot;,</span>
<span class="nc" id="L36">                    ImmutableMap.of(</span>
<span class="nc" id="L37">                            &quot;c79bcc7e-999b-428a-b52f-1ccff57aab47&quot;, 236001062L,</span>
<span class="nc" id="L38">                            &quot;542542c4-e099-4b0b-abba-e166614b1f76&quot;, 236001071L</span>
                    )
            )
<span class="nc" id="L41">            .put(&quot;16317745-bbde-4611-8a13-3a61e6a66d3f&quot;,</span>
<span class="nc" id="L42">                    ImmutableMap.of(</span>
<span class="nc" id="L43">                            &quot;7ca83c65-cc3d-4c64-8632-583fbb9e8979&quot;, 276255345L,</span>
<span class="nc" id="L44">                            &quot;5e94ae37-78f5-46a3-adac-475e2e073cad&quot;, 276255344L</span>
                    )
            )
<span class="nc" id="L47">            .put(&quot;1df03070-00be-432f-b9a2-991e7adb937a&quot;,</span>
<span class="nc" id="L48">                    ImmutableMap.of(</span>
<span class="nc" id="L49">                            &quot;a6bf77c8-bb03-4632-9362-14f2a6565c07&quot;, 267959070L,</span>
<span class="nc" id="L50">                            &quot;6da30c98-4c53-4659-97b0-a7f6d7589256&quot;, 267932863L</span>
                    )
            )
<span class="nc" id="L53">            .put(&quot;1faaf89e-156c-43ca-8714-26ea75c1908a&quot;,</span>
<span class="nc" id="L54">                    ImmutableMap.of(</span>
<span class="nc" id="L55">                            &quot;c43a755f-8bea-4f12-958d-ca700fa9dbc8&quot;, 274399707L,</span>
<span class="nc" id="L56">                            &quot;1faaf89e-156c-43ca-8714-26ea75c1908a&quot;, 274733272L</span>
                    )
            )
<span class="nc" id="L59">            .put(&quot;20ace971-c0a9-410e-b50d-0db45fde4ef3&quot;,</span>
<span class="nc" id="L60">                    ImmutableMap.of(</span>
<span class="nc" id="L61">                            &quot;abd888bf-8806-4824-bf18-86c42f428673&quot;, 252599949L,</span>
<span class="nc" id="L62">                            &quot;c44f61ea-9f64-4472-895d-4cd47fbf5eae&quot;, 252599367L</span>
                    )
            )
<span class="nc" id="L65">            .put(&quot;2190f637-b517-45b8-9b67-385e186aed7f&quot;,</span>
<span class="nc" id="L66">                    ImmutableMap.of(</span>
<span class="nc" id="L67">                            &quot;2d55d507-d4e0-4a4a-adfe-ab0bb6dadb85&quot;, 261463119L,</span>
<span class="nc" id="L68">                            &quot;1ad8bed4-5996-4bb9-ba9d-590618949b9e&quot;, 261463119L</span>
                    )
            )
<span class="nc" id="L71">            .put(&quot;25f6b918-b91b-40bb-8e7c-1436cf76fcf7&quot;,</span>
<span class="nc" id="L72">                    ImmutableMap.of(</span>
<span class="nc" id="L73">                            &quot;7f4939d5-4348-4deb-b1c8-14f3a07ce9aa&quot;, 242153157L,</span>
<span class="nc" id="L74">                            &quot;4ff73361-4d5b-4a71-acb2-65468fb0a049&quot;, 242153159L</span>
                    )
            )
<span class="nc" id="L77">            .put(&quot;4d192430-848d-493e-a9a6-0d5cede16a2c&quot;,</span>
<span class="nc" id="L78">                    ImmutableMap.of(</span>
<span class="nc" id="L79">                            &quot;52080824-7919-4451-9382-87e130f61509&quot;, 223312452L,</span>
<span class="nc" id="L80">                            &quot;8715ddec-ab4d-4d32-96d5-97deea2fb60f&quot;, 223312454L</span>
                    )
            )
<span class="nc" id="L83">            .build();</span>

<span class="nc" id="L85">    static Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    @Autowired
    KmsClientHelper kmsClientHelper;

    @Autowired
    MessageRepository messageRepository;

    @Autowired
    MessageProcessor messageProcessor;

    void checkDifferencesBetweenHardcodedMessages() {
        try {
<span class="nc" id="L98">            UNIQUE_ID_TO_PUBLIC_ACCOUNT_ID_AND_MESSAGE_ID.forEach((uniqueId, accountPublicIdToMessageId) -&gt; {</span>
                try {
<span class="nc" id="L100">                    Map&lt;Long, AccountKeysDTO&gt; messageIdToAccountKeys = getAccountKeysDTOs(accountPublicIdToMessageId);</span>

                    //only check differences if we have both keys
<span class="nc bnc" id="L103" title="All 2 branches missed.">                    if (messageIdToAccountKeys.entrySet().size() == 2) {</span>
<span class="nc" id="L104">                        calculateLevenshteinMessageDifference(accountPublicIdToMessageId, messageIdToAccountKeys);</span>
                    }
<span class="nc" id="L106">                } catch (Exception e) {</span>
<span class="nc" id="L107">                    LOGGER.error(&quot;DetectDifferences: Unexpected error processing messages for uniqueId {}&quot;, uniqueId, e);</span>
<span class="nc" id="L108">                }</span>
<span class="nc" id="L109">            });</span>
<span class="nc" id="L110">        } catch (Exception e) {</span>
<span class="nc" id="L111">            LOGGER.error(&quot;DetectDifferences: Unexpected error checking differences&quot;, e);</span>
<span class="nc" id="L112">        }</span>
<span class="nc" id="L113">    }</span>

    private void calculateLevenshteinMessageDifference(ImmutableMap&lt;String, Long&gt; accountPublicIdToMessageId, Map&lt;Long, AccountKeysDTO&gt; messageIdToAccountKeys) {
<span class="nc" id="L116">        List&lt;Message&gt; messages = messageRepository.getSpecificMessagesToProcess(accountPublicIdToMessageId.values());</span>

<span class="nc" id="L118">        Message message1 = messages.get(0);</span>
<span class="nc" id="L119">        Message message2 = messages.get(1);</span>
<span class="nc" id="L120">        Optional&lt;String&gt; maybeContent1 = messageProcessor.getContentWithMigration(message1, messageIdToAccountKeys.get(message1.getId()));</span>
<span class="nc" id="L121">        Optional&lt;String&gt; maybeContent2 = messageProcessor.getContentWithMigration(message2, messageIdToAccountKeys.get(message2.getId()));</span>

<span class="nc bnc" id="L123" title="All 4 branches missed.">        if (maybeContent1.isPresent() &amp;&amp; maybeContent2.isPresent()) {</span>
<span class="nc" id="L124">            String content1 = maybeContent1.get();</span>
<span class="nc" id="L125">            String content2 = maybeContent2.get();</span>
<span class="nc" id="L126">            Integer difference = LevenshteinDistance.getDefaultInstance().apply(content1, content2);</span>

            //also, if one message is longer than the other, try running it through the migration process.
<span class="nc" id="L129">            Optional&lt;Integer&gt; differencePostMigration = attemptMigrationForDifferentLengths(messageIdToAccountKeys, message1, message2, content1, content2);</span>

<span class="nc" id="L131">            LOGGER.debug(&quot;DetectDifferences: message {} length {} message {} length {} difference {} postMigration {}&quot;, message1.getId(), content1.length(), message2.getId(), content2.length(), difference, differencePostMigration);</span>
<span class="nc" id="L132">            return;</span>
        }

<span class="nc" id="L135">        LOGGER.debug(&quot;DetectDifferences: IsPresent for message {} = {} and message {} = {}&quot;, message1.getId(), maybeContent1.isPresent(), message2.getId(), maybeContent2.isPresent());</span>
<span class="nc" id="L136">    }</span>

    private Optional&lt;Integer&gt; attemptMigrationForDifferentLengths(Map&lt;Long, AccountKeysDTO&gt; messageIdToAccountKeys, Message message1, Message message2, String content1, String content2) {
<span class="nc bnc" id="L139" title="All 2 branches missed.">        if (content1.length() != content2.length())</span>
        {
<span class="nc" id="L141">            Message longestMessage = message1;</span>
<span class="nc" id="L142">            String shortestContent = content2;</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (content2.length() &gt; content1.length()) {</span>
<span class="nc" id="L144">                longestMessage = message2;</span>
<span class="nc" id="L145">                shortestContent = content1;</span>
            }

<span class="nc" id="L148">            Message preMigration = new PreMigrationMessage(longestMessage);</span>
<span class="nc" id="L149">            AccountKeysDTO accountKeys = messageIdToAccountKeys.get(preMigration.getId());</span>
<span class="nc" id="L150">            String contentWithMigration = messageProcessor.getContentWithMigration(preMigration, accountKeys).orElseThrow(RuntimeException::new);</span>

<span class="nc" id="L152">            return Optional.of(LevenshteinDistance.getDefaultInstance().apply(contentWithMigration, shortestContent));</span>
        }
<span class="nc" id="L154">        return Optional.empty();</span>
    }

    private Map&lt;Long, AccountKeysDTO&gt; getAccountKeysDTOs(ImmutableMap&lt;String, Long&gt; accountPublicIdToMessageId) {
<span class="nc" id="L158">        return accountPublicIdToMessageId.keySet().stream()</span>
<span class="nc" id="L159">                .map(publicAccountId -&gt; kmsClientHelper.getAccountKeys(UUID.fromString(publicAccountId)))</span>
<span class="nc" id="L160">                .flatMap(Optional::stream)</span>
<span class="nc" id="L161">                .collect(Collectors.toMap(accountKeysDTO -&gt; accountPublicIdToMessageId.get(accountKeysDTO.getAccountPublicId().toString()), Function.identity()));</span>
    }

    private static class PreMigrationMessage implements Message {

        private Message message;

<span class="nc" id="L168">        PreMigrationMessage(Message message) {</span>
<span class="nc" id="L169">            this.message = message;</span>
<span class="nc" id="L170">        }</span>

        @Override
        public Long getId() {
<span class="nc" id="L174">            return message.getId();</span>
        }

        @Override
        public int getMigrationVersion() {
<span class="nc" id="L179">            return 0;</span>
        }

        @Override
        public String getSecretKeyAlgorithm() {
<span class="nc" id="L184">            return message.getSecretKeyAlgorithm();</span>
        }

        @Override
        public Long getSymmetricEncryptionKeyId() {
<span class="nc" id="L189">            return message.getSymmetricEncryptionKeyId();</span>
        }

        @Override
        public String getNonceBase64() {
<span class="nc" id="L194">            return message.getNonceBase64();</span>
        }

        @Override
        public byte[] getEncryptedData() {
<span class="nc" id="L199">            return message.getEncryptedData();</span>
        }

        @Override
        public byte[] getSecretKeyInline() {
<span class="nc" id="L204">            return message.getSecretKeyInline();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>