<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlanExportFacade.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.phplan.export.facade</a> &gt; <span class="el_source">PlanExportFacade.java</span></div><h1>PlanExportFacade.java</h1><pre class="source lang-java linenums">package com.pkb.service.phplan.export.facade;

import com.google.common.collect.ImmutableMap;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.datamodel.Email;
import com.pkb.entities.enums.SponsorshipStatus;
import com.pkb.entities.enums.UserType;
import com.pkb.exception.MailException;
import com.pkb.exception.PKBException;
import com.pkb.institute.entity.Team;
import com.pkb.phplan.entity.PHPlan;
import com.pkb.phplan.entity.PHPlanTemplate;
import com.pkb.phplan.entity.TemplateMetric;
import com.pkb.service.ehrrequestcontext.EHRRequestContextManager;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.phplan.PlanExportManager;
import com.pkb.service.phplan.PlanManager;
import com.pkb.service.phplan.PlanTemplateManager;
import com.pkb.service.phplan.export.ExportPlanRequestData;
import com.pkb.service.phplan.export.ExportablePatientPlan;
import com.pkb.service.phplan.export.ExportablePatientPlans;
import com.pkb.service.phplan.export.ExportablePlanTemplateMetrics;
import com.pkb.service.phplan.export.HistoricalExportablePatientPlan;
import com.pkb.service.phplan.export.LatestExportablePatientPlan;
import com.pkb.service.phplan.export.TemplateMetricsFilter;
import com.pkb.service.symptom.SymptomReportManager;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.test.LoincManager;
import com.pkb.service.test.MeasurementManager;
import com.pkb.service.test.TestManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.symptom.entity.SymptomReportDTO;
import com.pkb.symptom.entity.SymptomReportHistoryDTO;
import com.pkb.test.IncludeDeletedResults;
import com.pkb.test.entity.LoincTest;
import com.pkb.test.entity.MeasurementDTO;
import com.pkb.test.entity.MeasurementHistoryDTO;
import com.pkb.test.entity.MeasurementTypeId;
import com.pkb.test.entity.PredefinedMeasurementType;
import com.pkb.test.entity.TestHistoryDTO;
import com.pkb.test.entity.TestResultDTO;
import com.pkb.user.entity.NationalId;
import com.pkb.user.entity.OrgLevelId;
import com.pkb.user.entity.OrgLevelIdType;
import com.pkb.user.entity.PKBPerson;
import io.vavr.Tuple;
import io.vavr.control.Either;
import io.vavr.control.Option;
import org.apache.commons.lang3.StringUtils;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.io.StringWriter;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.SortedSet;
import java.util.stream.Collectors;

import static com.pkb.phplan.entity.TemplateMetric.MetricType.LAB_TEST;
import static com.pkb.phplan.entity.TemplateMetric.MetricType.MEASUREMENT;
import static com.pkb.phplan.entity.TemplateMetric.MetricType.SYMPTOM;
import static com.pkb.service.phplan.PlanExportManager.PLAN_EXPORT_LIMIT;
import static com.pkb.test.IncludeDeletedResults.EXCLUDE_DELETED;
import static java.util.Collections.emptyList;
import static org.apache.commons.collections4.CollectionUtils.isEmpty;

/**
 * Responsible for orchstrating business logic (implemented by services, which are named *Manager in the project).
 * &lt;p&gt;
 * This facade is a (feature) facade so that represents an entry point to features, providing a transparent interface to complex behavior.
 * &lt;p&gt;
 * Feature facades should not call other feature facades.
 */
@Component
<span class="fc" id="L87">public class PlanExportFacade {</span>
<span class="fc" id="L88">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    @Autowired
    private PlanExportManager planExportManager;
    @Autowired
    private TeamUserManager teamUserManager;
    @Autowired
    private UserManager userManager;
    @Autowired
    private TeamManager teamManager;
    @Autowired
    private EHRRequestContextManager requestContextManager;
    @Autowired
    private PlanManager planManager;
    @Autowired
    private SymptomReportManager symptomReportManager;
    @Autowired
    private MeasurementManager measurementManager;
    @Autowired
    private TestManager testManager;
    @Autowired
    private TemplateMetricsFilter templateMetricsFilter;
    @Autowired
    private PlanTemplateManager planTemplateManager;
    @Autowired
    private PKBEmailMessageManager emailMessageManager;
    @Autowired
    private DateTimeService dateTimeService;
    @Autowired
    private LoincManager loincManager;

    private static Map&lt;Long, LoincTest&gt; loincTestMap;

    public ExportablePatientPlans exportPlans(ExportPlanRequestData exportPlanRequestData) {
<span class="fc" id="L122">        List&lt;Long&gt; patientIds = collectInstituteUsers(exportPlanRequestData);</span>
<span class="fc" id="L123">        List&lt;PKBPerson&gt; pkbPersonList = getPkbPersonList(patientIds, PKBPerson.Lazy.NATIONAL_AND_LOCAL_IDS);</span>
<span class="fc" id="L124">        Team patientsTeam = getTeam(exportPlanRequestData.teamId());</span>
<span class="fc" id="L125">        ExportablePatientPlans result = collectExportablePatientPlans(exportPlanRequestData, pkbPersonList, patientsTeam);</span>
<span class="fc" id="L126">        debugLog(exportPlanRequestData.loggedInUser().findEmail().map(Email::address).getOrNull(),</span>
<span class="fc" id="L127">                String.format(&quot;export: (all=%b) %d total plans collected&quot;, exportPlanRequestData.exportAll(), result.getPlans().size()));</span>
<span class="fc" id="L128">        return result;</span>
    }

    @Nullable
    private Team getTeam(Long teamId) {
<span class="fc" id="L133">        return teamManager.getTeam(teamId);</span>
    }

    private List&lt;PKBPerson&gt; getPkbPersonList(List&lt;Long&gt; patientIds, PKBPerson.Lazy... fields) {
<span class="fc" id="L137">        return userManager.getPKBPersonList(patientIds, fields);</span>
    }

    @NotNull
    private List&lt;Long&gt; collectInstituteUsers(ExportPlanRequestData exportPlanRequestData) {
<span class="fc" id="L142">        return teamUserManager.getInstituteUsersByType(exportPlanRequestData.teamId(), UserType.PATIENT, 0, 0)</span>
<span class="fc" id="L143">                .stream()</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">                .filter(instituteUser -&gt; instituteUser.getSponsorshipStatus() != SponsorshipStatus.INVITED)</span>
<span class="fc" id="L145">                .map(instituteUser -&gt; instituteUser.getPerson().getId())</span>
<span class="fc" id="L146">                .collect(Collectors.toList());</span>
    }

    private ExportablePatientPlans collectExportablePatientPlans(ExportPlanRequestData exportPlanRequestData, List&lt;PKBPerson&gt; pkbPersonList, Team patientsTeam) {
<span class="fc" id="L150">        long inaccessiblePatientCount = 0L;</span>
<span class="fc" id="L151">        List&lt;ExportablePatientPlan&gt; exportablePatientPlans = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L152">        long totalPlans = 0L;</span>
<span class="fc" id="L153">        Iterator&lt;PKBPerson&gt; patientIterator = pkbPersonList.iterator();</span>
<span class="pc bpc" id="L154" title="1 of 4 branches missed.">        while (patientIterator.hasNext() &amp;&amp; totalPlans &lt; PLAN_EXPORT_LIMIT) {</span>
<span class="fc" id="L155">            PKBPerson patient = patientIterator.next();</span>
<span class="fc" id="L156">            Either&lt;Exception, List&lt;PHPlan&gt;&gt; eitherPatientPlan = collectPatientPlansFromTemplate(exportPlanRequestData, patient, patientsTeam);</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">            if (eitherPatientPlan.isRight()) {</span>
<span class="fc" id="L158">                List&lt;PHPlan&gt; patientPlans = eitherPatientPlan.get();</span>
<span class="fc" id="L159">                totalPlans += patientPlans.size();</span>
<span class="fc" id="L160">                exportablePatientPlans.addAll(createExportablePatientPlans(exportPlanRequestData, patientsTeam, patient, patientPlans));</span>

<span class="fc" id="L162">            } else {</span>
<span class="nc" id="L163">                ++inaccessiblePatientCount;</span>
            }
<span class="fc" id="L165">        }</span>
<span class="fc" id="L166">        ExportablePatientPlans result = new ExportablePatientPlans();</span>
<span class="fc" id="L167">        result.setPlans(exportablePatientPlans);</span>
<span class="fc" id="L168">        result.setInaccessiblePatientCount(inaccessiblePatientCount);</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        result.setPlanLimitExceeded(totalPlans &gt;= PLAN_EXPORT_LIMIT);</span>
<span class="fc" id="L170">        result.setLoincTestMap(collectLoincTestMap());</span>
<span class="fc" id="L171">        result.setTemplate(getPlanTemplate(exportPlanRequestData.templateId()).orElse(null));</span>
<span class="fc" id="L172">        result.setTemplateMetrics(createExportablePlanTemplateMetrics(templateMetricsFilter.filterTemplateMetrics(result.getTemplate().getMetrics())));</span>
<span class="fc" id="L173">        result.setTeam(patientsTeam);</span>
<span class="fc" id="L174">        result.setExportDate(dateTimeService.now());</span>

<span class="pc bpc" id="L176" title="1 of 2 branches missed.">        if (result.isPlanLimitExceeded()) {</span>
<span class="nc" id="L177">            debugLog(exportPlanRequestData.loggedInUser().findEmail().map(Email::address).getOrNull(), String.format(</span>
                    &quot;export: (all=%b) %d total plans exceeded limit %d while processing nationalId %s&quot;,
<span class="nc" id="L179">                    exportPlanRequestData.exportAll(), totalPlans, PLAN_EXPORT_LIMIT, exportablePatientPlans.get(exportablePatientPlans.size() - 1).getTargetPatientNationalId()));</span>
        }
<span class="fc" id="L181">        return result;</span>
    }

    private Optional&lt;PHPlanTemplate&gt; getPlanTemplate(Long templateId) {
<span class="fc" id="L185">        return planTemplateManager.getPHPlanTemplateOldStyleWithFieldsAndMetrics(templateId);</span>
    }

    private List&lt;ExportablePatientPlan&gt; createExportablePatientPlans(ExportPlanRequestData exportPlanRequestData, Team patientsTeam, PKBPerson patient, List&lt;PHPlan&gt; patientPlans) {
        List&lt;ExportablePatientPlan&gt; result;
<span class="fc bfc" id="L190" title="All 2 branches covered.">        if (patientPlans.isEmpty()) {</span>
<span class="fc" id="L191">            result = emptyList();</span>
        } else {
<span class="fc" id="L193">            result = new ArrayList&lt;&gt;(patientPlans</span>
<span class="fc" id="L194">                    .stream()</span>
<span class="fc" id="L195">                    .map(plan -&gt; createExportablePatientPlan(exportPlanRequestData, patient, plan, patientsTeam)).collect(Collectors.toList()));</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">            if (exportPlanRequestData.exportAll()) {</span>
                // for some reason we fill metrics only for the first plan but we will dump it once after written all plan fields
<span class="fc" id="L198">                augmentHistoricalTemplateMetrics(exportPlanRequestData, getLastListElement(result), patientPlans.get(0));</span>
            }
<span class="fc" id="L200">            debugLog(exportPlanRequestData.loggedInUser().findEmail().map(Email::address).getOrNull(),</span>
<span class="fc" id="L201">                    String.format(&quot;export: (all=%b) %d plans for nationalId %s&quot;, exportPlanRequestData.exportAll(), patientPlans.size(), getPatientNationalId(patientsTeam, patient)));</span>
        }
<span class="fc" id="L203">        return result;</span>
    }

    private ExportablePlanTemplateMetrics createExportablePlanTemplateMetrics(ImmutableMap&lt;TemplateMetric.MetricType, List&lt;Long&gt;&gt; metricsMap) {
<span class="fc" id="L207">        var filteredTemplateMetrics = metricsMap.get(MEASUREMENT);</span>
<span class="fc" id="L208">        return new ExportablePlanTemplateMetrics(</span>
<span class="fc" id="L209">                metricsMap.get(SYMPTOM),</span>
<span class="fc" id="L210">                expandDerivedMeasurements(filteredTemplateMetrics),</span>
<span class="fc" id="L211">                metricsMap.get(LAB_TEST));</span>
    }

    private void augmentHistoricalTemplateMetrics(ExportPlanRequestData exportPlanRequestData, ExportablePatientPlan exportablePatientPlan, PHPlan plan) {
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">        if (exportablePatientPlan instanceof HistoricalExportablePatientPlan) {</span>
<span class="fc" id="L216">            ImmutableMap&lt;TemplateMetric.MetricType, List&lt;Long&gt;&gt; metricsMap = templateMetricsFilter.filterTemplateMetrics(plan.getMetrics());</span>
<span class="fc" id="L217">            HistoricalExportablePatientPlan historicalExportablePatientPlan = (HistoricalExportablePatientPlan) exportablePatientPlan;</span>

<span class="fc" id="L219">            historicalExportablePatientPlan.setSymptomHistories(collectSymptomReportHistory(exportPlanRequestData, plan.getPatientId(), metricsMap));</span>
<span class="fc" id="L220">            historicalExportablePatientPlan.setSymptomIdDataEntererMapping(mapSymptomIdEnterer(historicalExportablePatientPlan.getSymptomHistories()));</span>

<span class="fc" id="L222">            historicalExportablePatientPlan.setMeasurementHistories(collectMeasurementsHistory(exportPlanRequestData, plan.getPatientId(), metricsMap));</span>
<span class="fc" id="L223">            historicalExportablePatientPlan.setTestHistories(collectTestHistory(exportPlanRequestData, plan.getPatientId(), metricsMap));</span>
        }
<span class="fc" id="L225">    }</span>

    @NotNull
    private Map&lt;Long, PKBPerson&gt; mapSymptomIdEnterer(List&lt;SymptomReportHistoryDTO&gt; symptomHistories) {
<span class="fc" id="L229">        return symptomHistories</span>
<span class="fc" id="L230">                .stream()</span>
<span class="fc" id="L231">                .flatMap(symptomReportHistoryDTO -&gt; symptomReportHistoryDTO</span>
<span class="fc" id="L232">                        .getSymptomReportList()</span>
<span class="fc" id="L233">                        .stream()</span>
<span class="pc" id="L234">                        .map(symptomReport -&gt; Tuple.of(symptomReport.getId(), getPkbPerson(symptomReport.getDataEntererUid())))</span>
<span class="pc bnc" id="L235" title="All 2 branches missed.">                        .filter(symptomIdDataEntererMapping -&gt; symptomIdDataEntererMapping._2 != null))</span>
<span class="fc" id="L236">                .collect(Collectors.toMap(</span>
<span class="nc" id="L237">                        symptomIdDataEntererMapping -&gt; symptomIdDataEntererMapping._1,</span>
<span class="nc" id="L238">                        symptomIdDataEntererMapping -&gt; symptomIdDataEntererMapping._2));</span>
    }

    private &lt;T&gt; T getLastListElement(List&lt;T&gt; list) {
<span class="fc" id="L242">        return list.get(list.size() - 1);</span>
    }

    private ExportablePatientPlan createExportablePatientPlan(ExportPlanRequestData exportPlanRequestData, PKBPerson patient, PHPlan plan, Team team) {
        ExportablePatientPlan result;

<span class="fc bfc" id="L248" title="All 2 branches covered.">        if (exportPlanRequestData.exportAll()) {</span>
<span class="fc" id="L249">            result = new HistoricalExportablePatientPlan();</span>
        } else {
<span class="fc" id="L251">            LatestExportablePatientPlan exportablePatientPlan = new LatestExportablePatientPlan();</span>
<span class="fc" id="L252">            ImmutableMap&lt;TemplateMetric.MetricType, List&lt;Long&gt;&gt; metricsMap = templateMetricsFilter.filterTemplateMetrics(plan.getMetrics());</span>
<span class="fc" id="L253">            exportablePatientPlan.setSymptomReports(collectLatestSymptomReports(exportPlanRequestData, plan.getPatientId(), patient.getDefaultAccountId(), metricsMap));</span>
<span class="fc" id="L254">            exportablePatientPlan.setMeasurements(collectLatestMeasurements(exportPlanRequestData, plan.getPatientId(), metricsMap));</span>
<span class="fc" id="L255">            exportablePatientPlan.setTestResults(collectLatestTestResults(exportPlanRequestData, plan.getPatientId(), metricsMap));</span>
<span class="fc" id="L256">            result = exportablePatientPlan;</span>
        }

<span class="fc" id="L259">        result.setTargetPatient(patient);</span>
<span class="fc" id="L260">        result.setPlan(plan);</span>
<span class="fc" id="L261">        result.setPlanCreator(getPkbPerson(plan.getCreatorId()));</span>
<span class="fc" id="L262">        result.setTargetPatientNationalId(getPatientNationalId(team, patient));</span>
<span class="fc" id="L263">        result.setTargetPatientOrgLevelId(getPatientOlid(patient, team));</span>
<span class="fc" id="L264">        return result;</span>
    }

    private Map&lt;Long, LoincTest&gt; collectLoincTestMap() {
<span class="fc bfc" id="L268" title="All 2 branches covered.">        if (loincTestMap == null) {</span>
<span class="fc" id="L269">            loincTestMap = new HashMap&lt;&gt;();</span>
            try {
<span class="fc bfc" id="L271" title="All 2 branches covered.">                for (LoincTest loincTest : loincManager.getAllLoincTests()) {</span>
<span class="fc" id="L272">                    loincTestMap.put(loincTest.getId(), loincTest);</span>
<span class="fc" id="L273">                }</span>
<span class="nc" id="L274">            } catch (PKBException e) {</span>
<span class="nc" id="L275">                LOGGER.error(&quot;Exception while fetching loinc test map&quot;, e);</span>
<span class="fc" id="L276">            }</span>
        }
<span class="fc" id="L278">        return loincTestMap;</span>
    }

    private PKBPerson getPkbPerson(Long personId) {
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">        return personId == null ? null : userManager.getPKBPerson(personId);</span>
    }

    private OrgLevelId getPatientOlid(PKBPerson patient, Team team) {
<span class="fc" id="L286">        SortedSet&lt;OrgLevelId&gt; olids = patient.getOrgLevelIdsByOrg(team.getOrg().getId());</span>

<span class="fc" id="L288">        OrgLevelId olid = null;</span>

<span class="fc" id="L290">        Set&lt;OrgLevelIdType&gt; olidts = team.getOrg().getOrgLevelIdTypes();</span>
<span class="pc bpc" id="L291" title="1 of 4 branches missed.">        if ((olidts.size() == 1) &amp;&amp; !olids.isEmpty()) {</span>
<span class="fc" id="L292">            olid = olids.iterator().next();</span>
        } else {
            //TODO: Cannot safely output org level ID because we don't know
            // which one to use; leave as null
        }
<span class="fc" id="L297">        return olid;</span>
    }

    @NotNull
    private String getPatientNationalId(Team t, PKBPerson patient) {
<span class="fc" id="L302">        return patient.getNationalIdByCountry(t.getCountry())</span>
<span class="fc" id="L303">                .map(NationalId::getValue)</span>
<span class="fc" id="L304">                .orElse(&quot;&quot;);</span>
    }

    private Map&lt;Long, TestResultDTO&gt; collectLatestTestResults(ExportPlanRequestData exportPlanRequestData, Long patientId, ImmutableMap&lt;TemplateMetric.MetricType, List&lt;Long&gt;&gt; metricsMap) {
<span class="fc" id="L308">        return testManager.getLatestTestResults(exportPlanRequestData.requestContext(), patientId, metricsMap.get(LAB_TEST), IncludeDeletedResults.EXCLUDE_DELETED);</span>
    }

    private Map&lt;MeasurementTypeId, MeasurementDTO&gt; collectLatestMeasurements(ExportPlanRequestData exportPlanRequestData, Long patientId, ImmutableMap&lt;TemplateMetric.MetricType, List&lt;Long&gt;&gt; metricsMap) {
<span class="fc" id="L312">        return measurementManager.getLatestMeasurements(exportPlanRequestData.requestContext(), patientId,</span>
<span class="fc" id="L313">                io.vavr.collection.Stream.ofAll(expandDerivedMeasurements(metricsMap.get(MEASUREMENT))).flatMap(id -&gt; Option.of(PredefinedMeasurementType.getById(id))).toJavaList(),</span>
<span class="fc" id="L314">                exportPlanRequestData.loggedInUser());</span>
    }

    private Map&lt;Long, SymptomReportDTO&gt; collectLatestSymptomReports(ExportPlanRequestData exportPlanRequestData, long patientId, long patientAccountId, ImmutableMap&lt;TemplateMetric.MetricType, List&lt;Long&gt;&gt; metricsMap) {
<span class="fc" id="L318">        return symptomReportManager.getLatestSymptoms(exportPlanRequestData.requestContext(), metricsMap.get(SYMPTOM), patientId, patientAccountId);</span>
    }

    private List&lt;TestHistoryDTO&gt; collectTestHistory(ExportPlanRequestData exportPlanRequestData, Long patientId, ImmutableMap&lt;TemplateMetric.MetricType, List&lt;Long&gt;&gt; metricsMap) {
<span class="fc" id="L322">        List&lt;Long&gt; testIds = metricsMap.get(LAB_TEST);</span>
        List&lt;TestHistoryDTO&gt; result;
<span class="fc bfc" id="L324" title="All 2 branches covered.">        if (testIds.isEmpty()) {</span>
<span class="fc" id="L325">            result = emptyList();</span>
        } else {
<span class="fc" id="L327">            result = testManager.getTestHistoryList(exportPlanRequestData.requestContext(), patientId, testIds,</span>
                    null /*latestXmonths*/, EXCLUDE_DELETED);
        }
<span class="fc" id="L330">        result.sort(Comparator.comparing(testHistory -&gt; testHistory.getLoincTest().getLoinc()));</span>
<span class="fc" id="L331">        return result;</span>
    }

    private List&lt;SymptomReportHistoryDTO&gt; collectSymptomReportHistory(ExportPlanRequestData exportPlanRequestData, Long patientId, ImmutableMap&lt;TemplateMetric.MetricType, List&lt;Long&gt;&gt; metricsMap) {
<span class="fc" id="L335">        List&lt;Long&gt; symptomIds = metricsMap.get(SYMPTOM);</span>
<span class="fc bfc" id="L336" title="All 2 branches covered.">        if (isEmpty(symptomIds)) {</span>
<span class="fc" id="L337">            return emptyList();</span>
        }

<span class="fc" id="L340">        Long patientAccountId = userManager.getDefaultAccountId(patientId);</span>
<span class="fc" id="L341">        return symptomReportManager.getSymptomReportHistoryList(exportPlanRequestData.requestContext(), symptomIds, patientId, patientAccountId, null);</span>
    }

    private List&lt;MeasurementHistoryDTO&gt; collectMeasurementsHistory(ExportPlanRequestData exportPlanRequestData, Long patientId, ImmutableMap&lt;TemplateMetric.MetricType, List&lt;Long&gt;&gt; metricsMap) {
<span class="fc" id="L345">        List&lt;Long&gt; measurementTypeIds = expandDerivedMeasurements(metricsMap.get(MEASUREMENT));</span>
<span class="fc bfc" id="L346" title="All 2 branches covered.">        return measurementTypeIds.isEmpty() ?</span>
<span class="fc" id="L347">                emptyList() :</span>
<span class="fc" id="L348">                measurementManager.getMeasurementHistoryList(</span>
<span class="fc" id="L349">                        exportPlanRequestData.requestContext(),</span>
<span class="fc" id="L350">                        io.vavr.collection.Stream.ofAll(measurementTypeIds).map(MeasurementTypeId::ofPredefinedTypeId).toJavaList(),</span>
<span class="fc" id="L351">                        patientId, null, exportPlanRequestData.loggedInUser());</span>
    }

    private List&lt;Long&gt; expandDerivedMeasurements(List&lt;Long&gt; measurements) {
<span class="fc" id="L355">        List&lt;Long&gt; results = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L356" title="All 2 branches covered.">        for (Long mtId : measurements) {</span>
<span class="fc" id="L357">            results.add(mtId);</span>
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">            if (mtId == PredefinedMeasurementType.BMI.id().asInternalId().get()) {</span>
<span class="nc" id="L359">                addIfNotThere(results, PredefinedMeasurementType.HEIGHT.id().asInternalId().get());</span>
<span class="nc" id="L360">                addIfNotThere(results, PredefinedMeasurementType.WEIGHT.id().asInternalId().get());</span>
            }
<span class="fc" id="L362">        }</span>
<span class="fc" id="L363">        return results;</span>
    }

    private void addIfNotThere(List&lt;Long&gt; list, Long id) {
<span class="nc bnc" id="L367" title="All 2 branches missed.">        if (!list.contains(id)) {</span>
<span class="nc" id="L368">            list.add(id);</span>
        }
<span class="nc" id="L370">    }</span>

    private Either&lt;Exception, List&lt;PHPlan&gt;&gt; collectPatientPlansFromTemplate(ExportPlanRequestData exportPlanRequestData, PKBPerson patient, Team team) {
        try {
<span class="fc" id="L374">            boolean breakTheGlassActive = false;</span>
            // Create a new request context including the patient (the original one created with the request from the client doesn't have patient info)
<span class="fc" id="L376">            LoggedInEHRRequestContext newRequestContext = requestContextManager.createEHRRequestContextForTeamClinician(exportPlanRequestData.requestContext().getAccessingUser(), team,</span>
<span class="fc" id="L377">                    patient.getId(),</span>
<span class="fc" id="L378">                    exportPlanRequestData.requestContext().getCorrelationId(), exportPlanRequestData.requestContext().getAccessRoute(), breakTheGlassActive);</span>
<span class="fc" id="L379">            List&lt;PHPlan&gt; plans = planManager.getPHPlansFromTemplate(newRequestContext, patient.getId(), exportPlanRequestData.templateId(), true/*activeOnly*/, patient.getDefaultAccountId());</span>
<span class="fc" id="L380">            return Either.right(plans);</span>
<span class="nc" id="L381">        } catch (Exception e) {</span>
<span class="nc" id="L382">            LOGGER.error(&quot;Error for coord-{} exporting plans for patient-{}&quot;, exportPlanRequestData.loggedInUser().getId(), patient.getId(), e);</span>
<span class="nc" id="L383">            return Either.left(e);</span>
        }
    }

    private void debugLog(String email, String message) {
<span class="pc bpc" id="L388" title="1 of 2 branches missed.">        if (isTraceLoggingActive(email)) {</span>
<span class="nc" id="L389">            LOGGER.info(message);</span>
        }
<span class="fc" id="L391">    }</span>

    private boolean isTraceLoggingActive(String email) {
<span class="fc" id="L394">        return StringUtils.equalsIgnoreCase(&quot;prod.smoketest.coordinator@pkbtest.com&quot;, email);</span>
    }

    public void finalizeExport(ExportablePatientPlans exportablePatientPlans, ExportPlanRequestData exportPlanRequestData, StringWriter exportedContent) {
<span class="pc bpc" id="L398" title="1 of 2 branches missed.">        if (exportablePatientPlans.getPlans().isEmpty()) {</span>
            try {
<span class="nc" id="L400">                emailMessageManager.notifyCoordinatorNoPlansToExport(exportPlanRequestData.loggedInUser(), exportablePatientPlans.getTeam(),</span>
<span class="nc" id="L401">                        exportablePatientPlans.getTemplate(), exportablePatientPlans.getExportDate(),</span>
<span class="nc" id="L402">                        exportablePatientPlans.getInaccessiblePatientCount());</span>
<span class="nc" id="L403">            } catch (MailException e) {</span>
<span class="nc" id="L404">                LOGGER.error(&quot;Error while notifying coordiantor about no plans for export&quot;, e);</span>
<span class="nc" id="L405">            }</span>
        } else {
<span class="fc" id="L407">            planExportManager.savePlanExport(exportPlanRequestData, exportablePatientPlans, exportedContent.toString());</span>
<span class="fc" id="L408">            notifyPlanExportComplete(exportablePatientPlans, exportPlanRequestData);</span>
        }
<span class="fc" id="L410">        debugLog(exportPlanRequestData.loggedInUser().findEmail().map(Email::address).getOrNull(),</span>
<span class="fc" id="L411">                String.format(&quot;export: (all=%b) %d total plans DONE&quot;, exportPlanRequestData.exportAll(), exportablePatientPlans.getPlans().size()));</span>
<span class="fc" id="L412">    }</span>

    private void notifyPlanExportComplete(ExportablePatientPlans exportablePatientPlans, ExportPlanRequestData exportPlanRequestData) {
        try {

<span class="fc" id="L417">            emailMessageManager.notifyCoordinatorPlanExportComplete(exportPlanRequestData.loggedInUser(), exportablePatientPlans.getTeam(),</span>
<span class="fc" id="L418">                    exportablePatientPlans.getTemplate(), exportablePatientPlans.isPlanLimitExceeded(), exportablePatientPlans.getExportDate(),</span>
<span class="fc" id="L419">                    exportablePatientPlans.getInaccessiblePatientCount(), exportablePatientPlans.getTemplate());</span>
            PKBPerson clinician;
<span class="fc bfc" id="L421" title="All 2 branches covered.">            for (String clinicianId : exportPlanRequestData.selectedClinicians()) {</span>
<span class="fc" id="L422">                clinician = userManager.getPKBPerson(Long.parseLong(clinicianId));</span>
<span class="fc" id="L423">                emailMessageManager.notifyClinicianOfPlanExported(exportPlanRequestData.loggedInUser(), clinician,</span>
<span class="fc" id="L424">                        exportablePatientPlans.getTeam(),</span>
<span class="fc" id="L425">                        exportablePatientPlans.getTemplate(), exportablePatientPlans.getExportDate(), exportablePatientPlans.getTemplate());</span>
<span class="fc" id="L426">            }</span>
<span class="nc" id="L427">        } catch (MailException e) {</span>
<span class="nc" id="L428">            LOGGER.info(&quot;Error while notifying coordinator/clinician about plan export complete-&quot;, e);</span>
<span class="fc" id="L429">        }</span>
<span class="fc" id="L430">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>