<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Medication.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.medication.entity</a> &gt; <span class="el_source">Medication.java</span></div><h1>Medication.java</h1><pre class="source lang-java linenums">//---------------------------------------------------------------------------
//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: Medication.java 18 Nov 2010 14:40:36 Steve Gilbert$
//
//---------------------------------------------------------------------------

/**
 *
 */
package com.pkb.medication.entity;

import com.pkb.annotation.EHRField;
import com.pkb.annotation.EHRField.QueryField;
import com.pkb.annotation.EHRMigration;
import com.pkb.app.dto.DTOBaseFields;
import com.pkb.app.entity.SourceDetails;
import com.pkb.app.interfaces.DataPointWithStartAndEndDate;
import com.pkb.app.interfaces.EncryptedDataPoint;
import com.pkb.app.interfaces.IBaseDTO;
import com.pkb.coding.entity.CodeableConcept;
import com.pkb.document.entity.Attachment;
import com.pkb.entities.enums.MenuDataType;
import org.apache.commons.lang3.StringUtils;
import org.jetbrains.annotations.Nullable;

import java.time.Instant;
import java.util.Date;
import java.util.LinkedList;
import java.util.List;

import static com.pkb.annotation.EHRField.ValueDTOType.NESTED;

/**
 * This class hold a basic medication object corresponding to a prescription received by a patient
 */
@EHRMigration(migratorClass = MedicationMigrator.class)
public class Medication implements IBaseDTO, EncryptedDataPoint, DataPointWithStartAndEndDate {

    private static final long serialVersionUID = 2L;

<span class="fc" id="L43">    public static final MenuDataType MS_PATH = MenuDataType.medication;</span>

    public static final String MEDICATION = &quot;medication&quot;;

<span class="fc" id="L47">    public enum MedicationStatus {</span>
<span class="fc" id="L48">        ACTIVE, INACTIVE;</span>

        boolean isInactive() {
<span class="fc bfc" id="L51" title="All 2 branches covered.">            return this == INACTIVE;</span>
        }
    }

    // Id fields

    @EHRField(queryField = QueryField.id)
    private Long id;

    @EHRField(valueDtoType = NESTED)
    private CodeableConcept medication;

    @EHRField(queryField = QueryField.long01)
    private Long medicationCodingReceivedId;

    // HL7 fields in trim
    @EHRField(queryField = QueryField.ENCRYPTED)
    private String instructions;

    @EHRField(queryField = QueryField.ENCRYPTED)
    private Double doseValue;

    @EHRField(queryField = QueryField.ENCRYPTED)
    private CodeableConcept doseUnit;

    @EHRField(queryField = QueryField.ENCRYPTED)
    private Long doseUnitPkbId;

    @EHRField(queryField = QueryField.accountId)
    private Long patientAccountId;

    private String patientLdapUID; // not mapped into DB

    @EHRField(queryField = QueryField.ENCRYPTED)
    private Date orderDate;

    @EHRField(queryField = QueryField.ENCRYPTED)
    private Date startDate;

    @EHRField(queryField = QueryField.date02)
    private Date endDate;

    @EHRField(queryField = QueryField.ENCRYPTED)
    private String frequencyDisplayStr;

    @EHRField(queryField = QueryField.ENCRYPTED)
    private MedicationStatus status;

    // Placeholder for transferring attachments - stored separately
    private List&lt;Attachment&gt; attachments;

    private SourceDetails source;

<span class="fc" id="L104">    private DTOBaseFields baseFields = new DTOBaseFields();</span>

    @EHRField(queryField = QueryField.ENCRYPTED)
    private Long frequencyValue;

    @EHRField(queryField = QueryField.ENCRYPTED)
    private String frequencyUnit;

    @EHRField(queryField = QueryField.ENCRYPTED)
    private String frequencyPriorityCode;

    /**
     * This indicates whether the patient is taking the medication being defined by this {@code Medication}. Since it defaults to NULL, all
     * users MUST explicitly set this to {@code Boolean.TRUE} or {@code Boolean.FALSE} as appropriate if the data point exists.
     *
     * An example of when this might be false is if MiApp is explicitly recording that a patient is _not_ taking a given medication.
     *
     */
    @EHRField(queryField = QueryField.boolean01)
    private Boolean patientOnMedication;


    /**
     * DELIBERATELY PROTECTED DO NOT CHANGE! Use the available constructors!
     * &lt;p&gt;
     * Would have even less visibility but JPA spec &amp; Hibernate requires a no arg const. which is public or protected.
     * Other than those, nothing should be able to construct without parameters, as changelog wouldn't be filled correctly etc.
     */
<span class="fc" id="L132">    protected Medication() {</span>
<span class="fc" id="L133">        this.source = new SourceDetails();</span>
<span class="fc" id="L134">    }</span>

<span class="fc" id="L136">    public Medication(SourceDetails source) {</span>
<span class="fc" id="L137">        this.source = source;</span>
<span class="fc" id="L138">    }</span>

    @Override
    public CodeableConcept code() {
<span class="fc" id="L142">        return medication;</span>
    }

    @Nullable
    @Override
    public Instant startDate() {
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        return startDate == null ? null : startDate.toInstant();</span>
    }

    @Nullable
    @Override
    public Instant endDate() {
<span class="fc bfc" id="L154" title="All 2 branches covered.">        return endDate == null ? null : endDate.toInstant();</span>
    }

    @Override
    public MenuDataType getDataType() {
<span class="fc" id="L159">        return MS_PATH;</span>
    }

    // Access to fields
    @Override
    public Long getId() {
<span class="fc" id="L165">        return id;</span>
    }

    @Override
    public void setId(Long id) {
<span class="fc" id="L170">        this.id = id;</span>
<span class="fc" id="L171">    }</span>

    public String getInstructions() {
<span class="fc" id="L174">        return instructions;</span>
    }

    public void setInstructions(String instructions) {
<span class="fc" id="L178">        this.instructions = instructions;</span>
<span class="fc" id="L179">    }</span>

    public Long getDoseUnitPkbId() {
<span class="fc" id="L182">        return doseUnitPkbId;</span>
    }

    public void setDoseUnitPkbId(Long doseUnitPkbId) {
<span class="fc" id="L186">        this.doseUnitPkbId = doseUnitPkbId;</span>
<span class="fc" id="L187">    }</span>

    public Double getDoseValue() {
<span class="fc" id="L190">        return doseValue;</span>
    }

    public void setDoseValue(Double doseValue) {
<span class="fc" id="L194">        this.doseValue = doseValue;</span>
<span class="fc" id="L195">    }</span>

    @Override
    public Long getPatientAccountId() {
<span class="fc" id="L199">        return patientAccountId;</span>
    }

    public void setPatientAccountId(Long patientAccountId) {
<span class="fc" id="L203">        this.patientAccountId = patientAccountId;</span>
<span class="fc" id="L204">    }</span>

    public String getPatientLdapUID() {
<span class="fc" id="L207">        return patientLdapUID;</span>
    }

    public void setPatientLdapUID(String patientLdapUID) {
<span class="fc" id="L211">        this.patientLdapUID = patientLdapUID;</span>
<span class="fc" id="L212">    }</span>

    public void setPatientLdapUID(long patientId) {
<span class="fc" id="L215">        setPatientLdapUID(Long.toString(patientId));</span>
<span class="fc" id="L216">    }</span>

    public Date getOrderDate() {
<span class="fc" id="L219">        return orderDate;</span>
    }

    public void setOrderDate(Date orderDate) {
<span class="fc" id="L223">        this.orderDate = orderDate;</span>
<span class="fc" id="L224">    }</span>

    public Date getStartDate() {
<span class="fc" id="L227">        return startDate;</span>
    }

    public void setStartDate(Date startDate) {
<span class="fc" id="L231">        this.startDate = startDate;</span>
<span class="fc" id="L232">    }</span>

    public Date getEndDate() {
<span class="fc" id="L235">        return endDate;</span>
    }

    public void setEndDate(Date endDate) {
<span class="fc" id="L239">        this.endDate = endDate;</span>
<span class="fc" id="L240">    }</span>

    public void addAttachment(Attachment attachment) {
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (attachments == null) {</span>
<span class="nc" id="L244">            attachments = new LinkedList&lt;&gt;();</span>
        }
<span class="nc" id="L246">        attachments.add(attachment);</span>
<span class="nc" id="L247">    }</span>

    public void setAttachments(List&lt;Attachment&gt; attachments) {
<span class="fc" id="L250">        this.attachments = attachments;</span>
<span class="fc" id="L251">    }</span>

    public List&lt;Attachment&gt; getAttachments() {
<span class="fc bfc" id="L254" title="All 2 branches covered.">        if (attachments == null) {</span>
<span class="fc" id="L255">            attachments = new LinkedList&lt;&gt;();</span>
        }
<span class="fc" id="L257">        return attachments;</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L262">        return &quot;{id=&quot; + id + &quot;, patientAccountId=&quot; + patientAccountId</span>
                + &quot;, patientUid='&quot; + patientLdapUID //+ &quot;', status='&quot; + status
                + &quot;', orderDate=&quot; + orderDate + &quot;, startDate=&quot; + startDate
                + &quot;, endDate=&quot; + endDate + &quot;}&quot;;
    }

    @Nullable
    public PKBMedicationFrequency getFrequency() {
<span class="fc" id="L270">        CDAMedicationFrequency cdaFrequency = new CDAMedicationFrequency();</span>
<span class="fc bfc" id="L271" title="All 2 branches covered.">        if (StringUtils.isNotEmpty(getFrequencyPriorityCode())) {</span>
<span class="fc" id="L272">            cdaFrequency.setPriorityCode(HL7ActPriorityCode.getByCode(getFrequencyPriorityCode()));</span>
        } else {
<span class="fc" id="L274">            Long cdaFreqValue = getFrequencyValue();</span>
<span class="fc bfc" id="L275" title="All 2 branches covered.">            if (cdaFreqValue != null) {</span>
<span class="fc" id="L276">                cdaFrequency.setValue(cdaFreqValue);</span>
            } else {
<span class="fc" id="L278">                return null;</span>
            }
<span class="fc" id="L280">            String hl7UnitTime = getFrequencyUnit();</span>
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">            if (!StringUtils.isEmpty(hl7UnitTime)) {</span>
                //old records probably had code instead of enum strings
<span class="fc" id="L283">                HL7UnitOfTime unit = HL7UnitOfTime.getByCode(hl7UnitTime);</span>
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">                if (unit == null) {</span>
<span class="fc" id="L285">                    unit = HL7UnitOfTime.valueOf(hl7UnitTime); // else try to get the enum value</span>
                }
<span class="fc" id="L287">                cdaFrequency.setUnit(unit);</span>
            }
        }
<span class="fc" id="L290">        return PKBMedicationFrequency.fromCDAMedicationFrequency(cdaFrequency);</span>
    }

    public void setFrequency(PKBMedicationFrequency frequency) {
<span class="fc bfc" id="L294" title="All 2 branches covered.">        if (frequency != null) {</span>
<span class="fc" id="L295">            CDAMedicationFrequency cdaFrequency = frequency.toCDAMedicationFrequency();</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">            if (cdaFrequency.getPriorityCode() == null) {</span>
<span class="fc" id="L297">                setFrequencyValue(cdaFrequency.getValue());</span>
<span class="pc bpc" id="L298" title="1 of 2 branches missed.">                if (cdaFrequency.getUnit() != null) {</span>
<span class="fc" id="L299">                    setFrequencyUnit(cdaFrequency.getUnit().toString());</span>
                }
<span class="fc" id="L301">                setFrequencyPriorityCode(null);</span>
            } else {
<span class="fc" id="L303">                setFrequencyPriorityCode(cdaFrequency.getPriorityCode().getCode());</span>
            }
<span class="fc" id="L305">        } else {</span>
<span class="fc" id="L306">            setFrequencyValue(null);</span>
<span class="fc" id="L307">            setFrequencyPriorityCode(null);</span>
<span class="fc" id="L308">            setFrequencyUnit(null);</span>
        }
<span class="fc" id="L310">    }</span>

    public String getFrequencyDisplayStr() {
<span class="fc" id="L313">        return frequencyDisplayStr;</span>
    }

    public void setFrequencyDisplayStr(String frequencyDisplayStr) {
<span class="fc" id="L317">        this.frequencyDisplayStr = frequencyDisplayStr;</span>
<span class="fc" id="L318">    }</span>

    @Override
    public DTOBaseFields getBaseFields() {
<span class="fc" id="L322">        return baseFields;</span>
    }

    @Override
    public SourceDetails getSource() {
<span class="fc" id="L327">        return source;</span>
    }

    public Long getFrequencyValue() {
<span class="fc" id="L331">        return frequencyValue;</span>
    }

    public void setFrequencyValue(Long frequencyvalue) {
<span class="fc" id="L335">        this.frequencyValue = frequencyvalue;</span>
<span class="fc" id="L336">    }</span>

    public String getFrequencyUnit() {
<span class="fc" id="L339">        return frequencyUnit;</span>
    }

    public void setFrequencyUnit(String frequencyUnit) {
<span class="fc" id="L343">        this.frequencyUnit = frequencyUnit;</span>
<span class="fc" id="L344">    }</span>

    public String getFrequencyPriorityCode() {
<span class="fc" id="L347">        return frequencyPriorityCode;</span>
    }

    public void setFrequencyPriorityCode(String frequencyPriorityCode) {
<span class="fc" id="L351">        this.frequencyPriorityCode = frequencyPriorityCode;</span>
<span class="fc" id="L352">    }</span>

    public Boolean getPatientOnMedication() {
<span class="fc" id="L355">        return patientOnMedication;</span>
    }

    public void setPatientOnMedication(Boolean patientOnMedication) {
<span class="fc" id="L359">        this.patientOnMedication = patientOnMedication;</span>
<span class="fc" id="L360">    }</span>

    public MedicationStatus getStatus() {
<span class="fc" id="L363">        return status;</span>
    }

    public void setStatus(MedicationStatus status) {
<span class="fc" id="L367">        this.status = status;</span>
<span class="fc" id="L368">    }</span>

    public CodeableConcept getMedication() {
<span class="fc" id="L371">        return medication;</span>
    }

    public void setMedication(CodeableConcept medication) {
<span class="fc" id="L375">        this.medication = medication;</span>
<span class="fc" id="L376">    }</span>

    public Long getMedicationCodingReceivedId() {
<span class="fc" id="L379">        return medicationCodingReceivedId;</span>
    }

    public void setMedicationCodingReceivedId(Long medicationCodingReceivedId) {
<span class="fc" id="L383">        this.medicationCodingReceivedId = medicationCodingReceivedId;</span>
<span class="fc" id="L384">    }</span>

    public CodeableConcept getDoseUnit() {
<span class="fc" id="L387">        return doseUnit;</span>
    }

    public void setDoseUnit(CodeableConcept doseUnit) {
<span class="fc" id="L391">        this.doseUnit = doseUnit;</span>
<span class="fc" id="L392">    }</span>

    public String getDoseUnitKey() {
<span class="fc" id="L395">        return MedicationUnit.getTextKeyForId(doseUnitPkbId);</span>
    }

    public boolean isCurrent(Date today) {
<span class="fc bfc" id="L399" title="All 4 branches covered.">        boolean statusIsActive = !(getStatus() != null &amp;&amp; getStatus().isInactive());</span>
<span class="fc bfc" id="L400" title="All 4 branches covered.">        boolean dateIsCurrent = getEndDate() == null || getEndDate().after(today);</span>
<span class="fc bfc" id="L401" title="All 4 branches covered.">        return statusIsActive &amp;&amp; dateIsCurrent;</span>
    }

    public void setSource(SourceDetails source) {
<span class="fc" id="L405">        this.source = source;</span>
<span class="fc" id="L406">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>