<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MyRadiologyAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.radiology</a> &gt; <span class="el_source">MyRadiologyAction.java</span></div><h1>MyRadiologyAction.java</h1><pre class="source lang-java linenums">package com.pkb.action.radiology;

import com.google.common.collect.ImmutableMap;
import com.pkb.action.BaseAction;
import com.pkb.action.file.ChunkedUploadAction;
import com.pkb.action.message.ComposeMessageAction;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.dto.RadiologyAudioEntryDto;
import com.pkb.entities.enums.MenuDataType;
import com.pkb.mappers.ImmutableEntityDependency;
import com.pkb.mappers.RadiologyAudioEntryMapper;
import com.pkb.notification.entity.Activity;
import com.pkb.radiology.RadiologyFacade;
import com.pkb.radiology.entity.RadiologyResult;
import com.pkb.radiology.entity.RadiologyResult.MediaActCategory;
import com.pkb.service.datapoint.DataWithUIPermissions;
import com.pkb.service.radiology.RadiologyManager;
import com.pkb.util.DataDelayService;
import com.pkb.util.security.HtmlMessageFilter;
import org.apache.struts2.interceptor.validation.SkipValidation;
import org.owasp.encoder.Encode;
import org.springframework.beans.factory.annotation.Autowired;

import java.io.IOException;
import java.text.ParseException;
import java.time.Instant;
import java.time.LocalDate;
import java.time.ZonedDateTime;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.function.Supplier;

import static com.pkb.user.entity.PKBPerson.Lazy.CONTACTS;
import static com.pkb.user.entity.PKBPerson.Lazy.NATIONAL_AND_LOCAL_IDS;
import static java.lang.String.format;
import static java.util.Collections.emptyList;
import static org.apache.commons.collections4.CollectionUtils.isEmpty;
import static org.apache.commons.lang3.StringUtils.isBlank;


<span class="fc" id="L42">public class MyRadiologyAction extends ChunkedUploadAction {</span>

    private static final String THUMBNAIL_CONTENT = &quot;thumbnailContent&quot;;
    private static final String SHOW_FORM = &quot;showForm&quot;;

    private static final long serialVersionUID = 1L;
    private static final String NAMESPACE_MEDIA = &quot;media&quot;;

    // For view/edit
    private RadiologyResult radiologyResult;

    private String sanitizedRadiologyResultDescription;

    private String title;

    private String report;

    private String date;

    private String imageUploadErrorMessage;

    private String removeImageId;

    private String jsonString;

    // Internal
    private Long userId;

    private Long patientAccountId;

    private Long patientId;

    private String subTab;

    private RadiologyManager radiologyManager;

    @Autowired
    private RadiologyFacade radiologyFacade;

    @Autowired
    private DataDelayService dataDelayService;

    private HtmlMessageFilter htmlMessageFilter;

    // When editing data point privacy flags
    private Long dataPointId;

    private List&lt;Long&gt; radiologyIds;

    private MediaActCategory category;

    private String discussMessage;

    private String discussTopic;

    private List&lt;RadiologyAudioEntryDto&gt; radiologyAudioDtos;

    private LoggedInEHRRequestContext loggedInContext;

    @Autowired
    private RadiologyAudioEntryMapper radiologyAudioEntryMapper;

    public String listResults() {
<span class="fc" id="L105">        setupVariables();</span>
<span class="fc" id="L106">        List&lt;RadiologyResult&gt; radiologyResults = retrieveRadiologyResults(category, patientAccountId, 0, 0, emptyList());</span>
<span class="fc" id="L107">        List&lt;DataWithUIPermissions&lt;RadiologyResult&gt;&gt; radiologyList = dataPointManager.getPermissions(radiologyResults, loggedInContext);</span>
<span class="fc" id="L108">        var dependency = ImmutableEntityDependency.&lt;RadiologyResult&gt;builder()</span>
<span class="fc" id="L109">                .locale(getLocale())</span>
<span class="fc" id="L110">                .loggedInRequestContext(loggedInContext)</span>
<span class="fc" id="L111">                .build();</span>
<span class="fc" id="L112">        radiologyAudioDtos = radiologyAudioEntryMapper.entitiesToDtos(radiologyList, dependency);</span>

<span class="fc" id="L114">        return SUCCESS;</span>
    }

    private BaseAction.Users setupVariables() {
<span class="fc" id="L118">        var users = getContextAndLoggedInUsers();</span>
<span class="fc" id="L119">        userId = users.loggedInUser().getId();</span>
<span class="fc" id="L120">        category = MediaActCategory.getByNameIgnoreCase(subTab);</span>
<span class="fc" id="L121">        patientId = users.contextUser().getId();</span>
<span class="fc" id="L122">        patientAccountId = userManager.getDefaultAccountId(patientId);</span>
<span class="fc" id="L123">        loggedInContext = getLoggedInEHRRequestContext();</span>
<span class="fc" id="L124">        return users;</span>
    }

    public String viewResult() {
<span class="fc" id="L128">        setupVariables();</span>
<span class="fc" id="L129">        radiologyResult = retrieveRadiologyResult(getLoggedInEHRRequestContext(), dataPointId);</span>

<span class="fc bfc" id="L131" title="All 2 branches covered.">        if (isReportAvailable()) {</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">            sanitizedRadiologyResultDescription = radiologyResult.isHtmlAllowed() ? htmlMessageFilter.filter(radiologyResult.getDescription())</span>
<span class="pc" id="L133">                    : Encode.forHtml(radiologyResult.getDescription());</span>
        }

<span class="fc" id="L136">        return &quot;viewResult&quot;;</span>
    }

    public String uploadResultForm() {
<span class="fc" id="L140">        messageWebBean.removeAttachmentsFromSession(session);</span>

<span class="fc bfc" id="L142" title="All 2 branches covered.">        if (dataPointId != null) {</span>
<span class="fc" id="L143">            radiologyResult = retrieveRadiologyResult(getLoggedInEHRRequestContext(), dataPointId);</span>

<span class="fc" id="L145">            LocalDate creationDate = LocalDate.ofInstant(radiologyResult.getCreationTimestamp(), getZoneIdOfLoggedInUser());</span>
<span class="fc" id="L146">            date = getGlobalDateInputFormatter().format(creationDate);</span>
<span class="fc" id="L147">            title = radiologyResult.getTitle();</span>
<span class="fc" id="L148">            report = radiologyResult.getDescription();</span>
<span class="fc" id="L149">            attachments = radiologyResult.getAttachments();</span>
<span class="fc" id="L150">            messageWebBean.setAttachmentsInSession(attachments, session);</span>
<span class="fc" id="L151">            disablePrivacyFlagEditForm();</span>
<span class="fc" id="L152">        } else {</span>
<span class="fc" id="L153">            date = getGlobalDateInputFormatter().format(dateTimeService.nowLocalDateTime());</span>
<span class="fc" id="L154">            setDefaultFlag();</span>
        }

<span class="fc" id="L157">        return SHOW_FORM;</span>
    }

    public String saveResult() throws IOException {

<span class="fc" id="L162">        var users = setupVariables();</span>

<span class="fc" id="L164">        attachments = generateAttachmentsFromInputs();</span>

<span class="fc" id="L166">        boolean errors = false;</span>

<span class="fc bfc" id="L168" title="All 2 branches covered.">        if (isBlank(title)) {</span>
<span class="fc" id="L169">            addFieldError(&quot;title&quot;, getText(&quot;myRadiologyAction.err.enter_title&quot;));</span>
<span class="fc" id="L170">            errors = true;</span>
        }

<span class="pc bpc" id="L173" title="1 of 2 branches missed.">        if (isBlank(date)) {</span>
<span class="nc" id="L174">            addFieldError(&quot;date&quot;, getText(&quot;myRadiologyAction.err.enter_date&quot;));</span>
<span class="nc" id="L175">            errors = true;</span>
        }

<span class="fc bfc" id="L178" title="All 4 branches covered.">        if (isBlank(report) &amp;&amp; isEmpty(attachments)) {</span>
<span class="fc" id="L179">            addFieldError(&quot;report&quot;, getText(&quot;myRadiologyAction.err.include_report_or_image&quot;));</span>
<span class="fc" id="L180">            errors = true;</span>
        }

<span class="fc" id="L183">        Instant parsed = null;</span>
        try {
<span class="fc" id="L185">            parsed = parseInstant(date);</span>
<span class="nc" id="L186">        } catch (ParseException ignored) {</span>
<span class="nc" id="L187">            addFieldError(&quot;date&quot;, getText(&quot;myRadiologyAction.err.please_enter_date&quot;));</span>
<span class="nc" id="L188">            errors = true;</span>
<span class="fc" id="L189">        }</span>

<span class="fc bfc" id="L191" title="All 2 branches covered.">        if (errors) {</span>
<span class="fc" id="L192">            refillPrivacyFlags();</span>
<span class="fc" id="L193">            return SHOW_FORM;</span>
        }

<span class="fc" id="L196">        radiologyResult = radiologyFacade.initNewRadiologyResult(getEHRRequestContext());</span>
<span class="fc" id="L197">        radiologyResult.setCategory(category);</span>
<span class="fc" id="L198">        radiologyResult.setPatientId(patientId);</span>
<span class="fc" id="L199">        radiologyResult.setAuthorId(userId);</span>
<span class="fc" id="L200">        radiologyResult.setTitle(title);</span>
<span class="fc" id="L201">        radiologyResult.setDescription(report);</span>
<span class="fc" id="L202">        radiologyResult.setCreationTimestamp(parsed);</span>
<span class="fc" id="L203">        radiologyResult.setUploadTimestamp(dateTimeService.now());</span>

<span class="fc bfc" id="L205" title="All 2 branches covered.">        if (dataPointId == null) {</span>
<span class="fc" id="L206">            radiologyResult.getBaseFields().generateNewRandomUniqueId();</span>
<span class="fc" id="L207">            fillPrivacyFlagIn(radiologyResult);</span>
        } else {
<span class="fc" id="L209">            RadiologyResult originalResult = retrieveRadiologyResult(getLoggedInEHRRequestContext(), dataPointId);</span>
<span class="fc" id="L210">            radiologyResult.getBaseFields().setUniqueId(originalResult.getBaseFields().getUniqueId());</span>
<span class="fc" id="L211">            radiologyResult.setPrivacyFlagsFrom(originalResult);</span>
        }

<span class="fc" id="L214">        radiologyResult.setAttachments(attachments);</span>

<span class="pc bpc" id="L216" title="1 of 2 branches missed.">        if (hasNotPermissionsToEditDatapoint(radiologyResult, users.loggedInUser(), loggedInUserUtil.getLoggedInUserPrimaryTeam())) {</span>
<span class="nc" id="L217">            return CANCEL;</span>
        }

<span class="fc" id="L220">        radiologyFacade.saveRadiologyResult(getEHRRequestContext(), patientId, patientAccountId, radiologyResult);</span>

<span class="fc" id="L222">        messageWebBean.removeAttachmentsFromSession(session);</span>
<span class="fc bfc" id="L223" title="All 2 branches covered.">        if (category == MediaActCategory.AUDIO) {</span>
<span class="fc" id="L224">            logActivityByOthers(Activity.Action.UPLOADED_AUDIO, dateTimeService.now(), true, radiologyResult, getLoggedInEHRRequestContext());</span>
<span class="pc bpc" id="L225" title="1 of 2 branches missed.">        } else if (category == MediaActCategory.IMAGING) {</span>
<span class="fc" id="L226">            logActivityByOthers(Activity.Action.UPLOADED_RADIOLOGY, dateTimeService.now(), true, radiologyResult, getLoggedInEHRRequestContext());</span>
        }
<span class="fc" id="L228">        return RELOAD;</span>
    }

    public String cancel() {
<span class="fc" id="L232">        return RELOAD;</span>
    }

    public String deleteImageConfirm() {
<span class="fc" id="L236">        radiologyResult = retrieveRadiologyResult(getLoggedInEHRRequestContext(), dataPointId);</span>
<span class="fc" id="L237">        return &quot;confirmDelete&quot;;</span>
    }

    public String deleteImage() {
<span class="fc" id="L241">        var users = setupVariables();</span>
<span class="fc" id="L242">        radiologyResult = retrieveRadiologyResult(getLoggedInEHRRequestContext(), dataPointId);</span>

<span class="pc bpc" id="L244" title="1 of 2 branches missed.">        if (hasNotPermissionsToDeleteDatapoint(radiologyResult, users.loggedInUser(), loggedInUserUtil.getLoggedInUserPrimaryTeam())) {</span>
<span class="nc" id="L245">            return CANCEL;</span>
        }

<span class="fc" id="L248">        radiologyManager.transactional(() -&gt; {</span>
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">            if (radiologyManager.deleteRadiologyImage(dataPointId)) {</span>
<span class="fc" id="L250">                logActivityByOthers(Activity.Action.DELETED_RADIOLOGY, dateTimeService.now(), true, radiologyResult, getLoggedInEHRRequestContext());</span>
            }
<span class="fc" id="L252">        });</span>
<span class="fc" id="L253">        return SUCCESS;</span>
    }

    public String cancelDelete() {
<span class="nc" id="L257">        return SUCCESS;</span>
    }

    public String discussRadiology() {
<span class="fc" id="L261">        setupVariables();</span>
<span class="fc" id="L262">        radiologyResult = retrieveRadiologyResult(getLoggedInEHRRequestContext(), dataPointId);</span>

<span class="fc" id="L264">        StringBuilder message = new StringBuilder();</span>
<span class="fc" id="L265">        appendDescription(message, radiologyResult);</span>
<span class="fc" id="L266">        discussMessage = message.toString();</span>

        // This action handles two different data types, so we need to determine which data type is actually being
        // requested. For now, one easy way to do that is to use the subTab value.
<span class="fc" id="L270">        discussTopic = ComposeMessageAction.TOPIC_IMAGING;</span>
<span class="fc bfc" id="L271" title="All 2 branches covered.">        if (&quot;audio&quot;.equals(subTab)) {</span>
<span class="fc" id="L272">            discussTopic = ComposeMessageAction.TOPIC_AUDIO;</span>
        }
<span class="fc" id="L274">        sessionUtil.setContextRecipientId(getLoggedInEHRRequestContext());</span>

<span class="fc" id="L276">        return DISCUSS;</span>
    }

    private void appendDescription(StringBuilder message, RadiologyResult report) {
<span class="fc" id="L280">        message.append(&quot;\n&quot;);</span>

<span class="fc" id="L282">        message.append(getText(&quot;myRadiology.txt.title_&quot; + subTab))</span>
<span class="fc" id="L283">                .append(&quot;: &quot;)</span>
<span class="fc" id="L284">                .append(report.getTitle())</span>
<span class="fc" id="L285">                .append(&quot;\n&quot;);</span>

<span class="fc" id="L287">        LocalDate creationDate = LocalDate.ofInstant(report.getCreationTimestamp(), getZoneIdOfLoggedInUser());</span>
<span class="fc" id="L288">        message.append(getText(&quot;myRadiology.txt.date_&quot; + subTab))</span>
<span class="fc" id="L289">                .append(&quot;: &quot;)</span>
<span class="fc" id="L290">                .append(getGlobalDateInputFormatter().format(creationDate))</span>
<span class="fc" id="L291">                .append(&quot;\n&quot;);</span>
<span class="fc" id="L292">    }</span>

    public boolean isResultEditableByLoggedInUser() {
<span class="fc bfc" id="L295" title="All 2 branches covered.">        if (isLoggedInUserPatient()) {</span>
<span class="fc" id="L296">            return radiologyResult.isEditableByUser(loggedInUserUtil.getLoggedInUserId());</span>
        }

<span class="pc bpc" id="L299" title="1 of 2 branches missed.">        if (isLoggedInUserProfessional()) {</span>
<span class="fc" id="L300">            return radiologyResult.isEditableByTeam(loggedInUserUtil.getLoggedInUserPrimaryTeam());</span>
        }

<span class="nc" id="L303">        return false;</span>
    }

    public String editPrivacyForm() {
<span class="fc" id="L307">        var users = getContextAndLoggedInUsers();</span>
<span class="fc" id="L308">        return checkPermissionsAndDo((rc, f) -&gt; fillPrivacyFlagsFrom(f), fetchRadiologyResult(), INPUT, true, users);</span>
    }

<span class="fc" id="L311">    private static final Map&lt;String, MenuDataType&gt; URL_TO_MAIN_MENUDATA = ImmutableMap.&lt;String, MenuDataType&gt;builder()</span>
<span class="fc" id="L312">            .put(&quot;editRadiologyPrivacy_imaging&quot;, MenuDataType.radiologyResult)</span>
<span class="fc" id="L313">            .put(&quot;editRadiologyPrivacy_audio&quot;, MenuDataType.audioResult)</span>
<span class="fc" id="L314">            .build();</span>

<span class="fc" id="L316">    private static final Map&lt;String, MenuDataType&gt; URL_TO_ADDITIONAL_DATA = ImmutableMap.&lt;String, MenuDataType&gt;builder()</span>
<span class="fc" id="L317">            .put(&quot;editRadiologyPrivacy_imaging&quot;, MenuDataType.radiologyImage)</span>
<span class="fc" id="L318">            .put(&quot;editRadiologyPrivacy_audio&quot;, MenuDataType.audio)</span>
<span class="fc" id="L319">            .build();</span>

    @SkipValidation
    public String editPrivacySave() {
<span class="fc" id="L323">        setupVariables();</span>
<span class="fc" id="L324">        var users = getContextAndLoggedInUsers(CONTACTS, NATIONAL_AND_LOCAL_IDS);</span>
<span class="fc" id="L325">        MenuDataType mainType = getType(URL_TO_MAIN_MENUDATA);</span>
<span class="fc" id="L326">        MenuDataType additionalType = getType(URL_TO_ADDITIONAL_DATA);</span>
<span class="fc" id="L327">        return checkPermissionsAndDo(</span>
                (rc, f) -&gt;
<span class="fc" id="L329">                        privacyService.handlePrivacyChange(f, f.getImageSummaries(), mainType, additionalType,</span>
<span class="fc" id="L330">                                getNewFlag(), rc, patientAccountId, users.contextUser(), users.loggedInUser()),</span>
<span class="fc" id="L331">                fetchRadiologyResult(), SUCCESS, false, users);</span>
    }

    @SkipValidation
    public String editPrivacyCancel() {
<span class="fc" id="L336">        return CANCEL;</span>
    }

    private Supplier&lt;Optional&lt;RadiologyResult&gt;&gt; fetchRadiologyResult() {
<span class="fc" id="L340">        setupVariables();</span>
<span class="fc" id="L341">        return () -&gt; Optional.ofNullable(radiologyManager.getRadiologyResult(dataPointId, getLoggedInEHRRequestContext()));</span>
    }

    public String getTab() {
<span class="fc" id="L345">        return &quot;health&quot;;</span>
    }

    public String getSubTab() {
<span class="fc" id="L349">        return subTab;</span>
    }

    public String getTranslatedUppercasedTabName() {
<span class="fc" id="L353">        return getText(format(&quot;myRadiology.txt.%s_uppercase&quot;, subTab));</span>
    }

    public String getHeading() {
<span class="fc bfc" id="L357" title="All 2 branches covered.">        String prefix = dataPointId == null ? &quot;add&quot; : &quot;edit&quot;;</span>
<span class="fc" id="L358">        return getText(format(&quot;editRadiologyResult.txt.%s_result_%s&quot;, prefix, subTab));</span>
    }

    public String getEmptyText() {
<span class="fc bfc" id="L362" title="All 2 branches covered.">        if (loggedInContext.isUserInOwnAccount()) {</span>
<span class="fc bfc" id="L363" title="All 2 branches covered.">            if (subTab.equalsIgnoreCase(MediaActCategory.AUDIO.toString())) {</span>
<span class="fc" id="L364">                return getText(&quot;myRadiology.txt.click_to_start.audio&quot;);</span>
            } else {
<span class="fc" id="L366">                return getText(&quot;myRadiology.txt.click_to_start&quot;);</span>
            }
        } else {
<span class="fc" id="L369">            return getText(&quot;myRadiology.txt.no_results_found&quot;, new String[]{subTab});</span>
        }
    }

    @Override
    public String getCustomStyle() {
<span class="fc" id="L375">        return MOBILE_OPTIMIZED_STYLE;</span>
    }

    public String getDate() {
<span class="fc" id="L379">        return date;</span>
    }

    public void setDate(String date) {
<span class="fc" id="L383">        this.date = date;</span>
<span class="fc" id="L384">    }</span>

    public RadiologyManager getRadiologyManager() {
<span class="nc" id="L387">        return radiologyManager;</span>
    }

    public void setRadiologyManager(RadiologyManager radiologyManager) {
<span class="fc" id="L391">        this.radiologyManager = radiologyManager;</span>
<span class="fc" id="L392">    }</span>

    public RadiologyResult getRadiologyResult() {
<span class="fc" id="L395">        return radiologyResult;</span>
    }

    public void setRadiologyResult(RadiologyResult radiologyResult) {
<span class="nc" id="L399">        this.radiologyResult = radiologyResult;</span>
<span class="nc" id="L400">    }</span>

    public String getReport() {
<span class="fc" id="L403">        return report;</span>
    }

    public void setReport(String report) {
<span class="fc" id="L407">        this.report = report;</span>
<span class="fc" id="L408">    }</span>

    public String getImageUploadErrorMessage() {
<span class="nc" id="L411">        return imageUploadErrorMessage;</span>
    }

    public String getTitle() {
<span class="fc" id="L415">        return title;</span>
    }

    public void setTitle(String title) {
<span class="fc" id="L419">        this.title = title;</span>
<span class="fc" id="L420">    }</span>

    public void setSubTab(String subTab) {
<span class="fc" id="L423">        this.subTab = subTab;</span>
<span class="fc" id="L424">    }</span>

    public String getJsonString() {
<span class="nc" id="L427">        return jsonString;</span>
    }

    public void setJsonString(String jsonString) {
<span class="nc" id="L431">        this.jsonString = jsonString;</span>
<span class="nc" id="L432">    }</span>

    public String getRemoveImageId() {
<span class="nc" id="L435">        return removeImageId;</span>
    }

    public void setRemoveImageId(String removeImageId) {
<span class="nc" id="L439">        this.removeImageId = removeImageId;</span>
<span class="nc" id="L440">    }</span>

    public void setHtmlMessageFilter(HtmlMessageFilter htmlMessageFilter) {
<span class="fc" id="L443">        this.htmlMessageFilter = htmlMessageFilter;</span>
<span class="fc" id="L444">    }</span>

    public boolean isReportAvailable() {
<span class="fc" id="L447">        return radiologyResult.isReportAvailable();</span>
    }

    public String getSanitizedRadiologyResultDescription() {
<span class="fc" id="L451">        return sanitizedRadiologyResultDescription;</span>
    }

    public Long getDataPointId() {
<span class="fc" id="L455">        return dataPointId;</span>
    }

    public void setDataPointId(Long dataPointId) {
<span class="fc" id="L459">        this.dataPointId = dataPointId;</span>
<span class="fc" id="L460">    }</span>

    public List&lt;Long&gt; getRadiologyIds() {
<span class="nc" id="L463">        return radiologyIds;</span>
    }

    public void setRadiologyIds(List&lt;Long&gt; radiologyIds) {
<span class="nc" id="L467">        this.radiologyIds = radiologyIds;</span>
<span class="nc" id="L468">    }</span>

    private Optional&lt;ZonedDateTime&gt; findReportDelayedDate() {
<span class="fc" id="L471">        return dataDelayService.findWhenBecomesVisibleForUserType(radiologyResult, loggedInUserUtil.getLoggedInUserType()).map(z -&gt; z.atZone(loggedInUserUtil.getLoggedInUserZoneId()));</span>
    }

    public ZonedDateTime getReportDelayedDate() {
        // No delay is an error because the JSP should have used isReportDelayed to guard calls to this method
<span class="pc" id="L476">        return findReportDelayedDate().orElseThrow(() -&gt; new IllegalStateException(&quot;Report delayed date unavailable&quot;));</span>
    }

    public boolean isReportDelayed() {
<span class="fc" id="L480">        return findReportDelayedDate().isPresent();</span>
    }

    public boolean isAttachmentListAvailable() {
<span class="fc bfc" id="L484" title="All 4 branches covered.">        return !isReportDelayed() &amp;&amp; radiologyResult.hasAttachments();</span>
    }

    public String getDiscussMessage() {
<span class="fc" id="L488">        return discussMessage;</span>
    }

    public void setDiscussMessage(String discussMessage) {
<span class="nc" id="L492">        this.discussMessage = discussMessage;</span>
<span class="nc" id="L493">    }</span>

    public String getDiscussTopic() {
<span class="fc" id="L496">        return discussTopic;</span>
    }

    public void setDiscussTopic(String discussTopic) {
<span class="nc" id="L500">        this.discussTopic = discussTopic;</span>
<span class="nc" id="L501">    }</span>

    private List&lt;RadiologyResult&gt; retrieveRadiologyResults(MediaActCategory category, Long patientAccountId, int pageSize, int offset, List&lt;Long&gt; filteredRadiologyIds) {
<span class="fc" id="L504">        return radiologyFacade.retrieveRadiologyResults(getLoggedInEHRRequestContext(), category,</span>
                patientAccountId, pageSize, offset, filteredRadiologyIds);
    }

    private RadiologyResult retrieveRadiologyResult(LoggedInEHRRequestContext ehrRequestContext, Long dataPointId) {
<span class="fc" id="L509">        return radiologyFacade.retrieveRadiologyResult(ehrRequestContext, dataPointId);</span>
    }

    public List&lt;RadiologyAudioEntryDto&gt; getRadiologyAudioDtos() {
<span class="fc" id="L513">        return radiologyAudioDtos;</span>
    }

    public LoggedInEHRRequestContext getLoggedInContext() {
<span class="fc" id="L517">        return loggedInContext;</span>
    }

    @Override
    public String getNamespace() {
<span class="fc" id="L522">        return NAMESPACE_MEDIA;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>