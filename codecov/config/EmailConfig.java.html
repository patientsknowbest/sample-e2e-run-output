<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmailConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">config</a> &gt; <span class="el_source">EmailConfig.java</span></div><h1>EmailConfig.java</h1><pre class="source lang-java linenums">package config;

import com.google.common.collect.ImmutableMap;
import com.google.common.collect.Maps;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.entities.enums.Message;
import com.pkb.service.emailmessage.IAddressInfoProvider;
import com.pkb.service.emailmessage.impl.AddressInfoProvider;
import com.pkb.service.emailmessage.impl.EmailManager;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.emailmessage.impl.TemplateParamsFactory;
import com.pkb.service.emailmessage.sender.IMessageComposer;
import com.pkb.service.emailmessage.sender.IMessageDispatcher;
import com.pkb.service.emailmessage.sender.ITemplateDecider;
import com.pkb.service.emailmessage.sender.impl.MessageComposer;
import com.pkb.service.emailmessage.sender.impl.MessageDispatcher;
import com.pkb.service.emailmessage.sender.impl.TemplateDecider;
import com.pkb.service.emailmessage.sender.impl.VelocityTemplateHandler;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.reminders.ReminderManager;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.PersonContactManager;
import com.pkb.service.user.impl.PrimaryEmailContactManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.util.MailSenderFactory;
import com.pkb.util.security.RelaxedHtmlMessageFilter;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;
import org.springframework.mail.javamail.JavaMailSender;

import java.util.EnumMap;
import java.util.Map;

import static com.pkb.entities.enums.Message.ACCOUNT_ACTIVATION_CARER_NOTIFICATION;
import static com.pkb.entities.enums.Message.ACCOUNT_ACTIVATION_NOTIFICATION;
import static com.pkb.entities.enums.Message.ACTIVATION;
import static com.pkb.entities.enums.Message.ACTIVATION_REQUEST_TO_INST_ADMIN;
import static com.pkb.entities.enums.Message.ACTIVITY_NOTIFICATION_TO_CARER;
import static com.pkb.entities.enums.Message.ACTIVITY_NOTIFICATION_TO_CARER_FOR_PATIENT;
import static com.pkb.entities.enums.Message.ACTIVITY_NOTIFICATION_TO_CLINICIAN;
import static com.pkb.entities.enums.Message.ACTIVITY_NOTIFICATION_TO_PATIENT_V2;
import static com.pkb.entities.enums.Message.ACTIVITY_NOTIFICATION_TO_SELF;
import static com.pkb.entities.enums.Message.ACTIVITY_NOTIFICATION_TO_SELF_V2;
import static com.pkb.entities.enums.Message.ASK_FOR_ACCESS;
import static com.pkb.entities.enums.Message.BREAK_THE_GLASS_CARER_NOTIFICATION;
import static com.pkb.entities.enums.Message.BREAK_THE_GLASS_PATIENT_NOTIFICATION;
import static com.pkb.entities.enums.Message.CARER_ACCEPTS_INVITATION_FROM_OTHER_USER_NOTIFY_CARER;
import static com.pkb.entities.enums.Message.CARER_ACCEPTS_INVITATION_FROM_OTHER_USER_NOTIFY_PATIENT;
import static com.pkb.entities.enums.Message.CARER_ACCEPTS_INVITATION_FROM_PATIENT;
import static com.pkb.entities.enums.Message.CARER_ACCEPTS_INVITATION_FROM_PRO;
import static com.pkb.entities.enums.Message.CARER_INVITES_CLINICIAN_FOR_PATIENT;
import static com.pkb.entities.enums.Message.CARER_INVITES_NON_TEAM_CARER_FOR_PATIENT;
import static com.pkb.entities.enums.Message.CARER_INVITES_REGISTERING_CARER_FOR_PATIENT;
import static com.pkb.entities.enums.Message.CARER_INVITES_TEAM_CARER_FOR_PATIENT;
import static com.pkb.entities.enums.Message.CHILD_BIRTHDAY_REMINDER_TO_CARER;
import static com.pkb.entities.enums.Message.CHILD_BIRTHDAY_REMINDER_TO_PATIENT;
import static com.pkb.entities.enums.Message.CHILD_CARER_CONSENT_EXPIRY_TO_CARER;
import static com.pkb.entities.enums.Message.CHILD_CARER_CONSENT_EXPIRY_TO_PATIENT;
import static com.pkb.entities.enums.Message.CLINICIAN_DOCUMENT_CALL_REMINDER;
import static com.pkb.entities.enums.Message.CONFIRM_NEW_CONTACT;
import static com.pkb.entities.enums.Message.EMAIL_VERIFICATION;
import static com.pkb.entities.enums.Message.FORGOT_PASSWORD;
import static com.pkb.entities.enums.Message.HANDOVER_DISCUSSION_NOTIFICATION_TO_NEW_PERSON;
import static com.pkb.entities.enums.Message.HANDOVER_DISCUSSION_NOTIFICATION_TO_OTHER_CARER_FOR_PATIENT;
import static com.pkb.entities.enums.Message.HANDOVER_DISCUSSION_NOTIFICATION_TO_OTHER_PERSON;
import static com.pkb.entities.enums.Message.INDIV_ACCESS_REVOKED_NOTIFICATION_TO_PATIENT;
import static com.pkb.entities.enums.Message.INVITE_CARER;
import static com.pkb.entities.enums.Message.INVITE_CARER_TO_TAKE_QUESTIONNAIRE_FOR_PATIENT;
import static com.pkb.entities.enums.Message.INVITE_CLINICIAN;
import static com.pkb.entities.enums.Message.INVITE_CLINICIAN_TO_UPGRADE;
import static com.pkb.entities.enums.Message.INVITE_EMPLOYEE;
import static com.pkb.entities.enums.Message.INVITE_INSTITUTE_ADMIN;
import static com.pkb.entities.enums.Message.INVITE_ORG_COORD;
import static com.pkb.entities.enums.Message.INVITE_PATIENT_TO_TAKE_QUESTIONNAIRE;
import static com.pkb.entities.enums.Message.INVITE_PRIVACY_OFFICER;
import static com.pkb.entities.enums.Message.INVITE_REG_CLINICIAN;
import static com.pkb.entities.enums.Message.INVITE_TO_CARER_FOR_PATIENT;
import static com.pkb.entities.enums.Message.NOTIFICATION_CLINICIAN_ACCEPTED_INVITATION;
import static com.pkb.entities.enums.Message.NOTIFICATION_OFFERED_CARE_ACCEPTED_ON_BEHALF_OF_PATIENT;
import static com.pkb.entities.enums.Message.NOTIFICATION_OF_PRESCRIPTION;
import static com.pkb.entities.enums.Message.NOTIFICATION_PATIENT_ACCEPTED_OFFERED_CARE;
import static com.pkb.entities.enums.Message.NOTIFICATION_TO_CARER;
import static com.pkb.entities.enums.Message.NOTIFICATION_TO_CARER_OF_SENT_MESSAGE;
import static com.pkb.entities.enums.Message.NOTIFICATION_TO_INST_ADMIN;
import static com.pkb.entities.enums.Message.NOTIFICATION_TO_RECEIVER;
import static com.pkb.entities.enums.Message.NOTIFY_CARER_ACCESS_REVOKED_FOR_PERSON;
import static com.pkb.entities.enums.Message.NOTIFY_CARER_DISCHARGE;
import static com.pkb.entities.enums.Message.NOTIFY_CARER_OF_CREATED_PATIENT_ACCOUNT;
import static com.pkb.entities.enums.Message.NOTIFY_CARER_OF_DOCUMENT_RECEIVED_BY_PATIENT;
import static com.pkb.entities.enums.Message.NOTIFY_CARER_OF_PATIENT_DISCHARGE_FROM_ORG;
import static com.pkb.entities.enums.Message.NOTIFY_CARER_OF_PATIENT_INVITATION_WITH_PRIVACY_LABELS;
import static com.pkb.entities.enums.Message.NOTIFY_CARER_PRIVACY_LEVEL_CHANGED;
import static com.pkb.entities.enums.Message.NOTIFY_CARER_THAT_CLINICIAN_ACCEPTED_INVITATION;
import static com.pkb.entities.enums.Message.NOTIFY_CLINICIAN_OF_CREATED_ACCOUNT;
import static com.pkb.entities.enums.Message.NOTIFY_CLINICIAN_PLAN_EXPORTED;
import static com.pkb.entities.enums.Message.NOTIFY_COORDINATOR_BULK_ACCOUNT_CREATION_COMPLETED;
import static com.pkb.entities.enums.Message.NOTIFY_COORDINATOR_BULK_ACCOUNT_CREATION_FAILED;
import static com.pkb.entities.enums.Message.NOTIFY_COORDINATOR_BULK_CLINICIAN_ACCOUNT_CREATION_COMPLETED;
import static com.pkb.entities.enums.Message.NOTIFY_COORDINATOR_OF_CREATED_ACCOUNT;
import static com.pkb.entities.enums.Message.NOTIFY_COORDINATOR_PLAN_EXPORT_COMPLETED;
import static com.pkb.entities.enums.Message.NOTIFY_NHS_LOGIN_PATIENT_OF_CLAIMED_RECORD;
import static com.pkb.entities.enums.Message.NOTIFY_PATIENT_DISCHARGE;
import static com.pkb.entities.enums.Message.NOTIFY_PATIENT_DISCHARGE_FROM_ORG;
import static com.pkb.entities.enums.Message.NOTIFY_PATIENT_OF_CREATED_ACCOUNT;
import static com.pkb.entities.enums.Message.NOTIFY_PATIENT_OF_DOCUMENT_RECEIVED;
import static com.pkb.entities.enums.Message.NOTIFY_PATIENT_OF_INVITATION_WITH_PRIVACY_LABELS;
import static com.pkb.entities.enums.Message.NOTIFY_PATIENT_PRIVACY_LEVEL_CHANGED;
import static com.pkb.entities.enums.Message.NOTIFY_PATIENT_SHARING_DISABLED;
import static com.pkb.entities.enums.Message.NOTIFY_PATIENT_SHARING_ENABLED;
import static com.pkb.entities.enums.Message.NOTIFY_PATIENT_THAT_CLINICIAN_ACCEPTED_INVITATION;
import static com.pkb.entities.enums.Message.NOTIFY_PERSON_THEIR_ACCESS_HAS_BEEN_REVOKED;
import static com.pkb.entities.enums.Message.ORG_ACTIVATED_IN_NETWORK;
import static com.pkb.entities.enums.Message.ORG_APPROVED_NETWORK;
import static com.pkb.entities.enums.Message.ORG_INVITED_TO_NETWORK;
import static com.pkb.entities.enums.Message.ORG_NETWORK_CREATED;
import static com.pkb.entities.enums.Message.ORG_REJECTED_NETWORK;
import static com.pkb.entities.enums.Message.OTHER_USER_INVITES_CARER_NOTIFY_CARER;
import static com.pkb.entities.enums.Message.OTHER_USER_INVITES_CARER_NOTIFY_PATIENT;
import static com.pkb.entities.enums.Message.OUT_OF_AREA_DEFERRED_ACTIVATION;
import static com.pkb.entities.enums.Message.PATIENT_DOCUMENT_CALL_REMINDER;
import static com.pkb.entities.enums.Message.PATIENT_INVITES_CLINICIAN;
import static com.pkb.entities.enums.Message.PATIENT_INVITES_NON_TEAM_CARER_FOR_SELF;
import static com.pkb.entities.enums.Message.PATIENT_INVITES_REGISTERING_CARER_FOR_SELF;
import static com.pkb.entities.enums.Message.PATIENT_INVITES_TEAM_CARER_FOR_SELF;
import static com.pkb.entities.enums.Message.PRIMARY_CONTACT_CHANGE;
import static com.pkb.entities.enums.Message.PRIMARY_CONTACT_CHANGE_CARER_NOTIFICATION;
import static com.pkb.entities.enums.Message.PRIVACY_LABEL_NOTIFICATION_TO_CARER;
import static com.pkb.entities.enums.Message.PRIVACY_LABEL_NOTIFICATION_TO_PATIENT;
import static com.pkb.entities.enums.Message.PRO_INVITES_CLINICIAN_FOR_PATIENT;
import static com.pkb.entities.enums.Message.PRO_INVITES_NON_TEAM_CARER_FOR_PATIENT;
import static com.pkb.entities.enums.Message.PRO_INVITES_NON_TEAM_CLINICIAN_FOR_PATIENT;
import static com.pkb.entities.enums.Message.PRO_INVITES_REGISTERING_CARER_FOR_PATIENT;
import static com.pkb.entities.enums.Message.PRO_INVITES_TEAM_CARER_FOR_PATIENT;
import static com.pkb.entities.enums.Message.RESET_PASSWORD;
import static com.pkb.entities.enums.Message.RESET_PASSWORD_BY_SUPER_ADMIN;
import static com.pkb.entities.enums.Message.REVOKE_ACCESS_NOTIFICATION_TO_CARER;
import static com.pkb.entities.enums.Message.REVOKE_ACCESS_NOTIFICATION_TO_PATIENT;
import static com.pkb.entities.enums.Message.SYMPTOMS_REMINDER;
import static com.pkb.entities.enums.Message.TEAM_ACCESS_GRANTED_NOTIFICATION_TO_CARER_FOR_PATIENT;
import static com.pkb.entities.enums.Message.TEAM_ACCESS_GRANTED_NOTIFICATION_TO_PATIENT;
import static com.pkb.entities.enums.Message.UNREAD_DOCUMENT_REMINDER;
import static com.pkb.entities.enums.Message.UNREAD_MESSAGE_REMINDER;

@Configuration
@Import({
        PkbManagerConfig.class,
        VelocityTemplateHandlerConfig.class
})
<span class="fc" id="L152">public class EmailConfig {</span>

    @Bean
    public TemplateDecider templateDecider() {
<span class="fc" id="L156">        Map&lt;Message, String&gt; emailTemplateMaps = new EnumMap&lt;&gt;(Message.class);</span>

<span class="fc" id="L158">        emailTemplateMaps.put(ACTIVATION, &quot;templates/email/confirmEmail.vm&quot;);</span>
<span class="fc" id="L159">        emailTemplateMaps.put(EMAIL_VERIFICATION, &quot;templates/email/emailVerification.vm&quot;);</span>
<span class="fc" id="L160">        emailTemplateMaps.put(OUT_OF_AREA_DEFERRED_ACTIVATION, &quot;templates/email/accessGrantedNotificationToSelf.vm&quot;);</span>
<span class="fc" id="L161">        emailTemplateMaps.put(INVITE_CLINICIAN, &quot;templates/email/inviteClinician.vm&quot;);</span>
<span class="fc" id="L162">        emailTemplateMaps.put(NOTIFICATION_TO_RECEIVER, &quot;templates/email/notificationToReceiver.vm&quot;);</span>
<span class="fc" id="L163">        emailTemplateMaps.put(NOTIFICATION_TO_CARER, &quot;templates/email/notificationToCarer.vm&quot;);</span>
<span class="fc" id="L164">        emailTemplateMaps.put(NOTIFICATION_TO_CARER_OF_SENT_MESSAGE, &quot;templates/email/notificationToCarerOfSentMessage.vm&quot;);</span>
<span class="fc" id="L165">        emailTemplateMaps.put(NOTIFICATION_OF_PRESCRIPTION, &quot;templates/email/notificationOfPrescription.vm&quot;);</span>
<span class="fc" id="L166">        emailTemplateMaps.put(PATIENT_DOCUMENT_CALL_REMINDER, &quot;templates/email/patientDocumentCallReminder.vm&quot;);</span>
<span class="fc" id="L167">        emailTemplateMaps.put(CLINICIAN_DOCUMENT_CALL_REMINDER, &quot;templates/email/clinicianDocumentCallReminder.vm&quot;);</span>
<span class="fc" id="L168">        emailTemplateMaps.put(INVITE_TO_CARER_FOR_PATIENT, &quot;templates/email/inviteToCarerForPatient.vm&quot;);</span>
<span class="fc" id="L169">        emailTemplateMaps.put(INVITE_INSTITUTE_ADMIN, &quot;templates/email/inviteInstituteAdmin.vm&quot;);</span>
<span class="fc" id="L170">        emailTemplateMaps.put(INVITE_ORG_COORD, &quot;templates/email/inviteOrgCoord.vm&quot;);</span>
<span class="fc" id="L171">        emailTemplateMaps.put(INVITE_REG_CLINICIAN, &quot;templates/email/inviteRegClinician.vm&quot;);</span>
<span class="fc" id="L172">        emailTemplateMaps.put(NOTIFY_PATIENT_OF_CREATED_ACCOUNT, &quot;templates/email/notifyPatientOfCreatedAccount.vm&quot;);</span>
<span class="fc" id="L173">        emailTemplateMaps.put(NOTIFY_CARER_OF_CREATED_PATIENT_ACCOUNT, &quot;templates/email/notifyCarerOfCreatedPatientAccount.vm&quot;);</span>
<span class="fc" id="L174">        emailTemplateMaps.put(NOTIFY_CLINICIAN_OF_CREATED_ACCOUNT, &quot;templates/email/notifyClinicianOfCreatedAccount.vm&quot;);</span>
<span class="fc" id="L175">        emailTemplateMaps.put(NOTIFY_COORDINATOR_OF_CREATED_ACCOUNT, &quot;templates/email/notifyCoordinatorOfCreatedAccount.vm&quot;);</span>
<span class="fc" id="L176">        emailTemplateMaps.put(NOTIFICATION_CLINICIAN_ACCEPTED_INVITATION,</span>
                &quot;templates/email/notificationClinicianAcceptedInvitation.vm&quot;);
<span class="fc" id="L178">        emailTemplateMaps.put(NOTIFY_PATIENT_THAT_CLINICIAN_ACCEPTED_INVITATION,</span>
                &quot;templates/email/notifyPatientThatClinicianAcceptedInvitation.vm&quot;);
<span class="fc" id="L180">        emailTemplateMaps.put(NOTIFY_CARER_THAT_CLINICIAN_ACCEPTED_INVITATION,</span>
                &quot;templates/email/notifyCarerThatClinicianAcceptedInvitation.vm&quot;);
<span class="fc" id="L182">        emailTemplateMaps.put(NOTIFICATION_TO_INST_ADMIN, &quot;templates/email/notificationToInstituteAdmin.vm&quot;);</span>
<span class="fc" id="L183">        emailTemplateMaps.put(INVITE_CLINICIAN_TO_UPGRADE, &quot;templates/email/inviteClinicianToUpgrade.vm&quot;);</span>
<span class="fc" id="L184">        emailTemplateMaps.put(INVITE_PATIENT_TO_TAKE_QUESTIONNAIRE, &quot;templates/email/invitePatientToTakeQuestionnaire.vm&quot;);</span>
<span class="fc" id="L185">        emailTemplateMaps.put(INVITE_CARER_TO_TAKE_QUESTIONNAIRE_FOR_PATIENT, &quot;templates/email/invitePatientToTakeQuestionnaireCarerNotification.vm&quot;);</span>
<span class="fc" id="L186">        emailTemplateMaps.put(RESET_PASSWORD, &quot;templates/email/resetPassword.vm&quot;);</span>
<span class="fc" id="L187">        emailTemplateMaps.put(RESET_PASSWORD_BY_SUPER_ADMIN, &quot;templates/email/resetPasswordBySuperAdmin.vm&quot;);</span>
<span class="fc" id="L188">        emailTemplateMaps.put(REVOKE_ACCESS_NOTIFICATION_TO_PATIENT, &quot;templates/email/revokedAccessNotificationToPatient.vm&quot;);</span>
<span class="fc" id="L189">        emailTemplateMaps.put(REVOKE_ACCESS_NOTIFICATION_TO_CARER, &quot;templates/email/revokedAccessNotificationToCarer.vm&quot;);</span>
<span class="fc" id="L190">        emailTemplateMaps.put(NOTIFY_PERSON_THEIR_ACCESS_HAS_BEEN_REVOKED, &quot;templates/email/notifyPersonTheirAccessHasBeenRevoked.vm&quot;);</span>
<span class="fc" id="L191">        emailTemplateMaps.put(NOTIFY_CARER_ACCESS_REVOKED_FOR_PERSON, &quot;templates/email/notifyCarerAccessRevokedForPerson.vm&quot;);</span>
<span class="fc" id="L192">        emailTemplateMaps.put(ACTIVATION_REQUEST_TO_INST_ADMIN, &quot;templates/email/activationRequestToInstituteAdmin.vm&quot;);</span>
<span class="fc" id="L193">        emailTemplateMaps.put(ACCOUNT_ACTIVATION_NOTIFICATION, &quot;templates/email/accountActivatedNotification.vm&quot;);</span>
<span class="fc" id="L194">        emailTemplateMaps.put(ACCOUNT_ACTIVATION_CARER_NOTIFICATION, &quot;templates/email/accountActivatedCarerNotification.vm&quot;);</span>
<span class="fc" id="L195">        emailTemplateMaps.put(HANDOVER_DISCUSSION_NOTIFICATION_TO_NEW_PERSON,</span>
                &quot;templates/email/notificationOfDiscussionHandoverToNewPerson.vm&quot;);
<span class="fc" id="L197">        emailTemplateMaps.put(HANDOVER_DISCUSSION_NOTIFICATION_TO_OTHER_PERSON,</span>
                &quot;templates/email/notificationOfDiscussionHandoverToOtherPerson.vm&quot;);
<span class="fc" id="L199">        emailTemplateMaps.put(HANDOVER_DISCUSSION_NOTIFICATION_TO_OTHER_CARER_FOR_PATIENT,</span>
                &quot;templates/email/notificationOfDiscussionHandoverToOtherCarer.vm&quot;);
<span class="fc" id="L201">        emailTemplateMaps.put(ACTIVITY_NOTIFICATION_TO_PATIENT_V2, &quot;templates/email/notifyPatientOfActivityByOthersV2.vm&quot;);</span>
<span class="fc" id="L202">        emailTemplateMaps.put(ACTIVITY_NOTIFICATION_TO_CLINICIAN, &quot;templates/email/notifyClinicianOfActivityByOthers.vm&quot;);</span>
<span class="fc" id="L203">        emailTemplateMaps.put(ACTIVITY_NOTIFICATION_TO_CARER, &quot;templates/email/notifyCarerOfActivityByPatient.vm&quot;);</span>
<span class="fc" id="L204">        emailTemplateMaps.put(CONFIRM_NEW_CONTACT, &quot;templates/email/confirmContact.vm&quot;);</span>
<span class="fc" id="L205">        emailTemplateMaps.put(PRIMARY_CONTACT_CHANGE, &quot;templates/email/primaryContactChange.vm&quot;);</span>
<span class="fc" id="L206">        emailTemplateMaps.put(PRIMARY_CONTACT_CHANGE_CARER_NOTIFICATION, &quot;templates/email/primaryContactChangeCarerNotification.vm&quot;);</span>
<span class="fc" id="L207">        emailTemplateMaps.put(INVITE_CARER, &quot;templates/email/inviteCarer.vm&quot;);</span>
<span class="fc" id="L208">        emailTemplateMaps.put(INVITE_EMPLOYEE, &quot;templates/email/inviteEmployee.vm&quot;);</span>
<span class="fc" id="L209">        emailTemplateMaps.put(ASK_FOR_ACCESS, &quot;templates/email/askForAccess.vm&quot;);</span>
<span class="fc" id="L210">        emailTemplateMaps.put(NOTIFICATION_PATIENT_ACCEPTED_OFFERED_CARE,</span>
                &quot;templates/email/notificationPatientAcceptedOfferedCare.vm&quot;);
<span class="fc" id="L212">        emailTemplateMaps.put(NOTIFICATION_OFFERED_CARE_ACCEPTED_ON_BEHALF_OF_PATIENT,</span>
                &quot;templates/email/notificationOfferedCareAcceptedOnBehalfOfPatient.vm&quot;);
<span class="fc" id="L214">        emailTemplateMaps.put(TEAM_ACCESS_GRANTED_NOTIFICATION_TO_PATIENT,</span>
                &quot;templates/email/teamAccessGrantedNotificationToPatient.vm&quot;);
<span class="fc" id="L216">        emailTemplateMaps.put(TEAM_ACCESS_GRANTED_NOTIFICATION_TO_CARER_FOR_PATIENT,</span>
                &quot;templates/email/teamAccessGrantedNotificationToCarerForPatient.vm&quot;);
<span class="fc" id="L218">        emailTemplateMaps</span>
<span class="fc" id="L219">                .put(INDIV_ACCESS_REVOKED_NOTIFICATION_TO_PATIENT, &quot;templates/email/indivAccessRevokedNotificationToPatient.vm&quot;);</span>
<span class="fc" id="L220">        emailTemplateMaps.put(SYMPTOMS_REMINDER, &quot;templates/email/patientSymptomsReminder.vm&quot;);</span>
<span class="fc" id="L221">        emailTemplateMaps.put(UNREAD_MESSAGE_REMINDER, &quot;templates/email/patientUnreadMessageReminder.vm&quot;);</span>
<span class="fc" id="L222">        emailTemplateMaps.put(UNREAD_DOCUMENT_REMINDER, &quot;templates/email/patientUnreadDocumentReminder.vm&quot;);</span>
<span class="fc" id="L223">        emailTemplateMaps.put(CHILD_BIRTHDAY_REMINDER_TO_CARER, &quot;templates/email/childBirthdayReminderToCarer.vm&quot;);</span>
<span class="fc" id="L224">        emailTemplateMaps.put(CHILD_BIRTHDAY_REMINDER_TO_PATIENT, &quot;templates/email/childBirthdayReminderToPatient.vm&quot;);</span>
<span class="fc" id="L225">        emailTemplateMaps.put(CHILD_CARER_CONSENT_EXPIRY_TO_CARER, &quot;templates/email/childBirthdayRemovalNotificationToCarer.vm&quot;);</span>
<span class="fc" id="L226">        emailTemplateMaps.put(CHILD_CARER_CONSENT_EXPIRY_TO_PATIENT, &quot;templates/email/childBirthdayRemovalNotificationToPatient.vm&quot;);</span>
<span class="fc" id="L227">        emailTemplateMaps.put(ACTIVITY_NOTIFICATION_TO_SELF, &quot;templates/email/selfNotification.vm&quot;);</span>
<span class="fc" id="L228">        emailTemplateMaps.put(ACTIVITY_NOTIFICATION_TO_SELF_V2, &quot;templates/email/selfNotification_v2.vm&quot;);</span>

<span class="fc" id="L230">        emailTemplateMaps.put(NOTIFY_COORDINATOR_PLAN_EXPORT_COMPLETED, &quot;templates/email/notifyCoordinatorPlanExported.vm&quot;);</span>
<span class="fc" id="L231">        emailTemplateMaps.put(NOTIFY_CLINICIAN_PLAN_EXPORTED, &quot;templates/email/notifyClinicianPlanExported.vm&quot;);</span>
<span class="fc" id="L232">        emailTemplateMaps.put(NOTIFY_COORDINATOR_BULK_ACCOUNT_CREATION_COMPLETED,</span>
                &quot;templates/email/notifyCoordinatorBulkAccountCreationCompleted.vm&quot;);
<span class="fc" id="L234">        emailTemplateMaps.put(NOTIFY_COORDINATOR_BULK_ACCOUNT_CREATION_FAILED,</span>
                &quot;templates/email/notifyCoordinatorBulkAccountCreationFailed.vm&quot;);
<span class="fc" id="L236">        emailTemplateMaps.put(NOTIFY_COORDINATOR_BULK_CLINICIAN_ACCOUNT_CREATION_COMPLETED,</span>
                &quot;templates/email/notifyCoordinatorBulkClinicianAccountCreationCompleted.vm&quot;);
<span class="fc" id="L238">        emailTemplateMaps.put(PRO_INVITES_CLINICIAN_FOR_PATIENT, &quot;templates/email/proInvitesClinicianForPatient.vm&quot;);</span>
<span class="fc" id="L239">        emailTemplateMaps.put(PRO_INVITES_NON_TEAM_CLINICIAN_FOR_PATIENT, &quot;templates/email/proInvitesNonTeamClinicianForPatient.vm&quot;);</span>
<span class="fc" id="L240">        emailTemplateMaps.put(CARER_INVITES_CLINICIAN_FOR_PATIENT, &quot;templates/email/carerInvitesClinicianForPatient.vm&quot;);</span>
<span class="fc" id="L241">        emailTemplateMaps.put(PATIENT_INVITES_CLINICIAN, &quot;templates/email/patientInvitesClinician.vm&quot;);</span>
<span class="fc" id="L242">        emailTemplateMaps.put(PATIENT_INVITES_NON_TEAM_CARER_FOR_SELF, &quot;templates/email/patientInvitesNonTeamCarerForSelf.vm&quot;);</span>
<span class="fc" id="L243">        emailTemplateMaps.put(CARER_INVITES_NON_TEAM_CARER_FOR_PATIENT, &quot;templates/email/carerInvitesNonTeamCarerForPatient.vm&quot;);</span>
<span class="fc" id="L244">        emailTemplateMaps.put(PRO_INVITES_NON_TEAM_CARER_FOR_PATIENT, &quot;templates/email/proInvitesNonTeamCarerForPatient.vm&quot;);</span>
<span class="fc" id="L245">        emailTemplateMaps.put(PATIENT_INVITES_TEAM_CARER_FOR_SELF, &quot;templates/email/patientInvitesTeamCarerForSelf.vm&quot;);</span>
<span class="fc" id="L246">        emailTemplateMaps.put(CARER_INVITES_TEAM_CARER_FOR_PATIENT, &quot;templates/email/carerInvitesTeamCarerForPatient.vm&quot;);</span>
<span class="fc" id="L247">        emailTemplateMaps.put(PRO_INVITES_TEAM_CARER_FOR_PATIENT, &quot;templates/email/proInvitesTeamCarerForPatient.vm&quot;);</span>
<span class="fc" id="L248">        emailTemplateMaps.put(PATIENT_INVITES_REGISTERING_CARER_FOR_SELF,</span>
                &quot;templates/email/patientInvitesRegisteringCarerForSelf.vm&quot;);
<span class="fc" id="L250">        emailTemplateMaps.put(CARER_INVITES_REGISTERING_CARER_FOR_PATIENT,</span>
                &quot;templates/email/carerInvitesRegisteringCarerForPatient.vm&quot;);
<span class="fc" id="L252">        emailTemplateMaps.put(PRO_INVITES_REGISTERING_CARER_FOR_PATIENT, &quot;templates/email/proInvitesRegisteringCarerForPatient.vm&quot;);</span>
<span class="fc" id="L253">        emailTemplateMaps.put(CARER_ACCEPTS_INVITATION_FROM_PATIENT, &quot;templates/email/carerAcceptsInvitationFromPatient&quot;);</span>
<span class="fc" id="L254">        emailTemplateMaps.put(CARER_ACCEPTS_INVITATION_FROM_PRO, &quot;templates/email/carerAcceptsInvitationFromPro&quot;);</span>
<span class="fc" id="L255">        emailTemplateMaps.put(CARER_ACCEPTS_INVITATION_FROM_OTHER_USER_NOTIFY_PATIENT,</span>
                &quot;templates/email/carerAcceptsInviteFromOtherUserNotifyPatient&quot;);
<span class="fc" id="L257">        emailTemplateMaps.put(CARER_ACCEPTS_INVITATION_FROM_OTHER_USER_NOTIFY_CARER,</span>
                &quot;templates/email/carerAcceptsInviteFromOtherUserNotifyCarer&quot;);
<span class="fc" id="L259">        emailTemplateMaps.put(ORG_NETWORK_CREATED, &quot;templates/email/orgNetworkCreated.vm&quot;);</span>
<span class="fc" id="L260">        emailTemplateMaps.put(ORG_INVITED_TO_NETWORK, &quot;templates/email/orgInvitedToNetwork.vm&quot;);</span>
<span class="fc" id="L261">        emailTemplateMaps.put(ORG_APPROVED_NETWORK, &quot;templates/email/orgApprovedNetwork.vm&quot;);</span>
<span class="fc" id="L262">        emailTemplateMaps.put(ORG_ACTIVATED_IN_NETWORK, &quot;templates/email/orgActivatedNetwork.vm&quot;);</span>
<span class="fc" id="L263">        emailTemplateMaps.put(ORG_REJECTED_NETWORK, &quot;templates/email/orgRejectedNetwork.vm&quot;);</span>
<span class="fc" id="L264">        emailTemplateMaps.put(NOTIFY_PATIENT_PRIVACY_LEVEL_CHANGED, &quot;templates/email/changePrivacyLevelNotification.vm&quot;);</span>
<span class="fc" id="L265">        emailTemplateMaps.put(NOTIFY_CARER_PRIVACY_LEVEL_CHANGED, &quot;templates/email/changePrivacyLevelCarerNotification.vm&quot;);</span>
<span class="fc" id="L266">        emailTemplateMaps.put(NOTIFY_PATIENT_DISCHARGE, &quot;templates/email/patientDischargeNotification.vm&quot;);</span>
<span class="fc" id="L267">        emailTemplateMaps.put(NOTIFY_PATIENT_DISCHARGE_FROM_ORG, &quot;templates/email/patientDischargeFromOrgNotification.vm&quot;);</span>
<span class="fc" id="L268">        emailTemplateMaps.put(NOTIFY_CARER_OF_PATIENT_DISCHARGE_FROM_ORG, &quot;templates/email/patientDischargeFromOrgCarerNotification.vm&quot;);</span>
<span class="fc" id="L269">        emailTemplateMaps.put(NOTIFY_CARER_DISCHARGE, &quot;templates/email/carerDischargeNotification.vm&quot;);</span>
<span class="fc" id="L270">        emailTemplateMaps.put(OTHER_USER_INVITES_CARER_NOTIFY_PATIENT, &quot;templates/email/otherUserInvitesCarerNotifyPatient.vm&quot;);</span>
<span class="fc" id="L271">        emailTemplateMaps.put(OTHER_USER_INVITES_CARER_NOTIFY_CARER, &quot;templates/email/otherUserInvitesCarerNotifyCarer.vm&quot;);</span>
<span class="fc" id="L272">        emailTemplateMaps.put(INVITE_PRIVACY_OFFICER, &quot;templates/email/invitePrivacyOfficer.vm&quot;);</span>
<span class="fc" id="L273">        emailTemplateMaps.put(NOTIFY_PATIENT_SHARING_DISABLED, &quot;templates/email/sharingDisabledNotificationToPatient.vm&quot;);</span>
<span class="fc" id="L274">        emailTemplateMaps.put(NOTIFY_PATIENT_SHARING_ENABLED, &quot;templates/email/sharingEnabledNotificationToPatient.vm&quot;);</span>
<span class="fc" id="L275">        emailTemplateMaps.put(FORGOT_PASSWORD, &quot;templates/email/forgotPassword.vm&quot;);</span>
<span class="fc" id="L276">        emailTemplateMaps.put(NOTIFY_PATIENT_OF_DOCUMENT_RECEIVED, &quot;templates/email/patientDocumentReceivedNotification.vm&quot;);</span>
<span class="fc" id="L277">        emailTemplateMaps.put(NOTIFY_CARER_OF_DOCUMENT_RECEIVED_BY_PATIENT, &quot;templates/email/patientDocumentReceivedNotificationToCarer.vm&quot;);</span>
<span class="fc" id="L278">        emailTemplateMaps.put(ACTIVITY_NOTIFICATION_TO_CARER_FOR_PATIENT, &quot;templates/email/notifyCarerForPatientOfActivityByOthers.vm&quot;);</span>
<span class="fc" id="L279">        emailTemplateMaps.put(BREAK_THE_GLASS_PATIENT_NOTIFICATION, &quot;templates/email/breakTheGlassNotificationToPatient.vm&quot;);</span>
<span class="fc" id="L280">        emailTemplateMaps.put(BREAK_THE_GLASS_CARER_NOTIFICATION, &quot;templates/email/breakTheGlassNotificationToCarer.vm&quot;);</span>
<span class="fc" id="L281">        emailTemplateMaps.put(PRIVACY_LABEL_NOTIFICATION_TO_PATIENT, &quot;templates/email/privacyLabelNotificationToPatient.vm&quot;);</span>
<span class="fc" id="L282">        emailTemplateMaps.put(PRIVACY_LABEL_NOTIFICATION_TO_CARER, &quot;templates/email/privacyLabelNotificationToCarer.vm&quot;);</span>
<span class="fc" id="L283">        emailTemplateMaps.put(NOTIFY_PATIENT_OF_INVITATION_WITH_PRIVACY_LABELS, &quot;templates/email/notifyPatientOfInvitationWithPrivacyLabels.vm&quot;);</span>
<span class="fc" id="L284">        emailTemplateMaps.put(NOTIFY_CARER_OF_PATIENT_INVITATION_WITH_PRIVACY_LABELS, &quot;templates/email/notifyCarerOfPatientInvitationWithPrivacyLabels.vm&quot;);</span>
<span class="fc" id="L285">        emailTemplateMaps.put(NOTIFY_NHS_LOGIN_PATIENT_OF_CLAIMED_RECORD, &quot;templates/email/notifyNhsLoginPatientOfClaimedRecord.vm&quot;);</span>

<span class="fc" id="L287">        TemplateDecider templateDecider = new TemplateDecider();</span>
<span class="fc" id="L288">        templateDecider.setTemplateMap(ImmutableMap.of(</span>
<span class="fc" id="L289">                &quot;EMAIL&quot;, Maps.immutableEnumMap(emailTemplateMaps)));</span>
<span class="fc" id="L290">        return templateDecider;</span>
    }

    @Bean
    public MessageComposer messageComposer(VelocityTemplateHandler templateHandler) {
<span class="fc" id="L295">        MessageComposer messageComposer = new MessageComposer();</span>
<span class="fc" id="L296">        messageComposer.setTemplateHandler(templateHandler);</span>
<span class="fc" id="L297">        return messageComposer;</span>
    }

    @Bean
    public JavaMailSender mailSender(PhrConfig config) {
<span class="fc" id="L302">        return MailSenderFactory.getMailSender(config);</span>
    }

    @Bean
    public MessageDispatcher messageDispatcher(JavaMailSender mailSender, PhrConfig config) {
<span class="fc" id="L307">        MessageDispatcher messageDispatcher = new MessageDispatcher();</span>
<span class="fc" id="L308">        messageDispatcher.setMailSender(mailSender);</span>
<span class="fc" id="L309">        messageDispatcher.setConfig(config);</span>
<span class="fc" id="L310">        return messageDispatcher;</span>
    }

    @Bean
    public EmailManager emailManager(
            ITemplateDecider templateDecider,
            IMessageComposer messageComposer,
            IMessageDispatcher messageDispatcher,
            TeamUserManager teamUserManager,
            PersonContactManager personContactManager,
            UserManager userManager,
            PhrConfig config,
            RelaxedHtmlMessageFilter relaxedHtmlMessageFilter,
            DateTimeService dateTimeService) {

<span class="fc" id="L325">        EmailManager emailManager = new EmailManager();</span>
<span class="fc" id="L326">        emailManager.setTemplateDecider(templateDecider);</span>
<span class="fc" id="L327">        emailManager.setMessageComposer(messageComposer);</span>
<span class="fc" id="L328">        emailManager.setMessageDispatcher(messageDispatcher);</span>
<span class="fc" id="L329">        emailManager.setTeamUserManager(teamUserManager);</span>
<span class="fc" id="L330">        emailManager.setPersonContactManager(personContactManager);</span>
<span class="fc" id="L331">        emailManager.setUserManager(userManager);</span>
<span class="fc" id="L332">        emailManager.setConfig(config);</span>
<span class="fc" id="L333">        emailManager.setRelaxedHtmlMessageFilter(relaxedHtmlMessageFilter);</span>
<span class="fc" id="L334">        emailManager.setDateTimeService(dateTimeService);</span>
<span class="fc" id="L335">        return emailManager;</span>
    }

    @Bean
    public AddressInfoProvider formatter(PrimaryEmailContactManager primaryEmailContactManager, RelaxedHtmlMessageFilter htmlMessageFilter) {
<span class="fc" id="L340">        AddressInfoProvider formatter = new AddressInfoProvider();</span>
<span class="fc" id="L341">        formatter.setPrimaryEmailContactManager(primaryEmailContactManager);</span>
<span class="fc" id="L342">        formatter.setHtmlFilter(htmlMessageFilter);</span>
<span class="fc" id="L343">        return formatter;</span>
    }

    @Bean
    public PKBEmailMessageManager pkbEmailMessageManager(
            EmailManager emailManager,
            ReminderManager reminderManager,
            IAddressInfoProvider formatter,
            PhrConfig config,
            TeamUserManager teamUserManager,
            TeamManager teamManager,
            TemplateParamsFactory paramsFactory,
            DateTimeService dateTimeService,
            PatientConsentManager patientConsentManager) {
<span class="fc" id="L357">        PKBEmailMessageManager emailMessageManager = new PKBEmailMessageManager(config, emailManager, reminderManager,</span>
                teamUserManager, teamManager, formatter, paramsFactory, dateTimeService, patientConsentManager);

        // FIXME: eliminate circular dependency between TeamManager and PKBEmailMessageManager.
<span class="fc" id="L361">        teamManager.setEmailMessageManager(emailMessageManager);</span>
        // FIXME: eliminate circular dependency between TeamUserManager and PKBEmailMessageManager.
<span class="fc" id="L363">        teamUserManager.setPkbEmailMessageManager(emailMessageManager);</span>

<span class="fc" id="L365">        return emailMessageManager;</span>
    }

    @Bean
    public TemplateParamsFactory emailTemplateParamsFactory(PhrConfig config) {
<span class="fc" id="L370">        return new TemplateParamsFactory(config);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>