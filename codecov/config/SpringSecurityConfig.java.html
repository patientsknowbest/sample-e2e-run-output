<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SpringSecurityConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">config</a> &gt; <span class="el_source">SpringSecurityConfig.java</span></div><h1>SpringSecurityConfig.java</h1><pre class="source lang-java linenums">package config;

import static org.springframework.security.web.access.channel.ChannelDecisionManagerImpl.ANY_CHANNEL;

import java.util.UUID;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.ApplicationContext;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AnonymousAuthenticationProvider;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.builders.WebSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.config.annotation.web.configurers.UrlAuthorizationConfigurer;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.web.AuthenticationEntryPoint;
import org.springframework.security.web.PortMapper;
import org.springframework.security.web.PortResolver;
import org.springframework.security.web.PortResolverImpl;
import org.springframework.security.web.access.channel.ChannelProcessingFilter;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.security.web.authentication.switchuser.SwitchUserFilter;
import org.springframework.security.web.firewall.HttpFirewall;
import org.springframework.security.web.savedrequest.HttpSessionRequestCache;
import org.springframework.security.web.savedrequest.RequestCache;

import com.pkb.entities.enums.UserType;
import com.pkb.servlets.filter.ApiTokenCorsHeadersFilter;
import com.pkb.servlets.filter.DefaultCacheHeadersFilter;
import com.pkb.servlets.filter.LogoutSuccessHandler;
import com.pkb.servlets.filter.ReferrerPolicyHeaderFilter;
import com.pkb.servlets.filter.SessionCheckFilter;

@Configuration
@EnableWebSecurity
public class SpringSecurityConfig extends WebSecurityConfigurerAdapter {

<span class="fc" id="L42">    private static final String PATIENT = UserType.PATIENT.name();</span>
    private static final String CLINICIAN = &quot;CLINICIAN&quot;;
<span class="fc" id="L44">    private static final String REG_CLINICIAN = UserType.REG_CLINICIAN.name();</span>
<span class="fc" id="L45">    private static final String INSTITUTE_ADMIN = UserType.INSTITUTE_ADMIN.name();</span>
<span class="fc" id="L46">    private static final String SUPER_ADMIN = UserType.SUPER_ADMIN.name();</span>
<span class="fc" id="L47">    private static final String EMPLOYEE = UserType.EMPLOYEE.name();</span>
<span class="fc" id="L48">    private static final String ORG_COORD = UserType.ORG_COORD.name();</span>
<span class="fc" id="L49">    private static final String TECH_SUPPORT = UserType.TECH_SUPPORT.name();</span>
<span class="fc" id="L50">    private static final String PRIVACY_OFFICER = UserType.PRIVACY_OFFICER.name();</span>
    private static final String PRE_TWOFA = &quot;PRE_TWOFA&quot;;

    @Autowired
    @Value(&quot;${portMapping.http}&quot;)
    private Integer portMappingHttp;

    @Autowired
    @Value(&quot;${portMapping.https}&quot;)
    private Integer portMappingHttps;

    @Autowired
    private DefaultCacheHeadersFilter defaultCacheHeadersFilter;

    @Autowired
    private ApiTokenCorsHeadersFilter apiTokenCorsHeadersFilter;

    @Autowired
    private ReferrerPolicyHeaderFilter referrerPolicyHeaderFilter;

    @Qualifier(&quot;customizedFormLoginFilter&quot;)
    @Autowired
    private UsernamePasswordAuthenticationFilter customizedFormLoginFilter;

    @Qualifier(&quot;nhsLoginAuthenticationFilter&quot;)
    @Autowired
    private UsernamePasswordAuthenticationFilter nhsLoginAuthenticationFilter;

    @Autowired
    private SessionCheckFilter sessionCheckFilter;
    
    @Autowired
    private HttpFirewall httpFirewall;

    @Qualifier(&quot;myAuthenticationEntryPoint&quot;)
    @Autowired
    private AuthenticationEntryPoint myAuthenticationEntryPoint;

    @Qualifier(&quot;ssoAuthenticationFilter&quot;)
    @Autowired
    private UsernamePasswordAuthenticationFilter ssoAuthenticationFilter;

    public SpringSecurityConfig() {
<span class="fc" id="L93">        super(true);</span>
<span class="fc" id="L94">    }</span>

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        // TODO: PHR-5574 
        //  1. Refactor EMISSSOAuthenticationManager and PKBAuthenticationManager so that they implement AuthenticationProvider
        //  2. Let spring build AuthenticationManager which seems to be right approach otherwise following workaraound is required
<span class="fc" id="L101">        auth.authenticationProvider(new AnonymousAuthenticationProvider(UUID.randomUUID().toString()));</span>
<span class="fc" id="L102">    }</span>

    @Override
    public void configure(WebSecurity web) throws Exception {
<span class="fc" id="L106">        web.httpFirewall(httpFirewall)</span>
<span class="fc" id="L107">                .ignoring()</span>
<span class="fc" id="L108">                .antMatchers(&quot;login.jsp*&quot;,</span>
                        &quot;/sso/emis/**&quot;,
                        &quot;/_stats**&quot;,
                        &quot;/mockPortalLaunch.jsp&quot;,
                        &quot;/mockEmisClient.jsp&quot;,
                        &quot;/WEB-INF/view/instituteTeamList.jsp&quot;,
                        &quot;/WEB-INF/view/imhIframeBreakout.jsp&quot;);
<span class="fc" id="L115">    }</span>

    @Override
    protected void configure(HttpSecurity http) throws Exception {         
        // (next 3 lines) Forcing spring to use single portmapper/portresolver by configured objects
        // it seems xml based config publishes and reuses single instance 
<span class="fc" id="L121">        initPortMapper(http);</span>
<span class="fc" id="L122">        initPortResolver(http);</span>
<span class="fc" id="L123">        initRequestCache(http);</span>
        
<span class="fc" id="L125">        http.exceptionHandling()</span>
<span class="fc" id="L126">                .accessDeniedPage(&quot;/accessDenied403.jsp&quot;)</span>
<span class="fc" id="L127">                .authenticationEntryPoint(myAuthenticationEntryPoint)</span>
<span class="fc" id="L128">                .and()</span>
<span class="fc" id="L129">                .sessionManagement().enableSessionUrlRewriting(true)</span>
<span class="fc" id="L130">                .sessionFixation()</span>
<span class="fc" id="L131">                .migrateSession()</span>
<span class="fc" id="L132">                .sessionCreationPolicy(SessionCreationPolicy.ALWAYS)</span>
<span class="fc" id="L133">                .and()</span>
<span class="fc" id="L134">                .securityContext()</span>
<span class="fc" id="L135">                .and()</span>
<span class="fc" id="L136">                .servletApi()</span>
<span class="fc" id="L137">                .and()</span>
<span class="fc" id="L138">                .apply(new UrlAuthorizationConfigurer&lt;&gt;(http.getSharedObject(ApplicationContext.class))).getRegistry() // xml config uses this one instead of ExpressionUrlAuthorizationConfigurer</span>
<span class="fc" id="L139">                .antMatchers(&quot;/jsp/**&quot;).hasAnyRole(PATIENT, CLINICIAN, REG_CLINICIAN)</span>
<span class="fc" id="L140">                .antMatchers(&quot;/auth/resetCredentials**&quot;).hasRole(REG_CLINICIAN)</span>
<span class="fc" id="L141">                .antMatchers(&quot;/auth/**&quot;).hasAnyRole(PATIENT, CLINICIAN, REG_CLINICIAN, INSTITUTE_ADMIN, SUPER_ADMIN, EMPLOYEE, ORG_COORD, TECH_SUPPORT, PRIVACY_OFFICER)</span>
<span class="fc" id="L142">                .antMatchers(&quot;/twofactormanage/**&quot;).hasAnyRole(PATIENT, CLINICIAN, REG_CLINICIAN, INSTITUTE_ADMIN, SUPER_ADMIN, EMPLOYEE, ORG_COORD, TECH_SUPPORT)</span>
<span class="fc" id="L143">                .antMatchers(&quot;/twofactorauth/**&quot;).hasAnyRole(PRE_TWOFA)</span>
<span class="fc" id="L144">                .antMatchers(&quot;/techsupport/**&quot;).hasAnyRole(TECH_SUPPORT)</span>
<span class="fc" id="L145">                .antMatchers(&quot;/privacyofficer/**&quot;).hasAnyRole(PRIVACY_OFFICER)</span>
<span class="fc" id="L146">                .antMatchers(&quot;/patient/**&quot;).hasAnyRole(PATIENT, CLINICIAN, REG_CLINICIAN)</span>
<span class="fc" id="L147">                .antMatchers(&quot;/file/**&quot;).hasAnyRole(PATIENT, REG_CLINICIAN, PRIVACY_OFFICER)</span>
<span class="fc" id="L148">                .antMatchers(&quot;/diary/**&quot;).hasAnyRole(PATIENT, REG_CLINICIAN)</span>
<span class="fc" id="L149">                .antMatchers(&quot;/test/**&quot;).hasAnyRole(PATIENT, REG_CLINICIAN)</span>
<span class="fc" id="L150">                .antMatchers(&quot;/admin/**&quot;).hasAnyRole(EMPLOYEE, INSTITUTE_ADMIN, SUPER_ADMIN)</span>
<span class="fc" id="L151">                .antMatchers(&quot;/superadmin/**&quot;).hasAnyRole(SUPER_ADMIN)</span>
<span class="fc" id="L152">                .antMatchers(&quot;/orgCoord/**&quot;).hasAnyRole(ORG_COORD)</span>
<span class="fc" id="L153">                .antMatchers(&quot;/employee/**&quot;).hasAnyRole(EMPLOYEE)</span>
<span class="fc" id="L154">                .antMatchers(&quot;/media/**&quot;).hasAnyRole(PATIENT, REG_CLINICIAN)</span>
<span class="fc" id="L155">                .antMatchers(&quot;/allergies/**&quot;).hasAnyRole(PATIENT, REG_CLINICIAN)</span>
<span class="fc" id="L156">                .antMatchers(&quot;/diagnoses/**&quot;).hasAnyRole(PATIENT, REG_CLINICIAN)</span>
<span class="fc" id="L157">                .antMatchers(&quot;/devices/**&quot;).hasAnyRole(PATIENT, REG_CLINICIAN)</span>
<span class="fc" id="L158">                .antMatchers(&quot;/library/**&quot;).hasAnyRole(EMPLOYEE, PATIENT, CLINICIAN, REG_CLINICIAN, INSTITUTE_ADMIN, SUPER_ADMIN)</span>
<span class="fc" id="L159">                .antMatchers(&quot;/pregnancy/**&quot;).hasAnyRole(PATIENT, REG_CLINICIAN)</span>
<span class="fc" id="L160">                .antMatchers(&quot;/pkbNhs*Menu.action&quot;).hasAnyRole(PATIENT) // NHS App-specific screens only accessible by patient</span>
<span class="fc" id="L161">                .and()</span>
<span class="fc" id="L162">                .requiresChannel()</span>
<span class="fc" id="L163">                .antMatchers(&quot;/auth/**&quot;, &quot;/notification&quot;, &quot;/pkb/notification&quot;, &quot;/notificationReturn.action&quot;, &quot;/pkb/notificationReturn.action&quot;, &quot;/*.jsp&quot;, &quot;/*.action&quot;)</span>
<span class="fc" id="L164">                .requires(ANY_CHANNEL)</span>
<span class="fc" id="L165">                .and()</span>
<span class="fc" id="L166">                .logout()</span>
<span class="fc" id="L167">                .invalidateHttpSession(true)</span>
<span class="fc" id="L168">                .logoutUrl(&quot;/signoutRedirect.action&quot;)</span>
<span class="fc" id="L169">                .logoutSuccessHandler(new LogoutSuccessHandler())</span>
<span class="fc" id="L170">                .and()</span>
<span class="fc" id="L171">                .requestCache()</span>
<span class="fc" id="L172">                .and()</span>
<span class="fc" id="L173">                .anonymous()</span>
<span class="fc" id="L174">                .and()</span>
<span class="fc" id="L175">                .addFilterBefore(ssoAuthenticationFilter, UsernamePasswordAuthenticationFilter.class)</span>
<span class="fc" id="L176">                .addFilterBefore(nhsLoginAuthenticationFilter, UsernamePasswordAuthenticationFilter.class)</span>
<span class="fc" id="L177">                .addFilterBefore(defaultCacheHeadersFilter, ChannelProcessingFilter.class)</span>
<span class="fc" id="L178">                .addFilterBefore(apiTokenCorsHeadersFilter, ChannelProcessingFilter.class)</span>
<span class="fc" id="L179">                .addFilterBefore(referrerPolicyHeaderFilter, ChannelProcessingFilter.class)</span>
<span class="fc" id="L180">                .addFilter(customizedFormLoginFilter)   // position=&quot;FORM_LOGIN_FILTER&quot;</span>
<span class="fc" id="L181">                .addFilterAfter(sessionCheckFilter, SwitchUserFilter.class);</span>
<span class="fc" id="L182">    }</span>

    private void initPortMapper(HttpSecurity http) throws Exception {
<span class="fc" id="L185">        http.portMapper().http(portMappingHttp).mapsTo(portMappingHttps).init(http);</span>
<span class="fc" id="L186">    }</span>

    private void initPortResolver(HttpSecurity http) throws Exception {
<span class="fc" id="L189">        PortMapper portMapper = http.getSharedObject(PortMapper.class);</span>
<span class="fc" id="L190">        PortResolverImpl portResolver = new PortResolverImpl();</span>
<span class="fc" id="L191">        portResolver.setPortMapper(portMapper);</span>
<span class="fc" id="L192">        http.setSharedObject(PortResolver.class, portResolver);</span>
<span class="fc" id="L193">    }</span>

    private void initRequestCache(HttpSecurity http) throws Exception {
<span class="fc" id="L196">        http.requestCache().init(http);</span>
<span class="fc" id="L197">        HttpSessionRequestCache requestCache = (HttpSessionRequestCache) http.getSharedObject(RequestCache.class);</span>
<span class="fc" id="L198">        requestCache.setCreateSessionAllowed(false);</span>
<span class="fc" id="L199">        requestCache.setPortResolver(http.getSharedObject(PortResolver.class));</span>
<span class="fc" id="L200">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>