<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PkbManagerConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">config</a> &gt; <span class="el_source">PkbManagerConfig.java</span></div><h1>PkbManagerConfig.java</h1><pre class="source lang-java linenums">package config;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.dataformat.xml.XmlMapper;
import com.fasterxml.jackson.datatype.guava.GuavaModule;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import com.fasterxml.jackson.datatype.jsr310.deser.LocalDateDeserializer;
import com.pkb.allergy.entity.Allergy;
import com.pkb.api.internal.messaging.PKBPersonToMessagingPKBPersonDTOConverter;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.common.testlogging.DetailLoggingProvider;
import com.pkb.config.DomainConfig;
import com.pkb.datamodel.entity.mapper.LocalDateTimeMapper;
import com.pkb.datamodel.entity.mapper.UserTypeToScopeMapper;
import com.pkb.diagnosis.entity.Diagnosis;
import com.pkb.domain.AccountService;
import com.pkb.domain.AccountUserService;
import com.pkb.domain.AffiliateService;
import com.pkb.domain.ApiAuthService;
import com.pkb.domain.CoreDevicesCredentialsService;
import com.pkb.domain.CryptoModelSynchronisationService;
import com.pkb.domain.Hl7PartnerService;
import com.pkb.domain.IdentityVerificationService;
import com.pkb.domain.InvitationService;
import com.pkb.domain.LoginAttemptLogService;
import com.pkb.domain.NationalIdService;
import com.pkb.domain.OrgLevelIdService;
import com.pkb.domain.OrgNetworkService;
import com.pkb.domain.PHPlanTemplateService;
import com.pkb.domain.ParticipantService;
import com.pkb.domain.PersonContactService;
import com.pkb.domain.PkbPasswordRecoveryService;
import com.pkb.domain.ReferenceDatumService;
import com.pkb.domain.RegistrationEventService;
import com.pkb.domain.SSOService;
import com.pkb.domain.SciStoreService;
import com.pkb.domain.TeamExportService;
import com.pkb.domain.TeamLevelIdService;
import com.pkb.domain.TeamResearchPartnerService;
import com.pkb.domain.UnreadableDocumentService;
import com.pkb.domain.UploadedDataDomainService;
import com.pkb.domain.UserCredentialsService;
import com.pkb.domain.consent.ConsentService;
import com.pkb.domain.duplicate.TeamDomainService;
import com.pkb.domain.duplicate.person.PersonService;
import com.pkb.domain.messages.workflow.TrustedConversationWorkflowService;
import com.pkb.domain.nhs.NhsAppNotificationLogService;
import com.pkb.domain.provider.PKBSpecialtyService;
import com.pkb.domain.provider.PersonSpecialtyService;
import com.pkb.emis.es.entity.EmisEsObservationDelta;
import com.pkb.entities.enums.MenuDataType;
import com.pkb.filesanitizer.FileSanitizer;
import com.pkb.integration.coredevices.CoreDevicesClient;
import com.pkb.integration.nhs.NhsApiAuthenticationClient;
import com.pkb.integration.nhs.NhsAppNotificationClient;
import com.pkb.integration.nhs.mapper.ErrorResponseMapper;
import com.pkb.integration.sciStore.ISciStoreClient;
import com.pkb.integration.socialcare.PathfindersProxyClient;
import com.pkb.kms.client.core.Kms;
import com.pkb.mappers.AccountPrivateKeyMapper;
import com.pkb.mappers.DocAttachToAttachmentMapper;
import com.pkb.mappers.PKBInvitationMapper;
import com.pkb.mappers.SourceDetailsMapper;
import com.pkb.mappers.TeamResearchPartnerMapper;
import com.pkb.medication.entity.Medication;
import com.pkb.patient.LetterInvitationMetrics;
import com.pkb.patient.PatientActivationManager;
import com.pkb.questionnaireservice.client.QuestionnaireResponseClient;
import com.pkb.questionnaireservice.client.QuestionnaireResponseClientImpl;
import com.pkb.questionnaireservice.client.QuestionnaireServiceClient;
import com.pkb.questionnaireservice.client.QuestionnaireServiceClientImpl;
import com.pkb.repository.MenuDataRepository;
import com.pkb.repository.legacy.LegacyAccountUserRepository;
import com.pkb.repository.legacy.LegacyAttachmentRepository;
import com.pkb.repository.legacy.LegacyAuditLogRepository;
import com.pkb.repository.legacy.LegacyBreakTheGlassLogRepository;
import com.pkb.repository.legacy.LegacyCodeRepository;
import com.pkb.repository.legacy.LegacyCodingMatchRepository;
import com.pkb.repository.legacy.LegacyCodingReceivedRepository;
import com.pkb.repository.legacy.LegacyDocAttachRepository;
import com.pkb.repository.legacy.LegacyDocGcsDeleteQueueRepository;
import com.pkb.repository.legacy.LegacyDocumentMetadataRepository;
import com.pkb.repository.legacy.LegacyEncounterRepository;
import com.pkb.repository.legacy.LegacyEncounterToAppointmentLinkRepository;
import com.pkb.repository.legacy.LegacyGcsDeleteQueueRepository;
import com.pkb.repository.legacy.LegacyGcsFallbackDocRepository;
import com.pkb.repository.legacy.LegacyIdentityVerificationRepository;
import com.pkb.repository.legacy.LegacyInstituteLibraryEntryRepository;
import com.pkb.repository.legacy.LegacyInstituteUserRepository;
import com.pkb.repository.legacy.LegacyLoincCommonFormLoincTestRepository;
import com.pkb.repository.legacy.LegacyLoincCommonFormRepository;
import com.pkb.repository.legacy.LegacyLoincMappingRepository;
import com.pkb.repository.legacy.LegacyLoincTestRepository;
import com.pkb.repository.legacy.LegacyOrgRepository;
import com.pkb.repository.legacy.LegacyPHPlanTemplateRepository;
import com.pkb.repository.legacy.LegacyPKBPersonRepository;
import com.pkb.repository.legacy.LegacyPatientConsentRepository;
import com.pkb.repository.legacy.LegacyPersonContactRepository;
import com.pkb.repository.legacy.LegacySymptomReportRepository;
import com.pkb.repository.legacy.LegacyTeamRepository;
import com.pkb.repository.legacy.LegacyUploadInProgressRepository;
import com.pkb.repository.legacy.LegacyUploadedDataRepository;
import com.pkb.service.allergy.impl.AllergyManager;
import com.pkb.service.allergy.impl.EHRAllergyManager;
import com.pkb.service.calendar.impl.AppointmentService;
import com.pkb.service.calendar.impl.CalendarManager;
import com.pkb.service.code.CodeManager;
import com.pkb.service.coding.CodingManager;
import com.pkb.service.config.SupportConfig;
import com.pkb.service.datapoint.impl.DataPointManager;
import com.pkb.service.dataupload.emis.esv2.EmisEsManager;
import com.pkb.service.dataupload.hl7.HL7ParsingManager;
import com.pkb.service.dataupload.impl.DataUploadManager;
import com.pkb.service.dataupload.processor.UploadedDataService;
import com.pkb.service.devices.coredevices.CoreDevicesManager;
import com.pkb.service.diagnosis.DiagnosisManager;
import com.pkb.service.diagnosis.EHRDiagnosisManager;
import com.pkb.service.diary.DiaryManager;
import com.pkb.service.document.AttachmentManager;
import com.pkb.service.document.DocumentManager;
import com.pkb.service.document.GCSDocumentStore;
import com.pkb.service.document.GcsFallbackDocumentStore;
import com.pkb.service.document.storage.DocumentStorageFactory;
import com.pkb.service.document.storage.GCSDocumentStoreImpl;
import com.pkb.service.document.storage.GcsFallbackDocumentStoreImpl;
import com.pkb.service.document.storage.gcs.RealStorageProvider;
import com.pkb.service.ehr.DeduplicatorManager;
import com.pkb.service.ehrrequestcontext.EHRRequestContextManager;
import com.pkb.service.emailmessage.IAddressInfoProvider;
import com.pkb.service.emailmessage.impl.EmailManager;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.emailmessage.impl.TemplateParamsFactory;
import com.pkb.service.emailmessage.sender.impl.VelocityTemplateHandler;
import com.pkb.service.emis.EmisEsObservationDeltaManager;
import com.pkb.service.encounter.impl.tolven.EncounterManager;
import com.pkb.service.encounter.workflow.ConversationWorkflowConverter;
import com.pkb.service.file.ChunkedDocManager;
import com.pkb.service.file.DocumentMigrationManager;
import com.pkb.service.file.FileManager;
import com.pkb.service.file.GcsDocumentDeletionManager;
import com.pkb.service.file.OrphanedGcsDocumentDeletionManager;
import com.pkb.service.institutelibraryentry.InstituteLibraryEntryManager;
import com.pkb.service.instituteuser.InstituteUserManager;
import com.pkb.service.integration.DatapointExternalIntegrationUrlService;
import com.pkb.service.integration.SciStoreManager;
import com.pkb.service.invitation.impl.InvitationManager;
import com.pkb.service.invitation.impl.InvitationManagerHelper;
import com.pkb.service.invitation.impl.InvitationOperationManager;
import com.pkb.service.invitation.impl.LetterInvitationManager;
import com.pkb.service.invitation.impl.LetterInvitationService;
import com.pkb.service.invitation.impl.LetterInvitationUtility;
import com.pkb.service.invitation.impl.LetterInvitationValidator;
import com.pkb.service.measurement.EHRMeasurementManager;
import com.pkb.service.medication.EHRMedicationManager;
import com.pkb.service.medication.MedicationManager;
import com.pkb.service.nhslogin.impl.NhsLoginRegistrationManager;
import com.pkb.service.notification.impl.tolven.INotificationManager;
import com.pkb.service.notification.impl.tolven.NotificationManager;
import com.pkb.service.notification.nhs.AuthenticatingTokenSupplier;
import com.pkb.service.notification.nhs.GuavaCacheAccessTokenSupplier;
import com.pkb.service.notification.nhs.JwtSupplier;
import com.pkb.service.notification.nhs.NhsAppNotificationLogManager;
import com.pkb.service.notification.nhs.NhsAppNotificationManager;
import com.pkb.service.notification.nhs.NhsAppNotificationSender;
import com.pkb.service.notification.nhs.NhsAuthenticator;
import com.pkb.service.oauth2.NhsLoginService;
import com.pkb.service.patientconsent.DeprecatedPatientConsentManager;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.personallibrary.PersonalLibraryManager;
import com.pkb.service.phplan.LegacyPlanTemplateManager;
import com.pkb.service.phplan.ParticipantManager;
import com.pkb.service.phplan.PhPlanSaver;
import com.pkb.service.phplan.PhPlanXhtmlValidator;
import com.pkb.service.phplan.PlanAttachmentManager;
import com.pkb.service.phplan.PlanExportManager;
import com.pkb.service.phplan.PlanManager;
import com.pkb.service.phplan.PlanTemplateManager;
import com.pkb.service.privacy.PrivacyFlagsConverter;
import com.pkb.service.questionnaire.QuestionnaireDefinitionCsvExporter;
import com.pkb.service.questionnaire.QuestionnaireManager;
import com.pkb.service.questionnaire.QuestionnaireResultsCsvExporter;
import com.pkb.service.radiology.RadiologyManager;
import com.pkb.service.radiology.RadiologyPersistManager;
import com.pkb.service.reference.ReferenceDataManager;
import com.pkb.service.reminders.ReminderManager;
import com.pkb.service.sso.impl.emis.EMISSSOAuthManager;
import com.pkb.service.state.InternalStateManager;
import com.pkb.service.symptom.SymptomReportManager;
import com.pkb.service.team.AffiliateManager;
import com.pkb.service.team.OrgManager;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.test.EHRTestManager;
import com.pkb.service.test.LoincManager;
import com.pkb.service.test.MeasurementManager;
import com.pkb.service.test.MeasurementUtil;
import com.pkb.service.test.PathologyReportManager;
import com.pkb.service.test.TestManager;
import com.pkb.service.user.impl.ApiAuthManager;
import com.pkb.service.user.impl.AuditLogManager;
import com.pkb.service.user.impl.EmailSyncManager;
import com.pkb.service.user.impl.PersonContactManager;
import com.pkb.service.user.impl.PrimaryEmailContactManager;
import com.pkb.service.user.impl.UserAccessManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.service.virusscan.ClamAvStreamScanner;
import com.pkb.service.virusscan.NoopStreamScanner;
import com.pkb.service.virusscan.StreamScanner;
import com.pkb.test.entity.MeasurementDTO;
import com.pkb.test.entity.TestResultDTO;
import com.pkb.testdatagenerator.ITestDataGenerator;
import com.pkb.testdatagenerator.impl.TestDataGenerator;
import com.pkb.user.entity.PKBPersonHelper;
import com.pkb.util.CorrelationIdUtil;
import com.pkb.util.UncheckedCsvPrinter;
import com.pkb.util.security.FileSecurityHandler;
import com.pkb.util.security.PdfValidator;
import com.pkb.util.tolven.ConvertUtil;
import com.pkb.util.tolven.TolvenBeanFactory;
import io.micrometer.core.instrument.Metrics;
import okhttp3.OkHttpClient;
import org.apache.camel.ProducerTemplate;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.Lazy;
import org.springframework.core.env.Environment;
import org.springframework.http.client.reactive.ReactorClientHttpConnector;
import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;
import org.springframework.web.reactive.function.client.WebClient;
import reactor.netty.http.client.HttpClient;
import reactor.netty.resources.ConnectionProvider;
import retrofit2.Retrofit;
import retrofit2.converter.jackson.JacksonConverterFactory;

import java.time.Duration;
import java.time.LocalDate;

import static com.fasterxml.jackson.databind.DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES;
import static com.fasterxml.jackson.databind.MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES;
import static java.time.format.DateTimeFormatter.ofPattern;
import static java.util.concurrent.TimeUnit.SECONDS;

@SuppressWarnings(&quot;ClassWithTooManyMethods&quot;)
@Configuration
@Import({
        PkbBeansConfig.class,
        DomainConfig.class,
        SupportConfig.class,
        InternalMessagingConfig.class,
        VelocityTemplateHandlerConfig.class
})
<span class="fc" id="L256">public class PkbManagerConfig {</span>

    @Bean
    public TeamManager teamManager(TolvenBeanFactory beanFactory, PhrConfig config, DateTimeService dateTimeService,
                                   UUIDProvider uuidProvider, TeamResearchPartnerService teamResearchPartnerService,
                                   TeamResearchPartnerMapper teamResearchPartnerMapper, TeamDomainService teamDomainService,
                                   LegacyTeamRepository teamRepository, LegacyInstituteUserRepository instituteUserRepository,
                                   InstituteUserManager instituteUserManager, LegacyOrgRepository orgRepository) {
<span class="fc" id="L264">        return new TeamManager(config, beanFactory, dateTimeService, uuidProvider, teamResearchPartnerService,</span>
                teamResearchPartnerMapper, teamDomainService, teamRepository, instituteUserRepository, instituteUserManager,
                orgRepository);
    }

    @Bean
    public UserManager userManager(
            TolvenBeanFactory beanFactory,
            PersonContactManager personContactManager,
            PhrConfig config,
            DateTimeService dateTimeService,
            ConvertUtil convertUtil,
            UUIDProvider uuidProvider,
            Kms kmsClient,
            PathfindersProxyClient pathfindersClient,
            PersonService patientService,
            PKBSpecialtyService PKBSpecialtyService,
            PersonSpecialtyService personSpecialtyService,
            AccountUserService accountUserService,
            AccountService accountService,
            PkbPasswordRecoveryService passwordRecoveryService,
            UserCredentialsService userCredentialsService,
            IdentityVerificationService identityVerificationService,
            CryptoModelSynchronisationService cryptoModelSynchronisationService,
            ApiAuthService apiAuthService,
            InstituteUserManager instituteUserManager,
            LegacyTeamRepository teamRepository,
            DocumentManager documentManager) {
<span class="fc" id="L292">        return new UserManager(config, beanFactory, dateTimeService, uuidProvider, patientService, personContactManager,</span>
                convertUtil, kmsClient, pathfindersClient, PKBSpecialtyService, personSpecialtyService,
                accountUserService, accountService, passwordRecoveryService, userCredentialsService,
                identityVerificationService, cryptoModelSynchronisationService, apiAuthService,
                instituteUserManager, teamRepository, documentManager);
    }

    @Bean
    public TeamUserManager teamUserManager(
            PhrConfig config,
            TolvenBeanFactory beanFactory,
            DateTimeService dateTimeService,
            UUIDProvider uuidProvider,
            UserManager userManager,
            TeamManager teamManager,
            PersonContactManager personContactManager,
            InvitationOperationManager invitationOperationManager,
            UserCredentialsService userCredentialsService,
            IdentityVerificationService identityVerificationService,
            TeamExportService teamExportService,
            ConsentService consentService,
            CryptoModelSynchronisationService cryptoModelSynchronisationService,
            ApiAuthService apiAuthService,
            PersonService personService,
            LegacyTeamRepository teamRepository,
            LegacyBreakTheGlassLogRepository breakTheGlassLogRepository,
            LegacyPKBPersonRepository pkbPersonRepository,
            DocumentManager documentManager, Kms kms,
            InstituteUserManager instituteUserManager,
            @Lazy OrgManager orgManager) {
<span class="fc" id="L322">        return new TeamUserManager(config, beanFactory, dateTimeService, uuidProvider, userManager, teamManager,</span>
                personContactManager, invitationOperationManager, userCredentialsService, identityVerificationService,
                teamExportService, consentService, cryptoModelSynchronisationService, apiAuthService,
                personService,  teamRepository, breakTheGlassLogRepository,
                pkbPersonRepository, documentManager, kms, instituteUserManager, orgManager);
    }

    @Bean
    public FileSanitizer fileSanitizer() {
<span class="fc" id="L331">        return new FileSanitizer();</span>
    }

    @Bean
    public PdfValidator pdfValidator(UUIDProvider uuidProvider) {
<span class="fc" id="L336">        return new PdfValidator(uuidProvider);</span>
    }

    @Bean
    public ParticipantManager participantManager(
            TolvenBeanFactory beanFactory,
            TeamUserManager teamUserManager,
            PhrConfig config,
            DateTimeService dateTimeService,
            UUIDProvider uuidProvider,
            ParticipantService participantService) {
<span class="fc" id="L347">        return new ParticipantManager(config, beanFactory, dateTimeService, uuidProvider, teamUserManager, participantService);</span>
    }

    @Bean
    public PersonContactManager personContactManager(TolvenBeanFactory beanFactory, PhrConfig config,
                                                     DateTimeService dateTimeService, UUIDProvider uuidProvider,
                                                     LegacyPersonContactRepository personContactRepository) {
<span class="fc" id="L354">        return new PersonContactManager(config, beanFactory, dateTimeService, uuidProvider, personContactRepository);</span>
    }

    @Bean
    public UserAccessManager userAccessManager(TolvenBeanFactory beanFactory, DateTimeService dateTimeService, PhrConfig config,
                                               UUIDProvider uuidProvider, TrustedConversationWorkflowService trustedConversationWorkflowService,
                                               UserManager userManager, TeamUserManager teamUserManager,
                                               CryptoModelSynchronisationService cryptoModelSynchronisationService,
                                               InstituteUserManager instituteUserManager,
                                               DocumentManager documentManager,
                                               Kms kms, AccountService accountService, PKBEmailMessageManager emailMessageManager,
                                               CorrelationIdUtil correlationIdUtil, LegacyOrgRepository orgRepository, PersonService personService) {
<span class="fc" id="L366">        return new UserAccessManager(config, beanFactory, dateTimeService, uuidProvider,</span>
                trustedConversationWorkflowService, userManager, teamUserManager,
                cryptoModelSynchronisationService, instituteUserManager, documentManager, kms, accountService, emailMessageManager, correlationIdUtil,
                orgRepository, personService);
    }

    @Bean
    public ApiAuthManager apiAuthManager(TolvenBeanFactory beanFactory, PhrConfig config, DateTimeService dateTimeService, UUIDProvider uuidProvider, ApiAuthService apiAuthService) {
<span class="fc" id="L374">        return new ApiAuthManager(config, beanFactory, dateTimeService, uuidProvider, apiAuthService);</span>
    }

    @Bean
    public CoreDevicesClient coreDevicesClient(PhrConfig config) {
<span class="fc" id="L379">        CoreDevicesClient client = new CoreDevicesClient();</span>
<span class="fc" id="L380">        client.setConfig(config);</span>
<span class="fc" id="L381">        return client;</span>
    }

    @Bean
    public CoreDevicesManager coreDevicesManager(
            TolvenBeanFactory beanFactory,
            CoreDevicesClient coreDevicesClient,
            PhrConfig config, DateTimeService dateTimeService, UUIDProvider uuidProvider, UploadedDataService uploadedDataService,
            CoreDevicesCredentialsService coreDevicesCredentialsService) {
<span class="fc" id="L390">        return new CoreDevicesManager(config, beanFactory, dateTimeService, uuidProvider, coreDevicesClient, uploadedDataService, coreDevicesCredentialsService);</span>
    }

    @Bean
    public TestManager testManager(
            TolvenBeanFactory beanFactory,
            UserManager userManager,
            ReferenceDataManager referenceDataManager,
            PhrConfig config,
            DateTimeService dateTimeService, UUIDProvider uuidProvider, UploadedDataService uploadedDataService,
            CoreDevicesManager coreDevicesManager,
            LoincManager loincManager
    ) {
<span class="fc" id="L403">        return new TestManager(config, beanFactory, dateTimeService, uuidProvider, userManager, coreDevicesManager,</span>
                 referenceDataManager, uploadedDataService, loincManager);
    }

    @Bean
    public EncounterManager encounterManager(
            TolvenBeanFactory beanFactory,
            UserManager userManager,
            PKBEmailMessageManager pkbEmailMessageManager,
            PhrConfig config,
            DateTimeService dateTimeService,
            UUIDProvider uuidProvider,
            PlanManager planManager,
            DataUploadManager dataUploadManager,
            ThreadPoolTaskExecutor taskExecutor, UploadedDataService uploadedDataService,
            TrustedConversationWorkflowService trustedConversationWorkflowService,
            TeamManager teamManager, CorrelationIdUtil correlationIdUtil,
            ConversationWorkflowConverter conversationWorkflowConverter, ParticipantManager participantManager,
            UnreadableDocumentService unreadableDocumentService,
            HL7ParsingManager hl7ParsingManager, NhsAppNotificationManager nhsAppNotificationManager,
            PdfValidator pdfValidator, CodeManager codeManager, AttachmentManager attachmentManager,
            PatientConsentManager patientConsentManager, InstituteUserManager instituteUserManager,
            PKBPersonToMessagingPKBPersonDTOConverter pkbPersonDTOConverter, LegacyEncounterRepository encounterRepository,
            LegacyEncounterToAppointmentLinkRepository encounterToAppointmentLinkRepository,
            LegacyLoincTestRepository loincTestRepository,
            LegacyLoincMappingRepository loincMappingRepository,
            ChunkedDocManager chunkedDocManager,
            LegacyTeamRepository teamRepository, LegacyOrgRepository orgRepository, DocumentManager documentManager) {
<span class="fc" id="L431">        return new EncounterManager(config, beanFactory, dateTimeService, uuidProvider, pkbEmailMessageManager, userManager, planManager, dataUploadManager,</span>
                taskExecutor, uploadedDataService, trustedConversationWorkflowService, teamManager, correlationIdUtil, conversationWorkflowConverter, participantManager, unreadableDocumentService,
                hl7ParsingManager, nhsAppNotificationManager, pdfValidator, codeManager, attachmentManager, patientConsentManager, instituteUserManager, pkbPersonDTOConverter,
                encounterRepository, encounterToAppointmentLinkRepository, loincTestRepository, loincMappingRepository, chunkedDocManager, teamRepository, orgRepository, documentManager);
    }

    @Bean
    public ReferenceDataManager referenceDataManager(
            TolvenBeanFactory beanFactory,
            PhrConfig config,
            DateTimeService dateTimeService, UUIDProvider uuidProvider,
            ReferenceDatumService referenceDatumService) {
<span class="fc" id="L443">        return new ReferenceDataManager(config, beanFactory, dateTimeService, uuidProvider, referenceDatumService);</span>
    }

    @Bean
    public NotificationManager notificationManager(
            TolvenBeanFactory beanFactory,
            UserManager userManager,
            PatientConsentManager patientConsentManager,
            EmailManager emailManager,
            IAddressInfoProvider formatter,
            ThreadPoolTaskExecutor taskExecutor,
            PhrConfig config,
            TeamManager teamManager,
            TemplateParamsFactory templateParamsFactory,
            DateTimeService dateTimeService,
            UUIDProvider uuidProvider) {

<span class="fc" id="L460">        return new NotificationManager(config, beanFactory, dateTimeService, uuidProvider,</span>
                emailManager, userManager, teamManager, patientConsentManager, formatter,
                taskExecutor, templateParamsFactory);
    }

    @Bean
    public MedicationManager medicationManager(
            TolvenBeanFactory beanFactory,
            PhrConfig config,
            DateTimeService dateTimeService,
            UUIDProvider uuidProvider,
            UploadedDataService uploadedDataService,
            ChunkedDocManager chunkedDocManager,
            EHRMedicationManager ehrMedicationManager) {
<span class="fc" id="L474">        return new MedicationManager(config, beanFactory, dateTimeService, uuidProvider, uploadedDataService, chunkedDocManager, ehrMedicationManager);</span>
    }

    @Bean
    public DiaryManager diaryManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService,
                                     UUIDProvider uuidProvider, AttachmentManager attachmentManager,
                                     ChunkedDocManager chunkedDocManager) {
<span class="fc" id="L481">        return new DiaryManager(config, beanFactory, dateTimeService, uuidProvider, attachmentManager, chunkedDocManager);</span>
    }

    @Bean
    public SymptomReportManager symptomReportManager(
            TolvenBeanFactory beanFactory,
            UserManager userManager,
            TeamManager teamManager,
            TeamUserManager teamUserManager, PhrConfig config, DateTimeService dateTimeService,
            UUIDProvider uuidProvider, InstituteUserManager instituteUserManager,
            LegacySymptomReportRepository symptomReportRepository, LegacyTeamRepository teamRepository) {
<span class="fc" id="L492">        return new SymptomReportManager(config, beanFactory, dateTimeService, uuidProvider,</span>
                userManager, teamManager, teamUserManager, instituteUserManager, symptomReportRepository,
                teamRepository);
    }

    @Bean
    public StreamScanner streamScanner(PhrConfig config, DetailLoggingProvider detailLoggingProvider) {
<span class="fc" id="L499">        return config.clamAvHost()</span>
<span class="fc" id="L500">                .&lt;StreamScanner&gt;map(h -&gt; new ClamAvStreamScanner(h, detailLoggingProvider))</span>
<span class="fc" id="L501">                .orElseGet(NoopStreamScanner::new);</span>
    }

    @Bean
    public DataUploadManager dataUploadManager(
            TolvenBeanFactory beanFactory,
            PhrConfig config,
            DateTimeService dateTimeService,
            UUIDProvider uuidProvider,
            UploadedDataDomainService uploadedDataService,
            LegacyUploadedDataRepository uploadedDataRepository,
            DocumentManager documentManager) {
<span class="fc" id="L513">        return new DataUploadManager(config, beanFactory, dateTimeService, uuidProvider, uploadedDataService, uploadedDataRepository, documentManager);</span>
    }

    @Bean
    public MeasurementManager measurementManager(
            TolvenBeanFactory beanFactory,
            UserManager userManager,
            TeamUserManager teamUserManager,
            PhrConfig config,
            DateTimeService dateTimeService,
            DetailLoggingProvider testLoggingService,
            UUIDProvider uuidProvider,
            UploadedDataService uploadedDataService,
            MeasurementUtil measurementUtil,
            EHRMeasurementManager ehrMeasurementManager) {
<span class="fc" id="L528">        return new MeasurementManager(config, beanFactory, dateTimeService, uuidProvider, userManager, teamUserManager, testLoggingService, uploadedDataService, measurementUtil, ehrMeasurementManager);</span>
    }

    @Bean
    public ReminderManager reminderManager(TolvenBeanFactory beanFactory, UserManager userManager, PhrConfig config, DateTimeService dateTimeService, UUIDProvider uuidProvider) {
<span class="fc" id="L533">        return new ReminderManager(config, beanFactory, dateTimeService, uuidProvider, userManager);</span>
    }

    @Bean
    public RadiologyManager radiologyManager(
            TolvenBeanFactory beanFactory,
            UserManager userManager,
            PhrConfig config,
            FileSanitizer fileSanitizer,
            DateTimeService dateTimeService, UUIDProvider uuidProvider, UploadedDataService uploadedDataService,
            RadiologyPersistManager radiologyPersistManager, AttachmentManager attachmentManager) {
<span class="fc" id="L544">        return new RadiologyManager(config, beanFactory, dateTimeService, uuidProvider, userManager, fileSanitizer,</span>
                uploadedDataService, radiologyPersistManager, attachmentManager);
    }

    @Bean
    public RadiologyPersistManager radiologyPersistManager(TolvenBeanFactory beanFactory,
                                                           PhrConfig config,
                                                           DateTimeService dateTimeService,
                                                           UUIDProvider uuidProvider,
                                                           ChunkedDocManager chunkedDocManager,
                                                           LegacyTeamRepository teamRepository,
                                                           LegacyOrgRepository orgRepository,
                                                           DocumentManager documentManager) {
<span class="fc" id="L557">        return new RadiologyPersistManager(config, beanFactory, dateTimeService, uuidProvider,</span>
                chunkedDocManager, teamRepository, orgRepository, documentManager);
    }

    @Bean
    public FileManager fileManager(TolvenBeanFactory beanFactory,
                                   UserManager userManager,
                                   PhrConfig config,
                                   DateTimeService dateTimeService,
                                   UUIDProvider uuidProvider,
                                   ChunkedDocManager chunkedDocManager,
                                   DocumentManager documentManager,
                                   PatientConsentManager patientConsentManager) {
<span class="fc" id="L570">        return new FileManager(config, beanFactory, dateTimeService, uuidProvider, userManager, chunkedDocManager, documentManager, patientConsentManager);</span>
    }

    @Bean
    public ChunkedDocManager chunkedDocManager(TolvenBeanFactory beanFactory,
                                               PhrConfig config,
                                               DateTimeService dateTimeService,
                                               UUIDProvider uuidProvider,
                                               LegacyDocAttachRepository docAttachRepository,
                                               LegacyUploadInProgressRepository uploadInProgressRepository,
                                               DocAttachToAttachmentMapper attachmentMapper,
                                               DocumentManager documentManager) {
<span class="fc" id="L582">        return new ChunkedDocManager(config, beanFactory, dateTimeService, uuidProvider, docAttachRepository, uploadInProgressRepository, attachmentMapper, documentManager);</span>
    }

    @Bean
    public PersonalLibraryManager personalLibraryManager(TolvenBeanFactory beanFactory, UserManager userManager,
                                                         PatientConsentManager patientConsentManager, PhrConfig config, DateTimeService dateTimeService, UUIDProvider uuidProvider) {
<span class="fc" id="L588">        return new PersonalLibraryManager(config, beanFactory, dateTimeService, uuidProvider, userManager, patientConsentManager);</span>
    }

    @Bean
    QuestionnaireResultsCsvExporter questionnaireResultsBuilder(QuestionnaireServiceClient qsClient, CorrelationIdUtil correlationIdUtil, UserManager userManager,
                                                                PKBPersonHelper pkbPersonHelper, QuestionnaireResponseClient qsResponseClient, PhrConfig config) {
<span class="fc" id="L594">        return new QuestionnaireResultsCsvExporter(qsClient, correlationIdUtil, userManager, pkbPersonHelper, qsResponseClient, config, new UncheckedCsvPrinter.Factory());</span>
    }

    @Bean
    QuestionnaireDefinitionCsvExporter questionnaireBuilder() {
<span class="fc" id="L599">        return new QuestionnaireDefinitionCsvExporter(new UncheckedCsvPrinter.Factory());</span>
    }

    @Bean
    public QuestionnaireManager questionnaireManager(
            TolvenBeanFactory beanFactory,
            EncounterManager encounterManager,
            PKBEmailMessageManager pkbEmailMessageManager,
            ThreadPoolTaskExecutor taskExecutor,
            DateTimeService dateTimeService,
            PhrConfig config,
            UUIDProvider uuidProvider,
            UserManager userManager,
            TeamUserManager teamUserManager,
            TeamManager teamManager,
            QuestionnaireResultsCsvExporter resultsBuilder,
            QuestionnaireDefinitionCsvExporter questionnaireDefinitionCsvExporter,
            CorrelationIdUtil correlationIdUtil,
            QuestionnaireServiceClient qsClient,
            NhsAppNotificationManager nhsAppNotificationManager,
            VelocityTemplateHandler velocityTemplateHandler,
            DeprecatedPatientConsentManager patientConsentManager) {

<span class="fc" id="L622">        return new QuestionnaireManager(config, beanFactory, dateTimeService, uuidProvider, encounterManager, pkbEmailMessageManager,</span>
                taskExecutor, userManager, teamUserManager, teamManager, resultsBuilder, questionnaireDefinitionCsvExporter, correlationIdUtil,
                qsClient, nhsAppNotificationManager, velocityTemplateHandler, patientConsentManager);
    }

    @Bean
    QuestionnaireServiceClient questionnaireServiceClient(PhrConfig phrConfig,
                                                          OkHttpClient okHttpClient) {
<span class="fc" id="L630">        return new QuestionnaireServiceClientImpl(phrConfig.asyncQuestionnaireResultsAppUrl(),</span>
                okHttpClient);
    }

    @Bean
    QuestionnaireResponseClient questionnaireServiceWebClient(PhrConfig phrConfig) {
        //By default netty uses a connection pool; after a certain time idle, they are closed. If this idle timeout
        //is higher than the idle timeout of the target server, the server can end up closing a connection
        //that's still in the pool and causing weird errors. Newer versions of netty handle this more gracefully i believe
        //but we're tied to the WF version (sigh)
<span class="fc" id="L640">        ConnectionProvider provider =</span>
<span class="fc" id="L641">                ConnectionProvider.builder(&quot;questionnaireService&quot;)</span>
<span class="fc" id="L642">                        .maxIdleTime(Duration.ofSeconds(20)).build();</span>
        //Some of our large requests might take a while to complete (although really they should start streaming well before 5 minutes
<span class="fc" id="L644">        HttpClient httpClient = HttpClient.create(provider).responseTimeout(Duration.ofMinutes(5));</span>
<span class="fc" id="L645">        return new QuestionnaireResponseClientImpl(WebClient.builder().clientConnector(new ReactorClientHttpConnector(httpClient)).baseUrl(phrConfig.asyncQuestionnaireResultsAppUrl()).build());</span>
    }

    @Bean
    public InvitationManager invitationManager(
            TolvenBeanFactory beanFactory,
            PKBEmailMessageManager messagingManager,
            UserManager userManager,
            TeamUserManager teamUserManager,
            PersonContactManager personContactManager,
            PhrConfig config,
            DateTimeService dateTimeService,
            ConvertUtil convertUtil,
            UUIDProvider uuidProvider,
            TeamManager teamManager,
            LetterInvitationService letterInvitationService,
            InvitationService invitationService,
            PKBInvitationMapper pkbInvitationMapper,
            InvitationOperationManager invitationOperationManager,
            InvitationManagerHelper invitationManagerHelper,
            TeamDomainService teamDomainService,
            DocumentManager documentManager,
            InstituteUserManager instituteUserManager,
            PatientConsentManager patientConsentManager) {

<span class="fc" id="L670">        return new InvitationManager(config, beanFactory, dateTimeService, uuidProvider,</span>
                messagingManager, teamUserManager, userManager,
                personContactManager, convertUtil,
                letterInvitationService, invitationService, teamManager,
                pkbInvitationMapper, invitationOperationManager, invitationManagerHelper,
                teamDomainService, documentManager, instituteUserManager, patientConsentManager);
    }

    @Bean
    public InvitationOperationManager invitationOperationManager(
            PhrConfig config,
            TolvenBeanFactory beanFactory,
            DateTimeService dateTimeService,
            UUIDProvider uuidProvider,
            AccountPrivateKeyMapper accountPrivateKeyMapper,
            InvitationService invitationService,
            InvitationManagerHelper invitationManagerHelper) {
<span class="fc" id="L687">        return new InvitationOperationManager(config, beanFactory, dateTimeService, uuidProvider, accountPrivateKeyMapper, invitationService, invitationManagerHelper);</span>
    }

    @Bean
    public InvitationManagerHelper invitationManagerHelper(PKBInvitationMapper pkbInvitationMapper) {
<span class="fc" id="L692">        return new InvitationManagerHelper(pkbInvitationMapper);</span>
    }

    @Bean
    public AffiliateManager affiliateManager(TolvenBeanFactory beanFactory, PhrConfig config, DateTimeService dateTimeService, UUIDProvider uuidProvider, AffiliateService affiliateService) {
<span class="fc" id="L697">        return new AffiliateManager(config, beanFactory, dateTimeService, uuidProvider, affiliateService);</span>
    }

    @Bean
    public AllergyManager allergyManager(
            TolvenBeanFactory beanFactory,
            PhrConfig config,
            DateTimeService dateTimeService,
            UUIDProvider uuidProvider,
            UploadedDataService uploadedDataService,
            EmisEsManager emisEsManager,
            EHRAllergyManager ehrAllergyManager) {
<span class="fc" id="L709">        return new AllergyManager(config, beanFactory, dateTimeService, uuidProvider, emisEsManager, uploadedDataService, ehrAllergyManager);</span>
    }

    @Bean
    public DiagnosisManager diagnosisManager(
            TolvenBeanFactory beanFactory,
            PhrConfig config,
            DateTimeService dateTimeService, UUIDProvider uuidProvider,
            UploadedDataService uploadedDataService,
            EmisEsManager emisEsManager,
            CodeManager codeManager,
            EHRDiagnosisManager ehrDiagnosisManager) {
<span class="fc" id="L721">        return new DiagnosisManager(config, beanFactory, dateTimeService, uuidProvider, emisEsManager, uploadedDataService, codeManager, ehrDiagnosisManager);</span>
    }

    @Bean
    public EHRRequestContextManager ehrRequestContextManager(TeamManager teamManager, PatientConsentManager patientConsentManager, UserManager userManager) {
<span class="fc" id="L726">        return new EHRRequestContextManager(teamManager, patientConsentManager, userManager);</span>
    }

    @Bean
    public CalendarManager calendarManager(
            TolvenBeanFactory beanFactory,
            UserManager userManager, PhrConfig config,
            DateTimeService dateTimeService, UUIDProvider uuidProvider,
            AppointmentService appointmentService,
            UploadedDataService uploadedDataService,
            EncounterManager encounterManager,
            ReferenceDatumService referenceDatumService,
            DatapointExternalIntegrationUrlService datapointExternalIntegrationUrlService) {
<span class="fc" id="L739">        return new CalendarManager(config, beanFactory, dateTimeService, uuidProvider, userManager, encounterManager, appointmentService,</span>
                uploadedDataService, referenceDatumService, datapointExternalIntegrationUrlService);
    }

    @Bean
    public PlanTemplateManager planTemplateManager(TolvenBeanFactory beanFactory, PhrConfig config, DateTimeService dateTimeService,
                                                   UUIDProvider uuidProvider, PHPlanTemplateService phPlanTemplateService,
                                                   TeamDomainService teamDomainService, LegacyPlanTemplateManager templateManager) {
<span class="fc" id="L747">        return new PlanTemplateManager(config, beanFactory, dateTimeService, uuidProvider, phPlanTemplateService, teamDomainService, templateManager);</span>
    }

    @Bean
    public LegacyPlanTemplateManager legacyPlanTemplateManager(TolvenBeanFactory beanFactory, PhrConfig config, DateTimeService dateTimeService,
                                                               UUIDProvider uuidProvider, LegacyPHPlanTemplateRepository phPlanTemplateRepository) {
<span class="fc" id="L753">        return new LegacyPlanTemplateManager(config, beanFactory, dateTimeService, uuidProvider, phPlanTemplateRepository);</span>
    }

    @Bean
    public PlanManager planManager(
            TolvenBeanFactory beanFactory,
            PlanTemplateManager planTemplateManager,
            UserManager userManager,
            PhrConfig config,
            DateTimeService dateTimeService,
            UUIDProvider uuidProvider,
            UploadedDataService uploadedDataService,
            PhPlanSaver phPlanSaver,
            PhPlanXhtmlValidator phPlanXhtmlValidator,
            ParticipantService participantService,
            ChunkedDocManager chunkedDocManager,
            PlanAttachmentManager planAttachmentManager) {
<span class="fc" id="L770">        return new PlanManager(config, beanFactory, dateTimeService, uuidProvider, planTemplateManager, userManager,</span>
                phPlanXhtmlValidator, uploadedDataService, phPlanSaver, participantService, chunkedDocManager,
                planAttachmentManager);
    }

    @Bean
    public PlanAttachmentManager planAttachmentManager(PhrConfig config,
                                                       TolvenBeanFactory beanFactory,
                                                       DateTimeService dateTimeService,
                                                       UUIDProvider uuidProvider,
                                                       ChunkedDocManager chunkedDocManager,
                                                       DocumentManager documentManager) {
<span class="fc" id="L782">        return new PlanAttachmentManager(config, beanFactory, dateTimeService, uuidProvider, chunkedDocManager, documentManager);</span>
    }

    @Bean
    public PlanExportManager planExportManager(
            TolvenBeanFactory beanFactory, PhrConfig config, DateTimeService dateTimeService, UUIDProvider uuidProvider, LegacyPlanTemplateManager planTemplateManager, DocumentManager documentManager) {

<span class="fc" id="L789">        return new PlanExportManager(config, beanFactory, dateTimeService, uuidProvider, planTemplateManager, documentManager);</span>
    }

    @Bean
    public PathologyReportManager pathologyReportManager(TolvenBeanFactory beanFactory, PhrConfig config, DateTimeService dateTimeService, UUIDProvider uuidProvider) {
<span class="fc" id="L794">        return new PathologyReportManager(config, beanFactory, dateTimeService, uuidProvider);</span>
    }

    @Bean
    public SciStoreManager sciStoreManager(
            TolvenBeanFactory beanFactory,
            UserManager userManager,
            DataUploadManager dataUploadManager,
            TestManager testManager,
            TeamUserManager teamUserManager,
            INotificationManager notificationManager,
            ISciStoreClient sciStoreClient,
            PhrConfig config, DateTimeService dateTimeService, UUIDProvider uuidProvider,
            SciStoreService sciStoreService,
            LoincManager loincManager) {

<span class="fc" id="L810">        return new SciStoreManager(config, beanFactory, dateTimeService, uuidProvider, sciStoreClient, userManager,</span>
                dataUploadManager, testManager, teamUserManager, notificationManager, sciStoreService, loincManager);
    }

    @Bean
    public @SuppressWarnings(&quot;deprecation&quot;)
    DeprecatedPatientConsentManager deprecatedPatientConsentManager(
            DateTimeService dateTimeService,
            TolvenBeanFactory beanFactory,
            LegacyPatientConsentRepository patientConsentRepository,
            CryptoModelSynchronisationService cryptoModelSynchronisationService,
            InstituteUserManager instituteUserManager) {
<span class="fc" id="L822">        return new DeprecatedPatientConsentManager(</span>
                dateTimeService, beanFactory, patientConsentRepository,
                cryptoModelSynchronisationService, instituteUserManager);
    }

    @Bean
    public OrgManager orgManager(
            TolvenBeanFactory beanFactory,
            UserManager userManager,
            UserAccessManager userAccessManager,
            TeamManager teamManager,
            TeamUserManager teamUserManager,
            PKBEmailMessageManager pkbEmailMessageManager, PhrConfig config, DateTimeService dateTimeService, UUIDProvider uuidProvider,
            InvitationManager invitationManager, ConsentService consentService, PatientConsentManager patientConsentManager,
            SourceDetailsMapper sourceDetailsMapper, LegacyOrgRepository orgRepository, ChunkedDocManager chunkedDocManager) {
<span class="fc" id="L837">        return new OrgManager(config, beanFactory, dateTimeService, uuidProvider, userManager, teamManager, teamUserManager, pkbEmailMessageManager,</span>
                userAccessManager, invitationManager, consentService, patientConsentManager, sourceDetailsMapper, orgRepository, chunkedDocManager);
    }

    @Bean
    public UserTypeToScopeMapper userTypeToScopeMapper() {
<span class="fc" id="L843">        return new UserTypeToScopeMapper();</span>
    }

    @Bean
    public DataPointManager dataPointManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider, UserManager userManager) {
<span class="fc" id="L848">        return new DataPointManager(config, beanFactory, dateTimeService, uuidProvider, userManager);</span>
    }

    @Bean
    public EmailSyncManager emailSyncManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider,
                                             PersonContactManager contactManager) {
<span class="fc" id="L854">        return new EmailSyncManager(config, beanFactory, dateTimeService, uuidProvider, contactManager);</span>
    }

    @Bean
    public EMISSSOAuthManager ssoAuthManager(TolvenBeanFactory beanFactory, TeamUserManager teamUserManager, PhrConfig config, DateTimeService dateTimeService,
                                             UUIDProvider uuidProvider, SSOService ssoService) {
<span class="fc" id="L860">        return new EMISSSOAuthManager(config, beanFactory, dateTimeService, uuidProvider, teamUserManager, ssoService);</span>
    }

    @Bean
    public PrimaryEmailContactManager primaryEmailContactManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService,
                                                                 UUIDProvider uuidProvider, PatientConsentManager patientConsentManager,
                                                                 PersonContactManager personContactManager) {
<span class="fc" id="L867">        return new PrimaryEmailContactManager(config, beanFactory, dateTimeService, uuidProvider, patientConsentManager, personContactManager);</span>
    }

    @Bean
    public InstituteUserManager instituteUserManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService,
                                                     UUIDProvider uuidProvider, LegacyInstituteUserRepository instituteUserRepository,
                                                     LegacyPKBPersonRepository pkbPersonRepository, LegacyAccountUserRepository accountUserRepository,
                                                     LegacyIdentityVerificationRepository identityVerificationRepository,
                                                     LegacyPKBPersonRepository personRepository, LegacyTeamRepository teamRepository) {
<span class="fc" id="L876">        return new InstituteUserManager(config, beanFactory, dateTimeService, uuidProvider, instituteUserRepository, pkbPersonRepository, accountUserRepository,</span>
                identityVerificationRepository, personRepository, teamRepository);
    }

    @Bean
    public FileSecurityHandler fileSecurityHandler(FileSanitizer fileSanitizer, StreamScanner streamScanner) {
<span class="fc" id="L882">        return new FileSecurityHandler(fileSanitizer, streamScanner);</span>
    }

    @Bean
    PrivacyFlagsConverter PrivacyFlagsConverter(DateTimeService dateTimeService) {
<span class="fc" id="L887">        PrivacyFlagsConverter privacyFlagsConverter = new PrivacyFlagsConverter();</span>
<span class="fc" id="L888">        privacyFlagsConverter.setDateTimeService(dateTimeService);</span>
<span class="fc" id="L889">        return privacyFlagsConverter;</span>
    }

    @Bean
    public PatientActivationManager patientActivationService(
            TolvenBeanFactory beanFactory,
            LetterInvitationMetrics letterInvitationMetrics,
            PKBEmailMessageManager messagingManager,
            NhsLoginService nhsLoginService,
            PhrConfig config,
            DateTimeService dateTimeService,
            UUIDProvider uuidProvider,
            PersonService personService,
            RegistrationEventService registrationEventService,
            LetterInvitationService invitationService,
            TeamManager teamManager) {
<span class="fc" id="L905">        return new PatientActivationManager(letterInvitationMetrics, messagingManager, invitationService, beanFactory.getPKBPersonBean(),</span>
                nhsLoginService, config, dateTimeService, uuidProvider, beanFactory, personService, registrationEventService, teamManager);
    }

    @Bean
    public NhsLoginService nhsLoginService(
            AccountService accountService,
            NationalIdService nationalIdService,
            PersonContactService personContactService,
            PersonService personService,
            UserCredentialsService userCredentialsService,
            Kms kmsClient,
            CorrelationIdUtil correlationIdUtil,
            PhrConfig config,
            DateTimeService dateTimeService,
            LocalDateTimeMapper localDateTimeMapper,
            UUIDProvider uuidProvider,
            TolvenBeanFactory beanFactory,
            OrgNetworkService orgNetworkService,
            UserManager userManager) {
<span class="fc" id="L925">        return new NhsLoginService(</span>
                accountService,
                nationalIdService,
                personContactService,
                personService,
                userCredentialsService,
                kmsClient,
                correlationIdUtil,
                config,
                dateTimeService,
                localDateTimeMapper,
                uuidProvider,
                beanFactory,
                orgNetworkService,
                userManager);
    }

    @Bean
    public CorrelationIdUtil correlationIdUtil() {
<span class="fc" id="L944">        return new CorrelationIdUtil();</span>
    }

    @Bean
    ITestDataGenerator testDataGenerator(TolvenBeanFactory tolvenBeanFactory, DateTimeService dateTimeService, TeamUserManager teamUserManager, LoincManager loincManager) {
<span class="fc" id="L949">        return new TestDataGenerator(tolvenBeanFactory, dateTimeService, teamUserManager, loincManager);</span>
    }

    @Bean
    public UUIDProvider uuidProvider() {
<span class="fc" id="L954">        return new UUIDProvider();</span>
    }

    @Bean
    public PatientConsentManager patientConsentManager(PhrConfig phrConfig, TolvenBeanFactory tolvenBeanFactory,
                                                       DateTimeService dateTimeService, UUIDProvider uuidProvider,
                                                       TeamUserManager teamUserManager,
                                                       ConsentService consentService, SourceDetailsMapper sourceDetailsMapper,
                                                       CryptoModelSynchronisationService cryptoModelSynchronisationService) {
<span class="fc" id="L963">        return new PatientConsentManager(phrConfig, tolvenBeanFactory, dateTimeService, uuidProvider,</span>
                consentService, sourceDetailsMapper,
                cryptoModelSynchronisationService, teamUserManager);
    }

    @Bean
    public PathfindersProxyClient pathfindersClient(
            PhrConfig config,
            OkHttpClient httpClient,
            @Qualifier(&quot;PathfindersProxyXmlMapper&quot;) XmlMapper mapper) {

<span class="fc" id="L974">        OkHttpClient longTimeoutHttpClient = httpClient.newBuilder()</span>
<span class="fc" id="L975">                .readTimeout(60L, SECONDS)</span>
<span class="fc" id="L976">                .build();</span>

<span class="fc" id="L978">        return new Retrofit.Builder()</span>
<span class="fc" id="L979">                .client(longTimeoutHttpClient)</span>
<span class="fc" id="L980">                .baseUrl(config.getPathfindersProxyBaseUrl())</span>
<span class="fc" id="L981">                .addConverterFactory(JacksonConverterFactory.create(mapper))</span>
<span class="fc" id="L982">                .build()</span>
<span class="fc" id="L983">                .create(PathfindersProxyClient.class);</span>
    }

    @Bean(name = &quot;PathfindersProxyXmlMapper&quot;)
    public XmlMapper pathfindersXmlMapper() {
<span class="fc" id="L988">        XmlMapper mapper = new XmlMapper();</span>
<span class="fc" id="L989">        JavaTimeModule javaTimeModule = new JavaTimeModule();</span>
<span class="fc" id="L990">        javaTimeModule.addDeserializer(LocalDate.class, new LocalDateDeserializer(ofPattern(&quot;dd/MM/yyyy&quot;)));</span>
<span class="fc" id="L991">        mapper.registerModule(javaTimeModule);</span>
<span class="fc" id="L992">        mapper.configure(ACCEPT_CASE_INSENSITIVE_PROPERTIES, true);</span>
<span class="fc" id="L993">        mapper.configure(FAIL_ON_UNKNOWN_PROPERTIES, false);</span>
<span class="fc" id="L994">        return mapper;</span>
    }

    @Bean
    public HL7ParsingManager hl7ParsingManager(PhrConfig config, TeamManager teamManager, Hl7PartnerService hl7PartnerService,
                                               DateTimeService dateTimeService, FileSecurityHandler fileSecurityHandler) {
<span class="fc" id="L1000">        return new HL7ParsingManager(config, teamManager, hl7PartnerService, dateTimeService, fileSecurityHandler);</span>
    }

    @Bean
    public NhsLoginRegistrationManager nhsLoginRegistrationManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider,
                                                                   Kms kmsClient, PatientConsentManager patientConsentManager,
                                                                   RegistrationEventService registrationEventService,  UserManager userManager, TeamUserManager teamUserManager,
                                                                   IdentityVerificationService identityVerificationService) {
<span class="fc" id="L1008">        return new NhsLoginRegistrationManager(config, beanFactory, dateTimeService, uuidProvider, kmsClient, patientConsentManager, registrationEventService, teamUserManager,</span>
                userManager, identityVerificationService);
    }

    @Bean
    NhsAuthenticator nhsApiAuthenticator(GuavaCacheAccessTokenSupplier accessTokenSupplier, PhrConfig config) {
<span class="fc" id="L1014">        return new NhsAuthenticator(accessTokenSupplier, config);</span>
    }

    @Bean
    public NhsApiAuthenticationClient nhsApiAuthenticationClient(PhrConfig config,
                                                                 @Qualifier(&quot;DefaultObjectMapper&quot;) ObjectMapper objectMapper,
                                                                 OkHttpClient httpClient) {

<span class="fc" id="L1022">        OkHttpClient authenticatingClient = httpClient.newBuilder()</span>
<span class="fc" id="L1023">                .build();</span>

<span class="fc" id="L1025">        return new Retrofit.Builder()</span>
<span class="fc" id="L1026">                .client(authenticatingClient)</span>
<span class="fc" id="L1027">                .baseUrl(config.getNhsApiBaseUrl())</span>
<span class="fc" id="L1028">                .addConverterFactory(JacksonConverterFactory.create(objectMapper))</span>
<span class="fc" id="L1029">                .build()</span>
<span class="fc" id="L1030">                .create(NhsApiAuthenticationClient.class);</span>
    }

    @Bean
    public NhsAppNotificationClient notificationClient(
            PhrConfig config,
            OkHttpClient httpClient,
            @Qualifier(&quot;DefaultObjectMapper&quot;) ObjectMapper objectMapper,
            NhsAuthenticator authenticator) {

<span class="fc" id="L1040">        OkHttpClient authenticatingClient = httpClient.newBuilder()</span>
<span class="fc" id="L1041">                .authenticator(authenticator)</span>
<span class="fc" id="L1042">                .build();</span>

<span class="fc" id="L1044">        return new Retrofit.Builder()</span>
<span class="fc" id="L1045">                .client(authenticatingClient)</span>
<span class="fc" id="L1046">                .baseUrl(config.getNhsApiBaseUrl())</span>
<span class="fc" id="L1047">                .addConverterFactory(JacksonConverterFactory.create(objectMapper))</span>
<span class="fc" id="L1048">                .build()</span>
<span class="fc" id="L1049">                .create(NhsAppNotificationClient.class);</span>
    }

    @Bean(name = &quot;DefaultObjectMapper&quot;)
    public ObjectMapper objectMapper() {
<span class="fc" id="L1054">        ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="fc" id="L1055">        objectMapper.registerModule(new GuavaModule());</span>
<span class="fc" id="L1056">        return objectMapper;</span>
    }

    @Bean
    public JwtSupplier jwtSupplier(PhrConfig config,
                                   UUIDProvider uuidProvider,
                                   DateTimeService dateTimeService,
                                   Environment environment) {
<span class="fc" id="L1064">        return new JwtSupplier(config, uuidProvider, dateTimeService, environment);</span>
    }

    @Bean
    public AuthenticatingTokenSupplier authenticatingTokenResponseSupplier(NhsApiAuthenticationClient client,
                                                                           JwtSupplier jwtSupplier,
                                                                           ErrorResponseMapper errorResponseMapper,
                                                                           PhrConfig config) {

<span class="fc" id="L1073">        return new AuthenticatingTokenSupplier(client, jwtSupplier, errorResponseMapper, config);</span>
    }

    @Bean
    public GuavaCacheAccessTokenSupplier tokenResponseCache(AuthenticatingTokenSupplier authenticatingTokenSupplier,
                                                            PhrConfig config) {

<span class="fc" id="L1080">        return new GuavaCacheAccessTokenSupplier(authenticatingTokenSupplier, config);</span>
    }

    @Bean
    public NhsAppNotificationLogManager nhsAppNotificationLogManager(NhsAppNotificationLogService nhsAppNotificationLogService) {
<span class="fc" id="L1085">        return new NhsAppNotificationLogManager(nhsAppNotificationLogService);</span>
    }

    @Bean
    public NhsAppNotificationManager nhsNotificationService(LoginAttemptLogService loginAttemptLogService,
                                                            NhsAppNotificationSender nhsAppNotificationSender,
                                                            @Qualifier(&quot;NhsNotificationProducer&quot;) ProducerTemplate nhsNotificationProducer,
                                                            DateTimeService dateTimeService,
                                                            PhrConfig config) {

<span class="fc" id="L1095">        return new NhsAppNotificationManager(loginAttemptLogService,</span>
                nhsAppNotificationSender,
                nhsNotificationProducer,
                dateTimeService,
                config);
    }

    @Bean
    public NhsAppNotificationSender nhsNotificationSender(NhsAppNotificationClient client,
                                                          GuavaCacheAccessTokenSupplier accessTokenSupplier,
                                                          @Qualifier(&quot;NhsNotificationProducer&quot;) ProducerTemplate nhsNotificationProducer,
                                                          ErrorResponseMapper errorResponseMapper,
                                                          PhrConfig config,
                                                          NhsAppNotificationLogManager nhsAppNotificationLogManager,
                                                          ObjectMapper objectMapper) {

<span class="fc" id="L1111">        return new NhsAppNotificationSender(client,</span>
                accessTokenSupplier,
                nhsNotificationProducer,
                errorResponseMapper,
                Metrics.globalRegistry,
                config,
                nhsAppNotificationLogManager,
                objectMapper);
    }

    @Bean
    public ErrorResponseMapper errorResponseMapper(@Qualifier(&quot;DefaultObjectMapper&quot;) ObjectMapper objectMapper) {
<span class="fc" id="L1123">        return new ErrorResponseMapper(objectMapper);</span>
    }

    @Bean
    public LetterInvitationUtility letterInvitationUtility() {
<span class="fc" id="L1128">        return new LetterInvitationUtility();</span>
    }

    @Bean
    public LetterInvitationValidator letterInvitationValidator(NationalIdService nationalIdService, TeamLevelIdService teamLevelIdService,
                                                               OrgLevelIdService orgLevelIdService) {
<span class="fc" id="L1134">        return new LetterInvitationValidator(nationalIdService, teamLevelIdService, orgLevelIdService);</span>
    }

    @Bean
    public LetterInvitationManager defaultInvitationManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider,
                                                            LetterInvitationUtility letterInvitationUtility, com.pkb.domain.LetterInvitationService letterInvitationService,
                                                            LetterInvitationValidator validator, TeamDomainService teamService, UserCredentialsService userCredentialsService,
                                                            AccountUserService accountUserService, AccountPrivateKeyMapper accountPrivateKeyMapper,
                                                            PkbPasswordRecoveryService passwordRecoveryService, PersonContactManager personContactManager,
                                                            UserAccessManager userAccessManager) {
<span class="fc" id="L1144">        return new LetterInvitationManager(config, beanFactory, dateTimeService, uuidProvider, letterInvitationUtility,</span>
                letterInvitationService, validator, teamService, userCredentialsService, accountUserService,
                accountPrivateKeyMapper, passwordRecoveryService, personContactManager, userAccessManager);
    }

    @Bean
    public InternalStateManager internalStateManager(TolvenBeanFactory beanFactory, PhrConfig config,
                                                     DateTimeService dateTimeService, UUIDProvider uuidProvider,
                                                     EncounterManager encounterManager) {
<span class="fc" id="L1153">        return new InternalStateManager(config, beanFactory, dateTimeService, uuidProvider, encounterManager);</span>
    }

    @Bean
    public DocumentMigrationManager documentMigrationManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService,
                                                             UUIDProvider uuidProvider, ThreadPoolTaskExecutor taskExecutor, DocumentManager documentManager) {
<span class="fc" id="L1159">        return new DocumentMigrationManager(config, beanFactory, dateTimeService, uuidProvider, taskExecutor, documentManager);</span>
    }

    @Bean
    public OrphanedGcsDocumentDeletionManager orphanedGcsDocumentDeletionManager(DocumentManager documentManager) {
<span class="fc" id="L1164">        return new OrphanedGcsDocumentDeletionManager(documentManager);</span>
    }

    @Bean
    public GcsDocumentDeletionManager gcsDocumentDeletionManager(TolvenBeanFactory beanFactory,
                                                                 DateTimeService dateTimeService,
                                                                 UUIDProvider uuidProvider,
                                                                 PhrConfig config,
                                                                 DocumentManager documentManager,
                                                                 LegacyDocGcsDeleteQueueRepository docGcsDeleteQueueRepository) {
<span class="fc" id="L1174">        return new GcsDocumentDeletionManager(beanFactory, dateTimeService, uuidProvider, config, documentManager, docGcsDeleteQueueRepository);</span>
    }

    @Bean
    public CodeManager codeManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider, LegacyCodeRepository repository) {
<span class="fc" id="L1179">        return new CodeManager(config, beanFactory, dateTimeService, uuidProvider, repository);</span>
    }

    @Bean
    public AttachmentManager attachmentManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider, LegacyAttachmentRepository repository, DocumentManager documentManager) {
<span class="fc" id="L1184">        return new AttachmentManager(config, beanFactory, dateTimeService, uuidProvider, repository, documentManager);</span>
    }

    @Bean
    public DocumentManager documentManager(PhrConfig config,
                                           TolvenBeanFactory beanFactory,
                                           DateTimeService dateTimeService,
                                           UUIDProvider uuidProvider,
                                           DocumentStorageFactory documentStorageFactory,
                                           LegacyDocumentMetadataRepository metadataRepository,
                                           LegacyGcsDeleteQueueRepository deleteQueueRepository) {
<span class="fc" id="L1195">        return new DocumentManager(config, beanFactory, dateTimeService, uuidProvider, documentStorageFactory, metadataRepository, deleteQueueRepository);</span>
    }

    @Bean
    public RealStorageProvider realStorageProvider(PhrConfig config) {
<span class="fc" id="L1200">        return new RealStorageProvider(config);</span>
    }

    @Bean
    public GCSDocumentStore getGcsDocumentStore(PhrConfig config,
                                                UUIDProvider uuidProvider,
                                                RealStorageProvider storageProvider,
                                                DateTimeService dateTimeService,
                                                LegacyGcsDeleteQueueRepository repository) {
<span class="fc" id="L1209">        return new GCSDocumentStoreImpl(config, uuidProvider, storageProvider, dateTimeService, repository);</span>
    }

    @Bean
    public GcsFallbackDocumentStore getGcsFallbackDocumentStore(UUIDProvider uuidProvider,
                                                                LegacyGcsFallbackDocRepository repository) {
<span class="fc" id="L1215">        return new GcsFallbackDocumentStoreImpl(uuidProvider, repository);</span>
    }

    @Bean
    public DocumentStorageFactory getDocumentStorageFactory(GCSDocumentStore gcsDocumentStore, GcsFallbackDocumentStore gcsFallbackDocumentStore) {
<span class="fc" id="L1220">        return new DocumentStorageFactory(gcsDocumentStore, gcsFallbackDocumentStore);</span>
    }

    @Bean
    public InstituteLibraryEntryManager instituteLibraryEntryManager(TolvenBeanFactory beanFactory, PhrConfig config, DateTimeService dateTimeService,
                                                    UUIDProvider uuidProvider, LegacyInstituteLibraryEntryRepository instituteLibraryEntryRepository) {
<span class="fc" id="L1226">        return new InstituteLibraryEntryManager(config, beanFactory, dateTimeService, uuidProvider, instituteLibraryEntryRepository);</span>
    }

    @Bean
    public LoincManager loincManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider,
                                     LegacyLoincTestRepository loincTestRepository, LegacyLoincCommonFormRepository loincCommonFormRepository,
                                     LegacyLoincCommonFormLoincTestRepository loincCommonFormLoincTestRepository, LegacyLoincMappingRepository loincMappingRepository,
                                     MenuDataRepository menuDataRepository) {
<span class="fc" id="L1234">        return new LoincManager(config, beanFactory, dateTimeService, uuidProvider, loincTestRepository, loincCommonFormRepository, loincCommonFormLoincTestRepository, loincMappingRepository, menuDataRepository);</span>
    }

    @Bean
    public CodingManager codingManager(TolvenBeanFactory beanFactory, PhrConfig config, DateTimeService dateTimeService,
                                       UUIDProvider uuidProvider, LegacyCodingReceivedRepository codingReceivedRepository,
                                       LegacyCodingMatchRepository codingMatchRepository) {
<span class="fc" id="L1241">        return new CodingManager(config, beanFactory, dateTimeService, uuidProvider, codingReceivedRepository, codingMatchRepository);</span>
    }

    @Bean
    public DeduplicatorManager deduplicatorManager(TolvenBeanFactory beanFactory, PhrConfig config) {
<span class="fc" id="L1246">        return new DeduplicatorManager(beanFactory, config);</span>
    }

    @Bean
    public EHRMeasurementManager ehrMeasurementManager(PhrConfig config, TolvenBeanFactory beanFactory,
                                                       DateTimeService dateTimeService, UUIDProvider uuidProvider,
                                                       CodingManager codingManager, DeduplicatorManager deduplicator,
                                                       DetailLoggingProvider testLoggingService) {
<span class="fc" id="L1254">        return new EHRMeasurementManager(config, beanFactory, dateTimeService, uuidProvider, codingManager,</span>
                deduplicator, testLoggingService, MeasurementDTO.class, MenuDataType.measurement);
    }

    @Bean
    public EmisEsObservationDeltaManager emisEsObservationDeltaManager(PhrConfig config, TolvenBeanFactory beanFactory,
                                                                       DateTimeService dateTimeService, UUIDProvider uuidProvider,
                                                                       CodingManager codingManager, DeduplicatorManager deduplicator,
                                                                       MenuDataRepository menuDataRepository) {
<span class="fc" id="L1263">        return new EmisEsObservationDeltaManager(config, beanFactory, dateTimeService, uuidProvider, codingManager,</span>
                deduplicator, menuDataRepository, EmisEsObservationDelta.class, EmisEsObservationDelta.MS_PATH);
    }

    @Bean
    public EHRAllergyManager ehrAllergyManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService,
                                               UUIDProvider uuidProvider, CodingManager codingManager, DeduplicatorManager deduplicator) {
<span class="fc" id="L1270">        return new EHRAllergyManager(config, beanFactory, dateTimeService, uuidProvider, codingManager,</span>
                deduplicator, Allergy.class, Allergy.MS_PATH);
    }

    @Bean
    public EHRDiagnosisManager ehrDiagnosisManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService,
                                                 UUIDProvider uuidProvider, CodingManager codingManager, DeduplicatorManager deduplicator) {
<span class="fc" id="L1277">        return new EHRDiagnosisManager(config, beanFactory, dateTimeService, uuidProvider, codingManager,</span>
                deduplicator, Diagnosis.class, Diagnosis.MS_PATH);
    }

    @Bean
    public EHRMedicationManager ehrMedicationManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService,
                                                    UUIDProvider uuidProvider, CodingManager codingManager, DeduplicatorManager deduplicator) {
<span class="fc" id="L1284">        return new EHRMedicationManager(config, beanFactory, dateTimeService, uuidProvider, codingManager,</span>
                deduplicator, Medication.class, Medication.MS_PATH);
    }

    @Bean
    public AuditLogManager  auditLogManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider, LegacyAuditLogRepository auditLogRepository) {
<span class="fc" id="L1290">        return new AuditLogManager(config, beanFactory, dateTimeService, uuidProvider, auditLogRepository);</span>
    }

    @Bean
    public EHRTestManager ehrTestManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService,
                                         UUIDProvider uuidProvider, CodingManager codingManager, DeduplicatorManager deduplicator) {
<span class="fc" id="L1296">        return new EHRTestManager(config, beanFactory, dateTimeService, uuidProvider, codingManager,</span>
                deduplicator, TestResultDTO.class, TestResultDTO.MS_PATH);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>