<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SpringSecurityBeansConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">config</a> &gt; <span class="el_source">SpringSecurityBeansConfig.java</span></div><h1>SpringSecurityBeansConfig.java</h1><pre class="source lang-java linenums">package config;

import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.domain.SSOService;
import com.pkb.entities.enums.SSOType;
import com.pkb.integration.medmij.MedmijService;
import com.pkb.security.AdminResetInProgressException;
import com.pkb.security.CoordAwaitingActivationException;
import com.pkb.security.EmailPasswordAuthenticator;
import com.pkb.security.FrozenByTeamException;
import com.pkb.security.IdPasswordAuthenticator;
import com.pkb.security.ImmutableSsoAuthenticationDetails;
import com.pkb.security.InvalidTokenException;
import com.pkb.security.LoginAttemptAuditor;
import com.pkb.security.OriginalAuthenticationDetailsSource;
import com.pkb.security.PKBAuthenticationManager;
import com.pkb.security.RegIncompleteException;
import com.pkb.security.SsoAuthenticationDetails;
import com.pkb.security.SsoAuthenticationProvider;
import com.pkb.security.TooManyLoginAttemptsException;
import com.pkb.security.WifiInTheCemeteryException;
import com.pkb.service.security.twofactor.TotpUrlGenerator;
import com.pkb.service.sso.impl.emis.EMISSSOAuthManager;
import com.pkb.service.twofactor.TwoFactorAuthenticationService;
import com.pkb.service.user.impl.ApiAuthManager;
import com.pkb.service.user.impl.PersonContactManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.servlets.filter.ApiTokenCorsHeadersFilter;
import com.pkb.servlets.filter.DefaultCacheHeadersFilter;
import com.pkb.servlets.filter.PreAuthenticationSuccessHandler;
import com.pkb.servlets.filter.ReferrerPolicyHeaderFilter;
import com.pkb.servlets.filter.SessionCheckFilter;
import com.pkb.servlets.filter.TeamAwareRedirectStrategy;
import com.pkb.sso.SsoMetrics;
import com.pkb.util.AppIdentityUtil;
import com.pkb.util.CorrelationIdUtil;
import com.pkb.util.LoggedInUserUtil;
import com.pkb.util.SSOConstants;
import com.warrenstrange.googleauth.IGoogleAuthenticator;
import io.vavr.control.Option;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.http.HttpStatus;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.DisabledException;
import org.springframework.security.authentication.ProviderManager;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.web.RedirectStrategy;
import org.springframework.security.web.authentication.AuthenticationFailureHandler;
import org.springframework.security.web.authentication.AuthenticationSuccessHandler;
import org.springframework.security.web.authentication.ExceptionMappingAuthenticationFailureHandler;
import org.springframework.security.web.authentication.LoginUrlAuthenticationEntryPoint;
import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;
import org.springframework.security.web.authentication.session.SessionAuthenticationStrategy;
import org.springframework.security.web.authentication.session.SessionFixationProtectionStrategy;
import org.springframework.security.web.firewall.HttpFirewall;
import org.springframework.security.web.firewall.StrictHttpFirewall;

import javax.servlet.ServletException;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.List;
import java.util.Optional;

import static com.pkb.security.BaseAuthenticationDetails.getAuthenticationDetailsSource;
import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.Match;
import static io.vavr.Predicates.instanceOf;

@Configuration
<span class="fc" id="L76">public class SpringSecurityBeansConfig {</span>

    @Bean
    public RedirectStrategy teamAwareRedirectStrategy() {
<span class="fc" id="L80">        return new TeamAwareRedirectStrategy();</span>
    }

    @Bean
    public PreAuthenticationSuccessHandler preAuthenticationSuccessHandler(LoggedInUserUtil loggedInUserUtil) {
<span class="fc" id="L85">        PreAuthenticationSuccessHandler preAuthenticationSuccessHandler = new PreAuthenticationSuccessHandler(loggedInUserUtil);</span>
<span class="fc" id="L86">        preAuthenticationSuccessHandler.setDefaultTargetUrl(&quot;/auth/redirectHome.action&quot;);</span>
<span class="fc" id="L87">        return preAuthenticationSuccessHandler;</span>
    }

    @Bean
    public ExceptionMappingAuthenticationFailureHandler preAuthenticationFailureHandler(@Qualifier(&quot;teamAwareRedirectStrategy&quot;) RedirectStrategy teamAwareRedirectStrategy) {
<span class="fc" id="L92">        ExceptionMappingAuthenticationFailureHandler preAuthenticationFailureHandler = new RefererAwareExceptionMappingAuthenticationFailureHandler();</span>
        // Note: loginForm.jsp error values are constants in LoginCheckAction.java
<span class="fc" id="L94">        preAuthenticationFailureHandler.setRedirectStrategy(teamAwareRedirectStrategy);</span>
<span class="fc" id="L95">        return preAuthenticationFailureHandler;</span>
    }

    @Bean
    public SessionAuthenticationStrategy sessionFixationProtectionStrategy() {
<span class="fc" id="L100">        return new SessionFixationProtectionStrategy();</span>
    }

    @Bean
    public AuthenticationSuccessHandler ssoPreAuthenticationSuccessHandler(LoggedInUserUtil loggedInUserUtil) {
<span class="fc" id="L105">        return new PreAuthenticationSuccessHandler(loggedInUserUtil) {</span>
            @Override
            protected String determineTargetUrl(HttpServletRequest request, HttpServletResponse response, Authentication authentication) {
<span class="fc" id="L108">                return &quot;/auth/patientSummary.action?contextUserId=&quot; + ((SsoAuthenticationDetails) authentication.getDetails()).getContextUserId();</span>
            }
        };
    }

    @Bean
    public AuthenticationFailureHandler ssoPreAuthenticationFailureHandler() {
<span class="fc" id="L115">        return new ExceptionMappingAuthenticationFailureHandler() {</span>
            @Override
            public void onAuthenticationFailure(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) throws IOException, ServletException {
<span class="fc" id="L118">                SSOType ssoType = Optional.ofNullable(request.getParameter(&quot;ssoType&quot;)).map(SSOType::valueOf).orElse(SSOType.UNKNOWN);</span>
<span class="fc bfc" id="L119" title="All 2 branches covered.">                if (ssoType == SSOType.SYSTMONE) {</span>
<span class="fc" id="L120">                    request.setAttribute(&quot;generalAuthenticationError&quot;, true);</span>
<span class="fc" id="L121">                    request.getRequestDispatcher(&quot;/ssoErrorPage.jsp&quot;).forward(request, response);</span>
                } else {
<span class="fc" id="L123">                    response.sendError(HttpStatus.UNAUTHORIZED.value(), exception.getMessage());</span>
                }
<span class="fc" id="L125">            }</span>
        };
    }


    @Bean
    public UsernamePasswordAuthenticationFilter ssoAuthenticationFilter(
            @Qualifier(&quot;ssoPreAuthenticationSuccessHandler&quot;) AuthenticationSuccessHandler ssoPreAuthenticationSuccessHandler,
            @Qualifier(&quot;ssoPreAuthenticationFailureHandler&quot;) AuthenticationFailureHandler ssoPreAuthenticationFailureHandler,
            ProviderManager authenticationManager,
            AppIdentityUtil appIdentityUtil) {
<span class="fc" id="L136">        UsernamePasswordAuthenticationFilter filter = new UsernamePasswordAuthenticationFilter();</span>
<span class="fc" id="L137">        filter.setFilterProcessesUrl(&quot;/ssoLogin&quot;);</span>
<span class="fc" id="L138">        filter.setAuthenticationSuccessHandler(ssoPreAuthenticationSuccessHandler);</span>
<span class="fc" id="L139">        filter.setAuthenticationFailureHandler(ssoPreAuthenticationFailureHandler);</span>
<span class="fc" id="L140">        filter.setAuthenticationManager(authenticationManager);</span>
<span class="fc" id="L141">        filter.setUsernameParameter(SSOConstants.SSO_USERNAME_PARAM);</span>
<span class="fc" id="L142">        filter.setPasswordParameter(SSOConstants.SSO_KEY_PARAM);</span>
<span class="fc" id="L143">        filter.setAuthenticationDetailsSource(getAuthenticationDetailsSource(ImmutableSsoAuthenticationDetails::builder, appIdentityUtil));</span>
<span class="fc" id="L144">        filter.setPostOnly(false); //This isn't great but SystmOne session request is a GET. Otherwise we'd have to redirect via a postback which is probably worse</span>
<span class="fc" id="L145">        return filter;</span>
    }

    @Bean
    public ProviderManager getProviderManager(List&lt;AuthenticationProvider&gt; providerList) {
<span class="fc" id="L150">        return new ProviderManager(providerList);</span>
    }

    @Bean
    public AuthenticationProvider getSsoAuthenticationProvider(SSOService ssoService, EMISSSOAuthManager emisssoAuthManager,
                                                               LoginAttemptAuditor.Factory loginAttemptAuditorFactory, SsoMetrics ssoMetrics) {
<span class="fc" id="L156">        return new SsoAuthenticationProvider(</span>
                loginAttemptAuditorFactory,
                emisssoAuthManager,
                ssoMetrics);
    }


    @Bean
    public AppIdentityUtil appIdentityUtil() {
<span class="fc" id="L165">        return new AppIdentityUtil();</span>
    }

    @Bean
    public CorrelationIdUtil correlationIdUtil() {
<span class="nc" id="L170">        return new CorrelationIdUtil();</span>
    }

    @Bean
    public LoginUrlAuthenticationEntryPoint myAuthenticationEntryPoint(AppIdentityUtil appIdentity, PhrConfig config) {
<span class="fc" id="L175">        return new PkbAuthenticationEntryPoint(&quot;/login.jsp&quot;, appIdentity, config.getNhsIntegrationUrl());</span>
    }

    @Bean
    public DefaultCacheHeadersFilter defaultCacheHeadersFilter() {
<span class="fc" id="L180">        return new DefaultCacheHeadersFilter();</span>
    }

    @Bean
    public ApiTokenCorsHeadersFilter apiTokenCorsHeadersFilter() {
<span class="fc" id="L185">        return new ApiTokenCorsHeadersFilter();</span>
    }

    @Bean
    public ReferrerPolicyHeaderFilter referrerPolicyHeaderFilter() {
<span class="fc" id="L190">        return new ReferrerPolicyHeaderFilter();</span>
    }

    @Bean
    public UsernamePasswordAuthenticationFilter customizedFormLoginFilter(@Qualifier(&quot;preAuthenticationSuccessHandler&quot;) AuthenticationSuccessHandler preAuthenticationSuccessHandler,
                                                                          @Qualifier(&quot;preAuthenticationFailureHandler&quot;) AuthenticationFailureHandler preAuthenticationFailureHandler,
                                                                          @Qualifier(&quot;sessionFixationProtectionStrategy&quot;) SessionAuthenticationStrategy sessionFixationProtectionStrategy,
                                                                          PKBAuthenticationManager myAuthenticationManager) {
<span class="fc" id="L198">        UsernamePasswordAuthenticationFilter customizedFormLoginFilter = new UsernamePasswordAuthenticationFilter();</span>
<span class="fc" id="L199">        customizedFormLoginFilter.setAuthenticationSuccessHandler(preAuthenticationSuccessHandler);</span>
<span class="fc" id="L200">        customizedFormLoginFilter.setAuthenticationFailureHandler(preAuthenticationFailureHandler);</span>
<span class="fc" id="L201">        customizedFormLoginFilter.setSessionAuthenticationStrategy(sessionFixationProtectionStrategy);</span>
        // Here it is the custom authenticationManager, login magic goes here 
<span class="fc" id="L203">        customizedFormLoginFilter.setAuthenticationManager(myAuthenticationManager);</span>
        // Allow the application to create sessions
<span class="fc" id="L205">        customizedFormLoginFilter.setAllowSessionCreation(true);</span>
        // TODO: PHR-5505 We should consider OTP Workflow redesign to comply with default implementation of the filter.
<span class="fc" id="L207">        customizedFormLoginFilter.setPostOnly(false);</span>
<span class="fc" id="L208">        customizedFormLoginFilter.setFilterProcessesUrl(&quot;/j_spring_security_check&quot;);</span>
<span class="fc" id="L209">        customizedFormLoginFilter.setUsernameParameter(&quot;j_username&quot;);</span>
<span class="fc" id="L210">        customizedFormLoginFilter.setPasswordParameter(&quot;j_password&quot;);</span>
<span class="fc" id="L211">        customizedFormLoginFilter.setAuthenticationDetailsSource(new OriginalAuthenticationDetailsSource());</span>
<span class="fc" id="L212">        return customizedFormLoginFilter;</span>
    }

    @Bean
    public SessionCheckFilter sessionCheckFilter() {
<span class="fc" id="L217">        return new SessionCheckFilter();</span>
    }

    @Bean
    public PKBAuthenticationManager myAuthenticationManager(PersonContactManager personContactManager,
                                                            ApiAuthManager apiAuthManager,
                                                            UserManager userManager,
                                                            TwoFactorAuthenticationService twoFactorAuthenticationService,
                                                            LoginAttemptAuditor.Factory loginAttemptLoggerFactory,
                                                            IdPasswordAuthenticator.Factory idPasswordAuthenticatorFactory,
                                                            EmailPasswordAuthenticator.Factory emailPasswordAuthenticatorFactory) {
<span class="fc" id="L228">        return new PKBAuthenticationManager(personContactManager,</span>
                apiAuthManager,
                userManager,
                twoFactorAuthenticationService,
                loginAttemptLoggerFactory,
                idPasswordAuthenticatorFactory,
                emailPasswordAuthenticatorFactory);
    }


    //TODO: PHR-5679 use default and secure firewall implementation if possible. 
    @Bean
    public HttpFirewall insecureHttpFirewall() {
<span class="fc" id="L241">        StrictHttpFirewall firewall = new StrictHttpFirewall();</span>
<span class="fc" id="L242">        firewall.setAllowUrlEncodedSlash(true);</span>
<span class="fc" id="L243">        firewall.setAllowSemicolon(true);</span>
<span class="fc" id="L244">        firewall.setAllowBackSlash(true);</span>
<span class="fc" id="L245">        firewall.setAllowUrlEncodedPercent(true);</span>
<span class="fc" id="L246">        firewall.setAllowUrlEncodedPeriod(true);</span>
<span class="fc" id="L247">        return firewall;</span>
    }

    @Bean
    public TwoFactorAuthenticationService twoFactorAuthenticationService(PhrConfig config, UserManager userManager, TotpUrlGenerator totpUrlGenerator, IGoogleAuthenticator googleAuthenticator, MedmijService medmijService, DateTimeService dateTimeService) {
<span class="fc" id="L252">        return new TwoFactorAuthenticationService(config, userManager, totpUrlGenerator, googleAuthenticator, medmijService, dateTimeService);</span>
    }

<span class="fc" id="L255">    private class RefererAwareExceptionMappingAuthenticationFailureHandler</span>
            extends ExceptionMappingAuthenticationFailureHandler {
        @Override
        public void onAuthenticationFailure(HttpServletRequest request,
                                            HttpServletResponse response,
                                            AuthenticationException exception) throws IOException, ServletException {
<span class="fc" id="L261">            String referer = Option.of(request.getHeader(&quot;Referer&quot;))</span>
<span class="fc" id="L262">                    .filter(s -&gt; s.contains(&quot;nhsLoginConfirmPassword&quot;))</span>
<span class="fc" id="L263">                    .map($ -&gt; &quot;/nhsLoginConfirmPassword.action&quot;)</span>
<span class="fc" id="L264">                    .getOrElse(&quot;/login.jsp&quot;);</span>
<span class="fc" id="L265">            String redirectUri = Match(exception).of(</span>
<span class="fc" id="L266">                    Case($(instanceOf(DisabledException.class)), referer + &quot;?msg=inactive&quot;),</span>
<span class="fc" id="L267">                    Case($(instanceOf(RegIncompleteException.class)), referer + &quot;?msg=regIncomplete&quot;),</span>
<span class="fc" id="L268">                    Case($(instanceOf(TooManyLoginAttemptsException.class)), referer + &quot;?msg=tooManyLoginAttempts&quot;),</span>
<span class="fc" id="L269">                    Case($(instanceOf(InvalidTokenException.class)), referer + &quot;?msg=invalidToken&quot;),</span>
<span class="fc" id="L270">                    Case($(instanceOf(AdminResetInProgressException.class)), referer + &quot;?msg=resetInProgress&quot;),</span>
<span class="fc" id="L271">                    Case($(instanceOf(FrozenByTeamException.class)), referer + &quot;?msg=frozenByTeam&quot;),</span>
<span class="fc" id="L272">                    Case($(instanceOf(WifiInTheCemeteryException.class)), referer + &quot;?msg=contactTeamForAccess&quot;),</span>
<span class="fc" id="L273">                    Case($(instanceOf(CoordAwaitingActivationException.class)), &quot;coordAwaitingActivation.jsp&quot;),</span>
<span class="fc" id="L274">                    Case($(), referer + &quot;?msg=auth&quot;));</span>
<span class="fc" id="L275">            getRedirectStrategy().sendRedirect(request, response, redirectUri);</span>
<span class="fc" id="L276">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>