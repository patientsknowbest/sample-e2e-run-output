<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebappConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">config</a> &gt; <span class="el_source">WebappConfig.java</span></div><h1>WebappConfig.java</h1><pre class="source lang-java linenums">package config;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.pkb.action.ClinicianMultipleTeamService;
import com.pkb.action.DashboardService;
import com.pkb.action.DiscussDatapointService;
import com.pkb.action.EditPrivacyService;
import com.pkb.action.GenderLimitedStringLocalizationHelper;
import com.pkb.action.GenderLocalizationHelper;
import com.pkb.action.GenderStringLocalizationHelper;
import com.pkb.action.MonthMapShortKeyLocalizationHelper;
import com.pkb.action.PatientConsentTeamService;
import com.pkb.action.TimelineDisplayCache;
import com.pkb.action.TimelineDisplayGateway;
import com.pkb.action.TimelineDisplayGatewayImpl;
import com.pkb.action.UserTypeLocalizationHelper;
import com.pkb.action.diary.AppointmentsService;
import com.pkb.action.emis.pfs.EmisMessageHelper;
import com.pkb.action.library.LibraryService;
import com.pkb.action.message.ConversationActionItemBuilder;
import com.pkb.action.message.ConversationParticipantBuilder;
import com.pkb.action.message.EncounterClassLocalizationHelper;
import com.pkb.action.message.InboxService;
import com.pkb.action.message.MessageActionItemBuilder;
import com.pkb.action.message.ParticipantSelectorService;
import com.pkb.action.message.ReplyFeasibilityService;
import com.pkb.action.message.ShowMessageConversationService;
import com.pkb.action.message.workflow.ConversationWorkflowFlagService;
import com.pkb.action.registration.PatientActivationDetailsDTOConverter;
import com.pkb.action.registration.PatientRegistrationConsentService;
import com.pkb.action.registration.letter.CompositeDatePartsValueProvider;
import com.pkb.action.registration.reset.CandidateFinderService;
import com.pkb.action.registration.reset.PasswordResetEvents;
import com.pkb.action.registration.reset.PasswordResetService;
import com.pkb.action.registration.reset.demographicsvalidator.LenientDateOfBirthValidator;
import com.pkb.action.registration.reset.demographicsvalidator.LenientLastNameValidator;
import com.pkb.action.registration.reset.demographicsvalidator.LenientPostalCodeValidator;
import com.pkb.action.support.AppointmentTransformer;
import com.pkb.action.test.MeasurementUtil;
import com.pkb.action.userprofile.UserProfileDataSourceFactory;
import com.pkb.api.action.AccessTokenIssuer;
import com.pkb.api.internal.messaging.PKBPersonToMessagingPKBPersonDTOConverter;
import com.pkb.api.util.DefaultInternalAccessTokenIssuer;
import com.pkb.api.util.InternalAccessTokenIssuer;
import com.pkb.api.util.JournalApiHelper;
import com.pkb.api.util.MeasurementApiHelper;
import com.pkb.api.util.MessageApiHelper;
import com.pkb.api.util.OAuthAuthorizationServerClient;
import com.pkb.api.util.SymptomApiHelper;
import com.pkb.api.util.converter.v1.DiaryEntryToApiJournalEntryConverter;
import com.pkb.api.util.converter.v2.CarePlanConverter;
import com.pkb.api.util.v2.RestUtil;
import com.pkb.api.v1.V1OAuthTokenExchangeService;
import com.pkb.bean.IMessageWebBean;
import com.pkb.bean.impl.AutoSaveService;
import com.pkb.bean.impl.MessageWebBean;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.datamodel.entity.mapper.UserTypeToScopeMapper;
import com.pkb.domain.LoginAttemptLogService;
import com.pkb.domain.OrgNetworkService;
import com.pkb.domain.RegistrationFailedAttemptLogService;
import com.pkb.domain.appointment.AppointmentMessagingSettingsService;
import com.pkb.domain.appointment.EmisAppointmentService;
import com.pkb.domain.messages.workflow.TrustedConversationWorkflowService;
import com.pkb.emis.appointment.service.EmisAppointmentManager;
import com.pkb.emis.appointment.service.EmisSessionService;
import com.pkb.integration.medmij.MedmijService;
import com.pkb.integration.ods.OdsService;
import com.pkb.interceptor.CSRFTokenHelper;
import com.pkb.interceptor.CsrfTokenInterceptor;
import com.pkb.interceptor.ValidationExceptionMappingInterceptor;
import com.pkb.kms.client.core.Kms;
import com.pkb.mappers.AppointmentActionsMapper;
import com.pkb.mappers.AppointmentEntryMapper;
import com.pkb.mappers.AppointmentViewMapper;
import com.pkb.mappers.ConsentIndividualMapper;
import com.pkb.mappers.ConsentTeamMapper;
import com.pkb.mappers.ProgressItemMapper;
import com.pkb.mappers.TeamMapper;
import com.pkb.patient.InvitationNationalIdValidator;
import com.pkb.plan.support.PhPlanToPlanDtoConverter;
import com.pkb.repository.CodingTranslationRepository;
import com.pkb.repository.DatapointExternalIntegrationUrlRepository;
import com.pkb.repository.OrgSurvivingStateRepository;
import com.pkb.security.EmailPasswordAuthenticator;
import com.pkb.security.IdPasswordAuthenticator;
import com.pkb.security.LoginAttemptAuditor;
import com.pkb.security.LoginMetrics;
import com.pkb.service.calendar.impl.CalendarManager;
import com.pkb.service.code.CodingTranslationService;
import com.pkb.service.datapoint.impl.DataPointManager;
import com.pkb.service.diary.DiaryManager;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.encounter.impl.tolven.EncounterManager;
import com.pkb.service.encounter.workflow.ConversationWorkflowConverter;
import com.pkb.service.file.FileManager;
import com.pkb.service.institute.OrgSurvivingStateService;
import com.pkb.service.integration.AppointmentManagementPartnerService;
import com.pkb.service.integration.DatapointExternalIntegrationUrlService;
import com.pkb.service.invitation.impl.InvitationManager;
import com.pkb.service.notification.impl.tolven.INotificationManager;
import com.pkb.service.passwordreset.PasswordResetEmailSender;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.personallibrary.PersonalLibraryManager;
import com.pkb.service.phplan.PlanManager;
import com.pkb.service.privacy.PrivacyService;
import com.pkb.service.questionnaire.QuestionnaireManager;
import com.pkb.service.reference.ReferenceDataManager;
import com.pkb.service.reminders.ReminderManager;
import com.pkb.service.symptom.SymptomReportManager;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.test.LoincManager;
import com.pkb.service.test.MeasurementManager;
import com.pkb.service.test.TestManager;
import com.pkb.service.user.impl.ApiAuthManager;
import com.pkb.service.user.impl.PersonContactManager;
import com.pkb.service.user.impl.PrimaryEmailContactManager;
import com.pkb.service.user.impl.UserAccessManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.spring.LoggingPropertyPlaceholderConfigurer;
import com.pkb.sso.SsoMetrics;
import com.pkb.testsupport.TestSupportConfig;
import com.pkb.util.ContextSwitchValidator;
import com.pkb.util.ContextUserUtil;
import com.pkb.util.ContextUtil;
import com.pkb.util.DataDelayService;
import com.pkb.util.DateUtil;
import com.pkb.util.FakeHelpPageBaseURLProvider;
import com.pkb.util.HelpPageBaseURLProvider;
import com.pkb.util.LabResultFormattingService;
import com.pkb.util.LocalizedTextProvider;
import com.pkb.util.LoggedInUserUtil;
import com.pkb.util.PKBWebUtil;
import com.pkb.util.PrivacyUtil;
import com.pkb.util.RequestCache;
import com.pkb.util.SessionUtil;
import com.pkb.util.TestHistoryUtil;
import com.pkb.util.TimelineChartUtil;
import com.pkb.util.TrendlineService;
import com.pkb.util.UserAgentAnalyzerBean;
import com.pkb.util.metrics.SpaMetrics;
import com.warrenstrange.googleauth.GoogleAuthenticator;
import io.micrometer.core.instrument.Metrics;
import io.micrometer.core.instrument.binder.okhttp3.OkHttpMetricsEventListener;
import nl.basjes.parse.useragent.UserAgentAnalyzer;
import okhttp3.OkHttpClient;
import org.apache.struts2.ServletActionContext;
import org.jetbrains.annotations.NotNull;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.context.ApplicationListener;
import org.springframework.context.MessageSource;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.ComponentScan;
import org.springframework.context.annotation.Configuration;
import org.springframework.context.annotation.Import;
import org.springframework.context.annotation.ImportResource;
import org.springframework.context.event.ContextRefreshedEvent;
import org.springframework.context.support.ReloadableResourceBundleMessageSource;
import org.springframework.core.io.Resource;
import org.springframework.core.io.support.PathMatchingResourcePatternResolver;
import retrofit2.Retrofit.Builder;
import retrofit2.converter.jackson.JacksonConverterFactory;

import javax.enterprise.inject.spi.CDI;
import java.io.IOException;
import java.util.List;
import java.util.stream.Stream;

import static nl.basjes.parse.useragent.UserAgent.AGENT_NAME;
import static nl.basjes.parse.useragent.UserAgent.AGENT_VERSION_MAJOR;
import static nl.basjes.parse.useragent.UserAgent.OPERATING_SYSTEM_NAME;
import static nl.basjes.parse.useragent.UserAgent.OPERATING_SYSTEM_VERSION_MAJOR;

@SuppressWarnings(&quot;ClassWithTooManyMethods&quot;)
@Configuration
@ComponentScan(basePackages = {
        &quot;config&quot;,
        &quot;com.pkb.interceptor&quot;,
        &quot;com.pkb.servlets&quot;,
        &quot;com.pkb.apiservice&quot;,
        &quot;com.pkb.listener&quot;,
        &quot;com.pkb.testsupport&quot;,
        &quot;com.pkb.plan&quot;,
        &quot;com.pkb.source&quot;,
        &quot;com.pkb.action.support&quot;,
        &quot;com.pkb.radiology&quot;,
        &quot;com.pkb.security.postlogin&quot;
})
@ImportResource(value = {
        &quot;classpath:web-context.xml&quot;,
        &quot;classpath:aop-config.xml&quot;
})
@Import({
        SpringSecurityBeansConfig.class,
        SpringSecurityNhsLoginConfig.class,
        SpringSecurityConfig.class,
        PkbServiceConfig.class,
        TestSupportConfig.class
})
<span class="fc" id="L204">public class WebappConfig {</span>

    @Bean(name = &quot;PKBWebUtil&quot;)
    public PKBWebUtil pkbWebUtil(DateTimeService dateTimeService, TeamManager teamManager, UserManager userManager, MessageSource messageSource) {
<span class="fc" id="L208">        return new PKBWebUtil(messageSource, dateTimeService, teamManager, userManager);</span>
    }

    @Bean
    public V1OAuthTokenExchangeService exchangeService(RestUtil restUtil, InternalAccessTokenIssuer issuer, PhrConfig config) {
<span class="fc" id="L213">        return new V1OAuthTokenExchangeService(restUtil, issuer, config);</span>
    }

    @Bean
    public MessageSource messageSource() {
<span class="fc" id="L218">        ReloadableResourceBundleMessageSource messageSource = new ReloadableResourceBundleMessageSource();</span>
<span class="fc" id="L219">        messageSource.setBasenames(&quot;classpath:/global&quot;,</span>
                &quot;classpath:/countrylist&quot;,
                &quot;classpath:/ethnicitylist&quot;,
                &quot;classpath:/religionlist&quot;,
                &quot;classpath:/specialtyList&quot;,
                &quot;classpath:/timezonelist&quot;,
                &quot;classpath:/securityQuestionList&quot;,
                &quot;classpath:/loincTest&quot;,
                &quot;classpath:/medication&quot;,
                &quot;classpath:/symptom&quot;,
                &quot;classpath:/photoIdList&quot;,
                &quot;classpath:/clinicianPhotoIdList&quot;,
                &quot;classpath:/actionErrors&quot;,
                &quot;classpath:/validationMessages&quot;,
                &quot;classpath:/com/pkb/service/test/package&quot;,
                &quot;classpath:/com/pkb/service/mappers/package&quot;,
                &quot;classpath:/com/pkb/action/diary/package&quot;);
<span class="fc" id="L236">        messageSource.setCacheSeconds(7200);</span>
<span class="fc" id="L237">        return messageSource;</span>
    }

    @Bean(name = &quot;userAgentAnalyzerBean&quot;)
    public UserAgentAnalyzerBean userAgentAnalyzerBean(PhrConfig config) {
<span class="fc" id="L242">        UserAgentAnalyzer uaa = UserAgentAnalyzer.newBuilder()</span>
<span class="fc" id="L243">                .withCache(config.getUserAgentAnalyzerCacheSize())</span>
<span class="fc" id="L244">                .withField(OPERATING_SYSTEM_NAME)</span>
<span class="fc" id="L245">                .withField(AGENT_VERSION_MAJOR)</span>
<span class="fc" id="L246">                .withField(AGENT_NAME)</span>
<span class="fc" id="L247">                .withField(OPERATING_SYSTEM_VERSION_MAJOR)</span>
<span class="fc" id="L248">                .build();</span>
<span class="fc" id="L249">        return new UserAgentAnalyzerBean(uaa);</span>
    }

    @Bean
    public SessionUtil sessionUtil() {
<span class="fc" id="L254">        return new SessionUtil();</span>
    }

    @Bean
    public RequestCache requestCache() {
<span class="fc" id="L259">        return new RequestCache(ServletActionContext::getRequest);</span>
    }

    @Bean
    public LoggedInUserUtil loggedInUserUtil(TeamUserManager teamUserManager, UserManager userManager, RequestCache requestCache, PersonContactManager personContactManager) {
<span class="fc" id="L264">        return new LoggedInUserUtil(teamUserManager, userManager, requestCache, personContactManager);</span>
    }

    @Bean
    public ContextSwitchValidator contextSwitchValidator(UserManager userManager, TeamManager teamManager,
                                                         UserAccessManager userAccessManager, LoggedInUserUtil loggedInUserUtil) {
<span class="fc" id="L270">        return new ContextSwitchValidator(userManager, teamManager, userAccessManager, loggedInUserUtil);</span>
    }

    @Bean
    public ContextUtil contextUtil() {
<span class="fc" id="L275">        return new ContextUtil();</span>
    }

    @Bean
    public ContextUserUtil contextUserUtil(
            ContextSwitchValidator contextSwitchValidator,
            LoggedInUserUtil loggedInUserUtil,
            UserManager userManager,
            SessionUtil sessionUtil,
            SsoMetrics ssoMetrics) {
<span class="fc" id="L285">        return new ContextUserUtil(contextSwitchValidator, loggedInUserUtil, userManager, sessionUtil, ssoMetrics);</span>
    }

    @Bean(name = &quot;DateUtil&quot;)
    public DateUtil dateUtil(DateTimeService dateTimeService, MessageSource messageSource) {
<span class="fc" id="L290">        return new DateUtil(messageSource, dateTimeService);</span>
    }

    @Bean(name = &quot;GoogleAuthenticator&quot;)
    GoogleAuthenticator googleAuthenticator() {
<span class="fc" id="L295">        return new GoogleAuthenticator();</span>
    }

    @Bean
    public SsoMetrics getSsoMetrics() {
<span class="fc" id="L300">        return new SsoMetrics();</span>
    }

    @Bean
    public PatientActivationDetailsDTOConverter patientActivationDetailsDTOConverter() {
<span class="fc" id="L305">        return new PatientActivationDetailsDTOConverter();</span>
    }

    @Bean
    public CompositeDatePartsValueProvider dateValueProvider(DateTimeService dateTimeService) {
<span class="fc" id="L310">        return new CompositeDatePartsValueProvider(dateTimeService);</span>
    }

    @Bean
    public LoginAttemptAuditor.Factory loginAttemptAuditorFactory(LoginMetrics loginMetrics,
                                                                  PhrConfig config, DateTimeService dateTimeService,
                                                                  LoginAttemptLogService loginAttemptLogService) {
<span class="fc" id="L317">        return new LoginAttemptAuditor.Factory(loginMetrics, config, dateTimeService, loginAttemptLogService);</span>
    }

    @Bean
    public EmailPasswordAuthenticator.Factory emailPasswordAuthenticatorFactory(
            PersonContactManager personContactManager,
            UserManager userManager,
            TeamUserManager teamUserManager,
            UserAccessManager userAccessManager,
            PhrConfig config) {
<span class="fc" id="L327">        return new EmailPasswordAuthenticator.Factory(</span>
                personContactManager,
                teamUserManager,
                userManager,
                userAccessManager);
    }

    @Bean
    public IdPasswordAuthenticator.Factory idPasswordAuthenticatorFactory(
            TeamUserManager teamUserManager,
            UserManager userManager) {
<span class="fc" id="L338">        return new IdPasswordAuthenticator.Factory(teamUserManager, userManager);</span>
    }

    @Bean
    public AccessTokenIssuer.Factory accessTokenIssuerFactory(ApiAuthManager authManager, UserManager userManager, PhrConfig config) {
<span class="fc" id="L343">        return new AccessTokenIssuer.Factory(authManager, userManager, config);</span>
    }

    @Bean
    public OAuthAuthorizationServerClient oauthAuthorizationServerClient(PhrConfig config, OkHttpClient httpClient) {
<span class="fc" id="L348">        String url = config.getAuthorizationEndpointAddress();</span>
<span class="fc" id="L349">        return new Builder()</span>
<span class="fc" id="L350">                .client(httpClient)</span>
<span class="fc" id="L351">                .baseUrl(url)</span>
<span class="fc" id="L352">                .addConverterFactory(JacksonConverterFactory.create())</span>
<span class="fc" id="L353">                .build()</span>
<span class="fc" id="L354">                .create(OAuthAuthorizationServerClient.class);</span>
    }

    @Bean
    public InternalAccessTokenIssuer internalAccessTokenIssuer(UserTypeToScopeMapper mapper, OAuthAuthorizationServerClient client,
                                                               PhrConfig config) {
<span class="fc" id="L360">        return new DefaultInternalAccessTokenIssuer(mapper, client, config);</span>
    }

    @Bean
    public OkHttpClient httpClient() {
<span class="fc" id="L365">        return new OkHttpClient.Builder()</span>
<span class="fc" id="L366">                .eventListener(OkHttpMetricsEventListener.builder(Metrics.globalRegistry, &quot;okhttp.requests.phr.webconfig&quot;).build())</span>
<span class="fc" id="L367">                .build();</span>
    }

    @Bean
    public TimelineDisplayCache timelineDisplayCache(PhrConfig config) {
<span class="fc" id="L372">        return new TimelineDisplayCache(config.getTimelineHtmlExpiryInSeconds());</span>
    }

    @Bean
    public TimelineDisplayGateway timelineDisplayGateway(PhrConfig config, TimelineDisplayCache cache, OkHttpClient client) {
<span class="pc bpc" id="L377" title="3 of 4 branches missed.">        if (config.isTimelineEnabled() || config.isPatientBannerEnabled()) {</span>
<span class="fc" id="L378">            return new TimelineDisplayGatewayImpl(client,</span>
                    cache,
<span class="fc" id="L380">                    config.getTimelineFrontendFetchURL(),</span>
<span class="fc" id="L381">                    config.getTimelineFrontendBrowserBaseURL());</span>
        } else {
<span class="nc" id="L383">            return TimelineDisplayGateway.NOOP;</span>
        }
    }

    @Bean
    public CSRFTokenHelper csrfTokenHelper() {
<span class="fc" id="L389">        return new CSRFTokenHelper();</span>
    }

    @Bean
    public CsrfTokenInterceptor csrfTokenInterceptor(CSRFTokenHelper csrfTokenHelper, PhrConfig config) {
<span class="fc" id="L394">        return new CsrfTokenInterceptor(csrfTokenHelper, config);</span>
    }

    @Bean
    public ValidationExceptionMappingInterceptor validationExceptionMappingInterceptor(PhrConfig config) {
<span class="fc" id="L399">        return new ValidationExceptionMappingInterceptor(config);</span>
    }

    @Bean
    @Qualifier(&quot;feature.patientbanner.enabled&quot;)
    public boolean patientBannerFeatureInterceptor(PhrConfig config) {
<span class="fc" id="L405">        return config.isPatientBannerEnabled();</span>
    }

    @Bean
    @Qualifier(&quot;feature.timeline.enabled&quot;)
    public boolean timelineFeatureInterceptor(PhrConfig config) {
<span class="fc" id="L411">        return config.isTimelineEnabled();</span>
    }

    @Bean
    public JournalApiHelper journalApiHelper(PatientConsentManager patientConsentManager, UserManager userManager, DiaryManager diaryManager,
                                             DiaryEntryToApiJournalEntryConverter diaryEntryToApiJournalEntryConverter) {
<span class="fc" id="L417">        return new JournalApiHelper(patientConsentManager, userManager, diaryManager, diaryEntryToApiJournalEntryConverter);</span>
    }

    @Bean
    public DiaryEntryToApiJournalEntryConverter diaryEntryToApiJournalEntryConverter() {
<span class="fc" id="L422">        return new DiaryEntryToApiJournalEntryConverter();</span>
    }

    @Bean
    public HelpPageBaseURLProvider helpPageBaseURLProvider(PhrConfig config) {
<span class="pc bpc" id="L427" title="1 of 2 branches missed.">        if (config.isFakeHelpPageBaseUrlProviderEnabled()) {</span>
<span class="fc" id="L428">            return new FakeHelpPageBaseURLProvider(config);</span>
        } else {
<span class="nc" id="L430">            return new HelpPageBaseURLProvider(config);</span>
        }
    }

    @Bean
    public SpaMetrics spaMetrics() {
<span class="fc" id="L436">        return new SpaMetrics();</span>
    }

    @Bean
    public DataDelayService delayService(DateTimeService dateTimeService) {
<span class="fc" id="L441">        return new DataDelayService(dateTimeService);</span>
    }

    @Bean
    public LabResultFormattingService labResultFormattingService(DataDelayService delayService, LocalizedTextProvider textProvider) {
<span class="fc" id="L446">        return new LabResultFormattingService(delayService, textProvider);</span>
    }

    @Bean
    public TestHistoryUtil testHistoryUtil(
            LoggedInUserUtil loggedInUserUtil,
            ContextUserUtil contextUserUtil,
            LocalizedTextProvider localizedTextProvider,
            DataDelayService delayService,
            LabResultFormattingService labResultFormattingService,
            DataPointManager dataPointManager,
            FileManager fileManager) {
<span class="fc" id="L458">        return new TestHistoryUtil(loggedInUserUtil, contextUserUtil, localizedTextProvider, delayService, labResultFormattingService,</span>
                dataPointManager, fileManager);
    }

    @Bean
    public TrendlineService trendlineService(DataDelayService delayService) {
<span class="fc" id="L464">        return new TrendlineService(delayService);</span>
    }

    @Bean
    public ObjectMapper objectMapper() {
<span class="fc" id="L469">        return new ObjectMapper();</span>
    }

    @Bean
    public PrivacyUtil privacyUtil() {
<span class="fc" id="L474">        return new PrivacyUtil();</span>
    }

    @Bean
    public ShowMessageConversationService showMessageConversationService(
            EncounterManager encounterManager,
            ConversationWorkflowFlagService conversationWorkflowFlagService,
            TrustedConversationWorkflowService trustedConversationWorkflowService,
            ConversationWorkflowConverter conversationWorkflowConverter,
            DataPointManager dataPointManager,
            MessageWebBean messageWebBean,
            UserManager userManager,
            TeamUserManager teamUserManager,
            DateUtil dateUtil,
            EncounterClassLocalizationHelper encounterClassLocalizationHelper,
            ReferenceDataManager referenceDataManager,
            TeamManager teamManager,
            PKBPersonToMessagingPKBPersonDTOConverter personDTOConverter,
            ConversationActionItemBuilder conversationActionItemBuilder,
            MessageActionItemBuilder messageActionItemBuilder,
            ConversationParticipantBuilder participantBuilder,
            PrivacyUtil privacyUtil,
            MessageSource messageSource,
            ReplyFeasibilityService replyFeasibilityService,
            PhrConfig config) {
<span class="fc" id="L499">        return new ShowMessageConversationService(encounterManager, conversationWorkflowFlagService, trustedConversationWorkflowService, conversationWorkflowConverter,</span>
                dataPointManager, messageWebBean, userManager, teamUserManager, dateUtil, encounterClassLocalizationHelper, referenceDataManager, teamManager,
                personDTOConverter, privacyUtil, conversationActionItemBuilder, messageActionItemBuilder, participantBuilder, messageSource,
                replyFeasibilityService, config);
    }

    @Bean
    public DashboardService dashboardService(MedmijService medmijService) {
<span class="fc" id="L507">        return new DashboardService(medmijService);</span>
    }

    @Bean
    public ConversationActionItemBuilder conversationActionItemBuilder(MessageSource messageSource) {
<span class="fc" id="L512">        return new ConversationActionItemBuilder(messageSource);</span>
    }

    @Bean
    public MessageActionItemBuilder messageActionItemBuilder(MessageSource messageSource) {
<span class="fc" id="L517">        return new MessageActionItemBuilder(messageSource);</span>
    }

    @Bean
    public ConversationParticipantBuilder conversationParticipantBuilder(TeamUserManager teamUserManager, MessageSource messageSource) {
<span class="fc" id="L522">        return new ConversationParticipantBuilder(teamUserManager, messageSource);</span>
    }

    @Bean
    public ReplyFeasibilityService replyFeasibilityService(EncounterManager encounterManager, QuestionnaireManager questionnaireManager, TeamUserManager teamUserManager,
                                                           UserManager userManager) {
<span class="fc" id="L528">        return new ReplyFeasibilityService(encounterManager, questionnaireManager, teamUserManager, userManager);</span>
    }

    @Bean
    public ClinicianMultipleTeamService clinicianMultipleTeamService(LoggedInUserUtil loggedInUserUtil) {
<span class="fc" id="L533">        return new ClinicianMultipleTeamService(loggedInUserUtil);</span>
    }

    @Bean
    public PatientConsentTeamService patientConsentTeamService(ConsentIndividualMapper consentIndividualMapper,
                                                               ConsentTeamMapper consentTeamMapper,
                                                               PatientConsentManager patientConsentManager,
                                                               InvitationManager invitationManager,
                                                               MedmijService medmijService,
                                                               PatientRegistrationConsentService patientRegistrationConsentService) {
<span class="fc" id="L543">        return new PatientConsentTeamService(consentIndividualMapper, consentTeamMapper, patientConsentManager, medmijService</span>
        );
    }

    @Bean
    public AutoSaveService autoSaveService(LoggedInUserUtil loggedInUserUtil, EncounterManager encounterManager) {
<span class="fc" id="L549">        return new AutoSaveService(loggedInUserUtil, encounterManager);</span>
    }

    @Bean
    public TimelineChartUtil timelineChartUtil(DateTimeService dateTimeService, DateUtil dateUtil) {
<span class="fc" id="L554">        return new TimelineChartUtil(dateTimeService, dateUtil);</span>
    }

    @Bean
    public UserProfileDataSourceFactory userProfileDataSourceFactory(LoggedInUserUtil loggedInUserUtil,
                                                                     ContextUserUtil contextUserUtil,
                                                                     UserManager userManager,
                                                                     TeamUserManager teamUserManager,
                                                                     ReminderManager reminderManager,
                                                                     PersonContactManager personContactManager,
                                                                     PKBEmailMessageManager emailMessageManager,
                                                                     PatientConsentManager patientConsentManager,
                                                                     DateTimeService dateTimeService,
                                                                     OrgNetworkService orgNetworkManager) {
<span class="fc" id="L568">        return new UserProfileDataSourceFactory(loggedInUserUtil, contextUserUtil,</span>
                userManager, teamUserManager, reminderManager, personContactManager, emailMessageManager,
                patientConsentManager, dateTimeService, orgNetworkManager);
    }

    @Bean
    public MeasurementUtil measurementUtil(DateUtil dateUtil) {
<span class="fc" id="L575">        return new MeasurementUtil(dateUtil);</span>
    }

    @Bean
    public MeasurementApiHelper measurementApiHelper(MeasurementManager measurementManager, UserAccessManager userAccessManager,
                                                     DateUtil dateUtil, LocalizedTextProvider localizedTextProvider) {
<span class="fc" id="L581">        return new MeasurementApiHelper(measurementManager, userAccessManager, dateUtil, localizedTextProvider);</span>
    }

    @Bean
    public SymptomApiHelper symptomApiHelper(SymptomReportManager symptomReportManager, TeamUserManager teamUserManager, DateUtil dateUtil, UserManager userManager,
                                             LocalizedTextProvider localizedTextProvider) {
<span class="fc" id="L587">        return new SymptomApiHelper(symptomReportManager, teamUserManager, dateUtil, localizedTextProvider, userManager);</span>
    }

    @Bean
    public com.pkb.api.util.TestsApiHelper testsApiHelperV1(TestManager testManager, LocalizedTextProvider localizedTextProvider) {
<span class="fc" id="L592">        return new com.pkb.api.util.TestsApiHelper(testManager, localizedTextProvider);</span>
    }

    @Bean
    public com.pkb.api.util.v2.TestsApiHelper testsApiHelperV2(TestManager testManager, LoincManager loincManager, LocalizedTextProvider localizedTextProvider) {
<span class="fc" id="L597">        return new com.pkb.api.util.v2.TestsApiHelper(testManager, loincManager, localizedTextProvider);</span>
    }

    @Bean
    public CarePlanConverter carePlanConverter(DateUtil dateUtil) {
<span class="fc" id="L602">        return new CarePlanConverter(dateUtil);</span>
    }

    @Bean
    public PhPlanToPlanDtoConverter phPlanToPlanDtoConverter(LocalizedTextProvider localizedTextProvider, PlanManager planManager) {
<span class="fc" id="L607">        return new PhPlanToPlanDtoConverter(localizedTextProvider, planManager);</span>
    }

    @Bean
    public ParticipantSelectorService participantSelectorService(MessageWebBean messageWebBean,
                                                                 TeamManager teamManager,
                                                                 TeamUserManager teamUserManager,
                                                                 TeamMapper teamMapper,
                                                                 LocalizedTextProvider localizedTextProvider) {
<span class="fc" id="L616">        return new ParticipantSelectorService(messageWebBean, teamManager, teamUserManager, teamMapper, localizedTextProvider);</span>
    }

    @Bean
    public EmisMessageHelper emisErrorMessageHelper(OdsService odsService, EmisAppointmentManager emisAppointmentManager, MessageSource messageSource) {
<span class="fc" id="L621">        return new EmisMessageHelper(odsService, emisAppointmentManager, messageSource);</span>
    }

    @Bean
    public ApplicationListener&lt;ContextRefreshedEvent&gt; emisSessionCacheClearer(EmisSessionService emisSessionService) {
        // This cannot be converted to a lambda without confusing Spring about what type of listener it is.
        //noinspection Convert2Lambda
<span class="fc" id="L628">        return new ApplicationListener&lt;&gt;() {</span>
            @Override
            public void onApplicationEvent(@NotNull ContextRefreshedEvent event) {
<span class="fc" id="L631">                event.getApplicationContext().getBean(UserManager.class).addLogoutListener(emisSessionService::removeSession);</span>
<span class="fc" id="L632">            }</span>
        };
    }

    @Bean
    public Kms kmsClient() {
<span class="fc" id="L638">        return CDI.current().select(Kms.class).get();</span>
    }

    @Bean
    public InboxService inboxService(UserManager userManager, PhrConfig config, IMessageWebBean messageWebBean, EncounterManager encounterManager, MessageSource messageSource,
                                     DateTimeService dateTimeService, ReferenceDataManager referenceDataManager, PrivacyUtil privacyUtil, TeamUserManager teamUserManager,
                                     ConversationWorkflowFlagService conversationWorkflowFlagService,
                                     QuestionnaireManager questionnaireManager, PKBPersonToMessagingPKBPersonDTOConverter pkbPersonDTOConverter) {
<span class="fc" id="L646">        return new InboxService(userManager, config, messageWebBean, encounterManager, messageSource, dateTimeService, referenceDataManager, privacyUtil, teamUserManager,</span>
                conversationWorkflowFlagService, questionnaireManager, pkbPersonDTOConverter);
    }

    @Bean
    public ConversationWorkflowFlagService messageWorkflowService(PhrConfig config) {
<span class="fc" id="L652">        return new ConversationWorkflowFlagService(config);</span>
    }

    @Bean
    public EncounterClassLocalizationHelper encounterClassLocalizationHelper() {
<span class="fc" id="L657">        return new EncounterClassLocalizationHelper();</span>
    }

    @Bean
    public GenderStringLocalizationHelper genderStringLocalizationHelper() {
<span class="fc" id="L662">        return new GenderStringLocalizationHelper();</span>
    }

    @Bean
    public GenderLimitedStringLocalizationHelper genderLimitedStringLocalizationHelper() {
<span class="fc" id="L667">        return new GenderLimitedStringLocalizationHelper();</span>
    }

    @Bean
    public GenderLocalizationHelper genderLocalizationHelper() {
<span class="fc" id="L672">        return new GenderLocalizationHelper();</span>
    }

    @Bean
    public UserTypeLocalizationHelper userTypeLocalizationHelper() {
<span class="fc" id="L677">        return new UserTypeLocalizationHelper();</span>
    }

    @Bean
    public MonthMapShortKeyLocalizationHelper monthMapShortKeyLocalizationHelper() {
<span class="fc" id="L682">        return new MonthMapShortKeyLocalizationHelper();</span>
    }

    @Bean
    public InvitationNationalIdValidator invitationNationalIdValidator() {
<span class="fc" id="L687">        return new InvitationNationalIdValidator();</span>
    }

    @Bean
    public CandidateFinderService candidateFinderService(UserManager userManager,
                                                         TeamUserManager teamUserManager,
                                                         RegistrationFailedAttemptLogService failedAttemptLogService,
                                                         PhrConfig config,
                                                         DateTimeService dateTimeService) {
<span class="fc" id="L696">        var validators = List.of(</span>
                new LenientLastNameValidator(),
                new LenientDateOfBirthValidator(),
                new LenientPostalCodeValidator());

<span class="fc" id="L701">        return new CandidateFinderService(userManager, teamUserManager, dateTimeService, failedAttemptLogService, config, validators);</span>
    }

    @Bean
    public PasswordResetService passwordResetService(
            CandidateFinderService candidateFinderService,
            UserManager userManager,
            TeamUserManager teamUserManager,
            DateTimeService dateTimeService,
            PasswordResetEmailSender emailSender) {

<span class="fc" id="L712">        var passwordResetEvents = new PasswordResetEvents();</span>

<span class="fc" id="L714">        return new PasswordResetService(</span>
                passwordResetEvents,
                candidateFinderService,
                userManager,
                teamUserManager,
                dateTimeService,
                emailSender);
    }

    @Bean
    public MessageApiHelper MessageApiHelper(EncounterManager encounterManager, IMessageWebBean messageWebBean) {
<span class="fc" id="L725">        return new MessageApiHelper(encounterManager, messageWebBean);</span>
    }

    @Bean
    public PatientRegistrationConsentService patientRegistrationConsentService(ProgressItemMapper progressItemMapper,
                                                                               TeamManager teamManager,
                                                                               TeamUserManager teamUserManager,
                                                                               UserManager userManager,
                                                                               PatientConsentManager patientConsentManager) {
<span class="fc" id="L734">        return new PatientRegistrationConsentService(progressItemMapper, teamManager, teamUserManager, userManager, patientConsentManager);</span>
    }

    @Bean
    public EditPrivacyService editPrivacyService(AppointmentsService appointmentsService,
                                                 DataPointManager dataPointManager,
                                                 MessageSource messageSource,
                                                 PrivacyService privacyService,
                                                 UserManager userManager,
                                                 PersonalLibraryManager personalLibraryManager) {
<span class="fc" id="L744">        return new EditPrivacyService(appointmentsService, dataPointManager, messageSource, privacyService, userManager, personalLibraryManager);</span>
    }

    @Bean
    public DatapointExternalIntegrationUrlService datapointExternalIntegrationUrlService(DatapointExternalIntegrationUrlRepository repository, DateTimeService dateTimeService) {
<span class="fc" id="L749">        return new DatapointExternalIntegrationUrlService(repository, dateTimeService);</span>
    }

    @Bean
    public AppointmentManagementPartnerService appointmentManagementPartnerService(PhrConfig config, DatapointExternalIntegrationUrlService datapointExternalIntegrationUrlService) {
<span class="fc" id="L754">        return new AppointmentManagementPartnerService(config, datapointExternalIntegrationUrlService);</span>
    }

    @Bean
    public AppointmentsService appointmentsService(AppointmentEntryMapper appointmentEntryMapper,
                                                   AppointmentTransformer appointmentTransformer,
                                                   AppointmentViewMapper appointmentViewMapper,
                                                   AppointmentActionsMapper appointmentActionsMapper,
                                                   CalendarManager calendarManager,
                                                   DataPointManager dataPointManager,
                                                   DateTimeService dateTimeService,
                                                   DateUtil dateUtil,
                                                   EmisAppointmentManager emisAppointmentManager,
                                                   EmisAppointmentService emisAppointmentService,
                                                   EmisMessageHelper emisMessageHelper,
                                                   INotificationManager notificationManager,
                                                   MessageSource messageSource,
                                                   PrimaryEmailContactManager primaryEmailContactManager,
                                                   PhrConfig phrConfig,
                                                   PatientConsentManager patientConsentManager,
                                                   UserManager userManager,
                                                   EncounterManager encounterManager,
                                                   ParticipantSelectorService participantSelectorService,
                                                   UUIDProvider uuidProvider,
                                                   AppointmentManagementPartnerService appointmentManagementPartnerService,
                                                   AppointmentMessagingSettingsService appointmentMessagingSettingsService) {
<span class="fc" id="L780">        return new AppointmentsService(appointmentActionsMapper, appointmentEntryMapper, appointmentTransformer, appointmentViewMapper, calendarManager, dataPointManager,</span>
                dateTimeService, dateUtil, emisAppointmentManager, emisAppointmentService, emisMessageHelper, notificationManager, messageSource, primaryEmailContactManager,
                phrConfig, patientConsentManager, userManager, encounterManager, participantSelectorService, uuidProvider,
                appointmentManagementPartnerService, appointmentMessagingSettingsService);
    }

    @Bean
    public LibraryService libraryService(PersonalLibraryManager personalLibraryManager,
                                         DataPointManager dataPointManager,
                                         MessageSource messageSource,
                                         TeamUserManager teamUserManager) {
<span class="fc" id="L791">        return new LibraryService(personalLibraryManager, dataPointManager, messageSource,</span>
                teamUserManager);
    }

    /**
     * This allows us to inject all of the custom configuration files from the pkb-common config system
     * into the spring environment so that they can be referenced via spring property mechanisms
     */
    @Bean
    public static LoggingPropertyPlaceholderConfigurer propertyPlaceholderConfigurer(@Value(&quot;#{systemProperties.pkbConfigPath}&quot;) String configPath) throws IOException {
<span class="fc" id="L801">        var bean = new LoggingPropertyPlaceholderConfigurer();</span>
<span class="fc" id="L802">        var resolver = new PathMatchingResourcePatternResolver();</span>

<span class="fc" id="L804">        var locations = Stream.of(resolver.getResources(&quot;classpath:config/default.properties&quot;), resolver.getResources(&quot;file:///&quot; + configPath + &quot;/*.properties&quot;), resolver.getResources(&quot;classpath:**/swagger.properties&quot;))</span>
<span class="fc" id="L805">                .flatMap(Stream::of)</span>
<span class="fc" id="L806">                .toArray(Resource[]::new);</span>

<span class="fc" id="L808">        bean.setLocations(locations);</span>
<span class="fc" id="L809">        return bean;</span>
    }

    @Bean
    public OrgSurvivingStateService orgSurvivingStateService(OrgSurvivingStateRepository repository, DateTimeService dateTimeService, UUIDProvider uuidProvider) {
<span class="fc" id="L814">        return new OrgSurvivingStateService(repository, dateTimeService, uuidProvider);</span>
    }

    @Bean
    public CodingTranslationService codingTranslationService(CodingTranslationRepository repository, UUIDProvider uuidProvider) {
<span class="fc" id="L819">        return new CodingTranslationService(repository, uuidProvider);</span>
    }

    @Bean
    public DiscussDatapointService discussDatapointService(DataPointManager dataPointManager,
                                                           MessageSource messageSource,
                                                           PersonalLibraryManager personalLibraryManager,
                                                           TeamUserManager teamUserManager,
                                                           PhrConfig config) {
<span class="fc" id="L828">        return new DiscussDatapointService(dataPointManager, messageSource, personalLibraryManager, teamUserManager, config) ;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>