<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Activity.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.notification.entity</a> &gt; <span class="el_source">Activity.java</span></div><h1>Activity.java</h1><pre class="source lang-java linenums">//---------------------------------------------------------------------------
//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: NotificationDTO.java Aug 19, 2011 8:35:30 PM pravinam$
//
//---------------------------------------------------------------------------

package com.pkb.notification.entity;

import com.pkb.entities.enums.Message;
import org.owasp.encoder.Encode;

import java.io.Serializable;
import java.net.URL;
import java.time.Instant;
import java.time.Period;
import java.util.Date;
import java.util.EnumMap;
import java.util.Map;
import java.util.Optional;

import static com.pkb.entities.enums.Message.ACTIVITY_NOTIFICATION_TO_PATIENT_V2;
import static com.pkb.entities.enums.Message.ACTIVITY_NOTIFICATION_TO_SELF_V2;

/**
 * A DTO to carry the information required to notify the account owner
 * about the activities happened in the account
 *
 * @author pravinam
 *
 */
public class Activity implements Serializable {

    private static final long serialVersionUID = 1L;

<span class="fc" id="L37">    enum Throttleable {</span>
<span class="fc" id="L38">        YES, NO</span>
    }

<span class="fc" id="L41">    enum Suppressable {</span>
<span class="fc" id="L42">        YES, NO</span>
    }

<span class="fc" id="L45">    public enum Action {</span>
        // these are grouped by general type of data; see actionLabels.properties
<span class="fc" id="L47">        CREATED_ACCOUNT(Throttleable.NO, Suppressable.NO),</span>
<span class="fc" id="L48">        CREATED_NOCONTACT_ACCOUNT(Throttleable.NO, Suppressable.NO),</span>
<span class="fc" id="L49">        ACCOUNT_DEACTIVATED(Throttleable.NO, Suppressable.NO),</span>
<span class="fc" id="L50">        CREATED_DEPENDENT_ACCOUNT(Throttleable.NO, Suppressable.NO),</span>
<span class="fc" id="L51">        ADDED_CAREGIVER(Throttleable.NO, Suppressable.NO),</span>
<span class="fc" id="L52">        SENT_INVITATION(Throttleable.NO, Suppressable.NO),</span>
<span class="fc" id="L53">        ACCEPTED_INVITATION(Throttleable.NO, Suppressable.NO),</span>
<span class="fc" id="L54">        LINKED_PATIENT(Throttleable.NO, Suppressable.NO),</span>
<span class="fc" id="L55">        LINKED_TO_CONSULT_TEAM(Throttleable.NO, Suppressable.NO),</span>
<span class="fc" id="L56">        ASSIGNED_PATIENTS(Throttleable.NO, Suppressable.NO),</span>
<span class="fc" id="L57">        ASSIGNED_CLINICIANS(Throttleable.NO, Suppressable.NO),</span>
<span class="fc" id="L58">        UPDATED_CONSENT_RECORD(Throttleable.NO, Suppressable.NO),</span>

<span class="fc" id="L60">        UPDATED_PROFILE(Throttleable.YES, Suppressable.NO, &quot;auth/manageUserProfileForm.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L61">        ADDED_CONTACT_SELF(Throttleable.NO, Suppressable.NO, &quot;auth/manageUserProfileForm.action&quot;, ACTIVITY_NOTIFICATION_TO_SELF_V2),</span>
<span class="fc" id="L62">        ADDED_CONTACT_OTHERS(Throttleable.NO, Suppressable.NO, &quot;auth/manageUserProfileForm.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>

<span class="fc" id="L64">        ADDED_MEDICATION_RECORD(Throttleable.YES, Suppressable.YES, &quot;auth/manageMedications.action&quot;, &quot;&amp;tab=treatments&amp;subTab=medications&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L65">        EDITED_MEDICATION_RECORD(Throttleable.YES, Suppressable.YES, &quot;auth/manageMedications.action&quot;, &quot;&amp;tab=treatments&amp;subTab=medications&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L66">        DELETED_MEDICATION_RECORD(Throttleable.YES, Suppressable.YES, &quot;auth/manageMedications.action&quot;, &quot;&amp;tab=treatments&amp;subTab=medications&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>

<span class="fc" id="L68">        ADDED_DIAGNOSIS(Throttleable.YES, Suppressable.YES, &quot;diagnoses/viewDiagnoses.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L69">        UPDATED_DIAGNOSIS(Throttleable.YES, Suppressable.YES, &quot;diagnoses/viewDiagnoses.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L70">        DELETED_DIAGNOSIS(Throttleable.YES, Suppressable.YES, &quot;diagnoses/getDiagnosisForm.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>

<span class="fc" id="L72">        ADDED_ALLERGY(Throttleable.YES, Suppressable.YES, &quot;allergies/viewAllergies.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L73">        UPDATED_ALLERGY(Throttleable.YES, Suppressable.YES, &quot;allergies/viewAllergies.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L74">        DELETED_ALLERGY(Throttleable.YES, Suppressable.YES, &quot;allergies/viewAllergies.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>

<span class="fc" id="L76">        ADDED_SYMPTOM(Throttleable.YES, Suppressable.YES),</span>
<span class="fc" id="L77">        UPDATED_SYMPTOM(Throttleable.YES, Suppressable.YES),</span>
<span class="fc" id="L78">        DELETED_SYMPTOM(Throttleable.YES, Suppressable.YES),</span>

<span class="fc" id="L80">        ADDED_DIARY_ENTRY(Throttleable.YES, Suppressable.YES, &quot;diary/viewDiary.action&quot;, &quot;&amp;tab=diary&amp;subTab=journal&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L81">        EDITED_DIARY_ENTRY(Throttleable.YES, Suppressable.YES, &quot;diary/viewDiary.action&quot;, &quot;&amp;tab=diary&amp;subTab=journal&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L82">        INVITED_TO_APPOINTMENT(Throttleable.NO, Suppressable.YES, &quot;diary/viewAppointment.action&quot;, &quot;&amp;uniqueId=%s&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L83">        EDITED_APPOINTMENT(Throttleable.NO, Suppressable.YES, &quot;diary/viewAppointment.action&quot;, &quot;&amp;uniqueId=%s&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L84">        URL_ADDED_TO_APPOINTMENT(Throttleable.NO, Suppressable.YES, &quot;diary/viewAppointment.action&quot;, &quot;&amp;uniqueId=%s&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L85">        UNINVITED_FROM_APPOINTMENT(Throttleable.NO, Suppressable.YES),</span>
<span class="fc" id="L86">        DELETED_APPOINTMENT(Throttleable.NO, Suppressable.YES, &quot;diary/viewAppointment.action&quot;, &quot;&amp;uniqueId=%s&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L87">        CANCELLED_APPOINTMENT(Throttleable.NO, Suppressable.YES, &quot;diary/viewAppointment.action&quot;, &quot;&amp;uniqueId=%s&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>

<span class="fc" id="L89">        SENT_MESSAGE(Throttleable.NO, Suppressable.NO, &quot;auth/getInbox.action&quot;, &quot;&amp;tab=messages&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>

<span class="fc" id="L91">        ADDED_FILE(Throttleable.YES, Suppressable.YES, &quot;file/myFiles.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L92">        DELETED_FILE(Throttleable.YES, Suppressable.YES, &quot;file/myFiles.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>

<span class="fc" id="L94">        ADDED_PLAN(Throttleable.NO, Suppressable.NO, &quot;auth/listPlans.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L95">        UPDATED_PLAN(Throttleable.NO, Suppressable.NO, &quot;auth/listPlans.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L96">        UPLOADED_PHPLAN(Throttleable.NO, Suppressable.NO, &quot;auth/listPlans.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L97">        APPROVED_PLAN(Throttleable.YES, Suppressable.NO),</span>
<span class="fc" id="L98">        EXPORTED_PLANS(Throttleable.YES, Suppressable.NO),</span>

<span class="fc" id="L100">        UPLOADED_LAB_RESULTS(Throttleable.YES, Suppressable.YES, &quot;test/myTests.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L101">        DELETED_LAB_RESULTS(Throttleable.YES, Suppressable.YES, &quot;test/myTests.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L102">        UPLOADED_LAB_RESULTS_WITH_DELAY(Throttleable.YES, Suppressable.YES, &quot;test/myTests.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L103">        UPLOADED_RADIOLOGY(Throttleable.YES, Suppressable.YES, &quot;media/viewRadiologyResults.action&quot;, &quot;&amp;subTab=imaging&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L104">        DELETED_RADIOLOGY(Throttleable.YES, Suppressable.YES, &quot;media/viewRadiologyResults.action&quot;, &quot;&amp;subTab=imaging&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L105">        UPLOADED_AUDIO(Throttleable.YES, Suppressable.YES, &quot;media/viewRadiologyResults.action&quot;, &quot;&amp;subTab=audio&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L106">        DELETED_AUDIO(Throttleable.YES, Suppressable.YES, &quot;media/viewRadiologyResults.action&quot;, &quot;&amp;subTab=audio&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L107">        UPLOADED_MEASUREMENTS(Throttleable.YES, Suppressable.YES, &quot;test/myMeasurements.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L108">        UPLOADED_PATIENT_PROFILE_UPDATE(Throttleable.YES, Suppressable.NO, &quot;auth/manageUserProfileForm.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>

<span class="fc" id="L110">        REGISTERED(Throttleable.NO, Suppressable.NO),</span>
<span class="fc" id="L111">        GRANTED_ACCESS(Throttleable.NO, Suppressable.NO),</span>

<span class="fc" id="L113">        RECORD_FROZEN(Throttleable.NO, Suppressable.NO),</span>
<span class="fc" id="L114">        RECORD_UNFROZEN(Throttleable.NO, Suppressable.NO),</span>

<span class="fc" id="L116">        ADDED_LIBRARY_LINK(Throttleable.YES, Suppressable.YES, &quot;library/manageLibrary.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L117">        DELETED_LIBRARY_LINK(Throttleable.YES, Suppressable.YES, &quot;library/manageLibrary.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>

<span class="fc" id="L119">        DOCUMENT_RECEIVED(Throttleable.NO, Suppressable.YES),</span>
<span class="fc" id="L120">        DOCUMENT_WITHDRAWN(Throttleable.YES, Suppressable.YES, &quot;auth/showConversation.action&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>

        // Currently only used for privacy flag notification
<span class="fc" id="L123">        VIEW_GENETICS(Throttleable.NO, Suppressable.NO, &quot;file/genetics.action&quot;, &quot;&amp;tab=health&amp;subTab=genetics&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L124">        VIEW_CONVERSATION(Throttleable.NO, Suppressable.NO, &quot;auth/showConversation.action&quot;, &quot;&amp;conversationId=%s&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2),</span>
<span class="fc" id="L125">        VIEW_PHPLAN(Throttleable.NO, Suppressable.NO, &quot;auth/viewPlan.action&quot;, &quot;&amp;planId=%s&quot;, ACTIVITY_NOTIFICATION_TO_PATIENT_V2);</span>

        private final Throttleable throttleable;

        private final Suppressable suppressable;

        /** allows the path to be specified where the user can query the changes that have been made by the action **/
        private final String userQueryPath;

        /** allows the params for the path to be specified where the user can query the changes that have been made by the action **/
        private final String userQueryParams;

        /** allows the Message Enum to be specified on an Activity by Activity basis if needed **/
        private final Message actualMessage;

        Action(Throttleable throttleable, Suppressable suppressable) {
<span class="fc" id="L141">            this(throttleable, suppressable, &quot;&quot;, &quot;&quot;, null);</span>
<span class="fc" id="L142">        }</span>

        Action(Throttleable throttleable, Suppressable suppressable, String userQueryPath, Message actualMessage) {
<span class="fc" id="L145">            this(throttleable, suppressable, userQueryPath, &quot;&quot;, actualMessage);</span>
<span class="fc" id="L146">        }</span>

<span class="fc" id="L148">        Action(Throttleable throttleable, Suppressable suppressable, String userQueryPath, String userQueryParams, Message actualMessage) {</span>
<span class="fc" id="L149">            this.throttleable = throttleable;</span>
<span class="fc" id="L150">            this.suppressable = suppressable;</span>
<span class="fc" id="L151">            this.userQueryPath = userQueryPath;</span>
<span class="fc" id="L152">            this.userQueryParams = userQueryParams;</span>
<span class="fc" id="L153">            this.actualMessage = actualMessage;</span>
<span class="fc" id="L154">        }</span>

        /**
         * Determines whether the notification email for this action can be throttled (sending is skipped if recipient received an email today) .
         * For now we don't throttle sharing and discussion notifications .
         **/
        public boolean canBeThrottled() {
<span class="fc bfc" id="L161" title="All 2 branches covered.">            return throttleable == Throttleable.YES;</span>
        }

        public boolean canBeSupressed() {
<span class="fc bfc" id="L165" title="All 2 branches covered.">            return suppressable == Suppressable.YES;</span>
        }

        public String getUserQueryPath() {
<span class="fc" id="L169">            return userQueryPath;</span>
        }

        public String getUserQueryParams(Object... values) {
<span class="fc bfc" id="L173" title="All 2 branches covered.">            return Optional.ofNullable(values).map(objects -&gt; objects.length &lt; 1 ? String.format(userQueryParams, objects) : String.format(userQueryParams, Encode.forUriComponent(String.format(&quot;%s&quot;, objects)))).orElse(userQueryParams);</span>
        }

        public Message getActualMessage(Message defaultMessage) {
<span class="fc bfc" id="L177" title="All 2 branches covered.">            if (this.actualMessage != null) {</span>
<span class="fc" id="L178">                return this.actualMessage;</span>
            }
<span class="fc" id="L180">            return defaultMessage;</span>
        }

    }

    private Long id;

    private Long targetId;

    /**
     * This is still a string because there are some horrible bits of
     * code that do things like shoe-horning the name of an org
     * in here, sigh. If we can fix those we make this a Long like it
     * should be
     */
    private String actorId;

    private Long orgId;

    private Action action;

    private String actionUserQueryParams;

    private URL url;

    private Map&lt;ActivityProperty, String&gt; actionProperties;

    private Date timestamp;

<span class="fc" id="L209">    public Activity(Instant timestamp, Action action) {</span>
<span class="fc" id="L210">        this.timestamp = Date.from(timestamp);</span>
<span class="fc" id="L211">        this.action = action;</span>
<span class="fc" id="L212">    }</span>

<span class="fc" id="L214">    public Activity(Instant timestamp, Action action, Long orgId) {</span>
<span class="fc" id="L215">        this.timestamp = Date.from(timestamp);</span>
<span class="fc" id="L216">        this.action = action;</span>
<span class="fc" id="L217">        this.orgId = orgId;</span>
<span class="fc" id="L218">    }</span>

    public Activity(Action action, long pkbPersonId, Long orgId, Instant timestamp) {
<span class="fc" id="L221">        this(timestamp, action, orgId);</span>
<span class="fc" id="L222">        this.targetId = pkbPersonId;</span>
<span class="fc" id="L223">    }</span>

    public Long getId() {
<span class="nc" id="L226">        return id;</span>
    }

    public void setId(Long id) {
<span class="nc" id="L230">        this.id = id;</span>
<span class="nc" id="L231">    }</span>

    public String getActorId() {
<span class="fc" id="L234">        return actorId;</span>
    }

    public void setActorId(String actorId) {
<span class="fc" id="L238">        this.actorId = actorId;</span>
<span class="fc" id="L239">    }</span>

    public Long getOrgId() {
<span class="fc" id="L242">        return orgId;</span>
    }

    public void setOrgId(Long orgId) {
<span class="nc" id="L246">        this.orgId = orgId;</span>
<span class="nc" id="L247">    }</span>

    public Action getAction() {
<span class="fc" id="L250">        return action;</span>
    }

    public URL getUrl() {
<span class="fc" id="L254">        return url;</span>
    }

    public void setUrl(URL url) {
<span class="fc" id="L258">        this.url = url;</span>
<span class="fc" id="L259">    }</span>

    public Date getTimestamp() {
<span class="fc" id="L262">        return timestamp;</span>
    }

    public Long getTargetId() {
<span class="fc" id="L266">        return targetId;</span>
    }

    public void setTargetId(Long targetId) {
<span class="fc" id="L270">        this.targetId = targetId;</span>
<span class="fc" id="L271">    }</span>

    @Override
    public String toString() {
<span class="nc" id="L275">        StringBuilder buffer = new StringBuilder();</span>
<span class="nc" id="L276">        buffer.append(&quot;Activity[id=&quot;).append(this.id);</span>
<span class="nc" id="L277">        buffer.append(&quot;,action=&quot;).append(action);</span>
<span class="nc" id="L278">        buffer.append(&quot;,actorId=&quot;).append(actorId);</span>
<span class="nc" id="L279">        buffer.append(&quot;,targetId=&quot;).append(targetId);</span>
<span class="nc" id="L280">        buffer.append(&quot;,orgId=&quot;).append(orgId);</span>
<span class="nc bnc" id="L281" title="All 2 branches missed.">        if (url != null) {</span>
<span class="nc" id="L282">            buffer.append(&quot;,url=&quot;).append(url.toString());</span>
        }
<span class="nc" id="L284">        buffer.append(&quot;,timestamp=&quot;).append(timestamp);</span>
<span class="nc" id="L285">        buffer.append(&quot;]&quot;);</span>
<span class="nc" id="L286">        return buffer.toString();</span>
    }

    public Map&lt;ActivityProperty, String&gt; getActionProperties() {
<span class="nc bnc" id="L290" title="All 2 branches missed.">        if (actionProperties == null) {</span>
<span class="nc" id="L291">            this.actionProperties = new EnumMap&lt;&gt;(ActivityProperty.class);</span>
        }
<span class="nc" id="L293">        return actionProperties;</span>
    }

    public void setActionProperties(Map&lt;ActivityProperty, String&gt; actionProperties) {
<span class="fc" id="L297">        this.actionProperties = actionProperties;</span>
<span class="fc" id="L298">    }</span>

    public String getActionUserQueryParams() {
<span class="fc" id="L301">        return Optional.ofNullable(actionUserQueryParams).orElseGet(() -&gt; {</span>
<span class="fc" id="L302">            populateUserQueryParams();</span>
<span class="fc" id="L303">            return actionUserQueryParams;</span>
        });
    }

    public void populateUserQueryParams(Object... values) {
<span class="fc" id="L308">        this.actionUserQueryParams = action.getUserQueryParams(values);</span>
<span class="fc" id="L309">    }</span>

    public boolean sendHistorical(Instant now) {
<span class="fc bfc" id="L312" title="All 3 branches covered.">        switch (this.getAction()) {</span>
            case INVITED_TO_APPOINTMENT:
            case EDITED_APPOINTMENT:
            case UNINVITED_FROM_APPOINTMENT:
            case DELETED_APPOINTMENT:
            case CANCELLED_APPOINTMENT:
<span class="fc bfc" id="L318" title="All 2 branches covered.">                return now.compareTo(getTimestamp().toInstant()) &lt;= 0;</span>
            case DOCUMENT_RECEIVED:
<span class="fc bfc" id="L320" title="All 2 branches covered.">                return ((Instant) Period.ofWeeks(1).subtractFrom(now)).compareTo(getTimestamp().toInstant()) &lt;= 0;</span>
            default:
<span class="fc" id="L322">                return true;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>