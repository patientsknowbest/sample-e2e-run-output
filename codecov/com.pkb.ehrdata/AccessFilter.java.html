<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AccessFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.ehrdata</a> &gt; <span class="el_source">AccessFilter.java</span></div><h1>AccessFilter.java</h1><pre class="source lang-java linenums">package com.pkb.ehrdata;

import org.immutables.value.Value;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Optional;
import java.util.stream.Stream;

import static com.google.common.base.Preconditions.checkState;
import static io.vavr.Predicates.is;
import static java.lang.invoke.MethodHandles.lookup;

// TODO: This is defining additional 'authorization' at the query level,
//  but it's doing so totally separately from the Policy layer.
//  Could you change the policy layer so it builds AccessFilter itself?
//  I think so. Addressable in GDE-725
@Value.Style(stagedBuilder = true)
@Value.Immutable
<span class="fc" id="L20">public abstract class AccessFilter {</span>

<span class="fc" id="L22">    private static final Logger LOG = LoggerFactory.getLogger(lookup().lookupClass());</span>

    /**
     * Applies TDV conditions to query.
     * Should be true IFF the current user is a team professional.
     */
    public abstract boolean isTeamDataViewApplicable();

    /**
     * Should only be true IF the client is SYNERTEC.
     */
    public abstract Optional&lt;Boolean&gt; isReadReceiptApplicable();

    /**
     * See com.pkb.app.entity.EHRRequestContext#isPiggyback()
     */
    public abstract boolean isPiggyback();

    /**
     * See com.pkb.consent.entity.ConsentStatus#required
     */
    public abstract boolean isConsentNotRequired();

    public abstract boolean isBreakTheGlassActive();

    /**
     * Applies PVS conditions to the query.
     * See com.pkb.app.entity.EHRRequestContext#isPatientViewSuspendedRequired()
     */
    public abstract boolean isPatientViewSuspendedRequired();

    public abstract Optional&lt;PrivacyFilter&gt; getPrivacyFilter();

    @Value.Default
    public boolean isDecryptAccessRequired() {
<span class="fc" id="L57">        return true;</span>
    }
    
    public abstract Optional&lt;Long&gt; actorPersonId();

    public abstract Optional&lt;Long&gt; actorTeamId();

    public abstract Optional&lt;Long&gt; actorOrgId();

    @Value.Default
    public Optional&lt;Long&gt; sourceOrgId() {
<span class="fc" id="L68">        return actorOrgId();</span>
    }

    /**
     * True if the menudata query may subselect against view_account_key_links to ascertain crypto access.
     *
     * This subselect is potentially very slow, but conveniently checks for both org/user access to a target account
     * (which is helpful when e.g. a team pro with org keys is looking at their own account to see message drafts in a
     * conversation with a patient).
     *
     * It defaults to true so that existing codepaths are unaffected, but can be optionally switched off if a particular
     * codepath is suffering performance problems (e.g. read receipts via the doc-ref FHIR endpoint - see PHR-5032)
     */
    @Value.Default
    public boolean isAccountLinksJoinPermitted() {
<span class="fc" id="L83">        return true;</span>
    }

    @Value.Derived
    public boolean isConsentFilteringBypassed() {
<span class="fc" id="L88">        return Stream.of(isPiggyback(), isConsentNotRequired(), isBreakTheGlassActive())</span>
<span class="fc" id="L89">                .anyMatch(is(true));</span>
    }

    @Value.Derived
    public boolean isTeamDataViewOnly() {
<span class="fc bfc" id="L94" title="All 4 branches covered.">        return !getPrivacyFilter().isPresent() &amp;&amp; isTeamDataViewApplicable();</span>
    }

    @Value.Check
    protected void check() {
        // Assuming we have context for the request, then we must be in either a bypass state (BTG, patient viewing
        // their own account etc), or in TDV, or a privacy filter must exist. Otherwise, explode.
<span class="fc bfc" id="L101" title="All 2 branches covered.">        checkState(isConsentFilteringBypassed()</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">                || isTeamDataViewOnly()</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">                || getPrivacyFilter().isPresent());</span>
<span class="fc" id="L104">    }</span>

    @Value.Check
    protected void checkActorOrgSet() {
<span class="fc bfc" id="L108" title="All 2 branches covered.">        if (actorTeamId().isPresent()) {</span>
<span class="fc" id="L109">            checkState(actorOrgId().isPresent(), &quot;actorTeamId set, but actorOrgId is not&quot;);</span>
        }
<span class="fc" id="L111">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>