<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NhsLoginConfirmPasswordAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.oauth2</a> &gt; <span class="el_source">NhsLoginConfirmPasswordAction.java</span></div><h1>NhsLoginConfirmPasswordAction.java</h1><pre class="source lang-java linenums">package com.pkb.action.oauth2;

import com.pkb.action.BaseAction;
import com.pkb.institute.entity.Team;
import com.pkb.service.team.TeamManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import org.apache.commons.lang3.StringUtils;
import org.apache.struts2.ServletActionContext;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.invoke.MethodHandles;
import java.util.List;

import static com.google.common.util.concurrent.Runnables.doNothing;
import static com.pkb.datamodel.ImmutableDisclosingEmail.disclosingEmail;
import static com.pkb.util.Constants.NHS_LOGIN_INFO;
import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.Match;
import static io.vavr.API.run;


<span class="fc" id="L25">public class NhsLoginConfirmPasswordAction extends BaseAction {</span>
<span class="fc" id="L26">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

    private static final String MSG_REG_INCOMPLETE = &quot;regIncomplete&quot;;
    private static final String MSG_TOO_MANY_LOGIN_ATTEMPTS = &quot;tooManyLoginAttempts&quot;;
    private static final String MSG_INVALID_TOKEN = &quot;invalidToken&quot;;
    private static final String MSG_RESET_IN_PROGRESS = &quot;resetInProgress&quot;;
    private static final String MSG_FROZEN_BY_TEAM = &quot;frozenByTeam&quot;;
    private static final String MSG_CONTACT_TEAM_FOR_ACCESS = &quot;contactTeamForAccess&quot;;
    private static final String MSG_REG_COMPLETE = &quot;regComplete&quot;;
    private static final String MSG_SESSION_TIMEOUT = &quot;timeout&quot;;
    private static final String MSG_AUTH = &quot;auth&quot;;

    private TeamManager teamManager;

    private String j_username; // Email to PKB site prepopulated from session
    private String j_password; // Password to PKB site user has to enter
    private String msg;

    @Override
    public String execute() {
<span class="fc bfc" id="L46" title="All 2 branches covered.">        if (isNhsSessionAttributeEmpty()) {</span>
<span class="fc" id="L47">            LOGGER.error(&quot;NHS login info not found in session attributes. Redirecting to error page.&quot;);</span>
<span class="fc" id="L48">            return ERROR;</span>
        }
<span class="fc" id="L50">        addActionErrors();</span>
<span class="fc" id="L51">        return SUCCESS;</span>
    }

    private boolean isNhsSessionAttributeEmpty() {
<span class="fc bfc" id="L55" title="All 2 branches covered.">        return ServletActionContext.getRequest().getSession().getAttribute(NHS_LOGIN_INFO) == null;</span>
    }

    private void addActionErrors() {
<span class="fc" id="L59">        Match(msg).of(</span>
<span class="fc" id="L60">                Case($(MSG_REG_INCOMPLETE),</span>
<span class="nc" id="L61">                        m -&gt; run(() -&gt; addActionError(getText(&quot;loginCheckAction.err.account_inactive&quot;)))),</span>
<span class="fc" id="L62">                Case($(MSG_REG_INCOMPLETE),</span>
<span class="nc" id="L63">                        m -&gt; run(() -&gt; addActionError(getText(&quot;loginCheckAction.err.not_completed_registration&quot;)))),</span>
<span class="fc" id="L64">                Case($(MSG_TOO_MANY_LOGIN_ATTEMPTS),</span>
<span class="fc" id="L65">                        m -&gt; run(() -&gt; addActionError(getText(&quot;loginCheckAction.err.too_many_login_attempts&quot;)))),</span>
<span class="fc" id="L66">                Case($(MSG_INVALID_TOKEN),</span>
<span class="nc" id="L67">                        m -&gt; run(() -&gt; addActionError(getText(&quot;loginCheckAction.err.invalid_token&quot;)))),</span>
<span class="fc" id="L68">                Case($(MSG_RESET_IN_PROGRESS),</span>
<span class="fc" id="L69">                        m -&gt; run(() -&gt; addActionMessage(getText(&quot;loginCheckAction.txt.please_check_email&quot;)))),</span>
<span class="fc" id="L70">                Case($(MSG_CONTACT_TEAM_FOR_ACCESS),</span>
<span class="nc" id="L71">                        m -&gt; run(() -&gt; addActionError(getText(&quot;loginCheckAction.err.contact_team_for_access&quot;)))),</span>
<span class="fc" id="L72">                Case($(MSG_REG_COMPLETE),</span>
<span class="nc" id="L73">                        m -&gt; run(() -&gt; addActionMessage(getText(&quot;loginCheckAction.txt.registration_success&quot;)))),</span>
<span class="fc" id="L74">                Case($(MSG_SESSION_TIMEOUT),</span>
<span class="nc" id="L75">                        m -&gt; run(() -&gt; addActionError(getText(&quot;loginCheckAction.err.session_timed_out&quot;)))),</span>
<span class="fc" id="L76">                Case($(MSG_AUTH),</span>
<span class="fc" id="L77">                        m -&gt; run(() -&gt; addActionError(getText(&quot;loginCheckAction.err.invalid_username_or_password&quot;)))),</span>
<span class="fc" id="L78">                Case($(MSG_FROZEN_BY_TEAM),</span>
<span class="nc" id="L79">                        m -&gt; run(() -&gt; {</span>
                            // can we figure out what team froze them?
<span class="nc" id="L81">                            Team freezingTeam = null;</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">                            if (StringUtils.isNotBlank(j_username)) {</span>
<span class="nc" id="L83">                                List&lt;PKBPerson&gt; persons = userManager.getPKBPersonByConfirmedOrPrimaryEmail(disclosingEmail(j_username));</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                                if (!persons.isEmpty()) {</span>
<span class="nc" id="L85">                                    Long teamId = persons.get(0).getFrozenByTeamId();</span>
<span class="nc" id="L86">                                    freezingTeam = teamManager.getTeam(teamId);</span>
                                }
                            }
<span class="nc bnc" id="L89" title="All 2 branches missed.">                            if (freezingTeam != null) {</span>
<span class="nc" id="L90">                                addActionMessage(getText(&quot;global.msg.frozen_by_team&quot;,</span>
<span class="nc" id="L91">                                        new String[] { freezingTeam.getOrg().getName(), freezingTeam.getName() }));</span>
                            } else {
<span class="nc" id="L93">                                addActionMessage(getText(&quot;global.msg.frozen_by_team_generic&quot;));</span>
                            }
<span class="nc" id="L95">                        })),</span>
<span class="fc" id="L96">                Case($(), doNothing())</span>
        );
<span class="fc" id="L98">    }</span>

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L101">        this.userManager = userManager;</span>
<span class="fc" id="L102">    }</span>

    public void setTeamManager(TeamManager teamManager) {
<span class="fc" id="L105">        this.teamManager = teamManager;</span>
<span class="fc" id="L106">    }</span>

    public String getJ_username() {
<span class="nc" id="L109">        return j_username;</span>
    }

    public void setJ_username(String j_username) {
<span class="nc" id="L113">        this.j_username = j_username;</span>
<span class="nc" id="L114">    }</span>

    public String getJ_password() {
<span class="nc" id="L117">        return j_password;</span>
    }

    public void setJ_password(String j_password) {
<span class="nc" id="L121">        this.j_password = j_password;</span>
<span class="nc" id="L122">    }</span>

    public String getMsg() {
<span class="nc" id="L125">        return msg;</span>
    }

    public void setMsg(String msg) {
<span class="fc" id="L129">        this.msg = msg;</span>
<span class="fc" id="L130">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>