<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EMISSSOAuthManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.sso.impl.emis</a> &gt; <span class="el_source">EMISSSOAuthManager.java</span></div><h1>EMISSSOAuthManager.java</h1><pre class="source lang-java linenums">package com.pkb.service.sso.impl.emis;

import com.pkb.app.entity.EHRRequestContext;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.domain.SSOService;
import com.pkb.entities.enums.SSOType;
import com.pkb.institute.entity.Team;
import com.pkb.kms.shared.representation.KmsError;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.user.entity.PKBPerson;
import com.pkb.util.tolven.TolvenBeanFactory;
import com.pkb.util.tolven.TransactionManager;
import org.immutables.value.Value;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Optional;
import java.util.regex.Pattern;

public class EMISSSOAuthManager extends TransactionManager {

<span class="fc" id="L25">    private static final Logger LOGGER = LoggerFactory.getLogger(EMISSSOAuthManager.class);</span>

<span class="fc" id="L27">    private static final Pattern PERSON_PUBLIC_ID_ERROR_EXTRACTOR = Pattern.compile(&quot;personPublicId (\\p{XDigit}{8}(?:-\\p{XDigit}{4}){4}\\p{XDigit}{8})&quot;);</span>

    private final TeamUserManager teamUserManager;
    private final SSOService ssoService;

    public EMISSSOAuthManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider, TeamUserManager teamUserManager,
                              SSOService ssoService) {
<span class="fc" id="L34">        super(config, beanFactory, dateTimeService, uuidProvider);</span>
<span class="fc" id="L35">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L36">        this.ssoService = ssoService;</span>
<span class="fc" id="L37">    }</span>

    public LoginResult authenticateSSOUser(EHRRequestContext requestContext, @NotNull String username, @NotNull String ssoKey, @NotNull SSOType ssoType) {
<span class="fc" id="L40">        return ssoService.getSSOIdLinkForSSOUsernameAndSSOType(username, ssoType)</span>
<span class="fc" id="L41">                        .map(ssoIdLink -&gt; beanFactory.getPKBPersonBean().getPKBPerson(ssoIdLink.getPersonId()))</span>
<span class="fc" id="L42">                        .map(person -&gt; {</span>
<span class="fc" id="L43">                            var maybeTeamCode = teamUserManager.findActivePrimaryTeam(requestContext, person.getId()).map(Team::getCode);</span>
<span class="fc" id="L44">                            var builder = ImmutableLoginResult.builder()</span>
<span class="fc" id="L45">                                    .person(person)</span>
<span class="fc" id="L46">                                    .teamCode(maybeTeamCode);</span>
<span class="fc" id="L47">                            return ssoService.authenticateSsoUser(person.getPublicId(), ssoKey, ssoType)</span>
<span class="fc" id="L48">                                    .fold(builder::loginError, ignored -&gt; builder)</span>
<span class="fc" id="L49">                                    .build();</span>
                        })
<span class="pc" id="L51">                .orElseGet(() -&gt; ImmutableLoginResult.builder().build());</span>
    }


    @Value.Immutable
    public static interface LoginResult {
        Optional&lt;PKBPerson&gt; getPerson();
        Optional&lt;String&gt; getTeamCode();
        Optional&lt;KmsError&gt; getLoginError();

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>