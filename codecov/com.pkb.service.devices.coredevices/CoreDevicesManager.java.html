<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CoreDevicesManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.devices.coredevices</a> &gt; <span class="el_source">CoreDevicesManager.java</span></div><h1>CoreDevicesManager.java</h1><pre class="source lang-java linenums">package com.pkb.service.devices.coredevices;

import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.EHRSearch;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.PKBFilter;
import com.pkb.app.entity.SourceDetails;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.common.util.FrameFilter;
import com.pkb.coreDevices.entity.CoreDevicesSyncRecord;
import com.pkb.datamodel.CoreDevicesCredentials;
import com.pkb.dataupload.entity.UploadedData;
import com.pkb.domain.CoreDevicesCredentialsService;
import com.pkb.entities.enums.MenuDataType;
import com.pkb.entities.enums.Route;
import com.pkb.integration.coredevices.CoreDevice;
import com.pkb.integration.coredevices.CoreDeviceDataBatch;
import com.pkb.integration.coredevices.CoreDevicesClient;
import com.pkb.integration.coredevices.Notification;
import com.pkb.service.dataupload.processor.UploadedDataService;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.util.tolven.TolvenBeanFactory;
import com.pkb.util.tolven.TransactionManager;
import io.vavr.Tuple;
import io.vavr.Tuple3;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;
import java.lang.invoke.MethodHandles;
import java.util.Date;
import java.util.List;
import java.util.Optional;

import static com.pkb.service.dataupload.processor.ImmutableLoggedInUploadedDataProcessingContext.loggedInUploadedDataProcessingContext;

public class CoreDevicesManager extends TransactionManager {
<span class="fc" id="L41">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

    private final CoreDevicesClient coreDevicesClient;
    private final UploadedDataService uploadedDataService;
    private final CoreDevicesCredentialsService coreDevicesCredentialsService;

    public CoreDevicesManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider, CoreDevicesClient coreDevicesClient,
                              UploadedDataService uploadedDataService, CoreDevicesCredentialsService coreDevicesCredentialsService) {
<span class="fc" id="L49">        super(config, beanFactory, dateTimeService, uuidProvider);</span>
<span class="fc" id="L50">        this.coreDevicesClient = coreDevicesClient;</span>
<span class="fc" id="L51">        this.uploadedDataService = uploadedDataService;</span>
<span class="fc" id="L52">        this.coreDevicesCredentialsService = coreDevicesCredentialsService;</span>
<span class="fc" id="L53">    }</span>

    @NotNull
    private CoreDevicesCredentials getCoreDevicesCredentials(long patientId) {
        try {
<span class="fc" id="L58">            CoreDevicesCredentials coreDevicesCredentials = coreDevicesCredentialsService.getCoreDevicesCredentials(patientId).orElse(null);</span>

<span class="fc bfc" id="L60" title="All 2 branches covered.">            if (coreDevicesCredentials == null) {</span>
<span class="fc" id="L61">                String installationId = &quot;sj&quot;;</span>
                //before patient registration remove unneeded users to optimize available user pool
                //NOTE: in case of user starting device registration and then not completing it that user will stay provisioned but never used
<span class="fc" id="L64">                removeProvisionedUsers();</span>
<span class="fc" id="L65">                coreDevicesCredentials = coreDevicesClient.registerPatient(patientId, installationId);</span>
<span class="fc" id="L66">                coreDevicesCredentialsService.createCoreDevicesCredentials(coreDevicesCredentials);</span>
            }

<span class="fc" id="L69">            return coreDevicesCredentials;</span>
<span class="nc" id="L70">        } catch (Exception e) {</span>
<span class="nc" id="L71">            throw new IllegalStateException(&quot;Error while getting PublicCoreDevicesCredentials for patient-&quot; + patientId, e);</span>
        }
    }

    private void removeProvisionedUsers() throws IOException {
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">        if (config.isValidicProvisionedUsersMaturityEnabled()) {</span>
<span class="fc" id="L77">            coreDevicesClient.getProvisionedCoreDeviceUserId().forEach(provisionedCoreDeviceUserId -&gt; {</span>
                try {
<span class="fc" id="L79">                    coreDevicesClient.removeProvisionedUserFromValidicAndPHR(provisionedCoreDeviceUserId);</span>
<span class="fc" id="L80">                } catch(RuntimeException e) {</span>
<span class="fc" id="L81">                    LOGGER.error(e.getMessage(), e);</span>
<span class="fc" id="L82">                }</span>
<span class="fc" id="L83">            });</span>
        }
<span class="fc" id="L85">    }</span>

    public Optional&lt;String&gt; getCoreDevicesUserId(long patientId) {
<span class="fc" id="L88">        CoreDevicesCredentials credentials = getCoreDevicesCredentials(patientId);</span>
<span class="fc" id="L89">        return Optional.of(credentials).map(CoreDevicesCredentials::getCoreDevicesUserId);</span>
    }

    @Nullable
    public Long getPatientIdFromCoreDevicesUserId(String coreDevicesUserId) {
        try {
<span class="fc" id="L95">            return coreDevicesCredentialsService.getCoreDevicesCredentialsByCoreDevicesUserId(coreDevicesUserId)</span>
<span class="fc" id="L96">                    .map(CoreDevicesCredentials::getPatientId)</span>
<span class="fc" id="L97">                    .map(Long::parseLong)</span>
<span class="fc" id="L98">                    .orElse(null);</span>
<span class="nc" id="L99">        } catch (Exception e) {</span>
<span class="nc" id="L100">            throw new IllegalStateException(&quot;Error while getting PublicCoreDevicesCredentials for coreDevicesUserId-&quot; + coreDevicesUserId, e);</span>
        }
    }

    public List&lt;CoreDevice&gt; fetchAvailableDevices(long patientId) {
        try {
<span class="fc" id="L106">            return coreDevicesClient.fetchAllDevices(getCoreDevicesCredentials(patientId));</span>
<span class="nc" id="L107">        } catch (Exception e) {</span>
<span class="nc" id="L108">            throw new IllegalStateException(&quot;Error while fetching available devices for patient-&quot; + patientId, e);</span>
        }
    }

    public List&lt;CoreDevice&gt; fetchConnectedDevices(long patientId) {
        try {
<span class="fc" id="L114">            return coreDevicesClient.fetchConnectedDevices(getCoreDevicesCredentials(patientId));</span>
<span class="nc" id="L115">        } catch (Exception e) {</span>
<span class="nc" id="L116">            throw new IllegalStateException(&quot;Error while fetching connected devices for patient-&quot; + patientId, e);</span>
        }
    }

    // Nb should be called in the same transaction as saving the data
    public Tuple3&lt;CoreDeviceDataBatch, CoreDevicesSyncRecord, Long&gt; fetchData(EHRRequestContext requestContext,
                                                                              @NotNull String coreDevicesUserId,
                                                                              String category,
                                                                              String source) {
        try {
<span class="fc" id="L126">            var now = dateTimeService.now();</span>
<span class="fc" id="L127">            var credentials = coreDevicesCredentialsService.getCoreDevicesCredentialsByCoreDevicesUserId(coreDevicesUserId)</span>
<span class="pc" id="L128">                    .orElseThrow(() -&gt; new IllegalStateException(&quot;Unknown coreDevicesUserId-&quot; + coreDevicesUserId));</span>
<span class="fc" id="L129">            var patientId = Long.parseLong(credentials.getPatientId());</span>
<span class="fc" id="L130">            var patientAccountId = Optional.ofNullable(beanFactory.getPKBPersonBean().getDefaultAccountId(patientId));</span>
<span class="fc" id="L131">            var syncRecord = patientAccountId.flatMap(id -&gt; getCoreDevicesSyncRecord(requestContext, id, category, source));</span>
            @SuppressWarnings(&quot;UseOfObsoleteDateTimeApi&quot;)
<span class="fc" id="L133">            var lastSynced = syncRecord.map(CoreDevicesSyncRecord::getLastSynced).orElse(null);</span>
<span class="pc bpc" id="L134" title="2 of 4 branches missed.">            if (patientId == 4 || 8808 == patientId) {</span>
<span class="nc" id="L135">                LOGGER.info(&quot;Last sync for patient-{} category-{} source-{} date-{}&quot;, patientId, category, source, lastSynced);</span>
            }

<span class="fc" id="L138">            CoreDeviceDataBatch batch = coreDevicesClient.fetchData(credentials, category, source, lastSynced, Date.from(now));</span>

<span class="pc bpc" id="L140" title="1 of 2 branches missed.">            if (batch != null) {</span>
<span class="fc" id="L141">                var record = syncRecord.orElseGet(() -&gt; {</span>
<span class="fc" id="L142">                    var newRecord = new CoreDevicesSyncRecord(new SourceDetails());</span>
<span class="fc" id="L143">                    newRecord.setCategory(category);</span>
<span class="fc" id="L144">                    newRecord.setSourceDevice(source);</span>
<span class="fc" id="L145">                    return newRecord;</span>
                });
<span class="fc" id="L147">                record.getSource().init(record.getSource().getPersonId(), null, null, source, Route.CORE_DEVICES, null); // source may not have been set in the past</span>
<span class="fc" id="L148">                record.setLastSynced(Date.from(now));</span>
<span class="fc" id="L149">                record.generateNewRandomUniqueId();</span>
<span class="fc" id="L150">                syncRecord = Optional.of(record);</span>
            }
<span class="fc" id="L152">            return Tuple.of(batch, syncRecord.orElse(null), patientAccountId.orElse(null));</span>
<span class="nc" id="L153">        } catch (Exception e) {</span>
<span class="nc" id="L154">            throw new IllegalStateException(&quot;Error while fetching data for coreDevicesUser-&quot; + coreDevicesUserId + &quot; category-&quot; + category + &quot; source-&quot; + source, e);</span>
        }
    }

    public void createOrUpdateSyncRecord(EHRRequestContext requestContext, long patientAccountId, CoreDevicesSyncRecord syncRecord) {
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">        if (!syncRecord.getSource().isPopulated()) {</span>
<span class="nc" id="L160">            syncRecord.getSource().init(new SourceDetails(requestContext));</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            if (config.isExceptionForMissingSourceEnabled()) {</span>
<span class="nc" id="L162">                throw new IllegalStateException(&quot;PHRZ-105,PHRZ-104: Source is null for data point!!! Fix code path to set it, and backfill DB!&quot;);</span>
            }
            //noinspection NewExceptionWithoutArguments
<span class="nc" id="L165">            LOGGER.warn(&quot;PHRZ-105,PHRZ-104: sync record missing source details&quot;, FrameFilter.filter(new Exception().fillInStackTrace()));</span>
        }
<span class="fc" id="L167">        var ehrBean = beanFactory.getEhrRemote();</span>
<span class="fc" id="L168">        var ehrData = ehrBean.populateEHRData(syncRecord, patientAccountId, MenuDataType.coreDevicesSyncRecord, requestContext);</span>
<span class="fc" id="L169">        ehrBean.saveEHRData(requestContext, ehrData);</span>
<span class="fc" id="L170">    }</span>

    public void synchUploadedData(@NotNull LoggedInEHRRequestContext requestContext, Long patientId) {
<span class="fc" id="L173">        uploadedDataService.synchUploadedData(loggedInUploadedDataProcessingContext()</span>
<span class="fc" id="L174">                        .requestContext(requestContext.withPiggyback(true))</span>
<span class="fc" id="L175">                        .patientId(patientId)</span>
<span class="fc" id="L176">                        .destination(UploadedData.Destination.CORE_DEVICES)</span>
<span class="fc" id="L177">                        .build());</span>
<span class="fc" id="L178">    }</span>

    public void logPushNotification(Notification notification) {
<span class="fc" id="L181">        coreDevicesClient.logPushNotification(notification);</span>
<span class="fc" id="L182">    }</span>

    private Optional&lt;CoreDevicesSyncRecord&gt; getCoreDevicesSyncRecord(EHRRequestContext requestContext, long accountId, String category, String source) {
<span class="fc" id="L185">        EHRSearch&lt;CoreDevicesSyncRecord&gt; baseSearch = new EHRSearch&lt;&gt;(accountId, CoreDevicesSyncRecord.class, MenuDataType.coreDevicesSyncRecord);</span>
<span class="fc" id="L186">        EHRSearch&lt;CoreDevicesSyncRecord&gt; filteredByDeviceAndCategory = baseSearch</span>
<span class="fc" id="L187">                .addFilter(new PKBFilter(&quot;sourceDevice&quot;, PKBFilter.Operator.EQUAL, source))</span>
<span class="fc" id="L188">                .addFilter(new PKBFilter(&quot;category&quot;, PKBFilter.Operator.EQUAL, category));</span>
<span class="fc" id="L189">        return beanFactory.getEhrRemote().queryTypedData(filteredByDeviceAndCategory, requestContext)</span>
<span class="fc" id="L190">                .stream()</span>
<span class="fc" id="L191">                .map(Optional::ofNullable)</span>
<span class="fc" id="L192">                .findFirst()</span>
<span class="fc" id="L193">                .orElse(Optional.empty());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>