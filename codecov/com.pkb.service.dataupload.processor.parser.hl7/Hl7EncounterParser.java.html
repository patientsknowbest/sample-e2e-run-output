<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Hl7EncounterParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.dataupload.processor.parser.hl7</a> &gt; <span class="el_source">Hl7EncounterParser.java</span></div><h1>Hl7EncounterParser.java</h1><pre class="source lang-java linenums">package com.pkb.service.dataupload.processor.parser.hl7;

import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.dataupload.entity.UploadedDataDTO;
import com.pkb.encounter.entity.Encounter;
import com.pkb.encounter.entity.EncounterEvent;
import com.pkb.entities.enums.messaging.MessageStatus;
import com.pkb.service.code.CodeManager;
import com.pkb.service.dataupload.hl7.HL7ConnContext;
import com.pkb.service.dataupload.hl7.HL7MessageType;
import com.pkb.service.dataupload.hl7.HL7ParsingManager;
import com.pkb.service.dataupload.hl7.HL7Wrapper;
import com.pkb.service.dataupload.hl7.HL7XmlDoc;
import com.pkb.service.dataupload.hl7.segment.HL7PatientVisit1;
import com.pkb.service.dataupload.processor.LoggedInUploadedDataProcessingContext;
import com.pkb.service.dataupload.processor.domain.UploadedEncounter;
import com.pkb.service.dataupload.processor.domain.UploadedEncounterRequestType;
import com.pkb.service.dataupload.processor.parser.hl7.encounter.EncounterPatientAdmitParser;
import com.pkb.service.dataupload.processor.parser.hl7.encounter.EncounterPatientDischargeParser;
import com.pkb.service.dataupload.processor.parser.hl7.encounter.EncounterPatientInfoUpdateParser;
import com.pkb.service.dataupload.processor.parser.hl7.encounter.EncounterPatientScheduledAdmissionParser;
import com.pkb.service.dataupload.processor.parser.hl7.encounter.EncounterPatientTransferParser;
import com.pkb.service.encounter.impl.tolven.EncounterManager;
import com.pkb.service.encounter.impl.tolven.EncounterManagerUtil;
import com.pkb.service.reference.ReferenceDataManager;
import com.pkb.user.entity.PKBPerson;
import org.apache.commons.lang3.StringUtils;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Lazy;
import org.springframework.stereotype.Component;

import java.lang.invoke.MethodHandles;
import java.util.Collections;
import java.util.Date;
import java.util.List;
import java.util.Optional;

import static com.pkb.service.dataupload.processor.domain.UploadedEncounterRequestType.PENDING_ADMIT;
import static com.pkb.service.dataupload.processor.domain.UploadedEncounterRequestType.PENDING_ADMIT_CANCEL;
import static com.pkb.service.dataupload.processor.domain.UploadedEncounterRequestType.PRE_ADMIT;
import static com.pkb.service.dataupload.processor.domain.UploadedEncounterRequestType.PRE_ADMIT_CANCEL;

@Component
public class Hl7EncounterParser extends AbstractHl7Parser&lt;UploadedEncounter, LoggedInUploadedDataProcessingContext&gt; {

<span class="fc" id="L52">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

    private final ReferenceDataManager referenceDataManager;
    private final EncounterPatientAdmitParser patientAdmitParser;
    private final EncounterPatientTransferParser patientTransferParser;
    private final EncounterPatientDischargeParser patientDischargeParser;
    private final EncounterPatientInfoUpdateParser patientInfoUpdateParser;
    private final EncounterPatientScheduledAdmissionParser patientScheduledAdmissionParser;
    private final DateTimeService dateTimeService;
    private final CodeManager codeManager;
    private final EncounterManager encounterManager;

    @Autowired
    private PhrConfig config;

    @Autowired
    public Hl7EncounterParser(HL7ParsingManager hl7ParsingManager, DateTimeService dateTimeService,
                              ReferenceDataManager referenceDataManager, EncounterPatientAdmitParser patientAdmitParser,
                              EncounterPatientTransferParser patientTransferParser, EncounterPatientDischargeParser patientDischargeParser,
                              EncounterPatientInfoUpdateParser patientInfoUpdateParser, EncounterPatientScheduledAdmissionParser patientScheduledAdmissionParser,
                              CodeManager codeManager, @Lazy EncounterManager encounterManager) {
<span class="fc" id="L73">        super(hl7ParsingManager);</span>
<span class="fc" id="L74">        this.referenceDataManager = referenceDataManager;</span>
<span class="fc" id="L75">        this.patientAdmitParser = patientAdmitParser;</span>
<span class="fc" id="L76">        this.patientTransferParser = patientTransferParser;</span>
<span class="fc" id="L77">        this.patientDischargeParser = patientDischargeParser;</span>
<span class="fc" id="L78">        this.patientInfoUpdateParser = patientInfoUpdateParser;</span>
<span class="fc" id="L79">        this.patientScheduledAdmissionParser = patientScheduledAdmissionParser;</span>
<span class="fc" id="L80">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L81">        this.codeManager = codeManager;</span>
<span class="fc" id="L82">        this.encounterManager = encounterManager;</span>
<span class="fc" id="L83">    }</span>

    @Override
    List&lt;UploadedEncounter&gt; doParse(LoggedInUploadedDataProcessingContext context, UploadedDataDTO dto, HL7Wrapper wrapper) {
        // Find existing encounter if any
<span class="fc" id="L88">        Encounter encounter = null;</span>

<span class="fc" id="L90">        Optional&lt;HL7PatientVisit1&gt; pv1 = wrapper.getHL7Xml().getPV1();</span>
<span class="pc bpc" id="L91" title="2 of 4 branches missed.">        if ((pv1.isPresent()) &amp;&amp; (pv1.get().getVisitNumber().isNotBlank())) {</span>
<span class="fc" id="L92">            encounter = getEncounterByExternalEncounterId(</span>
<span class="fc" id="L93">                    context.requestContext(),</span>
<span class="fc" id="L94">                    context.patientId(),</span>
<span class="fc" id="L95">                    pv1.get().getVisitNumber().getString(),</span>
<span class="fc" id="L96">                    dto.getSourceOrg().getId()</span>
<span class="fc" id="L97">            ).orElse(null);</span>
        }

<span class="fc" id="L100">        HL7MessageType messageType = wrapper.getHL7Xml().getMessageType();</span>

<span class="fc" id="L102">        UploadedEncounter result = null;</span>

<span class="pc bpc" id="L104" title="1 of 12 branches missed.">        switch (messageType) {</span>
            case ADT_A01:
<span class="fc" id="L106">                result = handlePatientAdmit(dto, wrapper.getHL7Xml(), context.patient(), encounter);</span>
<span class="fc" id="L107">                break;</span>
            case ADT_A11:
<span class="fc" id="L109">                result = new UploadedEncounter(null, encounter, UploadedEncounterRequestType.ADMIT_CANCEL);</span>
<span class="fc" id="L110">                break;</span>
            case ADT_A02:
<span class="fc" id="L112">                result = handlePatientTransfer(dto, wrapper.getHL7Xml(), context.patient(), encounter);</span>
<span class="fc" id="L113">                break;</span>
            case ADT_A12:
<span class="fc" id="L115">                result = new UploadedEncounter(null, encounter, UploadedEncounterRequestType.TRANSFER_CANCEL);</span>
<span class="fc" id="L116">                break;</span>
            case ADT_A03:
<span class="fc" id="L118">                result = handlePatientDischarge(dto, wrapper.getHL7Xml(), context.patient(), encounter);</span>
<span class="fc" id="L119">                break;</span>
            case ADT_A13:
<span class="fc" id="L121">                result = new UploadedEncounter(null, encounter, UploadedEncounterRequestType.DISCHARGE_CANCEL);</span>
<span class="fc" id="L122">                break;</span>
            case ADT_A08:
<span class="fc" id="L124">                result = handlePatientInformationUpdate(dto, wrapper.getHL7Xml(), context.patient(), encounter);</span>
<span class="fc" id="L125">                break;</span>
            case ADT_A05:
<span class="fc" id="L127">                result = handlePatientScheduledAdmission(dto, wrapper.getHL7Xml(), context.patient(), wrapper.getHl7ConnContext(), encounter, PRE_ADMIT);</span>
<span class="fc" id="L128">                break;</span>
            case ADT_A38:
<span class="fc" id="L130">                result = new UploadedEncounter(null, encounter, PRE_ADMIT_CANCEL);</span>
<span class="fc" id="L131">                result.setHL7ConnContext(wrapper.getHl7ConnContext());</span>
<span class="fc" id="L132">                break;</span>
            case ADT_A14:
<span class="fc" id="L134">                result = handlePatientScheduledAdmission(dto, wrapper.getHL7Xml(), context.patient(), wrapper.getHl7ConnContext(), encounter, PENDING_ADMIT);</span>
<span class="fc" id="L135">                break;</span>
            case ADT_A27:
<span class="fc" id="L137">                result = new UploadedEncounter(null, encounter, PENDING_ADMIT_CANCEL);</span>
<span class="fc" id="L138">                result.setHL7ConnContext(wrapper.getHl7ConnContext());</span>
<span class="fc" id="L139">                break;</span>
            default:
<span class="nc" id="L141">                rejectMessage(dto);</span>
        }
<span class="fc" id="L143">        checkForMissingSubjectAndContent(result, messageType);</span>

<span class="fc" id="L145">        return Collections.singletonList(result);</span>
    }

    /**
     * ADT^A01
     */
    private UploadedEncounter handlePatientAdmit(UploadedDataDTO dto, HL7XmlDoc hl7, PKBPerson patient, Encounter encounter) {

<span class="fc" id="L153">        EncounterEvent encounterEvent = createEncounterMessageFromHL7(dto, hl7, patient);</span>

<span class="fc" id="L155">        return patientAdmitParser.doProcess(hl7, patient, encounter, encounterEvent);</span>
    }

    /**
     * ADT^A02
     */
    private UploadedEncounter handlePatientTransfer(UploadedDataDTO dto, HL7XmlDoc hl7, PKBPerson patient, Encounter encounter) {

<span class="fc" id="L163">        EncounterEvent encounterEvent = createEncounterMessageFromHL7(dto, hl7, patient);</span>
<span class="fc" id="L164">        return patientTransferParser.doProcess(hl7, patient, encounter, encounterEvent);</span>

    }

    /**
     * ADT^A03
     */
    private UploadedEncounter handlePatientDischarge(UploadedDataDTO dto, HL7XmlDoc hl7, PKBPerson patient, Encounter encounter) {

<span class="fc" id="L173">        EncounterEvent encounterEvent = createEncounterMessageFromHL7(dto, hl7, patient);</span>
<span class="fc" id="L174">        return patientDischargeParser.doProcess(hl7, patient, encounter, encounterEvent);</span>
    }

    /**
     * ADT^A08
     * Allows:
     * &lt;ul&gt;
     * &lt;li&gt;Admit Date Update (A01 PV1-44)&lt;/li&gt;
     * &lt;li&gt;Discharge Date update (A03 PV1-45)&lt;/li&gt;
     * &lt;/ul&gt;
     */
    private UploadedEncounter handlePatientInformationUpdate(UploadedDataDTO dto, HL7XmlDoc hl7, PKBPerson patient, Encounter encounter) {

<span class="fc" id="L187">        EncounterEvent encounterEvent = createEncounterMessageFromHL7(dto, hl7, patient);</span>
<span class="fc" id="L188">        return patientInfoUpdateParser.doProcess(hl7, patient, encounter, encounterEvent);</span>

    }

    /**
     * Handles all message types that schedule a future admission as we don't currently differentiate.
     * Expects A05 and A14 message types.
     **/
    private UploadedEncounter handlePatientScheduledAdmission(UploadedDataDTO dto, HL7XmlDoc hl7, PKBPerson patient, HL7ConnContext hl7ConnContext, Encounter encounter,
                                                              UploadedEncounterRequestType requestType) {

<span class="fc" id="L199">        EncounterEvent encounterEvent = createEncounterMessageFromHL7(dto, hl7, patient);</span>
<span class="fc" id="L200">        return patientScheduledAdmissionParser.doProcess(hl7, patient, encounter, encounterEvent, hl7ConnContext, requestType);</span>

    }

    private void rejectMessage(UploadedDataDTO dto) {
<span class="nc" id="L205">        throw new IllegalArgumentException(String.format(&quot;Rejecting DTO %s, unknown message type&quot;, dto.getId()));</span>
    }

    private Optional&lt;Encounter&gt; getEncounterByExternalEncounterId(@NotNull LoggedInEHRRequestContext requestContext, long patientId, String externalEncounterId, long oid) {

<span class="fc" id="L210">        Optional&lt;Encounter&gt; ret = Optional.empty();</span>

<span class="pc bpc" id="L212" title="1 of 2 branches missed.">        if (StringUtils.isNotBlank(externalEncounterId)) {</span>
            try {
<span class="fc" id="L214">                Encounter encounter = encounterManager.getEncounterByExternalEncounterId(requestContext,</span>
<span class="fc" id="L215">                        Long.toString(patientId),</span>
                        externalEncounterId,
                        oid,
                        true);
<span class="fc bfc" id="L219" title="All 2 branches covered.">                if (encounter != null) {</span>
<span class="fc" id="L220">                    populateApiRef(encounter);</span>
<span class="fc" id="L221">                    codeManager.populateCodes(Collections.singletonList(encounter));</span>
<span class="fc" id="L222">                    ret = Optional.of(encounter);</span>
                }
<span class="nc" id="L224">            } catch (Exception e) {</span>
<span class="nc" id="L225">                throw new RuntimeException(&quot;Exception while fetching Encounter by class for patientId-&quot; + patientId, e);</span>
<span class="fc" id="L226">            }</span>
        }

<span class="fc" id="L229">        return ret;</span>
    }

    private void populateApiRef(Encounter encounter) {
<span class="fc" id="L233">        EncounterManagerUtil.populateApiRef(encounter);</span>
<span class="fc" id="L234">    }</span>

    private EncounterEvent createEncounterMessageFromHL7(UploadedDataDTO dto, HL7XmlDoc hl7, PKBPerson patient) {

<span class="fc" id="L238">        EncounterEvent encounterEvent = hl7.parseEncounterMessage(new SourceDetails(dto));</span>

        // Discussion Inbox message settings
<span class="fc" id="L241">        encounterEvent.setHtmlAllowed(false);</span>
<span class="fc" id="L242">        encounterEvent.setMessageStatus(MessageStatus.UNREAD);</span>
<span class="fc" id="L243">        encounterEvent.setPatientId(patient.getId().toString());</span>
<span class="fc" id="L244">        encounterEvent.setReceiverId(patient.getId().toString());</span>
<span class="fc" id="L245">        encounterEvent.setSenderId(null);</span>
<span class="fc" id="L246">        encounterEvent.setParticipants(Collections.singletonList(patient.getId().toString()));</span>
<span class="fc" id="L247">        encounterEvent.setAttachmentCount(0L);</span>

        // Base fields
<span class="fc" id="L250">        encounterEvent.getBaseFields().setEnteredDate(Date.from(dateTimeService.now()));</span>
<span class="fc" id="L251">        encounterEvent.getBaseFields().setUploadedDataId(dto.getId());</span>
<span class="fc" id="L252">        encounterEvent.getBaseFields().setPersistedDate(Date.from(dateTimeService.now()));</span>
<span class="fc" id="L253">        encounterEvent.getBaseFields().generateNewRandomUniqueId();</span>

        // Map appropriate privacy labels based on payload
<span class="fc" id="L256">        referenceDataManager.applyPrivacyLabels(encounterEvent);</span>

<span class="fc" id="L258">        return encounterEvent;</span>
    }

    private void checkForMissingSubjectAndContent(UploadedEncounter uploadedEncounter, HL7MessageType messageType) {
<span class="fc bfc" id="L262" title="All 4 branches covered.">        boolean isA08WithNullEncounter = uploadedEncounter.getEncounter() == null &amp;&amp; messageType == HL7MessageType.ADT_A08;</span>
<span class="fc" id="L263">        EncounterEvent encounterEvent = uploadedEncounter.getEncounterEvent();</span>
<span class="fc bfc" id="L264" title="All 4 branches covered.">        if (encounterEvent != null &amp;&amp; !isA08WithNullEncounter) {</span>
<span class="fc" id="L265">            String subject = encounterEvent.getSubject();</span>
<span class="fc" id="L266">            String content = encounterEvent.getContent();</span>
<span class="pc bpc" id="L267" title="2 of 4 branches missed.">            boolean subjectOrContentIsMissing = StringUtils.isBlank(subject) || StringUtils.isBlank(content);</span>
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">            if (subjectOrContentIsMissing) {</span>
<span class="nc" id="L269">                String exception = String.format(&quot;PHR-9900: %s encounterEvent uniqueid %s is missing subject and/or content (subject is null=%b, subject is blank=%b&quot; +</span>
                                &quot;, content is null=%b, content is blank=%b)&quot;,
<span class="nc" id="L271">                        messageType.getCode(),</span>
<span class="nc bnc" id="L272" title="All 2 branches missed.">                        encounterEvent.getBaseFields().getUniqueId(),</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">                        subject == null,</span>
<span class="nc bnc" id="L274" title="All 4 branches missed.">                        subject != null &amp;&amp; subject.isBlank(),</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">                        content == null,</span>
<span class="nc bnc" id="L276" title="All 2 branches missed.">                        content != null &amp;&amp; content.isBlank());</span>
<span class="nc bnc" id="L277" title="All 2 branches missed.">                if (config.isExceptionForMissingSubjectAndContentEnabled()) {</span>
<span class="nc" id="L278">                    throw new IllegalStateException(exception);</span>
                } else {
<span class="nc" id="L280">                    LOGGER.error(exception);</span>
                }
            }
        }
<span class="fc" id="L284">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>