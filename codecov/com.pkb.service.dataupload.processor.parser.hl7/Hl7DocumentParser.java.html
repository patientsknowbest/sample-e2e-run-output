<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Hl7DocumentParser.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.dataupload.processor.parser.hl7</a> &gt; <span class="el_source">Hl7DocumentParser.java</span></div><h1>Hl7DocumentParser.java</h1><pre class="source lang-java linenums">package com.pkb.service.dataupload.processor.parser.hl7;

import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.dataupload.entity.UploadedDataDTO;
import com.pkb.document.entity.Attachment;
import com.pkb.encounter.entity.EncounterEvent;
import com.pkb.encounter.entity.Message;
import com.pkb.entities.enums.EncounterClass;
import com.pkb.entities.enums.messaging.MessageStatus;
import com.pkb.service.dataupload.hl7.HL7ConnContext;
import com.pkb.service.dataupload.hl7.HL7MessageType;
import com.pkb.service.dataupload.hl7.HL7ParsingManager;
import com.pkb.service.dataupload.hl7.HL7Wrapper;
import com.pkb.service.dataupload.hl7.HL7XmlDoc;
import com.pkb.service.dataupload.hl7.segment.HL7PatientVisit1;
import com.pkb.service.dataupload.processor.UploadedDataProcessingContext;
import com.pkb.service.dataupload.processor.domain.UploadedDocument;
import com.pkb.service.dataupload.processor.domain.UploadedDocumentRequestType;
import com.pkb.service.encounter.impl.tolven.EncounterManager;
import com.pkb.service.reference.ReferenceDataManager;
import com.pkb.user.entity.PKBPerson;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Lazy;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.Collections;
import java.util.Date;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

@Component
public class Hl7DocumentParser extends AbstractHl7Parser&lt;UploadedDocument, UploadedDataProcessingContext&gt; {
    private final ReferenceDataManager referenceDataManager;
    private final PhrConfig config;
    private final DateTimeService dateTimeService;
    private final EncounterManager encounterManager;

    @Autowired
    public Hl7DocumentParser(PhrConfig config, DateTimeService dateTimeService, HL7ParsingManager hl7ParsingManager,
                             ReferenceDataManager referenceDataManager, @Lazy EncounterManager encounterManager) {
<span class="fc" id="L47">        super(hl7ParsingManager);</span>
<span class="fc" id="L48">        this.referenceDataManager = referenceDataManager;</span>
<span class="fc" id="L49">        this.config = config;</span>
<span class="fc" id="L50">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L51">        this.encounterManager = encounterManager;</span>
<span class="fc" id="L52">    }</span>

    @Override
    List&lt;UploadedDocument&gt; doParse(UploadedDataProcessingContext context, UploadedDataDTO dto, HL7Wrapper wrapper) {

<span class="fc" id="L57">        HL7XmlDoc hl7 = wrapper.getHL7Xml();</span>

<span class="fc" id="L59">        HL7MessageType messageType = hl7.getMessageType();</span>

<span class="fc" id="L61">        UploadedDocument result = null;</span>

<span class="pc bpc" id="L63" title="2 of 3 branches missed.">        switch (messageType) {</span>
        case MDM_T02:
<span class="fc" id="L65">            String docType = hl7.getMdmDocumentType().getString();</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">            if (HL7XmlDoc.ALLOWED_MDM_DOCUMENT_TYPES.contains(docType)) {</span>
<span class="fc" id="L67">                result = handleDocument(context.requestContext(), dto, hl7, context.patient(), context.patientAccountId(), docType, wrapper.getHl7ConnContext());</span>
            } else {
<span class="nc" id="L69">                rejectMessage(dto);</span>
            }
<span class="nc" id="L71">            break;</span>
        case MDM_T11:
<span class="nc" id="L73">            result = new UploadedDocument(null, null, UploadedDocumentRequestType.DELETE);</span>
<span class="nc" id="L74">            break;</span>
        default:
<span class="nc" id="L76">            rejectMessage(dto);</span>
        }
<span class="fc" id="L78">        return Collections.singletonList(result);</span>
    }

    private void rejectMessage(UploadedDataDTO dto) {
<span class="nc" id="L82">        throw new IllegalArgumentException(String.format(&quot;Rejecting DTO %s, unknown message type&quot;, dto.getId()));</span>
    }

    private UploadedDocument handleDocument(EHRRequestContext requestContext, UploadedDataDTO dto,
            HL7XmlDoc hl7, PKBPerson patient, Long accountId, String documentType, HL7ConnContext hl7ConnContext) {

<span class="fc" id="L88">        Message.DocumentType docType = Message.DocumentType.from(documentType);</span>
<span class="fc" id="L89">        Optional&lt;HL7PatientVisit1&gt; pv1 = hl7.getPV1(); // PV1 Segment</span>
        @SuppressWarnings(&quot;OptionalIsPresent&quot;)
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">        EncounterClass encounterClass = pv1.isPresent()</span>
<span class="fc" id="L92">                ? HL7XmlDoc.getPkbCS04ValueToEncounterClassMap(pv1.get().getPatientClass().getString())</span>
<span class="pc" id="L93">                : EncounterClass.OTHER;</span>
<span class="fc" id="L94">        EncounterEvent encounterEvent = hl7.parseMdmT02DocumentMessage(new SourceDetails(dto));</span>
<span class="fc" id="L95">        Attachment attachment = hl7.parseMdmDocumentAttachment(encounterEvent, hl7ConnContext);</span>

        // Look to see if there is an existing conversation which contains a message with this document ID
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">        long oid = (dto.getSourceOrg() == null) ? dto.getSourceTeam().getOrg().getId() : dto.getSourceOrg().getId();</span>
<span class="fc" id="L99">        UUID existingConversationId = encounterManager.getConversationIdForDocument(requestContext, accountId, hl7.getMdmDocumentId()</span>
<span class="fc" id="L100">                .getString(), oid);</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">        if (existingConversationId != null) {</span>
<span class="fc" id="L102">            encounterEvent.setEncounterUniqueId(existingConversationId);</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">            if (config.isHL7MdmT01DocumentUpdateEnabled()) {</span>
<span class="fc" id="L104">                encounterEvent.getBaseFields().setUniqueId(encounterEvent.getEncounterUniqueId());</span>
            } else {
<span class="nc" id="L106">                encounterEvent.getBaseFields().generateNewRandomUniqueId();</span>
            }
        } else {
<span class="fc" id="L109">            encounterEvent.setEncounterUniqueId(UUID.randomUUID());</span>
<span class="fc" id="L110">            encounterEvent.getBaseFields().setUniqueId(encounterEvent.getEncounterUniqueId());</span>
        }

<span class="fc" id="L113">        encounterEvent.setHtmlAllowed(false);</span>
<span class="fc" id="L114">        encounterEvent.setMessageStatus(MessageStatus.UNREAD);</span>
<span class="fc" id="L115">        encounterEvent.setMessageTimestamp(encounterEvent.getBaseFields().getEnteredDate().toInstant());</span>
<span class="fc" id="L116">        encounterEvent.setSubject(Message.DocumentType.subjectProperty(docType));</span>
<span class="fc" id="L117">        encounterEvent.setPatientId(patient.getId().toString());</span>
<span class="fc" id="L118">        encounterEvent.setReceiverId(patient.getId().toString());</span>
        // This message has not come from a person, it has come across
        // directly from the hospital, so there is no other participant
        // to this conversation.
<span class="fc" id="L122">        encounterEvent.setSenderId(null);</span>
<span class="fc" id="L123">        List&lt;String&gt; participants = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L124">        participants.add(patient.getId().toString());</span>
<span class="fc" id="L125">        encounterEvent.setParticipants(participants);</span>
<span class="fc" id="L126">        encounterEvent.setAttachmentCount(1L);</span>
<span class="fc" id="L127">        encounterEvent.setContent(Message.DocumentType.contentProperty(docType));</span>

<span class="fc" id="L129">        attachment.setAccountId(accountId);</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">        if (StringUtils.isBlank(attachment.getFilename())) {</span>
<span class="fc" id="L131">            attachment.setFilename(Message.DocumentType.filename(docType) + &quot;.&quot; + attachment.getMediaType());</span>
        }
<span class="fc" id="L133">        attachment.setUploadTime(Date.from(dateTimeService.now()));</span>
<span class="fc" id="L134">        attachment.setUserId(patient.getId());</span>

        // This was populated on the DTO by the call to addUploadedData()
<span class="fc" id="L137">        encounterEvent.getBaseFields().setUploadedDataId(dto.getId());</span>

        //populating hospitalServiceCode
<span class="fc" id="L140">        pv1.ifPresent(x -&gt; encounterEvent.getBaseFields().setHospitalServiceCode(x.getHospitalService().getString()));</span>

        // Note: enteredDate is populated by parseMdmT02DocumentMessage, so we
        // don't set here. Also, ignoring uniqueId for now.
<span class="fc" id="L144">        encounterEvent.getBaseFields().setPersistedDate(Date.from(dateTimeService.now()));</span>

<span class="fc" id="L146">        encounterEvent.setExternalMessageId(dto.getExternalMessageId());</span>

<span class="fc" id="L148">        encounterEvent.setEncounterClass(encounterClass);</span>
<span class="fc" id="L149">        encounterEvent.setMessageType(Message.MessageType.HL7_DOCUMENT);</span>
<span class="fc" id="L150">        encounterEvent.setDocumentType(docType);</span>

        // Apply privacy labels
<span class="fc" id="L153">        referenceDataManager.applyPrivacyLabels(encounterEvent);</span>

<span class="fc" id="L155">        return new UploadedDocument(encounterEvent, attachment, UploadedDocumentRequestType.SAVE);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>