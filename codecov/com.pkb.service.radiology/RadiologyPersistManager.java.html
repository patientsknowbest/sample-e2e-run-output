<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RadiologyPersistManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.radiology</a> &gt; <span class="el_source">RadiologyPersistManager.java</span></div><h1>RadiologyPersistManager.java</h1><pre class="source lang-java linenums">package com.pkb.service.radiology;

import com.pkb.app.entity.EHRData;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.EHRSearch;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.PKBFilter;
import com.pkb.app.entity.SourceDetails;
import com.pkb.common.base.Error;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.crypto.document.Document;
import com.pkb.crypto.document.PlaintextDocument;
import com.pkb.data.EHRRemote;
import com.pkb.document.entity.Attachment;
import com.pkb.entities.enums.MenuDataType;
import com.pkb.exception.DecryptionFailedException;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import com.pkb.radiology.entity.RadiologyImage;
import com.pkb.radiology.entity.RadiologyResult;
import com.pkb.repository.legacy.LegacyOrgRepository;
import com.pkb.repository.legacy.LegacyTeamRepository;
import com.pkb.service.document.DocumentManager;
import com.pkb.service.file.ChunkedDocManager;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.user.entity.PKBPerson;
import com.pkb.util.tolven.TolvenBeanFactory;
import com.pkb.util.tolven.TransactionManager;
import io.vavr.control.Either;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.text.StringEscapeUtils;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.context.annotation.Lazy;

import javax.naming.NamingException;
import javax.xml.bind.JAXBException;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;

import static com.pkb.util.EncryptedDocumentMapperHelper.genericMetadata;
import static java.util.Collections.singletonList;
import static org.apache.commons.collections4.CollectionUtils.isNotEmpty;

public class RadiologyPersistManager extends TransactionManager {

<span class="fc" id="L54">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>
    private static final int RADIOLOGY_IMAGE_MIGRATION_VERSION = 1; // version 1 = migrate to not using trim doc for RadiologyImage
    private static final String RADIOLOGY_IMAGE = &quot;radiologyImage&quot;;

    private final ChunkedDocManager chunkedDocManager;
    private final LegacyTeamRepository teamRepository;
    private final LegacyOrgRepository orgRepository;
    private final DocumentManager documentManager;

    public RadiologyPersistManager(PhrConfig config,
                                   TolvenBeanFactory beanFactory,
                                   DateTimeService dateTimeService,
                                   UUIDProvider uuidProvider,
                                   @Lazy ChunkedDocManager chunkedDocManager,
                                   LegacyTeamRepository teamRepository,
                                   LegacyOrgRepository orgRepository,
                                   DocumentManager documentManager) {
<span class="fc" id="L71">        super(config, beanFactory, dateTimeService, uuidProvider);</span>
<span class="fc" id="L72">        this.chunkedDocManager = chunkedDocManager;</span>
<span class="fc" id="L73">        this.teamRepository = teamRepository;</span>
<span class="fc" id="L74">        this.orgRepository = orgRepository;</span>
<span class="fc" id="L75">        this.documentManager = documentManager;</span>
<span class="fc" id="L76">    }</span>

    public void saveRadiologyResults(long patientId, Long accountId,
                                     List&lt;RadiologyResult&gt; resultList,
                                     @NotNull EHRRequestContext context) {
<span class="fc" id="L81">        transactional(() -&gt; {</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">            for (RadiologyResult result : resultList) {</span>
<span class="fc" id="L83">                saveSingleResult(patientId, accountId, result, context);</span>
<span class="fc" id="L84">            }</span>
<span class="fc" id="L85">        });</span>
<span class="fc" id="L86">    }</span>

    public @NotNull Either&lt;Error, Long&gt; saveRadiologyResult(long patientId, Long accountId,
                                                            RadiologyResult radiologyResult, @NotNull EHRRequestContext context) {
<span class="fc" id="L90">        return transactional(() -&gt; saveSingleResult(patientId, accountId, radiologyResult, context));</span>
    }

    public List&lt;RadiologyResult&gt; getRadiologyResults(RadiologyResult.MediaActCategory category,
                                                     Long accountId, int pageSize, int offset,
                                                     @NotNull LoggedInEHRRequestContext context, Collection&lt;Long&gt; ids) {
        try {
<span class="fc" id="L97">            EHRSearch&lt;RadiologyResult&gt; ehrSearch = new EHRSearch&lt;&gt;(accountId, RadiologyResult.class,</span>
                    RadiologyResult.MS_RADIOLOGY_RESULT);
<span class="fc" id="L99">            ehrSearch.addFilter(new PKBFilter(RadiologyResult.CATEGORY, PKBFilter.Operator.EQUAL, category.toString()));</span>

<span class="pc bpc" id="L101" title="1 of 2 branches missed.">            if (isNotEmpty(ids)) {</span>
<span class="nc" id="L102">                ehrSearch.addFilter(new PKBFilter(&quot;id&quot;, PKBFilter.Operator.IN, ids));</span>
            }

<span class="pc bpc" id="L105" title="1 of 2 branches missed.">            if (pageSize &gt; 0) {</span>
<span class="nc" id="L106">                ehrSearch.setResultsMaxReturned(pageSize);</span>
<span class="nc" id="L107">                ehrSearch.setResultsStartPosition(offset);</span>
            } // else get all

<span class="fc" id="L110">            ehrSearch.setOrderBy(RadiologyResult.UPLOADTIMESTAMP, EHRSearch.OrderByDirection.Desc);</span>
<span class="fc" id="L111">            ehrSearch.setLatestPerTypeFilter(EHRData.ENTERED_DATE, EHRData.UNIQUE_ID);</span>
            // In decreasing order of the According to last edited date
<span class="fc" id="L113">            List&lt;EHRData&gt; ehrDataList = beanFactory.getEhrRemote().queryAndDecryptEHRData(ehrSearch, context);</span>
<span class="fc" id="L114">            List&lt;RadiologyResult&gt; radiologyResultList = new ArrayList&lt;&gt;();</span>
            RadiologyResult radiologyResult;
<span class="fc" id="L116">            int index = 0;</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">            for (EHRData ehrData : ehrDataList) {</span>
<span class="fc" id="L118">                radiologyResult = populateRadiologyResult(ehrData, context);</span>
<span class="fc" id="L119">                radiologyResultList.add(index++, radiologyResult);</span>
<span class="fc" id="L120">            }</span>

            // fill in details of org, team, person, etc. source for display
<span class="fc" id="L123">            populateSourceNames(radiologyResultList);</span>
<span class="fc" id="L124">            return radiologyResultList;</span>
<span class="nc" id="L125">        } catch (Exception e) {</span>
<span class="nc" id="L126">            throw new RuntimeException(&quot;Exception while getting radiology results list&quot;, e);</span>
        }
    }

    @Nullable
    public RadiologyResult getRadiologyResult(Long radiologyResultId, @NotNull LoggedInEHRRequestContext context) {
        try {
<span class="fc" id="L133">            EHRData ehrData = beanFactory.getEhrRemote().findAndDecryptEHRData(radiologyResultId, context);</span>
<span class="fc" id="L134">            RadiologyResult radiologyResult = populateRadiologyResult(ehrData, context);</span>
<span class="fc" id="L135">            radiologyResult.setAttachments(getAttachments(radiologyResult.getId()));</span>

            // fill in details of org, team, person, etc. source for display
<span class="fc" id="L138">            populateSourceNames(singletonList(radiologyResult));</span>
<span class="fc" id="L139">            return radiologyResult;</span>
<span class="nc" id="L140">        } catch (Exception exception) {</span>
<span class="nc" id="L141">            throw new RuntimeException(&quot;Exception while getting radiologyResult-&quot; + radiologyResultId, exception);</span>
        }
    }

    public RadiologyImage getRadiologyImage(Long radiologyImageId, @NotNull LoggedInEHRRequestContext requestContext) {
        try {
<span class="nc" id="L147">            return transactional(() -&gt; {</span>
<span class="nc" id="L148">                EHRData ehrData = beanFactory.getEhrRemote().findAndDecryptEHRData(radiologyImageId, requestContext);</span>
<span class="nc" id="L149">                RadiologyImage radiologyImage = beanFactory.getEhrRemote().populateDTO(ehrData, RadiologyImage.class, requestContext);</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                if (ehrData.getMigrationVersion() &lt; 1) {</span>
                    // TODO: implement trim migrator
<span class="nc" id="L152">                    throw new DecryptionFailedException(&quot;Cannot migrate plans from trim.&quot;);</span>
                } else {
<span class="nc" id="L154">                    Document document = documentManager.retrieveOrThrow(ehrData.getDocumentMetadataId());</span>
<span class="nc" id="L155">                    PlaintextDocument plaintextDocument = beanFactory.getEhrRemote().decryptDoc(document, requestContext);</span>
<span class="nc" id="L156">                    radiologyImage.setContent(plaintextDocument.plainText());</span>
                }
<span class="nc" id="L158">                return radiologyImage;</span>
            });
<span class="nc" id="L160">        } catch (Exception e) {</span>
<span class="nc" id="L161">            throw new RuntimeException(&quot;Exception while reading radiologyImage-&quot; + radiologyImageId + &quot; from trim&quot;, e);</span>
        }
    }

    public boolean deleteRadiologyImage(Long radiologyImageId) {
        try {
<span class="fc" id="L167">            return beanFactory.getEhrRemote().deleteEHRData(radiologyImageId);</span>
<span class="nc" id="L168">        } catch (Exception e) {</span>
<span class="nc" id="L169">            throw new RuntimeException(&quot;Error deleting the radiology image-&quot; + radiologyImageId, e);</span>
        }
    }

    private Either&lt;Error, Long&gt; saveSingleResult(long patientId, Long accountId,
                                                 RadiologyResult radiologyResult, EHRRequestContext context) {
        try {
<span class="fc" id="L176">            String logText = &quot;saveRadiologyResult:&quot;;</span>
<span class="fc" id="L177">            long startMs = System.currentTimeMillis();</span>

<span class="fc" id="L179">            Long existingRadResultId = null;</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">            if (StringUtils.isNotBlank(radiologyResult.getLabOrderId())) {</span>
                // check if this result has already been uploaded (and this is a correction)
                // assuming that a lab order ID is unique per radiology report
<span class="fc" id="L183">                existingRadResultId = getRadiologyResultByLabOrderId(radiologyResult.getLabOrderId(), radiologyResult.getSource()</span>
<span class="fc" id="L184">                        .getOrgId(), accountId, context);</span>
            }

<span class="fc" id="L187">            EHRData oldVersion = null;</span>

<span class="fc bfc" id="L189" title="All 2 branches covered.">            if (existingRadResultId != null) {</span>
                // replacing existing radiologyResult (track the version we're soft-deleting)
<span class="fc" id="L191">                oldVersion = beanFactory.getEhrRemote().findEHRData(existingRadResultId, context);</span>
            }

            // can't handle a deletion request unless the original is found
<span class="fc bfc" id="L195" title="All 4 branches covered.">            if (radiologyResult.getBaseFields().isDeleted() &amp;&amp; oldVersion == null) {</span>

<span class="fc" id="L197">                String description = &quot;Radiology deletion requested but no original found&quot;;</span>
<span class="fc" id="L198">                LOGGER.warn(&quot;Radiology deletion requested but no original found labOrderId {}, uploadedDataId {}&quot;, radiologyResult.getLabOrderId(),</span>
<span class="fc" id="L199">                        radiologyResult.getBaseFields().getUploadedDataId());</span>
<span class="fc" id="L200">                return Either.left(new Error(description, description));</span>
            }

<span class="fc" id="L203">            logText += &quot; setup &quot; + (System.currentTimeMillis() - startMs);</span>
<span class="fc" id="L204">            startMs = System.currentTimeMillis();</span>

<span class="fc" id="L206">            Long radiologyResultId = saveEHRData(accountId, context, radiologyResult, oldVersion);</span>

<span class="fc" id="L208">            logText += &quot; trim/md &quot; + (System.currentTimeMillis() - startMs);</span>
<span class="fc" id="L209">            startMs = System.currentTimeMillis();</span>

<span class="pc bpc" id="L211" title="1 of 2 branches missed.">            if (isNotEmpty(radiologyResult.getImageSummaries())) {</span>
<span class="nc" id="L212">                long sequenceNumber = 0;</span>
<span class="nc bnc" id="L213" title="All 2 branches missed.">                for (RadiologyImage radiologyImage : radiologyResult.getImageSummaries()) {</span>
<span class="nc" id="L214">                    saveRadiologyImage(patientId, accountId, radiologyImage,</span>
                            radiologyResultId, ++sequenceNumber, context);
<span class="nc" id="L216">                }</span>

<span class="nc" id="L218">                logText += &quot; &quot; + radiologyResult.getImageSummaries().size() + &quot; images &quot; + (System.currentTimeMillis() - startMs);</span>
<span class="nc" id="L219">                startMs = System.currentTimeMillis();</span>
            }

<span class="fc bfc" id="L222" title="All 2 branches covered.">            if (isNotEmpty(radiologyResult.getAttachments())) {</span>
<span class="fc" id="L223">                addAttachments(patientId, accountId, radiologyResult.getAttachments(), radiologyResultId);</span>

<span class="fc" id="L225">                logText += &quot; &quot; + radiologyResult.getAttachments().size() + &quot; attachments &quot; + (System.currentTimeMillis() - startMs);</span>
<span class="fc" id="L226">                startMs = System.currentTimeMillis();</span>
            }

<span class="fc" id="L229">            logText += &quot;; complete &quot; + (System.currentTimeMillis() - startMs);</span>
<span class="fc" id="L230">            LOGGER.info(&quot;PERF {}&quot;, logText);</span>

<span class="fc" id="L232">            return Either.right(radiologyResultId);</span>
<span class="nc" id="L233">        } catch (Exception e) {</span>
<span class="nc" id="L234">            throw new RuntimeException(&quot;Exception while saving RadiologyResult &quot;, e);</span>
        }
    }

    private Long getRadiologyResultByLabOrderId(String labOrderId, long oid, Long accountId,
                                                EHRRequestContext context) {
<span class="fc" id="L240">        Long radiologyResultId = null;</span>
<span class="fc" id="L241">        EHRSearch&lt;RadiologyResult&gt; ehrSearch = new EHRSearch&lt;&gt;(accountId, RadiologyResult.class,</span>
                RadiologyResult.MS_RADIOLOGY_RESULT);
<span class="fc" id="L243">        ehrSearch.addFilter(new PKBFilter(&quot;string02&quot;, PKBFilter.Operator.EQUAL, labOrderId));</span>
<span class="fc" id="L244">        ehrSearch.addFilter(new PKBFilter(SourceDetails.EHRQUERY_ORG_ID, PKBFilter.Operator.EQUAL, oid));</span>
<span class="fc" id="L245">        List&lt;EHRData&gt; ehrDataList = beanFactory.getEhrRemote().queryEHRData(ehrSearch, context);</span>
<span class="pc bpc" id="L246" title="1 of 4 branches missed.">        if ((ehrDataList != null) &amp;&amp; !ehrDataList.isEmpty()) {</span>
            // set the ID so we replace the existing data
<span class="fc" id="L248">            radiologyResultId = ehrDataList.get(0).getId();</span>
        }
<span class="fc" id="L250">        return radiologyResultId;</span>
    }

    private Long saveEHRData(Long accountId, EHRRequestContext requestContext, RadiologyResult radiologyResult,
                             EHRData oldVersion) {
<span class="fc" id="L255">        radiologyResult.setTitle(escapeXml(radiologyResult.getTitle()));</span>
<span class="fc" id="L256">        radiologyResult.setDescription(escapeXml(radiologyResult.getDescription()));</span>
        // maintain the unique id
<span class="fc bfc" id="L258" title="All 2 branches covered.">        if (oldVersion != null) {</span>
<span class="fc" id="L259">            radiologyResult.getBaseFields().setUniqueId(oldVersion.getUniqueId());</span>
        } else {
<span class="fc" id="L261">            radiologyResult.getBaseFields().generateNewRandomUniqueId();</span>
        }
<span class="fc" id="L263">        EHRRemote ehrRemote = beanFactory.getEhrRemote();</span>
<span class="fc" id="L264">        EHRData ehrData = ehrRemote.populateEHRData(radiologyResult, accountId, MenuDataType.radiologyResult, requestContext);</span>
<span class="fc" id="L265">        return ehrRemote.saveEHRData(requestContext, ehrData);</span>
    }

    /**
     * Creates the attachment to the radiology MD
     *
     * @
     */
    private void addAttachments(long personId, long accountId, List&lt;Attachment&gt; attachments, Long radiologyResultId) {
<span class="fc" id="L274">        chunkedDocManager.createAttachments(radiologyResultId, attachments, personId, accountId);</span>
<span class="fc" id="L275">    }</span>

    private Long saveRadiologyImage(long patientId, long accountId, RadiologyImage radiologyImage, Long parentResultId,
                                    long sequenceNumber, EHRRequestContext requestContext) throws JAXBException, NamingException {

<span class="nc" id="L280">        EHRRemote ehrRemote = beanFactory.getEhrRemote();</span>
<span class="nc" id="L281">        radiologyImage.setParentId(parentResultId);</span>
<span class="nc" id="L282">        radiologyImage.setSequenceNumber(sequenceNumber);</span>
<span class="nc" id="L283">        radiologyImage.getBaseFields().generateNewRandomUniqueId();</span>
<span class="nc" id="L284">        Document document = ehrRemote.createDocument(</span>
                requestContext,
<span class="nc" id="L286">                radiologyImage.getContent(),</span>
<span class="nc" id="L287">                accountId, genericMetadata(radiologyImage.getContentType(), patientId, RADIOLOGY_IMAGE).toJavaMap());</span>
<span class="nc" id="L288">        UUID documentId = documentManager.create(document);</span>
<span class="nc" id="L289">        EHRData ehrData = ehrRemote.populateEHRData(radiologyImage, accountId, MenuDataType.radiologyImage, requestContext);</span>
<span class="nc" id="L290">        ehrData.setDocumentMetadataId(documentId);</span>
<span class="nc" id="L291">        ehrData.setMigrationVersion(RADIOLOGY_IMAGE_MIGRATION_VERSION);</span>
<span class="nc" id="L292">        ehrRemote.saveEHRData(requestContext, ehrData);</span>
<span class="nc" id="L293">        return ehrData.getId();</span>

    }

    private RadiologyResult populateRadiologyResult(EHRData ehrData, EHRRequestContext context) {
<span class="fc" id="L298">        RadiologyResult radiologyResult = beanFactory.getEhrRemote().populateDTO(ehrData, RadiologyResult.class, context);</span>

<span class="fc" id="L300">        radiologyResult.setTitle(unescapeXml(radiologyResult.getTitle()));</span>
<span class="fc" id="L301">        radiologyResult.setDescription(unescapeXml(radiologyResult.getDescription()));</span>

<span class="fc" id="L303">        return radiologyResult;</span>
    }

    private List&lt;Attachment&gt; getAttachments(Long radiologyResultId) {
<span class="fc" id="L307">        return chunkedDocManager.findAttachmentsAsAttachment(radiologyResultId);</span>
    }

    /**
     * Populate the DTO SourceDetails info needed to display the sources
     * (use a local cache so we only look up each source once)
     *
     * @param dtoList
     */
    private void populateSourceNames(List&lt;RadiologyResult&gt; dtoList) {
<span class="fc" id="L317">        Map&lt;String, Object&gt; tempCache = new HashMap&lt;&gt;();</span>

<span class="fc bfc" id="L319" title="All 2 branches covered.">        for (RadiologyResult dto : dtoList) {</span>
            @Nullable
<span class="fc" id="L321">            PKBPerson personSource = null;</span>
            @Nullable
<span class="fc" id="L323">            String teamName = null;</span>
            @Nullable
<span class="fc" id="L325">            String orgName = null;</span>

<span class="fc bfc" id="L327" title="All 2 branches covered.">            if (dto.getSource().getPersonId() != null) {</span>
<span class="fc" id="L328">                String cacheKey = &quot;person&quot; + dto.getSource().getPersonId();</span>
<span class="fc" id="L329">                PKBPerson cached = (PKBPerson) tempCache.get(cacheKey);</span>
<span class="fc bfc" id="L330" title="All 2 branches covered.">                if (cached == null) {</span>
<span class="fc" id="L331">                    cached = beanFactory.getPKBPersonBean().findPKBPerson(dto.getSource().getPersonId()).getOrNull();</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">                    if (cached == null) {</span>
                        // invalid person id!  put a placeholder
<span class="nc" id="L334">                        cached = new PKBPerson();</span>
<span class="nc" id="L335">                        cached.setTitle(&quot;&quot;);</span>
<span class="nc" id="L336">                        cached.setFirstName(&quot;&quot;);</span>
<span class="nc" id="L337">                        cached.setLastName(&quot;[Person not found]&quot;);</span>
                    }
<span class="fc" id="L339">                    tempCache.put(cacheKey, cached);</span>
                }
<span class="fc" id="L341">                personSource = cached;</span>
            }

<span class="fc bfc" id="L344" title="All 2 branches covered.">            if (dto.getSource().getTeamId() != null) {</span>
<span class="fc" id="L345">                String cacheKey = &quot;team&quot; + dto.getSource().getTeamId();</span>
<span class="fc" id="L346">                Team cached = (Team) tempCache.get(cacheKey);</span>
<span class="fc bfc" id="L347" title="All 2 branches covered.">                if (cached == null) {</span>
<span class="fc" id="L348">                    cached = teamRepository.getInstitute(dto.getSource().getTeamId());</span>
<span class="pc bpc" id="L349" title="1 of 2 branches missed.">                    if (cached == null) {</span>
                        // invalid team id!  put a placeholder
<span class="nc" id="L351">                        cached = new Team();</span>
<span class="nc" id="L352">                        cached.setName(&quot;[Team not found]&quot;);</span>
                    }
<span class="fc" id="L354">                    tempCache.put(cacheKey, cached);</span>
                }
<span class="pc bpc" id="L356" title="1 of 2 branches missed.">                teamName = (cached != null) ? cached.getName() : null;</span>
            }

<span class="fc bfc" id="L359" title="All 2 branches covered.">            if (dto.getSource().getOrgId() != null) {</span>
<span class="fc" id="L360">                String cacheKey = &quot;org&quot; + dto.getSource().getOrgId();</span>
<span class="fc" id="L361">                Org cached = (Org) tempCache.get(cacheKey);</span>
<span class="fc bfc" id="L362" title="All 2 branches covered.">                if (cached == null) {</span>
<span class="fc" id="L363">                    cached = orgRepository.getOrg(dto.getSource().getOrgId()).orElse(null);</span>
<span class="pc bpc" id="L364" title="1 of 2 branches missed.">                    if (cached == null) {</span>
                        // invalid org id!  put a placeholder
<span class="nc" id="L366">                        cached = new Org();</span>
<span class="nc" id="L367">                        cached.setName(&quot;[Org not found]&quot;);</span>
                    }
<span class="fc" id="L369">                    tempCache.put(cacheKey, cached);</span>
                }
<span class="pc bpc" id="L371" title="1 of 2 branches missed.">                orgName = (cached != null) ? cached.getName() : null;</span>
            }

<span class="fc" id="L374">            dto.getSource().setDisplayNames(personSource, teamName, orgName);</span>
<span class="fc" id="L375">        }</span>
<span class="fc" id="L376">    }</span>

    private String escapeXml(String value) {
<span class="fc" id="L379">        return StringEscapeUtils.escapeXml10(value);</span>
    }

    private String unescapeXml(String value) {
<span class="fc" id="L383">        return StringEscapeUtils.unescapeXml(value);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>