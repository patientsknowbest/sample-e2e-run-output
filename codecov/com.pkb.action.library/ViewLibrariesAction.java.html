<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ViewLibrariesAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.library</a> &gt; <span class="el_source">ViewLibrariesAction.java</span></div><h1>ViewLibrariesAction.java</h1><pre class="source lang-java linenums">package com.pkb.action.library;

import com.opensymphony.xwork2.Action;
import com.pkb.action.ConsentCategoryBaseAction;
import com.pkb.action.DiscussDatapointService;
import com.pkb.action.ImmutableDiscussLibraryRequest;
import com.pkb.action.message.UIDiscussDto;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.bean.IMessageWebBean;
import com.pkb.exception.PKBException;
import com.pkb.notification.entity.Activity;
import com.pkb.personallibrary.entity.PersonalLibraryEntryDTO;
import com.pkb.service.personallibrary.PersonalLibraryManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.UserManager;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import java.net.MalformedURLException;
import java.net.URI;
import java.net.URISyntaxException;
import java.net.URL;
import java.util.List;
import java.util.Optional;
import java.util.concurrent.ExecutionException;

import static com.pkb.action.BaseAction.NhsAppPage.HEALTH_RECORDS;
import static org.apache.commons.lang3.StringUtils.isBlank;

/**
 * This is the action for users to view team libraries and view and manage their personal libraries
 *
 * @author russell
 */
<span class="fc" id="L37">public class ViewLibrariesAction extends ConsentCategoryBaseAction {</span>

    private static final long serialVersionUID = 1L;
<span class="fc" id="L40">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private IMessageWebBean messageWebBean;

    private PersonalLibraryManager personalLibraryManager;

    private UILibraryDto dto;

    private UIDiscussDto discussDto;

<span class="fc" id="L50">    private int deleteId = -1;</span>
<span class="fc" id="L51">    private Long editingId = null;</span>

    private String tkid;//db id of an ILE
    private String folderName;
    private String folderId;
    private String anchor;

    private TeamUserManager teamUserManager;

    private List&lt;String&gt; selectedInstituteLibraryIds;

    private Long deletePersonalLibraryId;

    private List&lt;Long&gt; selectedPersonalLibraryIds;

    private String discussMessage;

    private String discussTopic;

    //from editPersonalLibraryEntry.jsp:
    private String description;
    private String url;

    private String link;

    public String getDescription() {
<span class="fc" id="L77">        return description;</span>
    }

    @Autowired
    private LibraryService libraryService;

    @Autowired
    private DiscussDatapointService discussService;

    public void setDescription(String description) {
<span class="fc" id="L87">        this.description = description;</span>
<span class="fc" id="L88">    }</span>

    public String getUrl() {
<span class="fc" id="L91">        return url;</span>
    }

    //from /library/addLink.action (NHS choices)

    public void setUrl(String url) {
<span class="fc" id="L97">        this.url = url;</span>
<span class="fc" id="L98">    }</span>

    //from /library/addLink.action (NHS choices)

    /**
     * This method processes links added from external sites like NHS choices
     *
     * @return
     */
    public String addLinkExternal() {

<span class="nc" id="L109">        long userId = loggedInUserUtil.getLoggedInUserId();</span>

<span class="nc bnc" id="L111" title="All 2 branches missed.">        if (link == null) {</span>
<span class="nc" id="L112">            addActionError(getText(&quot;viewLibrariesAction.err.no_link&quot;));</span>
<span class="nc" id="L113">            return ERROR;</span>
        }
        try {
<span class="nc" id="L116">            URL test = new URL(link);</span>
<span class="nc" id="L117">            test.toURI();</span>
<span class="nc" id="L118">        } catch (MalformedURLException | URISyntaxException ignored) {</span>
<span class="nc" id="L119">            addActionError(getText(&quot;viewLibrariesAction.err.not_proper_link&quot;));</span>
<span class="nc" id="L120">            return ERROR;</span>
<span class="nc" id="L121">        }</span>

        try {
<span class="nc" id="L124">            var requestContext = getEHRRequestContext();</span>
<span class="nc" id="L125">            PersonalLibraryEntryDTO dto = new PersonalLibraryEntryDTO(new SourceDetails(requestContext));</span>
            //for now we just use the link as the description
<span class="nc" id="L127">            dto.setDescription(link);</span>
<span class="nc" id="L128">            dto.setUrl(link);</span>
<span class="nc" id="L129">            personalLibraryManager.addLibraryEntry(requestContext, dto, userId);</span>
<span class="nc" id="L130">            return Action.SUCCESS;</span>

<span class="nc" id="L132">        } catch (PKBException e) {</span>
<span class="nc" id="L133">            addActionError(getText(&quot;viewLibrariesAction.err.unexpected_error&quot;));</span>
<span class="nc" id="L134">            LOGGER.error(&quot;Unexpected error adding link via nhs choices&quot;, e);</span>
<span class="nc" id="L135">            return ERROR;</span>
        }

    }

    public String buildLibraries() throws ExecutionException {
<span class="fc" id="L141">        setNhsAppPage(HEALTH_RECORDS.name());</span>
<span class="fc" id="L142">        var request = ImmutableBuildLibrariesRequest.builder()</span>
<span class="fc" id="L143">                .eHRRequestContext(getLoggedInEHRRequestContext())</span>
<span class="fc" id="L144">                .locale(getLocale())</span>
<span class="fc" id="L145">                .tkid(Optional.ofNullable(tkid))</span>
<span class="fc" id="L146">                .nhsStyle(sessionUtil.renderNhsStyle())</span>
<span class="fc" id="L147">                .build();</span>
<span class="fc" id="L148">        dto = libraryService.buildLibraries(request);</span>
<span class="fc" id="L149">        return getActionResult(dto);</span>
    }

    public String createLibraryEntry() {
<span class="fc" id="L153">        setDefaultFlag();</span>
<span class="fc" id="L154">        return Action.SUCCESS;</span>
    }

    public String editLibraryEntry() {
<span class="fc" id="L158">        disablePrivacyFlagEditForm();</span>
<span class="fc" id="L159">        var users = getContextAndLoggedInUsers();</span>
<span class="fc" id="L160">        return getPersonalLibraryEntry().map(dto -&gt; {</span>
<span class="fc" id="L161">            description = dto.getDescription();</span>
<span class="fc" id="L162">            url = dto.getUrl();</span>
<span class="fc" id="L163">            fillPrivacyFlagsFrom(dto);</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">            if (hasNotPermissionsToEditDatapoint(dto, users.loggedInUser(), loggedInUserUtil.getLoggedInUserPrimaryTeam())) {</span>
<span class="nc" id="L165">                return ERROR;</span>
            }
<span class="fc" id="L167">            return Action.SUCCESS;</span>
<span class="fc" id="L168">        }).orElseGet(() -&gt; {</span>
<span class="nc" id="L169">            addActionError(getText(&quot;viewLibrariesAction.err.entry_not_found&quot;));</span>
<span class="nc" id="L170">            return Action.ERROR;</span>
        });
    }

    public String save() throws ExecutionException {
<span class="fc" id="L175">        boolean isValid = true;</span>
<span class="fc" id="L176">        refillPrivacyFlags();</span>

<span class="fc bfc" id="L178" title="All 2 branches covered.">        if (isBlank(url)) {</span>
<span class="fc" id="L179">            addFieldError(&quot;url&quot;, getText(&quot;library.url.required&quot;));</span>
<span class="fc" id="L180">            isValid = false;</span>
        } else {
            try {
<span class="pc bpc" id="L183" title="3 of 8 branches missed.">                if (!(url.startsWith(&quot;http&quot;) || url.startsWith(&quot;ftp&quot;) || url.startsWith(&quot;sftp&quot;) || url.startsWith(&quot;https&quot;))) {</span>
<span class="fc" id="L184">                    url = &quot;http://&quot; + url;</span>
                }
<span class="fc" id="L186">                URL test = new URL(url);</span>
<span class="fc" id="L187">                test.toURI();</span>
<span class="nc" id="L188">            } catch (MalformedURLException | URISyntaxException ignored) {</span>
<span class="nc" id="L189">                addFieldError(&quot;url&quot;, getText(&quot;library.url.invalid&quot;));</span>
<span class="nc" id="L190">                isValid = false;</span>
<span class="fc" id="L191">            }</span>
        }

<span class="fc bfc" id="L194" title="All 2 branches covered.">        if (isBlank(description)) {</span>
<span class="fc" id="L195">            addFieldError(&quot;description&quot;, getText(&quot;library.description.required&quot;));</span>
<span class="fc" id="L196">            isValid = false;</span>
        }

<span class="fc bfc" id="L199" title="All 2 branches covered.">        if (isValid) {</span>
<span class="fc" id="L200">            var users = getContextAndLoggedInUsers();</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">            if (editingId != null) {</span>
<span class="fc" id="L202">                var requestContext = getLoggedInEHRRequestContext();</span>
                PersonalLibraryEntryDTO dto;
<span class="fc" id="L204">                dto = personalLibraryManager.getEntry(requestContext, editingId, users.contextUser().getId());</span>
<span class="fc" id="L205">                dto.setDescription(description);</span>
<span class="fc" id="L206">                dto.setUrl(url);</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">                if (hasNotPermissionsToEditDatapoint(dto, users.loggedInUser(), loggedInUserUtil.getLoggedInUserPrimaryTeam())) {</span>
<span class="nc" id="L208">                    return ERROR;</span>
                } else {
<span class="fc" id="L210">                    personalLibraryManager.saveEntry(requestContext, dto, users.contextUser().getId(), userManager.getDefaultAccountId(users.contextUser().getId()));</span>
                }
<span class="fc" id="L212">            } else {</span>
<span class="fc" id="L213">                EHRRequestContext requestContext = getEHRRequestContext();</span>
<span class="fc" id="L214">                PersonalLibraryEntryDTO dto = new PersonalLibraryEntryDTO(new SourceDetails(requestContext));</span>
<span class="fc" id="L215">                dto.setDescription(description);</span>
<span class="fc" id="L216">                dto.setUrl(url);</span>
<span class="fc" id="L217">                fillPrivacyFlagIn(dto);</span>
<span class="fc" id="L218">                setConsentCategoriesOnEntity(dto);</span>
<span class="fc" id="L219">                dto.getBaseFields().generateNewRandomUniqueId();</span>
<span class="fc" id="L220">                personalLibraryManager.addLibraryEntry(requestContext, dto, users.contextUser().getId());</span>
<span class="fc" id="L221">                logActivity(Activity.Action.ADDED_LIBRARY_LINK, dateTimeService.now(), users.contextUser().getId(), true, dto);</span>
            }
<span class="fc" id="L223">            editingId = null;</span>
<span class="fc" id="L224">            buildLibraries();</span>
<span class="fc" id="L225">            return SUCCESS;</span>
        }
<span class="fc" id="L227">        return ERROR;</span>
    }

    public String confirmDelete() {

<span class="fc" id="L232">        return &quot;input&quot;;</span>
    }

    public String cancelDelete() {
<span class="nc" id="L236">        return &quot;cancel&quot;;</span>
    }

    public String cancelEdit() {
<span class="nc" id="L240">        this.editingId = null;</span>
<span class="nc" id="L241">        return &quot;cancel&quot;;</span>
    }

    public String discussLibraryEntries() throws ExecutionException {
<span class="fc" id="L245">        var request = ImmutableDiscussLibraryRequest.builder()</span>
<span class="fc" id="L246">                .eHRRequestContext(getLoggedInEHRRequestContext())</span>
<span class="fc" id="L247">                .locale(getLocale())</span>
<span class="fc" id="L248">                .personalLibraryIds(Optional.ofNullable(selectedPersonalLibraryIds))</span>
<span class="fc" id="L249">                .instituteLibraryIds(Optional.ofNullable(selectedInstituteLibraryIds))</span>
<span class="fc" id="L250">                .build();</span>
<span class="fc" id="L251">        discussDto = discussService.discuss(request);</span>
<span class="fc" id="L252">        discussMessage = discussDto.getDiscussMessage();</span>
<span class="fc" id="L253">        discussTopic = discussDto.getDiscussTopic();</span>
<span class="fc" id="L254">        sessionUtil.setContextRecipientId(discussDto.getContextRecipientId());</span>
<span class="fc" id="L255">        return getActionResult(discussDto);</span>
    }

    public String deleteLibraryEntry() throws Exception {
<span class="pc bpc" id="L259" title="2 of 4 branches missed.">        if ((deletePersonalLibraryId != null) &amp;&amp; (deletePersonalLibraryId != 0)) {</span>
<span class="fc" id="L260">            long userId = contextUserUtil.getContextOrLoggedInUserId();</span>

<span class="fc" id="L262">            userManager.transactional(() -&gt; {</span>
<span class="fc" id="L263">                personalLibraryManager.deleteEntry(getEHRRequestContext(), deletePersonalLibraryId, userId);</span>
<span class="fc" id="L264">                PersonalLibraryEntryDTO dto = personalLibraryManager.getEntry(getLoggedInEHRRequestContext(), deletePersonalLibraryId,</span>
                        userId);
<span class="fc" id="L266">                logActivity(Activity.Action.DELETED_LIBRARY_LINK, dateTimeService.now(), userId, true, dto);</span>
<span class="fc" id="L267">            });</span>
<span class="fc" id="L268">            deletePersonalLibraryId = 0L;</span>
        }

<span class="fc" id="L271">        return Action.SUCCESS;</span>
    }

    public String getTkid() {
<span class="fc" id="L275">        return tkid;</span>
    }

    public void setTkid(String tkid) {
<span class="fc" id="L279">        this.tkid = tkid;</span>
<span class="fc" id="L280">    }</span>

    public String getFolderName() {
<span class="nc" id="L283">        return folderName;</span>
    }

    public void setFolderName(String folderName) {
<span class="nc" id="L287">        this.folderName = folderName;</span>
<span class="nc" id="L288">    }</span>

    public String getFolderId() {
<span class="nc" id="L291">        return folderId;</span>
    }

    public void setFolderId(String folderId) {
<span class="nc" id="L295">        this.folderId = folderId;</span>
<span class="nc" id="L296">    }</span>

    public String getAnchor() {
<span class="nc" id="L299">        return anchor;</span>
    }

    public void setAnchor(String anchor) {
<span class="nc" id="L303">        this.anchor = anchor;</span>
<span class="nc" id="L304">    }</span>

    private void setConsentCategoriesOnEntity(PersonalLibraryEntryDTO dto) {
<span class="fc" id="L307">        fillPrivacyFlagIn(dto);</span>
<span class="fc" id="L308">    }</span>

    private Optional&lt;PersonalLibraryEntryDTO&gt; getPersonalLibraryEntry() {
<span class="pc bpc" id="L311" title="1 of 2 branches missed.">        if (editingId == null) {</span>
<span class="nc" id="L312">            return Optional.empty();</span>
        }
<span class="fc" id="L314">        long userId = contextUserUtil.getContextOrLoggedInUserId();</span>

<span class="fc" id="L316">        return Optional.ofNullable(personalLibraryManager.getEntry(getLoggedInEHRRequestContext(), editingId, userId));</span>
    }

    public UserManager getUserManager() {
<span class="nc" id="L320">        return userManager;</span>
    }

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L324">        this.userManager = userManager;</span>
<span class="fc" id="L325">    }</span>

    public IMessageWebBean getMessageWebBean() {
<span class="fc" id="L328">        return messageWebBean;</span>
    }

    public void setMessageWebBean(IMessageWebBean messageWebBean) {
<span class="fc" id="L332">        this.messageWebBean = messageWebBean;</span>
<span class="fc" id="L333">    }</span>

    public PersonalLibraryManager getPersonalLibraryManager() {
<span class="nc" id="L336">        return personalLibraryManager;</span>
    }

    public void setPersonalLibraryManager(PersonalLibraryManager personalLibraryManager) {
<span class="fc" id="L340">        this.personalLibraryManager = personalLibraryManager;</span>
<span class="fc" id="L341">    }</span>

    public TeamUserManager getTeamUserManager() {
<span class="fc" id="L344">        return teamUserManager;</span>
    }

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L348">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L349">    }</span>

    public List&lt;String&gt; getSelectedInstituteLibraryIds() {
<span class="fc" id="L352">        return selectedInstituteLibraryIds;</span>
    }

    public void setSelectedInstituteLibraryIds(List&lt;String&gt; selectedInstituteLibraryIds) {
<span class="fc" id="L356">        this.selectedInstituteLibraryIds = selectedInstituteLibraryIds;</span>
<span class="fc" id="L357">    }</span>

    public Long getDeletePersonalLibraryId() {
<span class="fc" id="L360">        return deletePersonalLibraryId;</span>
    }

    public void setDeletePersonalLibraryId(Long deletePersonalLibraryId) {
<span class="fc" id="L364">        this.deletePersonalLibraryId = deletePersonalLibraryId;</span>
<span class="fc" id="L365">    }</span>

    public List&lt;Long&gt; getSelectedPersonalLibraryIds() {
<span class="fc" id="L368">        return selectedPersonalLibraryIds;</span>
    }

    public void setSelectedPersonalLibraryIds(List&lt;Long&gt; selectedPersonalLibraryIds) {
<span class="fc" id="L372">        this.selectedPersonalLibraryIds = selectedPersonalLibraryIds;</span>
<span class="fc" id="L373">    }</span>

    public Long getEditingId() {
<span class="fc" id="L376">        return editingId;</span>
    }

    public void setEditingId(Long editingId) {
<span class="fc" id="L380">        this.editingId = editingId;</span>
<span class="fc" id="L381">    }</span>

    public int getDeleteId() {
<span class="fc" id="L384">        return deleteId;</span>
    }

    public void setDeleteId(int deleteId) {
<span class="fc" id="L388">        this.deleteId = deleteId;</span>
<span class="fc" id="L389">    }</span>

    // Tabs
    public String getTab() {
<span class="fc" id="L393">        return &quot;treatments&quot;;</span>
    }

    public String getSubTab() {
<span class="fc" id="L397">        return &quot;library&quot;;</span>
    }

    public String getLink() {
<span class="nc" id="L401">        return link;</span>
    }

    public void setLink(String link) {
<span class="nc" id="L405">        this.link = link;</span>
<span class="nc" id="L406">    }</span>

    public String getDiscussMessage() {
<span class="fc" id="L409">        return discussMessage;</span>
    }

    public void setDiscussMessage(String discussMessage) {
<span class="nc" id="L413">        this.discussMessage = discussMessage;</span>
<span class="nc" id="L414">    }</span>

    public String getDiscussTopic() {
<span class="fc" id="L417">        return discussTopic;</span>
    }

    public void setDiscussTopic(String discussTopic) {
<span class="nc" id="L421">        this.discussTopic = discussTopic;</span>
<span class="nc" id="L422">    }</span>

    public String getNoHostBaseURL() throws URISyntaxException {
<span class="nc" id="L425">        URI baseUrl = new URI(config.getBaseURL());</span>
<span class="nc" id="L426">        return baseUrl.getHost() + baseUrl.getPath();</span>
    }

    @Override
    public String getCustomStyle() {
<span class="fc bfc" id="L431" title="All 2 branches covered.">        return dto.isNhsStyle() ? NHS_STYLE : PKB_STYLE;</span>
    }

    public void setDto(UILibraryDto dto) {
<span class="nc" id="L435">        this.dto = dto;</span>
<span class="nc" id="L436">    }</span>

    public UILibraryDto getDto() {
<span class="fc" id="L439">        return dto;</span>
    }

    public UIDiscussDto getDiscussDto() {
<span class="nc" id="L443">        return discussDto;</span>
    }

    public void setDiscussDto(UIDiscussDto discussDto) {
<span class="nc" id="L447">        this.discussDto = discussDto;</span>
<span class="nc" id="L448">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>