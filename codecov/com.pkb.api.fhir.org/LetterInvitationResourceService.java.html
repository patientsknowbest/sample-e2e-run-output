<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LetterInvitationResourceService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.fhir.org</a> &gt; <span class="el_source">LetterInvitationResourceService.java</span></div><h1>LetterInvitationResourceService.java</h1><pre class="source lang-java linenums">package com.pkb.api.fhir.org;

import ca.uhn.fhir.rest.server.exceptions.BaseServerResponseException;
import ca.uhn.fhir.rest.server.exceptions.InternalErrorException;
import com.pkb.api.fhir.config.HybridMailProperties;
import com.pkb.api.fhir.parameters.ParametersToPatientIdentifiersDTOMapper;
import com.pkb.api.fhir.util.Issues;
import com.pkb.authentication.AuthenticatedIdentity;
import com.pkb.authentication.principal.user.AuthenticatedSystemUser;
import com.pkb.authz.AuthorizationDataService;
import com.pkb.authz.AuthorizationService;
import com.pkb.authz.data.AuthorizationData;
import com.pkb.authz.data.AuthorizationInputs;
import com.pkb.crypto.AccountPrivateKey;
import com.pkb.datamodel.LetterInvitation;
import com.pkb.datamodel.LetterInvitationTokenDTO;
import com.pkb.domain.letterinvitation.LetterInvitationService;
import com.pkb.entities.enums.ValidNationalId;
import io.vavr.collection.List;
import io.vavr.control.Either;
import io.vavr.control.Validation;
import org.hl7.fhir.dstu3.model.Parameters;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;

import static com.pkb.api.fhir.util.Fhirs.invalidRequestException;
import static com.pkb.authz.ImmutableTargetMeta.targetMeta;
import static com.pkb.authz.action.Action.CREATE;
import static com.pkb.authz.context.Path.FHIR;
import static com.pkb.authz.data.ImmutableAuthorizationInputs.inputs;
import static io.vavr.API.None;
import static io.vavr.API.Set;
import static io.vavr.control.Either.left;
import static java.lang.invoke.MethodHandles.lookup;
import static java.util.function.Function.identity;
import static org.slf4j.LoggerFactory.getLogger;

public class LetterInvitationResourceService {
<span class="fc" id="L39">    private static final Logger LOGGER = getLogger(lookup().lookupClass());</span>

    private final LetterInvitationService letterInvitationService;
    private final ParametersToPatientIdentifiersDTOMapper parametersToPatientIdentifiersDTOMapper;
    private final AuthorizationDataService authorizationDataService;
    private final AuthorizationService authorizationService;
    private final HybridMailProperties hybridMailProperties;

    public LetterInvitationResourceService(LetterInvitationService letterInvitationService,
                                           ParametersToPatientIdentifiersDTOMapper parametersToPatientIdentifiersDTOMapper,
                                           AuthorizationDataService authorizationDataService,
                                           AuthorizationService authorizationService,
<span class="fc" id="L51">                                           HybridMailProperties hybridMailProperties) {</span>
<span class="fc" id="L52">        this.letterInvitationService = letterInvitationService;</span>
<span class="fc" id="L53">        this.parametersToPatientIdentifiersDTOMapper = parametersToPatientIdentifiersDTOMapper;</span>
<span class="fc" id="L54">        this.authorizationDataService = authorizationDataService;</span>
<span class="fc" id="L55">        this.authorizationService = authorizationService;</span>
<span class="fc" id="L56">        this.hybridMailProperties = hybridMailProperties;</span>
<span class="fc" id="L57">    }</span>

    public @NotNull Either&lt;BaseServerResponseException, List&lt;LetterInvitationTokenDTO&gt;&gt; getLetterInvitations(
            AuthenticatedIdentity authenticatedIdentity,
            Parameters parameters) {
        // Do not return info on missing or invalid patients
<span class="fc" id="L63">        Validation&lt;Issues, List&lt;ValidNationalId&gt;&gt; issuesOrPatientIdentifierDTOs = parametersToPatientIdentifiersDTOMapper.toPatientNationalIdentifiers(parameters,</span>
<span class="fc" id="L64">                hybridMailProperties.getInvitationTokenRequestLimit());</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">        if (issuesOrPatientIdentifierDTOs.isInvalid()) {</span>
<span class="fc" id="L66">            return left(invalidRequestException(issuesOrPatientIdentifierDTOs.getError()));</span>
        } else {
<span class="fc" id="L68">            return getTokenListWithValidSystemUser(authenticatedIdentity, issuesOrPatientIdentifierDTOs.get())</span>
<span class="fc" id="L69">                    .bimap(InternalErrorException::new, identity());</span>
        }
    }

    @NotNull
    private Either&lt;RuntimeException, List&lt;LetterInvitationTokenDTO&gt;&gt; getTokenListWithValidSystemUser(
            AuthenticatedIdentity authenticatedIdentity,
            List&lt;ValidNationalId&gt; identifiers) {
<span class="fc" id="L77">        AuthorizationData authorizationData = getAuthorizationData(authenticatedIdentity);</span>
<span class="fc" id="L78">        return authorizationService.authorize(authorizationData)</span>
<span class="fc" id="L79">                .checkSingleResult(() -&gt; {</span>
<span class="fc" id="L80">                    AuthenticatedSystemUser systemUser = authorizationData.inputs().requireAuthenticatedSystemUser();</span>
<span class="fc" id="L81">                    var accountPrivateKey = authorizationData.inputs().authenticatedIdentity().requireAccountPrivateKey();</span>
<span class="fc" id="L82">                    return getTokenList(accountPrivateKey, identifiers, systemUser.getOrgId());</span>
                });

    }

    @NotNull
    private AuthorizationData getAuthorizationData(AuthenticatedIdentity authenticatedIdentity) {
<span class="fc" id="L89">        AuthorizationInputs authInputs = inputs()</span>
<span class="fc" id="L90">                .authenticatedIdentity(authenticatedIdentity)</span>
<span class="fc" id="L91">                .action(CREATE)</span>
<span class="fc" id="L92">                .addTargets(targetMeta(LetterInvitation.class, Set(), None(), false))</span>
<span class="fc" id="L93">                .path(FHIR)</span>
<span class="fc" id="L94">                .build();</span>
<span class="fc" id="L95">        return authorizationDataService.fetch(authInputs);</span>
    }

    @NotNull
    private List&lt;LetterInvitationTokenDTO&gt; getTokenList(AccountPrivateKey credential, List&lt;ValidNationalId&gt; identifiers, Long orgId) {
<span class="fc" id="L100">        return identifiers.map(identifier -&gt; letterInvitationService.createLetterInvitation(identifier, credential, orgId))</span>
<span class="fc" id="L101">                .partition(Either::isLeft)</span>
<span class="fc" id="L102">                .map1(l -&gt; l.map(Either::getLeft).peek(LOGGER::warn))</span>
<span class="fc" id="L103">                .map2(r -&gt; r.map(Either::get))</span>
                ._2;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>