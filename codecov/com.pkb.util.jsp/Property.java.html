<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Property.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.util.jsp</a> &gt; <span class="el_source">Property.java</span></div><h1>Property.java</h1><pre class="source lang-java linenums">package com.pkb.util.jsp;

import com.google.common.annotations.VisibleForTesting;
import com.opensymphony.xwork2.ObjectFactory;
import com.opensymphony.xwork2.inject.Inject;
import com.opensymphony.xwork2.util.ValueStack;
import com.pkb.util.security.CustomStyledHtmlFilter;
import com.pkb.util.security.HtmlMessageFilter;
import com.pkb.util.security.MinimalHtmlFilter;
import com.pkb.util.security.UrlToLinkFilter;
import org.apache.commons.lang3.NotImplementedException;
import org.apache.struts2.components.Component;
import org.apache.struts2.views.annotations.StrutsTag;
import org.apache.struts2.views.annotations.StrutsTagAttribute;
import org.owasp.encoder.Encode;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import java.io.IOException;
import java.io.Writer;
import java.util.EnumSet;
import java.util.Set;

import static com.google.common.base.Preconditions.checkState;

/**
 * @see https://www.owasp.org/index.php/OWASP_Java_Encoder_Project#tab=Use_the_Java_Encoder_Project
 */
@StrutsTag(name = &quot;property&quot;, tldBodyContent = &quot;empty&quot;, tldTagClass = &quot;com.pkb.util.jsp.PropertyTag&quot;, description = &quot;Print out expression which evaluates against the stack https://www.owasp.org/index.php/OWASP_Java_Encoder_Project#tab=Use_the_Java_Encoder_Project&quot;)
public class Property extends Component {

<span class="fc" id="L33">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private String defaultValue;
    private String value;
<span class="fc" id="L37">    private Set&lt;EscapeType&gt; escapes = EnumSet.of(EscapeType.FOR_HTML);</span>
    private Filters filters;

    public Property(ValueStack stack) {
<span class="fc" id="L41">        super(stack);</span>
<span class="fc" id="L42">    }</span>

    @StrutsTagAttribute(description = &quot;The default value to be used if &lt;u&gt;value&lt;/u&gt; attribute is null&quot;)
    public void setDefault(String defaultValue) {
<span class="fc" id="L46">        this.defaultValue = defaultValue;</span>
<span class="fc" id="L47">    }</span>

    @StrutsTagAttribute(description = &quot;Whether to escape for HTML&quot;, type = &quot;Boolean&quot;, defaultValue = &quot;true&quot;)
    public void setEscapeHtml(boolean escape) {
<span class="fc" id="L51">        handleToggle(escape, EscapeType.FOR_HTML);</span>
<span class="fc" id="L52">    }</span>

    @StrutsTagAttribute(description = &quot;Whether to escape for Javascript&quot;, type = &quot;Boolean&quot;, defaultValue = &quot;false&quot;)
    public void setEscapeJavaScript(boolean escapeJavaScript) {
<span class="fc" id="L56">        handleToggle(escapeJavaScript, EscapeType.FOR_JS);</span>
<span class="fc" id="L57">    }</span>

    @StrutsTagAttribute(description = &quot;Value to be displayed&quot;, type = &quot;Object&quot;, defaultValue = &quot;&amp;lt;top of stack&amp;gt;&quot;)
    public void setValue(String value) {
<span class="fc" id="L61">        this.value = value;</span>
<span class="fc" id="L62">    }</span>

    public void setDefaultValue(String defaultValue) {
<span class="nc" id="L65">        this.defaultValue = defaultValue;</span>
<span class="nc" id="L66">    }</span>

    @StrutsTagAttribute(description = &quot;Whether to escape for XML&quot;, type = &quot;Boolean&quot;, defaultValue = &quot;false&quot;)
    public void setEscapeXml(boolean escapeXml) {
<span class="fc" id="L70">        handleToggle(escapeXml, EscapeType.FOR_XML);</span>
<span class="fc" id="L71">    }</span>

    @StrutsTagAttribute(description = &quot;Whether to filter for minimal HTML&quot;, type = &quot;Boolean&quot;, defaultValue = &quot;false&quot;)
    public void setFilterMinimalHtml(boolean filterMinimalHtml) {
<span class="fc" id="L75">        handleToggle(filterMinimalHtml, EscapeType.FILTER_MINIMAL_HTML);</span>
<span class="fc" id="L76">    }</span>

    @StrutsTagAttribute(description = &quot;Whether to filter for relaxed HTML including styling&quot;, type = &quot;Boolean&quot;, defaultValue = &quot;false&quot;)
    public void setFilterRelaxedHtmlWithStyles(boolean filterRelaxedHtmlWithStyles) {
<span class="fc" id="L80">        handleToggle(filterRelaxedHtmlWithStyles, EscapeType.FILTER_RELAXED_HTML_WITH_STYLES);</span>
<span class="fc" id="L81">    }</span>

    @StrutsTagAttribute(description = &quot;Whether to message for HTML&quot;, type = &quot;Boolean&quot;, defaultValue = &quot;false&quot;)
    public void setFilterMessage(boolean filterMessage) {
<span class="fc" id="L85">        handleToggle(filterMessage, EscapeType.FILTER_MESSAGE);</span>
<span class="fc" id="L86">    }</span>

    @StrutsTagAttribute(description = &quot;Whether to convert URL to links&quot;, type = &quot;Boolean&quot;, defaultValue = &quot;false&quot;)
    public void setConvertUrlToLink(boolean convertUrlToLink) {
<span class="fc" id="L90">        handleToggle(convertUrlToLink, EscapeType.CONVERT_URL_TO_LINK);</span>
<span class="fc" id="L91">    }</span>

    private void handleToggle(boolean toggle, EscapeType type) {
<span class="fc bfc" id="L94" title="All 2 branches covered.">        if (toggle) {</span>
<span class="fc" id="L95">            escapes.add(type);</span>
        } else {
<span class="fc" id="L97">            escapes.remove(type);</span>
        }
<span class="fc" id="L99">    }</span>

    @Override
    public boolean start(Writer writer) {
<span class="fc" id="L103">        boolean result = super.start(writer);</span>

<span class="fc" id="L105">        String actualValue = null;</span>

<span class="fc bfc" id="L107" title="All 2 branches covered.">        if (value == null) {</span>
<span class="fc" id="L108">            value = &quot;top&quot;;</span>
        } else {
<span class="fc" id="L110">            value = stripExpressionIfAltSyntax(value);</span>
        }

        // exception: don't call findString(), since we don't want the
        //            expression parsed in this one case. it really
        //            doesn't make sense, in fact.
<span class="fc" id="L116">        actualValue = (String) getStack().findValue(value, String.class, throwExceptionOnELFailure);</span>

        try {
<span class="fc bfc" id="L119" title="All 2 branches covered.">            if (actualValue != null) {</span>
<span class="fc" id="L120">                writer.write(escape(actualValue));</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">            } else if (defaultValue != null) {</span>
<span class="fc" id="L122">                writer.write(escape(defaultValue));</span>
            }
<span class="nc" id="L124">        } catch (IOException e) {</span>
<span class="nc" id="L125">            LOGGER.error(&quot;Could not print out value '{}'&quot;, value, e);</span>
<span class="fc" id="L126">        }</span>

<span class="fc" id="L128">        return result;</span>
    }

    protected String escape(String value) {
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">        checkState(escapes.size() &lt; 2, &quot;Multiple property escaping set [%s], only one type of escaping is supported at a time!&quot;, escapes);</span>
<span class="fc" id="L133">        String result = value;</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">        if (escapes.size() == 1) {</span>
<span class="pc bpc" id="L135" title="3 of 8 branches missed.">            switch (escapes.iterator().next()) {</span>
            case FOR_HTML:
<span class="fc" id="L137">                result = Encode.forHtml(result);</span>
<span class="fc" id="L138">                break;</span>
            case FOR_JS:
<span class="fc" id="L140">                result = Encode.forJavaScript(result);</span>
<span class="fc" id="L141">                break;</span>
            case FOR_XML:
<span class="nc" id="L143">                result = Encode.forXml(result);</span>
<span class="nc" id="L144">                break;</span>
            case FILTER_MINIMAL_HTML:
<span class="fc" id="L146">                result = filters.minimalHtmlFilter.filter(result);</span>
<span class="fc" id="L147">                break;</span>
            case FILTER_RELAXED_HTML_WITH_STYLES:
<span class="fc" id="L149">                result = filters.customStyledHtmlFilter.filter(result);</span>
<span class="fc" id="L150">                break;</span>
            case FILTER_MESSAGE:
<span class="nc" id="L152">                result = filters.htmlMessageFilter.filter(result);</span>
<span class="nc" id="L153">                break;</span>
            case CONVERT_URL_TO_LINK:
<span class="fc" id="L155">                result = filters.urlToLinkFilter.filter(result);</span>
<span class="fc" id="L156">                break;</span>
            default:
<span class="nc" id="L158">                throw new NotImplementedException(&quot;Escape type not implemented yet!&quot;);</span>
            }
        }
<span class="fc" id="L161">        return result;</span>
    }

<span class="fc" id="L164">    enum EscapeType {</span>
<span class="fc" id="L165">		FOR_HTML, FOR_JS, FOR_XML, FILTER_MINIMAL_HTML, FILTER_MESSAGE, FILTER_RELAXED_HTML_WITH_STYLES, CONVERT_URL_TO_LINK</span>
    }

    @VisibleForTesting
    @Override
    protected String stripExpressionIfAltSyntax(String expr) {
<span class="fc" id="L171">        return super.stripExpressionIfAltSyntax(expr);</span>
    }

<span class="fc" id="L174">    public static class Filters {</span>
        private MinimalHtmlFilter minimalHtmlFilter;
        private HtmlMessageFilter htmlMessageFilter;
        private CustomStyledHtmlFilter customStyledHtmlFilter;
        private UrlToLinkFilter urlToLinkFilter;

        @Autowired
        public void setMinimalHtmlFilter(MinimalHtmlFilter minimalHtmlFilter) {
<span class="fc" id="L182">            this.minimalHtmlFilter = minimalHtmlFilter;</span>
<span class="fc" id="L183">        }</span>

        @Autowired
        public void setHtmlMessageFilter(HtmlMessageFilter htmlMessageFilter) {
<span class="fc" id="L187">            this.htmlMessageFilter = htmlMessageFilter;</span>
<span class="fc" id="L188">        }</span>

        @Autowired
        public void setCustomStyledHtmlFilter(CustomStyledHtmlFilter customStyledHtmlFilter) {
<span class="fc" id="L192">            this.customStyledHtmlFilter = customStyledHtmlFilter;</span>
<span class="fc" id="L193">        }</span>

        @Autowired
        public void setUrlToLinkFilter(UrlToLinkFilter urlToLinkFilter) {
<span class="fc" id="L197">            this.urlToLinkFilter = urlToLinkFilter;</span>
<span class="fc" id="L198">        }</span>
    }

    @VisibleForTesting
    @Inject
    void setObjectFactory(ObjectFactory objectFactory) {
        try {
<span class="fc" id="L205">            this.filters = (Filters) objectFactory.buildBean(Filters.class, getStack().getContext());</span>
<span class="nc" id="L206">        } catch (Exception e) {</span>
<span class="nc" id="L207">            throw new RuntimeException(e);</span>
<span class="fc" id="L208">        }</span>
<span class="fc" id="L209">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>