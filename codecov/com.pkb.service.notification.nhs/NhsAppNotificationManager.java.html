<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NhsAppNotificationManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.notification.nhs</a> &gt; <span class="el_source">NhsAppNotificationManager.java</span></div><h1>NhsAppNotificationManager.java</h1><pre class="source lang-java linenums">package com.pkb.service.notification.nhs;

import com.pkb.app.entity.EHRRequestContext;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.domain.LoginAttemptLogService;
import com.pkb.entities.enums.NationalIdType;
import com.pkb.integration.nhs.model.Issue;
import com.pkb.integration.nhs.model.response.ErrorResponse;
import com.pkb.notification.entity.Activity;
import com.pkb.service.notification.nhs.pubsub.payload.NhsApiNotificationMessage;
import com.pkb.service.notification.nhs.pubsub.payload.NhsApiNotificationTriggerType;
import com.pkb.user.entity.NationalId;
import com.pkb.user.entity.PKBPerson;
import io.vavr.collection.HashMap;
import io.vavr.collection.Map;
import io.vavr.control.Validation;
import org.apache.camel.Consume;
import org.apache.camel.ProducerTemplate;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.invoke.MethodHandles;

import static java.util.Objects.isNull;

public class NhsAppNotificationManager {

<span class="fc" id="L30">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>
    private static final String DEFAULT_MESSAGE = &quot;You have a new Patients Know Best message.&quot;;

    private final LoginAttemptLogService loginAttemptLogService;
    private final NhsAppNotificationSender nhsAppNotificationSender;
    private final ProducerTemplate nhsNotificationProducer;
    private final DateTimeService dateTimeService;
    private final PhrConfig config;

    public NhsAppNotificationManager(LoginAttemptLogService loginAttemptLogService,
                                     NhsAppNotificationSender nhsAppNotificationSender,
                                     ProducerTemplate nhsNotificationProducer,
                                     DateTimeService dateTimeService,
<span class="fc" id="L43">                                     PhrConfig config) {</span>

<span class="fc" id="L45">        this.loginAttemptLogService = loginAttemptLogService;</span>
<span class="fc" id="L46">        this.nhsAppNotificationSender = nhsAppNotificationSender;</span>
<span class="fc" id="L47">        this.nhsNotificationProducer = nhsNotificationProducer;</span>
<span class="fc" id="L48">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L49">        this.config = config;</span>
<span class="fc" id="L50">    }</span>

    public void sendNotification(@NotNull EHRRequestContext requestContext,
            @NotNull PKBPerson person,
            @NotNull NhsApiNotificationTriggerType trigger) {

<span class="fc" id="L56">        sendNotification(requestContext, person, trigger, DEFAULT_MESSAGE);</span>
<span class="fc" id="L57">    }</span>

    public void sendNotification(@NotNull EHRRequestContext requestContext,
            @NotNull PKBPerson person,
            @NotNull NhsApiNotificationTriggerType trigger,
            @NotNull String message) {

<span class="pc bpc" id="L64" title="1 of 2 branches missed.">        if (!config.isNhsAppNotificationEnabled()) {</span>
<span class="nc" id="L65">            return;</span>
        }

        try {
<span class="fc" id="L69">            Validation.combine(validateNationalId(person), validateNhsAppUsage(person))</span>
<span class="fc" id="L70">                    .ap((nationalId, unused) -&gt; {</span>
<span class="fc" id="L71">                        NhsApiNotificationMessage internalMessage = buildInternalMessage(</span>
<span class="fc" id="L72">                                requestContext.getCorrelationId().toString(), nationalId, person.getId(), message, trigger);</span>
<span class="fc" id="L73">                        nhsNotificationProducer.sendBody(internalMessage);</span>
<span class="fc" id="L74">                        return null;</span>
                    });
<span class="nc" id="L76">        } catch (Exception e) {</span>
            // Log and swallow all exceptions - we don't want any calling code to be broken if notification fails
<span class="nc" id="L78">            LOGGER.error(&quot;Unexpected error producing notification message&quot;, e);</span>
<span class="fc" id="L79">        }</span>
<span class="fc" id="L80">    }</span>

    @Consume(NhsNotificationRouteBuilder.PROCESS_NHS_NOTIFICATION)
    public void consumeNotificationMessage(NhsApiNotificationMessage message) {
<span class="fc" id="L84">        nhsAppNotificationSender.sendMessage(message);</span>
<span class="fc" id="L85">    }</span>

    @NotNull
    private NhsApiNotificationMessage buildInternalMessage(
            @NotNull String requestId,
            @NotNull NationalId nhsNumber,
            long patientPrivateId,
            @NotNull String message,
            NhsApiNotificationTriggerType trigger) {

<span class="fc" id="L95">        return NhsApiNotificationMessage.newBuilder()</span>
<span class="fc" id="L96">                .setMessage(message)</span>
<span class="fc" id="L97">                .setNhsNumber(nhsNumber.getValue())</span>
<span class="fc" id="L98">                .setPatientPrivateId(patientPrivateId)</span>
<span class="fc" id="L99">                .setTrigger(trigger)</span>
<span class="fc" id="L100">                .setRequestId(requestId)</span>
<span class="fc" id="L101">                .setCreatedDate(dateTimeService.now().toString())</span>
<span class="fc" id="L102">                .build();</span>
    }

    private Validation&lt;ErrorResponse, NationalId&gt; validateNationalId(PKBPerson person) {
        // Can't proceed without an NHS number
<span class="fc" id="L107">        NationalId nhsNumber = person.getNationalIdAnyTypeValidForSameCountryAsType(NationalIdType.NHS_NUMBER).orElse(null);</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">        if (isNull(nhsNumber)) {</span>
<span class="fc" id="L109">            String error = String.format(&quot;Person %d has no NHS number; cannot send notification&quot;, person.getId());</span>
<span class="fc" id="L110">            return Validation.invalid(ErrorResponse.getResponseError(Issue.of(&quot;no.nhs.number&quot;, error)));</span>
        }

<span class="fc" id="L113">        return Validation.valid(nhsNumber);</span>
    }

    private Validation&lt;ErrorResponse, Void&gt; validateNhsAppUsage(PKBPerson person) {
        // Can't proceed unless user has logged-in via NHS App successfully at least once
<span class="fc bfc" id="L118" title="All 2 branches covered.">        if (!loginAttemptLogService.isPersonNhsAppUser(person.getId())) {</span>
<span class="fc" id="L119">            String error = String.format(&quot;Person %d has no successful NHS App logins; cannot send notification&quot;, person.getId());</span>
<span class="fc" id="L120">            return Validation.invalid(ErrorResponse.getResponseError(Issue.of(&quot;no.nhs.app.logins&quot;, error)));</span>
        }

<span class="fc" id="L123">        return Validation.valid(null);</span>
    }

<span class="fc" id="L126">    public static Map&lt;Activity.Action, NhsApiNotificationTriggerType&gt; ACTIVITY_MAP = HashMap.of(</span>
            Activity.Action.SENT_MESSAGE, NhsApiNotificationTriggerType.NEW_MESSAGE_RECEIVED,
            Activity.Action.CANCELLED_APPOINTMENT, NhsApiNotificationTriggerType.UPDATED_ENCOUNTER
    );
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>