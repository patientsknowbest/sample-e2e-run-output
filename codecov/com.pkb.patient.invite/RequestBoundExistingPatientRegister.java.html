<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RequestBoundExistingPatientRegister.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.patient.invite</a> &gt; <span class="el_source">RequestBoundExistingPatientRegister.java</span></div><h1>RequestBoundExistingPatientRegister.java</h1><pre class="source lang-java linenums">package com.pkb.patient.invite;

import com.pkb.PKBConstants;
import com.pkb.VersionDetails;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.consent.entity.PatientConsent;
import com.pkb.datamodel.Email;
import com.pkb.datamodel.consent.PatientConsentUpdateTemplate;
import com.pkb.entities.enums.AccessingEntityType;
import com.pkb.entities.enums.UserStatus;
import com.pkb.entities.enums.ValidNationalId;
import com.pkb.exception.MailException;
import com.pkb.institute.entity.InstituteUser;
import com.pkb.institute.entity.Team;
import com.pkb.patient.invite.PatientRegister.FailedInvitation;
import com.pkb.patient.invite.PatientRegister.SuccessfulInvitation;
import com.pkb.service.emailmessage.impl.ImmutableEmailInfo;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.patientconsent.DeprecatedPatientConsentManager;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.UserAccessManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.NationalId;
import com.pkb.user.entity.OrgLevelId;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PasswordAccess;
import com.pkb.user.entity.TeamLevelId;
import com.pkb.util.EmailUtil;
import io.vavr.control.Either;
import io.vavr.control.Option;
import org.jetbrains.annotations.NotNull;

import java.time.Instant;
import java.util.Date;
import java.util.Optional;

import static com.pkb.common.base.ErrorBuilder.errorOf;
import static com.pkb.patient.invite.PatientRegister.FailedInvitation.invitingExistingUserWithExistingEmail;
import static com.pkb.patient.invite.PatientRegister.SuccessType.ADDED_TO_TEAM;
import static com.pkb.patient.invite.PatientRegister.SuccessType.ADDED_TO_TEAM_DEFERRED;
import static com.pkb.patient.invite.PatientRegister.SuccessType.ALREADY_IN_TEAM;
import static com.pkb.patient.invite.PatientRegister.SuccessType.INVITED_TO_REGISTER;
import static com.pkb.service.notification.impl.tolven.AccessUpdate.ACCESS_GRANT;
import static com.pkb.util.EmailUtil.Quantity.BULK;
import static com.pkb.util.EmailUtil.Quantity.SINGULAR;
import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.Match;
import static io.vavr.API.None;
import static java.util.Optional.ofNullable;

public class RequestBoundExistingPatientRegister {

    public static final class Parameters {
        private final PKBPerson existingPatient;
        private final PKBPerson inviter;
        private final Team invitingTeam;
        private final PatientConsentUpdateTemplate patientConsent;
        private TeamLevelId teamLevelId;
        private OrgLevelId orgLevelId;

<span class="fc" id="L65">        public Parameters(PKBPerson existingPatient, PKBPerson inviter, Team invitingTeam, PatientConsentUpdateTemplate patientConsent) {</span>
<span class="fc" id="L66">            this.existingPatient = existingPatient;</span>
<span class="fc" id="L67">            this.inviter = inviter;</span>
<span class="fc" id="L68">            this.invitingTeam = invitingTeam;</span>
<span class="fc" id="L69">            this.patientConsent = patientConsent;</span>
<span class="fc" id="L70">        }</span>

        Parameters withTeamLevelId(TeamLevelId teamLevelId) {
<span class="fc" id="L73">            this.teamLevelId = teamLevelId;</span>
<span class="fc" id="L74">            return this;</span>
        }

        public Parameters withOrgLevelId(OrgLevelId orgLevelId) {
<span class="fc" id="L78">            this.orgLevelId = orgLevelId;</span>
<span class="fc" id="L79">            return this;</span>
        }

        PKBPerson getExistingPatient() {
<span class="fc" id="L83">            return existingPatient;</span>
        }

        public PKBPerson getInviter() {
<span class="fc" id="L87">            return inviter;</span>
        }

        public Team getInvitingTeam() {
<span class="fc" id="L91">            return invitingTeam;</span>
        }

        public PatientConsentUpdateTemplate getPatientConsent() {
<span class="nc" id="L95">            return patientConsent;</span>
        }

        Optional&lt;TeamLevelId&gt; findTeamLevelId() {
<span class="fc" id="L99">            return ofNullable(teamLevelId);</span>
        }

        Optional&lt;OrgLevelId&gt; findOrgLevelId() {
<span class="fc" id="L103">            return ofNullable(orgLevelId);</span>
        }
    }

    private final UserManager userManager;

    private final TeamUserManager teamUserManager;
    private final UserAccessManager userAccessManager;

    private final PKBEmailMessageManager pkbEmailMessageManager;

    private final DateTimeService dateTimeService;

    private final PatientConsentManager patientConsentManager;

    private final DeprecatedPatientConsentManager deprecatedPatientConsentManager;


    RequestBoundExistingPatientRegister(
            UserManager userManager,
            TeamUserManager teamUserManager,
            UserAccessManager userAccessManager,
            PKBEmailMessageManager pkbEmailMessageManager,
            DateTimeService dateTimeService,
            PatientConsentManager patientConsentManager,
<span class="fc" id="L128">            DeprecatedPatientConsentManager deprecatedPatientConsentManager) {</span>
<span class="fc" id="L129">        this.userManager = userManager;</span>
<span class="fc" id="L130">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L131">        this.userAccessManager = userAccessManager;</span>
<span class="fc" id="L132">        this.pkbEmailMessageManager = pkbEmailMessageManager;</span>
<span class="fc" id="L133">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L134">        this.patientConsentManager = patientConsentManager;</span>
<span class="fc" id="L135">        this.deprecatedPatientConsentManager = deprecatedPatientConsentManager;</span>
<span class="fc" id="L136">    }</span>

    /**
     * Add a pre-existing patient to a new team. In the normal case where the patient's key is available in KMS,
     * crypto access will be granted immediately to the containing org; otherwise this will be queued for later.
     * If the patient hasn't already registered and an email address is available (existing or new), also attempt
     * to send an invitation/reminder to register.
     */
    Either&lt;FailedInvitation, SuccessfulInvitation&gt; addPatientToTeam(@NotNull LoggedInEHRRequestContext requestContext, InvitationDto invitation,
                                                                       Parameters parameters, EmailUtil.Quantity quantity) {


<span class="fc" id="L148">        PKBPerson existingPatient = parameters.getExistingPatient();</span>
<span class="fc" id="L149">        Team invitingTeam = parameters.getInvitingTeam();</span>
<span class="fc" id="L150">        PKBPerson inviter = parameters.getInviter();</span>

<span class="fc" id="L152">        updateInviteeFromInvitation(requestContext, invitation.getInvitee(), parameters);</span>

<span class="fc" id="L154">        InstituteUser userTeamLink = teamUserManager.getInstituteUser(invitingTeam.getId(), existingPatient.getId());</span>

<span class="fc bfc" id="L156" title="All 4 branches covered.">        boolean patientIsAlreadyMemberOfTeam = userTeamLink != null &amp;&amp; !patientPreviouslyDischarged(existingPatient, invitingTeam);</span>

<span class="fc" id="L158">        teamUserManager.transactional(() -&gt; {</span>
<span class="fc" id="L159">            patientConsentManager.ensureTeamLinkAndUpdatePatientConsent(requestContext, parameters.patientConsent.apply(existingPatient.getId()));</span>

<span class="fc bfc" id="L161" title="All 4 branches covered.">            if (!patientIsAlreadyMemberOfTeam &amp;&amp; parameters.existingPatient.findEmail().isDefined()) {</span>
<span class="fc" id="L162">                pkbEmailMessageManager.sendTeamAccessNotificationToPatient(ACCESS_GRANT,</span>
<span class="fc" id="L163">                        ImmutableEmailInfo.builder()</span>
<span class="fc" id="L164">                                .recipient(existingPatient)</span>
<span class="fc" id="L165">                                .sender(parameters.getInviter())</span>
<span class="pc bpc" id="L166" title="1 of 2 branches missed.">                                .team(invitingTeam)</span>
<span class="fc" id="L167">                                .includeSender(quantity == SINGULAR)</span>
<span class="fc" id="L168">                                .build(),</span>
                        parameters.patientConsent);
            }

<span class="fc" id="L172">        });</span>


<span class="fc bfc" id="L175" title="All 2 branches covered.">        if (userAccessManager.orgHasAccessToPerson(invitingTeam.getOrg().getPublicId(), existingPatient.getId())) {</span>
<span class="fc bfc" id="L176" title="All 4 branches covered.">            if (existingPatient.getStatus() != UserStatus.EMAIL_CONFIRMED &amp;&amp; parameters.existingPatient.findEmail().isDefined()) {</span>
                try {
<span class="fc" id="L178">                    remindNotFullyRegisteredPatients(requestContext, existingPatient, invitingTeam, inviter, quantity);</span>
<span class="fc" id="L179">                } catch (MailException ignored) {</span>
<span class="fc" id="L180">                    return Either.left(invitingExistingUserWithExistingEmail(errorOf(&quot;internally.stored.email.caused.error&quot;,</span>
                            &quot;Unable to send email to the address stored internally for this user, contact PKB to resolve this issue.&quot;)));
<span class="fc" id="L182">                }</span>
<span class="fc" id="L183">                return Either.right(new SuccessfulInvitation(INVITED_TO_REGISTER, existingPatient));</span>
            }
<span class="fc" id="L185">            return Either.right(</span>
<span class="fc bfc" id="L186" title="All 2 branches covered.">                    new SuccessfulInvitation(patientIsAlreadyMemberOfTeam ? ALREADY_IN_TEAM : ADDED_TO_TEAM, existingPatient));</span>
        }

<span class="fc" id="L189">        return Either.right(</span>
                new SuccessfulInvitation(ADDED_TO_TEAM_DEFERRED, existingPatient));
    }

    private boolean patientPreviouslyDischarged(PKBPerson existingPatient, Team invitingTeam) {

<span class="fc" id="L195">        return deprecatedPatientConsentManager.findPatientConsentWithoutReasons(existingPatient.getId(), invitingTeam.getId(), AccessingEntityType.TEAM)</span>
<span class="fc" id="L196">                .map(PatientConsent::isDischarged)</span>
<span class="fc" id="L197">                .orElse(false);</span>
    }


    private void updateInviteeFromInvitation(EHRRequestContext requestContext, InviteeDto invitee, Parameters parameters) {

<span class="fc" id="L203">        PKBPerson existingUser = parameters.getExistingPatient();</span>

<span class="fc" id="L205">        updateNameAddressAndDob(invitee, existingUser);</span>

<span class="fc" id="L207">        invitee.getInviteeIds().findNationalId().ifPresent(nationalId -&gt; {</span>
            // We don't call OrgNetworkManager.syncVerifiedPatientToOrgNetwork here, because
            // it will be done for us in TeamUserManager.createPatientForCoord
<span class="fc" id="L210">            existingUser.addOrUpdateNationalId(requestContext, createNationalId(requestContext, existingUser, nationalId), dateTimeService.now());</span>
<span class="fc" id="L211">        });</span>

<span class="fc" id="L213">        Instant now = dateTimeService.now();</span>
<span class="pc" id="L214">        parameters.findOrgLevelId().ifPresent(oid -&gt; existingUser.addOrgLevelId(requestContext, oid, now));</span>
<span class="pc" id="L215">        parameters.findTeamLevelId().ifPresent(tid -&gt; existingUser.addTeamLevelId(requestContext, tid, now));</span>

<span class="fc" id="L217">        maybeUpdateEmailAddress(invitee, existingUser, now, requestContext);</span>
        try {
<span class="fc" id="L219">            userManager.beginTransaction();</span>
<span class="fc" id="L220">            userManager.updateUser(requestContext, existingUser);</span>
<span class="fc" id="L221">            userManager.commitTransaction();</span>
        } finally {
<span class="fc" id="L223">            userManager.rollbackIfNotCommitted();</span>
        }
<span class="fc" id="L225">    }</span>

    private void updateNameAddressAndDob(InviteeDto invitee, PKBPerson existingUser) {
        // Do not update any email address changes (beyond scope)
<span class="fc" id="L229">        updateName(existingUser, invitee.getName());</span>
<span class="fc" id="L230">        invitee.findAddress().ifPresent(address -&gt; updateAddressPartIfPresent(existingUser, address));</span>
<span class="fc" id="L231">        invitee.findDateOfBirth().ifPresent(dateOfBirth -&gt; existingUser.setDateOfBirthString(PKBConstants.DATE_OF_BIRTH_FORMATTER.format(dateOfBirth)));</span>
<span class="fc" id="L232">    }</span>

    private void remindNotFullyRegisteredPatients(
            @NotNull LoggedInEHRRequestContext requestContext,
            PKBPerson existingPatient,
            Team invitingTeam,
            PKBPerson inviter,
            EmailUtil.Quantity quantity) throws MailException {


<span class="fc" id="L242">        PasswordAccess passwordAccess = userAccessManager</span>
<span class="fc" id="L243">                .getPasswordAccess(existingPatient.getId(), requestContext);</span>
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">        if (passwordAccess == null) {</span>
            // TODO: handle this (old user) more politely
            // There are 298 invited Patient effected in production as of 2016/Jun/01.
<span class="nc" id="L247">            throw new IllegalStateException(&quot;No temporary passwordAccess stored for patient &quot; + existingPatient.getId());</span>
        }
<span class="fc" id="L249">        existingPatient.setPassword(passwordAccess.getPassword());</span>
<span class="fc" id="L250">        PKBPerson creator = Match(quantity).of(</span>
<span class="fc" id="L251">                Case($(SINGULAR), inviter),</span>
<span class="fc" id="L252">                Case($(BULK), (PKBPerson) null));</span>
<span class="fc" id="L253">        pkbEmailMessageManager.notifyPatientOfCreatedAccount(creator, existingPatient, invitingTeam, null);</span>
<span class="fc" id="L254">    }</span>

    // FIXME: does not checks if e-mail is primary, is that ok?

    /**
     * Update email address with newly supplied email, if we don't already have an email address for this patient
     */
    private void maybeUpdateEmailAddress(InviteeDto invitee, PKBPerson existingUser, Instant now, EHRRequestContext requestContext) {
        // TODO: current implementation is missing out on recording a potentially new e-mail for Patient.
<span class="fc" id="L263">        invitee.findEmail()</span>
<span class="fc" id="L264">                .ifPresent(emailInInvitation -&gt; {</span>
<span class="fc bfc" id="L265" title="All 2 branches covered.">                    if (!findAnEmail(existingUser).isDefined()) {</span>
<span class="fc" id="L266">                        existingUser.setPrimaryEmail(emailInInvitation, VersionDetails.of(requestContext, now));</span>
<span class="fc" id="L267">                        existingUser.setStatus(UserStatus.CREATED, now);</span>
                    }
<span class="fc" id="L269">                });</span>
<span class="fc" id="L270">    }</span>

    private Option&lt;Email&gt; findAnEmail(PKBPerson existingUser) {
<span class="fc bfc" id="L273" title="All 2 branches covered.">        for (var personContact : existingUser.getContacts()) {</span>
<span class="fc" id="L274">            var email = personContact.getContactIfEmail();</span>
<span class="fc bfc" id="L275" title="All 2 branches covered.">            if (email.isDefined()) {</span>
<span class="fc" id="L276">                return email;</span>
            }
<span class="fc" id="L278">        }</span>
<span class="fc" id="L279">        return None();</span>
    }

    private NationalId createNationalId(EHRRequestContext requestContext, PKBPerson existingUser, ValidNationalId nid) {
<span class="fc" id="L283">        NationalId nationalId = new NationalId(nid, VersionDetails.of(requestContext, dateTimeService.now()));</span>
<span class="fc" id="L284">        nationalId.setPerson(existingUser);</span>
<span class="fc" id="L285">        nationalId.setEditDate(Date.from(dateTimeService.now()));</span>
<span class="fc" id="L286">        return nationalId;</span>
    }

    private void updateAddressPartIfPresent(PKBPerson invitee, AddressDto address) {
<span class="fc" id="L290">        address.findAddressPartOne().ifPresent(invitee::setAddress1);</span>
<span class="fc" id="L291">        address.findAddressPartTwo().ifPresent(invitee::setAddress2);</span>
<span class="fc" id="L292">        address.findCity().ifPresent(invitee::setCity);</span>
<span class="fc" id="L293">        address.findCounty().ifPresent(invitee::setState);</span>
<span class="fc" id="L294">        address.findPostCode().ifPresent(invitee::setPostalCode);</span>
<span class="fc" id="L295">    }</span>

    private void updateName(PKBPerson invitee, NameDto name) {
<span class="fc" id="L298">        name.findTitle().ifPresent(invitee::setTitle);</span>
<span class="fc" id="L299">        invitee.setFirstName(name.getFirstName());</span>
<span class="fc" id="L300">        invitee.setLastName(name.getLastName());</span>
<span class="fc" id="L301">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>