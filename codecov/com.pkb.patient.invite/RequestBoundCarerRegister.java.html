<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RequestBoundCarerRegister.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.patient.invite</a> &gt; <span class="el_source">RequestBoundCarerRegister.java</span></div><h1>RequestBoundCarerRegister.java</h1><pre class="source lang-java linenums">package com.pkb.patient.invite;

import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.bean.IUserBean;
import com.pkb.common.base.Error;
import com.pkb.datamodel.Email;
import com.pkb.entities.enums.PrivacyFlag;
import com.pkb.entities.enums.UserStatus;
import com.pkb.entities.enums.UserType;
import com.pkb.institute.entity.Team;
import com.pkb.service.invitation.impl.InvitationManager;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PersonContact;
import io.vavr.control.Option;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;

import java.lang.invoke.MethodHandles;
import java.util.ArrayList;
import java.util.EnumSet;
import java.util.List;

import static com.pkb.common.base.ErrorBuilder.error;
import static com.pkb.common.base.ErrorBuilder.errorOf;
import static java.util.Collections.singletonList;
import static org.slf4j.LoggerFactory.getLogger;

public class RequestBoundCarerRegister {
<span class="fc" id="L32">    private static final Logger LOGGER = getLogger(MethodHandles.lookup().lookupClass());</span>

    private static final String PATIENT_AND_CARER_EMAIL_IS_SAME_CODE = &quot;patient.bulk.invite.patient.and.carer.email.is.same&quot;;
    private static final String PATIENT_AND_CARER_EMAIL_IS_SAME = &quot;Inviting the patient '%s' as own carer&quot;;
    private static final String CARER_IS_NOT_A_PATIENT_CODE = &quot;patient.bulk.invite.patient.carer.is.not.a.patient&quot;;
    private static final String CARER_IS_NOT_A_PATIENT = &quot;Invited carer '%s' is not a patient&quot;;
    private static final String GENERAL_ERROR_CODE = &quot;patient.bulk.invite.patient.general.error&quot;;
    private static final String GENERAL_ERROR = &quot;Unexpected error happened: %s&quot;;

    private final UserManager userManager;
    private final InvitationManager invitationManager;
    private final IUserBean userWebBean;
    private final PatientConsentManager patientConsentManager;

    RequestBoundCarerRegister(
            UserManager userManager,
            InvitationManager invitationManager,
            IUserBean userWebBean,
<span class="fc" id="L50">            PatientConsentManager patientConsentManager) {</span>
<span class="fc" id="L51">        this.userManager = userManager;</span>
<span class="fc" id="L52">        this.invitationManager = invitationManager;</span>
<span class="fc" id="L53">        this.userWebBean = userWebBean;</span>
<span class="fc" id="L54">        this.patientConsentManager = patientConsentManager;</span>
<span class="fc" id="L55">    }</span>

    List&lt;Error&gt; registerCarer(
            @NotNull CarerDto carer,
            @NotNull PKBPerson patient,
            @NotNull LoggedInEHRRequestContext requestContext,
            @NotNull PKBPerson coordinator,
            @NotNull Team invitingTeam) {
        try {
<span class="fc" id="L64">            return attemptToInviteCarer(</span>
                    patient,
                    carer,
                    requestContext,
                    coordinator,
                    invitingTeam);
<span class="nc" id="L70">        } catch (Exception cause) {</span>
<span class="nc" id="L71">            LOGGER.error(&quot;Failed to invite carer for Patient with ID='{}', Because: &quot;, patient.getId(), cause);</span>
<span class="nc" id="L72">            return singletonList(error(GENERAL_ERROR_CODE, GENERAL_ERROR).withArguments(cause.getMessage()).build());</span>
        }
    }

    private List&lt;Error&gt; attemptToInviteCarer(
            PKBPerson patient,
            @NotNull CarerDto carerToBeInvited,
            LoggedInEHRRequestContext requestContext,
            PKBPerson coordinator,
            @NotNull Team invitingTeam) {

<span class="fc" id="L83">        List&lt;Error&gt; errors = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L85">        var maybeCarerEmail = carerToBeInvited.findEmail();</span>
<span class="pc bpc" id="L86" title="3 of 4 branches missed.">        if (maybeCarerEmail.equals(patient.findEmail()) &amp;&amp; maybeCarerEmail.isDefined()) {</span>
<span class="nc" id="L87">            errors.add(errorOf(PATIENT_AND_CARER_EMAIL_IS_SAME_CODE, PATIENT_AND_CARER_EMAIL_IS_SAME, maybeCarerEmail.map(Email::address).getOrNull()));</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">        } else if (!invitationManager.invitedAlready(maybeCarerEmail, userManager.getDefaultAccountId(patient.getId()))) {</span>

<span class="fc" id="L90">            PKBPerson carer = findOrCreateCarer(patient, carerToBeInvited, requestContext);</span>

<span class="pc bpc" id="L92" title="1 of 2 branches missed.">            if (!carer.isPatient()) {</span>
<span class="nc" id="L93">                errors.add(errorOf(CARER_IS_NOT_A_PATIENT_CODE, CARER_IS_NOT_A_PATIENT, maybeCarerEmail.map(Email::address).getOrNull()));</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">            } else if (!hasAccountAccess(carer, patient)) {</span>

                // Carer should get general consent + team's default privacy flags
                // i.e. the carer should access everything that the current team will add to the patient's record,
                // plus general health data.
                // https://pkbdev.atlassian.net/browse/PHR-6425
<span class="fc" id="L100">                EnumSet&lt;PrivacyFlag&gt; consents = EnumSet.of(PrivacyFlag.GENERAL, invitingTeam.getPrivacyFlags().getPrivacyFlags().toArray(new PrivacyFlag[0]));</span>
<span class="fc" id="L101">                userWebBean.inviteCarerForPatient(requestContext, patient, coordinator, carer, consents, &quot;&quot;);</span>
            } // already have access.
        } // invited already.

<span class="fc" id="L105">        return errors;</span>
    }

    private PKBPerson findOrCreateCarer(PKBPerson patient, CarerDto carerToBeInvited, EHRRequestContext requestContext) {
<span class="fc" id="L109">        Email carerEmail = carerToBeInvited.getEmail();</span>
<span class="fc" id="L110">        return Option.of(userManager.getSinglePersonByEmail(carerEmail, PersonContact.Lazy.PERSON_W_CONTACTS))</span>
<span class="fc" id="L111">                .getOrElse(() -&gt;</span>
                {
<span class="fc" id="L113">                    var carer = userWebBean.populateInvitee(requestContext, carerToBeInvited.getFirstName(), carerToBeInvited.getLastName(), carerEmail, &quot;&quot;, patient.getLanguageCode());</span>
<span class="fc" id="L114">                    carer.setUserType(UserType.PATIENT);</span>
<span class="fc" id="L115">                    return carer;</span>
                });
    }

    private boolean hasAccountAccess(
            PKBPerson invitee,
            PKBPerson patient) {
<span class="fc bfc" id="L122" title="All 2 branches covered.">        return invitee.getStatus() == UserStatus.EMAIL_CONFIRMED &amp;&amp;</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">                patient.isPatient() &amp;&amp;</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">                invitee.getId() != null &amp;&amp;</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">                patientConsentManager.hasIndividualAccessToUser(invitee.getId(), patient.getId());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>