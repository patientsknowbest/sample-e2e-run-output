<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ValidationExceptionMappingInterceptor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.interceptor</a> &gt; <span class="el_source">ValidationExceptionMappingInterceptor.java</span></div><h1>ValidationExceptionMappingInterceptor.java</h1><pre class="source lang-java linenums">package com.pkb.interceptor;

import com.opensymphony.xwork2.ActionInvocation;
import com.opensymphony.xwork2.ActionSupport;
import com.opensymphony.xwork2.interceptor.MethodFilterInterceptor;
import com.pkb.common.base.Error;
import com.pkb.common.config.PhrConfig;
import com.pkb.exception.ValidationException;
import org.slf4j.Logger;

import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.function.Function;

import static com.opensymphony.xwork2.Action.INPUT;
import static com.opensymphony.xwork2.util.TextParseUtil.commaDelimitedStringToSet;
import static com.pkb.util.TextParserUtil.keyValuesPairStringsToMap;
import static java.lang.invoke.MethodHandles.lookup;
import static java.util.Collections.emptyMap;
import static java.util.Collections.emptySet;
import static org.apache.commons.lang3.StringUtils.isBlank;
import static org.apache.commons.lang3.StringUtils.isNotBlank;
import static org.slf4j.LoggerFactory.getLogger;

/**
 * &lt;pre&gt;
 * =======
 * /**
 * &lt;pre&gt;
 *
 * import java.util.Map;
 * import java.util.Set;
 * import java.util.function.Function;
 *
 * import static com.opensymphony.xwork2.Action.INPUT;
 * import static com.opensymphony.xwork2.util.TextParseUtil.commaDelimitedStringToSet;
 * import static com.pkb.util.TextParserUtil.keyValuesPairStringsToMap;
 * import static java.lang.invoke.MethodHandles.lookup;
 * import static java.util.Collections.emptyMap;
 * import static java.util.Collections.emptySet;
 * import static org.apache.commons.lang3.StringUtils.isBlank;
 * import static org.apache.commons.lang3.StringUtils.isNotBlank;
 * import static org.slf4j.LoggerFactory.getLogger;
 *
 * /**
 * &lt;pre&gt;
 * Configurable {@link ValidationException} mapping interceptor.
 * {@code
 *
 * &lt;package name=&quot;patientActivation&quot; extends=&quot;registration&quot; namespace=&quot;/activate&quot; strict-method-invocation=&quot;true&quot;&gt;
 *   &lt;interceptors&gt;
 *     &lt;interceptor name=&quot;exceptionMapper&quot; class=&quot;com.pkb.interceptor.ValidationExceptionMappingInterceptor&quot;/&gt;
 *     // ...
 *
 *       &lt;interceptor-ref name=&quot;exceptionMapper&quot;&gt;
 *         &lt;!--
 *         Can be emitted. Use when action error level issue should select a different result then what is set for fieldErrorResult.
 *         When left empty will be defaulting to value of fieldErrorResult
 *         --&gt;
 *         &lt;param name=&quot;actionErrorResult&quot;&gt;activationError&lt;/param&gt;
 *         &lt;!-- can be emitted. it defaults to input anyway. --&gt;
 *         &lt;param name=&quot;fieldErrorResult&quot;&gt;input&lt;/param&gt;
 *         &lt;param name=&quot;actionErrors&quot;&gt;invitation.patient.usertype,invitation.patient.status,invitation.patient.identifier,invitation.patient.systemId&lt;/param&gt;
 *         &lt;param name=&quot;errorCodeToFieldErrorMapping&quot;&gt;invitation.patient.dob:activationDetails.dateOfBirth&lt;/param&gt;
 *       &lt;/interceptor-ref&gt;
 *     &lt;/interceptor-stack&gt;
 *   &lt;/interceptors&gt;
 *   // ...
 * &lt;/package&gt;
 * }
 * &lt;/pre&gt;
 */
public class ValidationExceptionMappingInterceptor extends MethodFilterInterceptor {
<span class="fc" id="L76">    private static final Logger LOGGER = getLogger(lookup().lookupClass());</span>

    private static final String CANNOT_HANDLE = &quot;Caught {} but action=[{}] does not implement {} interface, therefore exception cannot not be handled here.&quot;;
    private static final String KEY_VALUE_SEPARATOR = &quot;:&quot;;

    private final PhrConfig config;

<span class="fc" id="L83">    private Map&lt;String, String&gt; errorCodeToFieldErrorMapping = emptyMap();</span>
<span class="fc" id="L84">    private Set&lt;String&gt; actionErrors = emptySet();</span>
<span class="fc" id="L85">    private Set&lt;String&gt; nonDefaultActionErrors = emptySet();</span>

    /**
     * determines what view will be selected when an action level error is detected.
     */
    private String actionErrorResult;
    /**
     * determines what view will be selected when only field level error is detected
     */
<span class="fc" id="L94">    private String fieldErrorResult = INPUT;</span>
    /**
     * determines what view will be selected when an unexpected exception occurs (or when there is a mismatch between actual and mapped errors in ValidationException.
     */
    private String globalErrorResult;

<span class="fc" id="L100">    public ValidationExceptionMappingInterceptor(PhrConfig config) {</span>
<span class="fc" id="L101">        this.config = config;</span>
<span class="fc" id="L102">    }</span>

    @Override
    protected boolean applyInterceptor(ActionInvocation invocation) {
<span class="pc bpc" id="L106" title="1 of 2 branches missed.">        if (isBlank(globalErrorResult)) {</span>
<span class="nc" id="L107">            LOGGER.error(&quot;{} is not configured properly (globalErrorResult is not set).&quot;, ValidationExceptionMappingInterceptor.class.getSimpleName());</span>
        }
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">        if (isBlank(fieldErrorResult)) {</span>
<span class="nc" id="L110">            LOGGER.error(&quot;{} is not configured properly (fieldErrorResult is unset).&quot;, ValidationExceptionMappingInterceptor.class.getSimpleName());</span>
        }
<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (isBlank(actionErrorResult)) {</span>
<span class="fc" id="L113">            actionErrorResult = fieldErrorResult;</span>
        }
<span class="pc bpc" id="L115" title="2 of 4 branches missed.">        return isNotBlank(globalErrorResult) &amp;&amp; isNotBlank(fieldErrorResult);</span>
    }

    @Override
    protected String doIntercept(ActionInvocation invocation) throws Exception {
        try {
<span class="fc" id="L121">            return invocation.invoke();</span>
<span class="fc" id="L122">        } catch (ValidationException cause) {</span>
<span class="fc" id="L123">            return process(invocation, cause, (action) -&gt; processValidationException(cause, action));</span>
<span class="nc" id="L124">        } catch (Exception cause) {</span>
<span class="nc" id="L125">            return process(invocation, cause, (action) -&gt; processGenericExceptions(cause, action));</span>
        }
    }

    public void setGlobalErrorResult(String globalErrorResult) {
<span class="fc" id="L130">        this.globalErrorResult = globalErrorResult;</span>
<span class="fc" id="L131">    }</span>

    public void setActionErrorResult(String actionErrorResult) {
<span class="fc" id="L134">        this.actionErrorResult = actionErrorResult;</span>
<span class="fc" id="L135">    }</span>

    public void setFieldErrorResult(String fieldErrorResult) {
<span class="nc" id="L138">        this.fieldErrorResult = fieldErrorResult;</span>
<span class="nc" id="L139">    }</span>

    public void setActionErrors(String configuration) {
<span class="fc" id="L142">        this.actionErrors = commaDelimitedStringToSet(configuration);</span>
<span class="fc" id="L143">    }</span>

    public void setNonDefaultActionErrors(String configuration) {
<span class="fc" id="L146">        this.nonDefaultActionErrors = commaDelimitedStringToSet(configuration);</span>
<span class="fc" id="L147">    }</span>

    public void setErrorCodeToFieldErrorMapping(String configuration) {
<span class="fc" id="L150">        this.errorCodeToFieldErrorMapping = keyValuesPairStringsToMap(commaDelimitedStringToSet(configuration), KEY_VALUE_SEPARATOR);</span>
<span class="fc" id="L151">    }</span>

    // ========== Helper methods below. ==========

    private &lt;T extends Throwable&gt; String process(ActionInvocation invocation, T exception, Function&lt;ActionSupport, String&gt; resultMapper) {
        String result;

<span class="fc" id="L158">        Object action = invocation.getAction();</span>
<span class="pc bpc" id="L159" title="1 of 2 branches missed.">        if (ActionSupport.class.isInstance(action)) {</span>
<span class="fc" id="L160">            result = resultMapper.apply(ActionSupport.class.cast(action));</span>
        } else {
<span class="nc" id="L162">            LOGGER.error(CANNOT_HANDLE, exception.getClass().getSimpleName(), action.getClass().getSimpleName(), ActionSupport.class.getSimpleName());</span>
            // We can't do anything better than displaying an empty error screen.
<span class="nc" id="L164">            result = globalErrorResult;</span>
        }

<span class="fc" id="L167">        return result;</span>
    }

    /**
     * &lt;pre&gt;
     * 1. Finding validation errors that are classified as action error should result in displaying the form with action error.
     * 2. Finding only field errors should result in display form with field errors.
     * 3. Failing to categorize errors is an app error (bug) and should result in displaying configured error result.
     * &lt;/pre&gt;
     */
    private String processValidationException(ValidationException validationException, ActionSupport action) {
<span class="fc" id="L178">        String result = fieldErrorResult;</span>

<span class="fc" id="L180">        collectAndAddActionErrors(validationException.getErrors(), action);</span>
<span class="fc bfc" id="L181" title="All 2 branches covered.">        if (action.getActionErrors().isEmpty()) {</span>
<span class="fc" id="L182">            collectAndAddFieldErrors(validationException.getErrors(), action);</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">            if (action.getFieldErrors().isEmpty()) {</span>
<span class="nc" id="L184">                LOGGER.error(buildUnmappedErrorsMessage(validationException.getErrors()));</span>
                //noinspection StrutsI18nError,SSBasedInspection
<span class="nc" id="L186">                action.addActionError(action.getText(&quot;unmapped.field.validation&quot;));</span>
<span class="nc" id="L187">                result = globalErrorResult;</span>
            }
        } else {
<span class="fc" id="L190">            LOGGER.info(&quot;Validation errors were caught that User cannot do anything about.&quot;);</span>
<span class="fc" id="L191">            result = actionErrorResult;</span>
        }

<span class="fc" id="L194">        return result;</span>
    }

    private String processGenericExceptions(Throwable throwable, ActionSupport actionSupport) {
<span class="nc" id="L198">        LOGGER.error(&quot;Other than validation exception occurred: &quot;, throwable);</span>
        //noinspection StrutsI18nError,SSBasedInspection
<span class="nc" id="L200">        actionSupport.addActionError(actionSupport.getText(&quot;unexpected.exception.for.not.logged.in.user&quot;));</span>
<span class="nc" id="L201">        return globalErrorResult;</span>
    }

    private void collectAndAddActionErrors(List&lt;Error&gt; errors, ActionSupport action) {
<span class="fc" id="L205">        Set&lt;String&gt; actionErrors = new HashSet&lt;&gt;(this.actionErrors);</span>
<span class="fc bfc" id="L206" title="All 2 branches covered.">        if (!config.isDefaultTokenRegistrationErrorMessages()) {</span>
<span class="fc" id="L207">            actionErrors.addAll(this.nonDefaultActionErrors);</span>
        }

        //noinspection StrutsI18nError,SSBasedInspection
<span class="fc" id="L211">        errors.stream()</span>
<span class="fc" id="L212">                .map(Error::getErrorCode)</span>
<span class="fc" id="L213">                .filter(actionErrors::contains)</span>
<span class="fc" id="L214">                .forEach(errorCode -&gt; action.addActionError(action.getText(errorCode)));</span>
<span class="fc" id="L215">    }</span>

    private void collectAndAddFieldErrors(List&lt;Error&gt; errors, ActionSupport action) {
        //noinspection StrutsI18nError,SSBasedInspection
<span class="fc" id="L219">        errors.stream()</span>
<span class="fc" id="L220">                .filter(error -&gt; errorCodeToFieldErrorMapping.containsKey(error.getErrorCode()))</span>
<span class="fc" id="L221">                .forEach(error -&gt; action.addFieldError(errorCodeToFieldErrorMapping.get(error.getErrorCode()), action.getText(error.getErrorCode())));</span>
<span class="fc" id="L222">    }</span>

    private String buildUnmappedErrorsMessage(List&lt;Error&gt; errors) {
<span class="nc" id="L225">        StringBuilder message = new StringBuilder()</span>
<span class="nc bnc" id="L226" title="All 2 branches missed.">                .append(&quot;There &quot;).append(errors.size() &gt; 1 ? &quot;are &quot; : &quot;is &quot;).append(errors.size())</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">                .append(&quot; unmapped validation error&quot;).append(errors.size() &gt; 1 ? &quot;s&quot; : &quot;&quot;).append(&quot;:\n&quot;);</span>
<span class="nc" id="L228">        errors.forEach(error -&gt; message.append(&quot;errorCode=[&quot;).append(error.getErrorCode()).append(&quot;], description=[&quot;).append(error.getDescription()).append(&quot;]\n&quot;));</span>
<span class="nc" id="L229">        return message.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>