<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContextUserInterceptor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.interceptor</a> &gt; <span class="el_source">ContextUserInterceptor.java</span></div><h1>ContextUserInterceptor.java</h1><pre class="source lang-java linenums">package com.pkb.interceptor;

import com.google.common.primitives.Longs;
import com.opensymphony.xwork2.ActionContext;
import com.opensymphony.xwork2.ActionInvocation;
import com.opensymphony.xwork2.interceptor.MethodFilterInterceptor;
import com.pkb.datamodel.Email;
import com.pkb.entities.enums.NationalIdType;
import com.pkb.entities.enums.UserType;
import com.pkb.entities.enums.ValidNationalId;
import com.pkb.exception.DisplayableException;
import com.pkb.exception.DisplayableException.DisplayAs;
import com.pkb.exception.PKBException;
import com.pkb.service.user.impl.PersonContactManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.util.ContextUserUtil;
import com.pkb.util.LoggedInUserUtil;
import com.pkb.util.PersonAmbiguityHandler;
import org.apache.struts2.ServletActionContext;
import org.apache.struts2.StrutsStatics;
import org.apache.struts2.dispatcher.HttpParameters;
import org.jetbrains.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.MDC;
import org.springframework.beans.factory.annotation.Autowired;

import javax.servlet.http.HttpServletRequest;
import java.util.Objects;
import java.util.Optional;
import java.util.stream.Stream;

import static com.pkb.datamodel.ImmutableDisclosingEmail.disclosingEmail;
import static org.apache.commons.lang3.StringUtils.isBlank;
import static org.apache.commons.lang3.StringUtils.isNotBlank;

//---------------------------------------------------------------------------
//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: ContextUserInterceptor.java 22-Sep-2014 12:20:56 pm pravina$
//
//---------------------------------------------------------------------------

/**
 * Sets the contextUserId in the session, based on either a supplied
 * contextUserId or contextUserEmail parameter. If clearContext is set instead,
 * the context is cleared.
 *
 * @author pravina
 */
@SuppressWarnings(&quot;InstanceofCatchParameter&quot;)
<span class="fc" id="L54">public class ContextUserInterceptor extends MethodFilterInterceptor {</span>

    private static final long serialVersionUID = 442796023853625912L;

    private static final String CONTEXT_USER_MDC_KEY = &quot;contextUserId&quot;;

    public static final String LINK_UID = &quot;linkUid&quot;;
    public static final String CONTEXT_USER_ID = &quot;contextUserId&quot;;
    public static final String CONTEXT_USER_EMAIL = &quot;contextUserEmail&quot;;
    public static final String CONTEXT_USER_PNID = &quot;pnid&quot;;
    public static final String CONTEXT_USER_PNIDCC = &quot;pnidcc&quot;;

    public static final String CLEAR_CONTEXT = &quot;clearContext&quot;;

<span class="fc" id="L68">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    @Autowired
    private ContextUserUtil contextUserUtil;

    @Autowired
    private PersonContactManager personContactManager;

    @Autowired
    private UserManager userManager;

    @Autowired
    private LoggedInUserUtil loggedInUserUtil;

    @Override
    public String doIntercept(ActionInvocation invocation) throws Exception {
<span class="fc" id="L84">        ActionContext ac = invocation.getInvocationContext();</span>

<span class="fc" id="L86">        HttpParameters params = ac.getParameters();</span>

<span class="fc" id="L88">        String linkUid = params.get(LINK_UID).getValue();</span>
<span class="fc" id="L89">        String contextUserIdString = params.get(CONTEXT_USER_ID).getValue();</span>
<span class="fc" id="L90">        String contextUserNationalId = params.get(CONTEXT_USER_PNID).getValue();</span>
<span class="fc" id="L91">        String contextUserNationalIdCountryCode = params.get(CONTEXT_USER_PNIDCC).getValue();</span>

        Email contextUserEmail;
<span class="fc" id="L94">        String emailString = params.get(CONTEXT_USER_EMAIL).getValue();</span>
        try {
<span class="fc bfc" id="L96" title="All 2 branches covered.">            contextUserEmail = params.get(CONTEXT_USER_EMAIL).getValue() == null ? null : disclosingEmail(emailString);</span>
<span class="fc" id="L97">        } catch (Exception ignored) {</span>
<span class="fc" id="L98">            throw contextError(&quot;global.err.invalid_email&quot;,emailString);</span>
<span class="fc" id="L99">        }</span>

<span class="pc bpc" id="L101" title="1 of 8 branches missed.">        if (isBlank(contextUserIdString) &amp;&amp; contextUserEmail == null &amp;&amp; isBlank(contextUserNationalId) &amp;&amp; isBlank(contextUserNationalIdCountryCode)) {</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">            if (isBlank(linkUid)) {</span>
<span class="fc" id="L103">                contextUserIdString = ServletActionContext.getRequest().getHeader(CONTEXT_USER_ID);</span>
            } else {
<span class="fc" id="L105">                contextUserIdString = linkUid;</span>
            }
        }

<span class="fc" id="L109">        Long contextUserId = Optional.ofNullable(contextUserIdString).map(Longs::tryParse).orElse(null);</span>

<span class="fc bfc" id="L111" title="All 4 branches covered.">        if (clearingContextExplicitlyRequested(params) || aboutToSeePageForSelf(ac, contextUserId)) {</span>
<span class="fc" id="L112">            contextUserUtil.clearContextUser();</span>
        }

<span class="fc bfc" id="L115" title="All 2 branches covered.">        if (contextUserId == null) {</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">            if (contextUserEmail != null) {</span>

<span class="fc" id="L118">                contextUserId = personContactManager.getPersonForConfirmedOrPrimaryPatientContact(contextUserEmail)</span>
<span class="fc" id="L119">                        .map(cp -&gt; {</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">                                    if (cp.getUserType() == UserType.PATIENT) {</span>
<span class="fc" id="L121">                                        return cp.getId();</span>
                                    } else {
<span class="fc" id="L123">                                        throw contextError(&quot;global.err.email_not_patient&quot;, contextUserEmail.address());</span>
                                    }
                                }
<span class="fc" id="L126">                        ).getOrElseThrow(() -&gt; contextError(&quot;global.err.unknown_email&quot;,contextUserEmail.address()));</span>

<span class="fc bfc" id="L128" title="All 2 branches covered.">            } else if (isNotBlank(contextUserNationalId)) {</span>

<span class="fc bfc" id="L130" title="All 2 branches covered.">                if (isBlank(contextUserNationalIdCountryCode)) {</span>
<span class="fc" id="L131">                    throw contextError(&quot;global.err.national_id_without_country_code&quot;,contextUserNationalId);</span>
                }

<span class="fc" id="L134">                NationalIdType validNationalIdType = NationalIdType.getPrimaryNationalIdTypeFromCountryCode(contextUserNationalIdCountryCode)</span>
<span class="fc" id="L135">                        .orElseThrow(() -&gt; contextError(&quot;global.err.unsupported_country_code&quot;, contextUserNationalIdCountryCode));</span>

<span class="fc" id="L137">                ValidNationalId validNationalId = validNationalIdType.getValidNationalIdAndType(contextUserNationalId)</span>
<span class="fc" id="L138">                        .orElseThrow(() -&gt; contextError(&quot;global.err.invalid_national_id&quot;, contextUserNationalId));</span>

<span class="fc" id="L140">                contextUserId  = PersonAmbiguityHandler.getMaybePersonOrNone(userManager.getPKBPersonByNationalId(validNationalId), &quot;nationalId&quot;)</span>
<span class="fc" id="L141">                     .map(PKBPerson::getId).getOrElseThrow(() -&gt; contextError(&quot;global.err.unknown_patient&quot;,contextUserNationalId));</span>

            }

        }

<span class="fc bfc" id="L147" title="All 2 branches covered.">        if (contextUserId != null) {</span>
<span class="fc" id="L148">            setContextUserId(contextUserId);</span>
<span class="fc" id="L149">            MDC.put(CONTEXT_USER_MDC_KEY, Long.toString(contextUserId));</span>
        }

        try {
<span class="fc" id="L153">            return invocation.invoke();</span>
        } finally {
<span class="fc" id="L155">            MDC.remove(CONTEXT_USER_MDC_KEY);</span>
        }
    }

    private DisplayableException contextError(String template,String id) {
<span class="fc" id="L160">        contextUserUtil.clearContextUser();</span>
<span class="fc" id="L161">        return new DisplayableException(template, new String[]{id}, DisplayAs.error);</span>
    }

    private boolean clearingContextExplicitlyRequested(HttpParameters params) {
<span class="fc" id="L165">        String clearContext = params.get(CLEAR_CONTEXT).getValue();</span>
<span class="pc bpc" id="L166" title="1 of 4 branches missed.">        return isNotBlank(clearContext) &amp;&amp; clearContext.equals(Boolean.TRUE.toString());</span>
    }

    /**
     * &lt;pre&gt;
     * Since {@code contextUserId} query parameter is not applied accross all screens
     * where Team Pro is looking at a Patient's Medical Data, we don't have a reliable way
     * to determine that User is looking a screen that is related with their own data or given Patient.
     * Until https://pkbdev.atlassian.net/browse/PHR-3865 is complete, we don't have
     * better alternative than to black list urls.
     * &lt;/pre&gt;
     * &lt;p&gt;
     * // FIXME: remove guessing part once above mentioned ticket is done.
     */
    private boolean aboutToSeePageForSelf(ActionContext ac, @Nullable Long contextUserId) {
<span class="fc bfc" id="L181" title="All 6 branches covered.">        return userIsAProfessional() &amp;&amp; (byId(contextUserId) || byGuess(ac));</span>
    }

    private boolean userIsAProfessional() {
<span class="fc bfc" id="L185" title="All 4 branches covered.">        return loggedInUserUtil.isUserLoggedIn() &amp;&amp; loggedInUserUtil.isLoggedInUserProfessional();</span>
    }

    private boolean byId(@Nullable Long contextUserId) {
<span class="fc" id="L189">        return Objects.equals(loggedInUserUtil.getLoggedInUserId(), contextUserId);</span>
    }

    private boolean byGuess(ActionContext ac) {
<span class="fc" id="L193">        String requestURI = ((HttpServletRequest) ac.get(StrutsStatics.HTTP_REQUEST)).getRequestURI();</span>
<span class="fc" id="L194">        return Stream.of(&quot;dashboard.action&quot;, &quot;myPatients.action&quot;, &quot;createPatientForm.action&quot;).anyMatch(requestURI::contains);</span>
    }

    private void setContextUserId(long contextUserId) {
        try {
<span class="fc" id="L199">            Long contextUserIdExisting = contextUserUtil.getContextUserId();</span>
<span class="fc bfc" id="L200" title="All 4 branches covered.">            if (contextUserIdExisting == null || !contextUserIdExisting.equals(contextUserId)) {</span>
<span class="pc bpc" id="L201" title="1 of 4 branches missed.">                if (loggedInUserUtil.isUserLoggedIn() &amp;&amp; loggedInUserUtil.getLoggedInUserId() == contextUserId) {</span>
                    // contextUserId is the same as logged in user, so clear
                    // the context
<span class="fc" id="L204">                    contextUserUtil.clearContextUser();</span>
                } else {
                    // contextUserId is not currently set, and is not the
                    // logged in user, so set it
<span class="fc" id="L208">                    contextUserUtil.setContextUserInSession(contextUserId);</span>
                }
            }
<span class="fc" id="L211">        } catch (PKBException e) {</span>
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">            if (e instanceof DisplayableException) {</span>
<span class="fc" id="L213">                LOGGER.info(&quot;Exception while setting user {} in session (displayable reason)&quot;, contextUserId, e);</span>
<span class="fc" id="L214">                throw e;</span>
            } else {
<span class="nc" id="L216">                LOGGER.error(&quot;Exception while setting user {} in session (unexpected)&quot;, contextUserId, e);</span>
<span class="nc" id="L217">                throw new DisplayableException(&quot;global.err.fail_open_record_unexpected&quot;, DisplayAs.error);</span>
            }
<span class="fc" id="L219">        }</span>
<span class="fc" id="L220">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>