<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>V2MeasurementService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.v2</a> &gt; <span class="el_source">V2MeasurementService.java</span></div><h1>V2MeasurementService.java</h1><pre class="source lang-java linenums">package com.pkb.api.v2;

import com.pkb.api.aspect.annotation.RequiresScope;
import com.pkb.api.aspect.annotation.Timed;
import com.pkb.api.error.ApiValidationError;
import com.pkb.api.util.MeasurementApiHelper;
import com.pkb.api.util.PKBCommonApiParams;
import com.pkb.api.util.v2.RestUtil;
import com.pkb.api.v1.model.ApiMeasurementType;
import com.pkb.api.v1.model.ApiReadResponse;
import com.pkb.api.v1.model.ApiWriteResponse;
import com.pkb.api.v1.model.ApiWriteResponse.OperationEnum;
import com.pkb.api.v2.model.V2ApiMeasurement;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.service.test.MeasurementManager;
import com.pkb.test.entity.MeasurementDTO;
import com.pkb.test.entity.PredefinedMeasurementType;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiParam;
import io.swagger.annotations.Authorization;
import io.swagger.annotations.AuthorizationScope;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import javax.ws.rs.Consumes;
import javax.ws.rs.GET;
import javax.ws.rs.HeaderParam;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

import static com.pkb.api.util.PKBApiHelper.buildReadResponse;
import static com.pkb.entities.enums.api.ApiClientScope.CLINICIAN;
import static com.pkb.entities.enums.api.ApiClientScope.PATIENT;
import static com.pkb.entities.enums.api.ApiClientScope.PUBLIC;
import static javax.ws.rs.core.Response.Status.BAD_REQUEST;
import static javax.ws.rs.core.Response.Status.CREATED;
import static javax.ws.rs.core.Response.Status.OK;

/**
 * Measurements service supports the management of various measurements pertaining to a patient use /apiref to inspect the various options
 * supported
 *
 * @author vorekoya on 10/11/2015.
 */
@Component
@Path(&quot;/v2-beta/measurements&quot;)
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
@Api(tags = {&quot;Measurements&quot;}, value = &quot;Manage access to the measurements service&quot;)
<span class="fc" id="L67">public class V2MeasurementService {</span>

<span class="fc" id="L69">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private static Optional&lt;Response&gt; validateApiRefForProfessional(Collection&lt;String&gt; requestedApiRefs) {
<span class="pc bpc" id="L72" title="2 of 4 branches missed.">        if (requestedApiRefs == null || requestedApiRefs.isEmpty()) {</span>
<span class="nc" id="L73">            return Optional.of(Response.status(BAD_REQUEST).entity(&quot;no apiRef query parameter supplied&quot;).build());</span>
        }
<span class="fc" id="L75">        return Optional.empty();</span>
    }

    private MeasurementApiHelper measurementApiHelper;
    private MeasurementManager measurementManager;
    private RestUtil util;
    private DateTimeService dateTimeService;

    @Autowired
    public void setUtil(RestUtil util) {
<span class="fc" id="L85">        this.util = util;</span>
<span class="fc" id="L86">    }</span>

    @Autowired
    public void setMeasurementManager(MeasurementManager measurementManager) {
<span class="fc" id="L90">        this.measurementManager = measurementManager;</span>
<span class="fc" id="L91">    }</span>

    @Autowired
    public void setDateTimeService(DateTimeService dateTimeService) {
<span class="fc" id="L95">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L96">    }</span>

    @Autowired
    public void setMeasurementApiHelper(MeasurementApiHelper measurementApiHelper) {
<span class="fc" id="L100">        this.measurementApiHelper = measurementApiHelper;</span>
<span class="fc" id="L101">    }</span>

    /**
     * &lt;br/&gt;
     * &lt;a href=&quot;http://dev.patientsknowbest.com/home/rest-api/scopes&quot;&gt;&lt;b&gt;Scope&lt;/b&gt;&lt;/a&gt;: PATIENT, CLINICIAN
     *
     * @param authToken &lt;b&gt;&lt;b&gt;mandatory&lt;/b&gt;&lt;/b&gt;: Your bearer token, in the form: Bearer myBearerToken
     * @return return the full list of possible measurement types (including those where this user has no data)
     */
    @GET
    @Path(&quot;/apiRefs&quot;)
    @Timed
    @RequiresScope(scopes = {PUBLIC})
    @ApiOperation(value = &quot;Scope: PUBLIC&quot;)
    public ApiReadResponse&lt;ApiMeasurementType&gt; getMeasurementTypes(
            @ApiParam(value = &quot;Your bearer token, in the form: Bearer &lt;myBearerToken&gt;&quot;) @HeaderParam(value = &quot;Authorization&quot;) String authToken)
            throws Exception {

<span class="fc" id="L119">        return buildReadResponse(measurementApiHelper.getAllMeasurementTypes());</span>
    }

    @GET
    @Timed
    @RequiresScope(scopes = {PATIENT})
    @ApiOperation(value = &quot;Find measurements results for patient&quot;, notes = &quot;Returns measurements per patient&quot;, response = V2ApiMeasurement.class, responseContainer = &quot;List&quot;, code = 200)
    public ApiReadResponse&lt;V2ApiMeasurement&gt; getMeasurements(
            @ApiParam(value = &quot;list of api references&quot;) @QueryParam(&quot;apiRefs&quot;) List&lt;String&gt; apiRefs) {

<span class="fc" id="L129">        PKBCommonApiParams params = util.getCommonParams();</span>

<span class="fc" id="L131">        return getMeasurements(apiRefs, params.getPerson().getId(), params);</span>
    }

    @GET
    @Timed(hideParams = &quot;patientId&quot;)
    @RequiresScope(scopes = {CLINICIAN})
    @Path(&quot;/{patientId}&quot;)
    @ApiOperation(value = &quot;Find measurements results for patient&quot;, notes = &quot;Returns measurements per patient&quot;, response = V2ApiMeasurement.class, responseContainer = &quot;List&quot;, code = 200)
    public Response getMeasurementOfPatient(
            @ApiParam(value = &quot;the PKB ID of the patient&quot;, required = true) @PathParam(&quot;patientId&quot;) long patientId,
            @ApiParam(value = &quot;list of api references. &quot;, required = true) @QueryParam(&quot;apiRefs&quot;) List&lt;String&gt; apiRefs) {
<span class="fc" id="L142">        return validateApiRefForProfessional(apiRefs)</span>
<span class="fc" id="L143">                .orElseGet(() -&gt; Response.ok().entity(getMeasurements(apiRefs, patientId, util.getCommonParams(patientId))).build());</span>
    }

    /**
     * Create or update a measurement.
     * &lt;p/&gt;
     * &lt;br/&gt;
     * &lt;a href=&quot;http://dev.patientsknowbest.com/home/rest-api/scopes&quot;&gt;&lt;b&gt;Scope&lt;/b&gt;&lt;/a&gt;: CLINICIAN
     *
     * @param measurement &lt;b&gt;mandatory&lt;/b&gt;: The measurement to create.
     * @param patientId   &lt;b&gt;mandatory&lt;/b&gt;: patient id
     */
    @POST
    @Path(&quot;/{patientId}&quot;)
    @Timed(hideParams = &quot;patientId&quot;)
    @RequiresScope(scopes = {PATIENT, CLINICIAN})
    @ApiOperation(value = &quot;Scope: PATIENT, CLINICIAN&quot;, notes = &quot;Creates measurements by patient. Returns result of operation&quot;, response = ApiWriteResponse.class, code = 200, authorizations = {
            @Authorization(value = &quot;patient_oauth&quot;, scopes = {@AuthorizationScope(scope = &quot;PATIENT&quot;, description = &quot;allows patient to execute task&quot;)})
    })
    public Response createOrUpdateMeasurementsForPatient(
            @ApiParam(value = &quot;Api Measurement model V2&quot;) V2ApiMeasurement measurement,
            @ApiParam(value = &quot;Patient ID&quot;) @PathParam(&quot;patientId&quot;) long patientId) {
<span class="fc" id="L165">        PKBCommonApiParams params = util.getCommonParams(patientId, true);</span>
<span class="fc" id="L166">        return createOrUpdate(measurement, params, patientId);</span>
    }

    private Response createOrUpdate(V2ApiMeasurement measurement, PKBCommonApiParams params, Long patientId) {

<span class="pc bpc" id="L171" title="1 of 2 branches missed.">        if (patientId == null) {</span>
<span class="nc" id="L172">            patientId = params.getPerson().getId();</span>
        }

<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if (!(measurement.getPersistedDate() == null)) {</span>
<span class="nc" id="L176">            String message = &quot;Persisted date must be null as it is set by the server&quot;;</span>
<span class="nc" id="L177">            LOGGER.error(message);</span>
<span class="nc" id="L178">            throw new WebApplicationException(message, Response.Status.BAD_REQUEST);</span>
        }

<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        if (measurement.getEnteredDate() == null) {</span>
<span class="fc" id="L182">            measurement.setEnteredDate(Date.from(dateTimeService.now()));</span>
        }

<span class="fc bfc" id="L185" title="All 2 branches covered.">        if (measurement.getId() == null) {</span>

<span class="fc" id="L187">            UUID id = createMeasurementForUser(params.getRequestContext(), measurement, patientId);</span>
<span class="fc" id="L188">            return Response.ok(new ApiWriteResponse(id.toString(), OperationEnum.CREATED)).status(OK).build();</span>

        } else {

<span class="fc" id="L192">            LOGGER.info(&quot;update requested to measurement with ID[{}] by user-id {}&quot;, measurement.getId(), params.getPerson().getId());</span>

<span class="fc" id="L194">            validate(measurement);</span>

<span class="fc" id="L196">            MeasurementDTO measurementDTO = convert(measurement, params.getRequestContext());</span>

<span class="fc" id="L198">            UUID uniqueId = measurementManager.updateMeasurement(patientId, measurementDTO, params.getRequestContext());</span>
<span class="fc" id="L199">            return Response.ok(new ApiWriteResponse(uniqueId.toString(), OperationEnum.UPDATED)).status(CREATED).build();</span>
        }
    }

    private UUID createMeasurementForUser(EHRRequestContext requestContext, V2ApiMeasurement measurement, Long userId) {

<span class="pc bpc" id="L205" title="1 of 2 branches missed.">        if (measurement.getPersistedDate() == null) {</span>

<span class="fc" id="L207">            validate(measurement);</span>

<span class="fc" id="L209">            return measurementApiHelper.createMeasurement(requestContext, measurement, userId);</span>

        } else {

<span class="nc" id="L213">            throw new ApiValidationError(&quot;Persisted date is set by the server and should not be set by the client&quot;);</span>
        }

    }

    private MeasurementDTO convert(V2ApiMeasurement v2ApiMeasurement, EHRRequestContext requestContext) {

<span class="fc" id="L220">        PredefinedMeasurementType predefinedMeasurementType = PredefinedMeasurementType.getByApiRef(v2ApiMeasurement.getApiRef());</span>

<span class="pc bpc" id="L222" title="1 of 2 branches missed.">        if (predefinedMeasurementType == null) {</span>
<span class="nc" id="L223">            throw new ApiValidationError(&quot;Unknown measurement type&quot;);</span>
        }

<span class="fc" id="L226">        MeasurementDTO dto = new MeasurementDTO(new SourceDetails(requestContext));</span>

<span class="fc" id="L228">        dto.setMeasurementType(predefinedMeasurementType);</span>
<span class="fc" id="L229">        dto.setMeasureDate(v2ApiMeasurement.getMeasureDate().toInstant());</span>
<span class="fc" id="L230">        dto.setValue2(v2ApiMeasurement.getValue2());</span>
<span class="fc" id="L231">        dto.setValue(v2ApiMeasurement.getValue());</span>
<span class="fc" id="L232">        dto.getBaseFields().setUniqueId(v2ApiMeasurement.getId());</span>

<span class="fc" id="L234">        Date enteredDate = v2ApiMeasurement.getEnteredDate();</span>

<span class="pc bpc" id="L236" title="1 of 2 branches missed.">        if (enteredDate == null) {</span>
<span class="nc" id="L237">            enteredDate = Date.from(dateTimeService.now());</span>
        }
<span class="fc" id="L239">        dto.getBaseFields().setEnteredDate(enteredDate);</span>

<span class="fc" id="L241">        return dto;</span>
    }

    private void validate(V2ApiMeasurement measurement) {
        // gather info, validate

<span class="pc bpc" id="L247" title="1 of 2 branches missed.">        if (measurement.getMeasureDate() == null) {</span>
<span class="nc" id="L248">            String message = &quot;MeasureDate must not be null. Please provide as a timestamp&quot;;</span>
<span class="nc" id="L249">            LOGGER.error(message);</span>
<span class="nc" id="L250">            throw new WebApplicationException(message, Response.Status.BAD_REQUEST);</span>
        }

<span class="fc" id="L253">        PredefinedMeasurementType type = PredefinedMeasurementType.getByApiRef(measurement.getApiRef());</span>

<span class="pc bpc" id="L255" title="1 of 2 branches missed.">        if (type == null) {</span>
<span class="nc" id="L256">            throw new ApiValidationError(&quot;Unrecognized apiRef: &quot; + measurement.getApiRef());</span>
        }

<span class="fc" id="L259">    }</span>

    private ApiReadResponse&lt;V2ApiMeasurement&gt; getMeasurements(
            List&lt;String&gt; apiRefs,
            long patientId,
            PKBCommonApiParams params) {

<span class="fc" id="L266">        return buildReadResponse(measurementApiHelper.getAllMeasurementsV2(</span>
<span class="fc" id="L267">                params.getRequestContext(), convertToMeasurementTypes(apiRefs), patientId, null));</span>

    }

    private List&lt;PredefinedMeasurementType&gt; convertToMeasurementTypes(List&lt;String&gt; apiRefs) {

<span class="fc" id="L273">        List&lt;PredefinedMeasurementType&gt; measurementTypes = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L275" title="All 2 branches covered.">        for (String measurementTypeApiRef : apiRefs) {</span>
<span class="fc" id="L276">            PredefinedMeasurementType type = PredefinedMeasurementType.getByApiRef(measurementTypeApiRef);</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">            if (type == null) {</span>
<span class="nc" id="L278">                throw new ApiValidationError(&quot;Unrecognized apiRef: &quot; + measurementTypeApiRef);</span>
            }
<span class="fc" id="L280">            measurementTypes.add(type);</span>
<span class="fc" id="L281">        }</span>

<span class="fc" id="L283">        return measurementTypes;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>