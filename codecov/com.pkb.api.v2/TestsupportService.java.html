<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TestsupportService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.v2</a> &gt; <span class="el_source">TestsupportService.java</span></div><h1>TestsupportService.java</h1><pre class="source lang-java linenums">package com.pkb.api.v2;

import com.pkb.VersionDetails;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.EHRRequestContext.AccountLinkType;
import com.pkb.app.entity.ImmutableLoggedOutEHRRequestContext;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.config.PhrConfigImpl;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.consent.entity.PatientConsent;
import com.pkb.entities.enums.CarerRemovalAge;
import com.pkb.entities.enums.Route;
import com.pkb.service.dataupload.emis.esv2.batch.EmisProcessorAborter;
import com.pkb.service.dataupload.emis.esv2.model.EmisFileType;
import com.pkb.service.emailmessage.IAddressInfoProvider;
import com.pkb.service.emailmessage.ITemplateParamsFactory;
import com.pkb.service.emailmessage.impl.ChildBirthdayEmailSender;
import com.pkb.service.emailmessage.impl.EmailManager;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.patientconsent.ExpiredConsentRemover;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.reminders.ReminderManager;
import com.pkb.service.user.impl.UserAccessManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.util.HelpPageBaseURLProvider;
import org.slf4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import javax.ws.rs.Consumes;
import javax.ws.rs.GET;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import java.lang.invoke.MethodHandles;
import java.lang.reflect.Method;
import java.time.Instant;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.UUID;

import static com.pkb.consent.model.AbstractConsentStatus.noConsentRequired;
import static com.pkb.datamodel.ImmutableDisclosingEmail.disclosingEmail;
import static com.pkb.entities.enums.PropertyName.CHILD16_BIRTHDAY_REMINDER;
import static java.time.ZoneOffset.UTC;
import static java.time.temporal.ChronoUnit.MONTHS;
import static java.time.temporal.ChronoUnit.YEARS;
import static org.slf4j.LoggerFactory.getLogger;

@Path(&quot;/testsupport&quot;)
@Produces(&quot;application/json&quot;)
@Consumes(&quot;application/json&quot;)
@Component
<span class="fc" id="L59">public class TestsupportService {</span>

<span class="fc" id="L61">    private static final Logger LOGGER = getLogger(MethodHandles.lookup().lookupClass());</span>

    @Autowired
    private EmailManager emailManager;

    @Autowired
    private UserManager userManager;

    @Autowired
    private ReminderManager reminderManager;

    @Autowired
    private IAddressInfoProvider formatter;

    @Autowired
    private UserAccessManager userAccessManager;

    @Autowired
    private ITemplateParamsFactory templateParamsFactory;

    @Autowired
    private PKBEmailMessageManager emailMessageManager;

    @Autowired
    private PhrConfig config;

    @Autowired
    private DateTimeService dateTimeService;

    @Autowired
    private EmisProcessorAborter emisProcessorAborter;

    @Autowired
    private HelpPageBaseURLProvider pageBaseURLProvider;

    @Autowired
    private PatientConsentManager patientConsentManager;

    @GET
    @Path(&quot;/send-child-emails&quot;)
    public Response triggerSendEmails() {
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">        if (!config.isDisplayOfSensitiveErrorInformationEnabled()) {</span>
<span class="nc" id="L103">            return Response.status(Response.Status.FORBIDDEN).build();</span>
        }
<span class="fc" id="L105">        ChildBirthdayEmailSender subject = new ChildBirthdayEmailSender(reminderManager, emailManager,</span>
                formatter, templateParamsFactory, LOGGER, dateTimeService);
<span class="fc" id="L107">        subject.send(CarerRemovalAge.CHILD_13);</span>
<span class="fc" id="L108">        subject.send(CarerRemovalAge.CHILD_16);</span>
<span class="fc" id="L109">        subject.send(CarerRemovalAge.CHILD_18);</span>
<span class="fc" id="L110">        return Response.ok().build();</span>
    }

    @GET
    @Path(&quot;/issue334-setup-testdata&quot;)
    public Response setupTestdata() {
<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (!config.isDisplayOfSensitiveErrorInformationEnabled()) {</span>
<span class="nc" id="L117">            return Response.status(Response.Status.FORBIDDEN).build();</span>
        }
<span class="nc" id="L119">        PKBPerson patient = userManager.getPKBPerson(1615L, PKBPerson.Lazy.PROPERTIES);</span>
<span class="nc" id="L120">        ZonedDateTime dobTime = ZonedDateTime.ofInstant(Instant.now(), UTC.normalized()).minus(15, YEARS).minus(10, MONTHS);</span>
<span class="nc" id="L121">        DateTimeFormatter dtf = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;);</span>
<span class="nc" id="L122">        String dobString = dobTime.format(dtf);</span>
        try {
<span class="nc" id="L124">            patient.setDateOfBirthString(dobString);</span>
<span class="nc" id="L125">        } catch (DateTimeParseException dtpe) {</span>
<span class="nc" id="L126">            throw new RuntimeException(&quot;Invalid date of birth: &quot; + dobString, dtpe);</span>
<span class="nc" id="L127">        }</span>
<span class="nc" id="L128">        patient.getProperties().stream()</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">                .filter(prop -&gt; CHILD16_BIRTHDAY_REMINDER == prop.getPropertyName())</span>
<span class="nc" id="L130">                .findFirst().ifPresent(prop -&gt; prop.setPropertyValue(&quot;false&quot;));</span>

<span class="nc" id="L132">        EHRRequestContext reqCtx = ImmutableLoggedOutEHRRequestContext.of(AccountLinkType.NO_LINK, Route.NOT_CAPTURED, noConsentRequired(), UUID.randomUUID());</span>
<span class="nc" id="L133">        userManager.updateUser(reqCtx, patient);</span>

<span class="nc" id="L135">        PKBPerson author = userManager.getPKBPerson(1570L); // Teamcoord 1</span>
<span class="nc bnc" id="L136" title="All 2 branches missed.">        if (author == null) {</span>
<span class="nc" id="L137">            throw new RuntimeException(&quot;cannot find user with id 1570&quot;);</span>
        }
<span class="nc" id="L139">        PKBPerson carer = new PKBPerson();</span>
<span class="nc" id="L140">        carer.setFirstName(&quot;AZ&quot;);</span>
<span class="nc" id="L141">        carer.setLastName(&quot;Patient1 Carer1&quot;);</span>
<span class="nc" id="L142">        carer.setPrimaryEmail(disclosingEmail(&quot;az.patient1.carer1@pkbtest.com&quot;), VersionDetails.of(reqCtx, dateTimeService.now()));</span>
<span class="nc" id="L143">        PatientConsent consent = new PatientConsent();</span>
<span class="nc" id="L144">        consent.setGeneralHealthConsentGranted(true);</span>

<span class="nc" id="L146">        return Response.ok().build();</span>
    }

    @GET
    @Path(&quot;/delete-expired-consents&quot;)
    public Response deleteExpiredConsents() {
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">        if (!config.isDisplayOfSensitiveErrorInformationEnabled()) {</span>
<span class="nc" id="L153">            return Response.status(Response.Status.FORBIDDEN).build();</span>
        }
<span class="fc" id="L155">        ExpiredConsentRemover subject = new ExpiredConsentRemover(userAccessManager, emailManager, userManager,</span>
                templateParamsFactory, formatter, LOGGER, patientConsentManager);
<span class="fc" id="L157">        subject.run(CarerRemovalAge.CHILD_13);</span>
<span class="fc" id="L158">        subject.run(CarerRemovalAge.CHILD_16);</span>
<span class="fc" id="L159">        subject.run(CarerRemovalAge.CHILD_18);</span>
<span class="fc" id="L160">        return Response.ok().build();</span>
    }

    @GET
    @Path(&quot;/send-symptom-reminders&quot;)
    public Response sendSymptomReminders() {
<span class="nc bnc" id="L166" title="All 2 branches missed.">        if (!config.isDisplayOfSensitiveErrorInformationEnabled()) {</span>
<span class="nc" id="L167">            return Response.status(Response.Status.FORBIDDEN).build();</span>
        }
<span class="nc" id="L169">        emailMessageManager.doSendSymptomReminders();</span>
<span class="nc" id="L170">        return Response.ok().build();</span>
    }

    @GET
    @Path(&quot;/abortEmisProcessAt&quot;)
    public Response setAbortpoint(@QueryParam(&quot;emisFileType&quot;) EmisFileType type, @QueryParam(&quot;recordId&quot;) long recordId) {
<span class="pc bpc" id="L176" title="1 of 2 branches missed.">        if (config.isFakeDateTimeServiceEnabled()) {</span>
<span class="fc" id="L177">            emisProcessorAborter.setAbortPoint(type, recordId);</span>
        } else {
<span class="nc" id="L179">            return Response.status(Response.Status.NOT_FOUND).build();</span>
        }
<span class="fc" id="L181">        return Response.ok().build();</span>
    }

    @GET
    @Path(&quot;/pauseEmisProcessAt&quot;)
    public Response setPausepoint(@QueryParam(&quot;emisFileType&quot;) EmisFileType type, @QueryParam(&quot;recordId&quot;) long recordId) {
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">        if (config.isFakeDateTimeServiceEnabled()) {</span>
<span class="fc" id="L188">            emisProcessorAborter.setPausePoint(type, recordId);</span>
        } else {
<span class="nc" id="L190">            return Response.status(Response.Status.NOT_FOUND).build();</span>
        }
<span class="fc" id="L192">        return Response.ok().build();</span>
    }

    @GET
    @Path(&quot;/pauseEmisProcessAt/clear&quot;)
    public Response clearPausepoint(@QueryParam(&quot;emisFileType&quot;) EmisFileType type) {
<span class="pc bpc" id="L198" title="1 of 2 branches missed.">        if (config.isFakeDateTimeServiceEnabled()) {</span>
<span class="fc" id="L199">            emisProcessorAborter.clearPausePoint(type);</span>
        } else {
<span class="nc" id="L201">            return Response.status(Response.Status.NOT_FOUND).build();</span>
        }
<span class="fc" id="L203">        return Response.ok().build();</span>
    }

    @GET
    @Path(&quot;/isEmisEsPaused&quot;)
    public Response isEmisPaused() {
<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        if (config.isFakeDateTimeServiceEnabled()) {</span>
<span class="fc" id="L210">            return Response.ok(emisProcessorAborter.isPaused()).build();</span>
        } else {
<span class="nc" id="L212">            return Response.status(Response.Status.NOT_FOUND).build();</span>
        }
    }

    @GET
    @Path(&quot;/abortEmisProcessAt/clearAll&quot;)
    public Response clearEmisAbortProcess() {
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">        if (config.isFakeDateTimeServiceEnabled()) {</span>
<span class="fc" id="L220">            emisProcessorAborter.clear();</span>
        } else {
<span class="nc" id="L222">            return Response.status(Response.Status.NOT_FOUND).build();</span>
        }
<span class="fc" id="L224">        return Response.ok().build();</span>
    }

    @PUT
    @Path(&quot;/help-url&quot;)
    @Consumes(MediaType.TEXT_PLAIN)
    public Response setHelpUrl(String helpUrl) {
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">        if (config.isFakeHelpPageBaseUrlProviderEnabled()) {</span>
<span class="fc" id="L232">            pageBaseURLProvider.setOverrideHelpPageBaseUrl(helpUrl);</span>
<span class="fc" id="L233">            return Response.ok().build();</span>
        } else {
<span class="nc" id="L235">            return Response.status(Response.Status.NOT_FOUND).build();</span>
        }
    }

    @GET
    @Path(&quot;/configurationValue&quot;)
    public Response getConfigurationValue(@QueryParam(&quot;method&quot;) String methodName) throws Throwable {
<span class="fc" id="L242">        PhrConfigImpl target = new PhrConfigImpl(config.getConfigStorage());</span>
<span class="fc" id="L243">        Method method = target.getClass().getMethod(methodName);</span>
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">        if (!method.isDefault()) {</span>
<span class="nc" id="L245">            return Response.status(Response.Status.NOT_IMPLEMENTED).build();</span>
        }
<span class="fc" id="L247">        return Response.ok(method.invoke(target)).build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>