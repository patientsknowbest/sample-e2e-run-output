<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NhsLoginAuthenticationDetails.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.security</a> &gt; <span class="el_source">NhsLoginAuthenticationDetails.java</span></div><h1>NhsLoginAuthenticationDetails.java</h1><pre class="source lang-java linenums">package com.pkb.security;

import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.EHRRequestContext.AccountLinkType;
import com.pkb.app.entity.ImmutableLoggedOutEHRRequestContext;
import com.pkb.dto.NhsLoginInfo;
import com.pkb.entities.enums.LoginAttemptLogResult;
import com.pkb.entities.enums.Route;
import com.pkb.util.AppIdentityUtil;
import com.pkb.util.AppIdentityUtil.AppIdentity;
import org.immutables.value.Value;
import org.immutables.value.Value.Derived;
import org.immutables.value.Value.Immutable;
import org.jetbrains.annotations.NotNull;

import javax.servlet.http.HttpServletRequest;
import java.util.Map;
import java.util.Optional;
import java.util.UUID;

import static com.pkb.consent.model.AbstractConsentStatus.noConsentRequired;
import static com.pkb.entities.enums.LoginAttemptLogResult.FAIL_NHSELOGIN_NHSEAPP;
import static com.pkb.entities.enums.LoginAttemptLogResult.FAIL_NHSELOGIN_NHSEAPP_WAYFINDER;
import static com.pkb.entities.enums.LoginAttemptLogResult.FAIL_NHSELOGIN_NHSEAPP_WEB_WAYFINDER;
import static com.pkb.entities.enums.LoginAttemptLogResult.FAIL_NHSELOGIN_PKBWEB;
import static com.pkb.entities.enums.LoginAttemptLogResult.SUCCESS_NHSELOGIN_NHSEAPP;
import static com.pkb.entities.enums.LoginAttemptLogResult.SUCCESS_NHSELOGIN_NHSEAPP_WAYFINDER;
import static com.pkb.entities.enums.LoginAttemptLogResult.SUCCESS_NHSELOGIN_NHSEAPP_WEB_WAYFINDER;
import static com.pkb.entities.enums.LoginAttemptLogResult.SUCCESS_NHSELOGIN_PKBWEB;
import static com.pkb.util.Constants.NHS_LOGIN_CORRELATION_ID;
import static java.util.Optional.ofNullable;

@Immutable
@Value.Style(
        get = {&quot;is*&quot;, &quot;get*&quot;},
        passAnnotations = {NotNull.class}
)
public interface NhsLoginAuthenticationDetails extends BaseAuthenticationDetails, NhsLoginInfo {

    Optional&lt;UUID&gt; getJti();

    AppIdentity getAppIdentity();

    UUID getCorrelationId();

<span class="fc" id="L46">    Map&lt;AppIdentity, LoginAttemptLogResult&gt; APP_IDENTITY_RESULT_MAP = Map.of(</span>
            AppIdentity.PKB_WEB, SUCCESS_NHSELOGIN_PKBWEB,
            AppIdentity.NHS_APP, SUCCESS_NHSELOGIN_NHSEAPP,
            AppIdentity.NHS_APP_WAYFINDER, SUCCESS_NHSELOGIN_NHSEAPP_WAYFINDER,
            AppIdentity.NHS_APP_WEB_WAYFINDER, SUCCESS_NHSELOGIN_NHSEAPP_WEB_WAYFINDER
    );

<span class="fc" id="L53">    Map&lt;AppIdentity, LoginAttemptLogResult&gt; APP_IDENTITY_FAIL_RESULT_MAP = Map.of(</span>
            AppIdentity.PKB_WEB, FAIL_NHSELOGIN_PKBWEB,
            AppIdentity.NHS_APP, FAIL_NHSELOGIN_NHSEAPP,
            AppIdentity.NHS_APP_WAYFINDER, FAIL_NHSELOGIN_NHSEAPP_WAYFINDER,
            AppIdentity.NHS_APP_WEB_WAYFINDER, FAIL_NHSELOGIN_NHSEAPP_WEB_WAYFINDER
    );

    @Override
    default LoginAttemptLogResult getLoginAttemptSuccessResult() {
<span class="fc" id="L62">        return APP_IDENTITY_RESULT_MAP.get(getAppIdentity());</span>
    }

    @Override
    default LoginAttemptLogResult getLoginAttemptFailResult() {
<span class="fc" id="L67">        return APP_IDENTITY_FAIL_RESULT_MAP.get(getAppIdentity());</span>
    }

    @Derived
    @Override
    default EHRRequestContext getEHRRequestContext() {
<span class="fc" id="L73">        return ImmutableLoggedOutEHRRequestContext.builder()</span>
<span class="fc" id="L74">                .accountLinkType(AccountLinkType.NO_LINK)</span>
<span class="fc" id="L75">                .accessRoute(getRoute())</span>
<span class="fc" id="L76">                .consentStatus(noConsentRequired())</span>
<span class="fc" id="L77">                .correlationId(getCorrelationId())</span>
<span class="fc" id="L78">                .build();</span>
    }

    @SuppressWarnings(&quot;override&quot;)
    interface Builder extends BaseAuthenticationDetails.Builder&lt;NhsLoginAuthenticationDetails, Builder&gt; {

        Builder emailVerified(boolean verified);

        Builder nhsNumber(String nhsNumber);

        Builder redirectPath(String redirectPath);

        Builder jti(UUID jti);

        Builder route(Route route);

        Builder forceNewMetadata(boolean parseBoolean);

        Builder newMetadata(boolean parseBoolean);

        Builder appIdentity(AppIdentity appIdentity);

        Builder correlationId(UUID correlationId);

        Builder dateOfBirth(String dateOfBirth);

        Builder firstName(String firstName);

        Builder lastName(String lastName);

        Builder teamCode(String teamCode);

        Builder selfReg(boolean isSelfReg);

        @Override
        default BaseAuthenticationDetails.Builder&lt;NhsLoginAuthenticationDetails, Builder&gt; populateFrom(HttpServletRequest request, AppIdentityUtil appIdentityUtil) {
<span class="fc" id="L114">            BaseAuthenticationDetails.Builder.super.populateFrom(request, appIdentityUtil);</span>
<span class="fc" id="L115">            emailVerified(Boolean.parseBoolean(request.getParameter(&quot;info.emailVerified&quot;)));</span>
<span class="fc" id="L116">            nhsNumber(request.getParameter(&quot;info.nhsNumber&quot;));</span>
<span class="fc" id="L117">            ofNullable(request.getParameter(&quot;info.path&quot;)).ifPresent(this::redirectPath);</span>
<span class="fc" id="L118">            ofNullable(request.getParameter(&quot;info.jti&quot;)).map(UUID::fromString).ifPresent(this::jti);</span>
<span class="fc" id="L119">            forceNewMetadata(Boolean.parseBoolean(request.getParameter(&quot;info.forceNewMetadata&quot;)));</span>
<span class="fc" id="L120">            newMetadata(Boolean.parseBoolean(request.getParameter(&quot;info.isNewMetadata&quot;)));</span>
<span class="fc" id="L121">            AppIdentity appIdentity = appIdentityUtil.resolve(request);</span>
<span class="fc" id="L122">            appIdentity(appIdentity);</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">            route(appIdentity == AppIdentity.NHS_APP ? Route.WEBAPP_NHS_APP : Route.WEBAPP);</span>
<span class="fc" id="L124">            String correlationId = request.getHeader(&quot;X-Request-ID&quot;);</span>
<span class="fc" id="L125">            correlationId(UUID.fromString(correlationId));</span>
<span class="fc" id="L126">            request.getSession().setAttribute(NHS_LOGIN_CORRELATION_ID, correlationId);</span>
<span class="fc" id="L127">            dateOfBirth(request.getParameter(&quot;info.dateOfBirth&quot;));</span>
<span class="fc" id="L128">            firstName(request.getParameter(&quot;info.firstName&quot;));</span>
<span class="fc" id="L129">            lastName(request.getParameter(&quot;info.lastName&quot;));</span>
<span class="fc" id="L130">            ofNullable(request.getParameter(&quot;info.teamCode&quot;)).ifPresent(this::teamCode);</span>
<span class="fc" id="L131">            ofNullable(request.getParameter(&quot;info.isSelfReg&quot;))</span>
<span class="fc" id="L132">                    .map(&quot;true&quot;::equalsIgnoreCase)</span>
<span class="fc" id="L133">                    .ifPresent(this::selfReg);</span>

<span class="fc" id="L135">            return this;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>