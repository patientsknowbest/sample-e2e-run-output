<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PatientConsentAuditLogAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.team</a> &gt; <span class="el_source">PatientConsentAuditLogAction.java</span></div><h1>PatientConsentAuditLogAction.java</h1><pre class="source lang-java linenums">package com.pkb.action.team;

import com.pkb.action.BaseAction;
import com.pkb.action.support.PatientConsentReasonTransformer;
import com.pkb.app.PrivacyFlagsToPrivacyFlagConverter;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.PatientAuditLog;
import com.pkb.consent.entity.PatientConsentReason;
import com.pkb.datamodel.PrivacyFlagsOverride;
import com.pkb.domain.PrivacyFlagsService;
import com.pkb.entities.enums.PrivacyFlag;
import com.pkb.mappers.MappingTextProvider;
import com.pkb.mappers.PatientAccessLogMapper;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.AuditLogManager;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Set;

import static java.util.stream.Collectors.toList;
import static java.util.stream.Collectors.toMap;
import static java.util.stream.Collectors.toSet;
import static org.apache.commons.lang3.ObjectUtils.defaultIfNull;


<span class="fc" id="L29">public class PatientConsentAuditLogAction extends BaseAction {</span>

    private static final long serialVersionUID = -2697968127946737990L;

    private static final String TAB = &quot;invitations&quot;;
    private static final String SUB_TAB = &quot;accessLog&quot;;

    @Autowired
    private AuditLogManager auditLogManager;
    private TeamUserManager teamUserManager;
    private PrivacyFlagsService privacyFlagsService;

    @Autowired
    private PatientAccessLogMapper patientAccessLogMapper;
    @Autowired
    private PatientConsentReasonTransformer patientConsentReasonTransformer;
    private Integer offset;
    private Integer count;

    private List&lt;PatientAuditLogViewModel&gt; auditLog;

<span class="fc" id="L50">    private boolean hideOwnAccess = true;</span>

    public String view() {
        // TODO: Assert logged in as patient!
<span class="fc" id="L54">        LoggedInEHRRequestContext context = getLoggedInEHRRequestContext().withoutAccessLog();</span>
<span class="fc" id="L55">        long patientId = loggedInUserUtil.getLoggedInUserId();</span>
<span class="fc" id="L56">        Long accountId = loggedInUserUtil.getLoggedInUserAccountId();</span>

<span class="fc" id="L58">        List&lt;PatientAuditLog&gt; auditLogForPatient = io.vavr.collection.List</span>
<span class="fc" id="L59">                .ofAll(auditLogManager.getAuditLogForPatient(</span>
                        patientId,
<span class="fc" id="L61">                        getOffset(),</span>
<span class="fc" id="L62">                        getCount(), hideOwnAccess))</span>
<span class="fc" id="L63">                .distinctBy(PatientAuditLog::getId).asJava();</span>

<span class="fc" id="L65">        List&lt;PatientConsentReason&gt; reasons = retrieveConsentChangeReasons(context, accountId, auditLogForPatient);</span>

<span class="fc" id="L67">        Set&lt;Long&gt; privacyFlagIds = auditLogForPatient</span>
<span class="fc" id="L68">                .stream()</span>
<span class="fc" id="L69">                .map(PatientAuditLog::getPrivacyFlagsId)</span>
<span class="fc" id="L70">                .filter(Objects::nonNull)</span>
<span class="fc" id="L71">                .collect(toSet());</span>
<span class="fc" id="L72">        List&lt;PrivacyFlagsOverride&gt; privacyFlags = privacyFlagsService.getPrivacyFlagsByIds(privacyFlagIds);</span>
<span class="fc" id="L73">        Map&lt;Long, Set&lt;PrivacyFlag&gt;&gt; poIdToPrivacyFlags = privacyFlags.stream()</span>
<span class="fc" id="L74">                .collect(toMap(po -&gt; po.getId().get(),</span>
<span class="fc" id="L75">                        po -&gt; PrivacyFlagsToPrivacyFlagConverter.getPrivacyFlags(po.isGeneralRequired(), po.isMentalHealthRequired(),</span>
<span class="fc" id="L76">                                po.isSexualHealthRequired(), po.isSocialCareRequired())));</span>

<span class="fc" id="L78">        auditLog = patientAccessLogMapper.accessLogsToDTOs(</span>
                auditLogForPatient,
                reasons,
                poIdToPrivacyFlags,
                hideOwnAccess,
<span class="fc" id="L83">                MappingTextProvider.of(</span>
                        this::getText,
                        this::getText))
<span class="fc" id="L86">                .stream()</span>
<span class="fc" id="L87">                .map(PatientAuditLogViewModel::new).collect(toList());</span>

<span class="fc" id="L89">        return SUCCESS;</span>
    }

    private List&lt;PatientConsentReason&gt; retrieveConsentChangeReasons(LoggedInEHRRequestContext context, Long accountId, List&lt;PatientAuditLog&gt; auditLogForPatient) {
<span class="fc" id="L93">        return patientConsentReasonTransformer.transformPatientConsentReason(teamUserManager.getConsentChangeReasons(</span>
                context,
<span class="fc" id="L95">                accountId,</span>
                auditLogForPatient));
    }


    public void setAuditLogManager(AuditLogManager auditLogManager) {
<span class="fc" id="L101">        this.auditLogManager = auditLogManager;</span>
<span class="fc" id="L102">    }</span>

    public TeamUserManager getTeamUserManager() {
<span class="nc" id="L105">        return teamUserManager;</span>
    }

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L109">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L110">    }</span>

    public Integer getOffset() {
<span class="fc" id="L113">        return defaultIfNull(offset, 0);</span>
    }

    public void setOffset(Integer offset) {
<span class="fc" id="L117">        this.offset = offset;</span>
<span class="fc" id="L118">    }</span>

    public Integer getCount() {

<span class="fc" id="L122">        count = defaultIfNull(count, getAccessLogPageSize());</span>
<span class="pc bpc" id="L123" title="1 of 2 branches missed.">        if (count &gt; 100) {</span>
<span class="nc" id="L124">            count = 100;</span>
        }

<span class="fc" id="L127">        return count;</span>
    }

    public boolean isPreviousPageExists() {
<span class="fc bfc" id="L131" title="All 2 branches covered.">        return getOffset() &gt; 0;</span>
    }

    public boolean isNextPageExists() {
<span class="fc bfc" id="L135" title="All 2 branches covered.">        return auditLog.size() == getCount();</span>
    }

    public void setCount(Integer count) {
<span class="fc" id="L139">        this.count = count;</span>
<span class="fc" id="L140">    }</span>

    public List&lt;PatientAuditLogViewModel&gt; getAuditLog() {
<span class="fc" id="L143">        return auditLog;</span>
    }

    public Integer getPreviousOffset() {
<span class="fc" id="L147">        return Math.max(offset - count, 0);</span>
    }

    public Integer getNextOffset() {
<span class="fc" id="L151">        return getOffset() + getCount();</span>
    }

    public String getTab() {
<span class="fc" id="L155">        return TAB;</span>
    }

    public String getSubTab() {
<span class="fc" id="L159">        return SUB_TAB;</span>
    }

    public boolean isHideOwnAccess() {
<span class="fc" id="L163">        return hideOwnAccess;</span>
    }

    public void setHideOwnAccess(boolean hideOwnAccess) {
<span class="fc" id="L167">        this.hideOwnAccess = hideOwnAccess;</span>
<span class="fc" id="L168">    }</span>

    public PrivacyFlagsService getPrivacyFlagsService() {
<span class="nc" id="L171">        return privacyFlagsService;</span>
    }

    public void setPrivacyFlagsService(PrivacyFlagsService privacyFlagsService) {
<span class="fc" id="L175">        this.privacyFlagsService = privacyFlagsService;</span>
<span class="fc" id="L176">    }</span>

    public void setPatientAccessLogMapper(PatientAccessLogMapper patientAccessLogMapper) {
<span class="nc" id="L179">        this.patientAccessLogMapper = patientAccessLogMapper;</span>
<span class="nc" id="L180">    }</span>

    public void setAuditLog(List&lt;PatientAuditLogViewModel&gt; auditLog) {
<span class="nc" id="L183">        this.auditLog = auditLog;</span>
<span class="nc" id="L184">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>