<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConsultTeamAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.team</a> &gt; <span class="el_source">ConsultTeamAction.java</span></div><h1>ConsultTeamAction.java</h1><pre class="source lang-java linenums">package com.pkb.action.team;

import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.consent.model.NoConsentsRequired;
import com.pkb.entities.enums.OrgExternalIdType;
import com.pkb.entities.enums.SponsorshipStatus;
import com.pkb.entities.enums.UserType;
import com.pkb.institute.entity.InstituteUser;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.user.entity.PKBPerson;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

<span class="nc" id="L18">public class ConsultTeamAction extends BaseAction {</span>

    private static final long serialVersionUID = 1L;

    // Input from consult.action URL
    private String idType;
    private String orgId;

    // Output to instituteTeamList.jsp
    private Org org;

    private Long consultTeamId; // selected from the teams list

    private Team consultTeam; // only populated if we're showing the confirm JSP

    private TeamManager teamManager;

    private TeamUserManager teamUserManager;

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="nc" id="L38">        this.teamUserManager = teamUserManager;</span>
<span class="nc" id="L39">    }</span>

<span class="nc" id="L41">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    /**
     * run with external (no user signed-in) link. Find the org and show its teams
     *
     * @return
     */
    public String listTeams() {
<span class="nc" id="L49">        OrgExternalIdType extIdType = null;</span>
        try {
<span class="nc" id="L51">            extIdType = OrgExternalIdType.valueOf(idType.toUpperCase()); // throws exception if not found // who would have thought so? :)</span>
<span class="nc" id="L52">        } catch (Exception e) {</span>
<span class="nc" id="L53">            LOGGER.error(&quot;Cannot find idType&quot;, e);</span>
<span class="nc" id="L54">            addActionError(getText(&quot;consultTeamAction.err.unknown_org&quot;,new String[]{idType}));</span>
<span class="nc" id="L55">            return ERROR;</span>
<span class="nc" id="L56">        }</span>

<span class="nc" id="L58">        org = teamManager.getOrgByOrgExternalIdType(extIdType, orgId, Org.Lazy.TEAMS).orElse(null);</span>
        // org may be null, if no match was found -- JSP must handle this case
<span class="nc bnc" id="L60" title="All 2 branches missed.">        if (org == null) {</span>
            // we'll log it so we can track it
<span class="nc" id="L62">            LOGGER.warn(&quot;No match for org external id: {}, type {}&quot;, orgId, idType);</span>
        }

<span class="nc" id="L65">        return Action.SUCCESS;</span>
    }

    /**
     * superadmin/employee/institute admin: go to dashboard with error message.
     * clinician: straight to list of clinicians
     * patient: if already linked, go to composeMessage with list of clinicians
     * if NOT already linked, show prompt screen (cancel goes home, confirm goes to composeMessage w/ list of clinicians)
     */
    @Override
    public String execute() {
<span class="nc" id="L76">        PKBPerson person = loggedInUserUtil.getLoggedInPerson();</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (person.getUserType() == UserType.SUPER_ADMIN) {</span>
<span class="nc" id="L78">            addActionError(getText(&quot;consultTeamAction.err.superadmin_cannot_consult&quot;));</span>
<span class="nc" id="L79">            return &quot;homeSuperAdmin&quot;;</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">        } else if (person.getUserType() == UserType.EMPLOYEE) {</span>
<span class="nc" id="L81">            addActionError(getText(&quot;consultTeamAction.err.employee_cannot_consult&quot;));</span>
<span class="nc" id="L82">            return &quot;homeEmployee&quot;;</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">        } else if (person.isTeamCoordinator()) {</span>
<span class="nc" id="L84">            addActionError(getText(&quot;consultTeamAction.err.coord_cannot_consult&quot;));</span>
<span class="nc" id="L85">            return &quot;homeInstituteAdmin&quot;;</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">        } else if (person.isPro()) {</span>
<span class="nc" id="L87">            return SUCCESS; // no need to link clinician to other clinician's team</span>
        }
        // else: it's a patient.

        // patient must be linked -- if NOT linked, prompt for confirmation now
<span class="nc" id="L92">        InstituteUser patientIu = teamUserManager.getInstituteUser(consultTeamId, person.getId());</span>
<span class="nc bnc" id="L93" title="All 4 branches missed.">        if ((patientIu != null) &amp;&amp; patientIu.getSponsorshipStatus() == SponsorshipStatus.ACTIVE) {</span>
            // valid team-user link already exists
<span class="nc" id="L95">            return SUCCESS;</span>
        } else { // must confirm linking
<span class="nc" id="L97">            consultTeam = teamManager.getTeam(consultTeamId);</span>
<span class="nc" id="L98">            return &quot;confirm&quot;;</span>
        }

    }

    /**
     * The patient validates that they want to be linked to Team X, so we link them and continue
     * Clinicians won't hit this section
     *
     * @return
     */
    public String consultTeamConfirm() {
        // Logged in person has already been validated as a patient at this point
<span class="nc" id="L111">        long patientId = loggedInUserUtil.getLoggedInUserId();</span>

        try {
<span class="nc" id="L114">            teamUserManager.beginTransaction();</span>
            // Check if the patient has already been invited to this team before
<span class="nc" id="L116">            InstituteUser instituteUser = teamUserManager.getInstituteUser(consultTeamId, patientId);</span>
<span class="nc bnc" id="L117" title="All 2 branches missed.">            if (instituteUser == null) {</span>
                // Create institute user entry
<span class="nc" id="L119">                teamUserManager.createInstituteUser(patientId, consultTeamId);</span>
<span class="nc" id="L120">                teamUserManager.updateStatus(consultTeamId, patientId, SponsorshipStatus.ACTIVE);</span>
<span class="nc bnc" id="L121" title="All 2 branches missed.">            } else if (instituteUser.getSponsorshipStatus() != SponsorshipStatus.ACTIVE) {</span>
                // update the status to ACTIVE
<span class="nc" id="L123">                teamUserManager.updateStatus(consultTeamId, patientId, SponsorshipStatus.ACTIVE);</span>
            }

            // Assign institute admin
<span class="nc" id="L127">            teamUserManager.commitTransaction();</span>
            // Log the event
<span class="nc" id="L129">            logActivity(com.pkb.notification.entity.Activity.Action.LINKED_TO_CONSULT_TEAM, dateTimeService.now(), patientId, false, new NoConsentsRequired());</span>
        } finally {
<span class="nc" id="L131">            teamManager.rollbackIfNotCommitted();</span>
        }
<span class="nc" id="L133">        return SUCCESS;</span>
    }

    public String cancelConsult() {
<span class="nc" id="L137">        addActionMessage(getText(&quot;consultTeamAction.msg.request_cancelled&quot;));</span>
<span class="nc" id="L138">        return &quot;cancel&quot;;</span>
    }

    public String getIdType() {
<span class="nc" id="L142">        return idType;</span>
    }

    public void setIdType(String type) {
<span class="nc" id="L146">        this.idType = type;</span>
<span class="nc" id="L147">    }</span>

    public String getOrgId() {
<span class="nc" id="L150">        return orgId;</span>
    }

    public void setOrgId(String orgId) {
<span class="nc" id="L154">        this.orgId = orgId;</span>
<span class="nc" id="L155">    }</span>

    public Org getOrg() {
<span class="nc" id="L158">        return org;</span>
    }

    public Long getConsultTeamId() {
<span class="nc" id="L162">        return consultTeamId;</span>
    }

    public void setConsultTeamId(Long consultTeamId) {
<span class="nc" id="L166">        this.consultTeamId = consultTeamId;</span>
<span class="nc" id="L167">    }</span>

    public Team getConsultTeam() {
<span class="nc" id="L170">        return consultTeam;</span>
    }

    public void setTeamManager(TeamManager teamManager) {
<span class="nc" id="L174">        this.teamManager = teamManager;</span>
<span class="nc" id="L175">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>