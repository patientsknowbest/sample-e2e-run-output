<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PatientsAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.team</a> &gt; <span class="el_source">PatientsAction.java</span></div><h1>PatientsAction.java</h1><pre class="source lang-java linenums">package com.pkb.action.team;

import com.google.common.collect.Ordering;
import com.pkb.bean.IMessageWebBean;
import com.pkb.datamodel.Email;
import com.pkb.entities.enums.AccessingEntityType;
import com.pkb.entities.enums.NationalIdType;
import com.pkb.entities.enums.UserStatus;
import com.pkb.entities.enums.ValidNationalId;
import com.pkb.exception.PKBException;
import com.pkb.institute.entity.ImmutableOrgPatientSearchOptionsDto;
import com.pkb.institute.entity.ImmutablePatientSearchOptionsDto;
import com.pkb.institute.entity.InstituteUser;
import com.pkb.institute.entity.PatientSearchOptionsDto;
import com.pkb.institute.entity.Team;
import com.pkb.model.PKBPersonDTO;
import com.pkb.questionnaires.action.QuestionnaireBaseAction;
import com.pkb.questionnaireservice.modelv2.Questionnaire;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.questionnaire.QuestionnaireManager;
import com.pkb.service.symptom.SymptomReportManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.UserAccessManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.symptom.entity.AlarmSymptomData;
import com.pkb.symptom.entity.Symptom;
import com.pkb.symptom.entity.SymptomAlarmDTO;
import com.pkb.user.entity.OrgLevelIdType;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PasswordAccess;
import com.pkb.user.entity.TeamLevelIdType;
import com.pkb.util.PatientSearchUtil;
import com.pkb.util.PersonOrderingHelper;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.invoke.MethodHandles;
import java.util.ArrayList;
import java.util.List;
import java.util.Set;
import java.util.TreeSet;
import java.util.Vector;
import java.util.function.Function;
import java.util.stream.Collectors;

import static com.pkb.datamodel.ImmutableDisclosingEmail.disclosingEmail;
import static java.util.Collections.emptyList;
import static org.apache.commons.lang3.StringUtils.isNotBlank;

public class PatientsAction extends QuestionnaireBaseAction {
    private static final long serialVersionUID = -5043280774106212457L;

    private static final int PATIENT_SEARCH_MAX_RESULTS = 50;

<span class="fc" id="L56">    public PatientsAction() {</span>
<span class="fc" id="L57">        ordering = new PersonOrderingHelper();</span>
<span class="fc" id="L58">    }</span>

<span class="fc" id="L60">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

    private UserAccessManager userAccessManager;

    private TeamUserManager teamUserManager;

    private IMessageWebBean messageWebBean;

    private List&lt;PKBPerson&gt; patients;

    private Set&lt;Long&gt; assignedPatientIds;

    private PersonOrderingHelper ordering;

    private List&lt;InstituteUser&gt; colleagues;

    private List&lt;PKBPerson&gt; prevPatients;

<span class="fc" id="L78">    private final String tab = &quot;invitations&quot;;</span>

<span class="fc" id="L80">    private String subTab = &quot;patients&quot;;</span>

    private Long patientId;

    private PKBPerson patient;

    private String newContact;

    private String oldContact;

    private String searchIdType; // national/org/team
    private String searchId;
    private String searchName;
    private String searchDobYear;
    private String searchDobMonth;
    private String searchDobDay;
    private String searchLevel;

    private String teamName;
    private String orgName;
<span class="fc" id="L100">    private List&lt;Questionnaire&gt; questionnaires = emptyList();</span>

    // To pass to createPatient.jsp
    private Team team;
    private PKBPersonDTO patientDTO;
    private String nationalId;
    private String nationalIdName;
    private List&lt;String&gt; groupedOrgLevelIds;
    private List&lt;OrgLevelIdType&gt; orgLevelIdTypes;
    private List&lt;String&gt; groupedTeamLevelIds;
    private List&lt;TeamLevelIdType&gt; teamLevelIdTypes;

    private SymptomReportManager symptomReportManager;
    private PKBEmailMessageManager pkbEmailMessageManager;
    private QuestionnaireManager questionnaireManager;
    private PatientConsentManager patientConsentManager;

    private NationalIdType clinicianNationalIdType;

    // For myAlarms.jsp
    private boolean notActivated;
    private Vector&lt;String&gt; columnNames;
    private List&lt;SymptomAlarmDTO&gt; alarms;
    private Long redThreshold;

    public String myPatients() throws NumberFormatException {
<span class="fc" id="L126">        long clinicianId = loggedInUserUtil.getLoggedInUserId();</span>

<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        if (isLoggedInUserPatient()) {</span>
<span class="nc" id="L129">            addActionError(getText(&quot;patientsAction.err.no_permission_to_view_other_patients&quot;));</span>
<span class="nc" id="L130">            return SUCCESS;</span>
        }

<span class="fc" id="L133">        team = loggedInUserUtil.getLoggedInUserPrimaryTeam(getEHRRequestContext());</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">        if (team != null) {</span>
<span class="fc" id="L135">            clinicianNationalIdType = NationalIdType.getPrimaryNationalIdTypeFromCountryCode(team.getCountry()).orElse(null);</span>
<span class="fc" id="L136">            teamName = team.getName();</span>
<span class="fc" id="L137">            orgName = team.getOrg().getName();</span>
<span class="fc" id="L138">            questionnaires = questionnaireManager.getQuestionnaireListForTeam(team.getPublicId(), false)</span>
<span class="fc" id="L139">                    .peekLeft(this::handleQuestionnaireException)</span>
<span class="fc" id="L140">                    .getOrElse(emptyList());</span>
        } else {
<span class="fc" id="L142">            PKBPerson clinician = userManager.getPKBPerson(clinicianId);</span>
<span class="fc" id="L143">            clinicianNationalIdType = NationalIdType.getPrimaryNationalIdTypeFromCountryCode(clinician.getCountry()).orElse(null);</span>
        }

        try {
<span class="fc" id="L147">            contextUserUtil.clearContextUser();</span>

<span class="fc" id="L149">            assignedPatientIds = new TreeSet&lt;&gt;();</span>
<span class="fc" id="L150">            patients = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L151">            Set&lt;Long&gt; visiblePatientIds = new TreeSet&lt;&gt;();</span>

<span class="pc bpc" id="L153" title="2 of 6 branches missed.">            if ((searchId == null) &amp;&amp; (searchName == null) &amp;&amp; (searchDobYear == null)) {</span>
<span class="fc" id="L154">                return SUCCESS; // initial call - show nothing</span>
            }

<span class="fc" id="L157">            String searchIdOrNull = null;</span>
<span class="fc bfc" id="L158" title="All 2 branches covered.">            if (isNotBlank(searchId)) {</span>
<span class="fc" id="L159">                searchIdOrNull = PatientSearchUtil.getCleanSearchId(searchId, clinicianNationalIdType, searchIdType).fold(Function.identity(), ValidNationalId::value);</span>
            }

<span class="fc" id="L162">            String searchNameOrNull = null;</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">            if (isNotBlank(searchName)) {</span>
<span class="fc" id="L164">                searchNameOrNull = searchName;</span>
            }

<span class="fc" id="L167">            Integer searchDobYearOrNull = null;</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">            if (isNotBlank(searchDobYear)) {</span>
                try {
<span class="fc" id="L170">                    searchDobYearOrNull = Integer.parseInt(searchDobYear);</span>
<span class="nc" id="L171">                } catch (Exception ignored) {</span>
<span class="nc" id="L172">                    addActionError(getText(&quot;patientsAction.err.invalid_year&quot;));</span>
<span class="nc" id="L173">                    return SUCCESS;</span>
<span class="fc" id="L174">                }</span>
            }

<span class="fc" id="L177">            Integer searchDobMonthOrNull = null;</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">            if (isNotBlank(searchDobMonth)) {</span>
                try {
<span class="fc" id="L180">                    searchDobMonthOrNull = Integer.parseInt(searchDobMonth);</span>
<span class="nc" id="L181">                } catch (Exception ignored) {</span>
<span class="nc" id="L182">                    addActionError(getText(&quot;patientsAction.err.invalid_month&quot;));</span>
<span class="nc" id="L183">                    return SUCCESS;</span>
<span class="fc" id="L184">                }</span>
            }

<span class="fc" id="L187">            Integer searchDobDayOrNull = null;</span>
<span class="fc bfc" id="L188" title="All 2 branches covered.">            if (isNotBlank(searchDobDay)) {</span>
                try {
<span class="fc" id="L190">                    searchDobDayOrNull = Integer.parseInt(searchDobDay);</span>
<span class="nc" id="L191">                } catch (Exception ignored) {</span>
<span class="nc" id="L192">                    addActionError(getText(&quot;patientsAction.err.invalid_day&quot;));</span>
<span class="nc" id="L193">                    return SUCCESS;</span>
<span class="fc" id="L194">                }</span>
            }

            // limit to max + 1 -- if we get over max we'll ask them to use better search criteria
<span class="fc" id="L198">            Integer queryMax = PATIENT_SEARCH_MAX_RESULTS + 1;</span>

<span class="fc" id="L200">            PatientSearchOptionsDto options = ImmutablePatientSearchOptionsDto.searchParams()</span>
<span class="fc" id="L201">                    .searchIdType(searchIdType)</span>
<span class="fc" id="L202">                    .searchId(searchIdOrNull)</span>
<span class="fc" id="L203">                    .searchName(searchNameOrNull)</span>
<span class="fc" id="L204">                    .searchDobYear(searchDobYearOrNull)</span>
<span class="fc" id="L205">                    .searchDobMonth(searchDobMonthOrNull)</span>
<span class="fc" id="L206">                    .searchDobDay(searchDobDayOrNull)</span>
<span class="fc" id="L207">                    .maxRecords(queryMax)</span>
<span class="fc" id="L208">                    .lazies(PKBPerson.Lazy.NATIONAL_AND_LOCAL_IDS, PKBPerson.Lazy.PROPERTIES, PKBPerson.Lazy.CONTACTS)</span>
<span class="fc" id="L209">                    .build();</span>

<span class="fc bfc" id="L211" title="All 2 branches covered.">            if (team != null) {</span>

<span class="fc" id="L213">                patients = patientConsentManager.findConsentingPatientsForTeam(team.getId(), options);</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">                for (PKBPerson p : patients) {</span>
<span class="fc" id="L215">                    assignedPatientIds.add(p.getId());</span>
<span class="fc" id="L216">                }</span>

                // if they're ALREADY over the max, don't bother doing the org search
<span class="pc bpc" id="L219" title="2 of 6 branches missed.">                if ((patients.size() &lt; queryMax) &amp;&amp; (searchLevel != null) &amp;&amp; searchLevel.equals(team.getOrg().getCode())) {</span>
<span class="fc" id="L220">                    patients = teamUserManager.searchAllPatientsForOrg(ImmutableOrgPatientSearchOptionsDto.searchParams()</span>
<span class="fc" id="L221">                            .orgId(team.getOrg().getId())</span>
<span class="fc" id="L222">                            .searchIdType(searchIdType)</span>
<span class="fc" id="L223">                            .searchId(searchIdOrNull)</span>
<span class="fc" id="L224">                            .searchName(searchNameOrNull)</span>
<span class="fc" id="L225">                            .searchDobYear(searchDobYearOrNull)</span>
<span class="fc" id="L226">                            .searchDobMonth(searchDobMonthOrNull)</span>
<span class="fc" id="L227">                            .searchDobDay(searchDobDayOrNull)</span>
<span class="fc" id="L228">                            .maxRecords(queryMax)</span>
<span class="fc" id="L229">                            .lazies(PKBPerson.Lazy.NATIONAL_AND_LOCAL_IDS,</span>
                                    PKBPerson.Lazy.PROPERTIES,
                                    PKBPerson.Lazy.CONTACTS)
<span class="fc" id="L232">                            .build());</span>

                }

<span class="fc" id="L236">                var orgSearchPatientids = patients.stream().map(PKBPerson::getId).collect(Collectors.toUnmodifiableList());</span>
<span class="fc" id="L237">                visiblePatientIds.addAll(orgSearchPatientids);</span>

<span class="fc" id="L239">                assignedPatientIds.addAll(patientConsentManager.getPatientIdsForConsentsInTeam(team.getId(), orgSearchPatientids));</span>


<span class="pc bpc" id="L242" title="1 of 2 branches missed.">                if (patients.size() &lt; queryMax) {</span>
                    // Look for directly-assigned patients that we haven't found so far
<span class="fc" id="L244">                    List&lt;PKBPerson&gt; directlyAssignedPatients = patientConsentManager.findConsentingPatientsForIndividualProfessional(clinicianId, options);</span>

<span class="fc bfc" id="L246" title="All 2 branches covered.">                    for (PKBPerson p : directlyAssignedPatients) {</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">                        if (!visiblePatientIds.contains(p.getId())) {</span>
<span class="fc" id="L248">                            patients.add(p);</span>
                        }
<span class="fc" id="L250">                        assignedPatientIds.add(p.getId());</span>
<span class="fc" id="L251">                    }</span>
                }

<span class="fc" id="L254">            } else {</span>
<span class="fc" id="L255">                patients = patientConsentManager.findConsentingPatientsForIndividualProfessional(clinicianId, options);</span>
<span class="fc" id="L256">                assignedPatientIds.addAll(patients.stream().map(PKBPerson::getId).collect(Collectors.toUnmodifiableList()));</span>
            }

<span class="fc bfc" id="L259" title="All 2 branches covered.">            if (patients.isEmpty()) {</span>
<span class="fc" id="L260">                addActionError(getText(&quot;patientsAction.err.no_matches_found&quot;));</span>
<span class="fc" id="L261">                return SUCCESS;</span>
            }
<span class="nc" id="L263">        } catch (PKBException exception) {</span>
<span class="nc" id="L264">            throw new PKBException(&quot;Error while getting the patient list for &quot; + clinicianId, exception);</span>
<span class="fc" id="L265">        }</span>

<span class="pc bpc" id="L267" title="1 of 2 branches missed.">        if (patients.size() &gt; PATIENT_SEARCH_MAX_RESULTS) {</span>
<span class="nc" id="L268">            addActionError(getText(&quot;patientsAction.err.too_many_patients&quot;));</span>
            // truncate list from 51 to 50 in case of pedants
<span class="nc" id="L270">            patients = patients.subList(0, PATIENT_SEARCH_MAX_RESULTS);</span>
        }

<span class="fc" id="L273">        patients = Ordering.from(ordering.getComparator()).sortedCopy(patients);</span>

<span class="fc" id="L275">        subTab = &quot;patients&quot;;</span>
<span class="fc" id="L276">        return SUCCESS;</span>
    }

    /**
     * used by the myColleagues action
     *
     * @return
     */
    public String myColleagues() {
        try {
<span class="fc" id="L286">            contextUserUtil.clearContextUser();</span>
<span class="fc" id="L287">            PKBPerson user = loggedInUserUtil.getLoggedInPerson();</span>
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">            if (user.isPro()) {</span>
<span class="fc" id="L289">                colleagues = messageWebBean.getColleagues(getEHRRequestContext(), user);</span>
            }
<span class="nc" id="L291">        } catch (PKBException exception) {</span>
<span class="nc" id="L292">            LOGGER.error(&quot;Error while getting the colleague list for {}&quot;, loggedInUserUtil.getLoggedInUserId(), exception);</span>
<span class="fc" id="L293">        }</span>

<span class="fc" id="L295">        subTab = &quot;colleagues&quot;;</span>
<span class="fc" id="L296">        return SUCCESS;</span>
    }

    /**
     * This API is used to fetch the list of patients who shared record
     * with clinician previously
     * &lt;p&gt;
     * Used by the &quot;myPreviousPatients&quot; action.
     *
     * @return
     */
    public String myPreviousPatients() {
<span class="fc" id="L308">        long userId = loggedInUserUtil.getLoggedInUserId();</span>
        try {
<span class="fc" id="L310">            Team team = loggedInUserUtil.getLoggedInUserPrimaryTeam();</span>

<span class="pc bpc" id="L312" title="1 of 2 branches missed.">            if (team != null) {</span>
<span class="nc" id="L313">                prevPatients = patientConsentManager.findPastConsentingPatientsForTeam(team.getId());</span>
            } else {
                // Get all the users this clinician has lost access to
<span class="fc" id="L316">                prevPatients = patientConsentManager.findPastConsentingPatientsForIndividual(userId, AccessingEntityType.INDIVIDUAL);</span>
            }
<span class="nc" id="L318">        } catch (Exception exception) {</span>
<span class="nc" id="L319">            throw new RuntimeException(&quot;Error while getting previously shared patients for &quot; + userId, exception);</span>
<span class="fc" id="L320">        }</span>
<span class="fc" id="L321">        subTab = &quot;prevPatients&quot;;</span>
<span class="fc" id="L322">        return SUCCESS;</span>
    }

    /**
     * This API is used to update contact for an unregistered patient
     *
     * @return
     */
    public String editContact() {
        try {
<span class="nc" id="L332">            patient = userManager.getPKBPerson(Long.valueOf(patientId), PKBPerson.Lazy.CONTACTS);</span>
<span class="nc bnc" id="L333" title="All 2 branches missed.">            if (patient.getStatus() == UserStatus.EMAIL_CONFIRMED) {</span>
<span class="nc" id="L334">                addActionError(getText(&quot;editContactForm.err.patient_already_registered&quot;, new String[] { patient.findEmail().map(Email::address).getOrNull() }));</span>
<span class="nc" id="L335">                return ERROR;</span>
            } else {
                try {
<span class="nc" id="L338">                    Email newContact = disclosingEmail(this.newContact);</span>
<span class="nc" id="L339">                    PKBPerson patientByNewContact = userManager.getSinglePersonByEmail(newContact);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">                    if (patientByNewContact == null) {</span>
                        // new contact can be safely updated
                        try {
<span class="nc" id="L343">                            userManager.beginTransaction();</span>
<span class="nc" id="L344">                            userManager.updateUserPrimaryContact(patientId, newContact);</span>
<span class="nc" id="L345">                            userManager.commitTransaction();</span>

<span class="nc bnc" id="L347" title="All 4 branches missed.">                            if (patient.getStatus() == UserStatus.CREATED || patient.getStatus() == UserStatus.NOCONTACT) {</span>
                                // Cribbed from ManagerContactAction

<span class="nc" id="L350">                                PasswordAccess access = userAccessManager.getPasswordAccess(</span>
<span class="nc" id="L351">                                        patient.getId(), getLoggedInEHRRequestContext());</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">                                if (access == null) {</span>
<span class="nc" id="L353">                                    throw new NullPointerException(&quot;No passwordAccess stored for patient-&quot; + patient.getId()); // TODO: handle this (old user) more politely</span>
                                }
<span class="nc" id="L355">                                patient.setPassword(access.getPassword());</span>
<span class="nc" id="L356">                                pkbEmailMessageManager.notifyPatientOfCreatedAccount(</span>
<span class="nc" id="L357">                                        loggedInUserUtil.getLoggedInUser(), patient, team, &quot;&quot;);</span>

                                // Password should not get carried in rest of the flow
<span class="nc" id="L360">                                patient.setPassword(null);</span>
                            }

<span class="nc" id="L363">                            addActionMessage(getText(&quot;editContactForm.msg.contact_updated&quot;));</span>
                        } finally {
<span class="nc" id="L365">                            userManager.rollbackIfNotCommitted();</span>
<span class="nc" id="L366">                        }</span>
                    } else {
                        // a user with new contact already exits
<span class="nc bnc" id="L369" title="All 2 branches missed.">                        if (patientByNewContact.getId().equals(patientId)) {</span>
                            // email already used for this patient
<span class="nc" id="L371">                            addActionError(getText(&quot;editContactForm.err.email_already_exits_for_user&quot;));</span>
<span class="nc" id="L372">                            return ERROR;</span>
                        } else {
                            // email used by another user
<span class="nc" id="L375">                            addActionError(getText(&quot;editContactForm.err.email_already_used&quot;));</span>
<span class="nc" id="L376">                            return ERROR;</span>
                        }
                    }
<span class="nc" id="L379">                } catch (RuntimeException ignored) {</span>
<span class="nc" id="L380">                    addActionError(getText(&quot;editContactForm.err.invalid_email&quot;));</span>
<span class="nc" id="L381">                    return ERROR;</span>
<span class="nc" id="L382">                }</span>
            }
<span class="nc" id="L384">        } catch (Exception e) {</span>
<span class="nc" id="L385">            LOGGER.error(&quot;error editing contact for {}&quot;, patientId, e);</span>
<span class="nc" id="L386">            addActionError(getText(&quot;editContactForm.err.contact_update_failure&quot;));</span>
<span class="nc" id="L387">        }</span>
<span class="nc" id="L388">        subTab = &quot;patients&quot;;</span>
<span class="nc" id="L389">        return SUCCESS;</span>
    }

    public String cancelContactEdit() {
<span class="nc" id="L393">        subTab = &quot;patients&quot;;</span>
<span class="nc" id="L394">        return &quot;cancelContactEdit&quot;;</span>
    }

    public String editContactForm() {
        try {
<span class="nc" id="L399">            patient = userManager.getPKBPerson(patientId, PKBPerson.Lazy.CONTACTS);</span>
<span class="nc bnc" id="L400" title="All 2 branches missed.">            if (patient.getStatus() == UserStatus.EMAIL_CONFIRMED) {</span>
<span class="nc" id="L401">                addActionError(getText(&quot;patientsAction.err.patient_already_registered&quot;));</span>
<span class="nc" id="L402">                return ERROR;</span>
            } else {
<span class="nc" id="L404">                oldContact = patient.getPrimaryContact().getContactIfEmail().get().address();</span>
            }
<span class="nc" id="L406">        } catch (Exception exception) {</span>
<span class="nc" id="L407">            throw new PKBException(&quot;Error while loading patient email edit form for patient&quot; + patientId,</span>
                    exception);
<span class="nc" id="L409">        }</span>
<span class="nc" id="L410">        subTab = &quot;patients&quot;;</span>
<span class="nc" id="L411">        return SUCCESS;</span>
    }

    public String myAlarms() {
<span class="nc" id="L415">        Team team = loggedInUserUtil.getLoggedInUserPrimaryTeam();</span>
<span class="nc bnc" id="L416" title="All 2 branches missed.">        if (team == null) {</span>
<span class="nc" id="L417">            return &quot;notInstituteUser&quot;;</span>
        }
<span class="nc" id="L419">        redThreshold = team.getSymptomAlarmRedThreshold();</span>

<span class="nc" id="L421">        String teamCode = team.getCode();</span>
<span class="nc" id="L422">        long clinicianId = loggedInUserUtil.getLoggedInUserId();</span>

        //long startTime = System.nanoTime();
<span class="nc" id="L425">        notActivated = false;</span>
        try {
<span class="nc" id="L427">            alarms = symptomReportManager.getSymptomAlarms(getLoggedInEHRRequestContext(), teamCode);</span>
<span class="nc" id="L428">        } catch (PKBException exception) {</span>
<span class="nc bnc" id="L429" title="All 4 branches missed.">            if ((exception.getCause() != null) &amp;&amp; &quot;Your account has not been activated&quot;.equals(exception.getCause().getMessage())) {</span>
<span class="nc" id="L430">                notActivated = true;</span>
            } else {
<span class="nc" id="L432">                throw exception;</span>
            }
<span class="nc" id="L434">        }</span>

        // Get column names from alarms rather than make another backend call
        // TODO have yet another DTO to carry List&lt;String&gt; columnNames,List&lt;SymptomAlarmDTO&gt; rows
<span class="nc bnc" id="L438" title="All 4 branches missed.">        if ((alarms != null) &amp;&amp; !alarms.isEmpty()) {</span>
<span class="nc" id="L439">            int numberOfColumns = alarms.get(0).getSymptomDataList().size();</span>
            //int numberOfColumns = alarms.get(0).getSymptomReports().size();
<span class="nc" id="L441">            columnNames = new Vector&lt;&gt;();</span>
<span class="nc" id="L442">            columnNames.setSize(numberOfColumns);</span>

<span class="nc bnc" id="L444" title="All 2 branches missed.">            for (int n = 0; n &lt; numberOfColumns; ++n) {</span>
<span class="nc bnc" id="L445" title="All 2 branches missed.">                for (SymptomAlarmDTO alarm : alarms) {</span>
<span class="nc" id="L446">                    AlarmSymptomData alarmSymptomData = alarm.getSymptomDataList().get(n);</span>
                    //SymptomReportDTO symptomReportDTO = alarm.getSymptomReports().get(n);
<span class="nc bnc" id="L448" title="All 2 branches missed.">                    if (alarmSymptomData != null) {</span>
<span class="nc" id="L449">                        columnNames.set(n, Symptom.getById(alarmSymptomData.getSymptomId()).getName());</span>
<span class="nc" id="L450">                        break;</span>
                    }
<span class="nc" id="L452">                }</span>
            }
        }
<span class="nc" id="L455">        return SUCCESS;</span>
    }

    public String inviteOrgPatient() {
<span class="fc" id="L459">        team = loggedInUserUtil.getLoggedInUserPrimaryTeam();</span>
<span class="pc bpc" id="L460" title="1 of 2 branches missed.">        if (team == null) {</span>
<span class="nc" id="L461">            return &quot;notInstituteUser&quot;;</span>
        }

<span class="fc bfc" id="L464" title="All 2 branches covered.">        if (userManager.findIdentityVerification(patientId).isEmpty()) {</span>
<span class="fc" id="L465">            addActionError(getText(&quot;patientsAction.err.patient_must_be_activated_by_inviting_team&quot;));</span>
<span class="fc bfc" id="L466" title="All 2 branches covered.">            if (getLoggedInEHRRequestContext().isTeamCoordinator()) {</span>
<span class="fc" id="L467">                return &quot;unverifiedPatientForCoord&quot;;</span>
            } else {
<span class="fc" id="L469">                return &quot;unverifiedPatientForPro&quot;;</span>
            }
        }

<span class="fc" id="L473">        return &quot;consentRequired&quot;;</span>
    }

    public boolean isPatientOfTeamAndRegistered(PKBPerson patient) {
<span class="pc bpc" id="L477" title="1 of 4 branches missed.">        return loggedInUserUtil.isLoggedInUserTeamProfessional() &amp;&amp; patient.isEmailConfirmed();</span>
    }

    public UserManager getUserManager() {
<span class="nc" id="L481">        return userManager;</span>
    }

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L485">        this.userManager = userManager;</span>
<span class="fc" id="L486">    }</span>

    public IMessageWebBean getMessageWebBean() {
<span class="nc" id="L489">        return messageWebBean;</span>
    }

    public void setMessageWebBean(IMessageWebBean messageWebBean) {
<span class="fc" id="L493">        this.messageWebBean = messageWebBean;</span>
<span class="fc" id="L494">    }</span>

    public List&lt;PKBPerson&gt; getPrevPatients() {
<span class="fc" id="L497">        return prevPatients;</span>
    }

    public void setPrevPatients(List&lt;PKBPerson&gt; prevPatients) {
<span class="nc" id="L501">        this.prevPatients = prevPatients;</span>
<span class="nc" id="L502">    }</span>

    public List&lt;InstituteUser&gt; getColleagues() {
<span class="fc" id="L505">        return colleagues;</span>
    }

    public Set&lt;Long&gt; getAssignedPatientIds() {
<span class="fc" id="L509">        return assignedPatientIds;</span>
    }

    public void setAssignedPatientIds(Set&lt;Long&gt; assignedPatientIds) {
<span class="nc" id="L513">        this.assignedPatientIds = assignedPatientIds;</span>
<span class="nc" id="L514">    }</span>

    public void setColleagues(List&lt;InstituteUser&gt; colleagues) {
<span class="nc" id="L517">        this.colleagues = colleagues;</span>
<span class="nc" id="L518">    }</span>

    public List&lt;PKBPerson&gt; getPatients() {
<span class="fc" id="L521">        return patients;</span>
    }

    public void setPatients(List&lt;PKBPerson&gt; patients) {
<span class="nc" id="L525">        this.patients = patients;</span>
<span class="nc" id="L526">    }</span>

    public Long getRedThreshold() {
<span class="nc" id="L529">        return redThreshold;</span>
    }

    public void setRedThreshold(Long redThreshold) {
<span class="nc" id="L533">        this.redThreshold = redThreshold;</span>
<span class="nc" id="L534">    }</span>

    public UserAccessManager getUserAccessManager() {
<span class="nc" id="L537">        return userAccessManager;</span>
    }

    public void setUserAccessManager(UserAccessManager userAccessManager) {
<span class="fc" id="L541">        this.userAccessManager = userAccessManager;</span>
<span class="fc" id="L542">    }</span>

    public TeamUserManager getTeamUserManager() {
<span class="nc" id="L545">        return teamUserManager;</span>
    }

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L549">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L550">    }</span>

    public Team getTeam() {
<span class="fc" id="L553">        return team;</span>
    }

    public void setTeam(Team team) {
<span class="nc" id="L557">        this.team = team;</span>
<span class="nc" id="L558">    }</span>

    public PersonOrderingHelper getOrdering() {
<span class="fc" id="L561">        return ordering;</span>
    }

    public void setOrdering(PersonOrderingHelper ordering) {
<span class="nc" id="L565">        this.ordering = ordering;</span>
<span class="nc" id="L566">    }</span>

    public String getTab() {
<span class="fc" id="L569">        return tab;</span>
    }

    public String getSubTab() {
<span class="fc" id="L573">        return subTab;</span>
    }

    public PKBPersonDTO getPatientDTO() {
<span class="nc" id="L577">        return patientDTO;</span>
    }

    public void setPatientDTO(PKBPersonDTO patientDTO) {
<span class="nc" id="L581">        this.patientDTO = patientDTO;</span>
<span class="nc" id="L582">    }</span>

    public String getNationalId() {
<span class="nc" id="L585">        return nationalId;</span>
    }

    public void setNationalId(String nationalId) {
<span class="nc" id="L589">        this.nationalId = nationalId;</span>
<span class="nc" id="L590">    }</span>

    public String getNationalIdName() {
<span class="nc" id="L593">        return nationalIdName;</span>
    }

    public void setNationalIdName(String nationalIdName) {
<span class="nc" id="L597">        this.nationalIdName = nationalIdName;</span>
<span class="nc" id="L598">    }</span>

    public List&lt;String&gt; getGroupedOrgLevelIds() {
<span class="nc" id="L601">        return groupedOrgLevelIds;</span>
    }

    public void setGroupedOrgLevelIds(List&lt;String&gt; groupedOrgLevelIds) {
<span class="nc" id="L605">        this.groupedOrgLevelIds = groupedOrgLevelIds;</span>
<span class="nc" id="L606">    }</span>

    public List&lt;OrgLevelIdType&gt; getOrgLevelIdTypes() {
<span class="nc" id="L609">        return orgLevelIdTypes;</span>
    }

    public void setOrgLevelIdTypes(List&lt;OrgLevelIdType&gt; orgLevelIdTypes) {
<span class="nc" id="L613">        this.orgLevelIdTypes = orgLevelIdTypes;</span>
<span class="nc" id="L614">    }</span>

    public List&lt;String&gt; getGroupedTeamLevelIds() {
<span class="nc" id="L617">        return groupedTeamLevelIds;</span>
    }

    public void setGroupedTeamLevelIds(List&lt;String&gt; groupedTeamLevelIds) {
<span class="nc" id="L621">        this.groupedTeamLevelIds = groupedTeamLevelIds;</span>
<span class="nc" id="L622">    }</span>

    public List&lt;TeamLevelIdType&gt; getTeamLevelIdTypes() {
<span class="nc" id="L625">        return teamLevelIdTypes;</span>
    }

    public void setTeamLevelIdTypes(List&lt;TeamLevelIdType&gt; teamLevelIdTypes) {
<span class="nc" id="L629">        this.teamLevelIdTypes = teamLevelIdTypes;</span>
<span class="nc" id="L630">    }</span>

    public void setSubTab(String subTab) {
<span class="fc" id="L633">        this.subTab = subTab;</span>
<span class="fc" id="L634">    }</span>

    public SymptomReportManager getSymptomReportManager() {
<span class="nc" id="L637">        return symptomReportManager;</span>
    }

    public void setSymptomReportManager(SymptomReportManager symptomReportManager) {
<span class="fc" id="L641">        this.symptomReportManager = symptomReportManager;</span>
<span class="fc" id="L642">    }</span>

    public List&lt;SymptomAlarmDTO&gt; getAlarms() {
<span class="nc" id="L645">        return alarms;</span>
    }

    public void setAlarms(List&lt;SymptomAlarmDTO&gt; alarms) {
<span class="nc" id="L649">        this.alarms = alarms;</span>
<span class="nc" id="L650">    }</span>

    public Vector&lt;String&gt; getColumnNames() {
<span class="nc" id="L653">        return columnNames;</span>
    }

    public void setColumnNames(Vector&lt;String&gt; columnNames) {
<span class="nc" id="L657">        this.columnNames = columnNames;</span>
<span class="nc" id="L658">    }</span>

    public boolean getNotActivated() {
<span class="nc" id="L661">        return notActivated;</span>
    }

    public void setNotActivated(boolean notActivated) {
<span class="nc" id="L665">        this.notActivated = notActivated;</span>
<span class="nc" id="L666">    }</span>

    public NationalIdType getClinicianNationalIdType() {
<span class="fc" id="L669">        return clinicianNationalIdType;</span>
    }

    public void setClinicianNationalIdType(NationalIdType clinicianNationalIdType) {
<span class="nc" id="L673">        this.clinicianNationalIdType = clinicianNationalIdType;</span>
<span class="nc" id="L674">    }</span>

    public Long getPatientId() {
<span class="fc" id="L677">        return patientId;</span>
    }

    public void setPatientId(Long patientId) {
<span class="fc" id="L681">        this.patientId = patientId;</span>
<span class="fc" id="L682">    }</span>

    public PKBPerson getPatient() {
<span class="nc" id="L685">        return patient;</span>
    }

    public void setPatient(PKBPerson patient) {
<span class="nc" id="L689">        this.patient = patient;</span>
<span class="nc" id="L690">    }</span>

    public String getNewContact() {
<span class="nc" id="L693">        return newContact;</span>
    }

    public void setNewContact(String newContact) {
<span class="nc" id="L697">        this.newContact = newContact;</span>
<span class="nc" id="L698">    }</span>

    public String getOldContact() {
<span class="nc" id="L701">        return oldContact;</span>
    }

    public void setOldContact(String oldContact) {
<span class="nc" id="L705">        this.oldContact = oldContact;</span>
<span class="nc" id="L706">    }</span>

    public String getSearchName() {
<span class="fc" id="L709">        return searchName;</span>
    }

    public void setSearchName(String searchName) {
<span class="fc" id="L713">        this.searchName = searchName;</span>
<span class="fc" id="L714">    }</span>

    public String getSearchDobYear() {
<span class="fc" id="L717">        return searchDobYear;</span>
    }

    public void setSearchDobYear(String searchDobYear) {
<span class="fc" id="L721">        this.searchDobYear = searchDobYear;</span>
<span class="fc" id="L722">    }</span>

    public String getSearchLevel() {
<span class="fc" id="L725">        return searchLevel;</span>
    }

    public void setSearchLevel(String searchLevel) {
<span class="fc" id="L729">        this.searchLevel = searchLevel;</span>
<span class="fc" id="L730">    }</span>

    public String getTeamName() {
<span class="fc" id="L733">        return teamName;</span>
    }

    public void setTeamName(String teamName) {
<span class="nc" id="L737">        this.teamName = teamName;</span>
<span class="nc" id="L738">    }</span>

    public String getOrgName() {
<span class="fc" id="L741">        return orgName;</span>
    }

    public void setOrgName(String orgName) {
<span class="nc" id="L745">        this.orgName = orgName;</span>
<span class="nc" id="L746">    }</span>

    public String getSearchIdType() {
<span class="fc" id="L749">        return searchIdType;</span>
    }

    public void setSearchIdType(String searchIdType) {
<span class="fc" id="L753">        this.searchIdType = searchIdType;</span>
<span class="fc" id="L754">    }</span>

    public String getSearchId() {
<span class="fc" id="L757">        return searchId;</span>
    }

    public void setSearchId(String searchId) {
<span class="fc" id="L761">        this.searchId = searchId;</span>
<span class="fc" id="L762">    }</span>

    public String getSearchDobMonth() {
<span class="fc" id="L765">        return searchDobMonth;</span>
    }

    public void setSearchDobMonth(String searchDobMonth) {
<span class="fc" id="L769">        this.searchDobMonth = searchDobMonth;</span>
<span class="fc" id="L770">    }</span>

    public String getSearchDobDay() {
<span class="fc" id="L773">        return searchDobDay;</span>
    }

    public PKBEmailMessageManager getPkbEmailMessageManager() {
<span class="nc" id="L777">        return pkbEmailMessageManager;</span>
    }

    public void setPkbEmailmessageManager(PKBEmailMessageManager pkbEmailMessageManager) {
<span class="nc" id="L781">        this.pkbEmailMessageManager = pkbEmailMessageManager;</span>
<span class="nc" id="L782">    }</span>

    public void setSearchDobDay(String searchDobDay) {
<span class="fc" id="L785">        this.searchDobDay = searchDobDay;</span>
<span class="fc" id="L786">    }</span>

    public void setPkbEmailMessageManager(PKBEmailMessageManager pkbEmailMessageManager) {
<span class="fc" id="L789">        this.pkbEmailMessageManager = pkbEmailMessageManager;</span>
<span class="fc" id="L790">    }</span>

    public List&lt;Questionnaire&gt; getQuestionnaires() {
<span class="fc" id="L793">        return questionnaires;</span>
    }

    public void setQuestionnaireManager(QuestionnaireManager questionnaireManager) {
<span class="fc" id="L797">        this.questionnaireManager = questionnaireManager;</span>
<span class="fc" id="L798">    }</span>

    public PatientConsentManager getPatientConsentManager() {
<span class="nc" id="L801">        return patientConsentManager;</span>
    }

    public void setPatientConsentManager(PatientConsentManager patientConsentManager) {
<span class="fc" id="L805">        this.patientConsentManager = patientConsentManager;</span>
<span class="fc" id="L806">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>