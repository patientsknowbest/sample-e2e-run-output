<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PatientTeamAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.team</a> &gt; <span class="el_source">PatientTeamAction.java</span></div><h1>PatientTeamAction.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------

//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: GetInvitatonsAction.java Jun 3, 2009 2:35:47 PM mahendera$
//
//------------------------------------------------------------------------------
package com.pkb.action.team;

import com.google.common.base.Functions;
import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.datamodel.consent.PatientConsentDTO;
import com.pkb.entities.enums.AccessingEntityType;
import com.pkb.exception.PKBException;
import com.pkb.institute.entity.Team;
import com.pkb.service.invitation.impl.InvitationManager;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.UserAccessManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PKBPerson.Lazy;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Comparator;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;

import static java.util.Collections.emptyList;

/**
 * Shows all other users that currently have access to this patient's account
 *
 * @author robwhelan
 *
 */
<span class="fc" id="L42">public class PatientTeamAction extends BaseAction {</span>

    private static final long serialVersionUID = 1L;
<span class="fc" id="L45">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private TeamManager teamManager;
    private UserAccessManager userAccessManager;
    private InvitationManager invitationManager;
    private TeamUserManager teamUserManager;

    private PatientConsentManager patientConsentManager;

    private List&lt;PKBPerson&gt; prevClinicians;
    private List&lt;PKBPerson&gt; prevCarers;
    private List&lt;Team&gt; prevTeams;
    private List&lt;PKBPerson&gt; dependents;

    @SuppressWarnings(&quot;deprecation&quot;)
    private PatientConsentManager.ConsentLinks consentLinks;
    private Map&lt;Long, PatientConsentDTO&gt; dependentsConsentMap;

<span class="fc" id="L63">    private String tab = &quot;invitations&quot;;</span>
    private String subTab;

    private boolean clearContext;
    private boolean isTeamUser;

    // For /admin/listPatientTeam.jsp
    private Long patientId;
    private PKBPerson patient;

    // ------- initial pass at access roles -----------
    private Long userId;
    private Long permission;



    public String listPatientTeam() {
<span class="fc" id="L80">        String result = Action.SUCCESS;</span>
        try {
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">            if (patientId == null) {</span>
<span class="nc" id="L83">                patientId = userId;</span>
            }
<span class="fc" id="L85">            patient = userManager.getPKBPerson(patientId, Lazy.PROPERTIES);</span>
<span class="fc" id="L86">            loadLinks(patientId, false);</span>
<span class="nc" id="L87">        } catch (Exception exception) {</span>
<span class="nc" id="L88">            result = Action.ERROR;</span>
<span class="nc" id="L89">            LOGGER.error(&quot;Error while getting team list&quot;, exception);</span>
<span class="fc" id="L90">        }</span>
<span class="fc" id="L91">        return result;</span>
    }

    public String myPreviousClinicians() {
<span class="fc" id="L95">        String result = Action.SUCCESS;</span>
        try {
<span class="fc" id="L97">            contextUserId = contextUserUtil.getContextUserId();</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">            userId = contextUserId == null ? loggedInUserUtil.getLoggedInUserId() : contextUserId;</span>

<span class="fc" id="L100">            loadLinks(userId, true);</span>
            // Get all the clinicians with no more access to the patient's account
<span class="fc" id="L102">            prevClinicians = consentLinks.getPreviouslySharedClinicians();</span>

            // Get all the carers with no more access to the patient's account
<span class="fc" id="L105">            prevCarers = consentLinks.getPreviouslySharedCarers();</span>


<span class="fc" id="L108">            prevTeams = consentLinks.getPreviouslySharedTeams();</span>

<span class="nc" id="L110">        } catch (Exception exception) {</span>
<span class="nc" id="L111">            result = Action.ERROR;</span>
<span class="nc" id="L112">            LOGGER.error(&quot;Error while getting previously shared users&quot;, exception);</span>
<span class="fc" id="L113">        }</span>

<span class="fc" id="L115">        return result;</span>
    }

    /**
     * This is the action for displaying carers and dependents
     *
     */
    public String viewDependents() {
<span class="fc" id="L123">        String result = Action.SUCCESS;</span>
        try {
<span class="fc bfc" id="L125" title="All 2 branches covered.">            if (clearContext) {</span>
<span class="fc" id="L126">                contextUserUtil.clearContextUser();</span>
<span class="fc" id="L127">                subTab = &quot;dependents&quot;;</span>
            }

<span class="fc" id="L130">            userId = loggedInUserUtil.getLoggedInUserId();</span>
<span class="fc" id="L131">            contextUserId = contextUserUtil.getContextUserId();</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">            if (contextUserId != null) {</span>
<span class="fc" id="L133">                userId = contextUserId;</span>
            }

<span class="fc" id="L136">            isTeamUser = teamUserManager.isTeamUser(loggedInUserUtil.getLoggedInUserId());</span>

<span class="pc bpc" id="L138" title="1 of 2 branches missed.">            if (getEHRRequestContext().isTeamDataViewOnly()) {</span>
<span class="nc" id="L139">                dependents = emptyList();</span>
            } else {
<span class="fc" id="L141">                loadLinks(userId, false);</span>
<span class="fc" id="L142">                loadDependentList(userId);</span>
            }

<span class="nc" id="L145">        } catch (Exception exception) {</span>
<span class="nc" id="L146">            result = Action.ERROR;</span>
<span class="nc" id="L147">            LOGGER.error(&quot;Error while getting dependents&quot;, exception);</span>
<span class="fc" id="L148">        }</span>

<span class="fc" id="L150">        return result;</span>
    }

    private void loadLinks(long userId, boolean includeDischarged) {
        try {
<span class="fc" id="L155">            consentLinks = patientConsentManager.getConsentLinks(getLoggedInEHRRequestContext(), userId, includeDischarged);</span>
<span class="nc" id="L156">        } catch (PKBException ex) {</span>
<span class="nc" id="L157">            LOGGER.error(&quot;error loading teams for {}&quot;, userId, ex);</span>
<span class="fc" id="L158">        }</span>
<span class="fc" id="L159">    }</span>

    /**
     * @param userId
     */
    private void loadDependentList(long userId) {

<span class="fc" id="L166">        dependentsConsentMap = patientConsentManager.findAllPatientConsentsForIndividual(userId, AccessingEntityType.CARER)</span>
<span class="fc" id="L167">                .stream()</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">                .filter(consent -&gt; !consent.discharged())</span>
<span class="fc" id="L169">                .collect(Collectors.toMap(PatientConsentDTO::patientPersonId, Functions.identity()));</span>

<span class="fc" id="L171">        dependents = userManager.getPKBPersonList(dependentsConsentMap.keySet(), Lazy.CONTACTS);</span>
<span class="fc" id="L172">        dependents.sort(Comparator.comparing(PKBPerson::getLastName).thenComparing(PKBPerson::getFirstName));</span>
<span class="fc" id="L173">    }</span>


    public Long getPatientId() {
<span class="fc" id="L177">        return patientId;</span>
    }

    public PKBPerson getPatient() {
<span class="fc" id="L181">        return patient;</span>
    }

    public void setPatientId(Long patientId) {
<span class="fc" id="L185">        this.patientId = patientId;</span>
<span class="fc" id="L186">    }</span>

    public void setPatient(PKBPerson patient) {
<span class="nc" id="L189">        this.patient = patient;</span>
<span class="nc" id="L190">    }</span>

    public TeamUserManager getTeamUserManager() {
<span class="nc" id="L193">        return teamUserManager;</span>
    }

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L197">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L198">    }</span>

    public TeamManager getTeamManager() {
<span class="nc" id="L201">        return teamManager;</span>
    }

    public void setTeamManager(TeamManager teamManager) {
<span class="fc" id="L205">        this.teamManager = teamManager;</span>
<span class="fc" id="L206">    }</span>

    public UserManager getUserManager() {
<span class="nc" id="L209">        return userManager;</span>
    }

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L213">        this.userManager = userManager;</span>
<span class="fc" id="L214">    }</span>

    public UserAccessManager getUserAccessManager() {
<span class="nc" id="L217">        return userAccessManager;</span>
    }

    public void setUserAccessManager(UserAccessManager userAccessManager) {
<span class="fc" id="L221">        this.userAccessManager = userAccessManager;</span>
<span class="fc" id="L222">    }</span>

    public InvitationManager getInvitationManager() {
<span class="nc" id="L225">        return invitationManager;</span>
    }

    public void setInvitationManager(InvitationManager invitationManager) {
<span class="fc" id="L229">        this.invitationManager = invitationManager;</span>
<span class="fc" id="L230">    }</span>

    public List&lt;PKBPerson&gt; getPrevClinicians() {
<span class="fc" id="L233">        return prevClinicians;</span>
    }

    public void setPrevClinicians(List&lt;PKBPerson&gt; prevClinicians) {
<span class="nc" id="L237">        this.prevClinicians = prevClinicians;</span>
<span class="nc" id="L238">    }</span>

    public String getTab() {
<span class="fc" id="L241">        return tab;</span>
    }

    public void setTab(String tab) {
<span class="fc" id="L245">        this.tab = tab;</span>
<span class="fc" id="L246">    }</span>

    public List&lt;PKBPerson&gt; getDependents() {
<span class="fc" id="L249">        return dependents;</span>
    }

    public void setDependents(List&lt;PKBPerson&gt; dependents) {
<span class="nc" id="L253">        this.dependents = dependents;</span>
<span class="nc" id="L254">    }</span>

    public String getSubTab() {
<span class="fc" id="L257">        return subTab;</span>
    }

    public void setSubTab(String subTab) {
<span class="fc" id="L261">        this.subTab = subTab;</span>
<span class="fc" id="L262">    }</span>

    public boolean isClearContext() {
<span class="nc" id="L265">        return clearContext;</span>
    }

    public void setClearContext(boolean clearContext) {
<span class="fc" id="L269">        this.clearContext = clearContext;</span>
<span class="fc" id="L270">    }</span>

    public List&lt;PKBPerson&gt; getPrevCarers() {
<span class="fc" id="L273">        return prevCarers;</span>
    }

    public void setPrevCarers(List&lt;PKBPerson&gt; prevCarers) {
<span class="nc" id="L277">        this.prevCarers = prevCarers;</span>
<span class="nc" id="L278">    }</span>

    public boolean getIsTeamUser() {
<span class="nc" id="L281">        return isTeamUser;</span>
    }

    public void setTeamUser(boolean isTeamUser) {
<span class="nc" id="L285">        this.isTeamUser = isTeamUser;</span>
<span class="nc" id="L286">    }</span>

    public Long getUserId() {
<span class="nc" id="L289">        return userId;</span>
    }

    public Long getPermission() {
<span class="nc" id="L293">        return permission;</span>
    }

    public void setUserId(Long userId) {
<span class="nc" id="L297">        this.userId = userId;</span>
<span class="nc" id="L298">    }</span>

    public void setPermission(Long permission) {
<span class="nc" id="L301">        this.permission = permission;</span>
<span class="nc" id="L302">    }</span>

    public PatientConsentManager getPatientConsentManager() {
<span class="nc" id="L305">        return patientConsentManager;</span>
    }

    public void setPatientConsentManager(PatientConsentManager patientConsentManager) {
<span class="fc" id="L309">        this.patientConsentManager = patientConsentManager;</span>
<span class="fc" id="L310">    }</span>

    public PatientConsentManager.ConsentLinks getConsentLinks() {
<span class="fc" id="L313">        return consentLinks;</span>
    }

    public void setConsentLinks(PatientConsentManager.ConsentLinks consentLinks) {
<span class="nc" id="L317">        this.consentLinks = consentLinks;</span>
<span class="nc" id="L318">    }</span>

    public Map&lt;Long, PatientConsentDTO&gt; getDependentsConsentMap() {
<span class="fc" id="L321">        return dependentsConsentMap;</span>
    }

    public List&lt;Team&gt; getPrevTeams() {
<span class="fc" id="L325">        return prevTeams;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>