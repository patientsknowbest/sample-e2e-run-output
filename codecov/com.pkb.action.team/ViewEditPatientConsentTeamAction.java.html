<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ViewEditPatientConsentTeamAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.team</a> &gt; <span class="el_source">ViewEditPatientConsentTeamAction.java</span></div><h1>ViewEditPatientConsentTeamAction.java</h1><pre class="source lang-java linenums">/*

 * Copyright 2015 Patients Know Best
 */
package com.pkb.action.team;

import com.google.common.collect.Lists;
import com.google.common.collect.Maps;
import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.bean.IUserWebBean;
import com.pkb.bean.impl.UserWebBean;
import com.pkb.common.util.FrameFilter;
import com.pkb.consent.entity.PatientConsent;
import com.pkb.consent.entity.PatientConsentReason;
import com.pkb.datamodel.consent.ImmutablePatientAdditionalConsent;
import com.pkb.datamodel.consent.PatientAdditionalConsent;
import com.pkb.datamodel.consent.PatientConsentDTO;
import com.pkb.dto.AdditionalConsentsDto;
import com.pkb.entities.enums.AccessingEntityType;
import com.pkb.entities.enums.ConsentReason;
import com.pkb.entities.enums.UserType;
import com.pkb.exception.PKBException;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.patientconsent.DeprecatedPatientConsentManager;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.user.entity.PKBPerson;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.List;
import java.util.Optional;

import static java.lang.String.format;

/**
 * import io.vavr.Tuple2;
 * import org.apache.commons.lang3.StringUtils;
 * import org.slf4j.Logger;
 * import org.slf4j.LoggerFactory;
 * &lt;p&gt;
 * import java.util.List;
 * import java.util.Map;
 * import java.util.Optional;
 * &lt;p&gt;
 * import static java.lang.String.format;
 * &lt;p&gt;
 * /**
 * &lt;p&gt;
 * &lt;p&gt;
 * &lt;p&gt;
 * import java.util.List;
 * import java.util.Map;
 * import java.util.Optional;
 * &lt;p&gt;
 * import static java.lang.String.format;
 * &lt;p&gt;
 * /**
 *
 * @author Russ Gray &lt;russ.gray@patientsknowbest.com&gt;
 */
<span class="fc" id="L70">public class ViewEditPatientConsentTeamAction extends BaseAction {</span>

    private static final long serialVersionUID = 7932999669666153334L;
<span class="fc" id="L73">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

<span class="fc" id="L75">    private static final String NO_ERROR = null;</span>

    private TeamUserManager teamUserManager;
    private TeamManager teamManager;
    private IUserWebBean userWebBean;
    private PatientConsentManager patientConsentManager;

    private PKBEmailMessageManager pkbEmailMessageManager;

    private DeprecatedPatientConsentManager deprecatedPatientConsentManager;

    private Long teamId;
    private Team team;
    private PatientConsent patientConsent;
    private List&lt;ConsentReason&gt; consentReasons;
    private String selectedReason;
    private String freeTextReason;

    private String proEditOnlyReason;

    // Only used if the logged-in user is a carer. This is used to restrict
    // carers to only grant their own level of consent to new carers or pros
    private PatientConsentDTO loggedInCarerConsent;

    /**
     * for discharge flow. normally the sharing toggle default to &quot;on&quot; in this view
     */
<span class="fc" id="L102">    private boolean autoStopSharing = false;</span>

<span class="fc" id="L104">    private AdditionalConsentsDto additionalConsentsDto = new AdditionalConsentsDto();</span>
    private boolean grantedCustomConsent;

    private boolean allowDefaultConsentFromTeam;

    private boolean patientSelfView;
    private boolean patientUnder18;

    public String view() {

<span class="fc" id="L114">        var requestContext = getLoggedInEHRRequestContext();</span>

<span class="fc bfc" id="L116" title="All 2 branches covered.">        if (!requestContext.isSharingEnabled()) {</span>
<span class="fc" id="L117">            LOGGER.error(&quot;Sharing is not enabled for the patient&quot;);</span>
<span class="fc" id="L118">            addActionError(getText(&quot;patientEditConsentTeam.err.sharing_disabled&quot;));</span>
<span class="fc" id="L119">            return Action.SUCCESS;</span>
        }

<span class="fc" id="L122">        long patientId = requestContext.getContextOrAccessingUserId();</span>

        try {
            // TODO: teamId not set? Redirect

<span class="fc bfc" id="L127" title="All 2 branches covered.">            if (team == null) { // load if needed</span>
<span class="fc" id="L128">                team = teamManager.getTeam(teamId);</span>
            }

            // TODO: Confirm patient consent can't be null here, since the path in to this
            // screen filters out any team where consent record doesn't exist
<span class="fc" id="L133">            patientConsent = deprecatedPatientConsentManager.findPatientConsentWithReasons(requestContext, patientId, teamId, AccessingEntityType.TEAM).orElse(null);</span>

<span class="pc bpc" id="L135" title="1 of 4 branches missed.">            if (patientConsent == null &amp;&amp; allowDefaultConsentFromTeam) {</span>
<span class="fc" id="L136">                LOGGER.error(&quot;No patient consent for patient {}, and allowing default consent for team {} with user {}&quot;,</span>
<span class="fc" id="L137">                        patientId, teamId, requestContext.getAccessingUserId(),</span>
<span class="fc" id="L138">                        FrameFilter.filter(new Exception(&quot;Building default consent for user and team&quot;).fillInStackTrace()));</span>

<span class="fc" id="L140">                patientConsent = new PatientConsent.Builder(team.getId(), requestContext.getAccessingUserId(),</span>
<span class="fc" id="L141">                        requestContext.getAccessingUserId(), AccessingEntityType.TEAM, dateTimeService.now())</span>
<span class="fc" id="L142">                        .setAllCategories(team, ConsentReason.EXPLICIT_CONSENT)</span>
<span class="fc" id="L143">                        .route(requestContext.getAccessRoute())</span>
<span class="fc" id="L144">                        .build();</span>
            }

<span class="pc bpc" id="L147" title="2 of 4 branches missed.">            if ((patientConsent != null) &amp;&amp; patientConsent.isProEditOnlyForChild()) {</span>
<span class="nc" id="L148">                proEditOnlyReason = patientConsent.getReasons().getProEditOnlyForChildReasonText();</span>
            }

<span class="fc" id="L151">            additionalConsentsDto.setSelected(Maps.newEnumMap(teamUserManager.getAdditionalConsents(patientId, teamId)));</span>
<span class="fc" id="L152">            additionalConsentsDto.setTeamName(team.getName());</span>
<span class="fc" id="L153">            additionalConsentsDto.setOrgName(team.getOrg().getName());</span>
<span class="fc" id="L154">            additionalConsentsDto.setPartners(teamManager.getResearchPartners(team.getId()));</span>

<span class="fc bfc" id="L156" title="All 2 branches covered.">            if (requestContext.isCarer()) {</span>
<span class="fc" id="L157">                loggedInCarerConsent = requestContext.getConsentStatus().getConsent().orElse(null);</span>
            }

<span class="fc" id="L160">            var users = getContextAndLoggedInUsers(requestContext);</span>

<span class="fc bfc" id="L162" title="All 4 branches covered.">            patientSelfView = requestContext.isPatient() &amp;&amp; requestContext.isUserInOwnAccount();</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">            if (patientSelfView) {</span>
<span class="fc" id="L164">                patientUnder18 = personHelper.isUnderAge(18, users.loggedInUser()).orElse(true);</span>
            } else {
<span class="fc" id="L166">                patientUnder18 = personHelper.isUnderAge(18, users.contextUser()).orElse(true);</span>
            }
<span class="nc" id="L168">        } catch (RuntimeException ex) {</span>
<span class="nc" id="L169">            LOGGER.error(&quot;failed to load team {} for patient {}&quot;, teamId, patientId, ex);</span>
<span class="nc" id="L170">            return Action.ERROR;</span>
<span class="fc" id="L171">        }</span>

<span class="fc" id="L173">        prepareConsentReasons();</span>

<span class="fc" id="L175">        return Action.SUCCESS;</span>
    }

    private void prepareConsentReasons() {
<span class="fc" id="L179">        consentReasons = Lists.newArrayList(ConsentReason.userSelectableValues());</span>

        //PHR-1359 - don't show discharge reason when doing a 'normal' sharing update
<span class="fc bfc" id="L182" title="All 2 branches covered.">        if (selectedReason == null ||</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">                !selectedReason.equals(ConsentReason.DISCHARGE.toString())) {</span>
<span class="fc" id="L184">            consentReasons.remove(ConsentReason.DISCHARGE);</span>
        }
<span class="fc" id="L186">    }</span>

    public String viewForDischarge() {
        // current user is a professional, discharging the patient from their own team.
        // this works for

        // force to the current professional's team (ignore teamId)
<span class="fc" id="L193">        team = loggedInUserUtil.getLoggedInUserPrimaryTeam();</span>
<span class="fc" id="L194">        teamId = team.getId();</span>

<span class="fc" id="L196">        autoStopSharing = true;</span>
        // also set default reason selection and detail
<span class="fc" id="L198">        selectedReason = ConsentReason.DISCHARGE.toString();</span>
<span class="fc" id="L199">        freeTextReason = getText(&quot;patientEditConsentTeam.txt.discharge_reason&quot;); // this doesn't get picked up!  hacking into the JSP for now</span>

<span class="fc" id="L201">        addActionMessage(getText(&quot;viewEditPatientConsentTeamAction.msg.save_to_discharge&quot;));</span>

<span class="fc" id="L203">        return view();</span>
    }

    public String edit() {
<span class="fc" id="L207">        var loggedInEHRRequestContext = getLoggedInEHRRequestContext();</span>
<span class="fc" id="L208">        contextUserId = loggedInEHRRequestContext.getContextUserId().orElse(null);</span>
<span class="fc" id="L209">        var users = getContextAndLoggedInUsers(loggedInEHRRequestContext);</span>
<span class="fc" id="L210">        PKBPerson currentUser = users.loggedInUser();</span>
<span class="fc" id="L211">        PKBPerson patient = users.contextUser();</span>
<span class="fc" id="L212">        team = Optional.ofNullable(teamManager.getTeam(teamId))</span>
<span class="pc" id="L213">                .orElseThrow(() -&gt; new IllegalStateException(format(&quot;Unable to obtain the team from id %d&quot;, teamId)));</span>

<span class="fc" id="L215">        patientUnder18 = personHelper.isUnderAge(18, patient).orElse(true);</span>
<span class="fc bfc" id="L216" title="All 4 branches covered.">        patientSelfView = currentUser.isPatient() &amp;&amp; patient.getId().equals(currentUser.getId());</span>

<span class="fc" id="L218">        PatientConsent originalConsent = deprecatedPatientConsentManager.findPatientConsentWithoutReasons(patient.getId(), teamId,</span>
<span class="fc" id="L219">                AccessingEntityType.TEAM).orElse(null);</span>

<span class="fc" id="L221">        Optional&lt;String&gt; errorResult = validateConsent(patient, originalConsent, loggedInEHRRequestContext);</span>

<span class="pc bpc" id="L223" title="1 of 2 branches missed.">        if (errorResult.isPresent()) {</span>
<span class="nc" id="L224">            return errorResult.get();</span>
        }

<span class="fc" id="L227">        PatientConsentReason reasons = prepareConsentReason(currentUser, patient.getId(), originalConsent);</span>
<span class="fc" id="L228">        patientConsent.setReasons(reasons);</span>
<span class="fc" id="L229">        prepareConsent(originalConsent);</span>
<span class="fc" id="L230">        keepNonEditableConsent(originalConsent, patientConsent, loggedInEHRRequestContext);</span>

<span class="fc" id="L232">        saveConsent(currentUser, patient);</span>
<span class="fc" id="L233">        saveAdditionalConsent(currentUser, patient);</span>

<span class="fc bfc" id="L235" title="All 2 branches covered.">        if (loggedInEHRRequestContext.isPro()) {</span>
<span class="fc bfc" id="L236" title="All 2 branches covered.">            if (hasProfessionalRemovedOwnAccess(loggedInEHRRequestContext)) {</span>
<span class="fc" id="L237">                contextUserUtil.clearContextUser();</span>
<span class="fc" id="L238">                return &quot;backToPatients&quot;;</span>
            } else {
<span class="fc" id="L240">                return &quot;redirectTeamProfessionaslToPatientSummay&quot;;</span>
            }
        } else {
<span class="fc" id="L243">            return Action.SUCCESS;</span>
        }
    }

    private void prepareConsent(PatientConsent originalConsent) {

<span class="fc bfc" id="L249" title="All 2 branches covered.">        if (autoStopSharing) {// Set discharged flag if necessary. This is independent of the privacy flags</span>
<span class="fc" id="L250">            patientConsent.setDischarged(true);</span>
<span class="fc" id="L251">            addActionMessage(getText(&quot;patientEditConsentTeam.txt.discharge_successful&quot;));</span>
        } else {// Un-discharge patient if they are discharged and consent has been regranted
<span class="fc bfc" id="L253" title="All 2 branches covered.">            if (originalConsent != null &amp;&amp;</span>
<span class="pc bpc" id="L254" title="1 of 2 branches missed.">                    originalConsent.isDischarged() &amp;&amp;</span>
<span class="nc bnc" id="L255" title="All 2 branches missed.">                    patientConsent.anyConsentGranted()) {</span>
<span class="nc" id="L256">                LOGGER.info(&quot;clearing discharged flag for consent {}&quot;, patientConsent);</span>
<span class="nc" id="L257">                patientConsent.setDischarged(false);</span>
            }
        }
<span class="fc" id="L260">    }</span>

    private void keepNonEditableConsent(PatientConsent originalConsent, PatientConsent newConsent, LoggedInEHRRequestContext context) {
<span class="fc bfc" id="L263" title="All 2 branches covered.">        if (context.isCarer()) {</span>
<span class="pc" id="L264">            PatientConsentDTO carerConsent = context.getConsentStatus().getConsent().orElseThrow(() -&gt; new RuntimeException(&quot;No consent info set&quot;));</span>
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">            if (!carerConsent.generalHealthConsentGranted()) {</span>
<span class="nc" id="L266">                newConsent.setGeneralHealthConsentGranted(originalConsent.isGeneralHealthConsentGranted());</span>
<span class="nc" id="L267">                newConsent.getReasons().setGeneralHealthConsentGrantedReason(originalConsent.getReasons().getGeneralHealthConsentGrantedReason());</span>
<span class="nc" id="L268">                newConsent.getReasons().setGeneralHealthConsentGrantedReasonText(originalConsent.getReasons().getGeneralHealthConsentGrantedReasonText());</span>
            }
<span class="fc bfc" id="L270" title="All 2 branches covered.">            if (!carerConsent.mentalHealthConsentGranted()) {</span>
<span class="fc" id="L271">                newConsent.setMentalHealthConsentGranted(originalConsent.isMentalHealthConsentGranted());</span>
<span class="fc" id="L272">                newConsent.getReasons().setMentalHealthConsentGrantedReason(originalConsent.getReasons().getMentalHealthConsentGrantedReason());</span>
<span class="fc" id="L273">                newConsent.getReasons().setMentalHealthConsentGrantedReasonText(originalConsent.getReasons().getMentalHealthConsentGrantedReasonText());</span>
            }
<span class="fc bfc" id="L275" title="All 2 branches covered.">            if (!carerConsent.sexualHealthConsentGranted()) {</span>
<span class="fc" id="L276">                newConsent.setSexualHealthConsentGranted(originalConsent.isSexualHealthConsentGranted());</span>
<span class="fc" id="L277">                newConsent.getReasons().setSexualHealthConsentGrantedReason(originalConsent.getReasons().getSexualHealthConsentGrantedReason());</span>
<span class="fc" id="L278">                newConsent.getReasons().setSexualHealthConsentGrantedReasonText(originalConsent.getReasons().getSexualHealthConsentGrantedReasonText());</span>
            }
<span class="fc bfc" id="L280" title="All 2 branches covered.">            if (!carerConsent.socialCareConsentGranted()) {</span>
<span class="fc" id="L281">                newConsent.setSocialCareConsentGranted(originalConsent.isSocialCareConsentGranted());</span>
<span class="fc" id="L282">                newConsent.getReasons().setSocialCareConsentGrantedReason(originalConsent.getReasons().getSocialCareConsentGrantedReason());</span>
<span class="fc" id="L283">                newConsent.getReasons().setSocialCareConsentGrantedReasonText(originalConsent.getReasons().getSocialCareConsentGrantedReasonText());</span>
            }
        }
<span class="fc" id="L286">    }</span>

    private void saveConsent(PKBPerson currentUser, PKBPerson patient) {
<span class="fc" id="L289">        boolean consentChanged = userWebBean.updateOrCreateTeamConsentRecord(getEHRRequestContext(), patient.getId(), teamId, patientConsent);</span>
        // Should we check both and warn if NEITHER changed? Or just let it go?
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">        if (consentChanged) {</span>
            // The update reloaded consent from the database and modified it in-place. Reload it here so we have the full info
<span class="fc" id="L293">            patientConsent = deprecatedPatientConsentManager.findPatientConsentWithoutReasons(patient.getId(), teamId, AccessingEntityType.TEAM).orElse(null);</span>
<span class="fc" id="L294">            sendNotifications(currentUser, patient);</span>
        }
<span class="fc" id="L296">    }</span>

    private Optional&lt;String&gt; validateConsent(PKBPerson patient, PatientConsent originalConsent, LoggedInEHRRequestContext context) {

<span class="fc" id="L300">        long patientId = context.getContextOrAccessingUserId();</span>

<span class="fc" id="L302">        boolean isUserEditingOwnConsent = context.isUserInOwnAccount();</span>

<span class="fc" id="L304">        boolean isProEditOnlyForChildEnabled = isProEditOnlyForChildEnabled(originalConsent);</span>

        // ticking (or unticking) the under-18 sharing lock = only require that reason.  And limit who can do it here (not just JSP)
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">        if (isLockedChildSharing(patient, originalConsent)) {</span>
<span class="nc" id="L308">            return showError(&quot;patientEditConsentTeam.err.under18_locked_share&quot;);</span>
        }

        // prevent carers granting consent beyond their own
<span class="pc bpc" id="L312" title="1 of 4 branches missed.">        if (context.isCarer() &amp;&amp; !isCarerUpdateValid(originalConsent)) {</span>
<span class="nc" id="L313">            return showError(&quot;patientEditConsentTeam.err.carer_consent_level&quot;);</span>
        }

<span class="pc bpc" id="L316" title="1 of 4 branches missed.">        if (!isUserEditingOwnConsent &amp;&amp;</span>
                isProEditOnlyForChildEnabled &amp;&amp;
<span class="nc bnc" id="L318" title="All 2 branches missed.">                StringUtils.isBlank(proEditOnlyReason)) {</span>
            // special case for enabling the child lock option
<span class="nc" id="L320">            return showError(&quot;viewEditPatientConsentTeamAction.err.missing_reason&quot;);</span>
        }

<span class="pc bpc" id="L323" title="1 of 4 branches missed.">        if (!isUserEditingOwnConsent &amp;&amp;</span>
                !isProEditOnlyForChildEnabled &amp;&amp;
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">                StringUtils.isEmpty(getSelectedReason())) {</span>

<span class="nc" id="L327">            LOGGER.warn(&quot;userId {} did not specify a consent reason when setting team {} consent for patient {}&quot;, context.getAccessingUserId(), teamId, patientId);</span>
<span class="nc" id="L328">            return showError(&quot;viewEditPatientConsentTeamAction.err.missing_reason&quot;);</span>
        }

<span class="fc" id="L331">        return Optional.empty();</span>
    }

    private boolean isProEditOnlyForChildEnabled(PatientConsent originalConsent) {
<span class="fc bfc" id="L335" title="All 2 branches covered.">        return originalConsent != null &amp;&amp;</span>
<span class="pc bpc" id="L336" title="1 of 2 branches missed.">                !originalConsent.isProEditOnlyForChild() &amp;&amp;</span>
<span class="pc bpc" id="L337" title="1 of 2 branches missed.">                patientConsent.isProEditOnlyForChild();</span>
    }

    private PatientConsentReason prepareConsentReason(PKBPerson currentUser, long patientId, PatientConsent originalConsent) {
<span class="fc" id="L341">        PatientConsentReason reasons = new PatientConsentReason(new SourceDetails(getEHRRequestContext()));</span>

<span class="fc" id="L343">        boolean userEditingOwnConsent = currentUser.getId().equals(patientId);</span>
<span class="fc" id="L344">        boolean proEditOnlyForChildEnabled = isProEditOnlyForChildEnabled(originalConsent);</span>

<span class="fc bfc" id="L346" title="All 2 branches covered.">        if (userEditingOwnConsent) {</span>
<span class="fc" id="L347">            reasons.setAllReasons(ConsentReason.EXPLICIT_CONSENT, &quot;&quot;);</span>
<span class="pc bpc" id="L348" title="1 of 2 branches missed.">        } else if (proEditOnlyForChildEnabled) {</span>
<span class="nc" id="L349">            reasons.setProEditOnlyForChildReasonText(proEditOnlyReason);</span>

            // set others as well (if provided)
<span class="nc bnc" id="L352" title="All 2 branches missed.">            if (StringUtils.isNotEmpty(getSelectedReason())) {</span>
<span class="nc" id="L353">                reasons.setAllReasons(ConsentReason.valueOf(getSelectedReason()), freeTextReason);</span>
            }
        } else {
<span class="fc" id="L356">            reasons.setAllReasons(ConsentReason.valueOf(selectedReason), freeTextReason);</span>
            // don't lose the pro edit reason...
<span class="fc" id="L358">            reasons.setProEditOnlyForChildReasonText(proEditOnlyReason);</span>
        }

<span class="fc" id="L361">        reasons.setEventText(&quot;updated by &quot; + currentUser.getId());</span>
<span class="fc" id="L362">        reasons.trackConsentCategories(patientConsent);</span>

<span class="fc" id="L364">        return reasons;</span>
    }

    private Optional&lt;String&gt; showError(String errorCode) {
<span class="nc" id="L368">        addActionError(getText(errorCode));</span>
<span class="nc" id="L369">        view();</span>
<span class="nc" id="L370">        return Optional.of(INPUT);</span>
    }

    private boolean isCarerUpdateValid(PatientConsent originalConsent) {
<span class="pc" id="L374">        PatientConsentDTO carerConsent = getEHRRequestContext().getConsentStatus().getConsent().orElseThrow(() -&gt; new RuntimeException(&quot;No consent info set&quot;));</span>
        // TODO: MFA - Not sure this can be untangled. Might need to refactor this action class.
<span class="fc" id="L376">        return patientConsent.validateCarerUpdate(originalConsent, carerConsent);</span>
    }

    private boolean hasProfessionalRemovedOwnAccess(LoggedInEHRRequestContext requestContext) {
<span class="fc" id="L380">        Team loggedInUserTeam = loggedInUserUtil.getLoggedInUserPrimaryTeam(requestContext);</span>

<span class="pc bpc" id="L382" title="1 of 2 branches missed.">        return patientConsent != null &amp;&amp;</span>
<span class="pc bpc" id="L383" title="1 of 4 branches missed.">                !patientConsent.anyConsentGranted() &amp;&amp;</span>
                loggedInUserTeam != null &amp;&amp;
<span class="pc bpc" id="L385" title="1 of 2 branches missed.">                loggedInUserTeam.getId().equals(patientConsent.getAccessingTeamSlashPersonId());</span>
    }

    private boolean isLockedChildSharing(PKBPerson patient, PatientConsent origConsent) {

        // for supporting locked child sharing: check if the current user is an active team pro, and if patient is under 18
<span class="fc" id="L391">        boolean patientUnder18 = personHelper.isUnderAge(18, patient).orElse(true);</span>

<span class="fc bfc" id="L393" title="All 2 branches covered.">        return origConsent != null &amp;&amp;</span>
<span class="pc bpc" id="L394" title="3 of 4 branches missed.">                origConsent.isProEditOnlyForChild() &amp;&amp;</span>
                patientUnder18 &amp;&amp;
<span class="pc bnc" id="L396" title="All 2 branches missed.">                !loggedInUserUtil.isLoggedInUserActiveTeamMember();</span>
    }

    private void saveAdditionalConsent(PKBPerson currentUser, PKBPerson patient) {
        try {
<span class="fc" id="L401">            List&lt;PatientAdditionalConsent&gt; selectedAdditionalConsents = Lists.newArrayList();</span>
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">            var allConsentsRemoved = additionalConsentsDto.getSelected() == null;</span>
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">            if (!allConsentsRemoved) {</span>
<span class="fc bfc" id="L404" title="All 2 branches covered.">                for (var consentId : additionalConsentsDto.getSelectedIds()) {</span>
<span class="fc" id="L405">                    PatientAdditionalConsent pac = ImmutablePatientAdditionalConsent.builder().additionalConsent(consentId)</span>
<span class="fc" id="L406">                            .patientId(patient.getId()).teamId(teamId).build();</span>
<span class="fc" id="L407">                    selectedAdditionalConsents.add(pac);</span>
<span class="fc" id="L408">                }</span>
            }

<span class="fc" id="L411">            teamUserManager.updatePatientAdditionalConsentsForTeam(currentUser.getId(), teamId,</span>
                    selectedAdditionalConsents);
<span class="nc" id="L413">        } catch (PKBException ex) {</span>
<span class="nc" id="L414">            LOGGER.error(&quot;failed to save additional consent for user {}&quot;, currentUser.getId(), ex);</span>
<span class="fc" id="L415">        }</span>
<span class="fc" id="L416">    }</span>

    public String cancel() {
<span class="nc" id="L419">        return Action.SUCCESS;</span>
    }

    private void sendNotifications(PKBPerson currentUser, PKBPerson patient) {

        try {
<span class="fc" id="L425">            sendNotification(currentUser, patient);</span>
<span class="nc" id="L426">        } catch (PKBException e) {</span>
<span class="nc" id="L427">            LOGGER.error(&quot;Exception while notification of updating consent record patient-{}&quot;, patient, e);</span>
<span class="fc" id="L428">        }</span>
<span class="fc" id="L429">    }</span>

    private void sendNotification(PKBPerson actor, PKBPerson patient) {

<span class="fc" id="L433">        Team team = teamManager.getTeam(teamId);</span>
<span class="pc bpc" id="L434" title="1 of 2 branches missed.">        Org org = team != null ? team.getOrg() : null;</span>
<span class="fc" id="L435">        List&lt;PKBPerson&gt; carerList = patientConsentManager.getCaregivers(patient.getId());</span>
<span class="fc" id="L436">        EHRRequestContext requestContext = getEHRRequestContext();</span>

<span class="fc bfc" id="L438" title="All 2 branches covered.">        if (isPatientDischarge()) {</span>
<span class="fc" id="L439">            pkbEmailMessageManager.sendDischargeNotificationToPatient(actor, patient, org, team);</span>
<span class="fc" id="L440">            carerList.forEach(carer -&gt; pkbEmailMessageManager.sendDischargeNotificationToCarer(actor, patient, carer, org, team));</span>
        } else {
<span class="fc bfc" id="L442" title="All 2 branches covered.">            if (notSelf.test(actor, patient)) {</span>
<span class="fc" id="L443">                pkbEmailMessageManager.sendChangePrivacyLevelNotificationToPatient(requestContext, actor, patient, org, team);</span>
            }
<span class="fc" id="L445">            carerList.stream()</span>
<span class="fc" id="L446">                    .filter(carer -&gt; notSelf.test(actor, carer))</span>
<span class="fc" id="L447">                    .forEach(carer -&gt; pkbEmailMessageManager</span>
<span class="fc" id="L448">                            .sendChangePrivacyLevelNotificationToCarer(requestContext, actor, patient, carer, org));</span>
        }
<span class="fc" id="L450">    }</span>

    private boolean isPatientDischarge() {
<span class="pc bpc" id="L453" title="1 of 2 branches missed.">        return patientConsent != null &amp;&amp;</span>
<span class="fc bfc" id="L454" title="All 2 branches covered.">                patientConsent.isDischarged();</span>
    }

    // &lt;editor-fold desc=&quot;Accessors&quot;&gt;
    public TeamUserManager getTeamUserManager() {
<span class="nc" id="L459">        return teamUserManager;</span>
    }

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L463">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L464">    }</span>

    public TeamManager getTeamManager() {
<span class="nc" id="L467">        return teamManager;</span>
    }

    public void setTeamManager(TeamManager teamManager) {
<span class="fc" id="L471">        this.teamManager = teamManager;</span>
<span class="fc" id="L472">    }</span>

    public Long getTeamId() {
<span class="fc" id="L475">        return teamId;</span>
    }

    public void setTeamId(Long teamId) {
<span class="fc" id="L479">        this.teamId = teamId;</span>
<span class="fc" id="L480">    }</span>

    public Team getTeam() {
<span class="fc" id="L483">        return team;</span>
    }

    public void setTeam(Team team) {
<span class="nc" id="L487">        this.team = team;</span>
<span class="nc" id="L488">    }</span>

    public PatientConsent getPatientConsent() {
<span class="fc" id="L491">        return patientConsent;</span>
    }

    public void setPatientConsent(PatientConsent patientConsent) {
<span class="fc" id="L495">        this.patientConsent = patientConsent;</span>
<span class="fc" id="L496">    }</span>

    public IUserWebBean getUserWebBean() {
<span class="nc" id="L499">        return userWebBean;</span>
    }

    public void setUserWebBean(UserWebBean userWebBean) {
<span class="fc" id="L503">        this.userWebBean = userWebBean;</span>
<span class="fc" id="L504">    }</span>

    public AdditionalConsentsDto getAdditionalConsentsDto() {
<span class="fc" id="L507">        return additionalConsentsDto;</span>
    }

    public void setAdditionalConsentsDto(AdditionalConsentsDto additionalConsentsDto) {
<span class="nc" id="L511">        this.additionalConsentsDto = additionalConsentsDto;</span>
<span class="nc" id="L512">    }</span>

    public List&lt;ConsentReason&gt; getConsentReasons() {
<span class="fc" id="L515">        return consentReasons;</span>
    }

    public void setConsentReasons(List&lt;ConsentReason&gt; consentReasons) {
<span class="nc" id="L519">        this.consentReasons = consentReasons;</span>
<span class="nc" id="L520">    }</span>

    public String getSelectedReason() {
<span class="fc" id="L523">        return selectedReason;</span>
    }

    public void setSelectedReason(String selectedReason) {
<span class="fc" id="L527">        this.selectedReason = selectedReason;</span>
<span class="fc" id="L528">    }</span>

    public String getFreeTextReason() {
<span class="nc" id="L531">        return freeTextReason;</span>
    }

    public void setFreeTextReason(String freeTextReason) {
<span class="fc" id="L535">        this.freeTextReason = freeTextReason;</span>
<span class="fc" id="L536">    }</span>

    public boolean isGrantedCustomConsent() {
<span class="nc" id="L539">        return grantedCustomConsent;</span>
    }

    public void setGrantedCustomConsent(boolean grantedCustomConsent) {
<span class="nc" id="L543">        this.grantedCustomConsent = grantedCustomConsent;</span>
<span class="nc" id="L544">    }</span>

    public boolean isAutoStopSharing() {
<span class="fc" id="L547">        return autoStopSharing;</span>
    }

    public void setAutoStopSharing(boolean autoStopSharing) {
<span class="fc" id="L551">        this.autoStopSharing = autoStopSharing;</span>
<span class="fc" id="L552">    }</span>

    public String getProEditOnlyReason() {
<span class="fc" id="L555">        return proEditOnlyReason;</span>
    }

    public void setProEditOnlyReason(String proEditOnlyReason) {
<span class="fc" id="L559">        this.proEditOnlyReason = proEditOnlyReason;</span>
<span class="fc" id="L560">    }</span>

    public PatientConsentDTO getLoggedInCarerConsent() {
<span class="fc" id="L563">        return loggedInCarerConsent;</span>
    }

    public PKBEmailMessageManager getPkbEmailMessageManager() {
<span class="nc" id="L567">        return pkbEmailMessageManager;</span>
    }

    public void setPkbEmailMessageManager(PKBEmailMessageManager pkbEmailMessageManager) {
<span class="fc" id="L571">        this.pkbEmailMessageManager = pkbEmailMessageManager;</span>
<span class="fc" id="L572">    }</span>

    public void setDeprecatedPatientConsentManager(DeprecatedPatientConsentManager patientConsentManager) {
<span class="fc" id="L575">        this.deprecatedPatientConsentManager = patientConsentManager;</span>
<span class="fc" id="L576">    }</span>

    public void setPatientConsentManager(PatientConsentManager patientConsentManager) {
<span class="fc" id="L579">        this.patientConsentManager = patientConsentManager;</span>
<span class="fc" id="L580">    }</span>

    public boolean getAllowDefaultConsentFromTeam() {
<span class="nc" id="L583">        return allowDefaultConsentFromTeam;</span>
    }

    public void setAllowDefaultConsentFromTeam(boolean allowDefaultConsentFromTeam) {
<span class="fc" id="L587">        this.allowDefaultConsentFromTeam = allowDefaultConsentFromTeam;</span>
<span class="fc" id="L588">    }</span>

    public boolean getLoggedInUserIsTeamAdmin() {
<span class="pc bpc" id="L591" title="1 of 2 branches missed.">        return loggedInUserUtil.getLoggedInUserType() == UserType.INSTITUTE_ADMIN;</span>
    }

    public boolean isPatientUnder18() {
<span class="fc" id="L595">        return patientUnder18;</span>
    }

    public boolean isPatientSelfView() {
<span class="fc" id="L599">        return patientSelfView;</span>
    }

    // &lt;/editor-fold&gt;
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>