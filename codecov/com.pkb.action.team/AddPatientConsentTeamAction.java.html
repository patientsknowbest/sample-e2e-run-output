<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AddPatientConsentTeamAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.team</a> &gt; <span class="el_source">AddPatientConsentTeamAction.java</span></div><h1>AddPatientConsentTeamAction.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2015 Patients Know Best
 */
package com.pkb.action.team;

import com.google.common.collect.Lists;
import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.consent.entity.PatientConsent;
import com.pkb.consent.entity.PatientConsentReason;
import com.pkb.datamodel.Affiliate;
import com.pkb.entities.enums.AccessingEntityType;
import com.pkb.entities.enums.ConsentReason;
import com.pkb.entities.enums.SponsorshipStatus;
import com.pkb.exception.PKBException;
import com.pkb.institute.entity.InstituteUser;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.patientconsent.DeprecatedPatientConsentManager;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.team.AffiliateManager;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.List;
import java.util.stream.Collectors;

<span class="fc" id="L38">public class AddPatientConsentTeamAction extends BaseAction {</span>

    private static final long serialVersionUID = -9151764513944880841L;
<span class="fc" id="L41">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private TeamUserManager teamUserManager;
    private TeamManager teamManager;
    private AffiliateManager affiliateManager;
    private PKBEmailMessageManager pkbEmailMessageManager;
    private DeprecatedPatientConsentManager deprecatedPatientConsentManager;

    @Autowired
    private PatientConsentManager patientConsentManager;

    private List&lt;Team&gt; teamsForOrg;
    private List&lt;ConsentReason&gt; consentReasons;
    private PatientConsent patientConsent;
    private String selectedReason;
    private String freeTextReason;

    @Override
    public void prepare() throws Exception {
        // Get the clinician team
<span class="fc" id="L61">        Team team = teamUserManager.getClinicianTeam(getEHRRequestContext(), loggedInUserUtil.getLoggedInUserId());</span>
<span class="fc" id="L62">        Long currentTeamId = team.getId();</span>
        // Load all other teams belong to the same org, but filter out the
        // clinician's current team (which doesn't need inviting again)
<span class="fc" id="L65">        teamsForOrg = teamManager.getTeamsForOrg(team.getOrg().getId());</span>

<span class="fc" id="L67">        List&lt;Long&gt; affiliateTeamIds = affiliateManager.getAffiliates(currentTeamId)</span>
<span class="fc" id="L68">                .stream()</span>
<span class="fc" id="L69">                .map(Affiliate::getAffiliateTeamId)</span>
<span class="fc" id="L70">                .collect(Collectors.toUnmodifiableList());</span>

<span class="fc" id="L72">        teamsForOrg.addAll(teamManager.getTeams(affiliateTeamIds));</span>

<span class="fc bfc" id="L74" title="All 2 branches covered.">        CollectionUtils.filter(teamsForOrg, candidate -&gt; !currentTeamId.equals(candidate.getId()));</span>
<span class="fc" id="L75">        consentReasons = Lists.newArrayList(ConsentReason.userSelectableValues());</span>
<span class="fc" id="L76">    }</span>

    @Override
    public void validate() {
<span class="fc bfc" id="L80" title="All 4 branches covered.">        if (patientConsent != null &amp;&amp; patientConsent.getAccessingTeamSlashPersonId() == null) {</span>
<span class="fc" id="L81">            addFieldError(&quot;patientConsent.accessingTeamSlashPersonId&quot;, getText(&quot;patientAddConsentTeam.err.team&quot;));</span>
        }
<span class="fc bfc" id="L83" title="All 4 branches covered.">        if (selectedReason != null &amp;&amp; StringUtils.isBlank(selectedReason)) {</span>
<span class="fc" id="L84">            addFieldError(&quot;selectedReason&quot;, getText(&quot;patientAddConsentTeam.err.reason&quot;));</span>
        }
<span class="fc" id="L86">    }</span>

    public String view() {
        try {
            // Make sure we are a team-registered clinician viewing a patient record,
            // otherwise error out
<span class="fc" id="L92">            long userId = loggedInUserUtil.getLoggedInUserId();</span>

<span class="pc bpc" id="L94" title="1 of 2 branches missed.">            if (!loggedInUserUtil.isLoggedInUserActiveTeamMember()) {</span>
                // Not the right user type
<span class="nc" id="L96">                LOGGER.warn(&quot;non-team-clinician user {} tried to access 'add team' page, redirecting to dashboard&quot;, userId);</span>
<span class="nc" id="L97">                return loggedInUserUtil.getLoggedInUserHomeResult().orElse(null);</span>
            }
<span class="pc bpc" id="L99" title="1 of 2 branches missed.">            if (contextUserId == null) {</span>
                // Not viewing a patient page
<span class="nc" id="L101">                LOGGER.warn(&quot;team-clinician user {} tried to access 'add team' page with no contextUserId set, redirecting to dashboard&quot;,</span>
<span class="nc" id="L102">                        userId);</span>
<span class="nc" id="L103">                return loggedInUserUtil.getLoggedInUserHomeResult().orElse(null);</span>
            }
<span class="nc" id="L105">        } catch (PKBException ex) {</span>
<span class="nc" id="L106">            LOGGER.error(&quot;&quot;, ex);</span>
<span class="fc" id="L107">        }</span>
<span class="fc" id="L108">        return Action.SUCCESS;</span>
    }

    public String add() {
        try {
            // Check the patient isn't already in this team
<span class="fc" id="L114">            boolean createInstituteUser = true;</span>
<span class="fc" id="L115">            Long newTeamId = patientConsent.getAccessingTeamSlashPersonId();</span>
<span class="fc" id="L116">            List&lt;Team&gt; patientTeams = teamUserManager.getUserTeams(getEHRRequestContext(), contextUserId, false);</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">            for (Team t : patientTeams) {</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">                if (newTeamId.equals(t.getId())) {</span>
<span class="nc" id="L119">                    createInstituteUser = false;</span>
<span class="nc" id="L120">                    break;</span>
                }
<span class="fc" id="L122">            }</span>

<span class="pc bpc" id="L124" title="1 of 2 branches missed.">            if (createInstituteUser) {</span>
                // Check if the patient has already been invited to this team before. If so, update the
                // status; if not, create a new institute user
                // TODO: teamUserManager.beginTransaction
<span class="fc" id="L128">                InstituteUser instituteUser = teamUserManager.getInstituteUser(newTeamId, contextUserId);</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">                if (instituteUser == null) {</span>
<span class="fc" id="L130">                    teamUserManager.createInstituteUser(contextUserId, newTeamId);</span>
<span class="fc" id="L131">                    teamUserManager.updateStatus(newTeamId, contextUserId, SponsorshipStatus.ACTIVE);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">                } else if (instituteUser.getSponsorshipStatus() != SponsorshipStatus.ACTIVE) {</span>
<span class="nc" id="L133">                    teamUserManager.updateStatus(newTeamId, contextUserId, SponsorshipStatus.ACTIVE);</span>
                }
            }

            // Finish off setting up the consent record. This is a new record,
            // so we create the reasons object directly since it wasn't loaded
            // from the database
<span class="fc" id="L140">            patientConsent.setPatientPersonId(contextUserId);</span>
<span class="fc" id="L141">            patientConsent.setAccessingEntityType(AccessingEntityType.TEAM);</span>

<span class="fc" id="L143">            PatientConsentReason reasons = new PatientConsentReason(new SourceDetails(getEHRRequestContext()));</span>
<span class="fc" id="L144">            reasons.setAllReasons(ConsentReason.valueOf(selectedReason), freeTextReason);</span>
<span class="fc" id="L145">            reasons.trackConsentCategories(patientConsent);</span>
<span class="fc" id="L146">            patientConsent.setReasons(reasons);</span>
<span class="fc" id="L147">            patientConsent.setDischarged(false);</span>
<span class="fc" id="L148">            patientConsent.setAdded(dateTimeService.now());</span>
<span class="fc" id="L149">            deprecatedPatientConsentManager.ensureTeamLinkAndUpdatePatientConsentLegacy(getEHRRequestContext(), patientConsent);</span>
<span class="fc" id="L150">            sendNotification(loggedInUserUtil.getLoggedInUser(), contextUserUtil.getContextUser());</span>

<span class="pc bpc" id="L152" title="1 of 2 branches missed.">            if (contextUserId != null) {</span>
<span class="fc" id="L153">                addActionMessage(getText(&quot;patientAddConsentTeam.msg.teams_assigned&quot;));</span>
            }

<span class="nc" id="L156">        } catch (PKBException ex) {</span>
<span class="nc" id="L157">            LOGGER.error(&quot;Error during adding consent&quot;, ex);</span>
<span class="fc" id="L158">        }</span>
<span class="fc" id="L159">        return Action.SUCCESS;</span>
    }

    public String cancel() {
<span class="nc" id="L163">        return Action.SUCCESS;</span>
    }

    private void sendNotification(PKBPerson actor, PKBPerson patient) {
<span class="fc" id="L167">        List&lt;PKBPerson&gt; carers = patientConsentManager.getCaregivers(patient.getId());</span>
<span class="fc" id="L168">        Team team = teamManager.getTeam(patientConsent.getAccessingTeamSlashPersonId());</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        Org org = team != null ? team.getOrg() : null;</span>
<span class="fc" id="L170">        EHRRequestContext requestContext = getEHRRequestContext();</span>
<span class="fc" id="L171">        carers.stream()</span>
<span class="fc" id="L172">                .filter(carer -&gt; notSelf.test(actor, carer))</span>
<span class="fc" id="L173">                .forEach(carer -&gt; pkbEmailMessageManager.sendChangePrivacyLevelNotificationToCarer(requestContext, actor, patient, carer, org));</span>
<span class="fc" id="L174">        pkbEmailMessageManager.sendChangePrivacyLevelNotificationToPatient(requestContext, actor, patient, org, team);</span>
<span class="fc" id="L175">    }</span>

    public TeamUserManager getTeamUserManager() {
<span class="nc" id="L178">        return teamUserManager;</span>
    }

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L182">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L183">    }</span>

    public TeamManager getTeamManager() {
<span class="nc" id="L186">        return teamManager;</span>
    }

    public void setTeamManager(TeamManager teamManager) {
<span class="fc" id="L190">        this.teamManager = teamManager;</span>
<span class="fc" id="L191">    }</span>

    public List&lt;Team&gt; getTeamsForOrg() {
<span class="fc" id="L194">        return teamsForOrg;</span>
    }

    public void setTeamsForOrg(List&lt;Team&gt; teamsForOrg) {
<span class="nc" id="L198">        this.teamsForOrg = teamsForOrg;</span>
<span class="nc" id="L199">    }</span>

    public List&lt;ConsentReason&gt; getConsentReasons() {
<span class="fc" id="L202">        return consentReasons;</span>
    }

    public void setConsentReasons(List&lt;ConsentReason&gt; consentReasons) {
<span class="nc" id="L206">        this.consentReasons = consentReasons;</span>
<span class="nc" id="L207">    }</span>

    public PatientConsent getPatientConsent() {
<span class="fc" id="L210">        return patientConsent;</span>
    }

    public void setPatientConsent(PatientConsent patientConsent) {
<span class="fc" id="L214">        this.patientConsent = patientConsent;</span>
<span class="fc" id="L215">    }</span>

    public String getSelectedReason() {
<span class="fc" id="L218">        return selectedReason;</span>
    }

    public void setSelectedReason(String selectedReason) {
<span class="fc" id="L222">        this.selectedReason = selectedReason;</span>
<span class="fc" id="L223">    }</span>

    public UserManager getUserManager() {
<span class="nc" id="L226">        return userManager;</span>
    }

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L230">        this.userManager = userManager;</span>
<span class="fc" id="L231">    }</span>

    public String getFreeTextReason() {
<span class="nc" id="L234">        return freeTextReason;</span>
    }

    public void setFreeTextReason(String freeTextReason) {
<span class="fc" id="L238">        this.freeTextReason = freeTextReason;</span>
<span class="fc" id="L239">    }</span>

    public AffiliateManager getAffiliateManager() {
<span class="nc" id="L242">        return affiliateManager;</span>
    }

    public void setAffiliateManager(AffiliateManager affiliateManager) {
<span class="fc" id="L246">        this.affiliateManager = affiliateManager;</span>
<span class="fc" id="L247">    }</span>

    public PKBEmailMessageManager getPkbEmailMessageManager() {
<span class="nc" id="L250">        return pkbEmailMessageManager;</span>
    }

    public void setPkbEmailMessageManager(PKBEmailMessageManager pkbEmailMessageManager) {
<span class="fc" id="L254">        this.pkbEmailMessageManager = pkbEmailMessageManager;</span>
<span class="fc" id="L255">    }</span>

    public void setDeprecatedPatientConsentManager(DeprecatedPatientConsentManager patientConsentManager) {
<span class="fc" id="L258">        this.deprecatedPatientConsentManager = patientConsentManager;</span>
<span class="fc" id="L259">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>