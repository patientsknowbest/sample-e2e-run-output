<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ForgotPasswordPersonalInfoAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.registration</a> &gt; <span class="el_source">ForgotPasswordPersonalInfoAction.java</span></div><h1>ForgotPasswordPersonalInfoAction.java</h1><pre class="source lang-java linenums">//---------------------------------------------------------------------------
//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: ForgotPasswordPersonalInfoAction.java Mar 4, 2010 12:32:24 PM anamika$
//
//---------------------------------------------------------------------------
package com.pkb.action.registration;

import com.pkb.action.registration.reset.PasswordResetService;
import com.pkb.action.registration.reset.ResetStepFailure.AlreadyResetByTeamMember;
import com.pkb.action.registration.reset.ResetStepFailure.InconsistentDB;
import com.pkb.action.registration.reset.ResetStepFailure.NoUserByEmail;
import com.pkb.action.registration.reset.ResetStepFailure.NotRegistered;
import com.pkb.action.registration.reset.ResetStepFailure.TooManyInvalidDOBInputAttempts;
import com.pkb.action.registration.reset.ResetStepFailure.UnexpectedCompositeError;
import com.pkb.action.registration.reset.ResetStepFailure.UnexpectedError;
import com.pkb.action.registration.reset.UserVerificationCriteria;
import com.pkb.action.registration.reset.UserVerificationFailure.DemographicsMismatch;
import com.pkb.action.registration.reset.UserVerificationFailure.SecurityAnswerMismatch;
import com.pkb.datamodel.Email;
import com.pkb.user.entity.PKBPerson;
import com.pkb.util.DateUtil;
import com.pkb.util.PKBEmailValidator;
import com.pkb.util.PKBEmailValidator.EmailValidationFailure;
import io.vavr.control.Validation;
import org.apache.struts2.interceptor.ServletRequestAware;
import org.slf4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;

import java.time.Instant;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.Optional;

import static com.pkb.action.registration.reset.ImmutableUserVerificationCriteria.matchingCriteria;
import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.Match;
import static io.vavr.API.Try;
import static io.vavr.Predicates.anyOf;
import static io.vavr.Predicates.instanceOf;
import static io.vavr.control.Validation.invalid;
import static io.vavr.control.Validation.valid;
import static java.lang.String.format;
import static java.lang.invoke.MethodHandles.lookup;
import static java.util.Objects.isNull;
import static java.util.Optional.empty;
import static org.apache.commons.lang3.StringUtils.isBlank;
import static org.apache.commons.lang3.StringUtils.trim;
import static org.apache.commons.lang3.StringUtils.trimToEmpty;
import static org.slf4j.LoggerFactory.getLogger;

/**
 * Verify the personal info (dob, last name) entered by the user as a first step towards password reset
 *
 * @author pravinam
 */
<span class="fc" id="L59">public class ForgotPasswordPersonalInfoAction extends ForgotPasswordActionSupport implements ServletRequestAware {</span>
    private static final long serialVersionUID = 3L;

<span class="fc" id="L62">    private static final Logger LOGGER = getLogger(lookup().lookupClass());</span>

    private static final String WRONG_DETAILS = &quot;forgotPasswordPersonalInfoAction.err.wrong_details&quot;;
    private static final String NOT_YET_REGISTERED = &quot;forgotPasswordPersonalInfoAction.err.not_yet_registered&quot;;
    private static final String ALREADY_RESET = &quot;forgotPasswordPersonalInfoAction.err.password_already_reset&quot;;
    private static final int MAX_NAME_LENGTH = 50;

    private PKBPerson pkbPerson;
<span class="fc" id="L70">    private boolean pwdAlreadyReset = false;</span>
    private Instant lockedUntil;

    @Autowired
    private PasswordResetService passwordResetService;
    @Autowired
    private PKBEmailValidator emailValidator;
    @Autowired
    protected DateUtil dateUtil;

    @Override
    public void validate() {
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (resetPassObj != null) {</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">            if (resetPassObj.isVerifyLastName()) {</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">                if (resetPassObj.getLastName().isBlank()) {</span>
<span class="fc" id="L85">                    addFieldError(&quot;resetPassObj.lastName&quot;,</span>
<span class="fc" id="L86">                            getText(&quot;forgotPasswordPersonalInfoActionValidation.err.enter_lastname&quot;));</span>
<span class="pc bpc" id="L87" title="1 of 2 branches missed.">                } else if (resetPassObj.getLastName().length() &gt; MAX_NAME_LENGTH) {</span>
<span class="nc" id="L88">                    addFieldError(&quot;resetPassObj.lastName&quot;,</span>
<span class="nc" id="L89">                            getText(&quot;forgotPasswordPersonalInfoActionValidation.err.invalid_lastName&quot;));</span>
                }
            }

<span class="fc bfc" id="L93" title="All 2 branches covered.">            if (resetPassObj.isVerifyDateOfBirth()) {</span>
<span class="fc" id="L94">                boolean dobError = false;</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">                if (resetPassObj.getDay() == null</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">                        || &quot;Day&quot;.equals(resetPassObj.getDay())</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">                        || &quot;0&quot;.equals(resetPassObj.getDay())) {</span>
<span class="fc" id="L98">                    dobError = true;</span>
                    // the following is not displayed, but is used to turn the field red
<span class="fc" id="L100">                    addFieldError(&quot;resetPassObj.day&quot;, getText(&quot;forgotPasswordPersonalInfoAction.err.enter_date_of_birth&quot;));</span>
                }

<span class="pc bpc" id="L103" title="1 of 2 branches missed.">                if (resetPassObj.getMonth() == null</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">                        || &quot;0&quot;.equals(resetPassObj.getMonth())</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">                        || &quot;Month&quot;.equals(resetPassObj.getMonth())) {</span>
<span class="fc" id="L106">                    dobError = true;</span>
                    // the following is not displayed, but is used to turn the field red
<span class="fc" id="L108">                    addFieldError(&quot;resetPassObj.month&quot;, getText(&quot;forgotPasswordPersonalInfoAction.err.enter_date_of_birth&quot;));</span>
                }

<span class="pc bpc" id="L111" title="1 of 4 branches missed.">                if (isBlank(resetPassObj.getYear()) || &quot;0&quot;.equals(resetPassObj.getYear())) {</span>
<span class="fc" id="L112">                    dobError = true;</span>
                    // the following is not displayed, but is used to turn the field red
<span class="fc" id="L114">                    addFieldError(&quot;resetPassObj.year&quot;, getText(&quot;forgotPasswordPersonalInfoAction.err.enter_date_of_birth&quot;));</span>
                }

<span class="fc bfc" id="L117" title="All 2 branches covered.">                if (dobError) {</span>
<span class="fc" id="L118">                    addFieldError(&quot;resetPassObj.DOB&quot;, getText(&quot;forgotPasswordPersonalInfoAction.err.enter_date_of_birth&quot;));</span>
                }
            }

<span class="fc bfc" id="L122" title="All 2 branches covered.">            if (resetPassObj.isVerifyPostalCode()) {</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">                if (isBlank(resetPassObj.getPostalCode())) {</span>
<span class="fc" id="L124">                    addFieldError(&quot;resetPassObj.postalCode&quot;, getText(&quot;forgotPasswordPersonalInfoActionValidation.err.enter_postcode&quot;));</span>
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">                } else if (trimToEmpty(resetPassObj.getPostalCode()).length() &gt; 10) {</span>
<span class="nc" id="L126">                    addFieldError(&quot;resetPassObj.postalCode&quot;, getText(&quot;forgotPasswordPersonalInfoActionValidation.err.invalid_postcode_length&quot;));</span>
                }
            }

<span class="fc bfc" id="L130" title="All 4 branches covered.">            if (resetPassObj.isVerifySecurityAnswer() &amp;&amp; isBlank(resetPassObj.getAnswer1())) {</span>
<span class="fc" id="L131">                addFieldError(&quot;resetPassObj.answer1&quot;, getText(&quot;forgotPasswordPersonalInfoActionValidation.err.enter_answer&quot;));</span>
            }
        }
<span class="fc" id="L134">    }</span>

    @Override
    public String input() {
<span class="nc" id="L138">        return SUCCESS;</span>
    }

    /**
     * Step two - part two (continuation of {@link ForgotPasswordEmailInfoAction#execute()}).
     */
    @Override
    public String execute() {
<span class="fc" id="L146">        LOGGER.info(&quot;Personal info is submitted for verification&quot;);</span>
<span class="fc" id="L147">        return getVerifiedCriteria().fold(</span>
                validationError -&gt; {
<span class="nc" id="L149">                    LOGGER.warn(validationError);</span>
<span class="nc" id="L150">                    return ERROR;</span>
                },
<span class="fc" id="L152">                criteria -&gt; passwordResetService.verifyDetails(criteria).fold(</span>
<span class="fc" id="L153">                        verificationFailure -&gt; Match(verificationFailure).of(</span>
                                // Business use-cases
<span class="fc" id="L155">                                Case($(instanceOf(NotRegistered.class)), () -&gt; {</span>
<span class="nc" id="L156">                                    addActionError(getText(NOT_YET_REGISTERED));</span>
<span class="nc" id="L157">                                    return ERROR;</span>
                                }),
<span class="fc" id="L159">                                Case($(instanceOf(TooManyInvalidDOBInputAttempts.class)), () -&gt; {</span>
<span class="fc" id="L160">                                    lockedUntil = ((TooManyInvalidDOBInputAttempts) verificationFailure).getLockedUntil();</span>
<span class="fc" id="L161">                                    DateTimeFormatter formatter = dateUtil.getDateAtTimeOutputFormatter((s, l) -&gt; getText(s), getLocale())</span>
<span class="fc" id="L162">                                            .withLocale(getLocale());</span>
<span class="fc" id="L163">                                    addActionError(getText(&quot;forgotPasswordPersonalInfoAction.err.too_many_dob_attempts&quot;,</span>
<span class="fc" id="L164">                                            new String[] { formatter.format(lockedUntil) }));</span>
<span class="fc" id="L165">                                    return ERROR;</span>
                                }),
<span class="fc" id="L167">                                Case($(anyOf(</span>
<span class="fc" id="L168">                                        instanceOf(NoUserByEmail.class), // sure?</span>
<span class="fc" id="L169">                                        instanceOf(DemographicsMismatch.class),</span>
<span class="fc" id="L170">                                        instanceOf(SecurityAnswerMismatch.class))),</span>
                                        () -&gt; {
<span class="fc" id="L172">                                            addActionError(getText(WRONG_DETAILS));</span>
<span class="fc" id="L173">                                            return ERROR;</span>
                                        }),
<span class="fc" id="L175">                                Case($(instanceOf(AlreadyResetByTeamMember.class)), () -&gt; {</span>
<span class="nc" id="L176">                                    pwdAlreadyReset = true;</span>
<span class="nc" id="L177">                                    addActionError(getText(ALREADY_RESET));</span>
<span class="nc" id="L178">                                    return INPUT;</span>
                                }),
                                // Irregularities:
<span class="fc" id="L181">                                Case($(anyOf(</span>
<span class="fc" id="L182">                                        instanceOf(InconsistentDB.class),</span>
<span class="fc" id="L183">                                        instanceOf(UnexpectedCompositeError.class),</span>
<span class="fc" id="L184">                                        instanceOf(UnexpectedError.class))), (error) -&gt; {</span>
                                            // FIXME: redirect to a genuine error screen (saying the user that they should contact us?)
                                            //  and set up an alert!
<span class="nc" id="L187">                                            addActionError(getText(WRONG_DETAILS));</span>
<span class="nc" id="L188">                                            return ERROR;</span>
                                        }),
<span class="fc" id="L190">                                Case($(), unhandledFailure -&gt; {</span>
<span class="nc" id="L191">                                    LOGGER.error(&quot;Unhandled case: {}, message: {}&quot;, unhandledFailure.getClass().getSimpleName(), unhandledFailure.message());</span>
<span class="nc" id="L192">                                    return ERROR;</span>
                                })),
                        verified -&gt; {
<span class="fc" id="L195">                            pkbPerson = verified.user();</span>
<span class="fc" id="L196">                            resetPassObj.setUid(pkbPerson.getId());</span>
<span class="fc" id="L197">                            resetPassObj.setQuestion1(verified.question());</span>
<span class="fc" id="L198">                            return SUCCESS;</span>
                        }));
    }

    private Validation&lt;String, UserVerificationCriteria&gt; getVerifiedCriteria() {
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">        if (isNull(resetPassObj)) {</span>
<span class="nc" id="L204">            return invalid(&quot;resetPassObj is null&quot;);</span>
        }

<span class="fc" id="L207">        Validation&lt;String, Email&gt; validatedEmail = emailValidator.validEmail(resetPassObj.findEmailId().map(Email::address).getOrNull())</span>
<span class="fc" id="L208">                .mapError(EmailValidationFailure::message);</span>

<span class="fc bfc" id="L210" title="All 2 branches covered.">        Validation&lt;String, Optional&lt;String&gt;&gt; validatedLastName = resetPassObj.isVerifyLastName() ? lastName() : valid(empty());</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">        Validation&lt;String, Optional&lt;LocalDate&gt;&gt; validatedDateOfBirth = resetPassObj.isVerifyDateOfBirth() ? dateOfBirth() : valid(empty());</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">        Validation&lt;String, Optional&lt;String&gt;&gt; validatedPostalCode = resetPassObj.isVerifyPostalCode() ? postalCode() : valid(empty());</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">        Validation&lt;String, Optional&lt;String&gt;&gt; validatedAnswer = resetPassObj.isVerifySecurityAnswer() ? securityAnswer() : valid(empty());</span>

<span class="fc" id="L215">        return Validation.combine(validatedEmail, validatedDateOfBirth, validatedPostalCode, validatedLastName, validatedAnswer)</span>
<span class="fc" id="L216">                .ap((email, maybeDateOfBirth, maybePostalCode, maybeLastName, maybeAnswer) -&gt; (UserVerificationCriteria) matchingCriteria(</span>
                        email,
                        maybeLastName,
                        maybeDateOfBirth,
                        maybePostalCode,
<span class="fc" id="L221">                        resetPassObj.getQuestion1(),</span>
                        maybeAnswer))
<span class="pc" id="L223">                .mapError(errors -&gt; String.join(&quot;,&quot;, errors));</span>
    }

    private Validation&lt;String, Optional&lt;String&gt;&gt; lastName() {
<span class="fc" id="L227">        return verifiedNonBlankValue(resetPassObj.getLastName(), &quot;Last name is blank&quot;).map(Optional::of);</span>
    }

    private Validation&lt;String, Optional&lt;String&gt;&gt; postalCode() {
<span class="fc" id="L231">        return verifiedNonBlankValue(resetPassObj.getPostalCode(), &quot;Postal code is blank&quot;).map(Optional::of);</span>
    }

    private Validation&lt;String, Optional&lt;LocalDate&gt;&gt; dateOfBirth() {
<span class="fc" id="L235">        return Try(() -&gt; LocalDate.parse(format(&quot;%4d-%02d-%02d&quot;,</span>
<span class="fc" id="L236">                Integer.parseInt(resetPassObj.getYear()),</span>
<span class="fc" id="L237">                Integer.parseInt(resetPassObj.getMonth()),</span>
<span class="fc" id="L238">                Integer.parseInt(resetPassObj.getDay()))))</span>
<span class="fc" id="L239">                        .toValidation()</span>
<span class="fc" id="L240">                        .map(Optional::of)</span>
<span class="pc" id="L241">                        .mapError(error -&gt; format(&quot;Failed to parse date of birth (reason: %s: %s)&quot;, error.getClass().getSimpleName(), error.getMessage()));</span>
    }
    private Validation&lt;String, Optional&lt;String&gt;&gt; securityAnswer() {
<span class="fc" id="L244">        return verifiedNonBlankValue(resetPassObj.getAnswer1(), &quot;Answer is blank&quot;).map(Optional::of);</span>
    }

    private Validation&lt;String, String&gt; verifiedNonBlankValue(String value, String message) {
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">        return isBlank(value) ? invalid(message) : valid(trim(value));</span>
    }

    public PKBPerson getPkbPerson() {
<span class="nc" id="L252">        return pkbPerson;</span>
    }

    public void setPkbPerson(PKBPerson pkbPerson) {
<span class="nc" id="L256">        this.pkbPerson = pkbPerson;</span>
<span class="nc" id="L257">    }</span>

    public boolean getPwdAlreadyReset() {
<span class="nc" id="L260">        return pwdAlreadyReset;</span>
    }

    public void setPwdAlreadyReset(boolean pwdAlreadyReset) {
<span class="nc" id="L264">        this.pwdAlreadyReset = pwdAlreadyReset;</span>
<span class="nc" id="L265">    }</span>

    public boolean isAttemptLocked() {
<span class="fc bfc" id="L268" title="All 2 branches covered.">        return lockedUntil != null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>