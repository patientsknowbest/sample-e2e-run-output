<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MenuDataXmlSerializerHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.common.ehrdata.serializer.xml01</a> &gt; <span class="el_source">MenuDataXmlSerializerHelper.java</span></div><h1>MenuDataXmlSerializerHelper.java</h1><pre class="source lang-java linenums">package com.pkb.common.ehrdata.serializer.xml01;

import io.micrometer.core.instrument.Metrics;
import io.micrometer.core.instrument.Timer;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;

import javax.xml.stream.XMLOutputFactory;
import javax.xml.stream.XMLStreamException;
import javax.xml.stream.XMLStreamWriter;
import java.io.ByteArrayOutputStream;
import java.time.Instant;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.time.temporal.TemporalAccessor;
import java.util.Base64;
import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.Map;

import static io.vavr.API.unchecked;
import static java.nio.charset.StandardCharsets.UTF_8;
import static org.apache.commons.lang3.StringUtils.isEmpty;

public class MenuDataXmlSerializerHelper {

    private static final String CDATA_ENCODING_ATTRIB = &quot;cdataEncoding&quot;;
    private static final String CDATA_ENCODING_BASE64 = &quot;Base64&quot;;

<span class="fc" id="L34">    private static final Timer XML_CREATE_TIMER = Timer.builder(&quot;pkb_phr_menudata_xmlcreateseconds&quot;)</span>
<span class="fc" id="L35">            .description(&quot;Time needed to serialize fields to xml&quot;)</span>
<span class="fc" id="L36">            .publishPercentileHistogram()</span>
<span class="fc" id="L37">            .publishPercentiles(0.5, 0.9, 0.95, 0.99)</span>
<span class="fc" id="L38">            .register(Metrics.globalRegistry);</span>

    private MenuDataXmlSerializerHelper() {
    }

    @NotNull
    public static byte[] marshalEncryptedFields(@NotNull Map&lt;String, Object&gt; encryptedFields) {
<span class="fc" id="L45">        XMLOutputFactory factory = XMLOutputFactory.newInstance();</span>

<span class="fc" id="L47">        return XML_CREATE_TIMER.record(() -&gt; unchecked(() -&gt; {</span>
<span class="fc" id="L48">            XMLStreamWriter writer = null;</span>
<span class="fc" id="L49">            try (ByteArrayOutputStream baos = new ByteArrayOutputStream()) {</span>

<span class="fc" id="L51">                writer = factory.createXMLStreamWriter(baos, &quot;UTF-8&quot;);</span>
<span class="fc" id="L52">                writer.writeStartDocument(&quot;UTF-8&quot;, &quot;1.0&quot;);</span>
<span class="fc" id="L53">                writeXmlFields(writer, encryptedFields);</span>
<span class="fc" id="L54">                writer.writeEndDocument();</span>

<span class="fc" id="L56">                return baos.toByteArray();</span>
            } finally {
<span class="pc bpc" id="L58" title="1 of 2 branches missed.">                if (writer != null) {</span>
<span class="fc" id="L59">                    writer.close();</span>
                }
            }
<span class="fc" id="L62">        }).get());</span>
    }

    private static void writeXmlFields(@NotNull XMLStreamWriter writer, @NotNull Map&lt;String, Object&gt; fieldMap) throws XMLStreamException {
<span class="fc" id="L66">        writer.writeStartElement(&quot;fields&quot;);</span>
<span class="fc" id="L67">        writer.writeAttribute(CDATA_ENCODING_ATTRIB, CDATA_ENCODING_BASE64);</span>

<span class="pc bpc" id="L69" title="1 of 2 branches missed.">        if (fieldMap != null) {</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">            for (Map.Entry&lt;String, Object&gt; entry : fieldMap.entrySet()) {</span>
<span class="fc" id="L71">                writer.writeStartElement(&quot;field&quot;);</span>
<span class="fc" id="L72">                writer.writeAttribute(&quot;name&quot;, entry.getKey());</span>
<span class="fc" id="L73">                writeXmlFieldValue(writer, entry.getValue());</span>
<span class="fc" id="L74">                writer.writeEndElement();</span>
<span class="fc" id="L75">            }</span>
        }
<span class="fc" id="L77">        writer.writeEndElement();</span>
<span class="fc" id="L78">    }</span>

    @SuppressWarnings(&quot;UseOfObsoleteDateTimeApi&quot;)
    private static void writeXmlFieldValue(@NotNull XMLStreamWriter writer, @Nullable Object value) throws XMLStreamException {
<span class="fc bfc" id="L82" title="All 4 branches covered.">        if ((value == null)</span>
<span class="fc bfc" id="L83" title="All 4 branches covered.">                || ((value instanceof String) &amp;&amp; ((String) value).isEmpty())</span>
<span class="pc bpc" id="L84" title="1 of 2 branches missed.">                || ((value instanceof Collection&lt;?&gt;) &amp;&amp; ((Collection) value).isEmpty())) {</span>
<span class="fc" id="L85">            writer.writeAttribute(&quot;type&quot;, &quot;null&quot;);</span>
<span class="fc bfc" id="L86" title="All 2 branches covered.">        } else if (value instanceof String) {</span>
<span class="fc" id="L87">            writer.writeAttribute(&quot;type&quot;, &quot;String&quot;);</span>
<span class="fc" id="L88">            writer.writeCData(toBase64(value.toString()));</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">        } else if (value instanceof Date) {</span>
<span class="fc" id="L90">            writer.writeAttribute(&quot;type&quot;, &quot;Date&quot;);</span>
<span class="fc" id="L91">            writer.writeCData(toBase64(Long.toString(((Date) value).getTime())));</span>
<span class="fc bfc" id="L92" title="All 2 branches covered.">        } else if (value instanceof TemporalAccessor) {</span>
<span class="fc bfc" id="L93" title="All 2 branches covered.">            if (value instanceof Instant) {</span>
<span class="fc" id="L94">                writer.writeAttribute(&quot;type&quot;, &quot;Instant&quot;);</span>
<span class="fc" id="L95">                writer.writeCData(toBase64(DateTimeFormatter.ISO_INSTANT.format((Instant) value)));</span>
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">            } else if (value instanceof ZonedDateTime) {</span>
<span class="fc" id="L97">                writer.writeAttribute(&quot;type&quot;, &quot;ZonedDateTimeFull&quot;);</span>
<span class="fc" id="L98">                writer.writeCData(toBase64(DateTimeFormatter.ISO_ZONED_DATE_TIME.format((ZonedDateTime) value)));</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">            } else if (value instanceof LocalDateTime) {</span>
<span class="nc" id="L100">                writer.writeAttribute(&quot;type&quot;, &quot;LocalDateTime&quot;);</span>
<span class="nc" id="L101">                writer.writeCData(toBase64(DateTimeFormatter.ISO_LOCAL_DATE_TIME.format((LocalDateTime) value)));</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            } else if (value instanceof LocalDate) {</span>
<span class="nc" id="L103">                writer.writeAttribute(&quot;type&quot;, &quot;LocalDate&quot;);</span>
<span class="nc" id="L104">                writer.writeCData(toBase64(DateTimeFormatter.ISO_LOCAL_DATE.format((LocalDate) value)));</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">            } else if (value instanceof LocalTime) {</span>
<span class="nc" id="L106">                writer.writeAttribute(&quot;type&quot;, &quot;LocalTime&quot;);</span>
<span class="nc" id="L107">                writer.writeCData(toBase64(DateTimeFormatter.ISO_LOCAL_TIME.format((LocalTime) value)));</span>
            } else {
<span class="nc" id="L109">                throw new RuntimeException(value.getClass() + &quot; is not a recognized encrypted field type&quot;);</span>
            }
<span class="fc bfc" id="L111" title="All 2 branches covered.">        } else if (value instanceof Long) {</span>
<span class="fc" id="L112">            writer.writeAttribute(&quot;type&quot;, &quot;Long&quot;);</span>
<span class="fc" id="L113">            writer.writeCData(toBase64(value.toString()));</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">        } else if (value instanceof Boolean) {</span>
<span class="fc" id="L115">            writer.writeAttribute(&quot;type&quot;, &quot;Boolean&quot;);</span>
<span class="fc" id="L116">            writer.writeCData(toBase64(value.toString()));</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">        } else if (value instanceof Double) {</span>
<span class="fc" id="L118">            writer.writeAttribute(&quot;type&quot;, &quot;Double&quot;);</span>
<span class="fc" id="L119">            writer.writeCData(toBase64(value.toString()));</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">        } else if (value instanceof List&lt;?&gt;) {</span>
<span class="fc" id="L121">            Object firstItem = ((List) value).get(0);</span>
<span class="fc bfc" id="L122" title="All 2 branches covered.">            if (firstItem instanceof String) {</span>
<span class="fc" id="L123">                writer.writeAttribute(&quot;type&quot;, &quot;List&lt;String&gt;&quot;);</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">                for (String listItem : ((List&lt;String&gt;) value)) {</span>
<span class="fc" id="L125">                    writer.writeStartElement(&quot;item&quot;);</span>
<span class="fc" id="L126">                    writer.writeCData(toBase64(listItem));</span>
<span class="fc" id="L127">                    writer.writeEndElement();</span>
<span class="fc" id="L128">                }</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">            } else if (firstItem instanceof Long) {</span>
<span class="nc" id="L130">                writer.writeAttribute(&quot;type&quot;, &quot;List&lt;Long&gt;&quot;);</span>
<span class="nc bnc" id="L131" title="All 2 branches missed.">                for (Long listItem : ((List&lt;Long&gt;) value)) {</span>
<span class="nc" id="L132">                    writer.writeStartElement(&quot;item&quot;);</span>
<span class="nc" id="L133">                    writer.writeCData(toBase64(listItem.toString()));</span>
<span class="nc" id="L134">                    writer.writeEndElement();</span>
<span class="nc" id="L135">                }</span>
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">            } else if (firstItem instanceof Enum) {</span>
<span class="nc" id="L137">                writer.writeAttribute(&quot;type&quot;, &quot;List&lt;String&gt;&quot;);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">                for (Enum listItem : ((List&lt;Enum&gt;) value)) {</span>
<span class="nc" id="L139">                    writer.writeStartElement(&quot;item&quot;);</span>
<span class="nc" id="L140">                    writer.writeCData(toBase64(listItem.toString()));</span>
<span class="nc" id="L141">                    writer.writeEndElement();</span>
<span class="nc" id="L142">                }</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">            } else if (firstItem instanceof Map) {</span>
                // list of nested DTOs!
<span class="fc" id="L145">                writer.writeAttribute(&quot;type&quot;, &quot;List&lt;Map&lt;String,Object&gt;&gt;&quot;);</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">                for (Map&lt;String, Object&gt; listItem : ((List&lt;Map&lt;String, Object&gt;&gt;) value)) {</span>
<span class="fc" id="L147">                    writer.writeStartElement(&quot;item&quot;);</span>
                    // add in the nested fields just as we add in these...
<span class="fc" id="L149">                    writeXmlFields(writer, listItem);</span>
<span class="fc" id="L150">                    writer.writeEndElement(); // item</span>
<span class="fc" id="L151">                }</span>
            } else {
<span class="nc" id="L153">                throw new RuntimeException(value.getClass() + &quot;&lt;&quot; + firstItem.getClass() + &quot;&gt; is not a recognized encrypted field type&quot;);</span>
            }
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">        } else if (value instanceof Map) {</span>
<span class="fc" id="L156">            Map.Entry firstEntry = (Map.Entry) ((Map) value).entrySet().iterator().next();</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">            if (!(firstEntry.getKey() instanceof String)) {</span>
<span class="nc" id="L158">                throw new RuntimeException(value.getClass() + &quot;&lt;&quot; + firstEntry.getKey().getClass()</span>
                        + &quot;, ?&gt; is not a recognized encrypted field type -- only Map&lt;String, Object&gt; for nested DTOs&quot;);
            }

<span class="fc" id="L162">            writer.writeAttribute(&quot;type&quot;, &quot;Map&lt;String,Object&gt;&quot;);</span>
            // add in the nested fields just as we add in these...
<span class="fc" id="L164">            writeXmlFields(writer, (Map&lt;String, Object&gt;) value);</span>
<span class="fc" id="L165">        } else {</span>
<span class="nc" id="L166">            throw new RuntimeException(value.getClass() + &quot; is not a recognized encrypted field type&quot;);</span>
        }
<span class="fc" id="L168">    }</span>

    @NotNull
    private static String toBase64(String s) {
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">        if (isEmpty(s)) {</span>
<span class="nc" id="L173">            return s;</span>
        }
<span class="fc" id="L175">        return Base64.getEncoder().encodeToString(s.getBytes(UTF_8));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>