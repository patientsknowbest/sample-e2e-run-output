<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MigrationConfig.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.fhir.migration.configuration</a> &gt; <span class="el_source">MigrationConfig.java</span></div><h1>MigrationConfig.java</h1><pre class="source lang-java linenums">package com.pkb.fhir.migration.configuration;

import ca.uhn.fhir.context.FhirContext;
import ca.uhn.fhir.rest.client.api.IGenericClient;
import com.pkb.entities.enums.MenuDataType;
import com.pkb.fhir.common.configuration.EhrmigratorConfig;
import com.pkb.fhir.common.decrypt.RetryingEhrDataDecryptor;
import com.pkb.fhir.common.repository.MenuDataRepository;
import com.pkb.fhir.common.retrieve.DataTypeBasedEhrDataRetriever;
import com.pkb.fhir.common.service.OrgService;
import com.pkb.fhir.common.service.PersonService;
import com.pkb.fhir.common.service.TeamService;
import com.pkb.fhir.common.transform.BaseEhrDataTransformer;
import com.pkb.fhir.migration.decrypt.MigrationEncryptedEhrDataDecryptor;
import com.pkb.fhir.migration.migrators.InstituteUserMigrator;
import com.pkb.fhir.migration.migrators.MenuDataMigrator;
import com.pkb.fhir.migration.migrators.MigrationManager;
import com.pkb.fhir.migration.migrators.OrgMigrator;
import com.pkb.fhir.migration.migrators.PKBPersonMigrator;
import com.pkb.fhir.migration.migrators.PatientConsentMigrator;
import com.pkb.fhir.migration.migrators.PatientOptOutMigrator;
import com.pkb.fhir.migration.migrators.ReferenceDatumMigrator;
import com.pkb.fhir.migration.migrators.TeamMigrator;
import com.pkb.fhir.migration.service.AccountService;
import com.pkb.fhir.migration.service.BaseMenuDataService;
import com.pkb.fhir.migration.service.ConsentService;
import com.pkb.fhir.migration.service.Hl7PartnerService;
import com.pkb.fhir.migration.service.InstituteUserService;
import com.pkb.fhir.migration.service.OrgExternalIdService;
import com.pkb.fhir.migration.service.PatientOptOutService;
import com.pkb.fhir.migration.service.ReferenceDatumService;
import com.pkb.fhir.migration.service.RetryManager;
import com.pkb.fhir.migration.transformation.MigrationDecryptedEhrDataTransformer;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.retry.backoff.ExponentialBackOffPolicy;
import org.springframework.retry.policy.AlwaysRetryPolicy;
import org.springframework.retry.support.RetryTemplate;
import org.springframework.scheduling.annotation.EnableScheduling;

import java.util.Map;

@Configuration
@EnableScheduling
<span class="fc" id="L45">public class MigrationConfig {</span>

    @Bean
    public MigrationManager migrationManager(PKBPersonMigrator pkbPersonMigrator,
                                             TeamMigrator teamMigrator,
                                             OrgMigrator orgMigrator,
                                             InstituteUserMigrator instituteUserMigrator,
                                             PatientOptOutMigrator patientOptOutMigrator,
                                             PatientConsentMigrator patientConsentMigrator,
                                             MenuDataMigrator menuDataMigrator,
                                             ReferenceDatumMigrator referenceDatumMigrator,
                                             EhrmigratorConfig config,
                                             IGenericClient fhirClient) {
<span class="fc" id="L58">        return new MigrationManager(pkbPersonMigrator, teamMigrator, orgMigrator, instituteUserMigrator, patientOptOutMigrator,</span>
                patientConsentMigrator, menuDataMigrator, referenceDatumMigrator, config, fhirClient);
    }

    @Bean
    public PKBPersonMigrator pkbPersonMigrator(PersonService personService, TeamService teamService, OrgService orgService,
                                               Hl7PartnerService hl7PartnerService, AccountService accountService) {
<span class="fc" id="L65">        return new PKBPersonMigrator(personService, teamService, orgService, hl7PartnerService, accountService);</span>
    }

    @Bean
    public OrgMigrator orgMigrator(PersonService personService, TeamService teamService, OrgService orgService,
                                   Hl7PartnerService hl7PartnerService, OrgExternalIdService orgExternalIdService) {
<span class="fc" id="L71">        return new OrgMigrator(personService, teamService, orgService, hl7PartnerService, orgExternalIdService);</span>
    }

    @Bean
    public TeamMigrator teamMigrator(PersonService personService, TeamService teamService, OrgService orgService,
                                     Hl7PartnerService hl7PartnerService, AccountService accountService) {
<span class="fc" id="L77">        return new TeamMigrator(personService, teamService, orgService, hl7PartnerService, accountService);</span>
    }

    @Bean
    public InstituteUserMigrator instituteUserMigrator(PersonService personService, TeamService teamService, OrgService orgService,
                                                       Hl7PartnerService hl7PartnerService, InstituteUserService instituteUserService) {
<span class="fc" id="L83">        return new InstituteUserMigrator(personService, teamService, orgService, hl7PartnerService, instituteUserService);</span>
    }

    @Bean
    public PatientOptOutMigrator patientOptOutMigrator(PersonService personService, TeamService teamService, OrgService orgService,
                                                       Hl7PartnerService hl7PartnerService, PatientOptOutService patientOptOutService,
                                                       BaseMenuDataService menuDataService) {
<span class="fc" id="L90">        return new PatientOptOutMigrator(personService, teamService, orgService, hl7PartnerService,</span>
                patientOptOutService, menuDataService);
    }

    @Bean
    public PatientConsentMigrator patientConsentMigrator(PersonService personService, TeamService teamService, OrgService orgService,
                                                         Hl7PartnerService hl7PartnerService, ConsentService consentService) {
<span class="fc" id="L97">        return new PatientConsentMigrator(personService, teamService, orgService, hl7PartnerService,</span>
                consentService);
    }

    @Bean
    public MenuDataMigrator menuDataMigrator(PersonService personService, TeamService teamService, OrgService orgService,
                                             Hl7PartnerService hl7PartnerService,
                                             MigrationEncryptedEhrDataDecryptor decryptor, MigrationDecryptedEhrDataTransformer transformer,
                                             FhirContext fhirContext) {
<span class="fc" id="L106">        return new MenuDataMigrator(personService, teamService, orgService, hl7PartnerService,</span>
                decryptor, transformer, fhirContext);
    }

    @Bean
    public ReferenceDatumMigrator referenceDatumMigrator(PersonService personService, TeamService teamService, OrgService orgService,
                                                         Hl7PartnerService hl7PartnerService, ReferenceDatumService referenceDatumService) {
<span class="fc" id="L113">        return new ReferenceDatumMigrator(personService, teamService, orgService, hl7PartnerService, referenceDatumService);</span>
    }

    @Bean
    public AlwaysRetryPolicy alwaysRetryPolicy() {
<span class="fc" id="L118">        return new AlwaysRetryPolicy();</span>
    }

    @Bean
    public ExponentialBackOffPolicy exponentialBackOffPolicy(EhrmigratorConfig config) {
<span class="fc" id="L123">        ExponentialBackOffPolicy backOffPolicy = new ExponentialBackOffPolicy();</span>
<span class="fc" id="L124">        backOffPolicy.setInitialInterval(config.getSyncRunnerBackoffInitialInterval());</span>
<span class="fc" id="L125">        backOffPolicy.setMaxInterval(config.getSyncRunnerBackoffMaxInterval());</span>
<span class="fc" id="L126">        backOffPolicy.setMultiplier(config.getSyncRunnerBackoffMultiplier());</span>
<span class="fc" id="L127">        return backOffPolicy;</span>
    }

    @Bean
    public RetryTemplate retryTemplate(AlwaysRetryPolicy alwaysRetryPolicy, ExponentialBackOffPolicy exponentialBackOffPolicy) {
<span class="fc" id="L132">        RetryTemplate template = new RetryTemplate();</span>
<span class="fc" id="L133">        template.setRetryPolicy(alwaysRetryPolicy);</span>
<span class="fc" id="L134">        template.setBackOffPolicy(exponentialBackOffPolicy);</span>
<span class="fc" id="L135">        return template;</span>
    }

    @Bean
    public RetryManager&lt;Boolean, RuntimeException&gt; retryManager(RetryTemplate retryTemplate) {
<span class="fc" id="L140">        return new RetryManager&lt;&gt;(retryTemplate);</span>
    }

    @Bean
    public MigrationDecryptedEhrDataTransformer decryptedEhrDataForMigrationTransformer(DataTypeBasedEhrDataRetriever dataTypeBasedEhrDataRetriever,
                                                                                        Map&lt;MenuDataType, BaseEhrDataTransformer&gt; transformerMap) {
<span class="fc" id="L146">        return new MigrationDecryptedEhrDataTransformer(dataTypeBasedEhrDataRetriever, transformerMap);</span>
    }

    @Bean
    public MigrationEncryptedEhrDataDecryptor encryptedEhrDataForMigrationDecryptor(MenuDataRepository menuDataRepository,
                                                                                    RetryingEhrDataDecryptor ehrDataDecryptor) {
<span class="fc" id="L152">        return new MigrationEncryptedEhrDataDecryptor(menuDataRepository, ehrDataDecryptor);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>