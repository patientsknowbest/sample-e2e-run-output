<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UploadedDataProcessingConfiguration.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.dataupload.processor</a> &gt; <span class="el_source">UploadedDataProcessingConfiguration.java</span></div><h1>UploadedDataProcessingConfiguration.java</h1><pre class="source lang-java linenums">package com.pkb.service.dataupload.processor;

import com.pkb.allergy.entity.Allergy;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.dataupload.entity.UploadedData;
import com.pkb.dataupload.entity.UploadedData.Destination;
import com.pkb.diagnosis.entity.Diagnosis;
import com.pkb.medication.entity.Medication;
import com.pkb.service.dataupload.processor.domain.ParsedObservationInformation;
import com.pkb.service.dataupload.processor.domain.UploadedAppointment;
import com.pkb.service.dataupload.processor.domain.UploadedDocument;
import com.pkb.service.dataupload.processor.parser.MultiformatUploadedDataParser;
import com.pkb.service.dataupload.processor.parser.UploadedDataParser;
import com.pkb.service.dataupload.processor.parser.hl7.Hl7AllergyParser;
import com.pkb.service.dataupload.processor.parser.hl7.Hl7CalendarParser;
import com.pkb.service.dataupload.processor.parser.hl7.Hl7CalendarPreParser;
import com.pkb.service.dataupload.processor.parser.hl7.Hl7DiagnosisParser;
import com.pkb.service.dataupload.processor.parser.hl7.Hl7DocumentParser;
import com.pkb.service.dataupload.processor.parser.hl7.Hl7EncounterParser;
import com.pkb.service.dataupload.processor.parser.hl7.Hl7MeasurementParser;
import com.pkb.service.dataupload.processor.parser.hl7.Hl7MedicationParser;
import com.pkb.service.dataupload.processor.parser.hl7.Hl7PhPlanParser;
import com.pkb.service.dataupload.processor.parser.hl7.Hl7RadiologyParser;
import com.pkb.service.dataupload.processor.parser.hl7.Hl7TestResultParser;
import com.pkb.service.dataupload.processor.parser.json.JsonMeasurementParser;
import com.pkb.service.dataupload.processor.parser.json.JsonTestResultsParser;
import com.pkb.service.dataupload.processor.persister.AllergyPersister;
import com.pkb.service.dataupload.processor.persister.CalendarPersister;
import com.pkb.service.dataupload.processor.persister.DiagnosisPersister;
import com.pkb.service.dataupload.processor.persister.DocumentPersister;
import com.pkb.service.dataupload.processor.persister.EncounterPersister;
import com.pkb.service.dataupload.processor.persister.MeasurementPersister;
import com.pkb.service.dataupload.processor.persister.MedicationPersister;
import com.pkb.service.dataupload.processor.persister.PhPlanPersister;
import com.pkb.service.dataupload.processor.persister.RadiologyPersister;
import com.pkb.service.dataupload.processor.persister.TestResultPersister;
import com.pkb.service.dataupload.processor.persister.UploadedDataPersister;
import com.pkb.service.team.TeamManager;
import com.pkb.test.entity.TestResultDTO;
import com.pkb.util.security.FileSecurityHandler;
import com.pkb.util.tolven.TolvenBeanFactory;
import org.jetbrains.annotations.NotNull;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;

import java.util.Arrays;
import java.util.Collections;
import java.util.EnumMap;
import java.util.List;
import java.util.Map;

@Configuration
<span class="fc" id="L55">public class UploadedDataProcessingConfiguration {</span>
    @Autowired
    private Hl7AllergyParser hl7AllergyParser;
    @Autowired
    private Hl7RadiologyParser hl7RadiologyParser;
    @Autowired
    private Hl7CalendarPreParser hl7CalendarPreParser;
    @Autowired
    private Hl7CalendarParser hl7CalendarParser;
    @Autowired
    private Hl7DocumentParser hl7DocumentParser;
    @Autowired
    private Hl7EncounterParser hl7EncounterParser;
    @Autowired
    private JsonTestResultsParser jsonTestResultsParser;
    @Autowired
    private Hl7DiagnosisParser hl7DiagnosisParser;
    @Autowired
    private Hl7MeasurementParser hl7MeasurementParser;
    @Autowired
    private JsonMeasurementParser jsonMeasurementParser;
    @Autowired
    private Hl7MedicationParser hl7MedicationParser;
    @Autowired
    private Hl7PhPlanParser hl7PhPlanParser;
    @Autowired
    private Hl7TestResultParser hl7TestResultParser;

    @Autowired
    private AllergyPersister allergyPersister;
    @Autowired
    private RadiologyPersister radiologyPersister;
    @Autowired
    private CalendarPersister calendarPersister;
    @Autowired
    private DocumentPersister documentPersister;
    @Autowired
    private EncounterPersister encounterPersister;
    @Autowired
    private DiagnosisPersister diagnosisPersister;
    @Autowired
    private MeasurementPersister measurementPersister;
    @Autowired
    private MedicationPersister medicationPersister;
    @Autowired
    private PhPlanPersister phPlanPersister;
    @Autowired
    private TestResultPersister testResultPersister;

    @Autowired
    private TolvenBeanFactory beanFactory;
    @Autowired
    private TeamManager teamManager;
    @Autowired
    private PhrConfig config;
    @Autowired
    private FileSecurityHandler fileSecurityHandler;
    @Autowired
    private DateTimeService dateTimeService;

    @Bean
    public Map&lt;UploadedData.Destination, UploadedDataProcessor&lt;?, LoggedInUploadedDataProcessingContext&gt;&gt; loggedInUploadedDataProcessorMapping() {
<span class="fc" id="L117">        Map&lt;UploadedData.Destination, UploadedDataProcessor&lt;?, LoggedInUploadedDataProcessingContext&gt;&gt; processorMapping = new EnumMap&lt;&gt;(UploadedData.Destination.class);</span>
<span class="fc" id="L118">        mapAllergyProcessor(processorMapping);</span>
<span class="fc" id="L119">        mapRadiologyProcessor(processorMapping);</span>
<span class="fc" id="L120">        mapCalendarProcessor(processorMapping);</span>

<span class="fc" id="L122">        mapEncounterProcessor(processorMapping);</span>
<span class="fc" id="L123">        mapCoreDevicesProcessor(processorMapping);</span>
<span class="fc" id="L124">        mapDiagnosisProcessor(processorMapping);</span>
<span class="fc" id="L125">        mapDeviceMeasurementsProcessor(processorMapping);</span>
<span class="fc" id="L126">        mapMeasurementsProcessor(processorMapping);</span>
<span class="fc" id="L127">        mapMedicationProcessor(processorMapping);</span>

<span class="fc" id="L129">        mapTestResultProcessor(processorMapping);</span>
<span class="fc" id="L130">        return Collections.unmodifiableMap(processorMapping);</span>
    }

    @Bean
    Map&lt;UploadedData.Destination, UploadedDataProcessor&lt;?, UploadedDataProcessingContext&gt;&gt; loggedOutUploadedDataProcessorMapping() {
<span class="fc" id="L135">        Map&lt;UploadedData.Destination, UploadedDataProcessor&lt;?, UploadedDataProcessingContext&gt;&gt; processorMapping = new EnumMap&lt;&gt;(UploadedData.Destination.class);</span>
<span class="fc" id="L136">        mapPhPlanProcessor(processorMapping);</span>
<span class="fc" id="L137">        mapDocumentProcessor(processorMapping);</span>
<span class="fc" id="L138">        return Collections.unmodifiableMap(processorMapping);</span>
    }

    private void mapTestResultProcessor(Map&lt;Destination, UploadedDataProcessor&lt;?, LoggedInUploadedDataProcessingContext&gt;&gt; processorMapping) {
<span class="fc" id="L142">        processorMapping.put(UploadedData.Destination.TEST_RESULT,</span>
<span class="fc" id="L143">                createUploadedDataProcessor(Collections.singletonList(new MultiformatUploadedDataParser&lt;&gt;(mapTestResultParsers())), testResultPersister));</span>
<span class="fc" id="L144">    }</span>

    private void mapPhPlanProcessor(Map&lt;Destination, UploadedDataProcessor&lt;?, UploadedDataProcessingContext&gt;&gt; processorMapping) {
<span class="fc" id="L147">        processorMapping.put(UploadedData.Destination.PHPLAN,</span>
<span class="fc" id="L148">                createUploadedDataProcessor(Collections.singletonList(hl7PhPlanParser), phPlanPersister));</span>
<span class="fc" id="L149">    }</span>

    private void mapMedicationProcessor(Map&lt;Destination, UploadedDataProcessor&lt;?, LoggedInUploadedDataProcessingContext&gt;&gt; processorMapping) {
<span class="fc" id="L152">        processorMapping.put(UploadedData.Destination.MEDICATION_UPDATE,</span>
<span class="fc" id="L153">                createUploadedDataProcessor(Collections.singletonList(new MultiformatUploadedDataParser&lt;&gt;(mapMedicationParsers())), medicationPersister));</span>
<span class="fc" id="L154">    }</span>

    private void mapMeasurementsProcessor(Map&lt;Destination, UploadedDataProcessor&lt;?, LoggedInUploadedDataProcessingContext&gt;&gt; processorMapping) {
<span class="fc" id="L157">        processorMapping.put(UploadedData.Destination.MEASUREMENT,</span>
<span class="fc" id="L158">                createUploadedDataProcessor(Collections.singletonList(hl7MeasurementParser), measurementPersister));</span>
<span class="fc" id="L159">    }</span>

    private void mapDeviceMeasurementsProcessor(Map&lt;Destination, UploadedDataProcessor&lt;?, LoggedInUploadedDataProcessingContext&gt;&gt; processorMapping) {
<span class="fc" id="L162">        processorMapping.put(UploadedData.Destination.DEVICE_MEASUREMENTS,</span>
<span class="fc" id="L163">                createUploadedDataProcessor(Collections.singletonList(jsonMeasurementParser), measurementPersister));</span>
<span class="fc" id="L164">    }</span>

    private void mapDiagnosisProcessor(Map&lt;Destination, UploadedDataProcessor&lt;?, LoggedInUploadedDataProcessingContext&gt;&gt; processorMapping) {
<span class="fc" id="L167">        processorMapping.put(UploadedData.Destination.DIAGNOSIS_UPDATE,</span>
<span class="fc" id="L168">                createUploadedDataProcessor(Collections.singletonList(new MultiformatUploadedDataParser&lt;&gt;(mapDiagnosisParsers())), diagnosisPersister));</span>
<span class="fc" id="L169">    }</span>

    private void mapCoreDevicesProcessor(Map&lt;Destination, UploadedDataProcessor&lt;?, LoggedInUploadedDataProcessingContext&gt;&gt; processorMapping) {
<span class="fc" id="L172">        processorMapping.put(UploadedData.Destination.CORE_DEVICES,</span>
<span class="fc" id="L173">                createUploadedDataProcessor(Collections.singletonList(jsonTestResultsParser), testResultPersister));</span>
<span class="fc" id="L174">    }</span>

    private void mapEncounterProcessor(Map&lt;Destination, UploadedDataProcessor&lt;?, LoggedInUploadedDataProcessingContext&gt;&gt; processorMapping) {
<span class="fc" id="L177">        processorMapping.put(UploadedData.Destination.ENCOUNTER,</span>
<span class="fc" id="L178">                createUploadedDataProcessor(Collections.singletonList(hl7EncounterParser), encounterPersister));</span>
<span class="fc" id="L179">    }</span>

    private void mapDocumentProcessor(Map&lt;Destination, UploadedDataProcessor&lt;?, UploadedDataProcessingContext&gt;&gt; processorMapping) {
<span class="fc" id="L182">        processorMapping.put(UploadedData.Destination.DOCUMENT,</span>
<span class="fc" id="L183">                createUploadedDataProcessor(Collections.singletonList(new MultiformatUploadedDataParser&lt;&gt;(mapDocumentParsers())), documentPersister));</span>
<span class="fc" id="L184">    }</span>

    private void mapCalendarProcessor(Map&lt;Destination, UploadedDataProcessor&lt;?, LoggedInUploadedDataProcessingContext&gt;&gt; processorMapping) {
<span class="fc" id="L187">        processorMapping.put(UploadedData.Destination.APPOINTMENT,</span>
<span class="fc" id="L188">                createUploadedDataProcessor(Arrays.asList(new MultiformatUploadedDataParser&lt;&gt;(mapCalendarPreParsers()), new MultiformatUploadedDataParser&lt;&gt;(mapCalendarParsers())),</span>
                        calendarPersister));
<span class="fc" id="L190">    }</span>

    private void mapRadiologyProcessor(Map&lt;Destination, UploadedDataProcessor&lt;?, LoggedInUploadedDataProcessingContext&gt;&gt; processorMapping) {
<span class="fc" id="L193">        processorMapping.put(UploadedData.Destination.RADIOLOGY, createUploadedDataProcessor(Collections.singletonList(hl7RadiologyParser), radiologyPersister));</span>
<span class="fc" id="L194">    }</span>

    private void mapAllergyProcessor(Map&lt;Destination, UploadedDataProcessor&lt;?, LoggedInUploadedDataProcessingContext&gt;&gt; processorMapping) {
<span class="fc" id="L197">        processorMapping.put(UploadedData.Destination.ALLERGY_UPDATE,</span>
<span class="fc" id="L198">                createUploadedDataProcessor(Collections.singletonList(new MultiformatUploadedDataParser&lt;&gt;(mapAllergyParsers())), allergyPersister));</span>
<span class="fc" id="L199">    }</span>

    private &lt;T, C extends UploadedDataProcessingContext&gt; UploadedDataProcessor&lt;T, C&gt; createUploadedDataProcessor(List&lt;UploadedDataParser&lt;T, C&gt;&gt; parser,
                                                                                                                 UploadedDataPersister&lt;T, C&gt; persister) {
<span class="fc" id="L203">        return new DefaultUploadedDataProcessor&lt;&gt;(parser, persister);</span>
    }

    private Map&lt;UploadedData.Format, UploadedDataParser&lt;UploadedAppointment, LoggedInUploadedDataProcessingContext&gt;&gt; mapCalendarPreParsers() {
<span class="fc" id="L207">        Map&lt;UploadedData.Format, UploadedDataParser&lt;UploadedAppointment, LoggedInUploadedDataProcessingContext&gt;&gt; parserMapping = new EnumMap&lt;&gt;(UploadedData.Format.class);</span>
<span class="fc" id="L208">        mapParser(parserMapping, hl7CalendarPreParser);</span>
<span class="fc" id="L209">        return parserMapping;</span>
    }

    private Map&lt;UploadedData.Format, UploadedDataParser&lt;UploadedAppointment, LoggedInUploadedDataProcessingContext&gt;&gt; mapCalendarParsers() {
<span class="fc" id="L213">        Map&lt;UploadedData.Format, UploadedDataParser&lt;UploadedAppointment, LoggedInUploadedDataProcessingContext&gt;&gt; parserMapping = new EnumMap&lt;&gt;(UploadedData.Format.class);</span>
<span class="fc" id="L214">        mapParser(parserMapping, hl7CalendarParser);</span>
<span class="fc" id="L215">        return parserMapping;</span>
    }

    @NotNull
    private Map&lt;UploadedData.Format, UploadedDataParser&lt;Allergy, LoggedInUploadedDataProcessingContext&gt;&gt; mapAllergyParsers() {
<span class="fc" id="L220">        Map&lt;UploadedData.Format, UploadedDataParser&lt;Allergy, LoggedInUploadedDataProcessingContext&gt;&gt; parserMapping = new EnumMap&lt;&gt;(UploadedData.Format.class);</span>
<span class="fc" id="L221">        mapParser(parserMapping, hl7AllergyParser);</span>
<span class="fc" id="L222">        return parserMapping;</span>
    }

    private Map&lt;UploadedData.Format, UploadedDataParser&lt;Diagnosis, LoggedInUploadedDataProcessingContext&gt;&gt; mapDiagnosisParsers() {
<span class="fc" id="L226">        Map&lt;UploadedData.Format, UploadedDataParser&lt;Diagnosis, LoggedInUploadedDataProcessingContext&gt;&gt; parserMapping = new EnumMap&lt;&gt;(UploadedData.Format.class);</span>
<span class="fc" id="L227">        mapParser(parserMapping, hl7DiagnosisParser);</span>
<span class="fc" id="L228">        return parserMapping;</span>
    }

    private Map&lt;UploadedData.Format, UploadedDataParser&lt;ParsedObservationInformation&lt;TestResultDTO&gt;, LoggedInUploadedDataProcessingContext&gt;&gt; mapTestResultParsers() {
<span class="fc" id="L232">        Map&lt;UploadedData.Format, UploadedDataParser&lt;ParsedObservationInformation&lt;TestResultDTO&gt;, LoggedInUploadedDataProcessingContext&gt;&gt; parserMapping = new EnumMap&lt;&gt;(UploadedData.Format.class);</span>
<span class="fc" id="L233">        mapParser(parserMapping, hl7TestResultParser);</span>
<span class="fc" id="L234">        return parserMapping;</span>
    }

    private Map&lt;UploadedData.Format, UploadedDataParser&lt;UploadedDocument, UploadedDataProcessingContext&gt;&gt; mapDocumentParsers() {
<span class="fc" id="L238">        Map&lt;UploadedData.Format, UploadedDataParser&lt;UploadedDocument, UploadedDataProcessingContext&gt;&gt; parserMapping = new EnumMap&lt;&gt;(UploadedData.Format.class);</span>
<span class="fc" id="L239">        mapParser(parserMapping, hl7DocumentParser);</span>
<span class="fc" id="L240">        return parserMapping;</span>
    }

    private Map&lt;UploadedData.Format, UploadedDataParser&lt;Medication, LoggedInUploadedDataProcessingContext&gt;&gt; mapMedicationParsers() {
<span class="fc" id="L244">        Map&lt;UploadedData.Format, UploadedDataParser&lt;Medication, LoggedInUploadedDataProcessingContext&gt;&gt; parserMapping = new EnumMap&lt;&gt;(UploadedData.Format.class);</span>
<span class="fc" id="L245">        mapParser(parserMapping, hl7MedicationParser);</span>
<span class="fc" id="L246">        return parserMapping;</span>
    }

    private &lt;T, C extends UploadedDataProcessingContext&gt; void mapParser(Map&lt;UploadedData.Format, UploadedDataParser&lt;T, C&gt;&gt; mapping, UploadedDataParser&lt;T, C&gt; parser) {
<span class="fc" id="L250">        parser.getSupportedFormat().forEach(format -&gt; mapping.put(format, parser));</span>
<span class="fc" id="L251">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>