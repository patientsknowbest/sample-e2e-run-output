<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BulkInvitationResultProcessor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.patient.invite.bulk.csv</a> &gt; <span class="el_source">BulkInvitationResultProcessor.java</span></div><h1>BulkInvitationResultProcessor.java</h1><pre class="source lang-java linenums">package com.pkb.patient.invite.bulk.csv;

import com.google.common.collect.ImmutableMap;
import com.pkb.common.base.Error;
import com.pkb.common.csv.CsvRecord;
import com.pkb.patient.invite.PatientRegister.FailureReason;
import com.pkb.patient.invite.PatientRegister.SuccessType;
import com.pkb.patient.invite.bulk.LineNumberedInvitationResult;

import java.util.List;
import java.util.Map;
import java.util.function.Function;
import java.util.function.Supplier;

import static com.pkb.patient.invite.bulk.csv.BulkInvitationConstants.ACCOUNT_CREATION_OUTCOME;
import static com.pkb.patient.invite.bulk.csv.BulkInvitationConstants.CARER_ONE_EMAIL;
import static com.pkb.patient.invite.bulk.csv.BulkInvitationConstants.CARER_ONE_OUTCOME;
import static com.pkb.patient.invite.bulk.csv.BulkInvitationConstants.CARER_TWO_EMAIL;
import static com.pkb.patient.invite.bulk.csv.BulkInvitationConstants.CARER_TWO_OUTCOME;
import static java.lang.String.format;
import static java.util.stream.Collectors.joining;
import static org.apache.commons.lang3.StringUtils.EMPTY;

<span class="fc" id="L24">public class BulkInvitationResultProcessor {</span>
    private static final String SUCCESS_PATTERN = &quot;Success - &lt;%s&gt;&quot;;
    private static final String FAILURE_PATTERN = &quot;Failure - &lt;%s&gt;&quot;;

    public Map&lt;String, String&gt; process(CsvRecord invitation, LineNumberedInvitationResult invitationResult) {
<span class="fc" id="L29">        return ImmutableMap.of(</span>
<span class="fc" id="L30">                ACCOUNT_CREATION_OUTCOME, labelPatientInvitationOutcome(invitationResult),</span>
<span class="fc" id="L31">                CARER_ONE_OUTCOME, labelCarerOneInvitation(invitation.getColumn(CARER_ONE_EMAIL), invitationResult),</span>
<span class="fc" id="L32">                CARER_TWO_OUTCOME, labelCarerTwoInvitation(invitation.getColumn(CARER_TWO_EMAIL), invitationResult)</span>
        );
    }

    private String labelPatientInvitationOutcome(LineNumberedInvitationResult invitationResult) {
<span class="fc" id="L37">        return invitationResult.getResult().map(</span>
                success -&gt; {
<span class="pc bpc" id="L39" title="1 of 7 branches missed.">                    switch (success.getSuccessType()) {</span>
                        case INVITED_TO_REGISTER:
<span class="fc" id="L41">                            return success(&quot;Existing patient invited to register&quot;);</span>
                        case ADDED_TO_TEAM_DEFERRED:
<span class="fc" id="L43">                            return success(&quot;Existing patient added to your team - awaiting record unlock&quot;);</span>
                        case ADDED_TO_TEAM:
<span class="fc" id="L45">                            return success(&quot;Existing patient added to your team&quot;);</span>
                        case ALREADY_IN_TEAM:
<span class="fc" id="L47">                            return success(&quot;Patient already in your team&quot;);</span>
                        case NEW_ACCOUNT_CREATED:
<span class="fc" id="L49">                            return success(&quot;New account created&quot;);</span>
                        case NEW_ACCOUNT_CREATED_AND_INVITATION_SENT:
<span class="fc" id="L51">                            return success(&quot;New account created &amp; invitation sent&quot;);</span>
                        default:
<span class="nc" id="L53">                            return success(unhandled(SuccessType.class, success.getSuccessType()));</span>
                    }
<span class="fc" id="L55">                }).mapLeft(</span>
                failure -&gt; {
<span class="fc" id="L57">                    FailureReason failureReason = failure.getPatientInvitationFailureReason();</span>
<span class="fc" id="L58">                    String patientInvitationErrors = concatenateErrorDescriptions(failure.getPatientInvitationErrors());</span>

<span class="pc bpc" id="L60" title="2 of 4 branches missed.">                    switch (failureReason) {</span>
                    case FAILED_TO_PARSE:
                    case FAILED_TO_INVITE_EXISTING_USER_WITHOUT_EMAIL:
                    case FAILED_TO_INVITE_EXISTING_USER_WITH_EXISTING_EMAIL:
<span class="fc" id="L64">                        return failure(patientInvitationErrors);</span>
                    case USER_WITH_NATIONAL_ID_EXISTS:
                    case USER_WITH_ORG_LEVEL_ID_EXISTS:
                    case USER_WITH_TEAM_LEVEL_ID_EXISTS:
<span class="fc" id="L68">                        return failure(&quot;This account belongs to existing user. Details: %s&quot;, patientInvitationErrors);</span>
                    case EXISTING_USER_IS_NOT_A_PATIENT:
                    case TEAM_DOES_NOT_HAVE_EXACTLY_ONE_TEAM_LEVEL_ID_TYPE:
                    case ORG_DOES_NOT_HAVE_EXACTLY_ONE_ORG_LEVEL_ID_TYPE:
                    case PATIENT_IS_OPTED_OUT:
<span class="nc" id="L73">                        return failure(&quot;Details: %s&quot;, patientInvitationErrors);</span>
                    case UNKNOWN:
                        // fall through to default.
                    default:
<span class="nc" id="L77">                        return failure(unhandled(FailureReason.class, failureReason));</span>
                    }
<span class="fc" id="L79">                }).fold(Function.identity(), Function.identity());</span>
    }

    private String labelCarerOneInvitation(String carerEmail, LineNumberedInvitationResult invitationResult) {
<span class="fc" id="L83">        return invitationResult.getResult()</span>
<span class="fc" id="L84">                .map(success -&gt; labelSuccessfulCarerInvitation(carerEmail, success::isCarerOneSuccessfullyInvited, success::getCarerOneInvitationErrors))</span>
<span class="fc" id="L85">                .mapLeft(failure -&gt; labelFailedCarerInvitation(carerEmail, failure.getCarerOneInvitationErrors()))</span>
<span class="fc" id="L86">                .fold(Function.identity(), Function.identity());</span>
    }

    private String labelCarerTwoInvitation(String carerEmail, LineNumberedInvitationResult invitationResult) {
<span class="fc" id="L90">        return invitationResult.getResult()</span>
<span class="fc" id="L91">                .map(success -&gt; labelSuccessfulCarerInvitation(carerEmail, success::isCarerTwoSuccessfullyInvited, success::getCarerTwoInvitationErrors))</span>
<span class="fc" id="L92">                .mapLeft(failure -&gt; labelFailedCarerInvitation(carerEmail, failure.getCarerTwoInvitationErrors()))</span>
<span class="fc" id="L93">                .fold(Function.identity(), Function.identity());</span>
    }

    private String success(String message) {
<span class="fc" id="L97">        return format(SUCCESS_PATTERN, message);</span>
    }

    private String failure(String reason) {
<span class="fc" id="L101">        return format(FAILURE_PATTERN, reason);</span>
    }

    private String failure(String reasonPattern, String... arguments) {
<span class="fc" id="L105">        return failure(format(reasonPattern, arguments));</span>
    }

    private &lt;T&gt; String unhandled(Class&lt;T&gt; type, T value) {
<span class="nc" id="L109">        return format(&quot;Unhandled %s: %s&quot;, type.getSimpleName(), value);</span>
    }

    private String labelSuccessfulCarerInvitation(Object carerEmail, Supplier&lt;Boolean&gt; test, Supplier&lt;List&lt;Error&gt;&gt; listErrors) {
<span class="fc bfc" id="L113" title="All 2 branches covered.">        return test.get() ? &quot;Carer successfully invited&quot; : labelFailedCarerInvitation(carerEmail, listErrors.get());</span>
    }

    private String labelFailedCarerInvitation(Object carerEmail, List&lt;Error&gt; errors) {
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        return errors.isEmpty() ? EMPTY : format(&quot;Unable to invite carer '%s': %s&quot;, carerEmail, concatenateErrorDescriptions(errors));</span>
    }

    private String concatenateErrorDescriptions(List&lt;Error&gt; errors) {
<span class="fc" id="L121">        return errors.stream().map(Error::getDescription).collect(joining(&quot;;&quot;));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>