<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuestionnaireResponseMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.fhir.questionnaire</a> &gt; <span class="el_source">QuestionnaireResponseMapper.java</span></div><h1>QuestionnaireResponseMapper.java</h1><pre class="source lang-java linenums">package com.pkb.api.fhir.questionnaire;

import com.pkb.api.fhir.TemporalMapper;
import com.pkb.api.fhir.foundation.ReferenceMapper;
import com.pkb.api.fhir.person.RelatedPersonMapper;
import com.pkb.datamodel.user.Patient;
import com.pkb.questionnaireservice.modelv2.Answer;
import com.pkb.questionnaireservice.modelv2.MultiSelectAnswer;
import com.pkb.questionnaireservice.modelv2.SingleSelectAnswer;
import io.vavr.Value;
import io.vavr.collection.Stream;
import io.vavr.control.Option;
import org.hl7.fhir.dstu3.model.Meta;
import org.hl7.fhir.dstu3.model.QuestionnaireResponse;
import org.hl7.fhir.dstu3.model.Reference;
import org.hl7.fhir.dstu3.model.RelatedPerson;
import org.hl7.fhir.dstu3.model.ResourceType;
import org.hl7.fhir.dstu3.model.StringType;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;

import java.time.ZoneOffset;
import java.util.List;
import java.util.stream.Collectors;

import static com.pkb.api.fhir.IdGeneratorUtil.generateIdFor;
import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.Match;
import static io.vavr.API.None;
import static io.vavr.API.Some;
import static io.vavr.Predicates.instanceOf;
import static java.lang.invoke.MethodHandles.lookup;
import static org.immutables.value.internal.$guava$.base.$Preconditions.checkState;
import static org.slf4j.LoggerFactory.getLogger;

public class QuestionnaireResponseMapper {

<span class="fc" id="L39">    private static final Logger LOGGER = getLogger(lookup().lookupClass());</span>

    private final TemporalMapper timeMapper;
    private final ReferenceMapper referenceMapper;
    private final RelatedPersonMapper relatedPersonMapper;
    private final QuestionnaireRequestMapper questionnaireRequestMapper;

    public QuestionnaireResponseMapper(TemporalMapper timeMapper, ReferenceMapper referenceMapper,
<span class="fc" id="L47">                                       RelatedPersonMapper relatedPersonMapper, QuestionnaireRequestMapper questionnaireRequestMapper) {</span>
<span class="fc" id="L48">        this.timeMapper = timeMapper;</span>
<span class="fc" id="L49">        this.referenceMapper = referenceMapper;</span>
<span class="fc" id="L50">        this.relatedPersonMapper = relatedPersonMapper;</span>
<span class="fc" id="L51">        this.questionnaireRequestMapper = questionnaireRequestMapper;</span>
<span class="fc" id="L52">    }</span>

    public @NotNull QuestionnaireResponse toQuestionnaireResponse(com.pkb.questionnaireservice.modelv2.QuestionnaireResponse questionnaireResponse,
                                                                  Patient patient,
                                                                  Option&lt;Patient&gt; completedBy) {
<span class="fc" id="L57">        QuestionnaireResponse fhirResponse = new QuestionnaireResponse();</span>
<span class="fc" id="L58">        fhirResponse.setId(questionnaireResponse.getId().toString());</span>
<span class="fc" id="L59">        fhirResponse.setMeta(extractMetadata(questionnaireResponse));</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">        if (questionnaireResponse.wasCompletedByThePatient()){</span>
<span class="fc" id="L61">            fhirResponse.setSource(referenceMapper.toReferenceWithName(patient));</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">        } else if (completedBy.isDefined()){</span>
            // In case the questionnaire response was submitted by a carer, we add it as a contained reference
<span class="fc" id="L64">            RelatedPerson relatedPerson = relatedPersonMapper.toRelatedPerson(patient, completedBy.get());</span>
<span class="fc" id="L65">            relatedPerson.setId(&quot;#carer-&quot; + generateIdFor(completedBy.get(), Patient::toString));</span>
<span class="fc" id="L66">            fhirResponse.addContained(relatedPerson);</span>

<span class="fc" id="L68">            Reference reference = new Reference();</span>
<span class="fc" id="L69">            reference.setReference(relatedPerson.getId());</span>
<span class="fc" id="L70">            reference.setDisplay(referenceMapper.toDisplay(completedBy.get()));</span>
<span class="fc" id="L71">            fhirResponse.setSource(reference);</span>
        }
<span class="fc" id="L73">        fhirResponse.setBasedOn(List.of(referenceMapper.toReference(ResourceType.ProcedureRequest, questionnaireResponse.getQuestionnaireRequest().getId())));</span>
<span class="fc" id="L74">        fhirResponse.setQuestionnaire(referenceMapper.toReferenceWithName(questionnaireResponse.getQuestionnaireRequest().getQuestionnaire()));</span>
<span class="fc" id="L75">        fhirResponse.setStatus(QuestionnaireResponse.QuestionnaireResponseStatus.COMPLETED);</span>
<span class="fc" id="L76">        fhirResponse.setSubject(referenceMapper.toReferenceWithName(patient));</span>
<span class="fc" id="L77">        fhirResponse.setAuthoredElement(timeMapper.toDateTimeType(questionnaireResponse.getCreatedDate().atZone(ZoneOffset.UTC)));</span>
<span class="fc" id="L78">        fhirResponse.setItem(questionnaireResponse.getAnswers().stream().map(this::mapAnswerToResponseItem).collect(Collectors.toList()));</span>
<span class="fc" id="L79">        LOGGER.info(&quot;Successfully mapped Questionnaire Response: {} for Questionnaire: {}&quot;,questionnaireResponse.getId(), questionnaireResponse.getQuestionnaireRequest().getQuestionnaire().getId());</span>
<span class="fc" id="L80">        return fhirResponse;</span>

    }
    
    private QuestionnaireResponse.QuestionnaireResponseItemComponent mapAnswerToResponseItem(Answer answer) {
<span class="fc" id="L85">        QuestionnaireResponse.QuestionnaireResponseItemComponent fhirItem = new QuestionnaireResponse.QuestionnaireResponseItemComponent();</span>
<span class="fc" id="L86">        fhirItem.setLinkId(answer.getQuestion().getId().toString());</span>
<span class="fc" id="L87">        fhirItem.setText(answer.getQuestion().getDisplayText());</span>
<span class="fc" id="L88">        Match(answer).of(</span>
<span class="fc" id="L89">                Case($(instanceOf(MultiSelectAnswer.class)), this::generateFhirAnswers),</span>
<span class="fc" id="L90">                Case($(instanceOf(SingleSelectAnswer.class)), this::generateFhirAnswer),</span>
<span class="fc" id="L91">                Case($(), otherAnswer -&gt; generateFhirAnswer(answer)))</span>
<span class="fc" id="L92">            .forEach(fhirItem::addAnswer);</span>
<span class="fc" id="L93">        return fhirItem;</span>
    }

    private Value&lt;QuestionnaireResponse.QuestionnaireResponseItemAnswerComponent&gt; generateFhirAnswers(MultiSelectAnswer answer) {
<span class="fc" id="L97">        return Stream.ofAll(answer.getAnswers())</span>
<span class="fc" id="L98">                .map(id -&gt; answer.getQuestion().getPossibleAnswers().stream()</span>
<span class="fc" id="L99">                        .filter(pos -&gt; pos.getId().equals(id)).findFirst()</span>
<span class="pc" id="L100">                        .orElseThrow(() -&gt; new IllegalStateException(String.format(&quot;MultiSelect contains an answer id that does not match possible answers. AnswerIds: %s. QuestionId: %s. &quot;, answer.getAnswers(), answer.getQuestion().getId()))))</span>
<span class="fc" id="L101">                .map(answerValue -&gt; {</span>
<span class="fc" id="L102">                    QuestionnaireResponse.QuestionnaireResponseItemAnswerComponent fhirAnswer = new QuestionnaireResponse.QuestionnaireResponseItemAnswerComponent();</span>
<span class="fc" id="L103">                    return fhirAnswer.setValue(new StringType(answerValue.getDisplayText()));</span>
                });
    }

    private Value&lt;QuestionnaireResponse.QuestionnaireResponseItemAnswerComponent&gt; generateFhirAnswer(SingleSelectAnswer answer) {
<span class="fc bfc" id="L108" title="All 2 branches covered.">        if (answer.getAnswerId() == null) {</span>
<span class="fc" id="L109">            return None();</span>
        } else {
<span class="fc" id="L111">            QuestionnaireResponse.QuestionnaireResponseItemAnswerComponent fhirAnswer = new QuestionnaireResponse.QuestionnaireResponseItemAnswerComponent();</span>
<span class="fc" id="L112">            checkState(answer.getQuestion().getPossibleAnswers().stream().anyMatch(pos -&gt; pos.getId().equals(answer.getAnswerId())), String.format(&quot;SingleSelect contains an answer id that does not match possible answers. AnswerId: %s. QuestionId: %s&quot;,answer.getAnswerId(), answer.getQuestion().getId()));</span>
<span class="fc" id="L113">            fhirAnswer.setValue(new StringType(answer.getAnswerText()));</span>
<span class="fc" id="L114">            LOGGER.info(&quot;Successfully mapped SingleSelectAnswer: {} for Question: {}&quot;, answer.getAnswerId(), answer.getQuestion().getId());</span>
<span class="fc" id="L115">            return Some(fhirAnswer);</span>
        }
    }

    private Value&lt;QuestionnaireResponse.QuestionnaireResponseItemAnswerComponent&gt; generateFhirAnswer(Answer answer) {
<span class="fc" id="L120">        QuestionnaireResponse.QuestionnaireResponseItemAnswerComponent fhirAnswer = new QuestionnaireResponse.QuestionnaireResponseItemAnswerComponent();</span>
<span class="fc" id="L121">        fhirAnswer.setValue(new StringType(answer.getAnswerText()));</span>
<span class="fc" id="L122">        return Some(fhirAnswer);</span>
    }

    private @NotNull Meta extractMetadata(com.pkb.questionnaireservice.modelv2.QuestionnaireResponse response) {
<span class="fc" id="L126">        Meta meta = new Meta();</span>
<span class="fc" id="L127">        meta.setLastUpdatedElement(timeMapper.toInstantTypeInUTC(response.getCreatedDate().atZone(ZoneOffset.UTC)));</span>
        //Note - we are not currently mapping privacy flags        
<span class="fc" id="L129">        return meta;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>