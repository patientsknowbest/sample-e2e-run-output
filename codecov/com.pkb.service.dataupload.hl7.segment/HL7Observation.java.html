<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HL7Observation.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.dataupload.hl7.segment</a> &gt; <span class="el_source">HL7Observation.java</span></div><h1>HL7Observation.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------
//
// Copyright (c) 2011 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: $
//
//------------------------------------------------------------------------------

package com.pkb.service.dataupload.hl7.segment;

import com.pkb.service.dataupload.hl7.HL7MessageProperties;
import com.pkb.service.dataupload.hl7.HL7XmlDoc;
import com.pkb.service.dataupload.hl7.field.HL7Code;
import com.pkb.service.dataupload.hl7.value.HL7Date;
import com.pkb.service.dataupload.hl7.value.HL7String;
import io.vavr.Tuple;
import io.vavr.Tuple2;
import io.vavr.collection.Stream;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.Element;

import java.io.Serializable;
import java.lang.invoke.MethodHandles;
import java.util.ArrayList;
import java.util.List;
import java.util.Set;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

/**
 * Parses an OBX segment. See HL7 v2.4 Chapter 7.
 *
 * An observation is (usually) a single OBX record in an order group.
 * Each OBX may have its own NTE list; these are added in from the main parse loop.
 *
 * @see HL7OrderGroup
 * @author robwhelan
 */
public class HL7Observation implements Serializable {

<span class="fc" id="L43">    private static final Pattern WINDOWS_NEWLINE_PATTERN = Pattern.compile(&quot;\r\n&quot;, Pattern.LITERAL);</span>

<span class="fc" id="L45">    private static final Set&lt;String&gt; TEXT_VALUE_TYPES = Set.of(&quot;TX&quot;, &quot;FT&quot;, &quot;ST&quot;);</span>

    public Tuple2&lt;String, String&gt; getTestId() {
<span class="fc" id="L48">        return Tuple.of(</span>
<span class="fc" id="L49">                StringUtils.trimToEmpty(getTestCode().getId().getString()),</span>
<span class="fc" id="L50">                StringUtils.trimToEmpty(getTestCode().getCodingSystem().getString()));</span>

    }

    public boolean isTestIdMatch(HL7Observation observation) {
<span class="fc" id="L55">        return Stream.of(this, observation)</span>
<span class="fc" id="L56">                .map(HL7Observation::getTestId)</span>
<span class="fc" id="L57">                .distinct()</span>
<span class="fc bfc" id="L58" title="All 2 branches covered.">                .length() == 1;</span>
    }

    public boolean isTextValueType() {
<span class="fc" id="L62">        return TEXT_VALUE_TYPES.contains(getValueType().getString());</span>
    }

<span class="nc" id="L65">    public enum SNArithmeticOperator {</span>
<span class="nc" id="L66">        PLUS('+'), MINUS('-'), DIV('/'), DOT('.'), COLON(':');</span>

        private char symbol;

<span class="nc" id="L70">        SNArithmeticOperator(char symbol) {</span>
<span class="nc" id="L71">            this.symbol = symbol;</span>
<span class="nc" id="L72">        }</span>

        public String getSymbol() {
<span class="nc" id="L75">            return String.valueOf(symbol);</span>
        }

        @Override
        public String toString() {
<span class="nc" id="L80">            return String.valueOf(symbol);</span>
        }

    }

    private static final long serialVersionUID = 1L;

<span class="fc" id="L87">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

<span class="fc" id="L89">    private List&lt;HL7String&gt; noteList = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L91">    private HL7String obxSetId = new HL7String();</span>
<span class="fc" id="L92">    private HL7String valueType = new HL7String();</span>
<span class="fc" id="L93">    private HL7String resultStatus = new HL7String();</span>
<span class="fc" id="L94">    private HL7Code testCode = new HL7Code();</span>

<span class="fc" id="L96">    private HL7String valueText = new HL7String();</span>
    // for the ED (encapsulated data) value type: application^datatype^subdatatype^encoding^value
<span class="fc" id="L98">    private HL7String edApplication = new HL7String();</span>
<span class="fc" id="L99">    private HL7String edDataType = new HL7String();</span>
<span class="fc" id="L100">    private HL7String edSubDataType = new HL7String();</span>
<span class="fc" id="L101">    private HL7String edEncoding = new HL7String();</span>
    private byte[] edValue;

<span class="fc" id="L104">    private HL7Code unitCode = new HL7Code();</span>

<span class="fc" id="L106">    private HL7String textRange = new HL7String();</span>

<span class="fc" id="L108">    private HL7Date timestamp = new HL7Date();</span>
    private Double valueNumeric;
    private Double rangeLow, rangeHigh;
    private boolean rangeLowInclusive, rangeHighInclusive;

    // used to delay when a patient can see lab results
<span class="fc" id="L114">    private HL7String accessChecks = new HL7String();</span>

    /**
     * some ORU^R01 messages may contain a mix of data types - this allows a single parsing run;
     * then different methods can review not-yet-processed observations
     */
<span class="fc" id="L120">    private boolean processed = false;</span>

    private HL7MessageProperties messageProperties;
    private HL7ComparatorOperator valueComparator;

<span class="fc" id="L125">    public HL7Observation(HL7MessageProperties messageProperties) {</span>
<span class="fc" id="L126">        this.messageProperties = messageProperties;</span>
<span class="fc" id="L127">    }</span>

    public void parseNte(Element nte) {
        // may have multiple lines (using multiple value separator)
<span class="fc" id="L131">        List&lt;HL7String&gt; nteTextList = HL7XmlDoc.getHl7TextList(nte, &quot;NTE.3.1&quot;, true/*unescape*/, false/*trim*/);</span>

<span class="fc" id="L133">        boolean first = true;</span>
<span class="fc" id="L134">        String i = null;</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">        for (HL7String instr : nteTextList) {</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">            if (first) {</span>
<span class="fc" id="L137">                i = instr.getString();</span>
<span class="fc" id="L138">                first = false;</span>
            } else {
<span class="fc" id="L140">                i += &quot;\n&quot; + instr.getString();</span>
            }
<span class="fc" id="L142">        }</span>

<span class="fc" id="L144">        addNote(i);</span>
<span class="fc" id="L145">    }</span>

    public void clearNotes() {
<span class="fc" id="L148">        noteList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L149">    }</span>

    public void addNote(String note) {
        // handle empty lines correctly (don't skip them!)
<span class="fc" id="L153">        note = StringUtils.stripEnd(note, null/*default: strips whitespace*/);</span>

<span class="pc bpc" id="L155" title="1 of 4 branches missed.">        if (note == null || note.isEmpty()) {</span>
<span class="fc" id="L156">            noteList.add(new HL7String(&quot;&quot;));</span>
        } else {
            // normalize line breaks (if any)
<span class="fc" id="L159">            String normalBreaks = WINDOWS_NEWLINE_PATTERN.matcher(note).replaceAll(Matcher.quoteReplacement(&quot;\n&quot;)).replace('\r', '\n'); // convert windows/mac line endings to \n</span>
<span class="fc" id="L160">            String[] notes = StringUtils.splitPreserveAllTokens(normalBreaks, '\n');</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">            for (String line : notes) {</span>
<span class="fc" id="L162">                noteList.add(new HL7String(line));</span>
            }
        }
<span class="fc" id="L165">    }</span>

    public boolean isDuplicateHl7Obx(HL7Observation other) {
<span class="fc" id="L168">        HL7ObservationComparisonDTO otherComparison = HL7ObservationMapper.INSTANCE.map(other);</span>
<span class="fc" id="L169">        HL7ObservationComparisonDTO thisComparison = HL7ObservationMapper.INSTANCE.map(this);</span>
<span class="fc" id="L170">        return otherComparison.equals(thisComparison);</span>
    }

    // getters/setters

    public HL7String getObxSetId() {
<span class="fc" id="L176">        return obxSetId;</span>
    }

    public void setObxSetId(String obxSetId) {
<span class="fc" id="L180">        setObxSetId(new HL7String(obxSetId));</span>
<span class="fc" id="L181">    }</span>

    public void setObxSetId(HL7String obxSetId) {
<span class="fc" id="L184">        this.obxSetId = obxSetId;</span>
<span class="fc" id="L185">    }</span>

    public HL7String getValueType() {
<span class="fc" id="L188">        return valueType;</span>
    }

    public void setValueType(String valueType) {
<span class="nc" id="L192">        setValueType(HL7String.of(valueType));</span>
<span class="nc" id="L193">    }</span>

    public void setValueType(HL7String valueType) {
<span class="fc" id="L196">        this.valueType = valueType;</span>
<span class="fc" id="L197">    }</span>

    public HL7String getResultStatus() {
<span class="fc" id="L200">        return resultStatus;</span>
    }

    public void setResultStatus(String resultStatus) {
<span class="nc" id="L204">        setResultStatus(HL7String.of(resultStatus));</span>
<span class="nc" id="L205">    }</span>

    public void setResultStatus(HL7String resultStatus) {
<span class="fc" id="L208">        this.resultStatus = resultStatus;</span>
<span class="fc" id="L209">    }</span>

    public HL7Code getTestCode() {
<span class="fc" id="L212">        return testCode;</span>
    }

    public void setTestCode(HL7Code testCode) {
<span class="nc" id="L216">        this.testCode = testCode;</span>
<span class="nc" id="L217">    }</span>

    public HL7String getValueText() {
<span class="fc" id="L220">        return valueText;</span>
    }

    public void setValueText(String valueText) {
<span class="fc" id="L224">        this.valueText = new HL7String(valueText);</span>
<span class="fc" id="L225">    }</span>

    public void setValueText(HL7String valueText) {
<span class="fc" id="L228">        this.valueText = valueText;</span>
<span class="fc" id="L229">    }</span>

    public HL7String getTextRange() {
<span class="fc" id="L232">        return textRange;</span>
    }

    public void setTextRange(String textRange) {
<span class="fc" id="L236">        setTextRange(HL7String.of(textRange));</span>
<span class="fc" id="L237">    }</span>

    public void setTextRange(HL7String textRange) {
<span class="fc" id="L240">        this.textRange = textRange;</span>
<span class="fc" id="L241">    }</span>

    public HL7Date getTimestamp() {
<span class="fc" id="L244">        return timestamp;</span>
    }

    public void setTimestamp(HL7Date timestamp) {
<span class="fc" id="L248">        this.timestamp = timestamp;</span>
<span class="fc" id="L249">    }</span>

    public Double getValueNumeric() {
<span class="fc" id="L252">        return valueNumeric;</span>
    }

    public void setValueNumeric(Double valueNumeric) {
<span class="fc" id="L256">        this.valueNumeric = valueNumeric;</span>
<span class="fc" id="L257">    }</span>

    public Double getRangeLow() {
<span class="fc" id="L260">        return rangeLow;</span>
    }

    public void setRangeLow(Double rangeLow) {
<span class="fc" id="L264">        this.rangeLow = rangeLow;</span>
<span class="fc" id="L265">    }</span>

    public Double getRangeHigh() {
<span class="fc" id="L268">        return rangeHigh;</span>
    }

    public void setRangeHigh(Double rangeHigh) {
<span class="fc" id="L272">        this.rangeHigh = rangeHigh;</span>
<span class="fc" id="L273">    }</span>

    public boolean isRangeLowInclusive() {
<span class="fc" id="L276">        return rangeLowInclusive;</span>
    }

    public void setRangeLowInclusive(boolean rangeLowInclusive) {
<span class="fc" id="L280">        this.rangeLowInclusive = rangeLowInclusive;</span>
<span class="fc" id="L281">    }</span>

    public boolean isRangeHighInclusive() {
<span class="fc" id="L284">        return rangeHighInclusive;</span>
    }

    public void setRangeHighInclusive(boolean rangeHighInclusive) {
<span class="fc" id="L288">        this.rangeHighInclusive = rangeHighInclusive;</span>
<span class="fc" id="L289">    }</span>

    public List&lt;HL7String&gt; getNoteList() {
<span class="fc" id="L292">        return noteList;</span>
    }

    public HL7String getEdApplication() {
<span class="fc" id="L296">        return edApplication;</span>
    }

    public HL7String getEdDataType() {
<span class="fc" id="L300">        return edDataType;</span>
    }

    public HL7String getEdSubDataType() {
<span class="fc" id="L304">        return edSubDataType;</span>
    }

    public HL7String getEdEncoding() {
<span class="fc" id="L308">        return edEncoding;</span>
    }

    public byte[] getEdValue() {
<span class="fc" id="L312">        return edValue;</span>
    }

    public HL7Code getUnitCode() {
<span class="fc" id="L316">        return unitCode;</span>
    }

    public void setUnitCode(HL7Code unitCode) {
<span class="nc" id="L320">        this.unitCode = unitCode;</span>
<span class="nc" id="L321">    }</span>

    public HL7String getAccessChecks() {
<span class="fc" id="L324">        return accessChecks;</span>
    }

    public boolean isProcessed() {
<span class="fc" id="L328">        return processed;</span>
    }

    public void setProcessed(boolean processed) {
<span class="fc" id="L332">        this.processed = processed;</span>
<span class="fc" id="L333">    }</span>

    public HL7ComparatorOperator getValueComparator() {
<span class="fc" id="L336">        return valueComparator;</span>
    }

    public void setEdApplication(HL7String edApplication) {
<span class="fc" id="L340">        this.edApplication = edApplication;</span>
<span class="fc" id="L341">    }</span>

    public void setEdDataType(HL7String edDataType) {
<span class="fc" id="L344">        this.edDataType = edDataType;</span>
<span class="fc" id="L345">    }</span>

    public void setEdSubDataType(HL7String edSubDataType) {
<span class="fc" id="L348">        this.edSubDataType = edSubDataType;</span>
<span class="fc" id="L349">    }</span>

    public void setEdEncoding(HL7String edEncoding) {
<span class="fc" id="L352">        this.edEncoding = edEncoding;</span>
<span class="fc" id="L353">    }</span>

    public void setEdValue(byte[] edValue) {
<span class="fc" id="L356">        this.edValue = edValue;</span>
<span class="fc" id="L357">    }</span>

    public void setAccessChecks(HL7String accessChecks) {
<span class="fc" id="L360">        this.accessChecks = accessChecks;</span>
<span class="fc" id="L361">    }</span>

    public void setValueComparator(HL7ComparatorOperator valueComparator) {
<span class="fc" id="L364">        this.valueComparator = valueComparator;</span>
<span class="fc" id="L365">    }</span>

    public HL7MessageProperties getMessageProperties() {
<span class="fc" id="L368">        return messageProperties;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>