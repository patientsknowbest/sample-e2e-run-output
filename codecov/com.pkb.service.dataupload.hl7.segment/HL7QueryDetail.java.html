<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HL7QueryDetail.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.dataupload.hl7.segment</a> &gt; <span class="el_source">HL7QueryDetail.java</span></div><h1>HL7QueryDetail.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------
//
// Copyright (c) 2011 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: $
//
//------------------------------------------------------------------------------

package com.pkb.service.dataupload.hl7.segment;

import com.pkb.exception.ApiCallMalformedException;
import com.pkb.service.dataupload.hl7.HL7MessageProperties;
import com.pkb.service.dataupload.hl7.HL7XmlDoc;
import com.pkb.service.dataupload.hl7.value.HL7Date;
import com.pkb.service.dataupload.hl7.value.HL7String;
import org.w3c.dom.Element;

import java.io.Serializable;

/**
 * Parses a QRD segment. See HL7 v2.4 Chapter 5.
 *
 * @author robwhelan
 */
public class HL7QueryDetail implements Serializable {

    private static final long serialVersionUID = 1L;

    /**
     * Query filter types.
     * We don't actually support queries filtered by patient name, yet -- but we support open queries of &quot;APN&quot; type.
     * For these, we return the *full* list of active patients, instead of just the ones with valid national/org/team IDs.
     *
     * An &quot;APM&quot; query is a way to find out the active patient list with connection-level IDs only, for pseudonymized
     * patient records. E.g., a team connection submitting an APM query will get a result that includes only team-level IDs
     * (and no other patient-identifiable demographic info). The same query on an org-level connection will return only
     * org-level IDs.
     */
    public static final String DEMOGRAPHICS_BY_ID = &quot;DEM&quot;;
    public static final String DEMOGRAPHICS_BY_NAME = &quot;APN&quot;;
    public static final String REGISTRATION_STATUS = &quot;STA&quot;;
    public static final String ID_RESULTS_ONLY = &quot;APM&quot;;

    public static final String ID_TYPE_LOCAL = &quot;MR&quot;; // for medical record (team or org level ID; depends on connection auth level)
    // the id types for NationalIds vary, and are tracked in the NationalIdType enum -- normally NI or NH

<span class="fc" id="L47">    private HL7Date timestamp = new HL7Date();</span>
<span class="fc" id="L48">    private HL7String queryId = new HL7String();</span>
<span class="fc" id="L49">    private HL7String patientId = new HL7String();</span>
<span class="fc" id="L50">    private HL7String patientLastName = new HL7String();</span>
<span class="fc" id="L51">    private HL7String patientFirstName = new HL7String();</span>
<span class="fc" id="L52">    private HL7String patientIdType = new HL7String();</span>
<span class="fc" id="L53">    private HL7String queryFilterType = new HL7String();</span>
<span class="fc" id="L54">    private HL7String registeredStatus = new HL7String();</span>
<span class="fc" id="L55">    private HL7String pageSize = new HL7String();</span>
<span class="fc" id="L56">    private HL7String pageSizeDetail = new HL7String();</span>

    private HL7MessageProperties messageProperties;

<span class="fc" id="L60">    public HL7QueryDetail(HL7MessageProperties messageProperties) {</span>
<span class="fc" id="L61">        this.messageProperties = messageProperties;</span>
<span class="fc" id="L62">    }</span>

    public void parseQrd(Element qrd) throws ApiCallMalformedException {
<span class="fc" id="L65">        HL7String type = HL7XmlDoc.getHl7Text(qrd, &quot;QRD.9.1&quot;);</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">        if (type.isBlank()) {</span>
            //  TODO: Default should be handled nicer than this
<span class="nc" id="L68">            type = new HL7String(DEMOGRAPHICS_BY_ID);</span>
        }
<span class="fc" id="L70">        timestamp = HL7XmlDoc.parseDateOrTimestamp(HL7XmlDoc.getHl7Text(qrd, &quot;QRD.1.1&quot;), &quot;QRD.1.1&quot;, messageProperties);</span>
<span class="fc" id="L71">        queryId = HL7XmlDoc.getHl7Text(qrd, &quot;QRD.4.1&quot;);</span>

<span class="fc bfc" id="L73" title="All 2 branches covered.">        if (REGISTRATION_STATUS.equals(type.getString())) {</span>
<span class="fc" id="L74">            pageSize = HL7XmlDoc.getHl7Text(qrd, &quot;QRD.7.1&quot;);</span>
<span class="fc" id="L75">            pageSizeDetail = HL7XmlDoc.getHl7Text(qrd, &quot;QRD.7.2&quot;);</span>
<span class="fc" id="L76">            registeredStatus = HL7XmlDoc.getHl7Text(qrd, &quot;QRD.11.1&quot;);</span>
        } else {
<span class="fc" id="L78">            patientId = HL7XmlDoc.getHl7Text(qrd, &quot;QRD.8.1&quot;);</span>
<span class="fc" id="L79">            patientLastName = HL7XmlDoc.getHl7Text(qrd, &quot;QRD.8.2&quot;);</span>
<span class="fc" id="L80">            patientFirstName = HL7XmlDoc.getHl7Text(qrd, &quot;QRD.8.3&quot;);</span>
<span class="fc" id="L81">            patientIdType = HL7XmlDoc.getHl7Text(qrd, &quot;QRD.8.13&quot;);</span>
        }

<span class="fc" id="L84">        queryFilterType = type; // DEM/APN/STA</span>
<span class="fc" id="L85">    }</span>

    /** convert back to pipe/hat format! */
    public String toHl7() {
<span class="fc" id="L89">        StringBuilder sb = new StringBuilder(&quot;QRD|&quot;)</span>
<span class="fc" id="L90">                .append(timestamp.getRawValue()).append(&quot;|R|I|&quot;)</span>
<span class="fc" id="L91">                .append(queryId.getRawValue()).append(&quot;|||&quot;);</span>

<span class="fc bfc" id="L93" title="All 2 branches covered.">        if (!pageSize.isBlank()) {</span>
<span class="fc" id="L94">            sb.append(pageSize.getRawValue()).append(&quot;^&quot;).append(pageSizeDetail.getRawValue());</span>
        }

<span class="fc" id="L97">        sb.append(&quot;|&quot;);</span>

<span class="fc bfc" id="L99" title="All 2 branches covered.">        if (!queryFilterType.getRawValue().equals(REGISTRATION_STATUS)) {</span>
<span class="fc" id="L100">            sb.append(patientId.getRawValue())</span>
<span class="fc" id="L101">                    .append(&quot;^&quot;).append(patientLastName.getRawValue())</span>
<span class="fc" id="L102">                    .append(&quot;^&quot;).append(patientFirstName.getRawValue())</span>
<span class="fc" id="L103">                    .append(&quot;^^^^^^^^^^&quot;).append(patientIdType.getRawValue());</span>
        }

<span class="fc" id="L106">        String s = sb.toString();</span>

        // remove extra ^...
<span class="fc bfc" id="L109" title="All 2 branches covered.">        while (s.endsWith(&quot;^&quot;)) {</span>
<span class="fc" id="L110">            s = s.substring(0, s.length() - 1);</span>
        }

<span class="fc" id="L113">        sb = new StringBuilder(s);</span>
<span class="fc" id="L114">        sb.append(&quot;|&quot;).append(queryFilterType.getRawValue()).append(&quot;|&quot;);</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">        if (registeredStatus.isNotBlank()) {</span>
<span class="fc" id="L116">            sb.append(&quot;|&quot;).append(registeredStatus);</span>
        }

<span class="fc" id="L119">        return sb.toString();</span>
    }

    public HL7Date getTimestamp() {
<span class="nc" id="L123">        return timestamp;</span>
    }

    public void setTimestamp(HL7Date timestamp) {
<span class="nc" id="L127">        this.timestamp = timestamp;</span>
<span class="nc" id="L128">    }</span>

    public HL7String getQueryId() {
<span class="nc" id="L131">        return queryId;</span>
    }

    public void setQueryId(String queryId) {
<span class="nc" id="L135">        this.queryId = new HL7String(queryId);</span>
<span class="nc" id="L136">    }</span>

    public HL7String getPatientId() {
<span class="fc" id="L139">        return patientId;</span>
    }

    public void setPatientId(String patientId) {
<span class="nc" id="L143">        this.patientId = new HL7String(patientId);</span>
<span class="nc" id="L144">    }</span>

    public HL7String getPatientLastName() {
<span class="nc" id="L147">        return patientLastName;</span>
    }

    public void setPatientLastName(String patientLastName) {
<span class="nc" id="L151">        this.patientLastName = new HL7String(patientLastName);</span>
<span class="nc" id="L152">    }</span>

    public HL7String getPatientFirstName() {
<span class="nc" id="L155">        return patientFirstName;</span>
    }

    public void setPatientFirstName(String patientFirstName) {
<span class="nc" id="L159">        this.patientFirstName = new HL7String(patientFirstName);</span>
<span class="nc" id="L160">    }</span>

    public HL7String getPatientIdType() {
<span class="fc" id="L163">        return patientIdType;</span>
    }

    public void setPatientIdType(String patientIdType) {
<span class="nc" id="L167">        this.patientIdType = new HL7String(patientIdType);</span>
<span class="nc" id="L168">    }</span>

    public HL7String getQueryFilterType() {
<span class="fc" id="L171">        return queryFilterType;</span>
    }

<span class="nc" id="L174">    public void setQueryFilterType(String queryFilterType) { this.queryFilterType = new HL7String(queryFilterType); }</span>

<span class="fc" id="L176">    public HL7String getRegisteredStatus() { return registeredStatus; }</span>

<span class="nc" id="L178">    public void setRegisteredStatus(HL7String registeredStatus) { this.registeredStatus = registeredStatus; }</span>

<span class="fc" id="L180">    public HL7String getPageSize() { return pageSize; }</span>

<span class="nc" id="L182">    public void setPageSize(HL7String pageSize) { this.pageSize = pageSize; }</span>

<span class="fc" id="L184">    public HL7String getPageSizeDetail() { return pageSizeDetail; }</span>

<span class="nc" id="L186">    public void setPageSizeDetail(HL7String pageSizeDetail) { this.pageSizeDetail = pageSizeDetail; }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>