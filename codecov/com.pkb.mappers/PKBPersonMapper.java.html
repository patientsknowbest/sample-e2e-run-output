<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PKBPersonMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.mappers</a> &gt; <span class="el_source">PKBPersonMapper.java</span></div><h1>PKBPersonMapper.java</h1><pre class="source lang-java linenums">package com.pkb.mappers;

import com.pkb.dto.ChangeOrgInviteeEmailDTO;
import com.pkb.dto.PatientDTO;
import com.pkb.entities.enums.NationalIdType;
import com.pkb.institute.entity.Org;
import com.pkb.user.entity.OrgLevelIdType;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PKBPersonHelper;
import org.apache.commons.lang3.StringUtils;
import org.mapstruct.AfterMapping;
import org.mapstruct.Mapper;
import org.mapstruct.Mapping;
import org.mapstruct.MappingTarget;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.List;

import static java.util.stream.Collectors.toList;

@Mapper
<span class="fc" id="L22">public abstract class PKBPersonMapper {</span>

    @Autowired
    private PKBPersonHelper pkbPersonHelper;

    @Mapping(source = &quot;person.dateOfBirthUTC&quot;, target = &quot;dateOfBirth&quot;)
    @Mapping(target = &quot;nationalId&quot;, ignore = true)
    @Mapping(target = &quot;orgLevelIdsCsv&quot;, ignore = true)
    @Mapping(target = &quot;optedOut&quot;, ignore = true) // calculated after mapping
    @Mapping(target = &quot;optOutUnavailableReason&quot;, ignore = true) // calculated after mapping
    public abstract PatientDTO personToPatientDTO(PKBPerson person);

    @Mapping(source = &quot;person.id&quot;, target = &quot;id&quot;)
    @Mapping(source = &quot;person.dateOfBirthUTC&quot;, target = &quot;dateOfBirth&quot;)
    @Mapping(target = &quot;nationalId&quot;, ignore = true) // calculated after mapping
    @Mapping(target = &quot;orgLevelIdsCsv&quot;, ignore = true) // calculated after mapping
    @Mapping(target = &quot;optedOut&quot;, ignore = true) // calculated after mapping
    @Mapping(target = &quot;optOutUnavailableReason&quot;, ignore = true) // calculated after mapping
    public abstract PatientDTO personToPatientDTO(PKBPerson person, Org org, NationalIdType nationalIdType);

    @Mapping(source = &quot;id&quot;, target = &quot;personId&quot;)
    @Mapping(source = &quot;email&quot;, target = &quot;emailAddress&quot;)
    @Mapping(target = &quot;orgId&quot;, ignore = true)
    public abstract ChangeOrgInviteeEmailDTO personToChangeOrgInviteeEmailDTO(PKBPerson person, @MappingTarget ChangeOrgInviteeEmailDTO result);

    @AfterMapping
    protected void calculatePatientIdentifierProperties(PKBPerson person, Org org, NationalIdType nationalIdType, @MappingTarget PatientDTO result) {
<span class="fc" id="L49">        person.getNationalIdAnyTypeValidForSameCountryAsType(nationalIdType)</span>
<span class="fc" id="L50">                .ifPresentOrElse(nid -&gt; result.setNationalId(nid),</span>
<span class="fc" id="L51">                        () -&gt; result.setOptOutUnavailableReason(PatientDTO.OptOutUnavailableReason.NO_NATIONAL_ID));</span>

<span class="fc" id="L53">        List&lt;String&gt; orgLevelIds = org.getOrgLevelIdTypes().stream()</span>
<span class="fc" id="L54">                .map(OrgLevelIdType::getId)</span>
<span class="fc" id="L55">                .map(person::getOrgLevelIdsByTypeAsCSV)</span>
<span class="fc" id="L56">                .collect(toList());</span>
<span class="fc" id="L57">        result.setOrgLevelIdsCsv(StringUtils.join(orgLevelIds, &quot;;&quot;));</span>

<span class="fc bfc" id="L59" title="All 4 branches covered.">        result.setOptedOut(person.getOptoutDetails() != null &amp;&amp; !person.getOptoutDetails().isSharingEnabled());</span>

<span class="fc bfc" id="L61" title="All 2 branches covered.">        if (!pkbPersonHelper.isAtLeastYearsOld(16, person).orElse(false)) {</span>
<span class="fc" id="L62">            result.setOptOutUnavailableReason(PatientDTO.OptOutUnavailableReason.UNDERAGE);</span>
        }
<span class="fc" id="L64">    }</span>

    public void setPkbPersonHelper(PKBPersonHelper pkbPersonHelper) {
<span class="nc" id="L67">        this.pkbPersonHelper = pkbPersonHelper;</span>
<span class="nc" id="L68">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>