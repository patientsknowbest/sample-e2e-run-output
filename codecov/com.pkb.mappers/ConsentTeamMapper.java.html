<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConsentTeamMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.mappers</a> &gt; <span class="el_source">ConsentTeamMapper.java</span></div><h1>ConsentTeamMapper.java</h1><pre class="source lang-java linenums">package com.pkb.mappers;

import com.google.common.collect.ImmutableMap;
import com.google.common.collect.Maps;
import com.pkb.datamodel.consent.PatientConsentDTO;
import com.pkb.dto.ConsentTeamDto;
import com.pkb.dto.ImmutableConsentTeamDto;
import com.pkb.dto.ImmutableUrlDto;
import com.pkb.dto.UrlDto;
import com.pkb.entities.enums.AdditionalConsentId;
import com.pkb.institute.entity.Team;
import com.pkb.service.team.TeamUserManager;
import com.pkb.util.PKBServiceUtil;
import com.pkb.util.UrlUtil;
import io.vavr.collection.LinkedHashMap;

import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Optional;

import static com.pkb.entities.enums.AdditionalConsentId.CONTACT_BY_EMAIL;
import static com.pkb.entities.enums.AdditionalConsentId.CONTACT_BY_POST;
import static com.pkb.entities.enums.AdditionalConsentId.CONTACT_BY_SMS;
import static com.pkb.entities.enums.AdditionalConsentId.CONTACT_FOR_RESEARCH;
import static com.pkb.entities.enums.AdditionalConsentId.SAMPLE_STORAGE;
import static com.pkb.util.WebNamespace.PATIENT;
import static java.lang.String.valueOf;
import static java.util.stream.Collectors.toList;

public class ConsentTeamMapper implements ConsentEntityMapper {

    private static final String ACTION = &quot;viewConsentTeam&quot;;

    private static final String CONTACT_PREFERENCE_EMAIL = &quot;patientEditConsentTeam.txt.contacttype_email&quot;;
    private static final String CONTACT_PREFERENCE_SMS = &quot;patientEditConsentTeam.txt.contacttype_sms&quot;;
    private static final String CONTACT_PREFERENCE_POST = &quot;patientEditConsentTeam.txt.contacttype_post&quot;;

    private static final String CONTACT_PREFERENCE_BTN_TEXT = &quot;patientConsentTeam.txt.teams.contact_preferences_add&quot;;

    private static final String SAMPLE_CONSENT_BTN = &quot;patientConsentTeam.txt.teams.samples_consent_prompt&quot;;
    private static final String RESEARCH_CONSENT_BTN = &quot;patientConsentTeam.txt.teams.research_consent_prompt&quot;;
    private static final String IMPROVE_HEALTHCARE_CONSENT_BTN = &quot;patientConsentTeam.txt.teams.improve_healthcare_consent_prompt&quot;;

    private static final String ALL_CONSENTED = &quot;patientConsentTeam.txt.teams.all_consented&quot;;
    private static final String RESEARCH_CONSENTED = &quot;patientConsentTeam.txt.teams.research_consented&quot;;
    private static final String SAMPLE_CONSENTED = &quot;patientConsentTeam.txt.teams.sample_consented&quot;;

<span class="fc" id="L49">    private static final Map&lt;AdditionalConsentId, String&gt; CONTACT_PREFERENCES_TEXT = Maps.immutableEnumMap(ImmutableMap.of(</span>
            CONTACT_BY_EMAIL, CONTACT_PREFERENCE_EMAIL,
            CONTACT_BY_SMS, CONTACT_PREFERENCE_SMS,
            CONTACT_BY_POST, CONTACT_PREFERENCE_POST
    ));

    private TeamUserManager teamUserManager;

    private PKBServiceUtil pkbServiceUtil;

<span class="fc" id="L59">    public ConsentTeamMapper(PKBServiceUtil pkbServiceUtil, TeamUserManager teamUserManager) {</span>
<span class="fc" id="L60">        this.pkbServiceUtil = pkbServiceUtil;</span>
<span class="fc" id="L61">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L62">    }</span>

    public List&lt;ConsentTeamDto&gt; teamsToConsentTeamDtos(List&lt;Team&gt; teams,
                                                       Long contextUserId,
                                                       Long userId,
                                                       Map&lt;Long, PatientConsentDTO&gt; consents,
                                                       Locale locale) {
<span class="fc" id="L69">        return teams.stream()</span>
<span class="fc" id="L70">                .map(team -&gt; teamToConsentTeamDto(team, contextUserId, userId, consents, locale))</span>
<span class="fc" id="L71">                .collect(toList());</span>
    }

    private ConsentTeamDto teamToConsentTeamDto(Team team,
                                                Long contextUserId,
                                                Long userId,
                                                Map&lt;Long, PatientConsentDTO&gt; consents,
                                                Locale locale) {

<span class="fc" id="L80">        Map&lt;AdditionalConsentId, Boolean&gt; additionalConsents = teamUserManager.getAdditionalConsents(userId, team.getId());</span>
<span class="fc bfc" id="L81" title="All 4 branches covered.">        boolean isAnyHealthcareConsentRequired = additionalConsents.containsKey(CONTACT_FOR_RESEARCH) || additionalConsents.containsKey(SAMPLE_STORAGE);</span>
<span class="fc" id="L82">        String buttonText = getHealthcareButtonText(isAnyHealthcareConsentRequired, additionalConsents);</span>
<span class="fc" id="L83">        return ImmutableConsentTeamDto.builder()</span>
<span class="fc" id="L84">                .name(team.getName())</span>
<span class="fc" id="L85">                .editUrl(buildEditUrl(team.getId(), contextUserId))</span>
<span class="fc" id="L86">                .orgName(team.getOrg().getName())</span>
<span class="fc" id="L87">                .contactPreferencesButtonText(pkbServiceUtil.getMessage(CONTACT_PREFERENCE_BTN_TEXT, locale))</span>
<span class="fc" id="L88">                .isAnyHealthcareConsentRequired(isAnyHealthcareConsentRequired)</span>
<span class="fc" id="L89">                .improveHealthcareButtonText(pkbServiceUtil.getMessage(buttonText, locale))</span>
<span class="fc" id="L90">                .displayNotification(buttonText.equals(IMPROVE_HEALTHCARE_CONSENT_BTN))</span>
<span class="fc" id="L91">                .addAllPrivacyFlags(buildTeamConsents(team, consents, pkbServiceUtil, locale))</span>
<span class="fc" id="L92">                .improveHealthcareText(getHealthcareText(isAnyHealthcareConsentRequired, additionalConsents, locale))</span>
<span class="fc" id="L93">                .logoFileName(Optional.ofNullable(team.getLogoFileName()))</span>
<span class="fc" id="L94">                .contactPreferences(buildContactPreferences(additionalConsents, locale))</span>
<span class="fc" id="L95">                .build();</span>
    }

    private Optional&lt;String&gt; getHealthcareText(boolean isAnyHealthcareConsentRequired, Map&lt;AdditionalConsentId, Boolean&gt; additionalConsents, Locale locale) {
<span class="fc bfc" id="L99" title="All 2 branches covered.">        if (!isAnyHealthcareConsentRequired) {</span>
            //neither consent was asked, the healthcare section is redundant
<span class="fc" id="L101">            return Optional.empty();</span>
        }

<span class="fc" id="L104">        var researchConsent = additionalConsents.getOrDefault(CONTACT_FOR_RESEARCH, false);</span>
<span class="fc" id="L105">        var storageConsent = additionalConsents.getOrDefault(SAMPLE_STORAGE, false);</span>

<span class="fc bfc" id="L107" title="All 4 branches covered.">        if (researchConsent &amp;&amp; storageConsent) { //both were asked and both are true</span>
<span class="fc" id="L108">            return Optional.of(pkbServiceUtil.getMessage(ALL_CONSENTED, locale));</span>
        }
<span class="fc bfc" id="L110" title="All 2 branches covered.">        if (researchConsent) { //research was asked and consented to (and sample not or not asked)</span>
<span class="fc" id="L111">            return Optional.of(pkbServiceUtil.getMessage(RESEARCH_CONSENTED, locale));</span>
        }
<span class="fc bfc" id="L113" title="All 2 branches covered.">        if (storageConsent) { //sample was asked and consented to (and research not or not asked)</span>
<span class="fc" id="L114">            return Optional.of(pkbServiceUtil.getMessage(SAMPLE_CONSENTED, locale));</span>
        }
        //none of the cases fit so must be asked but not consented so empty
<span class="fc" id="L117">        return Optional.empty();</span>
    }

    private String getHealthcareButtonText(boolean isAnyHealthcareConsentRequired, Map&lt;AdditionalConsentId, Boolean&gt; additionalConsents) {
<span class="fc bfc" id="L121" title="All 2 branches covered.">        if (!isAnyHealthcareConsentRequired) {</span>
            //healthcare section is redundant
<span class="fc" id="L123">            return &quot;&quot;;</span>
        }

        // &quot;asked and not consented to&quot; -&gt; give prompt
<span class="fc bfc" id="L127" title="All 2 branches covered.">        var promptResearchConsent = !additionalConsents.getOrDefault(CONTACT_FOR_RESEARCH, true);</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">        var promptStorageConsent = !additionalConsents.getOrDefault(SAMPLE_STORAGE, true);</span>

<span class="fc bfc" id="L130" title="All 4 branches covered.">        if (promptStorageConsent &amp;&amp; promptResearchConsent) { // both were asked and not consented to, give joint prompt</span>
<span class="fc" id="L131">            return IMPROVE_HEALTHCARE_CONSENT_BTN;</span>
        }
<span class="fc bfc" id="L133" title="All 2 branches covered.">        if (promptResearchConsent) { //research was asked and not consented to, give research prompt</span>
<span class="fc" id="L134">            return RESEARCH_CONSENT_BTN;</span>
        }
<span class="fc bfc" id="L136" title="All 2 branches covered.">        if (promptStorageConsent) { //sample was asked and not consented to, give sample prompt</span>
<span class="fc" id="L137">            return SAMPLE_CONSENT_BTN;</span>
        }
        //no prompting needed
<span class="fc" id="L140">        return &quot;&quot;;</span>
    }

    private Optional&lt;List&lt;String&gt;&gt; buildContactPreferences(Map&lt;AdditionalConsentId, Boolean&gt; additionalConsents,
                                                           Locale locale) {
<span class="fc bfc" id="L145" title="All 2 branches covered.">        if (!additionalConsents.containsKey(CONTACT_BY_EMAIL)</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">                &amp;&amp; !additionalConsents.containsKey(CONTACT_BY_SMS)</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">                &amp;&amp; !additionalConsents.containsKey(CONTACT_BY_POST)) {</span>
            //no contact preferences asked, contact preference section is redundant
<span class="fc" id="L149">            return Optional.empty();</span>
        }

<span class="fc" id="L152">        return Optional.of(</span>
<span class="fc" id="L153">                CONTACT_PREFERENCES_TEXT.keySet()</span>
<span class="fc" id="L154">                .stream()</span>
<span class="fc bfc" id="L155" title="All 4 branches covered.">                .filter(key -&gt; additionalConsents.containsKey(key) &amp;&amp; additionalConsents.get(key))</span>
<span class="fc" id="L156">                .map(key -&gt; pkbServiceUtil.getMessage(CONTACT_PREFERENCES_TEXT.get(key), locale))</span>
<span class="fc" id="L157">                .collect(toList())</span>
        );
    }

    private UrlDto buildEditUrl(Long id,
                                Long contextUserId) {
<span class="fc" id="L163">        Map&lt;String, String&gt; parameters = LinkedHashMap.of(&quot;teamId&quot;, valueOf(id)).toJavaMap();</span>
<span class="fc" id="L164">        return ImmutableUrlDto.builder()</span>
<span class="fc" id="L165">                .href(UrlUtil.buildHref(PATIENT, ACTION, parameters, contextUserId))</span>
<span class="fc" id="L166">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>