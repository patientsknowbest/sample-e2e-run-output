<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RecordsServiceBulkLoaderRouteBuilder.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.backgroundtasks.wayfinder.recordsservice.routing</a> &gt; <span class="el_source">RecordsServiceBulkLoaderRouteBuilder.kt</span></div><h1>RecordsServiceBulkLoaderRouteBuilder.kt</h1><pre class="source lang-java linenums">package com.pkb.backgroundtasks.wayfinder.recordsservice.routing

import com.pkb.backgroundtasks.config.BackgroundTasksProperties
import com.pkb.backgroundtasks.config.WayfinderRecordsServiceProperties
import com.pkb.backgroundtasks.wayfinder.recordsservice.service.RecordsServiceNotifierService
import com.pkb.common.testcontrol.camel.route.AbstractNamespaceAwareRouteBuilder
import com.pkb.common.testcontrol.services.PubSubNamespaceService
import org.apache.camel.LoggingLevel.INFO
import org.apache.camel.component.jackson.JacksonDataFormat
import org.apache.camel.model.ProcessorDefinition
import org.springframework.stereotype.Component

/**
 * We must send already existing appointments to Wayfinder Records Service. This route is configured to
 * consume NHS numbers from a temporary table to send them in batches of 5000. We might also need
 * this in the future if the need ever rises to bulk load again.
 *
 * For Wayfinder there is a strict IG requirement that any NHS numbers sent must be for patients who have at
 * least one appointment at a trust which has onboarded. This is not enforced here programmatically, as this is
 * an ad-hoc process with manual population of the table which drives this code.
 */
@Component
<span class="fc" id="L23">class RecordsServiceBulkLoaderRouteBuilder(</span>
        backgroundTasksProperties: BackgroundTasksProperties,
<span class="fc" id="L25">        private val pubSubNamespaceService: PubSubNamespaceService,</span>
<span class="fc" id="L26">        private val recordsServiceNotifierService: RecordsServiceNotifierService,</span>
<span class="fc" id="L27">) : AbstractNamespaceAwareRouteBuilder() {</span>
    companion object {
        const val ROUTE_ID = &quot;bulk-load-appointments&quot;

        fun sqlConsumer(limit: Int) = &quot;sql:select id, nhs_number from bgtasks.wayfinder_record_service_nhs_numbers_to_send&quot; +
                &quot; where delivery_status = 'UNPROCESSED'::bgtasks.delivery_status&quot; +
<span class="fc" id="L33">                &quot; limit $limit&quot; +</span>
<span class="fc" id="L34">                &quot;?outputType=SelectList&amp;useIterator=false&amp;greedy=true&quot;</span>
    }

<span class="fc" id="L37">    private val properties: WayfinderRecordsServiceProperties = backgroundTasksProperties.recordsService</span>

    override fun configure() {
<span class="fc" id="L40">        onException(Exception::class.java)</span>
<span class="fc" id="L41">                .bean(recordsServiceNotifierService, &quot;handleFailure&quot;)</span>
<span class="fc" id="L42">                .stop()</span>

<span class="fc" id="L44">        from(sqlConsumer(properties.bulkLoaderBatchSize))</span>
<span class="fc" id="L45">                .routeId(ROUTE_ID)</span>
<span class="fc" id="L46">                .autoStartup(properties.bulkLoaderEnabled)</span>
<span class="fc" id="L47">                .bean(recordsServiceNotifierService, &quot;mapSqlToValidNationalId&quot;)</span>
<span class="fc" id="L48">                .bean(recordsServiceNotifierService, &quot;buildHttpMessage&quot;).id(&quot;$ROUTE_ID-build-http-message&quot;)</span>
<span class="fc" id="L49">                .marshal(JacksonDataFormat(RecordsServiceNotifierService.NotificationRequest::class.java))</span>
<span class="fc" id="L50">                .verbose(&quot;Bulk upload request body: \${body}&quot;)</span>
<span class="fc" id="L51">                .to(&quot;netty-http:${properties.requestUrl}&quot;).id(&quot;$ROUTE_ID-http-records-service&quot;)</span>
<span class="fc" id="L52">                .bean(recordsServiceNotifierService, &quot;markAsSent&quot;)</span>
<span class="fc" id="L53">                .verbose(&quot;Bulk upload response: HTTP \${header.CamelHttpResponseCode}, response body: \${body}&quot;)</span>
<span class="fc" id="L54">    }</span>

    private fun ProcessorDefinition&lt;*&gt;.verbose(message: String): ProcessorDefinition&lt;*&gt; {
<span class="fc" id="L57">        return this.choice()</span>
<span class="fc" id="L58">                .`when` { properties.bulkLoaderVerboseLogging }</span>
<span class="fc" id="L59">                .log(INFO, message)</span>
<span class="fc" id="L60">                .end()</span>
    }

<span class="fc" id="L63">    override fun camelNamespaceService(): PubSubNamespaceService = pubSubNamespaceService</span>

<span class="nc" id="L65">    override fun throwExceptionForNamespaceMismatch(): Boolean = false</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>