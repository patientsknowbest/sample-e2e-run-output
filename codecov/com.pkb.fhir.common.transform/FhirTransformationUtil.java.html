<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FhirTransformationUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.fhir.common.transform</a> &gt; <span class="el_source">FhirTransformationUtil.java</span></div><h1>FhirTransformationUtil.java</h1><pre class="source lang-java linenums">package com.pkb.fhir.common.transform;

import org.apache.commons.lang3.StringUtils;
import org.hl7.fhir.r4.model.DateTimeType;
import org.hl7.fhir.r4.model.DomainResource;
import org.hl7.fhir.r4.model.Element;
import org.hl7.fhir.r4.model.Extension;
import org.hl7.fhir.r4.model.Identifier;
import org.hl7.fhir.r4.model.Reference;
import org.hl7.fhir.r4.model.StringType;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;

import java.util.Optional;
import java.util.UUID;

/**
 * The core clinical and non-clinical transformation code by necessity cannot be placed in a singular hierarchy, as
 * the former has the dual purpose of transforming for both migration and analysis purposes.
 *
 * This interface can hold default methods common to both in order.
 */
public interface FhirTransformationUtil {
    
    static final String PRIVACY_LABEL_CODESYSTEM_URL = &quot;http://fhir.patientsknowbest.com/codesystem/privacy-label&quot;;
    static final String SOURCE_TEXT_EXTENSION_URL = &quot;http://fhir.patientsknowbest.com/structuredefinition/source-text&quot;;
    static final String ACCESS_ROUTE_EXTENSION_URL = &quot;http://fhir.patientsknowbest.com/structuredefinition/access-route&quot;;
    static final String ACCESS_ROUTE_SYSTEM_URL = &quot;http://fhir.patientsknowbest.com/codesystem/access-route&quot;;
    static final String SOURCE_ORG_EXTENSION_URL = &quot;http://fhir.patientsknowbest.com/structuredefinition/source-organization&quot;;
    static final String SOURCE_PERSON_EXTENSION_URL = &quot;http://fhir.patientsknowbest.com/structuredefinition/source-person&quot;;
    static final String SOURCE_TEAM_EXTENSION_URL = &quot;http://fhir.patientsknowbest.com/structuredefinition/source-team&quot;;
    static final String RESPONSIBLE_ORGANISATION_EXTENSION_URL = &quot;http://fhir.patientsknowbest.com/structuredefinition/responsible-organization&quot;;
    static final String VERSION_PERSISTED_EXTENSION_URL = &quot;http://fhir.patientsknowbest.com/structuredefinition/version-persisted&quot;;
    static final String CREATED_DATE_EXTENSION_URL = &quot;http://fhir.patientsknowbest.com/structuredefinition/created-date&quot;;
    //This is HL7 partner all over the place, but it's not really HL7 specific. Changing this to be more agnostic
    static final String PARTNER_EXTENSION_URL = &quot;http://fhir.patientsknowbest.com/structuredefinition/partner-identifier&quot;;
    static final String PKB_ID_SYSTEM = &quot;urn:uuid:cd97da65-0aa4-43a6-b695-cfd0c6f3267d&quot;; //Generic for PKB Public Id, as per existing FHIR API.

    default void addExtension(@Nullable String value, @NotNull String extensionUrl, @NotNull DomainResource resource) {
<span class="fc" id="L40">        createExtension(value, extensionUrl)</span>
<span class="fc" id="L41">                .ifPresent(resource::addExtension);</span>
<span class="fc" id="L42">    }</span>

    default void addExtension(@Nullable String value, @NotNull String extensionUrl, @NotNull Element element) {
<span class="fc" id="L45">        createExtension(value, extensionUrl)</span>
<span class="fc" id="L46">                .ifPresent(element::addExtension);</span>
<span class="fc" id="L47">    }</span>

    default Optional&lt;Extension&gt; createExtension(@Nullable String value, @NotNull String extensionUrl) {
<span class="fc" id="L50">        return Optional.ofNullable(value)</span>
<span class="fc" id="L51">                .filter(StringUtils::isNotBlank)</span>
<span class="fc" id="L52">                .map(valueNotNull -&gt; new Extension(extensionUrl, new StringType(valueNotNull)));</span>
    }

    default void addExtension(@Nullable DateTimeType value, @NotNull String extensionUrl, @NotNull DomainResource resource) {
<span class="fc" id="L56">        Optional.ofNullable(value)</span>
<span class="fc" id="L57">                .map(valueNotNull -&gt; resource.addExtension(new Extension(extensionUrl, valueNotNull)));</span>
<span class="fc" id="L58">    }</span>

    default Extension getExtensionWithReferenceIdentifier(@NotNull String extensionUrl, @NotNull UUID uuidReference) {
<span class="fc" id="L61">        return  getExtensionWithReferenceIdentifier(extensionUrl, String.valueOf(uuidReference));</span>
    }

    default Extension getExtensionWithReferenceIdentifier(@NotNull String extensionUrl, long primaryKeyReference) {
<span class="fc" id="L65">        return  getExtensionWithReferenceIdentifier(extensionUrl, String.valueOf(primaryKeyReference));</span>
    }

    default Extension getExtensionWithReferenceIdentifier(@NotNull String extensionUrl, @NotNull String identifier) {
<span class="fc" id="L69">        Extension extension = new Extension().setUrl(extensionUrl);</span>
<span class="fc" id="L70">        Reference reference = createReferenceWithIdentifier(identifier);</span>
<span class="fc" id="L71">        extension.setValue(reference);</span>
<span class="fc" id="L72">        return extension;</span>
    }

    /**
     * Used to refer to resources which we cannot guarantee to be within FHIR.
     * Should be used only where absolutely necessary, as this does not do referential integrity checks when saving.
     */
    default Reference createReferenceWithIdentifier(@NotNull String value) {
<span class="fc" id="L80">        Identifier referenceIdentifier = new Identifier();</span>
<span class="fc" id="L81">        referenceIdentifier.setSystem(PKB_ID_SYSTEM);</span>
<span class="fc" id="L82">        referenceIdentifier.setValue(value);</span>
<span class="fc" id="L83">        Reference reference = new Reference();</span>
<span class="fc" id="L84">        reference.setIdentifier(referenceIdentifier);</span>
<span class="fc" id="L85">        return reference;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>