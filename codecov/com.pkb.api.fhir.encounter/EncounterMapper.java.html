<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EncounterMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.fhir.encounter</a> &gt; <span class="el_source">EncounterMapper.java</span></div><h1>EncounterMapper.java</h1><pre class="source lang-java linenums">package com.pkb.api.fhir.encounter;

import com.pkb.api.fhir.CodingMapper;
import com.pkb.api.fhir.PeriodMapper;
import com.pkb.api.fhir.TemporalMapper;
import com.pkb.api.fhir.provenance.ProvenanceMapper;
import com.pkb.api.fhir.util.IncludeResource;
import com.pkb.datamodel.EncounterClassBlock;
import com.pkb.datamodel.EncounterEvent;
import com.pkb.datamodel.ExternalParticipant;
import com.pkb.datamodel.LocationBlock;
import com.pkb.datamodel.SpecialtyBlock;
import com.pkb.domain.criteria.CriteriaResult;
import com.pkb.domain.criteria.FhirCriteriaResult;
import com.pkb.domain.criteria.ImmutableFhirCriteriaResult;
import com.pkb.entities.enums.EncounterClass;
import io.vavr.collection.List;
import org.hl7.fhir.dstu3.model.CodeableConcept;
import org.hl7.fhir.dstu3.model.Encounter;
import org.hl7.fhir.dstu3.model.Extension;
import org.hl7.fhir.dstu3.model.Location;
import org.hl7.fhir.dstu3.model.Period;
import org.hl7.fhir.dstu3.model.Reference;
import org.hl7.fhir.dstu3.model.Resource;
import org.jetbrains.annotations.NotNull;

import static com.pkb.api.fhir.CanonicalExtensionURLs.specialtyHistory;
import static com.pkb.datamodel.ExternalParticipant.ParticipantRole.ATTENDER;
import static com.pkb.datamodel.ExternalParticipant.ParticipantRole.CONSULTANT;
import static com.pkb.datamodel.ExternalParticipant.ParticipantRole.REFERRER;
import static com.pkb.entities.enums.EncounterClass.AMBULATORY;
import static com.pkb.entities.enums.EncounterClass.OTHER;
import static com.pkb.entities.enums.EncounterClass.OUT_PATIENT;
import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.List;
import static io.vavr.API.Match;
import static java.lang.String.format;
import static java.util.Collections.singletonList;

public class EncounterMapper {

    private static final String ENCOUNTER_CLASS_CODE_SYSTEM = &quot;http://hl7.org/fhir/v3/ActCode&quot;;
    private static final String PARTICIPATION_TYPE_CODE_SYSTEM = &quot;http://hl7.org/fhir/v3/ParticipationType&quot;;

    private final TemporalMapper timeMapper;
    private final ProvenanceMapper provenanceMapper;
    private final CodingMapper codingMapper;
    private final PeriodMapper periodMapper;

    public EncounterMapper(@NotNull TemporalMapper timeMapper,
                           @NotNull ProvenanceMapper provenanceMapper,
                           @NotNull CodingMapper codingMapper,
<span class="fc" id="L54">                           @NotNull PeriodMapper periodMapper) {</span>

<span class="fc" id="L56">        this.timeMapper = timeMapper;</span>
<span class="fc" id="L57">        this.provenanceMapper = provenanceMapper;</span>
<span class="fc" id="L58">        this.codingMapper = codingMapper;</span>
<span class="fc" id="L59">        this.periodMapper = periodMapper;</span>
<span class="fc" id="L60">    }</span>

    public @NotNull FhirCriteriaResult&lt;Encounter&gt; toCriteriaResult(
            @NotNull CriteriaResult&lt;com.pkb.datamodel.Encounter&gt; modelEncounters,
            @NotNull List&lt;IncludeResource&gt; includeResources) {

<span class="fc" id="L66">        return ImmutableFhirCriteriaResult.&lt;Encounter&gt;fhirCriteriaResult(modelEncounters.getTotal())</span>
<span class="fc" id="L67">                .withPage(modelEncounters.getPage().map(this::toFhirEncounter))</span>
<span class="fc" id="L68">                .withIncludes(buildIncludes(modelEncounters, includeResources));</span>
    }

    private List&lt;Resource&gt; buildIncludes(CriteriaResult&lt;com.pkb.datamodel.Encounter&gt; encounters, 
                                         List&lt;IncludeResource&gt; includeResources) {
<span class="fc bfc" id="L73" title="All 2 branches covered.">        return includeResources.contains(IncludeResource.PROVENANCE) ?</span>
<span class="fc" id="L74">                encounters.getPage().flatMap(provenanceMapper::toProvenance) :</span>
<span class="fc" id="L75">                List();</span>
    }

    public @NotNull Encounter toFhirEncounter(@NotNull com.pkb.datamodel.Encounter modelEncounter) {

<span class="fc" id="L80">        Period period = new Period();</span>
<span class="fc" id="L81">        period.setStartElement(timeMapper.toDateTimeTypeInUTC(modelEncounter.getStart()));</span>
<span class="fc" id="L82">        period.setEndElement(timeMapper.toDateTimeTypeInUTC(modelEncounter.getEnd()));</span>

<span class="fc" id="L84">        Encounter fhirEncounter = new Encounter();</span>
<span class="fc" id="L85">        fhirEncounter.setId(modelEncounter.getId().toString());</span>
<span class="fc" id="L86">        fhirEncounter.setStatus(Encounter.EncounterStatus.UNKNOWN);</span>
<span class="fc" id="L87">        fhirEncounter.setPeriod(periodMapper.mapPeriod(modelEncounter.getStart(), modelEncounter.getEnd()));</span>

<span class="fc bfc" id="L89" title="All 2 branches covered.">        if (!modelEncounter.getLocationBlocks().isEmpty()) {</span>

            // Take distinct locations
<span class="fc" id="L92">            List&lt;LocationBlock&gt; locationMap = modelEncounter.getLocationBlocks()</span>
<span class="fc" id="L93">                    .distinctBy(LocationBlock::getLocation);</span>

            // Convert to FHIR locations
<span class="fc" id="L96">            List&lt;Location&gt; fhirLocations = locationMap.toList().map(this::toFhirLocation);</span>
            
            // Add each location as a contained resource
<span class="fc" id="L99">            fhirLocations.forEach(fhirEncounter::addContained);</span>
            
            // Create location block with references to contained resources
<span class="fc" id="L102">            modelEncounter.getLocationBlocks()</span>
<span class="fc" id="L103">                    .forEach(lb -&gt; {</span>
<span class="fc" id="L104">                        Reference reference = new Reference();</span>
<span class="fc" id="L105">                        reference.setReference(deriveKey(lb));</span>

<span class="fc" id="L107">                        Encounter.EncounterLocationComponent location = new Encounter.EncounterLocationComponent();</span>
<span class="fc" id="L108">                        location.setLocation(reference);</span>
<span class="fc" id="L109">                        location.setPeriod(periodMapper.mapPeriod(lb));</span>

<span class="fc" id="L111">                        fhirEncounter.addLocation(location);</span>
<span class="fc" id="L112">                    });</span>
        }

<span class="fc bfc" id="L115" title="All 2 branches covered.">        if (!modelEncounter.getParticipantBlocks().isEmpty()) {</span>
<span class="fc" id="L116">            modelEncounter.getParticipantBlocks().forEach(p -&gt; {</span>
<span class="fc" id="L117">                Encounter.EncounterParticipantComponent participant = new Encounter.EncounterParticipantComponent();</span>

                // Coding
<span class="fc" id="L120">                participant.setType(singletonList(toCodeableConcept(p.getParticipant().getRole())));</span>

                // Period
<span class="fc" id="L123">                participant.setPeriod(periodMapper.mapPeriod(p));</span>

                // Name
<span class="fc" id="L126">                Reference reference = new Reference();</span>
<span class="fc" id="L127">                reference.setDisplay(p.getParticipant().getName().value());</span>
<span class="fc" id="L128">                participant.setIndividual(reference);</span>

<span class="fc" id="L130">                fhirEncounter.addParticipant(participant);</span>
<span class="fc" id="L131">            });</span>
        }

<span class="pc bpc" id="L134" title="1 of 2 branches missed.">        if (modelEncounter.getEncounterClass() != EncounterClass.OTHER) {</span>
<span class="fc" id="L135">            fhirEncounter.setClass_(codingMapper.mapCoding(toCode(modelEncounter.getEncounterClass()), ENCOUNTER_CLASS_CODE_SYSTEM));</span>
        }

<span class="fc" id="L138">        toClassHistory(modelEncounter.getClassBlocks(this::encounterClassBlockShouldContinue, this::encounterClassIsNotOther))</span>
<span class="fc" id="L139">                .forEach(fhirEncounter::addClassHistory);</span>

<span class="fc" id="L141">        toSpecialtyHistory(modelEncounter.getSpecialtyBlocks())</span>
<span class="fc" id="L142">                .forEach(fhirEncounter::addExtension);</span>

<span class="fc" id="L144">        return fhirEncounter;</span>
    }

    private Location toFhirLocation(LocationBlock lb) {
<span class="fc" id="L148">        Location location = new Location();</span>
<span class="fc" id="L149">        location.setId(deriveKey(lb));</span>
<span class="fc" id="L150">        location.setDescription(lb.getLocation().value());</span>
<span class="fc" id="L151">        return location;</span>
    }
    
    private String deriveKey(LocationBlock lb) {
<span class="fc" id="L155">        return &quot;#location&quot; + lb.getLocation().hashCode();</span>
    }

    private @NotNull String toCode(@NotNull EncounterClass modelEncounterClass) {
<span class="pc bpc" id="L159" title="1 of 8 branches missed.">        switch (modelEncounterClass) {</span>
        case IN_PATIENT:
<span class="fc" id="L161">            return &quot;IMP&quot;;</span>
        case OUT_PATIENT:
        case AMBULATORY:
<span class="fc" id="L164">            return &quot;AMB&quot;;</span>
        case EMERGENCY:
<span class="fc" id="L166">            return &quot;EMER&quot;;</span>
        case HOME:
<span class="fc" id="L168">            return &quot;HH&quot;;</span>
        case FIELD:
<span class="fc" id="L170">            return &quot;FLD&quot;;</span>
        case DAYTIME:
<span class="fc" id="L172">            return &quot;SS&quot;;</span>
        case VIRTUAL:
<span class="fc" id="L174">            return &quot;VR&quot;;</span>
        default:
<span class="nc" id="L176">            throw new RuntimeException(format(&quot;Unknown model encounter class code [[%s]]&quot;, modelEncounterClass.toString()));</span>
        }
    }

    private List&lt;Encounter.ClassHistoryComponent&gt; toClassHistory(List&lt;EncounterClassBlock&gt; blocks) {
<span class="fc" id="L181">        return blocks.map(this::toClassHistoryElement);</span>
    }

    private List&lt;Extension&gt; toSpecialtyHistory(List&lt;SpecialtyBlock&gt; blocks) {
<span class="fc" id="L185">        return blocks.map(this::toSpecialtyHistoryExtension);</span>
    }

    private Extension toSpecialtyHistoryExtension(SpecialtyBlock block) {
<span class="fc" id="L189">        Extension extension = new Extension()</span>
<span class="fc" id="L190">                .setUrl(specialtyHistory());</span>

<span class="fc" id="L192">        extension.addExtension()</span>
<span class="fc" id="L193">                .setUrl(&quot;specialty&quot;)</span>
<span class="fc" id="L194">                .setValue(codingMapper.mapCoding(block.getSpecialty()));</span>

<span class="fc" id="L196">        extension.addExtension()</span>
<span class="fc" id="L197">                .setUrl(&quot;period&quot;)</span>
<span class="fc" id="L198">                .setValue(periodMapper.mapPeriod(block));</span>

<span class="fc" id="L200">        return extension;</span>
    }

    private Encounter.ClassHistoryComponent toClassHistoryElement(EncounterClassBlock block) {
<span class="fc" id="L204">        return new Encounter.ClassHistoryComponent()</span>
<span class="fc" id="L205">                .setClass_(codingMapper.mapCoding(toCode(block.getEncounterClass()), ENCOUNTER_CLASS_CODE_SYSTEM))</span>
<span class="fc" id="L206">                .setPeriod(periodMapper.mapPeriod(block));</span>
    }

    @NotNull
    private CodeableConcept toCodeableConcept(@NotNull ExternalParticipant.ParticipantRole participantRole) {
<span class="fc" id="L211">        String fhirCode = Match(participantRole).of(</span>
<span class="fc" id="L212">                Case($(ATTENDER), &quot;ATND&quot;),</span>
<span class="fc" id="L213">                Case($(REFERRER), &quot;REF&quot;),</span>
<span class="fc" id="L214">                Case($(CONSULTANT), &quot;CON&quot;),</span>
<span class="fc" id="L215">                Case($(), o -&gt; {</span>
<span class="nc" id="L216">                    throw new RuntimeException(format(&quot;Unknown participant role [[%s]]&quot;, participantRole.name()));</span>
                }));

<span class="fc" id="L219">        CodeableConcept codeableConcept = new CodeableConcept();</span>
<span class="fc" id="L220">        codeableConcept.setCoding(singletonList(codingMapper.mapCoding(fhirCode, PARTICIPATION_TYPE_CODE_SYSTEM)));</span>
<span class="fc" id="L221">        return codeableConcept;</span>
    }
    
    private boolean encounterClassBlockShouldContinue(EncounterClass class1, EncounterClass class2) {
<span class="fc bfc" id="L225" title="All 6 branches covered.">        return (class1 == OUT_PATIENT ? AMBULATORY : class1) == (class2 == OUT_PATIENT ? AMBULATORY : class2);</span>
    }

    private boolean encounterClassIsNotOther(EncounterEvent ev) {
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">        return ev.encounterClass() != OTHER;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>