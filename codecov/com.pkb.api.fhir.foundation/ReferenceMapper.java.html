<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReferenceMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.fhir.foundation</a> &gt; <span class="el_source">ReferenceMapper.java</span></div><h1>ReferenceMapper.java</h1><pre class="source lang-java linenums">package com.pkb.api.fhir.foundation;

import ca.uhn.fhir.rest.server.exceptions.InternalErrorException;
import com.pkb.datamodel.Org;
import com.pkb.datamodel.authorization.ConsentedEntity;
import com.pkb.datamodel.consent.Purview;
import com.pkb.datamodel.team.BaseTeam;
import com.pkb.datamodel.team.Team;
import com.pkb.datamodel.team.TeamWithOrg;
import com.pkb.datamodel.user.Patient;
import com.pkb.datamodel.user.Person;
import com.pkb.datamodel.user.Professional;
import com.pkb.datamodel.user.TeamCoordinator;
import com.pkb.questionnaireservice.modelv2.Questionnaire;
import io.vavr.collection.List;
import org.apache.commons.lang3.StringUtils;
import org.hl7.fhir.dstu3.model.Reference;
import org.hl7.fhir.dstu3.model.ResourceType;

import java.util.UUID;

import static io.vavr.API.List;
import static org.hl7.fhir.dstu3.model.ResourceType.Organization;
import static org.hl7.fhir.dstu3.model.ResourceType.Patient;
import static org.hl7.fhir.dstu3.model.ResourceType.Practitioner;

<span class="fc" id="L27">public class ReferenceMapper {</span>

    public Reference toReference(Purview purview) {
<span class="fc" id="L30">        return purview.getPatient().map(this::toReference)</span>
<span class="fc" id="L31">                .getOrElse(() -&gt; purview.getProfessional().map(this::toReference)</span>
<span class="fc" id="L32">                        .getOrElse(() -&gt; purview.getTeam().map(this::toReference)</span>
<span class="pc" id="L33">                                .getOrElseThrow(() -&gt; new IllegalStateException(&quot;Undefined purview&quot;))));</span>
    }

    public Reference toReference(Org org) {
<span class="fc" id="L37">        return toReference(Organization, org.getPublicId());</span>
    }

    public Reference toReferenceWithName(ConsentedEntity ae) {
<span class="fc bfc" id="L41" title="All 2 branches covered.">        if (ae instanceof TeamWithOrg) {</span>
<span class="fc" id="L42">            return toReferenceWithName((TeamWithOrg) ae);</span>
<span class="fc bfc" id="L43" title="All 2 branches covered.">        } else if (ae instanceof Professional) {</span>
<span class="fc" id="L44">            return toReferenceWithName((Professional) ae);</span>
<span class="fc bfc" id="L45" title="All 2 branches covered.">        } else if (ae instanceof TeamCoordinator) {</span>
<span class="fc" id="L46">            return toReferenceWithName((TeamCoordinator) ae);</span>
<span class="pc bpc" id="L47" title="1 of 2 branches missed.">        } else if (ae instanceof Patient) {</span>
<span class="fc" id="L48">            return toReferenceWithName((Patient) ae);</span>
        } else {
<span class="nc" id="L50">            throw new InternalErrorException(&quot;Unknown AccessingEntity subclass &quot; + ae.getClass().getName());</span>
        }
    }

    private Reference toReferenceWithName(TeamWithOrg patientTeam) {
<span class="fc" id="L55">        Reference reference = toReference(patientTeam);</span>
<span class="fc" id="L56">        reference.setDisplay(patientTeam.getName());</span>
<span class="fc" id="L57">        return reference;</span>
    }

    private Reference toReferenceWithName(Professional p) {
<span class="fc" id="L61">        Reference reference = toReference(p);</span>
<span class="fc" id="L62">        reference.setDisplay(toDisplay(p));</span>
<span class="fc" id="L63">        return reference;</span>
    }

    public Reference toReferenceWithName(Patient p) {
<span class="fc" id="L67">        Reference reference = toReference(p);</span>
<span class="fc" id="L68">        reference.setDisplay(toDisplay(p));</span>
<span class="fc" id="L69">        return reference;</span>
    }

    public Reference toReferenceWithName(TeamCoordinator tc) {
<span class="fc" id="L73">        Reference reference = toReference(tc);</span>
<span class="fc" id="L74">        reference.setDisplay(toDisplay(tc));</span>
<span class="fc" id="L75">        return reference;</span>
    }

    public Reference toReferenceWithName(Org org) {
<span class="fc" id="L79">        return toReference(org).setDisplay(org.getName());</span>
    }

    public Reference toReferenceWithName(BaseTeam team) {
<span class="fc" id="L83">        return toReference(team).setDisplay(team.getName());</span>
    }

    public String toDisplay(Person person) {
<span class="fc" id="L87">        List&lt;String&gt; name = List();</span>
<span class="fc" id="L88">        name = person.demographics().getTitle().filter(StringUtils::isNotBlank).map(name::append).getOrElse(name);</span>
<span class="fc" id="L89">        name = person.demographics().getFirstName().filter(StringUtils::isNotBlank).map(name::append).getOrElse(name);</span>
<span class="fc" id="L90">        name = person.demographics().getLastName().filter(StringUtils::isNotBlank).map(name::append).getOrElse(name);</span>
<span class="fc" id="L91">        return String.join(&quot; &quot;, name);</span>
    }

    public Reference toReference(Patient patient) {
<span class="fc" id="L95">        return toReference(Patient, patient.getPublicId());</span>
    }

    public Reference toReference(Professional professional) {
<span class="fc" id="L99">        return toReference(Practitioner, professional.getPublicId());</span>
    }

    public Reference toReference(TeamCoordinator teamCoordinator) {
<span class="fc" id="L103">        return toReference(Practitioner, teamCoordinator.getPublicId());</span>
    }

    public Reference toReference(Team team) {
<span class="fc" id="L107">        return toReference(Organization, team.getPublicId());</span>
    }

    public Reference toReference(BaseTeam team) {
<span class="fc" id="L111">        return toReference(Organization, team.getPublicId());</span>
    }

    public Reference toReference(TeamWithOrg patientTeam) {
<span class="fc" id="L115">        return toReference(Organization, patientTeam.getPublicId())</span>
<span class="fc" id="L116">                .setDisplay(patientTeam.getName());</span>
    }

    public Reference toReference(ResourceType type, UUID id) {
<span class="fc" id="L120">        return toReference(type, id.toString());</span>
    }

    public Reference toReference(ResourceType type, String id) {
<span class="fc" id="L124">        Reference reference = new Reference();</span>
<span class="fc" id="L125">        reference.setReference(type + &quot;/&quot; + id);</span>
<span class="fc" id="L126">        return reference;</span>
    }

    public Reference toReferenceWithName(Questionnaire questionnaire){
<span class="fc" id="L130">        return toReference(ResourceType.Questionnaire, questionnaire.getId()).setDisplay(questionnaire.getName());</span>
    }

    public Reference toContainedReference(Patient carer, String containedReferenceId) {
<span class="fc" id="L134">        Reference reference = new Reference();</span>
<span class="fc" id="L135">        reference.setReference(containedReferenceId);</span>
<span class="fc" id="L136">        reference.setDisplay(toDisplay(carer));</span>
<span class="fc" id="L137">        return reference;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>