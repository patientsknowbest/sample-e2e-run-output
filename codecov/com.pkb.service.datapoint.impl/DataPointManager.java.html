<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataPointManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.datapoint.impl</a> &gt; <span class="el_source">DataPointManager.java</span></div><h1>DataPointManager.java</h1><pre class="source lang-java linenums">package com.pkb.service.datapoint.impl;

import com.google.common.collect.Sets;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.PersonAuthInfo;
import com.pkb.app.entity.SourceDetails;
import com.pkb.app.interfaces.IBaseDTO;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.entities.enums.Route;
import com.pkb.entities.enums.UserType;
import com.pkb.institute.entity.Team;
import com.pkb.service.datapoint.DataWithUIPermissions;
import com.pkb.service.user.impl.UserManager;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.user.entity.PKBPerson;
import com.pkb.util.tolven.TolvenBeanFactory;
import com.pkb.util.tolven.TransactionManager;

import java.util.Collection;
import java.util.List;
import java.util.Objects;
import java.util.Set;

import static com.pkb.entities.enums.Route.EMIS_PFS;
import static com.pkb.entities.enums.Route.NOT_CAPTURED;
import static com.pkb.entities.enums.Route.REST_API;
import static com.pkb.entities.enums.Route.WEBAPP;
import static com.pkb.entities.enums.Route.WEBAPP_EMIS_PORTAL;
import static com.pkb.entities.enums.Route.WEBAPP_NHS_APP;
import static com.pkb.entities.enums.Route.WEBAPP_SYSTMONE_PORTAL;
import static com.pkb.entities.enums.UserType.PATIENT;
import static com.pkb.entities.enums.UserType.REG_CLINICIAN;
import static java.util.stream.Collectors.toList;

public class DataPointManager extends TransactionManager {

<span class="fc" id="L38">    private static final Set&lt;Route&gt; NOT_AUTOMATED_SOURCES = Sets.immutableEnumSet(</span>
            WEBAPP,
            WEBAPP_EMIS_PORTAL,
            WEBAPP_SYSTMONE_PORTAL,
            WEBAPP_NHS_APP,
            REST_API,
            NOT_CAPTURED);

<span class="fc" id="L46">    private static final Set&lt;UserType&gt; CAN_EDIT_PRIVACY_REGARDLESS_SOURCE = Sets.immutableEnumSet(</span>
            PATIENT,
            REG_CLINICIAN);

    private final UserManager userManager;

    public DataPointManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider, UserManager userManager) {
<span class="fc" id="L53">        super(config, beanFactory, dateTimeService, uuidProvider);</span>
<span class="fc" id="L54">        this.userManager = userManager;</span>
<span class="fc" id="L55">    }</span>

    public &lt;T extends IBaseDTO&gt; List&lt;DataWithUIPermissions&lt;T&gt;&gt; getPermissions(Collection&lt;T&gt; data, Long callerId, boolean callerIsClinician, Long callerTeamId) {
<span class="nc" id="L58">        PKBPerson callerPerson = userManager.getPKBPerson(callerId);</span>
<span class="nc" id="L59">        return getPermissions(data, callerPerson, callerIsClinician, callerTeamId);</span>
    }

    public &lt;T extends IBaseDTO&gt; List&lt;DataWithUIPermissions&lt;T&gt;&gt; getPermissions(Collection&lt;T&gt; data, PKBPerson callerPerson, Team callerTeam) {
<span class="fc" id="L63">        boolean callerIsClinician = callerPerson.isPro();</span>
<span class="fc" id="L64">        Long callerTeamId = getTeamId(callerPerson, callerTeam);</span>
<span class="fc" id="L65">        return data.stream()</span>
<span class="fc" id="L66">                .map(d -&gt; getPermission(d, callerPerson, callerIsClinician, callerTeamId))</span>
<span class="fc" id="L67">                .collect(toList());</span>
    }

    public &lt;T extends IBaseDTO&gt; List&lt;DataWithUIPermissions&lt;T&gt;&gt; getPermissions(Collection&lt;T&gt; data, PKBPerson callerPerson, boolean callerIsClinician, Long callerTeamId) {
<span class="nc" id="L71">        return data.stream()</span>
<span class="nc" id="L72">                .map(d -&gt; getPermission(d, callerPerson, callerIsClinician, callerTeamId))</span>
<span class="nc" id="L73">                .collect(toList());</span>
    }

    public &lt;T extends IBaseDTO&gt; List&lt;DataWithUIPermissions&lt;T&gt;&gt; getPermissions(Collection&lt;T&gt; data, EHRRequestContext requestContext) {
<span class="fc" id="L77">        return data.stream()</span>
<span class="fc" id="L78">                .map(d -&gt; getPermission(d, requestContext))</span>
<span class="fc" id="L79">                .collect(toList());</span>
    }

    public &lt;T extends IBaseDTO&gt; DataWithUIPermissions&lt;T&gt; getPermission(T data, Long callerId, boolean callerIsClinician, Long callerTeamId) {
<span class="nc" id="L83">        PKBPerson callerPerson = userManager.getPKBPerson(callerId);</span>
<span class="nc" id="L84">        return getPermission(data, callerPerson, callerIsClinician, callerTeamId);</span>
    }

    public &lt;T extends IBaseDTO&gt; DataWithUIPermissions&lt;T&gt; getPermission(T data, PKBPerson callerPerson, Team callerTeam) {
<span class="fc" id="L88">        boolean callerIsClinician = callerPerson.isPro();</span>
<span class="fc" id="L89">        Long callerTeamId = getTeamId(callerPerson, callerTeam);</span>
<span class="fc" id="L90">        return getPermission(data, callerPerson, callerIsClinician, callerTeamId);</span>
    }

    public &lt;T extends IBaseDTO&gt; DataWithUIPermissions&lt;T&gt; getPermission(T data, EHRRequestContext requestContext) {
<span class="pc" id="L94">        PersonAuthInfo loggedInUser = requestContext.getMaybeAccessingUser().orElseThrow(() -&gt; new IllegalStateException(&quot;No logged in user!&quot;));</span>
<span class="fc" id="L95">        return doGetPermission(data, loggedInUser.getId(), loggedInUser.getUserType(), loggedInUser.isPro(), requestContext.getTeamId().orElse(null));</span>
    }

    public &lt;T extends IBaseDTO&gt; DataWithUIPermissions&lt;T&gt; getPermission(T data, PKBPerson callerPerson, boolean callerIsClinician, Long callerTeamId) {
<span class="fc" id="L99">        return doGetPermission(data, callerPerson.getId(), callerPerson.getUserType(), callerIsClinician, callerTeamId);</span>
    }

    private &lt;T extends IBaseDTO&gt; DataWithUIPermissions&lt;T&gt; doGetPermission(T data, Long callerUserId, UserType callerUserType, boolean callerIsClinician, Long callerTeamId) {
<span class="fc" id="L103">        DataWithUIPermissions&lt;T&gt; result = new DataWithUIPermissions&lt;&gt;(data);</span>
<span class="fc" id="L104">        boolean canEditPrivacyFlags = CAN_EDIT_PRIVACY_REGARDLESS_SOURCE.contains(callerUserType);</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        if (data.getSource() == null) {</span>
<span class="nc" id="L106">            result.setEditOrDeletable(false);</span>
<span class="nc" id="L107">            result.setPrivacyFlagEditable(canEditPrivacyFlags);</span>
        } else {
<span class="fc bfc" id="L109" title="All 2 branches covered.">            if (isCallerTheCreator(callerUserId, data.getSource())) {</span>
<span class="fc" id="L110">                result.setEditOrDeletable(true);</span>
<span class="fc" id="L111">                result.setPrivacyFlagEditable(true);</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">            } else if (isEmisIntegratedAppointment(data.getSource().getRoute())) {</span>
<span class="fc" id="L113">                result.setEditOrDeletable(false);</span>
<span class="fc" id="L114">                result.setPrivacyFlagEditable(false);</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">                if (callerUserType == PATIENT) {</span>
<span class="fc" id="L116">                    result.setEditEmisIntegratedAppointment(true);</span>
                }
            } else {
<span class="fc" id="L119">                boolean isEditable = canEdit(callerIsClinician, callerTeamId, data.getSource());</span>
<span class="fc" id="L120">                result.setEditOrDeletable(isEditable);</span>
<span class="pc bpc" id="L121" title="3 of 4 branches missed.">                result.setPrivacyFlagEditable(canEditPrivacyFlags || isEditable);</span>
            }
        }
<span class="fc" id="L124">        return result;</span>
    }

    public boolean isEmisIntegratedAppointment(Route route) {
<span class="fc bfc" id="L128" title="All 2 branches covered.">        return route == EMIS_PFS;</span>
    }

    private Long getTeamId(PKBPerson callerPerson, Team callerTeam) {
<span class="fc bfc" id="L132" title="All 4 branches covered.">        if (callerPerson.isPro() &amp;&amp; callerTeam != null) {</span>
<span class="fc" id="L133">            return callerTeam.getId();</span>
        }
<span class="fc" id="L135">        return null;</span>
    }

    private boolean canEdit(boolean callerIsClinician, Long callerTeamId, SourceDetails source) {

<span class="fc bfc" id="L140" title="All 4 branches covered.">        if (!callerIsClinician || callerTeamId == null) {</span>
<span class="fc" id="L141">            return false;</span>
        }

<span class="fc" id="L144">        Long sourceTeamId = source.getTeamId();</span>
<span class="fc bfc" id="L145" title="All 6 branches covered.">        return sourceTeamId != null &amp;&amp; Objects.equals(sourceTeamId, callerTeamId) &amp;&amp; isNotAutomatedSource(source.getRoute());</span>

    }

    private boolean isCallerTheCreator(Long callerId, SourceDetails source) {
<span class="fc" id="L150">        return Objects.equals(callerId, source.getPersonId());</span>
    }

    private boolean isNotAutomatedSource(Route route) {
<span class="fc" id="L154">        return NOT_AUTOMATED_SOURCES.contains(route);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>