<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StartLetterInvitedPatientActivationAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.registration.letter</a> &gt; <span class="el_source">StartLetterInvitedPatientActivationAction.java</span></div><h1>StartLetterInvitedPatientActivationAction.java</h1><pre class="source lang-java linenums">package com.pkb.action.registration.letter;

import com.pkb.action.registration.AbstractPatientActivationDTO;
import com.pkb.action.registration.PatientActivationDetailsDTOConverter;
import com.pkb.datamodel.Email;
import com.pkb.model.PKBSecurityQuestion;
import com.pkb.patient.PatientActivationManager;
import com.pkb.patient.activation.letter.AccountDetailsDTO;
import com.pkb.patient.activation.letter.InvitationTokenDTO;
import com.pkb.util.TermsAndConditionsConfigDTO;
import io.vavr.Tuple2;
import org.apache.commons.lang3.StringUtils;
import org.apache.struts2.interceptor.validation.SkipValidation;

import javax.inject.Inject;
import javax.servlet.http.HttpServletRequest;
import javax.validation.Valid;
import javax.validation.constraints.NotNull;
import java.util.ArrayList;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;

import static com.pkb.action.registration.letter.PatientActivationDetailsDTO.EMAILS_MUST_MATCH;
import static com.pkb.action.registration.letter.PatientActivationDetailsDTO.EMAIL_MUST_MATCH_WITH_EMAIL_CONFIRMATION;
import static com.pkb.action.registration.letter.PatientActivationDetailsDTO.PASSWORDS_MUST_MATCH;
import static com.pkb.action.registration.letter.PatientActivationDetailsDTO.PASSWORD_MUST_MATCH_WITH_PASSWORD_CONFIRMATION;

<span class="fc" id="L31">public class StartLetterInvitedPatientActivationAction extends LetterInvitationBaseAction {</span>

    private static final String INVITATION_CODE_REQUEST_PARAM_NAME = &quot;t1&quot;;
    private static final String INVALID_CODE = &quot;invitation.codes.invalid&quot;;

    @Valid
    @NotNull(message = &quot;submitted.no.data&quot;)
    private PatientActivationDetailsDTO activationDetails;
    private String clue;
    private long invitationClue;

    private Long inviteeId;
    private TermsAndConditionsConfigDTO termsAndConditionsConfig;

    @Inject
    private CompositeDatePartsValueProvider dateValueProvider;
    @Inject
    private PatientActivationManager patientActivationManager;
    @Inject
    private PatientActivationDetailsDTOConverter activationDetailsConverter;

    @SkipValidation
    public String displayForm() {
<span class="fc" id="L54">        termsAndConditionsConfig = buildTermsAndConditionsConfig();</span>
<span class="fc bfc" id="L55" title="All 2 branches covered.">        if (activationDetails != null) {</span>
<span class="fc" id="L56">            inviteeId = patientActivationManager.getInvitedPersonIdByInvitationCode(activationDetails.getInvitationCode()).orElse(null);</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">            if (isFirstPageLoad(getRequest())) {</span>
<span class="fc" id="L58">                Optional.ofNullable(inviteeId)</span>
<span class="fc" id="L59">                        .map(userManager::getPKBPerson)</span>
<span class="fc" id="L60">                        .ifPresent(pkbPerson -&gt; activationDetailsConverter.copyGenderAndAddressFields(pkbPerson, activationDetails));</span>
            }
        }
<span class="fc" id="L63">        lookupBrandDetails(clue);</span>
<span class="fc" id="L64">        return INPUT;</span>
    }

    public String activatePatient() {
<span class="fc" id="L68">        termsAndConditionsConfig = buildTermsAndConditionsConfig();</span>
<span class="fc" id="L69">        recordValidationErrors();</span>
<span class="fc" id="L70">        updateCodeErrors();</span>
<span class="fc" id="L71">        weakenActionLevelErrorToFieldLevel(PASSWORDS_MUST_MATCH, &quot;activationDetails.password&quot;, PASSWORD_MUST_MATCH_WITH_PASSWORD_CONFIRMATION);</span>
<span class="fc" id="L72">        weakenActionLevelErrorToFieldLevel(EMAILS_MUST_MATCH, &quot;activationDetails.email&quot;, EMAIL_MUST_MATCH_WITH_EMAIL_CONFIRMATION);</span>
<span class="fc" id="L73">        boolean branded = lookupBrandDetails(clue);</span>

<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (isRequestNotValid()) {</span>
<span class="fc" id="L76">            Set&lt;String&gt; fieldsWithError = getFieldErrors().keySet();</span>
<span class="pc bpc" id="L77" title="1 of 2 branches missed.">            if (fieldsWithError.contains(&quot;activationDetails&quot;)) {</span>
<span class="nc" id="L78">                promoteFieldLevelToActionLevelError(&quot;activationDetails&quot;);</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">            } else if (fieldsWithError.contains(&quot;activationDetails.dayOfBirth&quot;) ||</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">                    fieldsWithError.contains(&quot;activationDetails.monthOfBirth&quot;) ||</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">                    fieldsWithError.contains(&quot;activationDetails.yearOfBirth&quot;)) {</span>
<span class="fc" id="L82">                Collection&lt;String&gt; actionErrors = new ArrayList&lt;&gt;(getActionErrors());</span>
<span class="fc" id="L83">                actionErrors.remove(getText(&quot;invalid.date.of.birth.value&quot;));</span>
<span class="fc" id="L84">                setActionErrors(actionErrors);</span>
            }

<span class="fc" id="L87">            weakenActionLevelErrorToFieldLevel(&quot;invalid.date.of.birth.value&quot;, &quot;activationDetails.dateOfBirth&quot;);</span>

<span class="fc" id="L89">            return displayForm();</span>
        }

<span class="fc" id="L92">        setQuestionText(activationDetails, getQuestions());</span>
<span class="fc" id="L93">        Tuple2&lt;InvitationTokenDTO, AccountDetailsDTO&gt; activationRequestArguments = activationDetailsConverter.convert(activationDetails);</span>
<span class="fc" id="L94">        invitationClue = patientActivationManager.activatePatient(activationRequestArguments._1(), activationRequestArguments._2(),</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">                branded, getEHRRequestContext() == null ? null : getEHRRequestContext().getContextUserId().map(Object::toString).orElse(null)).getId();</span>
<span class="fc" id="L96">        inviteeId = patientActivationManager.getInvitedPersonIdByInvitationCode(activationDetails.getInvitationCode()).orElse(null);</span>
<span class="fc" id="L97">        Optional.ofNullable(inviteeId)</span>
<span class="fc" id="L98">                .map(userManager::getPKBPerson)</span>
<span class="fc" id="L99">                .filter(pkbPerson -&gt; activationDetailsConverter.copyGenderAndAddressFields(activationDetails, pkbPerson))</span>
<span class="fc" id="L100">                .ifPresent(pkbPerson -&gt; userManager.updateUser(getEHRRequestContext().withRegisteringUser(inviteeId), pkbPerson));</span>
<span class="fc" id="L101">        return SUCCESS;</span>
    }

    private void updateCodeErrors() {
<span class="fc" id="L105">        var fieldErrors = getFieldErrors();</span>
<span class="fc" id="L106">        var codes = List.of(&quot;activationDetails.invitationCode&quot;, &quot;activationDetails.decryptToken&quot;);</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">        if (codes.stream().anyMatch(fieldErrors::containsKey)) {</span>
<span class="fc" id="L108">            addFieldError(&quot;activationDetails.codes&quot;, getText(INVALID_CODE));</span>
        }
<span class="fc" id="L110">    }</span>

    /** Some clients put the invitation code into the invitation URL so that it appears within the request
     * parameters which means this is the first time the user opens the page and we can pre-populate the gender and
     * address fields. In this case the invitation code is also set on the {@link PatientActivationDetailsDTO} object
     * via {@link StartLetterInvitedPatientActivationAction#setT1(String)} but it can also be set via a former invalid
     * form submission therefore we should check for the request parameter and only update the activation details from
     * the existing record when it is present.
     *
     * @return true if a non blank invitation code is within the request parameters, false otherwise
     */
    private boolean isFirstPageLoad(HttpServletRequest request) {
<span class="fc" id="L122">        return StringUtils.isNotBlank(request.getParameter(INVITATION_CODE_REQUEST_PARAM_NAME));</span>
    }

    public static void setQuestionText(AbstractPatientActivationDTO activationDetails, List&lt;PKBSecurityQuestion&gt; questions) {
<span class="fc" id="L126">        Long id = activationDetails.getSecurityQuestionId();</span>
<span class="fc" id="L127">        questions.stream().filter(q -&gt; q.getId().equals(id)).findFirst()</span>
<span class="fc" id="L128">                .ifPresent(q -&gt; activationDetails.setSecurityQuestion(q.getQuestion()));</span>
<span class="fc" id="L129">    }</span>

    public Map&lt;String, String&gt; getDays() {
<span class="fc" id="L132">        return dateValueProvider.getDays();</span>
    }

    public Map&lt;String, String&gt; getMonths() {
<span class="fc" id="L136">        return dateValueProvider.getMonths(this::getText);</span>
    }

    public Map&lt;String, String&gt; getYears() {
<span class="fc" id="L140">        return dateValueProvider.getYears();</span>
    }

    public List&lt;PKBSecurityQuestion&gt; getQuestions() {
<span class="fc" id="L144">        return pkbWebUtil.getSecretQuestions(getLocale());</span>
    }

    public PatientActivationDetailsDTO getActivationDetails() {
<span class="fc bfc" id="L148" title="All 2 branches covered.">        if (activationDetails == null) {</span>
<span class="fc" id="L149">            activationDetails = new PatientActivationDetailsDTO();</span>
        }
<span class="fc" id="L151">        return activationDetails;</span>
    }

    public void setActivationDetails(PatientActivationDetailsDTO activationDetails) {
<span class="nc" id="L155">        this.activationDetails = activationDetails;</span>
<span class="nc" id="L156">    }</span>

    public void setE(Email emailAddress) {
<span class="fc" id="L159">        getActivationDetails().setEmail(emailAddress);</span>
<span class="fc" id="L160">        getActivationDetails().setEmailConfirmation(emailAddress);</span>
<span class="fc" id="L161">    }</span>

    public void setT1(String token1) {
<span class="fc" id="L164">        getActivationDetails().setInvitationCode(token1);</span>
<span class="fc" id="L165">    }</span>

    public void setT2(String token2) {
<span class="fc" id="L168">        getActivationDetails().setDecryptToken(token2);</span>
<span class="fc" id="L169">    }</span>

    public long getInvitationClue() {
<span class="fc" id="L172">        return invitationClue;</span>
    }

    public Long getInviteeId() {
<span class="fc" id="L176">        return inviteeId;</span>
    }

    public void setInviteeId(Long inviteeId) {
<span class="nc" id="L180">        this.inviteeId = inviteeId;</span>
<span class="nc" id="L181">    }</span>

    public String getClue() {
<span class="fc" id="L184">        return clue;</span>
    }

    public void setClue(String clue) {
<span class="fc" id="L188">        this.clue = clue;</span>
<span class="fc" id="L189">    }</span>

    public Email getEmailValue() {
<span class="fc" id="L192">        return activationDetails.getEmail();</span>
    }

    public String getAction() {
<span class="fc" id="L196">        return &quot;letterInvitedPatient&quot;;</span>
    }

    public String getNhsLoginInfoClass() {
<span class="fc" id="L200">        String cssClass = &quot;nhs-login-info-message&quot;;</span>

<span class="fc bfc" id="L202" title="All 2 branches covered.">        if (!getFieldErrors().containsKey(&quot;activationDetails.codes&quot;)) {</span>
<span class="fc" id="L203">            cssClass += &quot; hidden&quot;;</span>
        }

<span class="fc" id="L206">        return cssClass;</span>
    }

    public boolean isNhsLoginRegistrationEnabled() {
<span class="fc" id="L210">        return config.isNhsLoginWebUiButtonEnabledForSelfRegistration();</span>
    }

    public TermsAndConditionsConfigDTO getTermsAndConditionsConfig() {
<span class="fc" id="L214">        return termsAndConditionsConfig;</span>
    }

    public void setTermsAndConditionsConfig(TermsAndConditionsConfigDTO termsAndConditionsConfig) {
<span class="nc" id="L218">        this.termsAndConditionsConfig = termsAndConditionsConfig;</span>
<span class="nc" id="L219">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>