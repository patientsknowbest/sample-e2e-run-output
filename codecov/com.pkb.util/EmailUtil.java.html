<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmailUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.util</a> &gt; <span class="el_source">EmailUtil.java</span></div><h1>EmailUtil.java</h1><pre class="source lang-java linenums">package com.pkb.util;

import com.google.common.collect.ImmutableMap;
import com.google.common.collect.Maps;
import com.google.common.net.UrlEscapers;
import com.pkb.app.interfaces.IBaseDTO;
import com.pkb.entities.enums.MenuDataType;
import com.pkb.entities.enums.Message;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import com.pkb.notification.entity.Activity;
import com.pkb.radiology.entity.RadiologyResult;
import com.pkb.radiology.entity.RadiologyResult.MediaActCategory;
import com.pkb.util.security.RelaxedHtmlMessageFilter;
import io.vavr.Tuple;
import io.vavr.Tuple2;
import org.apache.commons.lang3.StringUtils;

import java.util.HashMap;
import java.util.Map;
import java.util.Optional;

import static com.pkb.entities.enums.MenuDataType.allergy;
import static com.pkb.entities.enums.MenuDataType.appointment;
import static com.pkb.entities.enums.MenuDataType.audioResult;
import static com.pkb.entities.enums.MenuDataType.diagnosis;
import static com.pkb.entities.enums.MenuDataType.diaryEntry;
import static com.pkb.entities.enums.MenuDataType.event;
import static com.pkb.entities.enums.MenuDataType.file;
import static com.pkb.entities.enums.MenuDataType.geneticsFile;
import static com.pkb.entities.enums.MenuDataType.libraryEntry;
import static com.pkb.entities.enums.MenuDataType.loincTestResult;
import static com.pkb.entities.enums.MenuDataType.medication;
import static com.pkb.entities.enums.MenuDataType.message;
import static com.pkb.entities.enums.MenuDataType.phplan;
import static com.pkb.entities.enums.MenuDataType.radiologyResult;
import static com.pkb.entities.enums.Message.ACCOUNT_ACTIVATION_CARER_NOTIFICATION;
import static com.pkb.entities.enums.Message.ACCOUNT_ACTIVATION_NOTIFICATION;
import static com.pkb.entities.enums.Message.ACTIVITY_NOTIFICATION_TO_CARER_FOR_PATIENT;
import static com.pkb.entities.enums.Message.ACTIVITY_NOTIFICATION_TO_PATIENT_V2;
import static com.pkb.entities.enums.Message.BREAK_THE_GLASS_CARER_NOTIFICATION;
import static com.pkb.entities.enums.Message.BREAK_THE_GLASS_PATIENT_NOTIFICATION;
import static com.pkb.entities.enums.Message.CARER_ACCEPTS_INVITATION_FROM_OTHER_USER_NOTIFY_CARER;
import static com.pkb.entities.enums.Message.CARER_ACCEPTS_INVITATION_FROM_OTHER_USER_NOTIFY_PATIENT;
import static com.pkb.entities.enums.Message.HANDOVER_DISCUSSION_NOTIFICATION_TO_OTHER_CARER_FOR_PATIENT;
import static com.pkb.entities.enums.Message.HANDOVER_DISCUSSION_NOTIFICATION_TO_OTHER_PERSON;
import static com.pkb.entities.enums.Message.INDIV_ACCESS_REVOKED_NOTIFICATION_TO_PATIENT;
import static com.pkb.entities.enums.Message.INVITE_CARER_TO_TAKE_QUESTIONNAIRE_FOR_PATIENT;
import static com.pkb.entities.enums.Message.INVITE_PATIENT_TO_TAKE_QUESTIONNAIRE;
import static com.pkb.entities.enums.Message.NOTIFICATION_CLINICIAN_ACCEPTED_INVITATION;
import static com.pkb.entities.enums.Message.NOTIFY_CARER_ACCESS_REVOKED_FOR_PERSON;
import static com.pkb.entities.enums.Message.NOTIFY_CARER_OF_CREATED_PATIENT_ACCOUNT;
import static com.pkb.entities.enums.Message.NOTIFY_CARER_OF_DOCUMENT_RECEIVED_BY_PATIENT;
import static com.pkb.entities.enums.Message.NOTIFY_CARER_OF_PATIENT_INVITATION_WITH_PRIVACY_LABELS;
import static com.pkb.entities.enums.Message.NOTIFY_CARER_THAT_CLINICIAN_ACCEPTED_INVITATION;
import static com.pkb.entities.enums.Message.NOTIFY_PATIENT_OF_CREATED_ACCOUNT;
import static com.pkb.entities.enums.Message.NOTIFY_PATIENT_OF_DOCUMENT_RECEIVED;
import static com.pkb.entities.enums.Message.NOTIFY_PATIENT_OF_INVITATION_WITH_PRIVACY_LABELS;
import static com.pkb.entities.enums.Message.NOTIFY_PATIENT_THAT_CLINICIAN_ACCEPTED_INVITATION;
import static com.pkb.entities.enums.Message.OTHER_USER_INVITES_CARER_NOTIFY_CARER;
import static com.pkb.entities.enums.Message.OTHER_USER_INVITES_CARER_NOTIFY_PATIENT;
import static com.pkb.entities.enums.Message.PRIVACY_LABEL_NOTIFICATION_TO_CARER;
import static com.pkb.entities.enums.Message.PRIVACY_LABEL_NOTIFICATION_TO_PATIENT;
import static com.pkb.entities.enums.Message.REVOKE_ACCESS_NOTIFICATION_TO_CARER;
import static com.pkb.entities.enums.Message.REVOKE_ACCESS_NOTIFICATION_TO_PATIENT;
import static com.pkb.entities.enums.Message.TEAM_ACCESS_GRANTED_NOTIFICATION_TO_CARER_FOR_PATIENT;
import static com.pkb.entities.enums.Message.TEAM_ACCESS_GRANTED_NOTIFICATION_TO_PATIENT;
import static com.pkb.notification.entity.Activity.Action.ADDED_ALLERGY;
import static com.pkb.notification.entity.Activity.Action.ADDED_DIAGNOSIS;
import static com.pkb.notification.entity.Activity.Action.ADDED_DIARY_ENTRY;
import static com.pkb.notification.entity.Activity.Action.ADDED_FILE;
import static com.pkb.notification.entity.Activity.Action.ADDED_LIBRARY_LINK;
import static com.pkb.notification.entity.Activity.Action.ADDED_MEDICATION_RECORD;
import static com.pkb.notification.entity.Activity.Action.EDITED_APPOINTMENT;
import static com.pkb.notification.entity.Activity.Action.INVITED_TO_APPOINTMENT;
import static com.pkb.notification.entity.Activity.Action.SENT_MESSAGE;
import static com.pkb.notification.entity.Activity.Action.UPLOADED_AUDIO;
import static com.pkb.notification.entity.Activity.Action.UPLOADED_LAB_RESULTS;
import static com.pkb.notification.entity.Activity.Action.UPLOADED_RADIOLOGY;
import static com.pkb.notification.entity.Activity.Action.VIEW_CONVERSATION;
import static com.pkb.notification.entity.Activity.Action.VIEW_GENETICS;
import static com.pkb.notification.entity.Activity.Action.VIEW_PHPLAN;
import static com.pkb.radiology.entity.RadiologyResult.MediaActCategory.AUDIO;
import static com.pkb.radiology.entity.RadiologyResult.MediaActCategory.IMAGING;
import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.Match;
import static io.vavr.Predicates.isIn;

<span class="nc" id="L90">public class EmailUtil {</span>

<span class="fc" id="L92">    public enum Quantity {</span>
<span class="fc" id="L93">        SINGULAR,</span>
<span class="fc" id="L94">        BULK</span>
    }

<span class="fc" id="L97">    private final static ImmutableMap&lt;Message, Message&gt; PATIENT_TO_CARER_MAP = Maps.immutableEnumMap(ImmutableMap.&lt;Message, Message&gt; builder()</span>
<span class="fc" id="L98">            .put(ACTIVITY_NOTIFICATION_TO_PATIENT_V2, ACTIVITY_NOTIFICATION_TO_CARER_FOR_PATIENT)</span>
<span class="fc" id="L99">            .put(OTHER_USER_INVITES_CARER_NOTIFY_PATIENT, OTHER_USER_INVITES_CARER_NOTIFY_CARER)</span>
<span class="fc" id="L100">            .put(NOTIFY_PATIENT_OF_CREATED_ACCOUNT, NOTIFY_CARER_OF_CREATED_PATIENT_ACCOUNT)</span>
<span class="fc" id="L101">            .put(ACCOUNT_ACTIVATION_NOTIFICATION, ACCOUNT_ACTIVATION_CARER_NOTIFICATION)</span>
<span class="fc" id="L102">            .put(NOTIFY_PATIENT_THAT_CLINICIAN_ACCEPTED_INVITATION, NOTIFY_CARER_THAT_CLINICIAN_ACCEPTED_INVITATION)</span>
<span class="fc" id="L103">            .put(NOTIFICATION_CLINICIAN_ACCEPTED_INVITATION, NOTIFY_CARER_THAT_CLINICIAN_ACCEPTED_INVITATION)</span>
<span class="fc" id="L104">            .put(CARER_ACCEPTS_INVITATION_FROM_OTHER_USER_NOTIFY_PATIENT, CARER_ACCEPTS_INVITATION_FROM_OTHER_USER_NOTIFY_CARER)</span>
<span class="fc" id="L105">            .put(TEAM_ACCESS_GRANTED_NOTIFICATION_TO_PATIENT, TEAM_ACCESS_GRANTED_NOTIFICATION_TO_CARER_FOR_PATIENT)</span>
<span class="fc" id="L106">            .put(BREAK_THE_GLASS_PATIENT_NOTIFICATION, BREAK_THE_GLASS_CARER_NOTIFICATION)</span>
<span class="fc" id="L107">            .put(INVITE_PATIENT_TO_TAKE_QUESTIONNAIRE, INVITE_CARER_TO_TAKE_QUESTIONNAIRE_FOR_PATIENT)</span>
<span class="fc" id="L108">            .put(HANDOVER_DISCUSSION_NOTIFICATION_TO_OTHER_PERSON, HANDOVER_DISCUSSION_NOTIFICATION_TO_OTHER_CARER_FOR_PATIENT)</span>
<span class="fc" id="L109">            .put(NOTIFY_PATIENT_OF_DOCUMENT_RECEIVED, NOTIFY_CARER_OF_DOCUMENT_RECEIVED_BY_PATIENT)</span>
<span class="fc" id="L110">            .put(PRIVACY_LABEL_NOTIFICATION_TO_PATIENT, PRIVACY_LABEL_NOTIFICATION_TO_CARER)</span>
<span class="fc" id="L111">            .put(REVOKE_ACCESS_NOTIFICATION_TO_PATIENT, REVOKE_ACCESS_NOTIFICATION_TO_CARER)</span>
<span class="fc" id="L112">            .put(INDIV_ACCESS_REVOKED_NOTIFICATION_TO_PATIENT, NOTIFY_CARER_ACCESS_REVOKED_FOR_PERSON)</span>
<span class="fc" id="L113">            .put(NOTIFY_PATIENT_OF_INVITATION_WITH_PRIVACY_LABELS, NOTIFY_CARER_OF_PATIENT_INVITATION_WITH_PRIVACY_LABELS)</span>
<span class="fc" id="L114">            .build());</span>

    private final static ImmutableMap&lt;MenuDataType, Tuple2&lt;String, Activity.Action&gt;&gt; TYPE_TO_STRING_AND_URL = Maps
<span class="fc" id="L117">            .immutableEnumMap(ImmutableMap.&lt;MenuDataType, Tuple2&lt;String, Activity.Action&gt;&gt; builder()</span>
<span class="fc" id="L118">                    .put(allergy, Tuple.of(&quot;an allergy&quot;, ADDED_ALLERGY))</span>
<span class="fc" id="L119">                    .put(audioResult, Tuple.of(&quot;an audio entry&quot;, UPLOADED_AUDIO))</span>
<span class="fc" id="L120">                    .put(diagnosis, Tuple.of(&quot;a diagnosis&quot;, ADDED_DIAGNOSIS))</span>
<span class="fc" id="L121">                    .put(medication, Tuple.of(&quot;a medication&quot;, ADDED_MEDICATION_RECORD))</span>
<span class="fc" id="L122">                    .put(loincTestResult, Tuple.of(&quot;a test&quot;, UPLOADED_LAB_RESULTS))</span>
<span class="fc" id="L123">                    .put(file, Tuple.of(&quot;a file&quot;, ADDED_FILE))</span>
<span class="fc" id="L124">                    .put(geneticsFile, Tuple.of(&quot;a genetics entry&quot;, VIEW_GENETICS))</span>
<span class="fc" id="L125">                    .put(diaryEntry, Tuple.of(&quot;a journal entry&quot;, ADDED_DIARY_ENTRY))</span>
<span class="fc" id="L126">                    .put(appointment, Tuple.of(&quot;an appointment&quot;, EDITED_APPOINTMENT))</span>
<span class="fc" id="L127">                    .put(libraryEntry, Tuple.of(&quot;a library entry&quot;, ADDED_LIBRARY_LINK))</span>
<span class="fc" id="L128">                    .put(message, Tuple.of(&quot;a message&quot;, VIEW_CONVERSATION))</span>
<span class="fc" id="L129">                    .put(event, Tuple.of(&quot;an event&quot;, SENT_MESSAGE))</span>
<span class="fc" id="L130">                    .put(phplan, Tuple.of(&quot;a care plan&quot;, VIEW_PHPLAN))</span>
<span class="fc" id="L131">                    .build());</span>

    private final static ImmutableMap&lt;MediaActCategory, Tuple2&lt;String, Activity.Action&gt;&gt; MEDIA_TYPE_TO_STRING_AND_URL = Maps
<span class="fc" id="L134">            .immutableEnumMap(ImmutableMap.&lt;MediaActCategory, Tuple2&lt;String, Activity.Action&gt;&gt; builder()</span>
<span class="fc" id="L135">                    .put(IMAGING, Tuple.of(&quot;an imaging report&quot;, UPLOADED_RADIOLOGY))</span>
<span class="fc" id="L136">                    .put(AUDIO, Tuple.of(&quot;an audio entry&quot;, UPLOADED_AUDIO))</span>
<span class="fc" id="L137">                    .build());</span>

<span class="fc" id="L139">    private final static ImmutableMap&lt;Activity.Action, String&gt; ACTION_TO_ALTERNATIVE_TEXT = Maps.immutableEnumMap(ImmutableMap.&lt;Activity.Action, String&gt; builder()</span>
<span class="fc" id="L140">            .put(INVITED_TO_APPOINTMENT, &quot;INVITED_TO_ATTEND_PATIENT_APPOINTMENT&quot;)</span>
<span class="fc" id="L141">            .build());</span>

    public static Optional&lt;Map&lt;String, Object&gt;&gt; getOptionalFooterProperties(Team team, Org org, RelaxedHtmlMessageFilter htmlMessageFilter) {
<span class="fc" id="L144">        Map&lt;String, Object&gt; results = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">        if (team != null) {</span>
<span class="fc" id="L146">            String plainTextFooter = team.getPatientMessageFooterText();</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">            if (StringUtils.isNotBlank(plainTextFooter)) {</span>
<span class="fc" id="L148">                results.put(PKBConstants.EMAIL_FOOTER_TEXT, plainTextFooter.trim());</span>
            }
<span class="fc bfc" id="L150" title="All 2 branches covered.">            String htmlFooter = StringUtils.isNotBlank(team.getCustomHtmlFooter()) ? team.getCustomHtmlFooter() : team.getPatientMessageFooterHTML();</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">            if (StringUtils.isNotBlank(htmlFooter)) {</span>
<span class="fc" id="L152">                results.put(PKBConstants.EMAIL_FOOTER_HTML, htmlMessageFilter.filter(htmlFooter.trim()));</span>
<span class="fc bfc" id="L153" title="All 2 branches covered.">            } else if (StringUtils.isNotBlank(plainTextFooter)) {</span>
<span class="fc" id="L154">                results.put(PKBConstants.EMAIL_FOOTER_HTML, htmlMessageFilter.filter(plainTextFooter.trim()));</span>
            }
        }
<span class="fc bfc" id="L157" title="All 2 branches covered.">        if (org != null) {</span>
<span class="fc" id="L158">            String orgPlainTextFooter = org.getEmailFooterText();</span>
<span class="fc bfc" id="L159" title="All 2 branches covered.">            if (StringUtils.isNotEmpty(orgPlainTextFooter)) {</span>
<span class="fc" id="L160">                results.put(PKBConstants.ORG_FOOTER_TEXT, orgPlainTextFooter);</span>
<span class="fc" id="L161">                results.put(PKBConstants.ORG_FOOTER_HTML, htmlMessageFilter.filter(orgPlainTextFooter));</span>
            }
<span class="fc" id="L163">            results.put(PKBConstants.ORG_FOOTER_IMAGE, UrlEscapers.urlPathSegmentEscaper().escape(StringUtils.defaultString(org.getEmailFooterImageFilename())));</span>
<span class="fc" id="L164">            results.put(PKBConstants.ORG_FOOTER_IMAGE_TEXT, StringUtils.defaultString(org.getName()));</span>
        }
<span class="fc bfc" id="L166" title="All 2 branches covered.">        return results.isEmpty() ? Optional.empty() : Optional.of(results);</span>
    }

    public static Message getCarerMessage(Message patientMessage) {
<span class="fc" id="L170">        return PATIENT_TO_CARER_MAP.getOrDefault(patientMessage, patientMessage);</span>
    }

    public static String getTypeString(MenuDataType type, IBaseDTO dto) {
<span class="fc bfc" id="L174" title="All 2 branches covered.">        if (type == radiologyResult) {</span>
<span class="fc" id="L175">            return MEDIA_TYPE_TO_STRING_AND_URL.get(((RadiologyResult) dto).getCategory())._1;</span>
        } else {
<span class="fc" id="L177">            return TYPE_TO_STRING_AND_URL.getOrDefault(type, Tuple.of(type.name(), null))._1;</span>
        }
    }

    public static String getTypeUrl(MenuDataType type, IBaseDTO dto) {
<span class="fc bfc" id="L182" title="All 2 branches covered.">        if (type == radiologyResult) {</span>
<span class="fc" id="L183">            return MEDIA_TYPE_TO_STRING_AND_URL.get(((RadiologyResult) dto).getCategory())._2.getUserQueryPath();</span>
        } else {
<span class="fc" id="L185">            return TYPE_TO_STRING_AND_URL.get(type)._2.getUserQueryPath();</span>
        }
    }

    public static String getTypeUrlParams(MenuDataType type, IBaseDTO dto) {
<span class="fc bfc" id="L190" title="All 2 branches covered.">        if (type == radiologyResult) {</span>
<span class="fc" id="L191">            return MEDIA_TYPE_TO_STRING_AND_URL.get(((RadiologyResult) dto).getCategory())._2.getUserQueryParams();</span>
        } else {
<span class="fc" id="L193">            return Match(type).of(</span>
<span class="fc" id="L194">                    Case($(phplan), () -&gt; TYPE_TO_STRING_AND_URL.get(type)._2.getUserQueryParams(dto.getId())),</span>
<span class="fc" id="L195">                    Case($(isIn(message, appointment)), () -&gt; TYPE_TO_STRING_AND_URL.get(type)._2.getUserQueryParams(dto.getBaseFields().getUniqueId())),</span>
<span class="fc" id="L196">                    Case($(), () -&gt; TYPE_TO_STRING_AND_URL.get(type)._2.getUserQueryParams())</span>
            );
        }
    }

    public static String getActionAlternativeText(Activity.Action action) {
<span class="fc" id="L202">        return ACTION_TO_ALTERNATIVE_TEXT.getOrDefault(action, action.toString());</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>