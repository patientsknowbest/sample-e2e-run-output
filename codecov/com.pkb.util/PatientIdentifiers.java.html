<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PatientIdentifiers.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.util</a> &gt; <span class="el_source">PatientIdentifiers.java</span></div><h1>PatientIdentifiers.java</h1><pre class="source lang-java linenums">package com.pkb.util;

import com.pkb.common.config.PhrConfig;
import com.pkb.datamodel.Email;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.NationalId;
import com.pkb.user.entity.OrgLevelId;
import com.pkb.user.entity.TeamLevelId;
import org.apache.commons.lang3.StringUtils;
import org.jetbrains.annotations.NotNull;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.HashSet;
import java.util.Objects;
import java.util.Set;
import java.util.UUID;

import static com.google.common.base.Preconditions.checkNotNull;

/**
 * There are several different pieces of data which can uniquely identify a medical record within PKB.
 * &lt;p&gt;
 * This class is designed to group together identifiers believed to belong to a single patient, such that they can be used to query the
 * database for that patient.
 * &lt;p&gt;
 * The Builder for this class will normalise (but not validate) the values it is provided with. The purpose of normalisation is to ensure
 * that the database is always queried in a consistent manner, to ensure that two identifiers which are semantically equivalent will always
 * be considered the same. The normalisation applied is:
 *
 * &lt;ul&gt;
 * &lt;li&gt;&lt;b&gt;Email Addresses.&lt;/b&gt; Leading and trailing whitespace removed; forced into lowercase.&lt;/li&gt;
 * &lt;li&gt;&lt;b&gt;National IDs.&lt;/b&gt; The value is replaced with the result of calling cleanInput() on the corresponding National ID Type.&lt;/li&gt;
 * &lt;li&gt;&lt;b&gt;Org and Team Level IDs.&lt;/b&gt; Leading and trailing whitespace removed.&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * @see UserManager.lookupSinglePatient()
 */
public class PatientIdentifiers {

    @Autowired
    private PhrConfig config;

    private Long pkbId;
    private Set&lt;Email&gt; emailAddresses;
    private Set&lt;NationalId&gt; nids;
    private Set&lt;OrgLevelId&gt; olids;
    private Set&lt;TeamLevelId&gt; tlids;
    private UUID publicId;
    private String emisEsPersonGuid;

    /**
     * This constructor is private to force callers to use the builder. This is to ensure that the provided identifiers are normalised
     * before being accepted.
     */
    private PatientIdentifiers() {
    }

<span class="fc" id="L58">    private PatientIdentifiers(Builder builder) {</span>
<span class="fc" id="L59">        this.pkbId = builder.pkbId;</span>
<span class="fc" id="L60">        this.emailAddresses = builder.emailAddresses;</span>
<span class="fc" id="L61">        this.nids = builder.nids;</span>
<span class="fc" id="L62">        this.olids = builder.olids;</span>
<span class="fc" id="L63">        this.tlids = builder.tlids;</span>
<span class="fc" id="L64">        this.publicId = builder.publicId;</span>
<span class="fc" id="L65">        this.emisEsPersonGuid = builder.emisEsPersonGuid;</span>
<span class="fc" id="L66">    }</span>

    public boolean isEmpty() {
<span class="pc bpc" id="L69" title="2 of 14 branches missed.">        return pkbId == null &amp;&amp; emailAddresses.isEmpty() &amp;&amp; nids.isEmpty() &amp;&amp; olids.isEmpty() &amp;&amp; tlids.isEmpty() &amp;&amp; publicId == null &amp;&amp; emisEsPersonGuid == null;</span>
    }

    public boolean hasPkbId() {
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">        return pkbId != null;</span>
    }

    public boolean hasEmailAddress() {
<span class="fc bfc" id="L77" title="All 2 branches covered.">        return !emailAddresses.isEmpty();</span>
    }

    public boolean hasNid() {
<span class="fc bfc" id="L81" title="All 2 branches covered.">        return !nids.isEmpty();</span>
    }

    public boolean hasOlid() {
<span class="fc bfc" id="L85" title="All 2 branches covered.">        return !olids.isEmpty();</span>
    }

    public boolean hasTlid() {
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">        return !tlids.isEmpty();</span>
    }

    public boolean hasPublicId() {
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">        return publicId != null;</span>
    }

    public boolean hasEmisPersonGuid() {
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">        return emisEsPersonGuid != null;</span>
    }

    @Override
    public String toString() {
<span class="nc" id="L102">        return &quot;{pkbId = &quot; + protect(String.valueOf(pkbId)) + &quot;, &quot;</span>
<span class="nc" id="L103">                + &quot;emailAddreses = {&quot; + protect(emailAddresses) + &quot;}, &quot;</span>
<span class="nc" id="L104">                + &quot;nationalIds = {&quot; + protect(nids) + &quot;}, &quot;</span>
<span class="nc" id="L105">                + &quot;orgLevelIds = {&quot; + protect(olids) + &quot;}, &quot;</span>
<span class="nc" id="L106">                + &quot;teamLevelIds = {&quot; + protect(tlids) + &quot;}, &quot;</span>
<span class="nc" id="L107">                + &quot;publicId = {&quot; + protect(String.valueOf(publicId)) + &quot;}, &quot;</span>
<span class="nc" id="L108">                + &quot;emisEsPersonGuid = {&quot; + protect(String.valueOf(emisEsPersonGuid))</span>
                + &quot;}}&quot;;
    }

    private String protect(Set&lt;?&gt; entries) {
<span class="nc" id="L113">        String string = &quot;&quot;;</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">        for (Object entry : entries) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            if (StringUtils.isEmpty(string)) {</span>
<span class="nc" id="L116">                string = protect(entry.toString());</span>
            } else {
<span class="nc" id="L118">                string += &quot;, &quot; + protect(entry.toString());</span>
            }
<span class="nc" id="L120">        }</span>
<span class="nc" id="L121">        return string;</span>
    }

    // TODO: Didn't we have some new Sensitive or Confidential class or something? Russ was talking about it I think.
    private String protect(String value) {
<span class="nc bnc" id="L126" title="All 2 branches missed.">        if (config.isDisplayOfSensitiveErrorInformationEnabled()) {</span>
<span class="nc" id="L127">            return value;</span>
        } else {
<span class="nc" id="L129">            return &quot;PROTECTED&quot;;</span>
        }
    }

    public Long getPkbId() {
<span class="fc" id="L134">        return pkbId;</span>
    }

    public Set&lt;Email&gt; getEmailAddresses() {
<span class="fc" id="L138">        return emailAddresses;</span>
    }

    public Set&lt;NationalId&gt; getNationalIds() {
<span class="fc" id="L142">        return nids;</span>
    }

    public Set&lt;OrgLevelId&gt; getOrgLeveIds() {
<span class="fc" id="L146">        return olids;</span>
    }

    public Set&lt;TeamLevelId&gt; getTeamLevelIds() {
<span class="fc" id="L150">        return tlids;</span>
    }

    public UUID getPublicId() {
<span class="fc" id="L154">        return publicId;</span>
    }

    public String getEmisEsPersonGuid() {
<span class="fc" id="L158">        return emisEsPersonGuid;</span>
    }

<span class="fc" id="L161">    public static class Builder {</span>

        private Long pkbId;
<span class="fc" id="L164">        private Set&lt;Email&gt; emailAddresses = new HashSet&lt;&gt;();</span>
<span class="fc" id="L165">        private Set&lt;NationalId&gt; nids = new HashSet&lt;&gt;();</span>
<span class="fc" id="L166">        private Set&lt;OrgLevelId&gt; olids = new HashSet&lt;&gt;();</span>
<span class="fc" id="L167">        private Set&lt;TeamLevelId&gt; tlids = new HashSet&lt;&gt;();</span>
        private UUID publicId;
        private String emisEsPersonGuid;

        public Builder withPkbId(@NotNull Long pkbId) {
<span class="nc" id="L172">            checkNotNull(pkbId, &quot;PKB ID must not be null&quot;);</span>
<span class="nc" id="L173">            this.pkbId = pkbId;</span>
<span class="nc" id="L174">            return this;</span>
        }

        public Builder withEmailAddress(@NotNull Email emailAddress) {
<span class="fc" id="L178">            checkNotNull(emailAddress, &quot;Email address must not be null&quot;);</span>
<span class="fc" id="L179">            this.emailAddresses.add(emailAddress);</span>
<span class="fc" id="L180">            return this;</span>
        }

        public Builder withNationalId(@NotNull NationalId nid) {
<span class="fc" id="L184">            checkNotNull(nid, &quot;National ID must not be null&quot;);</span>
<span class="fc" id="L185">            this.nids.add(normaliseNationalId(nid));</span>
<span class="fc" id="L186">            return this;</span>
        }

        public Builder withOrgLevelId(@NotNull OrgLevelId olid) {
<span class="fc" id="L190">            checkNotNull(olid, &quot;Org Level ID must not be null&quot;);</span>
<span class="fc" id="L191">            this.olids.add(normaliseOrgLevelId(olid));</span>
<span class="fc" id="L192">            return this;</span>
        }

        public Builder withTeamLevelId(@NotNull TeamLevelId tlid) {
<span class="nc" id="L196">            checkNotNull(tlid, &quot;Team Level ID must not be null&quot;);</span>
<span class="nc" id="L197">            this.tlids.add(normaliseTeamLevelId(tlid));</span>
<span class="nc" id="L198">            return this;</span>
        }

        public Builder withNationalIds(@NotNull Set&lt;NationalId&gt; nids) {
<span class="fc" id="L202">            checkNotNull(nids, &quot;National IDs must not be null&quot;);</span>
<span class="fc bfc" id="L203" title="All 2 branches covered.">            for (NationalId nid : nids) {</span>
<span class="fc" id="L204">                checkNotNull(nid, &quot;National ID must not be null&quot;);</span>
<span class="fc" id="L205">                this.nids.add(normaliseNationalId(nid));</span>
<span class="fc" id="L206">            }</span>
<span class="fc" id="L207">            return this;</span>
        }

        public Builder withOrgLevelIds(@NotNull Set&lt;OrgLevelId&gt; olids) {
<span class="fc" id="L211">            checkNotNull(olids, &quot;Org Level IDs must not be null&quot;);</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">            for (OrgLevelId olid : olids) {</span>
<span class="fc" id="L213">                checkNotNull(olid, &quot;Org Level ID must not be null&quot;);</span>
<span class="fc" id="L214">                this.olids.add(normaliseOrgLevelId(olid));</span>
<span class="fc" id="L215">            }</span>
<span class="fc" id="L216">            return this;</span>
        }

        public Builder withTeamLevelIds(@NotNull Set&lt;TeamLevelId&gt; tlids) {
<span class="fc" id="L220">            checkNotNull(tlids, &quot;Team Level IDs must not be null&quot;);</span>
<span class="fc bfc" id="L221" title="All 2 branches covered.">            for (TeamLevelId tlid : tlids) {</span>
<span class="fc" id="L222">                checkNotNull(tlid, &quot;Team Level ID must not be null&quot;);</span>
<span class="fc" id="L223">                this.tlids.add(normaliseTeamLevelId(tlid));</span>
<span class="fc" id="L224">            }</span>
<span class="fc" id="L225">            return this;</span>
        }

        public Builder withPublicId(@NotNull UUID publicId) {
<span class="fc" id="L229">            checkNotNull(publicId, &quot;Public ID must not be null&quot;);</span>
<span class="fc" id="L230">            this.publicId = publicId;</span>
<span class="fc" id="L231">            return this;</span>
        }

        public Builder withEmisEsPersonGuid(@NotNull String emisEsPersonGuid) {
<span class="fc" id="L235">            checkNotNull(emisEsPersonGuid, &quot;Emis Es IDs must not be null&quot;);</span>
<span class="fc" id="L236">            this.emisEsPersonGuid = emisEsPersonGuid;</span>
<span class="fc" id="L237">            return this;</span>
        }

        public PatientIdentifiers build() {
<span class="fc" id="L241">            return new PatientIdentifiers(this);</span>
        }
    }

    public static String normaliseEmailAddress(String emailAddress) {
<span class="nc" id="L246">        return StringUtils.trimToEmpty(emailAddress).toLowerCase();</span>
    }

    public static NationalId normaliseNationalId(NationalId nid) {
<span class="fc" id="L250">        nid.setValue(nid.getType().cleanInput(nid.getValue()));</span>
<span class="fc" id="L251">        return nid;</span>
    }

    public static OrgLevelId normaliseOrgLevelId(OrgLevelId olid) {
<span class="fc" id="L255">        olid.setValue(StringUtils.trimToEmpty(olid.getValue()));</span>
<span class="fc" id="L256">        return olid;</span>
    }

    public static TeamLevelId normaliseTeamLevelId(TeamLevelId tlid) {
<span class="fc" id="L260">        tlid.setValue(StringUtils.trimToEmpty(tlid.getValue()));</span>
<span class="fc" id="L261">        return tlid;</span>
    }

    @Override
    public boolean equals(Object o) {
<span class="nc bnc" id="L266" title="All 2 branches missed.">        if (this == o) {</span>
<span class="nc" id="L267">            return true;</span>
        }
<span class="nc bnc" id="L269" title="All 4 branches missed.">        if (o == null || getClass() != o.getClass()) {</span>
<span class="nc" id="L270">            return false;</span>
        }
<span class="nc" id="L272">        PatientIdentifiers that = (PatientIdentifiers) o;</span>
<span class="nc bnc" id="L273" title="All 14 branches missed.">        return Objects.equals(pkbId, that.pkbId) &amp;&amp; Objects.equals(emailAddresses, that.emailAddresses) &amp;&amp; Objects.equals(nids, that.nids) &amp;&amp; Objects.equals(olids, that.olids) &amp;&amp; Objects.equals(tlids, that.tlids) &amp;&amp; Objects.equals(publicId, that.publicId) &amp;&amp; Objects.equals(emisEsPersonGuid, that.emisEsPersonGuid);</span>
    }

    @Override
    public int hashCode() {
<span class="fc" id="L278">        return Objects.hash(pkbId, emailAddresses, nids, olids, tlids, publicId, emisEsPersonGuid);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>