<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RequestCache.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.util</a> &gt; <span class="el_source">RequestCache.java</span></div><h1>RequestCache.java</h1><pre class="source lang-java linenums">package com.pkb.util;

import org.jetbrains.annotations.Nullable;

import javax.servlet.http.HttpServletRequest;
import java.util.Objects;
import java.util.function.Function;
import java.util.function.Supplier;

public class RequestCache {

    //Request.setAttribute does not allow null values - setting null is equivalent
    //to deleting an attribute. Sometimes we need to store null explicitly. This dummy object
    //represents a null value for these cases.
<span class="fc" id="L15">    static final Object NULL_VALUE = new Object();</span>
    private Supplier&lt;HttpServletRequest&gt; requestSupplier;

<span class="fc" id="L18">    public RequestCache(Supplier&lt;HttpServletRequest&gt; requestSupplier) {</span>
<span class="fc" id="L19">        this.requestSupplier = requestSupplier;</span>
<span class="fc" id="L20">    }</span>

    public &lt;T&gt; @Nullable T get(String key, Supplier&lt;T&gt; ifAbsent) {
        //noinspection unchecked
<span class="pc bpc" id="L24" title="2 of 4 branches missed.">        return internalGet(key, ifAbsent, newVal -&gt; newVal == null ? NULL_VALUE : newVal, oldVal -&gt; oldVal == NULL_VALUE ? null : (T) oldVal);</span>
    }

    public &lt;T&gt; T getNotNull(String key, Supplier&lt;T&gt; ifAbsent) {

<span class="fc" id="L29">        return internalGet(key, ifAbsent, Objects::requireNonNull, val -&gt; {</span>
<span class="pc bpc" id="L30" title="1 of 2 branches missed.">            if (val == NULL_VALUE) {</span>
<span class="nc" id="L31">                throw new NullPointerException(key + &quot; has null value&quot;);</span>
            }
            //noinspection unchecked
<span class="fc" id="L34">            return (T) val;</span>
        });
    }

    private &lt;T&gt; T internalGet(String key, Supplier&lt;T&gt; ifAbsent, Function&lt;T, Object&gt; newValProcessor, Function&lt;Object, T&gt; oldValProcessor) {
<span class="fc" id="L39">        HttpServletRequest request = requestSupplier.get();</span>
<span class="fc" id="L40">        Object o = request.getAttribute(key);</span>
<span class="fc bfc" id="L41" title="All 2 branches covered.">        if (o == null) {</span>
<span class="fc" id="L42">            T newVal = ifAbsent.get();</span>
<span class="fc" id="L43">            request.setAttribute(key, newValProcessor.apply(newVal));</span>
<span class="fc" id="L44">            return newVal;</span>
        }

<span class="fc" id="L47">        return oldValProcessor.apply(o);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>