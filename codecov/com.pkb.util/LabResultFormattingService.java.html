<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>LabResultFormattingService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.util</a> &gt; <span class="el_source">LabResultFormattingService.java</span></div><h1>LabResultFormattingService.java</h1><pre class="source lang-java linenums">package com.pkb.util;

import com.pkb.entities.enums.UserType;
import com.pkb.test.entity.TestResultDTO;
import com.pkb.test.entity.TestResultType;
import io.vavr.control.Either;
import org.jetbrains.annotations.NotNull;

import java.text.DecimalFormat;
import java.time.Instant;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.Locale;
import java.util.Optional;
import java.util.function.Function;

import static com.google.common.base.Preconditions.checkNotNull;
import static com.pkb.util.PKBConstants.DECIMAL_FORMAT;
import static io.vavr.control.Either.right;
import static java.lang.String.format;
import static java.time.ZoneOffset.UTC;
import static java.util.Optional.empty;
import static org.apache.commons.lang3.StringUtils.EMPTY;
import static org.apache.commons.lang3.StringUtils.isNotBlank;
import static org.apache.commons.lang3.StringUtils.trimToEmpty;

public class LabResultFormattingService {
    private static final String SPACE = &quot; &quot;;

    private final DataDelayService delayService;
    private final LocalizedTextProvider textProvider;

<span class="fc" id="L33">    public LabResultFormattingService(@NotNull DataDelayService delayService, @NotNull LocalizedTextProvider textProvider) {</span>
<span class="fc" id="L34">        this.delayService = delayService;</span>
<span class="fc" id="L35">        this.textProvider = textProvider;</span>
<span class="fc" id="L36">    }</span>

    public @NotNull String formattedLabResult(@NotNull UserType userType, @NotNull TestResultDTO labResult, @NotNull TestResultType testResultType) {
<span class="nc" id="L39">        return formattedLabResult(userType, labResult, testResultType, UTC, Locale.UK, DECIMAL_FORMAT);</span>
    }

    private @NotNull String formattedLabResult(@NotNull UserType userType, @NotNull TestResultDTO labResult, @NotNull TestResultType testResultType, @NotNull ZoneId timezone,
                                               @NotNull Locale locale, @NotNull DecimalFormat decimalFormat) {
<span class="nc" id="L44">        StringBuilder resultBuilder = new StringBuilder(checkNotNull(testResultType.getName()));</span>

<span class="nc" id="L46">        String formattedValue = formattedLabResultWithoutName(userType, labResult, testResultType, timezone, locale, decimalFormat);</span>
<span class="nc bnc" id="L47" title="All 2 branches missed.">        if (isNotBlank(formattedValue)) {</span>
<span class="nc" id="L48">            resultBuilder.append(&quot;:&quot;).append(SPACE).append(formattedValue);</span>
        }

<span class="nc" id="L51">        return resultBuilder.toString();</span>
    }

    public @NotNull String formattedLabResultWithoutName(@NotNull UserType userType, @NotNull TestResultDTO labResult, @NotNull TestResultType testResultType) {
<span class="fc" id="L55">        return formattedLabResultWithoutName(userType, labResult, testResultType, UTC, Locale.UK, DECIMAL_FORMAT);</span>
    }

    @NotNull
    String formattedLabResultWithoutName(@NotNull UserType userType, @NotNull TestResultDTO labResult, @NotNull TestResultType testResultType,
                                         @NotNull ZoneId timezone, @NotNull Locale locale, DecimalFormat decimalFormat) {
<span class="fc" id="L61">        return formattedLabResultWithoutName(userType, labResult, testResultType, timezone, locale, decimalFormat, true);</span>
    }

    @NotNull
    public String formattedLabResultWithoutName(@NotNull UserType userType, @NotNull TestResultDTO labResult, @NotNull TestResultType testResultType,
                                                @NotNull ZoneId timezone, @NotNull Locale locale, DecimalFormat decimalFormat, boolean includeRange) {
<span class="fc" id="L67">        return formatValue(labResult, userType, timezone, locale, decimalFormat)</span>
<span class="fc" id="L68">                .fold(</span>
<span class="fc" id="L69">                        handleDelayedLabResult(),</span>
<span class="fc" id="L70">                        handleNonDelayedLabResult(labResult, testResultType, decimalFormat, includeRange));</span>
    }

    @NotNull
    Either&lt;String, String&gt; formatValue(@NotNull TestResultDTO result, @NotNull UserType userType) {
<span class="nc" id="L75">        return formatValue(result, userType, UTC, Locale.UK, DECIMAL_FORMAT);</span>
    }

    /**
     * Either delayed (in left) or formatted value (in right).
     */
    public @NotNull Either&lt;String, String&gt; formatValue(@NotNull TestResultDTO result, @NotNull UserType userType, @NotNull ZoneId timezone, @NotNull Locale locale,
                                                       @NotNull DecimalFormat decimalFormat) {
<span class="fc" id="L83">        Optional&lt;Instant&gt; maybeDelayedUntil = delayService.findWhenBecomesVisibleForUserType(result, userType);</span>

<span class="fc" id="L85">        return maybeDelayedUntil</span>
<span class="fc" id="L86">                .map(delayedUntil -&gt; {</span>
<span class="fc" id="L87">                    DateTimeFormatter formatter = DateTimeFormatter.ofPattern(textProvider.getText(&quot;global.format.date_full_at_time&quot;)).withZone(timezone).withLocale(locale);</span>
<span class="fc" id="L88">                    return Either.&lt;String, String&gt;left(format(&quot;%s&quot;, getDelayedResultDisplayText(formatter.format(delayedUntil))));</span>
                })
<span class="fc" id="L90">                .orElseGet(() -&gt; {</span>
                    String value;
<span class="fc bfc" id="L92" title="All 2 branches covered.">                    if (result.isValueWithComparator()) {</span>
<span class="fc" id="L93">                        value = result.getValueWithComparatorStr();</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">                    } else if (result.isValueNumeric()) {</span>
<span class="fc" id="L95">                        value = decimalFormat.format(result.getValue());</span>
                    } else {
<span class="fc" id="L97">                        value = result.getTextValue();</span>
                    }
<span class="fc" id="L99">                    return right(value);</span>
                });
    }

    private @NotNull String getDelayedResultDisplayText(String dateAsString) {
<span class="fc" id="L104">        return textProvider.getText(&quot;myTests.txt.delayed&quot;, dateAsString);</span>
    }

    public @NotNull Optional&lt;String&gt; formatUnit(@NotNull TestResultType testResultType) {
<span class="fc" id="L108">        return toNonBlankOptional(testResultType.getUnit());</span>
    }

    public @NotNull Optional&lt;String&gt; formatRange(@NotNull TestResultDTO result, @NotNull TestResultType resultType, @NotNull DecimalFormat decimalFormat) {
<span class="fc" id="L112">        StringBuilder valueBuilder = new StringBuilder();</span>

<span class="fc" id="L114">        boolean rangeSignAddedBefore = rangeSignBefore(result)</span>
<span class="fc" id="L115">                .map(rangeSign -&gt; {</span>
<span class="fc" id="L116">                    valueBuilder.append(rangeSign);</span>
<span class="fc" id="L117">                    return true;</span>
                })
<span class="fc" id="L119">                .orElse(false);</span>

<span class="fc" id="L121">        boolean lowAdded = low(result, decimalFormat)</span>
<span class="fc" id="L122">                .map(lowEnd -&gt; {</span>
<span class="fc" id="L123">                    valueBuilder</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">                            .append(rangeSignAddedBefore ? SPACE : EMPTY)</span>
<span class="fc" id="L125">                            .append(lowEnd);</span>
<span class="fc" id="L126">                    return true;</span>
                })
<span class="fc" id="L128">                .orElse(false);</span>

<span class="fc" id="L130">        boolean rangeSignAddedBetween = rangeSignInBetween(result)</span>
<span class="fc" id="L131">                .map(rangeSign -&gt; {</span>
<span class="fc" id="L132">                    valueBuilder</span>
<span class="pc bpc" id="L133" title="1 of 2 branches missed.">                            .append(lowAdded ? SPACE : EMPTY)</span>
<span class="fc" id="L134">                            .append(rangeSign);</span>
<span class="fc" id="L135">                    return true;</span>
                })
<span class="fc" id="L137">                .orElse(false);</span>

<span class="pc bpc" id="L139" title="1 of 4 branches missed.">        boolean rangeSignAdded = rangeSignAddedBefore || rangeSignAddedBetween;</span>

<span class="fc" id="L141">        boolean highAdded = high(result, decimalFormat)</span>
<span class="fc" id="L142">                .map(highEnd -&gt; {</span>
<span class="fc" id="L143">                    valueBuilder</span>
<span class="pc bpc" id="L144" title="3 of 4 branches missed.">                            .append(rangeSignAdded || lowAdded ? SPACE : EMPTY)</span>
<span class="fc" id="L145">                            .append(highEnd);</span>
<span class="fc" id="L146">                    return true;</span>
                })
<span class="fc" id="L148">                .orElse(false);</span>

<span class="fc" id="L150">        formatUnit(resultType)</span>
<span class="fc" id="L151">                .ifPresent(unit -&gt; valueBuilder</span>
<span class="pc bpc" id="L152" title="5 of 6 branches missed.">                        .append(rangeSignAdded || lowAdded || highAdded ? SPACE : EMPTY)</span>
<span class="fc" id="L153">                        .append(unit));</span>

<span class="fc" id="L155">        return toNonBlankOptional(valueBuilder.toString());</span>
    }

    private Optional&lt;String&gt; rangeSignBefore(TestResultDTO result) {
<span class="fc" id="L159">        String rangeSign = trimToEmpty(result.getRangeSign());</span>

<span class="fc bfc" id="L161" title="All 2 branches covered.">        if (result.isRangeSignBefore()) {</span>
<span class="pc bpc" id="L162" title="1 of 2 branches missed.">            if (isNotBlank(rangeSign)) {</span>
<span class="fc" id="L163">                return Optional.of(rangeSign);</span>
            }
        }

<span class="fc" id="L167">        return empty();</span>
    }

    private Optional&lt;String&gt; low(@NotNull TestResultDTO result, @NotNull DecimalFormat decimalFormat) {
<span class="fc bfc" id="L171" title="All 2 branches covered.">        if (result.getRangeLow() != null) {</span>
<span class="fc" id="L172">            return Optional.of(decimalFormat.format(result.getRangeLow()));</span>
        }
<span class="fc" id="L174">        return empty();</span>
    }

    private Optional&lt;String&gt; rangeSignInBetween(@NotNull TestResultDTO result) {
<span class="fc" id="L178">        String rangeSign = trimToEmpty(result.getRangeSign());</span>

<span class="fc bfc" id="L180" title="All 2 branches covered.">        if (!result.isRangeSignBefore()) {</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">            if (isNotBlank(rangeSign)) {</span>
<span class="fc" id="L182">                return Optional.of(rangeSign);</span>
            }
        }

<span class="fc" id="L186">        return empty();</span>
    }

    private Optional&lt;String&gt; high(@NotNull TestResultDTO result, @NotNull DecimalFormat decimalFormat) {
<span class="fc bfc" id="L190" title="All 2 branches covered.">        if (result.getRangeHigh() != null) {</span>
<span class="fc" id="L191">            return Optional.of(decimalFormat.format(result.getRangeHigh()));</span>
        }
<span class="fc" id="L193">        return empty();</span>
    }

    private Function&lt;String, String&gt; handleDelayedLabResult() {
<span class="fc" id="L197">        return delayedValue -&gt; format(&quot;%s&quot;, delayedValue);</span>
    }

    private Function&lt;String, String&gt; handleNonDelayedLabResult(TestResultDTO labResult,
                                                               TestResultType testResultType,
                                                               DecimalFormat decimalFormat,
                                                               boolean includeRange) {
<span class="fc" id="L204">        return value -&gt; {</span>
<span class="fc" id="L205">            StringBuilder valueBuilder = new StringBuilder();</span>

<span class="fc" id="L207">            boolean valueAdded = isNotBlank(value);</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">            if (valueAdded) {</span>
<span class="fc" id="L209">                valueBuilder.append(value);</span>
            }

<span class="fc" id="L212">            boolean unitAdded = formatUnit(testResultType)</span>
<span class="fc" id="L213">                    .map(unit -&gt; {</span>
<span class="fc" id="L214">                        valueBuilder</span>
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">                                .append(valueAdded ? SPACE : EMPTY)</span>
<span class="fc" id="L216">                                .append(unit);</span>
<span class="fc" id="L217">                        return true;</span>
                    })
<span class="fc" id="L219">                    .orElse(false);</span>

<span class="fc bfc" id="L221" title="All 4 branches covered.">            if (valueAdded &amp;&amp; includeRange) {</span>
<span class="fc" id="L222">                getDisplayableRange(labResult, testResultType, decimalFormat)</span>
<span class="pc bpc" id="L223" title="3 of 4 branches missed.">                        .ifPresent(range -&gt; valueBuilder.append(valueAdded || unitAdded ? SPACE : EMPTY)</span>
<span class="fc" id="L224">                                .append(&quot;(&quot;)</span>
<span class="fc" id="L225">                                .append(range)</span>
<span class="fc" id="L226">                                .append(&quot;)&quot;));</span>
            }
<span class="fc" id="L228">            return valueBuilder.toString();</span>
        };
    }

    private Optional&lt;String&gt; getDisplayableRange(@NotNull TestResultDTO result, @NotNull TestResultType resultType, @NotNull DecimalFormat decimalFormat) {
<span class="fc bfc" id="L233" title="All 2 branches covered.">        if (result.isNumericRangeProvided()) {</span>
<span class="fc" id="L234">            return formatRange(result, resultType, decimalFormat);</span>
<span class="pc bpc" id="L235" title="1 of 2 branches missed.">        } else if (result.isTextualRangeProvided()) {</span>
<span class="nc" id="L236">            return Optional.of(result.getTextRange());</span>
        } else {
<span class="fc" id="L238">            return Optional.empty();</span>
        }
    }

    private Optional&lt;String&gt; toNonBlankOptional(String value) {
<span class="fc" id="L243">        String trimmedValue = trimToEmpty(value);</span>
<span class="fc bfc" id="L244" title="All 2 branches covered.">        return isNotBlank(trimmedValue) ? Optional.of(trimmedValue) : empty();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>