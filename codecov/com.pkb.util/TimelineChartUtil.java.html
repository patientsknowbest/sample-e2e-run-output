<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TimelineChartUtil.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.util</a> &gt; <span class="el_source">TimelineChartUtil.java</span></div><h1>TimelineChartUtil.java</h1><pre class="source lang-java linenums">//---------------------------------------------------------------------------
//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: SymptomUtil.java Feb 21, 2013 5:29:12 PM pravinam$
//
//---------------------------------------------------------------------------
package com.pkb.util;

import com.google.common.collect.ImmutableMap;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.symptom.entity.SymptomReportHistoryDTO;
import com.pkb.symptom.entity.SymptomSeverity;
import org.apache.commons.lang3.StringUtils;
import org.immutables.value.Value.Immutable;
import org.jetbrains.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.ZoneId;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.GregorianCalendar;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Optional;

import static com.pkb.util.TimelineChartUtil.RangeDetails.Range.ONE_MONTH;
import static com.pkb.util.TimelineChartUtil.RangeDetails.Range.SIX_MONTHS;
import static com.pkb.util.TimelineChartUtil.RangeDetails.Range.TWO_MONTHS;
import static java.time.temporal.ChronoUnit.DAYS;

public class TimelineChartUtil {
<span class="fc" id="L38">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private final DateTimeService dateTimeService;
    private final DateUtil dateUtil;

<span class="fc" id="L43">    public TimelineChartUtil(DateTimeService dateTimeService, DateUtil dateUtil) {</span>
<span class="fc" id="L44">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L45">        this.dateUtil = dateUtil;</span>
<span class="fc" id="L46">    }</span>

<span class="fc" id="L48">    public enum Period {</span>
<span class="fc" id="L49">        MONTH, SIXMONTHS, YEAR</span>
    }

    @Immutable
<span class="fc" id="L53">    public static abstract class RangeDetails {</span>

<span class="fc" id="L55">        public enum Range {</span>
<span class="fc" id="L56">            ONE_MONTH(&quot;1m&quot;),</span>
<span class="fc" id="L57">            TWO_MONTHS(&quot;2m&quot;),</span>
<span class="fc" id="L58">            SIX_MONTHS(&quot;6m&quot;),</span>
<span class="fc" id="L59">            NEWER(&quot;newer&quot;),</span>
<span class="fc" id="L60">            OLDER(&quot;older&quot;);</span>

            private static final Map&lt;String, Range&gt; NAME_TO_ENUM;
            private static final Map&lt;String, String&gt; SHORT_NAME_TO_KEY;
            private final String shortName;

<span class="fc" id="L66">            Range(String shortName) {</span>
<span class="fc" id="L67">                this.shortName = shortName;</span>
<span class="fc" id="L68">            }</span>

            static {
<span class="fc" id="L71">                NAME_TO_ENUM = new HashMap&lt;&gt;();</span>
<span class="fc" id="L72">                SHORT_NAME_TO_KEY = new HashMap&lt;&gt;();</span>
<span class="fc" id="L73">                Arrays.stream(Range.values()).forEach(value -&gt; {</span>
<span class="fc" id="L74">                    NAME_TO_ENUM.put(value.getShortName(), value);</span>
<span class="fc" id="L75">                    SHORT_NAME_TO_KEY.put(value.getShortName(), &quot;viewPlan.txt.&quot; + value.getShortName());</span>
<span class="fc" id="L76">                });</span>
<span class="fc" id="L77">            }</span>

            public String getShortName() {
<span class="fc" id="L80">                return shortName;</span>
            }

            public static Optional&lt;Range&gt; findByName(String name) {
<span class="fc" id="L84">                return Optional.ofNullable(NAME_TO_ENUM.get(name));</span>
            }

            public static Optional&lt;String&gt; findKeyByName(String name) {
<span class="fc" id="L88">                return Optional.ofNullable(SHORT_NAME_TO_KEY.get(name));</span>
            }
        }

        public abstract Range getRange();

        public abstract Period getPeriod();

        public abstract @Nullable Integer getPeriodsToDisplay();

        public abstract @Nullable Integer getPeriodsBack();

        public static RangeDetails base() {
<span class="fc" id="L101">            return of(SIX_MONTHS, Period.SIXMONTHS, 1, 0);</span>
        }

        static RangeDetails of(Range range, Period period, Integer periodsToDisplay, Integer periodsBack) {
<span class="fc" id="L105">            return ImmutableRangeDetails.builder()</span>
<span class="fc" id="L106">                    .range(range)</span>
<span class="fc" id="L107">                    .period(period)</span>
<span class="fc" id="L108">                    .periodsToDisplay(periodsToDisplay)</span>
<span class="fc" id="L109">                    .periodsBack(periodsBack)</span>
<span class="fc" id="L110">                    .build();</span>
        }

        public RangeDetails update(@Nullable String rangeWanted) {
            try {
<span class="fc bfc" id="L115" title="All 2 branches covered.">                if (StringUtils.isNotEmpty(rangeWanted)) {</span>
<span class="fc" id="L116">                    Range range = Range.findByName(rangeWanted)</span>
<span class="pc" id="L117">                            .orElseThrow(() -&gt; new RuntimeException(&quot;Invalid RangeWanted value [&quot; + rangeWanted + &quot;]&quot;));</span>
<span class="pc bpc" id="L118" title="2 of 6 branches missed.">                    switch (range) {</span>
                        case SIX_MONTHS:
<span class="nc" id="L120">                            return base();</span>
                        case TWO_MONTHS:
<span class="fc" id="L122">                            return of(range, Period.MONTH, 2, 0);</span>
                        case ONE_MONTH:
<span class="fc" id="L124">                            return of(range, Period.MONTH, 1, 0);</span>
                        case NEWER:
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">                            if (getPeriodsBack() == null) {</span>
<span class="nc" id="L127">                                return of(getRange(), getPeriod(), getPeriodsToDisplay(), 0);</span>
                            }
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">                            if (getPeriodsBack() &gt; 0) {</span>
<span class="nc" id="L130">                                return of(getRange(), getPeriod(), getPeriodsToDisplay(), getPeriodsBack() - 1);</span>
                            }
<span class="fc" id="L132">                            return of(getRange(), getPeriod(), getPeriodsToDisplay(), getPeriodsBack());</span>
                        case OLDER:
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">                            if (getPeriodsBack() == null) {</span>
<span class="nc" id="L135">                                return of(getRange(), getPeriod(), getPeriodsToDisplay(), 1);</span>
                            }
<span class="fc" id="L137">                            return of(getRange(), getPeriod(), getPeriodsToDisplay(), getPeriodsBack() + 1);</span>
                    }
                }
<span class="nc" id="L140">            } catch (Exception t) {</span>
<span class="nc" id="L141">                LOGGER.error(&quot;Error getting RangeDetails for timeline&quot;, t);</span>
<span class="fc" id="L142">            }</span>
<span class="fc" id="L143">            return base();</span>
        }

        public boolean isOneMonth() {
<span class="fc bfc" id="L147" title="All 2 branches covered.">            return getRange() == ONE_MONTH;</span>
        }

        public boolean isTwoMonths() {
<span class="fc bfc" id="L151" title="All 2 branches covered.">            return getRange() == TWO_MONTHS;</span>
        }

        public boolean isSixMonths() {
<span class="fc bfc" id="L155" title="All 2 branches covered.">            return getRange() == SIX_MONTHS;</span>
        }

        public boolean isToday() {
<span class="fc bfc" id="L159" title="All 2 branches covered.">            return getPeriodsBack() &gt; 0;</span>
        }
    }

    public List&lt;ChartHeading&gt; populateChartHeadings(Calendar firstDayOfRange, Calendar lastDayOfRange,
            RangeDetails.Range range,
            Locale locale,
            boolean includeEmptyCells/*remove once all callers are updated!*/) {
<span class="fc" id="L167">        List&lt;ChartHeading&gt; chartHeadings = new LinkedList&lt;&gt;();</span>

<span class="fc" id="L169">        Calendar day = new GregorianCalendar();</span>
<span class="fc" id="L170">        day.setTime(firstDayOfRange.getTime());</span>
<span class="fc" id="L171">        day.setTimeZone(firstDayOfRange.getTimeZone());</span>

<span class="fc bfc" id="L173" title="All 2 branches covered.">        while (day.compareTo(lastDayOfRange) &lt;= 0) {</span>
<span class="fc" id="L174">            ChartHeading chartHeading = populateChartHeading(day, range, locale);</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">            if (chartHeading != null) {</span>
<span class="fc" id="L176">                chartHeadings.add(chartHeading);</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">            } else if (includeEmptyCells) {</span>
<span class="fc" id="L178">                chartHeadings.add(ImmutableChartHeading.builder().build());</span>
            }

<span class="fc" id="L181">            day.add(Calendar.DAY_OF_YEAR, 1);</span>
<span class="fc" id="L182">        }</span>

<span class="fc" id="L184">        return chartHeadings;</span>
    }

    private ChartHeading populateChartHeading(Calendar day, RangeDetails.Range range, Locale locale) {
<span class="fc" id="L188">        ImmutableChartHeading.Builder chartHeadingBuilder = ImmutableChartHeading.builder();</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">        if (range == ONE_MONTH) {</span>
            // label Mondays
<span class="fc bfc" id="L191" title="All 2 branches covered.">            if (day.get(Calendar.DAY_OF_WEEK) == Calendar.MONDAY) {</span>
<span class="fc" id="L192">                chartHeadingBuilder.label(dateUtil.getPKBFormattedDate(day.getTime().toInstant(), locale, null));</span>
            } else {
<span class="fc" id="L194">                return null;</span>
            }
        } else {
            // label 1st of each month
<span class="fc bfc" id="L198" title="All 2 branches covered.">            if (day.get(Calendar.DAY_OF_MONTH) == 1) {</span>
<span class="fc" id="L199">                chartHeadingBuilder.label(dateUtil.getPKBFormattedMonth(day.getTime(), locale, null));</span>
            } else {
<span class="fc" id="L201">                return null;</span>
            }
        }
<span class="fc" id="L204">        return chartHeadingBuilder.build();</span>
    }

    public List&lt;ChartRow&lt;ChartCell&gt;&gt; populateSymptomRows(Calendar firstDayOfRange, Calendar lastDayOfRange,
            RangeDetails.Range range,
            List&lt;SymptomReportHistoryDTO&gt; symptomHistoryList, Locale locale, ZoneId zoneId) {

<span class="fc" id="L211">        List&lt;ChartRow&lt;ChartCell&gt;&gt; chartRows = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L213" title="All 2 branches covered.">        for (SymptomReportHistoryDTO symptomHistory : symptomHistoryList) {</span>
<span class="fc" id="L214">            ChartRow&lt;ChartCell&gt; chartRow = new ChartRow&lt;&gt;();</span>
<span class="fc" id="L215">            chartRow.setLabel(symptomHistory.getSymptom().getName());</span>

<span class="fc" id="L217">            List&lt;ChartCell&gt; severityNames = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L219">            Calendar day = new GregorianCalendar(firstDayOfRange.getTimeZone());</span>
<span class="fc" id="L220">            day.setTime(firstDayOfRange.getTime());</span>

<span class="fc bfc" id="L222" title="All 2 branches covered.">            int dayIncrement = range == ONE_MONTH ? 1 : 7;</span>

<span class="fc bfc" id="L224" title="All 2 branches covered.">            for (; day.compareTo(lastDayOfRange) &lt;= 0; day.add(Calendar.DATE, dayIncrement)) {</span>
<span class="fc" id="L225">                severityNames.add(getSeverityForDateRange(symptomHistory, day, dayIncrement, locale, zoneId));</span>
            }

<span class="fc" id="L228">            chartRow.setValues(severityNames);</span>
<span class="fc" id="L229">            chartRows.add(chartRow);</span>
<span class="fc" id="L230">        }</span>
<span class="fc" id="L231">        return chartRows;</span>
    }

    private ChartCell getSeverityForDateRange(SymptomReportHistoryDTO symptomHistory, Calendar startDate,
            int daysInRange,
            Locale locale, ZoneId localZone) {

<span class="fc" id="L238">        SymptomSeverity severity = symptomHistory.getSeverityForDateRange(startDate, daysInRange, localZone);</span>
        // If there is no info, then put a placeholder for the day
        // so the frontend knows that this needs to be skipped
        // ... not pretty.
<span class="fc bfc" id="L242" title="All 2 branches covered.">        if (severity == null) {</span>
<span class="fc" id="L243">            return ChartCell.base();</span>
        } else {
<span class="fc" id="L245">            startDate.getTime();</span>
<span class="fc" id="L246">            String label = dateUtil.getPKBFormattedDate(startDate.getTime().toInstant(), locale, null);</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">            if (daysInRange &gt; 1) {</span>
<span class="fc" id="L248">                Calendar throughDate = (Calendar) startDate.clone();</span>
<span class="fc" id="L249">                throughDate.add(Calendar.DATE, daysInRange - 1);</span>
<span class="fc" id="L250">                throughDate.getTime();</span>
<span class="fc" id="L251">                label += &quot; - &quot; + dateUtil.getPKBFormattedDate(throughDate.getTime().toInstant(), locale, null);</span>
            }
<span class="fc" id="L253">            String text = symptomHistory.getSymptom().getSeverityText(severity.getNumber0to3());</span>
<span class="fc" id="L254">            return ChartCell.of(label, severity.getNumber0to3(), text);</span>
        }
    }

    @Immutable
<span class="fc" id="L259">    public static abstract class ChartCell {</span>

<span class="fc" id="L261">        private final Map&lt;Integer, String&gt; SEVERITY_TO_INTENSITY = ImmutableMap.of(</span>
<span class="fc" id="L262">                0, &quot;none&quot;,</span>
<span class="fc" id="L263">                1, &quot;mild&quot;,</span>
<span class="fc" id="L264">                2, &quot;moderate&quot;,</span>
<span class="fc" id="L265">                3, &quot;severe&quot;);</span>

        public static ChartCell base() {
<span class="fc" id="L268">            return ChartCell.of(&quot;Null&quot;, null, &quot;&quot;);</span>
        }

        public static ChartCell of(String name, Integer severity0to3, String text) {
<span class="fc" id="L272">            return ImmutableChartCell.builder()</span>
<span class="fc" id="L273">                    .name(name)</span>
<span class="fc" id="L274">                    .severity0to3(severity0to3)</span>
<span class="fc" id="L275">                    .text(text)</span>
<span class="fc" id="L276">                    .build();</span>
        }

        public abstract String getName();

        public abstract @Nullable Integer getSeverity0to3();

        public abstract String getText();

        public boolean isNameNull() {
<span class="fc" id="L286">            return getName().equals(&quot;Null&quot;);</span>
        }

        public String getIntensity() {
<span class="fc bfc" id="L290" title="All 2 branches covered.">            return isNameNull() ? &quot;empty&quot; : SEVERITY_TO_INTENSITY.get(getSeverity0to3());</span>
        }

    }

    public Calendar getFirstDayOfRange(Period period, int periodsToDisplay, Calendar lastDayOfRange) {
        // initial value: today with 00:00 time
<span class="fc" id="L297">        Calendar firstDayOfRange = new GregorianCalendar();</span>
<span class="fc" id="L298">        firstDayOfRange.setTime(lastDayOfRange.getTime());</span>
<span class="fc" id="L299">        firstDayOfRange.setTimeZone(lastDayOfRange.getTimeZone());</span>

<span class="pc bpc" id="L301" title="2 of 4 branches missed.">        switch (period) {</span>
        case MONTH:
<span class="fc" id="L303">            firstDayOfRange.add(Calendar.MONTH, -periodsToDisplay);</span>
<span class="fc" id="L304">            break;</span>
        case SIXMONTHS:
<span class="fc" id="L306">            firstDayOfRange.add(Calendar.MONTH, -periodsToDisplay * 6);</span>
<span class="fc" id="L307">            break;</span>
        case YEAR:
<span class="nc" id="L309">            firstDayOfRange.add(Calendar.YEAR, -periodsToDisplay);</span>
            break;
        }
<span class="fc" id="L312">        return firstDayOfRange;</span>
    }

    public Calendar getLastDayOfRange(Period period,
            int movePeriodsBack, boolean alignWithToday) {
        // initial value: today with 00:00 time
<span class="fc" id="L318">        Calendar lastDayOfRange = GregorianCalendar.from(dateTimeService.nowZonedDateTime().truncatedTo(DAYS));</span>
<span class="pc bpc" id="L319" title="2 of 4 branches missed.">        switch (period) {</span>
        case MONTH:

<span class="pc bpc" id="L322" title="2 of 4 branches missed.">            if (alignWithToday &amp;&amp; (movePeriodsBack == 0)) {</span>
<span class="fc" id="L323">                lastDayOfRange.add(Calendar.DAY_OF_YEAR, 1); // if the end date should be today (0 periods back to reach this end date) then nudge</span>
<span class="nc bnc" id="L324" title="All 2 branches missed.">            } else if (!alignWithToday) {</span>
<span class="nc" id="L325">                lastDayOfRange.set(Calendar.DAY_OF_MONTH, lastDayOfRange.getActualMaximum(Calendar.DAY_OF_MONTH));</span>
            }

<span class="fc" id="L328">            lastDayOfRange.add(Calendar.MONTH, -1 * movePeriodsBack);</span>
<span class="fc" id="L329">            break;</span>
        case SIXMONTHS:

<span class="pc bpc" id="L332" title="2 of 4 branches missed.">            if (alignWithToday &amp;&amp; (movePeriodsBack == 0)) {</span>
<span class="fc" id="L333">                lastDayOfRange.add(Calendar.DAY_OF_YEAR, 1); // see above</span>
<span class="nc bnc" id="L334" title="All 2 branches missed.">            } else if (!alignWithToday) {</span>
<span class="nc" id="L335">                lastDayOfRange.set(Calendar.DAY_OF_MONTH,</span>
<span class="nc" id="L336">                        lastDayOfRange.getActualMaximum(Calendar.DAY_OF_MONTH));</span>
            }

<span class="fc" id="L339">            lastDayOfRange.add(Calendar.MONTH, movePeriodsBack * -6);</span>
<span class="fc" id="L340">            break;</span>
        case YEAR:
            // don't support aligning with today
<span class="nc" id="L343">            lastDayOfRange.set(Calendar.DAY_OF_YEAR,</span>
<span class="nc" id="L344">                    lastDayOfRange.getActualMaximum(Calendar.DAY_OF_YEAR));</span>

<span class="nc" id="L346">            lastDayOfRange.add(Calendar.YEAR, movePeriodsBack * -1);</span>
            break;
        }

<span class="fc" id="L350">        return lastDayOfRange;</span>
    }

    public Calendar getFirstDayOfRange(int field, int year, int month) {
<span class="nc" id="L354">        Calendar firstDayOfRange = GregorianCalendar.from(dateTimeService.nowZonedDateTime().truncatedTo(DAYS));</span>
<span class="nc" id="L355">        firstDayOfRange.set(Calendar.DAY_OF_MONTH, firstDayOfRange.getActualMinimum(Calendar.DAY_OF_MONTH));</span>

<span class="nc bnc" id="L357" title="All 2 branches missed.">        if (year != 0) {</span>
<span class="nc" id="L358">            firstDayOfRange.set(Calendar.YEAR, year);</span>
<span class="nc" id="L359">            firstDayOfRange.set(Calendar.MONTH, month);</span>
        }
<span class="nc" id="L361">        return firstDayOfRange;</span>
    }

    public Calendar getLastDayOfRange(int field, int span, Calendar firstDayOfRange) {
<span class="nc" id="L365">        Calendar lastDayOfRange = new GregorianCalendar();</span>
<span class="nc" id="L366">        lastDayOfRange.setTime(firstDayOfRange.getTime());</span>
<span class="nc" id="L367">        lastDayOfRange.setTimeZone(firstDayOfRange.getTimeZone());</span>
<span class="nc" id="L368">        lastDayOfRange.add(field, span);</span>
<span class="nc" id="L369">        lastDayOfRange.set(Calendar.DAY_OF_MONTH, lastDayOfRange.getActualMaximum(Calendar.DAY_OF_MONTH));</span>
<span class="nc" id="L370">        return lastDayOfRange;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>