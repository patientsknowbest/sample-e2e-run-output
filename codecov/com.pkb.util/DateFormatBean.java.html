<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DateFormatBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.util</a> &gt; <span class="el_source">DateFormatBean.java</span></div><h1>DateFormatBean.java</h1><pre class="source lang-java linenums">package com.pkb.util;

import com.google.common.annotations.VisibleForTesting;
import com.opensymphony.xwork2.LocaleProvider;
import com.opensymphony.xwork2.LocaleProviderFactory;
import com.opensymphony.xwork2.TextProvider;
import com.opensymphony.xwork2.TextProviderFactory;
import com.opensymphony.xwork2.inject.Inject;
import com.pkb.common.datetime.DateTimeService;
import org.apache.commons.lang3.NotImplementedException;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;

import java.time.Instant;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.time.temporal.TemporalAccessor;
import java.util.Date;
import java.util.Locale;
import java.util.Optional;
import java.util.function.Function;

/**
 * JavaBean format for easier using in JSPs
 *
 * @author robwhelan
 * @author ksykula
 */
<span class="fc" id="L32">public class DateFormatBean {</span>

    private Date date;

    private TemporalAccessor temporalAccessor;

    private TextProvider textProvider;

    private LocaleProvider localeProvider;

    private LoggedInUserUtil loggedInUserUtil;

    private DateTimeService dateTimeService;

    private DateUtil dateUtil;

    @Inject
    private void setTextProviderFactory(TextProviderFactory textProviderFactory) {
<span class="fc" id="L50">        this.textProvider = textProviderFactory.createInstance(getClass());</span>
<span class="fc" id="L51">    }</span>

    @Inject
    protected void setLocaleProvider(LocaleProviderFactory factory) {
<span class="fc" id="L55">        this.localeProvider = factory.createLocaleProvider();</span>
<span class="fc" id="L56">    }</span>

    @Autowired
    public void setDateUtil(DateUtil dateUtil) {
<span class="fc" id="L60">        this.dateUtil = dateUtil;</span>
<span class="fc" id="L61">    }</span>

    @Autowired
    public void setLoggedInUserUtil(LoggedInUserUtil loggedInUserUtil) {
<span class="fc" id="L65">        this.loggedInUserUtil = loggedInUserUtil;</span>
<span class="fc" id="L66">    }</span>

    @Autowired
    public void setDateTimeService(DateTimeService dateTimeService) {
<span class="fc" id="L70">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L71">    }</span>

    protected TextProvider getTextProvider() {
<span class="nc" id="L74">        return textProvider;</span>
    }

    protected LocaleProvider getLocaleProvider() {
<span class="nc" id="L78">        return localeProvider;</span>
    }

    @VisibleForTesting
    void setLocaleProvider(LocaleProvider localeProvider) {
<span class="nc" id="L83">        this.localeProvider = localeProvider;</span>
<span class="nc" id="L84">    }</span>

    @VisibleForTesting
    void setTextProvider(TextProvider textProvider) {
<span class="nc" id="L88">        this.textProvider = textProvider;</span>
<span class="nc" id="L89">    }</span>

    private String getText(String aTextName) {
<span class="fc" id="L92">        return textProvider.getText(aTextName);</span>
    }

    private Locale getLocale() {
<span class="fc" id="L96">        return localeProvider.getLocale();</span>
    }

    // Date and Time

    public String getDateTimeMessage() {
<span class="fc" id="L102">        return getFormattedDateTime(getText(&quot;global.format.date_and_time_message&quot;));</span>
    }

    public String getDateTimeSimple() {
<span class="fc" id="L106">        return getFormattedDateTime(getText(&quot;global.format.date_and_time_output&quot;));</span>
    }

    public String getDateTimeWithSlash() {
<span class="nc" id="L110">        return getFormattedDateTime(getText(&quot;global.format.date_and_time_output_slashed&quot;));</span>
    }

    public String getDateTimeFull() {
<span class="fc" id="L114">        return getFormattedDateTime(getText(&quot;global.format.date_and_timestamp_output&quot;));</span>
    }

    public String getDateFullAtTime() {
<span class="fc" id="L118">        return getFormattedDateTime(getText(&quot;global.format.date_full_at_time&quot;));</span>
    }

    public String getDateFullWithDay() {
<span class="fc" id="L122">        return getFormattedDateTime(getText(&quot;global.format.date_full_with_day&quot;));</span>
    }

    public String getTimeAmPm() {
<span class="fc" id="L126">        return getFormattedDateTime(getText(&quot;global.format.time_ampm&quot;)).toLowerCase(localeProvider.getLocale());</span>
    }

    public String getNhsTimeAmPm() {
<span class="fc" id="L130">        return dateUtil.nhsFormattedTimestamp(getFormattedDateTime(getText(&quot;global.format.time_ampm_nhs&quot;)).toLowerCase(localeProvider.getLocale()));</span>
    }

    public String getDateIso() {
        // Do not i18n
<span class="nc" id="L135">        return getFormattedTimestamp(DateTimeFormatter.ISO_INSTANT::format);</span>
    }

    // Just Time

    public String getTimeHourMin() {
<span class="fc" id="L141">        return getFormattedDateTime(getText(&quot;global.format.time_output&quot;));</span>
    }

    // Just Date

    public String getDateSimple() {
<span class="fc" id="L147">        return getFormattedDateTime(&quot;dd MMM yy&quot;);</span>
    }

    public String getDateSimpleFullYear() {
<span class="fc" id="L151">        return getFormattedDateTime(&quot;dd MMM yyyy&quot;);</span>
    }

    public String getDateNoYear() {
<span class="nc" id="L155">        return getFormattedDateTime(&quot;dd MMM&quot;);</span>
    }

    public String getMonthYear() {
<span class="nc" id="L159">        return dateUtil.getPKBFormattedMonth(date, getLocale(), getActualZoneId());</span>
    }

    public String getDateFileSuffix() {
<span class="fc" id="L163">        return getFormattedDateTime(&quot;_yyyy-MM-dd&quot;);</span>
    }

    public String getDateInvitation() {
<span class="fc" id="L167">        return getFormattedDateTime(getText(&quot;global.format.date_output&quot;));</span>
    }

    public String getExtendedFullDayAndTime() {
<span class="fc" id="L171">        return getFormattedDateTime(getText(&quot;global.format.date_full_with_day_and_time&quot;));</span>
    }

    public String getExtendedFullDayAnd12HourTime() {
<span class="fc" id="L175">        return getFormattedDateTimeWithUkEnglishPreference(getText(&quot;global.format.date_full_with_day_and_time_twelve_hr&quot;));</span>
    }

    public String getNhsExtendedFullDayAnd12HourTime() {
<span class="fc" id="L179">        return dateUtil.nhsFormattedTimestamp(getFormattedDateTimeWithUkEnglishPreference(getText(&quot;global.format.date_full_with_day_and_time_twelve_hr_nhs&quot;)));</span>
    }

    public String getRelativeDateTime() {
<span class="fc" id="L183">        ZoneId actualZoneId = getActualZoneId();</span>
<span class="fc" id="L184">        Instant createdDate = null;</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">        if (date != null) {</span>
<span class="fc" id="L186">            createdDate = date.toInstant();</span>
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">        } else if (temporalAccessor != null) {</span>
<span class="fc" id="L188">            createdDate = getInstantFromTemporalAccessor(temporalAccessor, actualZoneId);</span>
        }
<span class="fc" id="L190">        return dateUtil.getFormattedDateTime(dateTimeService.now(), createdDate, getLocale(), actualZoneId);</span>
    }

    public String getDateNatural() {
<span class="fc" id="L194">        ZoneId actualZoneId = getActualZoneId();</span>
<span class="fc" id="L195">        Instant createdDate = null;</span>
<span class="fc bfc" id="L196" title="All 2 branches covered.">        if (date != null) {</span>
<span class="fc" id="L197">            createdDate = date.toInstant();</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">        } else if (temporalAccessor != null) {</span>
<span class="fc" id="L199">            createdDate = getInstantFromTemporalAccessor(temporalAccessor, actualZoneId);</span>
        }
<span class="fc" id="L201">        return dateUtil.getPKBFormattedDate(createdDate, getLocale(), getText(&quot;global.format.date_output&quot;),</span>
                actualZoneId);
    }

    private ZoneId getActualZoneId() {
<span class="fc" id="L206">        ZoneId loggedInZoneId = loggedInUserUtil.getLoggedInUserZoneId();</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">        return loggedInZoneId == null ? Constants.APPLICATION_TZ : loggedInZoneId;</span>
    }

    private Instant getInstantFromTemporalAccessor(TemporalAccessor input, ZoneId zoneId) {
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">        if (input == null) {</span>
<span class="nc" id="L212">            return null;</span>
        }
<span class="fc" id="L214">        Class&lt;?&gt; clazz = input.getClass();</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">        if (clazz.equals(Instant.class)) {</span>
<span class="fc" id="L216">            return (Instant) input;</span>
        }
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">        if (clazz.equals(ZonedDateTime.class)) {</span>
<span class="nc" id="L219">            return ((ZonedDateTime) input).toInstant();</span>
        }
<span class="pc bpc" id="L221" title="1 of 2 branches missed.">        if (clazz.equals(LocalDate.class)) {</span>
<span class="fc" id="L222">            return ((LocalDate) input).atStartOfDay(zoneId).toInstant();</span>
        }
<span class="nc bnc" id="L224" title="All 2 branches missed.">        if (clazz.equals(LocalDateTime.class)) {</span>
<span class="nc" id="L225">            return ((LocalDateTime) input).atZone(zoneId).toInstant();</span>
        }
<span class="nc" id="L227">        throw new NotImplementedException(&quot;Feel free to add support!&quot;);</span>
    }

    public String getDateDOB() {
<span class="fc" id="L231">        return getFormattedDateTime(getText(&quot;global.format.date_output&quot;));</span>
    }

    // Helper
    private String getFormattedDateTime(String format, Locale locale) {
<span class="fc" id="L236">        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(format)</span>
<span class="fc" id="L237">                .withLocale(locale)</span>
<span class="fc" id="L238">                .withZone(getActualZoneId());</span>

<span class="fc" id="L240">        return getFormattedTimestamp(formatter::format);</span>
    }

    private String getFormattedDateTimeWithUkEnglishPreference(String format) {
<span class="fc" id="L244">        Locale locale = getLocale();</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">        if (locale.equals(Locale.ENGLISH)) {</span>
<span class="fc" id="L246">            locale = Locale.UK;</span>
        }
<span class="fc" id="L248">        return getFormattedDateTime(format, locale);</span>
    }

    private String getFormattedDateTime(String format) {
<span class="fc" id="L252">        return getFormattedDateTime(format, getLocale());</span>
    }

    private String getFormattedTimestamp(Function&lt;TemporalAccessor, String&gt; formatter) {
<span class="fc" id="L256">        return getInstantOrTemporalAccessor()</span>
<span class="fc" id="L257">                .map(formatter)</span>
<span class="fc" id="L258">                .orElse(StringUtils.EMPTY);</span>
    }

    private Optional&lt;TemporalAccessor&gt; getInstantOrTemporalAccessor() {
<span class="fc bfc" id="L262" title="All 2 branches covered.">        if (date != null) {</span>
<span class="fc" id="L263">            return Optional.of(date.toInstant());</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">        } else if (temporalAccessor != null) {</span>
<span class="fc" id="L265">            return Optional.of(temporalAccessor);</span>
        }

<span class="fc" id="L268">        return Optional.empty();</span>
    }

    // Getters &amp; Setters

    public Date getDate() {
<span class="nc" id="L274">        return date;</span>
    }

    public void setDate(Date date) {
<span class="fc" id="L278">        this.date = date;</span>
<span class="fc" id="L279">    }</span>

    public TemporalAccessor getTemporalAccessor() {
<span class="fc" id="L282">        return temporalAccessor;</span>
    }

    public void setTemporalAccessor(TemporalAccessor temporalAccessor) {
<span class="fc" id="L286">        this.temporalAccessor = temporalAccessor;</span>
<span class="fc" id="L287">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>