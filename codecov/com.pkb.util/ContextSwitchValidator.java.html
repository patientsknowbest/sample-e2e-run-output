<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ContextSwitchValidator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.util</a> &gt; <span class="el_source">ContextSwitchValidator.java</span></div><h1>ContextSwitchValidator.java</h1><pre class="source lang-java linenums">package com.pkb.util;

import com.pkb.entities.enums.UserType;
import com.pkb.exception.DisplayableException;
import com.pkb.exception.NoCryptoAccessException;
import com.pkb.exception.PKBException;
import com.pkb.service.team.TeamManager;
import com.pkb.service.user.impl.UserAccessManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import io.vavr.control.Either;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.security.InvalidParameterException;
import java.util.Optional;
import java.util.UUID;
import java.util.function.BiPredicate;
import java.util.function.Function;

import static com.pkb.entities.enums.UserType.INSTITUTE_ADMIN;
import static com.pkb.entities.enums.UserType.REG_CLINICIAN;
import static com.pkb.util.PKBConstants.VALID_ACCESS_CONTEXTUSER_USERTYPES;
import static io.vavr.control.Either.left;
import static io.vavr.control.Either.right;
import static java.lang.String.format;

public class ContextSwitchValidator {

    private UserManager userManager;
    private TeamManager teamManager;
    private UserAccessManager userAccessManager;
    private LoggedInUserUtil loggedInUserUtil;

<span class="fc" id="L35">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    public ContextSwitchValidator(UserManager userManager, TeamManager teamManager, UserAccessManager userAccessManager,
<span class="fc" id="L38">                                  LoggedInUserUtil loggedInUserUtil) {</span>
<span class="fc" id="L39">        this.userManager = userManager;</span>
<span class="fc" id="L40">        this.teamManager = teamManager;</span>
<span class="fc" id="L41">        this.userAccessManager = userAccessManager;</span>
<span class="fc" id="L42">        this.loggedInUserUtil = loggedInUserUtil;</span>
<span class="fc" id="L43">    }</span>

    void validateContextSwitchConditions(long contextUserId, UserType currentUserType, boolean currentActiveTeamUser, UUID loggedInUserPublicId) {


<span class="pc bpc" id="L48" title="1 of 2 branches missed.">        if (!VALID_ACCESS_CONTEXTUSER_USERTYPES.contains(currentUserType)) {</span>
<span class="nc" id="L49">            throw new PKBException(&quot;current userType cannot set a contextUser: &quot; + currentUserType);</span>
        }

<span class="fc" id="L52">        var patient = getPatientFromContextUser(contextUserId).getOrElseThrow(Function.identity());</span>
<span class="pc bpc" id="L53" title="1 of 6 branches missed.">        BiPredicate&lt;UserType, Boolean&gt; activeTeamAdminOrClinician = (userType, active) -&gt; (userType == INSTITUTE_ADMIN || userType == REG_CLINICIAN) &amp;&amp; active;</span>

        // When the record is frozen then only an active team clinician can open this record
<span class="fc bfc" id="L56" title="All 4 branches covered.">        if (patient.isFrozenByTeam() &amp;&amp; (activeTeamAdminOrClinician.negate().test(currentUserType, currentActiveTeamUser))) {</span>
<span class="fc" id="L57">            var freezingTeam = Optional.ofNullable(teamManager.getTeam(patient.getFrozenByTeamId()))</span>
<span class="pc" id="L58">                    .orElseThrow(() -&gt; new IllegalStateException(format(&quot;Unable to determine the team who froze the patient record (id=%d).&quot;, patient.getId())));</span>
<span class="fc bfc" id="L59" title="All 2 branches covered.">            if (loggedInUserUtil.isLoggedInUserACarer()) {</span>
<span class="fc" id="L60">                throw new DisplayableException(&quot;global.msg.frozen_by_org&quot;,</span>
<span class="fc" id="L61">                        new String[]{ freezingTeam.getOrg().getName() },</span>
                        DisplayableException.DisplayAs.error);
            } else {
<span class="fc" id="L64">                throw new DisplayableException(&quot;global.msg.frozen_by_team&quot;,</span>
<span class="fc" id="L65">                        new String[]{ freezingTeam.getOrg().getName(), freezingTeam.getName() },</span>
                        DisplayableException.DisplayAs.error);
            }
        }

<span class="fc bfc" id="L70" title="All 2 branches covered.">        if (!userAccessManager.hasAccessToAccount(loggedInUserPublicId, patient.getDefaultAccountId())) {</span>
<span class="fc" id="L71">            throw new NoCryptoAccessException();</span>
        }
<span class="fc" id="L73">    }</span>

    private Either&lt;InvalidParameterException, PKBPerson&gt; getPatientFromContextUser(long contextUserId) {
<span class="fc" id="L76">        var person = userManager.getPKBPerson(contextUserId, PKBPerson.Lazy.PROPERTIES);</span>
<span class="pc bpc" id="L77" title="2 of 4 branches missed.">        if (person == null || !person.isPatient()) {</span>
<span class="nc" id="L78">            return left(new InvalidParameterException(format(&quot;contextUserId is not a patient: %d&quot;, contextUserId)));</span>
        }
<span class="fc" id="L80">        return right(person);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>