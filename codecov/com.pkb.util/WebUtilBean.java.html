<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WebUtilBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.util</a> &gt; <span class="el_source">WebUtilBean.java</span></div><h1>WebUtilBean.java</h1><pre class="source lang-java linenums">package com.pkb.util;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.opensymphony.xwork2.ActionContext;
import com.opensymphony.xwork2.ObjectFactory;
import com.opensymphony.xwork2.inject.Inject;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.entities.enums.NationalIdType;
import com.pkb.institute.entity.Team;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import org.apache.struts2.StrutsStatics;
import org.apache.struts2.interceptor.I18nInterceptor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import javax.servlet.http.HttpServletRequest;
import java.time.format.DateTimeFormatter;
import java.util.Locale;
import java.util.Map;
import java.util.Optional;
import java.util.Set;

import static com.fasterxml.jackson.annotation.JsonInclude.Include.NON_NULL;
import static com.opensymphony.xwork2.ActionContext.getContext;
import static com.pkb.util.PKBWebUtil.BREAK_THE_GLASS;
import static java.util.Optional.ofNullable;
import static org.apache.commons.collections4.CollectionUtils.isEmpty;

public class WebUtilBean {

<span class="fc" id="L35">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private PKBWebUtil pkbWebUtil;
    @Autowired
    private PhrConfig config;
    private ContextUserUtil contextUserUtil;
    private LoggedInUserUtil loggedInUserUtil;
    @Autowired
    private UserManager userManager;
<span class="fc" id="L44">    private ObjectMapper objectMapper = new ObjectMapper()</span>
<span class="fc" id="L45">            .setSerializationInclusion(NON_NULL);</span>

    @Autowired
    private HelpPageBaseURLProvider helpPageBaseURLProvider;

    @Autowired
    private UserAgentAnalyzerBean userAgentAnalyzerBean;

    @Autowired
    private DateTimeService dateTimeService;

    @Autowired
    private PKBServiceUtil pkbServiceUtil;

    @Autowired
    private SessionUtil sessionUtil;

<span class="fc" id="L62">    public WebUtilBean() {</span>
<span class="fc" id="L63">    }</span>

    @Inject
    private void setObjectFactory(ObjectFactory objectFactory) {
        try {
<span class="fc" id="L68">            Map&lt;String, Object&gt; context = getContext().getActionInvocation().getStack().getContext();</span>
<span class="fc" id="L69">            pkbWebUtil = (PKBWebUtil) objectFactory.buildBean(PKBWebUtil.class.getName(), context, false);</span>
<span class="fc" id="L70">            contextUserUtil = (ContextUserUtil) objectFactory.buildBean(ContextUserUtil.class.getName(), context);</span>
<span class="fc" id="L71">            loggedInUserUtil = (LoggedInUserUtil) objectFactory.buildBean(LoggedInUserUtil.class.getName(), context);</span>
<span class="nc" id="L72">        } catch (Exception e) {</span>
<span class="nc" id="L73">            throw new RuntimeException(e);</span>
<span class="fc" id="L74">        }</span>
<span class="fc" id="L75">    }</span>

    public String getHomePageURL() {
<span class="fc" id="L78">        return config.getBaseURL();</span>
    }

    public PKBPerson getContextUser() {
<span class="fc" id="L82">        return contextUserUtil.getContextUser();</span>
    }

    public boolean isShowErrorDetail() {
<span class="fc" id="L86">        return config.isDisplayOfSensitiveErrorInformationEnabled();</span>
    }

    public double getSessionTextSize() {
<span class="fc" id="L90">        HttpServletRequest request = (HttpServletRequest) getContext().get(StrutsStatics.HTTP_REQUEST);</span>
<span class="fc" id="L91">        Map&lt;String, Object&gt; session = getContext().getSession();</span>
<span class="fc" id="L92">        double textSize = 1.0;</span>
<span class="fc" id="L93">        String textSizeParam = request.getParameter(&quot;textSize&quot;);</span>
<span class="pc bpc" id="L94" title="1 of 2 branches missed.">        if (textSizeParam != null) {</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">            if (&quot;small&quot;.equals(textSizeParam)) {</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                textSize = session.get(&quot;textSize&quot;) == null ? 1.0 : (Double) session.get(&quot;textSize&quot;);</span>
<span class="nc" id="L97">                textSize = textSize - 0.1;</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            } else if (&quot;big&quot;.equals(textSizeParam)) {</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">                textSize = session.get(&quot;textSize&quot;) == null ? 1.0 : (Double) session.get(&quot;textSize&quot;);</span>
<span class="nc" id="L100">                textSize = textSize + 0.1;</span>
            }

<span class="nc" id="L103">            session.put(&quot;textSize&quot;, textSize);</span>
        }
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        return session.get(&quot;textSize&quot;) == null ? 1.0 : (Double) session.get(&quot;textSize&quot;);</span>
    }

    public String getSessionContrast() {
<span class="fc" id="L109">        HttpServletRequest request = (HttpServletRequest) getContext().get(StrutsStatics.HTTP_REQUEST);</span>
<span class="fc" id="L110">        Map&lt;String, Object&gt; session = getContext().getSession();</span>

<span class="fc" id="L112">        String contrastParam = request.getParameter(&quot;contrast&quot;);</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">        if (contrastParam != null) {</span>
<span class="nc" id="L114">            session.put(&quot;contrast&quot;, contrastParam);</span>
        }
<span class="fc" id="L116">        return (String) session.get(&quot;contrast&quot;);</span>
    }

    public String getSpaConfig() throws JsonProcessingException {
<span class="fc" id="L120">        ActionContext context = getContext();</span>
<span class="fc" id="L121">        Map&lt;String, Object&gt; session = context.getSession();</span>

<span class="fc" id="L123">        Optional&lt;Team&gt; loggedInUsersTeam = loggedInUserUtil.getOptionalLoggedInUserPrimaryTeam();</span>
<span class="fc" id="L124">        Long patientPrivateId = contextUserUtil.getContextUser().getId();</span>
<span class="fc" id="L125">        Locale locale = (Locale) session.get(I18nInterceptor.DEFAULT_SESSION_ATTRIBUTE);</span>

<span class="fc" id="L127">        SpaConfig config = new SpaConfig();</span>
<span class="fc" id="L128">        config.setLocale(locale.getLanguage());</span>

<span class="fc" id="L130">        config.setPatientPrivateId(Long.toString(patientPrivateId));</span>
<span class="fc" id="L131">        config.setPatientPublicId(userManager.getIdentifierPair(patientPrivateId).getUuid().toString());</span>

<span class="fc" id="L133">        config.setCanActorEditPatientDemographics(loggedInUserUtil.isLoggedInUserTeamProfessional());</span>

<span class="pc bpc" id="L135" title="2 of 4 branches missed.">        if (loggedInUserUtil.isLoggedInUserTeamProfessional() &amp;&amp; loggedInUsersTeam.isPresent()) {</span>
<span class="fc" id="L136">            config.setTeamPrivateId(Long.toString(loggedInUsersTeam.get().getId()));</span>
        }

<span class="fc" id="L139">        config.setErrorTimeoutMillis(this.config.getPatientBannerErrorTimeoutMillis());</span>

<span class="fc" id="L141">        config.setFeatureCalendar(this.config.isTimelineCalendarEnabled());</span>
<span class="fc" id="L142">        config.setFeatureTests(this.config.isTimelineTestsEnabled());</span>
<span class="fc" id="L143">        config.setFeatureRadiology(this.config.isTimelineRadiologyEnabled());</span>
<span class="fc" id="L144">        config.setFeatureSymptoms(this.config.isTimelineSymptomsEnabled());</span>
<span class="fc" id="L145">        config.setFeatureMeasurements(this.config.isTimelineMeasurementsEnabled());</span>
<span class="fc" id="L146">        config.setPreloadingEnabled(this.config.isTimelinePreloadingEnabled());</span>
<span class="fc" id="L147">        config.setRequestTimeout(this.config.getTimelineRequestTimeout());</span>
<span class="fc" id="L148">        config.setFeatureRollbarEnabled(this.config.isRollBarEnabled());</span>
<span class="fc" id="L149">        this.config.getRollBarEnvironment().ifPresent(config::setFeatureRollbarEnvironment);</span>

<span class="fc" id="L151">        config.setCurrentDate(dateTimeService.nowLocalDateTime().format(DateTimeFormatter.ISO_LOCAL_DATE_TIME));</span>

<span class="fc" id="L153">        loggedInUsersTeam.map(Team::getCountry)</span>
<span class="fc" id="L154">                .flatMap(this::findNationalIdType)</span>
<span class="fc" id="L155">                .map(NationalIdType::getFhirIdentifierSystem)</span>
<span class="fc" id="L156">                .ifPresent(config::setUriOfIdentifierSystemOfTeamNationalIdType);</span>

<span class="fc" id="L158">        return objectMapper.writeValueAsString(config);</span>
    }

    public boolean isRollbarEnabled() {
<span class="fc" id="L162">        return config.isRollBarEnabled();</span>
    }

    public String getRollbarEnvironment() {
<span class="fc" id="L166">        return config.getRollBarEnvironment().orElse(null);</span>
    }

    public String getRollbarEndpoint() {
<span class="fc" id="L170">        return config.getRollbarEndpoint().orElse(null);</span>
    }

    public boolean isGpPrescriptionOrderingEnabled() {
<span class="fc" id="L174">        return config.isGpPrescriptionOrderingEnabled();</span>
    }

    private Optional&lt;NationalIdType&gt; findNationalIdType(String teamCountryCode) {
<span class="fc" id="L178">        Optional&lt;NationalIdType&gt; maybeNationalIdTypeForTeamsCountryCode = NationalIdType.getPrimaryNationalIdTypeFromCountryCode(teamCountryCode);</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        if (maybeNationalIdTypeForTeamsCountryCode.isEmpty()) {</span>
<span class="nc" id="L180">            LOGGER.error(&quot;Unknow National Id Type for country-code=[{}]&quot;, teamCountryCode);</span>
        }
<span class="fc" id="L182">        return maybeNationalIdTypeForTeamsCountryCode;</span>
    }

    public boolean displayNewPatientBanner() {
<span class="fc bfc" id="L186" title="All 4 branches covered.">        boolean displayNewPatientBanner = isSpaElementAllowed() &amp;&amp; sessionUtil.getDynamicFeatures().allowPatientBanner();</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">        LOGGER.debug(&quot;Displaying {} Patient Banner.&quot;, displayNewPatientBanner ? &quot;new&quot; : &quot;legacy&quot;);</span>
<span class="fc" id="L188">        return displayNewPatientBanner;</span>
    }

    public boolean displayTimeline() {
<span class="fc bfc" id="L192" title="All 4 branches covered.">        boolean displayTimeline = isSpaElementAllowed() &amp;&amp; isTimelineAllowed();</span>
<span class="fc" id="L193">        LOGGER.debug(&quot;Displaying Timeline: {}.&quot;, displayTimeline);</span>
<span class="fc" id="L194">        return displayTimeline;</span>
    }

    public boolean displayBrowserNotSupportedWarning() {
<span class="fc" id="L198">        return userAgentAnalyzerBean.isIE10OrOlder();</span>
    }

    public boolean displayOsNotSupportedWarning() {
<span class="fc" id="L202">        return userAgentAnalyzerBean.isBelowMinimumSupportedIOS();</span>
    }

    private boolean isSpaElementAllowed() {
<span class="fc bfc" id="L206" title="All 2 branches covered.">        return loggedInUserUtil.isLoggedInUserTeamProfessional() &amp;&amp;</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">                notBreakTheGlassAccess(getContext()) &amp;&amp;</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">                userAgentAnalyzerBean.isModernBrowser();</span>
    }

    private boolean notBreakTheGlassAccess(ActionContext context) {
<span class="fc" id="L212">        Set&lt;?&gt; patients = (Set&lt;?&gt;) context.getSession().get(BREAK_THE_GLASS);</span>

<span class="fc bfc" id="L214" title="All 2 branches covered.">        return isEmpty(patients) || ofNullable(getContextUser())</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">                .map(user -&gt; !patients.contains(user.getId()))</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">                .orElse(true);</span>
    }

    private boolean isTimelineAllowed() {
<span class="pc bpc" id="L220" title="1 of 4 branches missed.">        return sessionUtil.getDynamicFeatures().allowPatientBanner() &amp;&amp; config.isTimelineEnabled();</span>
    }

    public boolean hideHelpIcons() {
<span class="fc" id="L224">        return helpPageBaseURLProvider.hideHelpIcons();</span>
    }

<span class="fc" id="L227">    public boolean isIframeTestingEnabled() {return config.isIframeTestingEnabled(); }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>