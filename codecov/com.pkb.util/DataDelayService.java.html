<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataDelayService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.util</a> &gt; <span class="el_source">DataDelayService.java</span></div><h1>DataDelayService.java</h1><pre class="source lang-java linenums">package com.pkb.util;

import com.pkb.common.datetime.DateTimeService;
import com.pkb.encounter.entity.Message;
import com.pkb.entities.enums.UserType;
import com.pkb.radiology.entity.RadiologyResult;
import com.pkb.test.entity.TestResultDTO;
import org.jetbrains.annotations.NotNull;

import java.time.Instant;
import java.util.Optional;

import static com.pkb.entities.enums.UserType.PATIENT;
import static java.time.Period.ofDays;
import static java.util.Optional.empty;

/**
 * Some HL7 messages (e.g. ORU R01 and MDM T02) allow a caller to specify a delay (typically in OBX-13). If present,
 * this causes PKB to hide the data from the patient (but not other user types) until the specified number of days have
 * elapsed from the reference point in time, which is typically when the data was created (but varies by data type).
 *
 * This service allows callers to determine whether or not there is a non-expired delay.
 *
 * @see HL7Util.getPatientDelayDays
 */
public class DataDelayService {
    private final DateTimeService dateTimeService;

<span class="fc" id="L29">    public DataDelayService(@NotNull DateTimeService dateTimeService) {</span>
<span class="fc" id="L30">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L31">    }</span>

    public @NotNull Optional&lt;Instant&gt; findWhenBecomesVisibleForUserType(@NotNull TestResultDTO labResult, @NotNull UserType userType) {
<span class="fc" id="L34">        return findWhenBecomesVisibleForUserType(labResult.getTestDate(), labResult.getDelayDisplayDays(), userType);</span>
    }

    public @NotNull Optional&lt;Instant&gt; findWhenBecomesVisibleForUserType(@NotNull RadiologyResult radiologyResult, @NotNull UserType userType) {
<span class="fc" id="L38">        return findWhenBecomesVisibleForUserType(radiologyResult.getCreationTimestamp(), radiologyResult.getDelayDisplayDays(), userType);</span>
    }

    public @NotNull Optional&lt;Instant&gt; findWhenBecomesVisibleForUserType(@NotNull Message message, @NotNull UserType userType) {
<span class="fc" id="L42">        return findWhenBecomesVisibleForUserType(message.getMessageTimestamp(), message.getDelayDisplayDays(), userType);</span>
    }

    /**
     * Calculates when the data will become visible to patients.
     * If there is a non-expired delay and the accessing user is a patient then the Instant when the data will become visible is returned.
     * In all other situations Optional.empty() is returned.
     *
     * @param referenceInstant The point in time from which the delay should be calculated
     * @param delayDisplayDays The number of days for which the data display should be delayed
     * @param userType The type of user accessing the data
     * @return The Instant when the data will become visible, else Optional.empty() if no delay should be applied
     */
    public @NotNull Optional&lt;Instant&gt; findWhenBecomesVisibleForUserType(Instant referenceInstant, Long delayDisplayDays, @NotNull UserType userType) {
<span class="fc" id="L56">        Optional&lt;Instant&gt; maybeVisibleOnInstant = empty();</span>
<span class="fc bfc" id="L57" title="All 2 branches covered.">        if (PATIENT == userType) {</span>
<span class="pc bpc" id="L58" title="1 of 6 branches missed.">            if (referenceInstant != null &amp;&amp; delayDisplayDays != null &amp;&amp; delayDisplayDays &gt; 0L) {</span>
<span class="fc" id="L59">                maybeVisibleOnInstant = Optional.of(referenceInstant.plus(ofDays(delayDisplayDays.intValue()))).filter(dateTimeService.now()::isBefore);</span>
            }
        }
<span class="fc" id="L62">        return maybeVisibleOnInstant;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>