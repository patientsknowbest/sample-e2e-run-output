<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TwoFactorAuthenticationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.twofactor</a> &gt; <span class="el_source">TwoFactorAuthenticationService.java</span></div><h1>TwoFactorAuthenticationService.java</h1><pre class="source lang-java linenums">package com.pkb.service.twofactor;

import com.google.common.collect.Sets;
import com.pkb.VersionDetails;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.datamodel.Email;
import com.pkb.entities.enums.TwoFactorAuthState;
import com.pkb.entities.enums.UserType;
import com.pkb.integration.medmij.MedmijService;
import com.pkb.service.security.twofactor.TotpUrlGenerator;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import com.warrenstrange.googleauth.GoogleAuthenticatorKey;
import com.warrenstrange.googleauth.IGoogleAuthenticator;
import io.vavr.control.Either;
import net.glxn.qrgen.core.image.ImageType;
import net.glxn.qrgen.javase.QRCode;
import org.apache.commons.codec.binary.Base64;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.invoke.MethodHandles;
import java.util.Optional;
import java.util.Set;

import static com.google.common.base.Preconditions.checkArgument;
import static com.google.common.base.Preconditions.checkNotNull;
import static com.google.common.base.Preconditions.checkState;
import static org.apache.commons.lang3.StringUtils.isNotEmpty;

public class TwoFactorAuthenticationService {
    public static final String ROLE_FOR_TWO_FACTOR_AUTH = &quot;ROLE_PRE_TWOFA&quot;;
    private static final String PERSON_CANNOT_BE_NULL = &quot;Person cannot be null!&quot;;
<span class="fc" id="L36">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>
    private static final String MANUAL_ACCOUNT_PREFIX = &quot;PKB:&quot;;
<span class="fc" id="L38">    private static final Set&lt;UserType&gt; PKB_EMPLOYEES = Sets.immutableEnumSet(UserType.SUPER_ADMIN,</span>
            UserType.EMPLOYEE, UserType.TECH_SUPPORT);

<span class="fc" id="L41">    private static final Set&lt;UserType&gt; TWO_FACTOR_AUTH_MANDATORY = Sets.immutableEnumSet(UserType.TECH_SUPPORT);</span>

    private final PhrConfig config;

    private final UserManager userManager;

    private final TotpUrlGenerator totpUrlGenerator;

    private final IGoogleAuthenticator googleAuthenticator;

    private final MedmijService medmijService;

    private final DateTimeService dateTimeService;

<span class="fc" id="L55">    public TwoFactorAuthenticationService(PhrConfig config, UserManager userManager, TotpUrlGenerator totpUrlGenerator, IGoogleAuthenticator googleAuthenticator, MedmijService medmijService, DateTimeService dateTimeService) {</span>
<span class="fc" id="L56">        this.config = config;</span>
<span class="fc" id="L57">        this.userManager = userManager;</span>
<span class="fc" id="L58">        this.totpUrlGenerator = totpUrlGenerator;</span>
<span class="fc" id="L59">        this.googleAuthenticator = googleAuthenticator;</span>
<span class="fc" id="L60">        this.medmijService = medmijService;</span>
<span class="fc" id="L61">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L62">    }</span>

    /**
     * Performs authorization for {@link PKBPerson} with the provided code.
     *
     * @param person       {@link PKBPerson} to authorize.
     * @param providedCode The 2FA code to verify.
     * @return &lt;code&gt;true&lt;/code&gt; when the given code is valid or the service is disabled, &lt;code&gt;false&lt;/code&gt; otherwise.
     */
    public boolean authorize(PKBPerson person, int providedCode) {
<span class="fc" id="L72">        checkNotNull(person, PERSON_CANNOT_BE_NULL);</span>
<span class="fc" id="L73">        boolean result = false;</span>
<span class="pc bpc" id="L74" title="1 of 2 branches missed.">        if (isServiceEnabled()) {</span>
<span class="pc bpc" id="L75" title="2 of 4 branches missed.">            if (isTwoFaActive(person) &amp;&amp; allowedToUseTwoFA(person)) {</span>
<span class="fc" id="L76">                result = isCodeValid(person, providedCode);</span>
<span class="fc" id="L77">                LOGGER.info(&quot;Two factor authentication result for {} is {}.&quot;, person.getId(), result);</span>

            } else {
<span class="nc" id="L80">                result = true;</span>
<span class="nc" id="L81">                LOGGER.info(&quot;Two factor authentication skipped for {} because its not active!&quot;, person.getId());</span>
            }
        } else {
<span class="nc" id="L84">            LOGGER.info(&quot;Two factor authentication service is disabled, authorizing {}.&quot;, person.getId());</span>
<span class="nc" id="L85">            result = true;</span>
        }
<span class="fc" id="L87">        return result;</span>
    }

    /**
     * Initialize 2FA secret for {@link PKBPerson}.
     *
     * @param person {@link PKBPerson} who wants to activate 2FA.
     * @return {@link PKBPerson} with initialized 2FA.
     * @throws {@link IllegalStateException} in case {@link PKBPerson#getTwoFactorAuthState()} is not {@link TwoFactorAuthState#DISABLED}
     *                or the service is disabled.
     */
    public PKBPerson initialize(EHRRequestContext requestContext, PKBPerson person) {
<span class="fc" id="L99">        checkNotNull(person, PERSON_CANNOT_BE_NULL);</span>
<span class="fc" id="L100">        checkState(isTwoFaDisabled(person),</span>
                &quot;Two factor authentication for person was already initilaized!&quot;);
<span class="fc" id="L102">        checkEnabledServiceState();</span>
<span class="fc" id="L103">        GoogleAuthenticatorKey createCredentials = googleAuthenticator.createCredentials();</span>
<span class="fc" id="L104">        person.setTwoFactorAuthState(TwoFactorAuthState.INITIALIZED);</span>
<span class="fc" id="L105">        person.setTwoFactorSecret(createCredentials.getKey());</span>
<span class="fc" id="L106">        PKBPerson result = userManager.updateUser(requestContext, person);</span>
<span class="fc" id="L107">        LOGGER.info(&quot;Two factor authentication initialized for {}.&quot;, result.getId());</span>
<span class="fc" id="L108">        return result;</span>
    }

    /**
     * Performs activation of 2FA for {@link PKBPerson}.
     * Must provide valid code in order to enable 2FA.
     *
     * @param person       The {@link PKBPerson} who requires 2FA activation.
     * @param providedCode The 2FA code to verify.
     * @return Optional {@link PKBPerson} in case the activation is successful, {@link Optional#empty()} otherwise.
     * @throws {@link IllegalStateException} in case {@link PKBPerson#getTwoFactorAuthState()} is not {@link TwoFactorAuthState#INITIALIZED}
     *                or the service is disabled.
     */
    public Optional&lt;PKBPerson&gt; activate(EHRRequestContext requestContext, PKBPerson person, int providedCode) {
<span class="fc" id="L122">        checkNotNull(person, PERSON_CANNOT_BE_NULL);</span>
<span class="fc" id="L123">        checkState(isTwoFaInitialized(person),</span>
                &quot;Two factor authentication for person was not initilaized!&quot;);
<span class="fc" id="L125">        checkEnabledServiceState();</span>
<span class="fc" id="L126">        Optional&lt;PKBPerson&gt; result = Optional.empty();</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">        if (isCodeValid(person, providedCode)) {</span>
<span class="fc" id="L128">            person.setTwoFactorAuthState(TwoFactorAuthState.ACTIVE);</span>
<span class="fc" id="L129">            PKBPerson updatedPerson = userManager.updateUser(requestContext, person);</span>
<span class="fc" id="L130">            result = Optional.of(updatedPerson);</span>
<span class="fc" id="L131">            LOGGER.info(&quot;Two factor authentication activated for {}.&quot;, updatedPerson.getId());</span>
        }
<span class="fc" id="L133">        return result;</span>
    }

    /**
     * Disable 2FA for {@link PKBPerson}.
     * Must provide valid code in order to disable 2FA.
     *
     * @param person       The {@link PKBPerson} whose 2FA should be disabled.
     * @param providedCode The 2FA code to verify.
     * @return Optional {@link PKBPerson} in case 2FA was disabled, {@link Optional#empty()} otherwise.
     * @throws {@link IllegalStateException} in case {@link PKBPerson#getTwoFactorAuthState()} is not {@link TwoFactorAuthState#ACTIVE}
     *                or the service is disabled.
     */
    public Either&lt;String, Optional&lt;PKBPerson&gt;&gt; disable(EHRRequestContext requestContext, PKBPerson person, int providedCode) {
<span class="fc" id="L147">        checkNotNull(person, PERSON_CANNOT_BE_NULL);</span>
<span class="fc" id="L148">        checkState(isTwoFaActive(person), &quot;Two factor authentication for person is not active!&quot;);</span>
<span class="fc" id="L149">        checkEnabledServiceState();</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">        if (isTwoFactorAuthMandatory(person)) {</span>
<span class="nc" id="L151">            return Either.left(&quot;Cannot disable Two factor authentication as its mandatory for user: &quot; + person.getId());</span>
        }
<span class="fc bfc" id="L153" title="All 2 branches covered.">        if (isCodeValid(person, providedCode)) {</span>
<span class="fc" id="L154">            person.setTwoFactorAuthState(TwoFactorAuthState.DISABLED);</span>
<span class="fc" id="L155">            person.setTwoFactorSecret(null);</span>
<span class="fc" id="L156">            PKBPerson updatedPerson = userManager.updateUser(requestContext, person);</span>
<span class="fc" id="L157">            LOGGER.info(&quot;Two factor authentication disabled for {}.&quot;, updatedPerson.getId());</span>
<span class="fc" id="L158">            return Either.right(Optional.of(updatedPerson));</span>
        }
<span class="fc" id="L160">        return Either.right(Optional.empty());</span>
    }

    /**
     * This method is for administrators to disable two-factor authentication for users without requiring access to the 2FA device.
     * @param person
     * @return
     */
    public Optional&lt;PKBPerson&gt; forceDisable(PKBPerson person, VersionDetails versionDetails) {
<span class="fc" id="L169">        checkNotNull(person, PERSON_CANNOT_BE_NULL);</span>
<span class="fc" id="L170">        checkEnabledServiceState();</span>
<span class="fc" id="L171">        person.setTwoFactorAuthState(TwoFactorAuthState.DISABLED);</span>
<span class="fc" id="L172">        person.setTwoFactorSecret(null);</span>
<span class="fc" id="L173">        PKBPerson updatedPerson = userManager.updateUser(person, versionDetails);</span>
<span class="fc" id="L174">        LOGGER.info(&quot;Two factor authentication disabled for {}.&quot;, updatedPerson.getId());</span>
<span class="fc" id="L175">        return Optional.of(updatedPerson);</span>
    }

    /**
     * Returns the QR code for 2FA as a Base64 encoded PNG.
     *
     * @param person
     * @return Base64 encoded PNG
     */
    public String getQRCode(PKBPerson person) {
<span class="fc" id="L185">        checkNotNull(person, PERSON_CANNOT_BE_NULL);</span>
<span class="fc" id="L186">        checkArgument(isNotEmpty(person.getTwoFactorSecret()),</span>
                &quot;Two factor secret must be present!&quot;);
<span class="fc" id="L188">        String totpUrl = totpUrlGenerator.getOtpAuthTotpURL(person.findEmail().map(Email::address).getOrNull(),</span>
<span class="fc" id="L189">                person.getTwoFactorSecret());</span>
<span class="fc" id="L190">        byte[] qrBytes = QRCode.from(totpUrl).to(ImageType.PNG).stream().toByteArray();</span>
<span class="fc" id="L191">        return Base64.encodeBase64String(qrBytes);</span>
    }

    /**
     * Returns the account for manual 2FA setup.
     *
     * @param person
     * @return The account string to enter in APP.
     */
    public String getAccountForManualSetup(PKBPerson person) {
<span class="fc" id="L201">        checkNotNull(person, PERSON_CANNOT_BE_NULL);</span>
<span class="fc" id="L202">        return MANUAL_ACCOUNT_PREFIX + person.findEmail().map(Email::address).getOrNull();</span>
    }

    /**
     * Checks whether 2FA check should be done for {@link PKBPerson}.
     * Ignores previously done 2FA check.
     *
     * @param person
     * @return &lt;code&gt;true&lt;/code&gt; in case 2FA is available and active for {@link PKBPerson}, &lt;code&gt;false&lt;/code&gt; otherwise.
     */
    public boolean isTwoFactorCheckRequired(PKBPerson person) {
<span class="fc bfc" id="L213" title="All 4 branches covered.">        return isTwoFactorAvailableForUser(person) &amp;&amp; isTwoFaActive(person);</span>
    }

    /**
     * Checks whether 2FA is available for the given {@link PKBPerson}.
     *
     * @param person
     * @return &lt;code&gt;true&lt;/code&gt; in case 2FA is available for the given {@link PKBPerson}, &lt;code&gt;false&lt;/code&gt; otherwise.
     */
    public boolean isTwoFactorAvailableForUser(PKBPerson person) {
<span class="pc bpc" id="L223" title="1 of 4 branches missed.">        return isServiceEnabled() &amp;&amp; allowedToUseTwoFA(person);</span>
    }

    /**
     * Checks weather 2FA check is mandatory for the given {@link PKBPerson}.
     *
     * @param person
     * @return &lt;code&gt;true&lt;/code&gt; in case 2FA is mandatory for the given {@link PKBPerson}, &lt;code&gt;false&lt;/code&gt; otherwise.
     */
    public boolean isTwoFactorAuthMandatory(PKBPerson person) {
<span class="fc bfc" id="L233" title="All 6 branches covered.">        return isTwoFactorAvailableForUser(person) &amp;&amp; (person.getTwoFactorAuthMandatory() || medmijService.isMedMijSubject(person));</span>
    }

    /**
     * Checks weather 2FA check is mandatory for the given {@link UserType}.
     *
     * @param userType
     * @return &lt;code&gt;true&lt;/code&gt; in case 2FA is mandatory for given {@link UserType}, &lt;code&gt;false&lt;/code&gt; otherwise.
     */
    public boolean isTwoFactorAuthMandatoryForUserType(UserType userType) {
<span class="nc" id="L243">        return TWO_FACTOR_AUTH_MANDATORY.contains(userType);</span>
    }

    private boolean isCodeValid(PKBPerson person, int providedCode) {
<span class="fc" id="L247">        return googleAuthenticator.authorize(person.getTwoFactorSecret(), providedCode);</span>
    }

    private boolean isTwoFaInitialized(PKBPerson person) {
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">        return TwoFactorAuthState.INITIALIZED == person.getTwoFactorAuthState();</span>
    }

    private boolean isTwoFaActive(PKBPerson person) {
<span class="fc bfc" id="L255" title="All 2 branches covered.">        return TwoFactorAuthState.ACTIVE == person.getTwoFactorAuthState();</span>
    }

    private boolean isTwoFaDisabled(PKBPerson person) {
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">        return TwoFactorAuthState.DISABLED == person.getTwoFactorAuthState();</span>
    }

    private void checkEnabledServiceState() {
<span class="fc" id="L263">        checkState(isServiceEnabled(), &quot;Service disabled, check state before calling this method!&quot;);</span>
<span class="fc" id="L264">    }</span>

    private boolean allowedToUseTwoFA(PKBPerson person) {
<span class="fc" id="L267">        boolean result = true;</span>
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">        if (config.is2FARestrictedToPKBEmployees()) {</span>
<span class="nc" id="L269">            result = PKB_EMPLOYEES.contains(person.getUserType());</span>
        }
<span class="fc" id="L271">        return result;</span>
    }

    public boolean isServiceEnabled() {
<span class="fc" id="L275">        return config.is2FAEnabled();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>