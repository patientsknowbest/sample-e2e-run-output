<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessageService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.rpc.message</a> &gt; <span class="el_source">MessageService.java</span></div><h1>MessageService.java</h1><pre class="source lang-java linenums">package com.pkb.api.rpc.message;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.pkb.client.message.Failure;
import com.pkb.client.message.MessageDetails;
import com.pkb.client.message.MessageSent;
import com.pkb.client.message.ReactorMessageGrpc;
import com.pkb.client.message.exception.InconsistentDataException;
import com.pkb.client.message.exception.InvalidParameterException;
import com.pkb.client.message.exception.MessageServiceException;
import com.pkb.client.message.model.MessageDetailsAndContent;
import com.pkb.client.message.util.MessageDetailsValidation;
import com.pkb.common.config.PhrConfig;
import com.pkb.grpc.common.ListTransform;
import com.pkb.service.emailmessage.sender.impl.VelocityTemplateHandler;
import com.pkb.service.encounter.impl.tolven.EncounterManager;
import io.vavr.control.Either;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import reactor.core.publisher.Flux;

import java.lang.invoke.MethodHandles;
import java.time.Duration;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.stream.Collectors;

import static io.vavr.control.Either.left;
import static io.vavr.control.Either.right;

public class MessageService extends ReactorMessageGrpc.MessageImplBase {

<span class="fc" id="L37">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>
    private static final String QUESTIONNAIRE_REQUEST_TEMPLATE = &quot;questionnaire-request-template&quot;;

<span class="fc" id="L40">    private Map&lt;String, String&gt; messageTemplates = new HashMap&lt;&gt;();</span>
    private final EncounterManager encounterManager;
    private final VelocityTemplateHandler velocityTemplateHandler;
    private final ObjectMapper objectMapper;
    private final PhrConfig config;

    public MessageService(EncounterManager encounterManager, VelocityTemplateHandler velocityTemplateHandler, ObjectMapper objectMapper,
<span class="fc" id="L47">                          PhrConfig config) {</span>
<span class="fc" id="L48">        this.encounterManager = encounterManager;</span>
<span class="fc" id="L49">        this.velocityTemplateHandler = velocityTemplateHandler;</span>
<span class="fc" id="L50">        this.objectMapper = objectMapper;</span>
<span class="fc" id="L51">        this.config = config;</span>


<span class="fc" id="L54">        messageTemplates.put(QUESTIONNAIRE_REQUEST_TEMPLATE, &quot;templates/messages/sendQuestionnaireRequestToPatient.vm&quot;);</span>
<span class="fc" id="L55">    }</span>

    @Override
    public Flux&lt;MessageSent&gt; sendMessageStream(Flux&lt;MessageDetails&gt; messageDetailsFlux) {
<span class="fc" id="L59">        return messageDetailsFlux.bufferTimeout(config.getGrpcServerMessageBatchSize(), Duration.ofMillis(config.getGrpcServerMessageBufferTimeout()))</span>
<span class="fc" id="L60">                .flatMapIterable(this::sendMessagesFromDetails)</span>
<span class="pc" id="L61">                .doOnError(err -&gt; LOGGER.error(&quot;error sendMessageStream&quot;, err));</span>
    }

    private List&lt;MessageSent&gt; sendMessagesFromDetails(List&lt;MessageDetails&gt; messageDetailsList) {

<span class="fc" id="L66">        List&lt;Either&lt;MessageServiceException, MessageDetailsAndContent&gt;&gt; validationResults = messageDetailsList.stream()</span>
<span class="fc" id="L67">                .map(messageDetails -&gt; MessageDetailsValidation.validate(messageDetails)</span>
<span class="fc" id="L68">                        .flatMap(validMessageDetails -&gt; parseVariables(validMessageDetails)</span>
<span class="fc" id="L69">                                .flatMap(variables -&gt; getTemplatePath(validMessageDetails)</span>
<span class="fc" id="L70">                                        .map(template -&gt; new MessageDetailsAndContent(validMessageDetails,</span>
<span class="fc" id="L71">                                                velocityTemplateHandler.process(variables, template, new Locale(validMessageDetails.getMetadata().getLanguage())))))))</span>
<span class="fc" id="L72">                .collect(Collectors.toList());</span>

<span class="fc" id="L74">        return ListTransform.transformByPredicateAndReturnInSameOrder(validationResults, Either::isRight,</span>
<span class="fc" id="L75">                rights -&gt; encounterManager.saveMessagesFromLoggedOutContext(rights.stream().map(Either::get).collect(Collectors.toList())),</span>
<span class="nc" id="L76">                lefts -&gt; lefts.stream().map(l -&gt; Either.&lt;MessageServiceException, MessageDetails&gt;left(l.getLeft())).collect(Collectors.toList()))</span>
<span class="fc" id="L77">                .stream().map(either -&gt; either.peekLeft(this::logException)</span>
<span class="fc" id="L78">                        .fold(</span>
<span class="nc" id="L79">                                error -&gt; MessageSent.newBuilder().setFailure(Failure.newBuilder()</span>
<span class="nc" id="L80">                                        .setStatus(error.toStatus())</span>
<span class="nc" id="L81">                                        .setConversationId(error.getMessageDetails().getMetadata().getConversationId())).build(), </span>
<span class="fc" id="L82">                                messageDetails -&gt; MessageSent.newBuilder().setConversationId(messageDetails.getMetadata().getConversationId()).build()))</span>
<span class="fc" id="L83">                .collect(Collectors.toList());</span>
    }
    
    private void logException(MessageServiceException exception){
<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (exception instanceof InconsistentDataException) {</span>
<span class="nc" id="L88">            LOGGER.error(exception.getIssue());</span>
        } else {
<span class="nc" id="L90">            LOGGER.info(exception.getIssue());</span>
        }
<span class="nc" id="L92">    }</span>

    private Either&lt;MessageServiceException, Map&lt;String, Object&gt;&gt; parseVariables(MessageDetails messageDetails) {
        try {
<span class="fc" id="L96">            TypeReference&lt;HashMap&lt;String, Object&gt;&gt; typeRef = new TypeReference&lt;&gt;() {};</span>
<span class="fc" id="L97">            return right(objectMapper.readValue(messageDetails.getVariables().getJsonPayload(), typeRef));</span>
<span class="nc" id="L98">        } catch (JsonProcessingException e) {</span>
<span class="nc" id="L99">            return left(new InvalidParameterException(&quot;Unreadable template variables: &quot; + e.getMessage(), messageDetails));</span>
        }
    }

    private Either&lt;MessageServiceException, String&gt; getTemplatePath(MessageDetails messageDetails) {
<span class="fc" id="L104">        String templatePath = messageTemplates.getOrDefault(messageDetails.getTemplate(), &quot;&quot;);</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        if (templatePath.isEmpty()) {</span>
<span class="nc" id="L106">            return left(new InvalidParameterException(&quot;Unknown template name: '&quot; + messageDetails.getTemplate() + &quot;'&quot;, messageDetails));</span>
        }
<span class="fc" id="L108">        return right(templatePath);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>