<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BaseAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action</a> &gt; <span class="el_source">BaseAction.java</span></div><h1>BaseAction.java</h1><pre class="source lang-java linenums">package com.pkb.action;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.datatype.jdk8.Jdk8Module;
import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;
import com.google.common.collect.Lists;
import com.opensymphony.xwork2.ActionSupport;
import com.opensymphony.xwork2.Preparable;
import com.opensymphony.xwork2.inject.Inject;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.PersonAuthInfo;
import com.pkb.app.entity.PersonRoles;
import com.pkb.app.entity.SourceDetails;
import com.pkb.app.interfaces.IBaseDTO;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.consent.model.ConsentStatus;
import com.pkb.datamodel.consent.PatientConsentDTO;
import com.pkb.datamodel.consent.RequiresConsent;
import com.pkb.datamodel.ui.IUIDto;
import com.pkb.datamodel.ui.ResponseMeta;
import com.pkb.entities.enums.Gender;
import com.pkb.entities.enums.PrivacyFlag;
import com.pkb.entities.enums.UserType;
import com.pkb.exception.PKBException;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import com.pkb.mappers.PKBPersonToPersonDtoMapper;
import com.pkb.notification.entity.Activity;
import com.pkb.notification.entity.Activity.Action;
import com.pkb.notification.entity.ActivityProperty;
import com.pkb.repository.util.EmisContextHolder;
import com.pkb.repository.util.ImmutableEmisContextHolder;
import com.pkb.service.datapoint.DataWithUIPermissions;
import com.pkb.service.datapoint.impl.DataPointManager;
import com.pkb.service.ehrrequestcontext.EHRRequestContextManager;
import com.pkb.service.notification.impl.tolven.INotificationManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.symptom.entity.SymptomReportDTO;
import com.pkb.symptom.entity.SymptomSeverity;
import com.pkb.test.entity.PredefinedMeasurementType;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PKBPersonHelper;
import com.pkb.util.ContextUserUtil;
import com.pkb.util.ContextUtil;
import com.pkb.util.DateUtil;
import com.pkb.util.FormValidationErrors;
import com.pkb.util.HelpPageBaseURLProvider;
import com.pkb.util.ImmutableFooterConfigDto;
import com.pkb.util.ImmutableTermsAndConditionsConfigDTO;
import com.pkb.util.LoggedInUserUtil;
import com.pkb.util.PKBServiceUtil;
import com.pkb.util.PKBWebUtil;
import com.pkb.util.SessionUtil;
import com.pkb.util.SupportCodeGenerator;
import com.pkb.util.TermsAndConditionsConfigDTO;
import com.pkb.util.UserAgentAnalyzerBean;
import io.prometheus.client.Counter;
import io.vavr.Tuple2;
import io.vavr.control.Either;
import nl.basjes.parse.useragent.UserAgent;
import org.apache.commons.io.FileUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.lang3.time.DateUtils;
import org.apache.commons.lang3.tuple.Pair;
import org.apache.http.client.utils.URIBuilder;
import org.apache.struts2.ServletActionContext;
import org.apache.struts2.dispatcher.mapper.ActionMapper;
import org.apache.struts2.dispatcher.mapper.ActionMapping;
import org.apache.struts2.interceptor.ServletRequestAware;
import org.apache.struts2.interceptor.SessionAware;
import org.immutables.value.Value;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.File;
import java.io.IOException;
import java.lang.reflect.Field;
import java.net.MalformedURLException;
import java.net.URISyntaxException;
import java.net.URL;
import java.text.DecimalFormat;
import java.text.NumberFormat;
import java.text.ParseException;
import java.text.ParsePosition;
import java.time.Instant;
import java.time.LocalDate;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.function.BiFunction;
import java.util.function.BiPredicate;
import java.util.regex.Pattern;

import static com.pkb.util.Constants.APPLICATION_TZ;
import static com.pkb.util.Constants.NHS_LOGIN_CORRELATION_ID;
import static com.pkb.util.PKBConstants.DECIMAL_FORMAT_PATTERN;
import static com.pkb.util.PKBWebUtil.DOB_VALIDATOR_FORMATTER;
import static org.apache.commons.collections4.CollectionUtils.isNotEmpty;
import static org.apache.commons.lang3.StringUtils.EMPTY;
import static org.apache.commons.lang3.StringUtils.trimToEmpty;

/**
 * Abstract class which other Action classes should extend to access common functionality (e.g - logging activity)
 */
@SuppressWarnings(&quot;NonSerializableFieldInSerializableClass&quot;)
<span class="fc" id="L122">public abstract class BaseAction extends PKBActionSupport implements SessionAware,</span>
        ServletRequestAware, Preparable, ErrorLevelManipulator {

<span class="fc" id="L125">    public enum NhsAppPage {</span>
<span class="fc" id="L126">        HOME_PAGE,</span>
<span class="fc" id="L127">        APPOINTMENTS,</span>
<span class="fc" id="L128">        PRESCRIPTIONS,</span>
<span class="fc" id="L129">        HEALTH_RECORDS,</span>
<span class="fc" id="L130">        MESSAGES,</span>
<span class="fc" id="L131">        NONE</span>
    }

<span class="fc" id="L134">    protected String nhsAppPage = NhsAppPage.NONE.name();</span>

    protected static final String NO_CUSTOM_STYLE = &quot;&quot;;
    protected static final String MOBILE_OPTIMIZED_STYLE = &quot;mobile-optimized&quot;;
    protected static final String NO_HEADER_STYLE = &quot;no-header&quot;;
    protected static final String NO_NAVIGATION = &quot;no-navigation&quot;;
    protected static final String NO_TEAM_FOOTER = &quot;no-team-footer&quot;;
    protected static final String NHS_STYLE = &quot;nhs-style&quot;;
    protected static final String PKB_STYLE = &quot;pkb-style&quot;;
    public static final String CANCEL = &quot;cancel&quot;;
    public static final String RELOAD = &quot;reload&quot;;
    public static final String DISCUSS = &quot;discuss&quot;;
    public static final String NOT_FOUND = &quot;not-found&quot;;

    public static final String RETURN_TO_APPOINTMENT = &quot;returnToAppointment&quot;;
    public static final String RETURN_TO_APPOINTMENTS_LIST = &quot;returnToAppointmentsList&quot;;

    @Autowired
    protected PhrConfig config;

    @Autowired
    protected DateTimeService dateTimeService;

    @Autowired
    protected DataPointManager dataPointManager;

    @Autowired
    protected DateUtil dateUtil;

    @Autowired
    protected UUIDProvider uuidProvider;

    @Autowired
    protected PKBPersonHelper personHelper;

    @Autowired
    protected PKBPersonToPersonDtoMapper pkbPersonToPersonDtoMapper;

    @Autowired
    protected PKBWebUtil pkbWebUtil;

    @Autowired
    protected ContextUtil contextUtil;

    @Autowired
    protected PKBServiceUtil pkbServiceUtil;

    @Autowired
    protected GenderStringLocalizationHelper genderStringLocalizationHelper;

    @Autowired
    protected GenderLimitedStringLocalizationHelper genderLimitedStringLocalizationHelper;

    @Autowired
    protected GenderLocalizationHelper genderLocalizationHelper;

    @Autowired
    protected UserTypeLocalizationHelper userTypeLocalizationHelper;

    @Autowired
    protected MonthMapShortKeyLocalizationHelper monthMapShortKeyLocalizationHelper;

    @Autowired
    protected UserAgentAnalyzerBean userAgentAnalyzerBean;

    @Autowired
    protected UserManager userManager;

    @Autowired
    protected SupportCodeGenerator supportCodeGenerator;

    @Autowired
    private ClinicianMultipleTeamService clinicianMultipleTeamService;

    @Autowired
    protected SessionUtil sessionUtil;

    private static final String ACTION_LABEL = &quot;action&quot;;
    private static final String FIELD_LABEL = &quot;field&quot;;
    private static final String ERROR_LABEL = &quot;error&quot;;
<span class="fc" id="L214">    private static final io.prometheus.client.Counter actionErrorCounter = Counter.build()</span>
<span class="fc" id="L215">            .name(&quot;pkb_phr_struts_actionerrors&quot;)</span>
<span class="fc" id="L216">            .help(&quot;Struts action error count&quot;)</span>
<span class="fc" id="L217">            .labelNames(ACTION_LABEL, ERROR_LABEL)</span>
<span class="fc" id="L218">            .register();</span>

<span class="fc" id="L220">    private static final io.prometheus.client.Counter fieldErrorCounter = Counter.build()</span>
<span class="fc" id="L221">            .name(&quot;pkb_phr_struts_fielderrors&quot;)</span>
<span class="fc" id="L222">            .help(&quot;Struts action error count&quot;)</span>
<span class="fc" id="L223">            .labelNames(ACTION_LABEL, FIELD_LABEL, ERROR_LABEL)</span>
<span class="fc" id="L224">            .register();</span>

    private static final long serialVersionUID = 1L;
<span class="fc" id="L227">    private static final Pattern PASSWORD_COMPLEXITY_CHECKER = Pattern.compile(com.pkb.PKBConstants.PASSWORD_CONTENT_REGEXP);</span>

<span class="fc" id="L229">    protected static final ObjectMapper OBJECT_MAPPER = new ObjectMapper().registerModule(new Jdk8Module()).registerModule(new JavaTimeModule());</span>

    protected INotificationManager notificationManager;

    private EHRRequestContextManager ehrRequestContextManager;

    protected ContextUserUtil contextUserUtil;
    protected LoggedInUserUtil loggedInUserUtil;

    protected Map&lt;String, Object&gt; session;

    protected HttpServletRequest request;

    private HelpPageBaseURLProvider helpPageBaseURLProvider;

<span class="fc" id="L244">    protected static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    protected Long contextUserId;

    protected ActionMapper actionMapper;


<span class="pc bpc" id="L251" title="2 of 6 branches missed.">    protected static final BiPredicate&lt;PKBPerson, PKBPerson&gt; notSelf = (from, to) -&gt; from == null || to == null || !from.getId().equals(to.getId());</span>

    protected void throwFileSizeBreachedException(String fileName, String limitText) throws IOException {
<span class="fc" id="L254">        String breachText = getText(&quot;fileUploader.txt.fileTooLarge&quot;, Lists.newArrayList(fileName, limitText));</span>
        //noinspection StrutsI18nError,SSBasedInspection
<span class="fc" id="L256">        addActionError(breachText);</span>
<span class="fc" id="L257">        HttpServletResponse response = ServletActionContext.getResponse();</span>
<span class="fc" id="L258">        response.setStatus(HttpServletResponse.SC_BAD_REQUEST);</span>
<span class="fc" id="L259">        throw new IOException(breachText);</span>
    }


    public void logActivity(Activity.Action action, Instant timestampOfActivity, Long targetId, boolean notify, RequiresConsent consentRequired, Long... altActionTextPersonIds) {
<span class="fc" id="L264">        logActivity(action, timestampOfActivity, targetId, notify, null, consentRequired, altActionTextPersonIds);</span>
<span class="fc" id="L265">    }</span>

    protected Either&lt;MalformedURLException, Activity&gt; getActivity(Action action, Instant timestampOfActivity, Long targetId, Long actorId, Object... queryParams) {
<span class="fc" id="L268">        Activity activity = new Activity(timestampOfActivity, action, getEHRRequestContext().getOrgId().orElse(null));</span>
<span class="fc" id="L269">        activity.setTargetId(targetId);</span>
<span class="pc bpc" id="L270" title="1 of 2 branches missed.">        activity.setActorId(actorId != null ? actorId.toString() : null);</span>
<span class="fc" id="L271">        activity.populateUserQueryParams(queryParams);</span>
        try {
<span class="fc" id="L273">            activity.setUrl(new URL(request.getRequestURL().toString()));</span>
<span class="nc" id="L274">        } catch (MalformedURLException e) {</span>
<span class="nc" id="L275">            return Either.left(e);</span>
<span class="fc" id="L276">        }</span>
<span class="fc" id="L277">        return Either.right(activity);</span>
    }

<span class="fc" id="L280">    private final String[] acceptedDateFormats = {&quot;dd/MM/yy&quot;, &quot;dd/MM/yyyy&quot;, &quot;dd/MM/yyyy HH:mm&quot;, &quot;dd/MM/yyyy HH:mm:ss&quot;, &quot;dd.MM.yy&quot;,</span>
            &quot;dd.MM.yyyy&quot;, &quot;dd.MM.yyyy HH:mm&quot;, &quot;dd.MM.yyyy HH:mm:ss&quot;};

    /**
     * Log the activity by other account user and notify the owner
     *
     * @param action {@link Action} to be provided by the Action class
     * @param notify true of notification is required
     * @deprecated Use {@link #logActivityByOthers(Activity.Action, Instant, boolean, RequiresConsent, LoggedInEHRRequestContext)} instead.
     */
    public void logActivityByOthers(Activity.Action action, Instant timestampOfActivity, boolean notify, RequiresConsent consentRequired) {
<span class="fc" id="L291">        Long targetId = Optional.ofNullable(contextUserUtil.getContextUser()).map(PKBPerson::getId).orElseGet(loggedInUserUtil::getLoggedInUserId);</span>
<span class="fc" id="L292">        logActivity(action, timestampOfActivity, targetId, notify, null, consentRequired);</span>
<span class="fc" id="L293">    }</span>

    /**
     * Will log the activity if and only if !requestContext.isUserInOwnAccount()
     */
    public void logActivityByOthers(Activity.Action action, Instant timestampOfActivity, boolean notify, RequiresConsent consentRequired, LoggedInEHRRequestContext requestContext) {
<span class="fc bfc" id="L299" title="All 2 branches covered.">        if (!requestContext.isUserInOwnAccount()) {</span>
<span class="fc" id="L300">            logActivity(action, timestampOfActivity, requestContext.getContextOrAccessingUserId(), notify, null, consentRequired);</span>
        }
<span class="fc" id="L302">    }</span>

    public void logActivity(Activity.Action action, Instant timestampOfActivity, Long targetId, boolean notify, Map&lt;ActivityProperty,
            String&gt; actionPropertiesOrNull, RequiresConsent consentRequired, Long... altActionTextPersonIds) {
<span class="fc" id="L306">        logActivity(getActivity(action, timestampOfActivity, targetId, loggedInUserUtil.getLoggedInUserId()), notify, actionPropertiesOrNull, consentRequired, altActionTextPersonIds);</span>
<span class="fc" id="L307">    }</span>

    void notifySelfActivity(RequiresConsent consentRequired) {
<span class="fc" id="L310">        Long actorId = loggedInUserUtil.getLoggedInUserId();</span>
        try {
<span class="pc" id="L312">            Activity activity = getActivity(Activity.Action.ADDED_CONTACT_SELF, dateTimeService.now(), actorId, actorId).getOrElseThrow(e -&gt; e);</span>
            // Log the activity in actor account
<span class="fc" id="L314">            notificationManager.notifySelf(getEHRRequestContext(), actorId, activity, consentRequired);</span>
<span class="nc" id="L315">        } catch (MalformedURLException e1) {</span>
<span class="nc" id="L316">            LOGGER.info(&quot;Logging activity failed due to -{}&quot;, e1.getMessage(), e1);</span>
<span class="nc" id="L317">        } catch (Exception e) {</span>
<span class="nc" id="L318">            LOGGER.info(&quot;Ignoring exception-{}&quot;, e.getMessage(), e);</span>
<span class="pc" id="L319">        }</span>
<span class="fc" id="L320">    }</span>

    protected byte[] getContents(File file) throws IOException {
<span class="fc" id="L323">        return FileUtils.readFileToByteArray(file);</span>
    }

    public EHRRequestContext getEHRRequestContext() {
<span class="fc" id="L327">        return contextUtil.getEHRRequestContext(request);</span>
    }

    public LoggedInEHRRequestContext getLoggedInEHRRequestContext() {
<span class="fc" id="L331">        EHRRequestContext context = getEHRRequestContext();</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">        if (context instanceof LoggedInEHRRequestContext) {</span>
<span class="fc" id="L333">            return (LoggedInEHRRequestContext) context;</span>
        }
<span class="nc" id="L335">        throw new RuntimeException(&quot;Logged in context requested but user is not logged in&quot;);</span>
    }

    protected void applyErrors(FormValidationErrors errors) {
<span class="pc" id="L339">        errors.getGlobalErrors().forEach(err -&gt; addActionError(getText(err.getErrorCode(), err.getArguments())));</span>
<span class="fc" id="L340">        errors.getFieldErrors().forEach((fieldName, fieldErrors) -&gt;</span>
<span class="fc" id="L341">                fieldErrors.forEach(err -&gt; addFieldError(fieldName, getText(err.getErrorCode(), err.getArguments()))));</span>
<span class="fc" id="L342">    }</span>

    private void applyInfoMessages(IUIDto dto) {
<span class="fc" id="L345">        ResponseMeta responseMeta = dto.getResponseMeta();</span>
<span class="pc bpc" id="L346" title="1 of 2 branches missed.">        if (responseMeta != null) {</span>
<span class="fc" id="L347">            responseMeta.getInfoMessages().forEach(this::addActionMessage);</span>
        }
<span class="fc" id="L349">    }</span>

    private void applyWarningMessages(IUIDto dto) {
<span class="fc" id="L352">        ResponseMeta responseMeta = dto.getResponseMeta();</span>
<span class="pc bpc" id="L353" title="1 of 2 branches missed.">        if (responseMeta != null) {</span>
<span class="fc" id="L354">            responseMeta.getActionWarnings().forEach(this::addActionWarning);</span>
        }
<span class="fc" id="L356">    }</span>

    private void applyErrors(IUIDto dto) {
<span class="fc" id="L359">        ResponseMeta responseMeta = dto.getResponseMeta();</span>
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">        if (responseMeta != null) {</span>
<span class="fc" id="L361">            responseMeta.getActionErrors().forEach(this::addActionError);</span>
<span class="fc" id="L362">            responseMeta.getFieldErrors().forEach((field, errors) -&gt; errors.forEach(message -&gt; {</span>
                //noinspection StrutsI18nError,SSBasedInspection
<span class="fc" id="L364">                addFieldError(field, message);</span>
<span class="fc" id="L365">            }));</span>
        }
<span class="fc" id="L367">    }</span>

    protected String getActionResult(IUIDto dto) {
<span class="fc" id="L370">        applyInfoMessages(dto);</span>
<span class="fc" id="L371">        applyWarningMessages(dto);</span>
<span class="fc" id="L372">        applyErrors(dto);</span>
<span class="fc" id="L373">        return dto.getActionResult();</span>
    }

    protected void logActivity(Either&lt;MalformedURLException, Activity&gt; activityOrError, boolean notify, Map&lt;ActivityProperty, String&gt; actionPropertiesOrNull,
                               RequiresConsent consentRequired, Long... altActionTextPersonIds) {
        try {
<span class="pc" id="L379">            Activity activity = activityOrError.getOrElseThrow(e -&gt; e);</span>
<span class="fc" id="L380">            activity.setActionProperties(actionPropertiesOrNull);</span>
            // Log the activity in actor account
<span class="pc bpc" id="L382" title="1 of 4 branches missed.">            if (!activity.getActorId().equals(Objects.toString(activity.getTargetId(), null)) || altActionTextPersonIds.length &gt; 0) {</span>
<span class="pc bpc" id="L383" title="1 of 4 branches missed.">                if (notify &amp;&amp; activity.sendHistorical(dateTimeService.now())) {</span>
<span class="fc" id="L384">                    notificationManager.notifyUserAboutActivityByOtherUser(getEHRRequestContext(), activity, consentRequired, altActionTextPersonIds);</span>
                }
            }
<span class="nc" id="L387">        } catch (MalformedURLException e1) {</span>
<span class="nc" id="L388">            LOGGER.info(&quot;Logging activity failed due to -{}&quot;, e1.getMessage(), e1);</span>
<span class="nc" id="L389">        } catch (PKBException e) {</span>
<span class="nc" id="L390">            LOGGER.info(&quot;Ignoring exception-{}&quot;, e.getMessage(), e);</span>
<span class="pc" id="L391">        }</span>
<span class="fc" id="L392">    }</span>

    @Override
    public void setSession(Map&lt;String, Object&gt; session) {
<span class="fc" id="L396">        this.session = session;</span>
<span class="fc" id="L397">    }</span>

    @Override
    public void setServletRequest(HttpServletRequest request) {
<span class="fc" id="L401">        this.request = request;</span>
<span class="fc" id="L402">    }</span>

    public INotificationManager getNotificationManager() {
<span class="fc" id="L405">        return notificationManager;</span>
    }

    public void setNotificationManager(INotificationManager notificationManager) {
<span class="fc" id="L409">        this.notificationManager = notificationManager;</span>
<span class="fc" id="L410">    }</span>

    //TODO: SEC: lets change visibility of this method
    public HttpServletRequest getRequest() {
<span class="fc" id="L414">        return request;</span>
    }

    public HttpServletResponse getResponse() {
<span class="fc" id="L418">        return ServletActionContext.getResponse();</span>
    }

    public void setRequest(HttpServletRequest request) {
<span class="fc" id="L422">        this.request = request;</span>
<span class="fc" id="L423">    }</span>

    //TODO: SEC: lets change visibility of this method
    public Map&lt;String, Object&gt; getSession() {
<span class="fc" id="L427">        return session;</span>
    }

    /**
     * @deprecated Use {@link #parseInstant(String)}
     */
    @Deprecated
    public Date parseDate(String dateString) throws ParseException {
<span class="fc" id="L435">        return DateUtils.parseDate(dateString, acceptedDateFormats);</span>
    }

    public Instant parseInstant(String dateString) throws ParseException {
<span class="fc" id="L439">        return DateUtils.parseDate(dateString, acceptedDateFormats).toInstant();</span>
    }

    public Long getContextUserId() {
<span class="fc" id="L443">        return contextUserId;</span>
    }

    public void setContextUserId(Long contextUserId) {
<span class="fc" id="L447">        this.contextUserId = contextUserId;</span>
<span class="fc" id="L448">    }</span>

    public void setEhrRequestContextManager(EHRRequestContextManager ehrRequestContextManager) {
<span class="fc" id="L451">        this.ehrRequestContextManager = ehrRequestContextManager;</span>
<span class="fc" id="L452">    }</span>

    public final ContextUserUtil getContextUserUtil() {
<span class="fc" id="L455">        return contextUserUtil;</span>
    }

    public final void setContextUserUtil(ContextUserUtil contextUserUtil) {
<span class="fc" id="L459">        this.contextUserUtil = contextUserUtil;</span>
<span class="fc" id="L460">    }</span>

    public void setPkbWebUtil(PKBWebUtil pkbWebUtil) {
<span class="nc" id="L463">        this.pkbWebUtil = pkbWebUtil;</span>
<span class="nc" id="L464">    }</span>

    public final LoggedInUserUtil getLoggedInUserUtil() {
<span class="fc" id="L467">        return loggedInUserUtil;</span>
    }

    public final void setLoggedInUserUtil(LoggedInUserUtil loggedInUserUtil) {
<span class="fc" id="L471">        this.loggedInUserUtil = loggedInUserUtil;</span>
<span class="fc" id="L472">    }</span>

    @Override
    public void prepare() throws Exception {
<span class="fc" id="L476">    }</span>

    @SuppressWarnings(&quot;SameParameterValue&quot;)
    protected Field getActionSupportField(String name) throws Exception {
<span class="nc" id="L480">        Field field = ActionSupport.class.getDeclaredField(name);</span>

<span class="nc bnc" id="L482" title="All 2 branches missed.">        if (!field.canAccess(this)) {</span>
<span class="nc" id="L483">            field.setAccessible(true);</span>
        }

<span class="nc" id="L486">        return field;</span>
    }

    @Override
    public boolean isRequestValid() {
<span class="fc bfc" id="L491" title="All 4 branches covered.">        return getActionErrors().isEmpty() &amp;&amp; getFieldErrors().isEmpty();</span>
    }

    @Override
    public boolean isRequestNotValid() {
<span class="fc bfc" id="L496" title="All 2 branches covered.">        return !isRequestValid();</span>
    }

    protected void recordValidationErrors() {
<span class="fc" id="L500">        String clazz = this.getClass().getSimpleName();</span>
<span class="fc" id="L501">        getActionErrors().forEach(e -&gt; actionErrorCounter.labels(clazz, e).inc());</span>
<span class="fc" id="L502">        getFieldErrors().forEach((f, es) -&gt; es.forEach(e -&gt; fieldErrorCounter.labels(clazz, f, e).inc()));</span>
<span class="fc" id="L503">    }</span>

    @Override
    public void promoteFieldLevelToActionLevelError(String fieldName) {
<span class="fc" id="L507">        Map&lt;String, List&lt;String&gt;&gt; fieldErrors = getFieldErrors();</span>
<span class="pc bpc" id="L508" title="1 of 2 branches missed.">        if (fieldErrors.containsKey(fieldName)) {</span>
<span class="fc" id="L509">            List&lt;String&gt; activationErrorCodes = fieldErrors.remove(fieldName);</span>
<span class="fc" id="L510">            activationErrorCodes.forEach(errorCode -&gt; addActionError(getText(errorCode)));</span>
<span class="fc" id="L511">            setFieldErrors(fieldErrors);</span>
        }
<span class="fc" id="L513">    }</span>

    @Override
    public void weakenActionLevelErrorToFieldLevel(String errorCode, String fieldName) {
<span class="fc" id="L517">        weakenActionLevelErrorToFieldLevel(errorCode, fieldName, errorCode);</span>
<span class="fc" id="L518">    }</span>

    @Override
    public void weakenActionLevelErrorToFieldLevel(String errorCode, String fieldName, String fieldErrorCode) {
<span class="fc" id="L522">        String errorMessage = getText(errorCode);</span>
<span class="fc" id="L523">        Collection&lt;String&gt; actionErrors = getActionErrors();</span>
<span class="pc bpc" id="L524" title="2 of 4 branches missed.">        if (actionErrors.removeIf(errorCode::equals) || actionErrors.removeIf(errorMessage::equals)) {</span>
<span class="nc" id="L525">            addFieldError(fieldName, getText(fieldErrorCode));</span>
<span class="nc" id="L526">            setActionErrors(actionErrors);</span>
        }
<span class="fc" id="L528">    }</span>

    public boolean isSharingEnabled() {
<span class="fc" id="L531">        return isSharingEnabled(getEHRRequestContext());</span>
    }

    protected boolean isSharingEnabled(EHRRequestContext context) {
<span class="fc" id="L535">        return Optional.ofNullable(context)</span>
<span class="fc" id="L536">                .map(EHRRequestContext::getConsentStatus)</span>
<span class="fc" id="L537">                .map(ConsentStatus::isPatientSharingEnabled)</span>
<span class="fc" id="L538">                .orElse(true);</span>
    }

    public List&lt;ClinicianTeamDto&gt; getTeamDtoCollection() {
<span class="fc" id="L542">        Team primaryTeam = loggedInUserUtil.getLoggedInUserPrimaryTeam();</span>
<span class="fc" id="L543">        return clinicianMultipleTeamService.buildClinicianTeamDtoCollection(getUserTypeEnumMap(), primaryTeam);</span>
    }

    /*
     * ACCESSORS to wrap Upload Config (referenced through JSP)
     */

    public long getFileChunkSizeInBytes() {
<span class="fc" id="L551">        return config.getFileChunkSizeInBytes();</span>
    }

    public long getUploadMaxFileSize() {
<span class="fc" id="L555">        return config.getUploadMaxFileSize();</span>
    }

    public String getUploadMaxFileTextGB() {
<span class="fc" id="L559">        return config.getUploadMaxFileTextGB();</span>
    }

    public long getImageUploadMaxFileSize() {
<span class="fc" id="L563">        return config.getImageUploadMaxFileSize();</span>
    }

    public String getImageUploadMaxFileTextGB() {
<span class="fc" id="L567">        return config.getImageUploadMaxFileTextGB();</span>
    }

    public long getGeneticsUploadMaxFileSize() {
<span class="fc" id="L571">        return config.getGeneticsUploadMaxFileSize();</span>
    }

    public String getGeneticsUploadMaxFileTextGB() {
<span class="fc" id="L575">        return config.getGeneticsUploadMaxFileTextGB();</span>
    }

    public long getPlanUploadMaxFileSize() {
<span class="fc" id="L579">        return config.getPlanUploadMaxFileSize();</span>
    }

    public String getPlanUploadMaxFileTextMB() {
<span class="fc" id="L583">        return config.getPlanUploadMaxFileTextMB();</span>
    }

    public long getShowConversationMaxFileSize() {
<span class="fc" id="L587">        return config.getShowConversationMaxFileSize();</span>
    }

    public String getShowConversationMaxFileTextMB() {
<span class="fc" id="L591">        return config.getShowConversationMaxFileTextMB();</span>
    }

    public long getTestUploadMaxFileSize() {
<span class="fc" id="L595">        return config.getTestUploadMaxFileSize();</span>
    }

    public String getTestUploadMaxFileTextMB() {
<span class="fc" id="L599">        return config.getTestUploadMaxFileTextMB();</span>
    }

    public boolean isTestServer() {
<span class="fc" id="L603">        return config.isDisplayOfSensitiveErrorInformationEnabled();</span>
    }

    public int getHighchartsThreshold() {
<span class="fc" id="L607">        return config.getHighchartsThreshold();</span>
    }

    public boolean getUseUTCInHighcharts() {
<span class="fc" id="L611">        return config.isUseUTCInHighcharts();</span>
    }

    public int getLatestResultsInitialThreshold() {
<span class="fc" id="L615">        return config.getLatestResultsInitialThreshold();</span>
    }

    protected int getAccessLogPageSize() {
<span class="fc" id="L619">        return config.getAccessLogPageSize();</span>
    }

    public String getLabtestsonlineRefURL() {
<span class="fc" id="L623">        return config.getLabtestsonlineRefURL();</span>
    }

    public String getLabtestsonlineSearchURL() {
<span class="fc" id="L627">        return config.getLabtestsonlineSearchURL();</span>
    }

    public void setHelpPageBaseURLProvider(HelpPageBaseURLProvider helpPageBaseURLProvider) {
<span class="fc" id="L631">        this.helpPageBaseURLProvider = helpPageBaseURLProvider;</span>
<span class="fc" id="L632">    }</span>

    public String getHelpTextURL() {
<span class="fc" id="L635">        return helpPageBaseURLProvider.getHelpBaseURL();</span>
    }

    protected PhrConfig getConfig() {
<span class="fc" id="L639">        return config;</span>
    }

    public void setConfig(PhrConfig config) {
<span class="fc" id="L643">        this.config = config;</span>
<span class="fc" id="L644">    }</span>

    public void setContextUtil(ContextUtil contextUtil) {
<span class="fc" id="L647">        this.contextUtil = contextUtil;</span>
<span class="fc" id="L648">    }</span>

    public void setPkbServiceUtil(PKBServiceUtil pkbServiceUtil) {
<span class="nc" id="L651">        this.pkbServiceUtil = pkbServiceUtil;</span>
<span class="nc" id="L652">    }</span>

    public DateTimeService getDateTimeService() {
<span class="fc" id="L655">        return dateTimeService;</span>
    }

    public void setDateTimeService(DateTimeService dateTimeService) {
<span class="fc" id="L659">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L660">    }</span>

    /**
     * Use {@link EHRRequestContext#isPatient()} or any implementing class of {@link PersonRoles#isPatient()}
     *
     * @return
     */
    @Deprecated
    public boolean isLoggedInUserPatient() {
<span class="fc" id="L669">        return loggedInUserUtil.isLoggedInUserPatient();</span>
    }

    /**
     * Use {@link EHRRequestContext#isPro()} or any implementing class of {@link PersonRoles#isPro()}
     *
     * @return
     */
    @Deprecated
    public boolean isLoggedInUserProfessional() {
<span class="fc" id="L679">        return loggedInUserUtil.isLoggedInUserProfessional();</span>
    }

    @SuppressWarnings(&quot;unused&quot;)
    public boolean showHelpText() {
<span class="fc" id="L684">        return isLoggedInUserPatient();</span>
    }

    public int getAutosaveTimeoutInMilliseconds() {
<span class="fc" id="L688">        return config.getAutosaveTimeoutInMilliseconds();</span>
    }

    public void setDataPointManager(DataPointManager dataPointManager) {
<span class="fc" id="L692">        this.dataPointManager = dataPointManager;</span>
<span class="fc" id="L693">    }</span>

    public void setDateUtil(DateUtil dateUtil) {
<span class="nc" id="L696">        this.dateUtil = dateUtil;</span>
<span class="nc" id="L697">    }</span>

    public void setPersonHelper(PKBPersonHelper personHelper) {
<span class="fc" id="L700">        this.personHelper = personHelper;</span>
<span class="fc" id="L701">    }</span>

    protected String getGlobalDateInputPattern() {
<span class="nc" id="L704">        return dateUtil.getGlobalDateInputPattern(localizedTextProvider(), getLocale());</span>
    }

    protected DateTimeFormatter getGlobalDateInputFormatter() {
<span class="fc" id="L708">        return getGlobalDateInputFormatter(true);</span>
    }

    protected void logSelfActivity(Long targetId, RequiresConsent consentRequired) {
<span class="nc" id="L712">        long actorId = loggedInUserUtil.getLoggedInUserId();</span>
<span class="nc" id="L713">        Long contextUserId = contextUserUtil.getContextUserId();</span>
        try {
<span class="nc" id="L715">            Activity activity = getActivity(Activity.Action.SENT_INVITATION, dateTimeService.now(), targetId, actorId).getOrElseThrow(e -&gt; e);</span>
<span class="nc bnc" id="L716" title="All 4 branches missed.">            if (isLoggedInUserPatient() &amp;&amp; contextUserId == null) {</span>
<span class="nc" id="L717">                notificationManager.notifyCarersAboutActivityByPatient(getEHRRequestContext(), actorId, activity, consentRequired);</span>
            }
<span class="nc" id="L719">        } catch (MalformedURLException e1) {</span>
<span class="nc" id="L720">            LOGGER.info(&quot;Logging activity failed due to -{}&quot;, e1.getMessage(), e1);</span>
<span class="nc" id="L721">        }</span>
<span class="nc" id="L722">    }</span>

    protected DateTimeFormatter getGlobalDateInputFormatter(boolean lenient) {
<span class="fc" id="L725">        return getGlobalDateInputFormatter(lenient, APPLICATION_TZ);</span>
    }

    protected DateTimeFormatter getGlobalDateInputFormatter(boolean lenient, ZoneId zone) {
<span class="fc" id="L729">        return dateUtil.getGlobalDateInputFormatter(lenient, zone, localizedTextProvider(), getLocale());</span>
    }

    protected DateTimeFormatter getDateWithHHmmFormatter() {
<span class="fc" id="L733">        return getDateWithHHmmFormatter(APPLICATION_TZ);</span>
    }

    protected DateTimeFormatter getDateWithHHmmFormatter(ZoneId zoneId) {
<span class="fc" id="L737">        return dateUtil.getDateWithHHmmFormatter(zoneId, getLocale());</span>
    }

    /**
     * It returns the current date and time as formatted strings in a tuple
     *
     * @return date as first element, time as second element
     */
    protected Tuple2&lt;String, String&gt; getCurrentDateAndTime() {
<span class="fc" id="L746">        DateTimeFormatter dateFormat = getDateWithHHmmFormatter(getZoneIdOfLoggedInUser());</span>
<span class="fc" id="L747">        ZonedDateTime zonedDateTime = dateTimeService.nowZoned(getZoneIdOfLoggedInUser());</span>
<span class="fc" id="L748">        String dateTime = zonedDateTime.format(dateFormat);</span>
<span class="fc" id="L749">        String[] split = StringUtils.split(dateTime, &quot; &quot;);</span>

<span class="fc" id="L751">        return new Tuple2&lt;&gt;(split[0], split[1]);</span>
    }

    protected Instant parseToInstantWithFormatter(String input, DateTimeFormatter formatter) {
<span class="fc" id="L755">        Tuple2&lt;Instant, ParsePosition&gt; result = dateTimeService.parseToInstantBackwardCompatibleWay(input, formatter);</span>
<span class="fc" id="L756">        return result._1;</span>
    }

    protected String dateToString(Date input, DateTimeFormatter formatter) {
<span class="fc" id="L760">        return dateTimeService.dateToString(input, formatter);</span>
    }

    protected String formatDateToGlobalOutputFormat(Instant input) {
<span class="fc" id="L764">        return dateUtil.formatDateToGlobalOutputFormat(input, getLocale());</span>
    }

    protected String formatDateToGlobalOutputFormat(LocalDate input) {
<span class="nc" id="L768">        return dateUtil.formatDateToGlobalOutputFormat(input, getLocale());</span>
    }

    public ZoneId getZoneIdOfLoggedInUser() {
<span class="fc" id="L772">        return loggedInUserUtil.getLoggedInUserZoneId();</span>
    }

    protected boolean isPasswordMatchComplexityRequirements(String password) {
<span class="pc bpc" id="L776" title="1 of 4 branches missed.">        return password != null &amp;&amp; PASSWORD_COMPLEXITY_CHECKER.matcher(password).matches();</span>
    }

    @Inject
    public void setActionMapper(ActionMapper actionMapper) {
<span class="fc" id="L781">        this.actionMapper = actionMapper;</span>
<span class="fc" id="L782">    }</span>

    protected SymptomReportDTO convertToSymptomReportDto(String input, Instant reportDate) {
<span class="fc" id="L785">        return convertToSymptomReportDto(input, reportDate, null);</span>
    }

    protected SymptomReportDTO convertToSymptomReportDto(String input, Instant reportDate, PrivacyFlag privacyFlag) {
<span class="fc" id="L789">        String[] tokens = input.split(&quot;,&quot;);</span>
<span class="fc" id="L790">        Long symptomId = Long.parseLong(tokens[1]);</span>
<span class="fc" id="L791">        Integer severity = Integer.decode(tokens[0]);</span>
<span class="fc" id="L792">        SymptomReportDTO dto = new SymptomReportDTO(new SourceDetails(getEHRRequestContext()));</span>
<span class="fc" id="L793">        dto.setSymptomPrivateId(symptomId);</span>
<span class="pc bpc" id="L794" title="1 of 2 branches missed.">        if (reportDate != null) {</span>
<span class="fc" id="L795">            dto.setReportDate(reportDate);</span>
        }
<span class="fc" id="L797">        dto.setSeverity(SymptomSeverity.getBy0to3(severity));</span>
<span class="fc" id="L798">        dto.generateNewRandomUniqueId();</span>
<span class="fc bfc" id="L799" title="All 2 branches covered.">        if (privacyFlag != null) {</span>
<span class="fc" id="L800">            dto.getBaseFields().setPrivacyFlag(privacyFlag);</span>
        }

<span class="fc" id="L803">        return dto;</span>
    }

    protected void handleExcludedDataPoint(String errorMsg) {
        //TODO: PHR-4657
<span class="nc" id="L808">        throw new RuntimeException(errorMsg);</span>
    }

    protected &lt;T&gt; void handleExcludedDataPoint(List&lt;T&gt; errorMsg) {
<span class="nc bnc" id="L812" title="All 2 branches missed.">        if (isNotEmpty(errorMsg)) {</span>
            //TODO: PHR-4657
<span class="nc" id="L814">            throw new RuntimeException(&quot;Excluded data points on UI, this not supposed to happen! If it did, than exclude handlinng is needed!!&quot;);</span>
        }
<span class="nc" id="L816">    }</span>

    /**
     * Checks whether the caller is authorized to edit the provided data point.
     *
     * @return false if authorized, true otherwise
     */
    protected &lt;T extends IBaseDTO&gt; boolean hasNotPermissionsToEditDatapoint(T data, PKBPerson callerPerson, Team callerTeam) {
<span class="fc" id="L824">        DataWithUIPermissions&lt;T&gt; datapointWithPermissions = dataPointManager.getPermission(data, callerPerson, callerTeam);</span>
<span class="fc bfc" id="L825" title="All 2 branches covered.">        if (!datapointWithPermissions.isEditOrDeletable()) {</span>
<span class="fc" id="L826">            addActionError(getText(&quot;saveDatapoint.txt.noAccess&quot;));</span>
<span class="fc" id="L827">            LOGGER.error(&quot;Logged in user id [{}] can't edit data point [{}]&quot;, callerPerson.getId(), data.getId());</span>
<span class="fc" id="L828">            return true;</span>
        }
<span class="fc" id="L830">        return false;</span>
    }

    /**
     * Checks whether the caller is authorized to edit the provided data point.
     *
     * @return false if authorized, true otherwise
     */
    protected &lt;T extends IBaseDTO&gt; boolean hasNotPermissionsToEditDatapoint(T data, EHRRequestContext requestContext) {
<span class="fc" id="L839">        DataWithUIPermissions&lt;T&gt; datapointWithPermissions = dataPointManager.getPermission(data, requestContext);</span>
<span class="pc bpc" id="L840" title="1 of 2 branches missed.">        if (!datapointWithPermissions.isEditOrDeletable()) {</span>
<span class="nc" id="L841">            addActionError(getText(&quot;saveDatapoint.txt.noAccess&quot;));</span>
<span class="nc" id="L842">            LOGGER.error(&quot;Logged in user id [{}] can't edit data point [{}]&quot;, requestContext.getMaybeAccessingUserId(), data.getId());</span>
<span class="nc" id="L843">            return true;</span>
        }
<span class="fc" id="L845">        return false;</span>
    }

    /**
     * Checks whether the caller is authorized to delete the provided data point.
     *
     * @return false if authorized, true otherwise
     */
    protected &lt;T extends IBaseDTO&gt; boolean hasNotPermissionsToDeleteDatapoint(T data, PKBPerson callerPerson, Team callerTeam) {
<span class="fc" id="L854">        DataWithUIPermissions&lt;T&gt; datapointWithPermissions = dataPointManager.getPermission(data, callerPerson, callerTeam);</span>
<span class="fc bfc" id="L855" title="All 2 branches covered.">        if (!datapointWithPermissions.isEditOrDeletable()) {</span>
<span class="fc" id="L856">            addActionError(getText(&quot;saveDatapoint.txt.noAccessDelete&quot;));</span>
<span class="fc" id="L857">            LOGGER.error(&quot;Logged in user id [{}] can't delete data point [{}]&quot;, callerPerson.getId(), data.getId());</span>
<span class="fc" id="L858">            return true;</span>
        }
<span class="fc" id="L860">        return false;</span>
    }

    /**
     * Checks whether the caller is authorized to delete the provided data point.
     *
     * @return false if authorized, true otherwise
     */
    protected &lt;T extends IBaseDTO&gt; boolean hasNotPermissionsToDeleteDatapoint(T data, EHRRequestContext requestContext) {
<span class="fc" id="L869">        DataWithUIPermissions&lt;T&gt; datapointWithPermissions = dataPointManager.getPermission(data, requestContext);</span>
<span class="pc bpc" id="L870" title="1 of 2 branches missed.">        if (!datapointWithPermissions.isEditOrDeletable()) {</span>
<span class="nc" id="L871">            addActionError(getText(&quot;saveDatapoint.txt.noAccessDelete&quot;));</span>
<span class="nc" id="L872">            LOGGER.error(&quot;Logged in user id [{}] can't delete data point [{}]&quot;, requestContext.getMaybeAccessingUserId(), data.getId());</span>
<span class="nc" id="L873">            return true;</span>
        }
<span class="fc" id="L875">        return false;</span>
    }

    /**
     * Checks whether the caller is authorized to edit the privacy flags for the provided data point.
     *
     * @return false if authorized, true otherwise
     */
    protected &lt;T extends IBaseDTO&gt; boolean hasNotPermissionsToEditPrivacyLabels(T data, PKBPerson callerPerson, Team callerTeam) {
<span class="fc" id="L884">        DataWithUIPermissions&lt;T&gt; datapointWithPermissions = dataPointManager.getPermission(data, callerPerson, callerTeam);</span>
<span class="pc bpc" id="L885" title="1 of 2 branches missed.">        if (!datapointWithPermissions.isPrivacyFlagEditable()) {</span>
<span class="nc" id="L886">            addActionError(getText(&quot;saveDatapoint.txt.noAccessPrivacyFlags&quot;));</span>
<span class="nc" id="L887">            LOGGER.error(&quot;Logged in user id [{}] can't edit the privacy flags for data point [{}]&quot;, callerPerson.getId(), data.getId());</span>
<span class="nc" id="L888">            return true;</span>
        }
<span class="fc" id="L890">        return false;</span>
    }

    /**
     * Checks whether the caller is authorized to edit the privacy flags for the provided data point.
     *
     * @return false if authorized, true otherwise
     */
    protected &lt;T extends IBaseDTO&gt; boolean hasNotPermissionsToEditPrivacyLabels(T data, EHRRequestContext requestContext) {
<span class="fc" id="L899">        DataWithUIPermissions&lt;T&gt; datapointWithPermissions = dataPointManager.getPermission(data, requestContext);</span>
<span class="pc bpc" id="L900" title="1 of 2 branches missed.">        if (!datapointWithPermissions.isPrivacyFlagEditable()) {</span>
<span class="nc" id="L901">            addActionError(getText(&quot;saveDatapoint.txt.noAccessPrivacyFlags&quot;));</span>
<span class="nc" id="L902">            LOGGER.error(&quot;Logged in user id [{}] can't edit the privacy flags for data point [{}]&quot;, requestContext.getMaybeAccessingUserId(), data.getId());</span>
<span class="nc" id="L903">            return true;</span>
        }
<span class="fc" id="L905">        return false;</span>
    }

    /**
     * For accessing patient accounts w/o using the contextUserId flow -- e.g., team coord re-sending patient invitation.
     *
     * @return ctx based on the main request ctx (same correlation ID!) tweaked to access this patient via this team (nullable)
     */
    public LoggedInEHRRequestContext getEHRRequestContextSingleAccess(long patientId, @Nullable Team team) {
        // get main ctx so we can re-use the access route and correlation ID
<span class="fc" id="L915">        LoggedInEHRRequestContext mainCtx = getLoggedInEHRRequestContext();</span>
<span class="fc" id="L916">        PersonAuthInfo loggedInUser = mainCtx.getAccessingUser();</span>
<span class="pc bpc" id="L917" title="2 of 4 branches missed.">        switch (loggedInUser.getUserType()) {</span>
            case REG_CLINICIAN:
<span class="fc bfc" id="L919" title="All 2 branches covered.">                if (team == null) {</span>
<span class="fc" id="L920">                    return ehrRequestContextManager.createEHRRequestContextForIndividualClinician(</span>
<span class="fc" id="L921">                            loggedInUser, patientId, mainCtx.getCorrelationId(), mainCtx.getAccessRoute());</span>
                }
            case INSTITUTE_ADMIN:
            case SUPER_ADMIN:
            case EMPLOYEE:
<span class="pc bpc" id="L926" title="1 of 2 branches missed.">                if (team == null) {</span>
<span class="nc" id="L927">                    throw new IllegalStateException(&quot;Cannot create context for team clinician as the team parameter is null.&quot;);</span>
                }
<span class="fc" id="L929">                return ehrRequestContextManager.createEHRRequestContextForTeamClinician(</span>
<span class="fc" id="L930">                        loggedInUser, team, patientId, mainCtx.getCorrelationId(), mainCtx.getAccessRoute(), false/*breakTheGlassActive*/);</span>
            case PATIENT:
<span class="nc" id="L932">                throw new IllegalArgumentException(&quot;Not yet impl&quot;);</span>
            default:
<span class="nc" id="L934">                throw new IllegalArgumentException(&quot;Not yet impl&quot;);</span>
        }
    }

    /**
     * Returns a {@link DecimalFormat} object based on the current locale
     *
     * @return decimalFormat
     */
    protected final @NotNull DecimalFormat getLocalizedDecimalFormat() {
<span class="fc" id="L944">        NumberFormat numberFormat = NumberFormat.getNumberInstance(getLocale());</span>
<span class="fc" id="L945">        DecimalFormat decimalFormat = (DecimalFormat) numberFormat;</span>
<span class="fc" id="L946">        decimalFormat.applyPattern(DECIMAL_FORMAT_PATTERN);</span>
<span class="fc" id="L947">        return decimalFormat;</span>
    }

    public LocalDate parseDOB(String year, String month, String day) {
<span class="fc" id="L951">        return parseDOB(year + &quot;-&quot; + month + &quot;-&quot; + day);</span>
    }

    protected LocalDate parseDOB(String dob) {
<span class="fc" id="L955">        return LocalDate.parse(dob, DOB_VALIDATOR_FORMATTER);</span>
    }

    /**
     * Handles the case when Struts sends a false instead of empty collection. STRUTS ODDITY: if it's a list with none-selected, we get a
     * list with single &quot;false&quot; list entry.
     *
     * @param input a {@link List} to check.
     * @return &lt;code&gt;true&lt;/code&gt; when input is null or one element collection with &quot;false&quot; as the only element in it, &lt;code&gt;false&lt;/code&gt;
     * otherwise.
     */
    protected boolean isEmptyStrutsInput(List&lt;String&gt; input) {
<span class="pc bpc" id="L967" title="1 of 6 branches missed.">        return (input == null) || ((input.size() == 1) &amp;&amp; &quot;false&quot;.equals(input.get(0)));</span>
    }

    protected DateTimeFormatter getDateAtTimeOutputFormatter() {
<span class="fc" id="L971">        return dateUtil.getDateAtTimeOutputFormatter(localizedTextProvider(), getLocale());</span>
    }

    @Value.Immutable
    @Value.Style(allParameters = true)
    public interface Users {
        PKBPerson contextUser();

        PKBPerson loggedInUser();
    }

    /**
     * Save on database trips and retrieve the {@link PKBPerson} of the context user and
     * the {@link PKBPerson} of the logged in user at the same time for methods that use
     * both and would normally set the context user to be the logged in user if the
     * former is null.
     *
     * @param loggedInUserLazies The additional data to fetch for the logged in user
     * @return An object with named fields for the context user {@link PKBPerson} and the logged in user {@link PKBPerson}
     */
    protected Users getContextAndLoggedInUsers(PKBPerson.Lazy... loggedInUserLazies) {
<span class="fc" id="L992">        return getContextAndLoggedInUsers(getLoggedInEHRRequestContext(), loggedInUserLazies);</span>
    }

    protected Users getContextAndLoggedInUsers(LoggedInEHRRequestContext context, PKBPerson.Lazy... loggedInUserLazies) {
<span class="fc" id="L996">        var personByIdMap = userManager.getPKBPersonMapById(context.getContextAndAccessingUserIds(), loggedInUserLazies);</span>
<span class="fc" id="L997">        return ImmutableUsers.of(personByIdMap.get(context.getContextOrAccessingUserId()), personByIdMap.get(context.getAccessingUserId()));</span>
    }

    public Map&lt;String, String&gt; getGenderMap() {
<span class="fc" id="L1001">        return genderStringLocalizationHelper.computeMap(getLocale(), localizedTextProvider());</span>
    }

    public Map&lt;String, String&gt; getLimitedGenderMap() {
<span class="fc" id="L1005">        return genderLimitedStringLocalizationHelper.computeMap(getLocale(), localizedTextProvider());</span>
    }

    private BiFunction&lt;String, Locale, String&gt; localizedTextProvider() {
<span class="fc" id="L1009">        return (s, l) -&gt; getText(s);</span>
    }

    public Map&lt;Gender, String&gt; getGenderEnumMap() {
<span class="fc" id="L1013">        return genderLocalizationHelper.computeMap(getLocale(), localizedTextProvider());</span>
    }

    public Map&lt;String, String&gt; getMonthMapWithShortKeys() {
<span class="fc" id="L1017">        return monthMapShortKeyLocalizationHelper.computeMap(getLocale(), localizedTextProvider());</span>
    }

    public Map&lt;UserType, String&gt; getUserTypeEnumMap() {
<span class="fc" id="L1021">        return userTypeLocalizationHelper.computeMap(getLocale(), localizedTextProvider());</span>
    }

    public String getAutocompleteValue() {
<span class="fc" id="L1025">        UserAgent userAgent = userAgentAnalyzerBean.getUserAgent(request);</span>
<span class="pc bpc" id="L1026" title="1 of 2 branches missed.">        if (userAgentAnalyzerBean.isChromeAndVersionEqualOrNewerThan(userAgent, 82) ||</span>
<span class="pc bpc" id="L1027" title="1 of 2 branches missed.">                userAgentAnalyzerBean.isSafari(userAgent)) {</span>
<span class="nc" id="L1028">            return &quot;chrome-off&quot;;</span>
        } else {
<span class="fc" id="L1030">            return &quot;off&quot;;</span>
        }
    }

    public List&lt;String&gt; getDaysForLocale() {
<span class="fc" id="L1035">        return pkbWebUtil.getDays(getLocale());</span>
    }

    public List&lt;Map.Entry&lt;String, String&gt;&gt; getCountriesForLocale() {
<span class="fc" id="L1039">        return pkbServiceUtil.getCountries(getLocale());</span>
    }

    public Map&lt;String, String&gt; getCountriesMapForLocale() {
<span class="fc" id="L1043">        return pkbServiceUtil.getCountriesMap(getLocale());</span>
    }

    public List&lt;String&gt; getYearsForLocale() {
<span class="fc" id="L1047">        return pkbWebUtil.getYears(getLocale());</span>
    }

    public Map&lt;Long, String&gt; getSpecialtiesForLocale() {
<span class="fc" id="L1051">        return pkbWebUtil.getSpecialties(getLocale());</span>
    }

    public Map&lt;String, String&gt; getTimeZonesForLocale() {
<span class="fc" id="L1055">        return pkbWebUtil.getTimeZones(getLocale());</span>
    }

    @SuppressWarnings(&quot;unused&quot;)
    public Map&lt;Long, String&gt; getOrgsForLocale(boolean includeCreateOption) {
<span class="fc" id="L1060">        return pkbWebUtil.getOrgs(includeCreateOption, getLocale());</span>
    }

    @SuppressWarnings(&quot;unused&quot;)
    public Map&lt;Long, String&gt; getTeamsForOrg(Org org) {
<span class="fc" id="L1065">        return pkbWebUtil.getTeamsForOrg(org);</span>
    }

    public Map&lt;String, String&gt; getPatientIdSupportOptions() {
<span class="fc" id="L1069">        return pkbWebUtil.getPatientIdSupportOptions(getLocale());</span>
    }

    protected final @NotNull String makeUrl(@NotNull String actionName, String namespace, Map&lt;String, String&gt; params) {
        try {
<span class="fc" id="L1074">            ActionMapping mapping = actionMapper.getMappingFromActionName(actionName);</span>
<span class="fc" id="L1075">            mapping.setNamespace(namespace);</span>
<span class="fc" id="L1076">            URIBuilder builder = new URIBuilder(actionMapper.getUriFromActionMapping(mapping));</span>
<span class="fc" id="L1077">            params.entrySet().stream()</span>
<span class="pc bpc" id="L1078" title="1 of 2 branches missed.">                    .filter(param -&gt; !param.getValue().isEmpty())</span>
<span class="fc" id="L1079">                    .forEach(param -&gt; builder.setParameter(param.getKey(), param.getValue()));</span>

<span class="fc" id="L1081">            return builder.toString();</span>
<span class="nc" id="L1082">        } catch (URISyntaxException e) {</span>
<span class="nc" id="L1083">            throw new RuntimeException(e);</span>
        }
    }

    protected EmisContextHolder getEmisContextHolder() {
<span class="fc" id="L1088">        var users = getContextAndLoggedInUsers();</span>
<span class="fc" id="L1089">        return ImmutableEmisContextHolder.builder()</span>
<span class="fc" id="L1090">                .personId(users.contextUser().getId())</span>
<span class="fc" id="L1091">                .accountId(users.contextUser().getDefaultAccountId())</span>
<span class="fc" id="L1092">                .actorPersonId(loggedInUserUtil.getLoggedInUserId())</span>
<span class="fc" id="L1093">                .build();</span>
    }

    public boolean isNhsLoginSession() {
<span class="fc bfc" id="L1097" title="All 2 branches covered.">        return request.getSession().getAttribute(NHS_LOGIN_CORRELATION_ID) != null;</span>
    }

    public GenderStringLocalizationHelper getGenderStringLocalizationHelper() {
<span class="fc" id="L1101">        return genderStringLocalizationHelper;</span>
    }

    public void setGenderStringLocalizationHelper(GenderStringLocalizationHelper genderStringLocalizationHelper) {
<span class="fc" id="L1105">        this.genderStringLocalizationHelper = genderStringLocalizationHelper;</span>
<span class="fc" id="L1106">    }</span>

    public GenderLimitedStringLocalizationHelper getGenderLimitedStringLocalizationHelper() {
<span class="fc" id="L1109">        return genderLimitedStringLocalizationHelper;</span>
    }

    public void setGenderLimitedStringLocalizationHelper(GenderLimitedStringLocalizationHelper genderLimitedStringLocalizationHelper) {
<span class="fc" id="L1113">        this.genderLimitedStringLocalizationHelper = genderLimitedStringLocalizationHelper;</span>
<span class="fc" id="L1114">    }</span>

    public GenderLocalizationHelper getGenderLocalizationHelper() {
<span class="fc" id="L1117">        return genderLocalizationHelper;</span>
    }

    public void setGenderLocalizationHelper(GenderLocalizationHelper genderLocalizationHelper) {
<span class="fc" id="L1121">        this.genderLocalizationHelper = genderLocalizationHelper;</span>
<span class="fc" id="L1122">    }</span>

    public MonthMapShortKeyLocalizationHelper getMonthMapShortKeyLocalizationHelper() {
<span class="fc" id="L1125">        return monthMapShortKeyLocalizationHelper;</span>
    }

    public void setMonthMapShortKeyLocalizationHelper(MonthMapShortKeyLocalizationHelper monthMapShortKeyLocalizationHelper) {
<span class="fc" id="L1129">        this.monthMapShortKeyLocalizationHelper = monthMapShortKeyLocalizationHelper;</span>
<span class="fc" id="L1130">    }</span>

    public String getCustomStyle() {
<span class="fc" id="L1133">        return NO_CUSTOM_STYLE;</span>
    }

    public String getFooterCustomStyle() {
<span class="fc bfc" id="L1137" title="All 2 branches covered.">        return sessionUtil.renderNhsFooter() ? NHS_STYLE : NO_CUSTOM_STYLE;</span>
    }

    public ImmutableFooterConfigDto getFooterConfig() {
<span class="fc" id="L1141">        return ImmutableFooterConfigDto.builder()</span>
<span class="fc" id="L1142">                .cookiePolicyTextWithLink(getText(&quot;main.txt.nhs.cookies&quot;, new String[]{config.getPKBManualCookiePolicyURL()}))</span>
<span class="fc" id="L1143">                .privacyNoticeUrl(config.getPKBPrivacyManualURLUK())</span>
<span class="fc" id="L1144">                .userAgreementUrl(config.getPKBManualLegalUserAgreementURL())</span>
<span class="fc" id="L1145">                .accessibilityStatementUrl(config.getPKBManualAccessibilityURL())</span>
<span class="fc" id="L1146">                .build();</span>
    }

    public String getNhsAppPage() {
<span class="fc" id="L1150">        return nhsAppPage;</span>
    }

    public void setNhsAppPage(String nhsAppPage) {
<span class="fc" id="L1154">        this.nhsAppPage = nhsAppPage;</span>
<span class="fc" id="L1155">    }</span>

    public String getNhsAppApi() {
<span class="fc" id="L1158">        return config.getNhsAppApi();</span>
    }

    public String getNhsAppServerFakeHost() {
<span class="fc" id="L1162">        return config.getNhsAppServerFakeHost();</span>
    }

    public boolean isShowSocialCare() {
<span class="fc" id="L1166">        return isSocialCareVisibile(true);</span>
    }

    protected boolean isSocialCareVisibile(boolean requireExplicitConsent) {
<span class="fc" id="L1170">        PKBPerson patient = loggedInUserUtil.getContextOrAccessingUser(getLoggedInEHRRequestContext());</span>
<span class="fc" id="L1171">        return isSocialCareVisibile(patient, requireExplicitConsent);</span>
    }

    protected boolean isSocialCareVisibile(PKBPerson person, boolean requireExplicitConsent) {
<span class="fc" id="L1175">        boolean socialCareConsentGranted = getEHRRequestContext().getConsentStatus().getConsent()</span>
<span class="fc bfc" id="L1176" title="All 2 branches covered.">                .map(PatientConsentDTO::socialCareConsentGranted)</span>
<span class="fc" id="L1177">                .orElse(!requireExplicitConsent);</span>

<span class="fc bfc" id="L1179" title="All 2 branches covered.">        return socialCareConsentGranted</span>
<span class="fc bfc" id="L1180" title="All 2 branches covered.">                &amp;&amp; config.isSocialCareFeatureEnabled()</span>
<span class="fc bfc" id="L1181" title="All 2 branches covered.">                &amp;&amp; userManager.canViewSocialCareData(person);</span>
    }

    public String getSupportCode() {
<span class="fc" id="L1185">        return supportCodeGenerator.getSupportCode(getEHRRequestContext());</span>
    }

    public boolean validateMeasurement(PredefinedMeasurementType type, String value, String value2, String actionPrefix) {
<span class="fc" id="L1189">        String validationError = type.getType().getValidationError(value, value2);</span>
<span class="fc bfc" id="L1190" title="All 2 branches covered.">        if (StringUtils.isNotBlank(validationError)) {</span>
<span class="fc" id="L1191">            addActionError(getText(actionPrefix + validationError, new String[]{quoteMeasurementName(type)}));</span>
<span class="fc" id="L1192">            return false;</span>
        }
<span class="fc" id="L1194">        return true;</span>
    }

    /**
     * Validates the format of the given date and time strings and checks if the parsed ZonedDateTime is not in the future
     * otherwise adds a field error to the given field.
     *
     * @param dateFieldNameToValueString the date field name to add the field error to based on the error type and the
     *                                   date string to validate likely coming from user input
     * @param timeFieldNameToValueString the time field name to add the field error to based on the error type and the
     *                                   time string to validate together with the date field likely coming from user input
     * @return the ZonedDateTime parsed from the given strings or null on validation error
     */
    @Nullable
    protected ZonedDateTime getDateTimeNotInPastOrAddFieldError(Pair&lt;String, String&gt; dateFieldNameToValueString,
                                                                Pair&lt;String, String&gt; timeFieldNameToValueString) {
<span class="fc" id="L1210">        DateTimeFormatter dateTimeFormat = getDateWithHHmmFormatter(getZoneIdOfLoggedInUser());</span>
<span class="fc" id="L1211">        ZonedDateTime zonedDateTime = null;</span>
        try {
<span class="fc" id="L1213">            zonedDateTime = ZonedDateTime.parse(trimToEmpty(dateFieldNameToValueString.getRight()) + &quot; &quot; +</span>
<span class="fc" id="L1214">                    trimToEmpty(timeFieldNameToValueString.getRight()), dateTimeFormat);</span>
<span class="fc" id="L1215">        } catch (DateTimeParseException ignored) {</span>
<span class="fc" id="L1216">            addFieldError(dateFieldNameToValueString.getLeft(), getText(&quot;global.err.enter_valid_date&quot;));</span>
            //noinspection StrutsI18nError,SSBasedInspection
<span class="fc" id="L1218">            addFieldError(timeFieldNameToValueString.getLeft(), EMPTY);</span>
<span class="fc" id="L1219">            return null;</span>
<span class="fc" id="L1220">        }</span>

<span class="fc bfc" id="L1222" title="All 2 branches covered.">        if (zonedDateTime.isAfter(dateTimeService.nowZonedDateTime())) {</span>
<span class="fc" id="L1223">            addFieldError(dateFieldNameToValueString.getLeft(), getText(&quot;global.err.date_must_be_past&quot;));</span>
            //noinspection StrutsI18nError,SSBasedInspection
<span class="fc" id="L1225">            addFieldError(timeFieldNameToValueString.getLeft(), EMPTY);</span>
<span class="fc" id="L1226">            return null;</span>
        }
<span class="fc" id="L1228">        return zonedDateTime;</span>
    }

    private String quoteMeasurementName(PredefinedMeasurementType type) {
<span class="fc" id="L1232">        return &quot;\&quot;&quot; + getText(type.getType().displayName()) + &quot;\&quot;&quot;;</span>
    }

    public String getSupportUrl() {
<span class="fc" id="L1236">        return config.getSupportNewTicketUrl();</span>
    }

    // To feed to terms-and-conditions.tagx
    public TermsAndConditionsConfigDTO buildTermsAndConditionsConfig() {
<span class="fc" id="L1241">        return ImmutableTermsAndConditionsConfigDTO.builder()</span>
<span class="fc" id="L1242">                .isShowNHSTermsAndConditions(config.isShowNhsTermsAndConditions())</span>
<span class="fc" id="L1243">                .pkbManualURL(config.getPKBManualURL())</span>
<span class="fc" id="L1244">                .pkbPrivacyManualURLUK(config.getPKBPrivacyManualURLUK())</span>
<span class="fc" id="L1245">                .pkbPrivacyManualURLEU(config.getPKBPrivacyManualURLEU())</span>
<span class="fc" id="L1246">                .pkbPrivacyManualURLIN(config.getPKBPrivacyManualURLIN())</span>
<span class="fc" id="L1247">                .nhsAppPrivacyNoticeURL(config.getNHSAppPrivacyNoticeURL())</span>
<span class="fc" id="L1248">                .nhsLoginTermsAndConditionsURL(config.getNHSLoginTermsAndConditionsURL())</span>
<span class="fc" id="L1249">                .pkbManualBTGURL(config.getPKBManualBTGURL())</span>
<span class="fc" id="L1250">                .pkbManualLegalComplaintsURL(config.getPKBManualLegalComplaintsURL())</span>
<span class="fc" id="L1251">                .pkbManualLegalPrivacyURL(config.getPKBManualLegalPrivacyURL())</span>
<span class="fc" id="L1252">                .pkbManualLegalUserAgreementURL(config.getPKBManualLegalUserAgreementURL())</span>
<span class="fc" id="L1253">                .pkbManualPODisableSharingURL(config.getPKBManualPODisableSharingURL())</span>
<span class="fc" id="L1254">                .pkbIGAgreementsJCAURL(config.getPKBIGAgreementsJCAURL())</span>
<span class="fc" id="L1255">                .nhsIGAgreementsJCAURL(config.getNHSIGAgreementsJCAURL())</span>
<span class="fc" id="L1256">                .breakdownOfOrganisationsURL(config.getBreakdownOfOrganisationsURL())</span>
<span class="fc" id="L1257">                .pkbDPOName(config.getPKBDPOName())</span>
<span class="fc" id="L1258">                .pkbDPOEmail(config.getPKBDPOEmail())</span>
<span class="fc" id="L1259">                .pkbDPOAddress(config.getPKBDPOAddress())</span>
<span class="fc" id="L1260">                .pkbContactUsURL(config.getPKBContactUsURL())</span>
<span class="fc" id="L1261">                .pkbHelpEmail(config.getPKBHelpEmail())</span>
<span class="fc" id="L1262">                .pkbPrivacyNoticeVersion(config.getPKBPrivacyNoticeVersion())</span>
<span class="fc" id="L1263">                .pkbPrivacyNoticeUpdated(config.getPKBPrivacyNoticeUpdated())</span>
<span class="fc" id="L1264">                .pkbRegisteredOfficeAddress(config.getPKBRegisteredOfficeAddress())</span>
<span class="fc" id="L1265">                .pkbStatusURL(config.getPKBStatusURL())</span>
<span class="fc" id="L1266">                .pkbSupportURL(config.getPKBSupportURL())</span>
<span class="fc" id="L1267">                .pkbUserAgreementUpdated(config.getPKBUserAgreementUpdated())</span>
<span class="fc" id="L1268">                .pkbWebsiteURL(config.getPKBWebsiteURL())</span>
<span class="fc" id="L1269">                .icoComplaintURL(config.getICOComplaintURL())</span>
<span class="fc" id="L1270">                .dutchComplaintURL(config.getDutchComplaintURL())</span>
<span class="fc" id="L1271">                .pkbIGURL(config.getPKBIGURL())</span>
<span class="fc" id="L1272">                .youtubeIsPKBSafeURL(config.getYoutubeIsPKBSafeURL())</span>
<span class="fc" id="L1273">                .nhsDataProcessingContractTemplateURL(config.getNHSDataProcessingContractTemplateURL())</span>
<span class="fc" id="L1274">                .pkbPreviousPrivacyNoticeURL(config.getPKBPreviousPrivacyNoticeURL())</span>
<span class="fc" id="L1275">                .pkbRegion(config.getPKBRegion())</span>
<span class="fc" id="L1276">                .build();</span>
    }

    public String getBaseURL() {
<span class="nc" id="L1280">        return config.getBaseURL();</span>
    }

    public String getHelpEmailURL() {
<span class="fc" id="L1284">        return config.getPKBHelpEmail();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>