<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CompleteResetCredentialsAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action</a> &gt; <span class="el_source">CompleteResetCredentialsAction.java</span></div><h1>CompleteResetCredentialsAction.java</h1><pre class="source lang-java linenums">package com.pkb.action;

import com.opensymphony.xwork2.Action;
import com.pkb.datamodel.Email;
import com.pkb.entities.enums.UserStatus;
import com.pkb.exception.PKBException;
import com.pkb.model.PKBSecurityQuestion;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;
import java.util.List;

<span class="fc" id="L17">public class CompleteResetCredentialsAction extends BaseAction {</span>

    private static final long serialVersionUID = 1L;

    private Long uid;

    private String resetCode;

    private String password;

    private String confirmPassword;

    private String securityQuestion;

    private String answer1;

    /**
     * used to pre-populate the email address for the login page
     */
    private String email;

    /**
     * for sending created patients to patient registration page with a chained action
     */
    private String icode;
    private String temp;
    private boolean securityInfoSet;

    private List&lt;PKBSecurityQuestion&gt; securityQuestions;

    private TeamUserManager teamUserManager;

<span class="fc" id="L49">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    @Override
    public String execute() {
<span class="fc" id="L53">        LOGGER.info(&quot;enter execute&quot;);</span>
<span class="fc" id="L54">        String result = SUCCESS;</span>

        // make sure id is valid
<span class="fc" id="L57">        PKBPerson person = userManager.getPKBPerson(uid, PKBPerson.Lazy.CONTACTS);</span>
<span class="pc bpc" id="L58" title="1 of 2 branches missed.">        if (person == null) {</span>
<span class="nc" id="L59">            addActionError(getText(&quot;completeResetCredentialsAction.err.invalid_reset_link&quot;));</span>
<span class="nc" id="L60">            return INPUT;</span>
        } else {
<span class="fc" id="L62">            email = person.findEmail().map(Email::address).getOrNull();</span>
        }

<span class="pc bpc" id="L65" title="1 of 2 branches missed.">        if (person.getStatus() == UserStatus.CREATED) {</span>
<span class="nc" id="L66">            addActionError(getText(&quot;completeResetCredentialsAction.err.complete_process_to_activate&quot;));</span>
<span class="nc" id="L67">            return INPUT;</span>
        }

<span class="pc bpc" id="L70" title="1 of 2 branches missed.">        if (!teamUserManager.isUserCredentialsResetPending(uid)) {</span>
<span class="nc" id="L71">            addActionError(getText(&quot;completeResetCredentialsAction.err.reset_in_progress&quot;));</span>
<span class="nc" id="L72">            return INPUT;</span>
        }
        try {
<span class="fc" id="L75">            teamUserManager.beginTransaction();</span>
<span class="fc" id="L76">            teamUserManager.completeResetUserCredentials(uid, resetCode, password,</span>
                    securityQuestion, answer1);
<span class="fc" id="L78">            teamUserManager.commitTransaction();</span>

<span class="fc" id="L80">            addActionMessage(getText(&quot;completeResetCredentialsAction.txt.password_reset&quot;));</span>
<span class="nc" id="L81">        } catch (PKBException e) {</span>
<span class="nc" id="L82">            result = INPUT;</span>
<span class="nc" id="L83">            addActionError(getText(&quot;completeResetCredentialsAction.err.error_resetting&quot;));</span>
<span class="nc" id="L84">            LOGGER.error(&quot;Error while resetting password&quot;, e);</span>
        } finally {
<span class="fc" id="L86">            teamUserManager.rollbackIfNotCommitted();</span>
        }

        try {
            // trying to login user after password reset
<span class="fc" id="L91">            LOGGER.info(&quot;Trying to login user-{} after password reset&quot;, uid);</span>
<span class="fc" id="L92">            userManager.authenticateUser(uid, password);</span>
<span class="nc" id="L93">        } catch (PKBException e) {</span>
<span class="nc" id="L94">            LOGGER.info(&quot;Error while logging out user-{} after password reset&quot;, uid, e);</span>
<span class="fc" id="L95">        }</span>

<span class="fc" id="L97">        LOGGER.info(&quot;exit execute&quot;);</span>
<span class="fc" id="L98">        return result;</span>
    }

    @Override
    public String input() {
<span class="fc" id="L103">        LOGGER.info(&quot;enter input()&quot;);</span>

<span class="fc" id="L105">        PKBPerson person = userManager.getPKBPerson(uid, PKBPerson.Lazy.CONTACTS);</span>

<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        if (person == null) {</span>
<span class="nc" id="L108">            addActionError(getText(&quot;completeResetCredentialsAction.err.invalid_reset_link&quot;));</span>
<span class="nc" id="L109">            return INPUT;</span>
        }

<span class="pc bpc" id="L112" title="1 of 2 branches missed.">        if (person.getStatus() == UserStatus.CREATED) {</span>
<span class="nc" id="L113">            addActionError(getText(&quot;completeResetCredentialsAction.err.complete_process_to_activate&quot;));</span>
<span class="nc" id="L114">            return INPUT;</span>
        }

<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if (!teamUserManager.isUserCredentialsResetPending(uid)) {</span>
<span class="nc" id="L118">            addActionError(getText(&quot;completeResetCredentialsAction.err.reset_in_progress&quot;));</span>
<span class="nc" id="L119">            return INPUT;</span>
        }

        // check that resetCode and uid are valid?

        //    	uid = servletRequest.getParameter(&quot;uid&quot;);
        //    	instituteId = servletRequest.getParameter(&quot;iid&quot;);
        //    	adminUserId = servletRequest.getParameter(&quot;adminid&quot;);

<span class="fc" id="L128">        LOGGER.info(&quot;exit input()&quot;);</span>
<span class="fc" id="L129">        return Action.SUCCESS;</span>
    }

    @Override
    public void validate() {
<span class="fc" id="L134">        LOGGER.info(&quot;enter validate()&quot;);</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">        if (this.securityQuestion != null) {</span>
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">            if (&quot;-1&quot;.equals(this.securityQuestion.trim())) {</span>
<span class="nc" id="L137">                addFieldError(&quot;securityQuestion&quot;,</span>
<span class="nc" id="L138">                        getText(&quot;completeResetCredentialsAction.err.select_security_question&quot;));</span>
            }
        }

<span class="pc bpc" id="L142" title="3 of 6 branches missed.">        if ((answer1 == null) || ((answer1.trim() != null) &amp;&amp; answer1.trim().isEmpty())) {</span>
<span class="nc" id="L143">            LOGGER.info(&quot;Entering Reset Password Security Info Action validate-answer1 empty&quot;);</span>
<span class="nc" id="L144">            addFieldError(&quot;answer1&quot;,</span>
<span class="nc" id="L145">                    getText(&quot;completeResetCredentialsAction.err.answer_security_question&quot;));</span>
        }

<span class="pc bpc" id="L148" title="1 of 2 branches missed.">        if (!isPasswordMatchComplexityRequirements(password)) {</span>
<span class="nc" id="L149">            addFieldError(&quot;password&quot;, getText(&quot;completeResetCredentialsAction.err.password.weak.message&quot;));</span>
        }

<span class="pc bpc" id="L152" title="1 of 2 branches missed.">        if (!password.equals(confirmPassword)) {</span>
<span class="nc" id="L153">            addFieldError(&quot;confirmPassword&quot;, getText(&quot;completeResetCredentialsAction.err.passwords_not_match&quot;));</span>
        }
        // TODO  missing resetCode?  uid?
        // this IS a request from the user's email, so values may be missing or truncated!
<span class="fc" id="L157">    }</span>

    public List&lt;PKBSecurityQuestion&gt; getSecurityQuestions() {
        try {
<span class="fc" id="L161">            securityQuestions = pkbWebUtil.getSecretQuestions(getLocale());</span>
<span class="nc" id="L162">        } catch (Exception e) {</span>
<span class="nc" id="L163">            securityQuestions = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L164">            addFieldError(&quot;securityQuestion&quot;, getText(&quot;completeResetCredentialsAction.err.error_loading_questions&quot;));</span>
<span class="nc" id="L165">            LOGGER.error(&quot;unable to load security questions&quot;, e);</span>
<span class="fc" id="L166">        }</span>
<span class="fc" id="L167">        return securityQuestions;</span>
    }

    public void setSecurityQuestions(List&lt;PKBSecurityQuestion&gt; securityQuestions) {
<span class="nc" id="L171">        this.securityQuestions = securityQuestions;</span>
<span class="nc" id="L172">    }</span>

    public String getSecurityQuestion() {
<span class="nc" id="L175">        return securityQuestion;</span>
    }

    public void setSecurityQuestion(String securityQuestion) {
<span class="fc" id="L179">        this.securityQuestion = securityQuestion;</span>
<span class="fc" id="L180">    }</span>

    public String getAnswer1() {
<span class="fc" id="L183">        return answer1;</span>
    }

    public void setAnswer1(String answer1) {
<span class="fc" id="L187">        this.answer1 = answer1;</span>
<span class="fc" id="L188">    }</span>

    public String getPassword() {
<span class="fc" id="L191">        return password;</span>
    }

    public void setPassword(String password) {
<span class="fc" id="L195">        this.password = password;</span>
<span class="fc" id="L196">    }</span>

    public String getConfirmPassword() {
<span class="nc" id="L199">        return confirmPassword;</span>
    }

    public void setConfirmPassword(String confirmPassword) {
<span class="fc" id="L203">        this.confirmPassword = confirmPassword;</span>
<span class="fc" id="L204">    }</span>

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L207">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L208">    }</span>

    public Long getUid() {
<span class="fc" id="L211">        return uid;</span>
    }

    public void setUid(Long uid) {
<span class="fc" id="L215">        this.uid = uid;</span>
<span class="fc" id="L216">    }</span>

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L219">        this.userManager = userManager;</span>
<span class="fc" id="L220">    }</span>

    public String getResetCode() {
<span class="fc" id="L223">        return resetCode;</span>
    }

    public void setResetCode(String resetCode) {
<span class="fc" id="L227">        this.resetCode = resetCode;</span>
<span class="fc" id="L228">    }</span>

    public String getEmail() {
<span class="fc" id="L231">        return email;</span>
    }

    public String getIcode() {
<span class="nc" id="L235">        return icode;</span>
    }

    public void setIcode(String icode) {
<span class="nc" id="L239">        this.icode = icode;</span>
<span class="nc" id="L240">    }</span>

    public String getTemp() {
<span class="nc" id="L243">        return temp;</span>
    }

    public boolean isSecurityInfoSet() {
<span class="nc" id="L247">        return securityInfoSet;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>