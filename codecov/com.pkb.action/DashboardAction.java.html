<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DashboardAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action</a> &gt; <span class="el_source">DashboardAction.java</span></div><h1>DashboardAction.java</h1><pre class="source lang-java linenums">package com.pkb.action;

import com.opensymphony.xwork2.Action;
import com.pkb.action.dto.ActivityDTO;
import com.pkb.bean.IMessageWebBean;
import com.pkb.dto.PKBInvitationDTO;
import com.pkb.dto.PKBMessageDTO;
import com.pkb.entities.enums.Gender;
import com.pkb.entities.enums.NationalIdType;
import com.pkb.institute.entity.Team;
import com.pkb.medication.entity.MedicationSummaryDTO;
import com.pkb.questionnaires.action.QuestionnaireBaseAction;
import com.pkb.questionnaireservice.modelv2.Questionnaire;
import com.pkb.service.encounter.impl.tolven.EncounterManager;
import com.pkb.service.questionnaire.QuestionnaireByNameComparator;
import com.pkb.service.questionnaire.QuestionnaireManager;
import com.pkb.service.symptom.SymptomReportManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.symptom.entity.Symptom;
import com.pkb.symptom.entity.SymptomReportDTO;
import com.pkb.user.entity.PKBPerson;
import org.apache.commons.collections4.MapUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.text.StringEscapeUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import java.io.Serializable;
import java.time.Instant;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.List;
import java.util.Map;
import java.util.NavigableMap;
import java.util.Objects;
import java.util.Optional;
import java.util.TreeMap;
import java.util.UUID;
import java.util.stream.Collectors;
import java.util.stream.Stream;

/**
 * This action is to show the Dashboard home page according to the logged in
 * user type.
 *
 * @author anamika
 */
<span class="fc" id="L50">public class DashboardAction extends QuestionnaireBaseAction {</span>

    private static final long serialVersionUID = 1L;
<span class="fc" id="L53">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private static final int ACTIVITY_LIST_SIZE = 5;

    // Dependencies

    private IMessageWebBean messageWebBean;
    private TeamUserManager teamUserManager;
    private EncounterManager encounterManager;
    private QuestionnaireManager questionnaireManager;
    private SymptomReportManager symptomReportManager;

    private List&lt;PKBMessageDTO&gt; messages;
    private List&lt;MedicationSummaryDTO&gt; medicationSummaries;
    private List&lt;PKBInvitationDTO&gt; invitations;
    private Map&lt;String, String&gt; symptomResults;
    private List&lt;ActivityDTO&gt; activities;
<span class="fc" id="L70">    private boolean showActivityHistoryPageLink = true;</span>
    private List&lt;Questionnaire&gt; questionnaires;
<span class="fc" id="L72">    private boolean showPregnancyLink = false;</span>
    private String teamName;
    private String orgName;
    private Team team;
    private NationalIdType clinicianNationalIdType;

    //TODO : all type of activities need to be merged  into above list- activities
    private List&lt;ActivityDTO&gt; medicationActivities;

    private UUID invitationId;
    private boolean accessGranted;
<span class="fc" id="L83">    private String welcomeText = &quot;&quot;;</span>
    private List&lt;Team&gt; institutes;
    private NavigableMap&lt;Team, List&lt;Symptom&gt;&gt; symptomsByInstitute;
    private boolean clearContext;
<span class="fc" id="L87">    private boolean showSocialCare = false;</span>

    private DashboardDto dashboardDto;

    @Autowired
    private DashboardService dashboardService;

    private static class InstituteComparator implements Comparator&lt;Team&gt;, Serializable {

        @Override
        public int compare(Team left, Team right) {
<span class="fc" id="L98">            String name1 = left.getName();</span>
<span class="fc" id="L99">            String name2 = right.getName();</span>
<span class="fc" id="L100">            int result = name1.compareToIgnoreCase(name2);</span>
<span class="fc" id="L101">            return result;</span>
        }
    }

    /**
     * Dashboard for logged in user. It will fetch the list of 2 most recent
     * conversations and invitations.
     */
    @Override
    public String execute() {
<span class="fc" id="L111">        var users = getContextAndLoggedInUsers();</span>
<span class="fc" id="L112">        PKBPerson loggedInUser = users.loggedInUser();</span>
<span class="fc" id="L113">        PKBPerson contextUser = users.contextUser();</span>
<span class="fc" id="L114">        LOGGER.trace(&quot;Entering-&gt; patient/clinician dashboard {}&quot;, loggedInUser.getId());</span>
<span class="fc" id="L115">        String result = Action.SUCCESS;</span>

        // Get additional info if logged in user is a clinician
<span class="fc bfc" id="L118" title="All 2 branches covered.">        if (loggedInUser.isPro()) {</span>
<span class="fc" id="L119">            team = loggedInUserUtil.getLoggedInUserPrimaryTeam();</span>
<span class="fc bfc" id="L120" title="All 2 branches covered.">            if (team != null) {</span>
<span class="fc" id="L121">                clinicianNationalIdType = NationalIdType.getPrimaryNationalIdTypeFromCountryCode(team.getCountry()).orElse(null);</span>
<span class="fc" id="L122">                teamName = team.getName();</span>
<span class="fc" id="L123">                orgName = team.getOrg().getName();</span>
            } else {
<span class="fc" id="L125">                clinicianNationalIdType = NationalIdType.getPrimaryNationalIdTypeFromCountryCode(loggedInUser.getCountry()).orElse(null);</span>
            }
        }

        try {
<span class="fc" id="L130">            PKBPerson patient = null;</span>

            // sets the context user if the param is set
<span class="fc bfc" id="L133" title="All 2 branches covered.">            if (contextUserId != null) {</span>
<span class="fc" id="L134">                patient = contextUser;</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">            } else if (loggedInUser.isPatient()) {</span>
<span class="fc" id="L136">                patient = loggedInUser;</span>
            }

<span class="fc bfc" id="L139" title="All 2 branches covered.">            if (isClearContext()) {</span>
<span class="fc" id="L140">                contextUserUtil.clearContextUser();</span>
            }

<span class="fc bfc" id="L143" title="All 2 branches covered.">            if (patient != null) {</span>
                //pregnancy section to be shown only for female patients with age &gt; 10 years
<span class="fc bfc" id="L145" title="All 4 branches covered.">                if ((patient.getGender() == Gender.FEMALE.getId()) &amp;&amp; personHelper.isAtLeastYearsOld(11, patient).orElse(false)) {</span>
<span class="fc" id="L146">                    showPregnancyLink = true;</span>
                }

<span class="fc" id="L149">                showSocialCare = isSocialCareVisibile(false);</span>
            }

<span class="fc" id="L152">            loadInstitutes(users);</span>

<span class="fc" id="L154">            buildWelcomeMessageProperties();</span>

<span class="fc" id="L156">            buildLatestActivityList();</span>

<span class="fc" id="L158">            buildSymptomsList();</span>

<span class="fc" id="L160">            setDashboardDto(dashboardService.buildDashboardDTO(getLoggedInEHRRequestContext()));</span>

<span class="fc bfc" id="L162" title="All 2 branches covered.">            if (patient != null) {</span>
<span class="fc" id="L163">                questionnaireManager.getQuestionnaireListForPatient(patient.getId())</span>
<span class="fc" id="L164">                        .peek( ques -&gt; {</span>
<span class="fc" id="L165">                            questionnaires = ques;</span>
<span class="fc" id="L166">                            questionnaires.sort(new QuestionnaireByNameComparator());</span>
<span class="fc" id="L167">                        })</span>
<span class="fc" id="L168">                        .peekLeft(this::handleQuestionnaireException);</span>
            }

<span class="nc" id="L171">        } catch (Exception exception) {</span>
<span class="nc" id="L172">            result = Action.ERROR;</span>
<span class="nc" id="L173">            LOGGER.error(&quot;Error building dashboard info for {}&quot;, loggedInUserUtil.getLoggedInUserId(), exception);</span>
<span class="nc" id="L174">            addActionError(getText(&quot;dashboardAction.err.error_building_dashboard&quot;));</span>
<span class="fc" id="L175">        }</span>

<span class="fc" id="L177">        LOGGER.trace(&quot;Exiting patient/clinician dashboard {}&quot;, loggedInUser.getId());</span>
<span class="fc" id="L178">        return result;</span>
    }

    public String saveSymptoms() {
<span class="fc" id="L182">        List&lt;SymptomReportDTO&gt; dtoList = processSymptomReportDtoListFromUI(symptomResults)</span>
<span class="fc" id="L183">                .collect(Collectors.toList());</span>
<span class="fc" id="L184">        long patientId = contextUserUtil.getContextOrLoggedInUserId();</span>

        try {
<span class="fc" id="L187">            symptomReportManager.beginTransaction();</span>
<span class="fc" id="L188">            symptomReportManager.saveSymptomReports(getLoggedInEHRRequestContext(), dtoList, patientId);</span>
<span class="fc" id="L189">            symptomReportManager.commitTransaction();</span>
        } finally {
<span class="fc" id="L191">            symptomReportManager.rollbackIfNotCommitted();</span>
        }
        try {
<span class="fc bfc" id="L194" title="All 2 branches covered.">            for (Team teamWithAlarm : symptomReportManager.getTeamsWithActiveAlarms(patientId)) {</span>
<span class="fc" id="L195">                addActionMessage(getText(&quot;dashboard.txt.check_care_plans&quot;));</span>
<span class="fc" id="L196">                LOGGER.info(&quot;Symptom Alarm triggered for patient-{} being treated by {} at {}&quot;, patientId, teamWithAlarm.getName(), teamWithAlarm.getOrg().getName());</span>
<span class="fc" id="L197">            }</span>
<span class="nc" id="L198">        } catch (Exception e) {</span>
<span class="nc" id="L199">            LOGGER.error(&quot;Exception while checking for active symptom alarms for patient-{}&quot;, patientId, e);</span>
<span class="fc" id="L200">        }</span>

<span class="fc" id="L202">        execute();</span>
<span class="fc" id="L203">        return SUCCESS;</span>
    }

    private void loadInstitutes(BaseAction.Users users) {
<span class="fc" id="L207">        PKBPerson contextUser = users.contextUser();</span>
<span class="fc bfc" id="L208" title="All 2 branches covered.">        if (isLoggedInUserPatient()) {</span>
<span class="fc" id="L209">            Team primaryTeam = teamUserManager.getPrimaryTeam(getEHRRequestContext(), contextUser.getId(), false);</span>
<span class="fc" id="L210">            institutes = new ArrayList&lt;&gt;();</span>
            // For NI patients this will be
<span class="fc bfc" id="L212" title="All 2 branches covered.">            if (primaryTeam != null) {</span>
<span class="fc" id="L213">                institutes.add(primaryTeam);</span>
            }
<span class="fc" id="L215">        } else {</span>
            // find the patient welcome message set up by the institute
<span class="fc" id="L217">            institutes = teamUserManager.getUserTeams(getEHRRequestContext(), contextUser.getId(), true);</span>
        }
<span class="fc" id="L219">    }</span>

    private void buildSymptomsList() {

<span class="fc" id="L223">        Long contextUserId = contextUserUtil.getContextUserId();</span>
<span class="fc bfc" id="L224" title="All 2 branches covered.">        if (contextUserId == null) {</span>
<span class="fc" id="L225">            long currentUserId = loggedInUserUtil.getLoggedInUserId();</span>
<span class="fc bfc" id="L226" title="All 4 branches covered.">            if ((getLoggedInEHRRequestContext().isPatient()) &amp;&amp; !institutes.isEmpty()) {</span>

<span class="fc bfc" id="L228" title="All 2 branches covered.">                if (!symptomReportManager.hasSymptomsForToday(getEHRRequestContext(), currentUserId)) {</span>
<span class="fc" id="L229">                    symptomsByInstitute = new TreeMap&lt;&gt;(new InstituteComparator());</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">                    for (Team team : institutes) {</span>
<span class="fc" id="L231">                        List&lt;Symptom&gt; forInstitute = symptomReportManager.getSymptomsMonitoredByTeam(getEHRRequestContext(),</span>
<span class="fc" id="L232">                                team.getCode());</span>

<span class="fc bfc" id="L234" title="All 2 branches covered.">                        if (!forInstitute.isEmpty()) {</span>
<span class="fc" id="L235">                            symptomsByInstitute.put(team, forInstitute);</span>
                        }
<span class="fc" id="L237">                    }</span>

                    //if no entries, reset back to null - required by dashboard.jsp
<span class="fc bfc" id="L240" title="All 2 branches covered.">                    if (symptomsByInstitute.isEmpty()) {</span>
<span class="fc" id="L241">                        symptomsByInstitute = null;</span>
                    }
                }
            }
        }
<span class="fc" id="L246">    }</span>

    private void buildWelcomeMessageProperties() {
<span class="fc" id="L249">        Long contextUserId = contextUserUtil.getContextUserId();</span>
<span class="fc bfc" id="L250" title="All 2 branches covered.">        if (contextUserId == null) {</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">            if (institutes.isEmpty()) {</span>
<span class="fc bfc" id="L252" title="All 2 branches covered.">                if (getLoggedInEHRRequestContext().isPatient()) {</span>
<span class="fc" id="L253">                    welcomeText = getText(&quot;dashboard.txt.default_patient_welcome_msg&quot;);</span>
                }
            } else {
<span class="fc" id="L256">                Team team = institutes.get(0);</span>
                // find the patient welcome message set up by the team
<span class="fc bfc" id="L258" title="All 2 branches covered.">                if (getLoggedInEHRRequestContext().isPatient()) {</span>
<span class="fc" id="L259">                    welcomeText = StringUtils.trimToEmpty(StringEscapeUtils.unescapeHtml4(team.getPatientWelcomeText()));</span>
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">                } else if (getLoggedInEHRRequestContext().isPro()) {</span>
<span class="fc" id="L261">                    welcomeText = StringUtils.trimToEmpty(StringEscapeUtils.unescapeHtml4(team.getClinicianWelcomeText()));</span>
                }
            }
<span class="fc bfc" id="L264" title="All 2 branches covered.">            if (welcomeText.isEmpty()) {</span>
<span class="fc" id="L265">                welcomeText = null; // to simplify the JSP logic</span>
            }
        }
<span class="fc" id="L268">    }</span>

    private void buildLatestActivityList() {

<span class="fc" id="L272">        long loggedInUserId = loggedInUserUtil.getLoggedInUserId(); // Never context user</span>
<span class="fc" id="L273">        long accountId = Optional.ofNullable(messageWebBean.getDefaultAccountId(loggedInUserId))</span>
<span class="pc" id="L274">                .orElseThrow(() -&gt; new IllegalStateException(&quot;Unable to get default account id.&quot;));</span>
<span class="fc" id="L275">        activities = encounterManager.getActivityListAsActivities(getLoggedInEHRRequestContext(), loggedInUserId, accountId, ACTIVITY_LIST_SIZE, 0, this::getText);</span>
<span class="fc" id="L276">    }</span>

    public void setMessageWebBean(IMessageWebBean messageWebBean) {
<span class="fc" id="L279">        this.messageWebBean = messageWebBean;</span>
<span class="fc" id="L280">    }</span>

    public List&lt;PKBMessageDTO&gt; getMessages() {
<span class="nc" id="L283">        return messages;</span>
    }

    public List&lt;PKBInvitationDTO&gt; getInvitations() {
<span class="nc" id="L287">        return invitations;</span>
    }

    public UUID getInvitationId() {
<span class="nc" id="L291">        return invitationId;</span>
    }

    public void setInvitationId(UUID invitationId) {
<span class="nc" id="L295">        this.invitationId = invitationId;</span>
<span class="nc" id="L296">    }</span>

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L299">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L300">    }</span>

    public boolean isAccessGranted() {
<span class="nc" id="L303">        return accessGranted;</span>
    }

    public void setAccessGranted(boolean accessGranted) {
<span class="nc" id="L307">        this.accessGranted = accessGranted;</span>
<span class="nc" id="L308">    }</span>

    public List&lt;MedicationSummaryDTO&gt; getMedicationSummaries() {
<span class="nc" id="L311">        return medicationSummaries;</span>
    }

    public void setMedicationSummaries(List&lt;MedicationSummaryDTO&gt; medicationSummaries) {
<span class="nc" id="L315">        this.medicationSummaries = medicationSummaries;</span>
<span class="nc" id="L316">    }</span>

    public String getWelcomeText() {
<span class="fc" id="L319">        return welcomeText;</span>
    }

    public List&lt;ActivityDTO&gt; getActivities() {
<span class="fc" id="L323">        return activities;</span>
    }

    public void setActivities(List&lt;ActivityDTO&gt; activities) {
<span class="nc" id="L327">        this.activities = activities;</span>
<span class="nc" id="L328">    }</span>

    public List&lt;ActivityDTO&gt; getMedicationActivities() {
<span class="nc" id="L331">        return medicationActivities;</span>
    }

    public void setMedicationActivities(List&lt;ActivityDTO&gt; medicationActivities) {
<span class="nc" id="L335">        this.medicationActivities = medicationActivities;</span>
<span class="nc" id="L336">    }</span>

    public boolean isClearContext() {
<span class="fc" id="L339">        return clearContext;</span>
    }

    public void setClearContext(boolean clearContext) {
<span class="fc" id="L343">        this.clearContext = clearContext;</span>
<span class="fc" id="L344">    }</span>

    public void setEncounterManager(EncounterManager encounterManager) {
<span class="fc" id="L347">        this.encounterManager = encounterManager;</span>
<span class="fc" id="L348">    }</span>

    public boolean getShowPregnancyLink() {
<span class="nc" id="L351">        return showPregnancyLink;</span>
    }

    public List&lt;Questionnaire&gt; getQuestionnaires() {
<span class="fc" id="L355">        return questionnaires;</span>
    }

    public void setQuestionnaireManager(QuestionnaireManager questionnaireManager) {
<span class="fc" id="L359">        this.questionnaireManager = questionnaireManager;</span>
<span class="fc" id="L360">    }</span>

    public String getTeamName() {
<span class="fc" id="L363">        return teamName;</span>
    }

    public String getOrgName() {
<span class="fc" id="L367">        return orgName;</span>
    }

    public NationalIdType getClinicianNationalIdType() {
<span class="fc" id="L371">        return clinicianNationalIdType;</span>
    }

    public Map&lt;String, String&gt; getSymptomResults() {
<span class="fc" id="L375">        return symptomResults;</span>
    }

    public void setSymptomReportManager(SymptomReportManager symptomReportManager) {
<span class="fc" id="L379">        this.symptomReportManager = symptomReportManager;</span>
<span class="fc" id="L380">    }</span>

    public List&lt;Team&gt; getInstitutes() {
<span class="nc" id="L383">        return institutes;</span>
    }

    public void setInstitutes(List&lt;Team&gt; institutes) {
<span class="nc" id="L387">        this.institutes = institutes;</span>
<span class="nc" id="L388">    }</span>

    public void setMessages(List&lt;PKBMessageDTO&gt; messages) {
<span class="nc" id="L391">        this.messages = messages;</span>
<span class="nc" id="L392">    }</span>

    public void setInvitations(List&lt;PKBInvitationDTO&gt; invitations) {
<span class="nc" id="L395">        this.invitations = invitations;</span>
<span class="nc" id="L396">    }</span>

    public void setSymptomResults(Map&lt;String, String&gt; symptomResults) {
<span class="fc" id="L399">        this.symptomResults = symptomResults;</span>
<span class="fc" id="L400">    }</span>

    public void setQuestionnaires(List&lt;Questionnaire&gt; questionnaires) {
<span class="nc" id="L403">        this.questionnaires = questionnaires;</span>
<span class="nc" id="L404">    }</span>

    public void setShowPregnancyLink(boolean showPregnancyLink) {
<span class="nc" id="L407">        this.showPregnancyLink = showPregnancyLink;</span>
<span class="nc" id="L408">    }</span>

    public void setTeamName(String teamName) {
<span class="nc" id="L411">        this.teamName = teamName;</span>
<span class="nc" id="L412">    }</span>

    public void setOrgName(String orgName) {
<span class="nc" id="L415">        this.orgName = orgName;</span>
<span class="nc" id="L416">    }</span>

    public void setTeam(Team team) {
<span class="nc" id="L419">        this.team = team;</span>
<span class="nc" id="L420">    }</span>

    public void setClinicianNationalIdType(NationalIdType clinicianNationalIdType) {
<span class="nc" id="L423">        this.clinicianNationalIdType = clinicianNationalIdType;</span>
<span class="nc" id="L424">    }</span>

    public void setWelcomeText(String welcomeText) {
<span class="nc" id="L427">        this.welcomeText = welcomeText;</span>
<span class="nc" id="L428">    }</span>

    public void setSymptomsByInstitute(NavigableMap&lt;Team, List&lt;Symptom&gt;&gt; symptomsByInstitute) {
<span class="nc" id="L431">        this.symptomsByInstitute = symptomsByInstitute;</span>
<span class="nc" id="L432">    }</span>

    public NavigableMap&lt;Team, List&lt;Symptom&gt;&gt; getSymptomsByInstitute() {
<span class="fc" id="L435">        return symptomsByInstitute;</span>
    }

    public Team getTeam() {
<span class="fc" id="L439">        return team;</span>
    }

    public boolean isShowActivityHistoryPageLink() {
<span class="fc" id="L443">        return showActivityHistoryPageLink;</span>
    }

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L447">        this.userManager = userManager;</span>
<span class="fc" id="L448">    }</span>

    @Override
    public boolean isShowSocialCare() {
<span class="fc" id="L452">        return showSocialCare;</span>
    }

    private Stream&lt;SymptomReportDTO&gt; processSymptomReportDtoListFromUI(Map&lt;String, String&gt; userInputValues) {
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">        if (MapUtils.isEmpty(userInputValues)) {</span>
<span class="nc" id="L457">            return Stream.empty();</span>
        }
<span class="fc" id="L459">        Instant reportDate = dateTimeService.now();</span>
<span class="fc" id="L460">        return userInputValues.values().stream()</span>
<span class="fc" id="L461">                .filter(Objects::nonNull)</span>
<span class="fc" id="L462">                .map(s -&gt; convertToSymptomReportDto(s, reportDate));</span>
    }

    public DashboardDto getDashboardDto() {
<span class="fc" id="L466">        return dashboardDto;</span>
    }

    public void setDashboardDto(DashboardDto dashboardDto) {
<span class="fc" id="L470">        this.dashboardDto = dashboardDto;</span>
<span class="fc" id="L471">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>