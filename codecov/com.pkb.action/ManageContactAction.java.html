<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ManageContactAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action</a> &gt; <span class="el_source">ManageContactAction.java</span></div><h1>ManageContactAction.java</h1><pre class="source lang-java linenums">package com.pkb.action;

import com.opensymphony.xwork2.Action;
import com.pkb.VersionDetails;
import com.pkb.consent.model.NoConsentsRequired;
import com.pkb.datamodel.Email;
import com.pkb.entities.enums.UserStatus;
import com.pkb.exception.MailException;
import com.pkb.institute.entity.Team;
import com.pkb.notification.entity.Activity;
import com.pkb.service.emailmessage.IAddressInfoProvider;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.user.impl.PersonContactManager;
import com.pkb.service.user.impl.UserAccessManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PasswordAccess;
import com.pkb.user.entity.PersonContact;
import io.vavr.control.Option;
import org.apache.struts2.interceptor.validation.SkipValidation;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.UUID;

import static com.pkb.datamodel.ImmutableDisclosingEmail.disclosingEmail;
import static org.apache.commons.lang3.StringUtils.isBlank;

/**
 * Action class for add, delete user contacts
 *
 * @author pravinam
 *
 */
<span class="fc" id="L39">public class ManageContactAction extends BaseAction {</span>

    private static final long serialVersionUID = 1L;

    private Long deleteContactId;

    private Long resendContactId;

    private PersonContact contact;

    public void setNewEmailContactString(String newEmailContactString) {
<span class="fc" id="L50">        this.newEmailContactString = newEmailContactString;</span>
<span class="fc" id="L51">    }</span>

    private String newEmailContactString;

    private UUID contactPublicId;

    private PersonContactManager personContactManager;

    private PKBEmailMessageManager pkbEmailMessageManager;

    private UserAccessManager userAccessManager;

    private IAddressInfoProvider formatter;

<span class="fc" id="L65">    private final String tab = &quot;myaccount&quot;;</span>

<span class="fc" id="L67">    private final String subTab = &quot;myProfile&quot;;</span>

<span class="fc" id="L69">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    public String addNewContactForm() {
<span class="fc" id="L72">        contact = new PersonContact();</span>
<span class="fc" id="L73">        contact.setPublicId(UUID.randomUUID());</span>
<span class="fc" id="L74">        return SUCCESS;</span>
    }

    @SkipValidation
    public String deleteContactForm() {
        try {
<span class="fc" id="L80">            long userId = contextUserUtil.getContextOrLoggedInUserId();</span>
<span class="fc" id="L81">            contact = personContactManager.getPersonContact(userId, deleteContactId);</span>
<span class="nc" id="L82">        } catch (Exception e) {</span>
<span class="nc" id="L83">            LOGGER.error(&quot;error getting contact to delete {}&quot;, deleteContactId, e);</span>
<span class="fc" id="L84">        }</span>
<span class="fc" id="L85">        return SUCCESS;</span>
    }


    public String cancel() {
<span class="nc" id="L90">        return Action.SUCCESS;</span>
    }

    @SkipValidation
    public String deleteContact() {
<span class="fc" id="L95">        long userId = contextUserUtil.getContextOrLoggedInUserId();</span>

<span class="pc bpc" id="L97" title="1 of 2 branches missed.">        if (deleteContactId != null) {</span>
            try {
<span class="fc" id="L99">                PersonContact pc = personContactManager.getPersonContact(userId, deleteContactId);</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">                if (!pc.getPerson().getId().equals(userId)) {</span>
<span class="nc" id="L101">                    throw new IllegalAccessException(&quot;User/context user is &quot; + userId +</span>
<span class="nc" id="L102">                            &quot;; can't delete contact &quot; + deleteContactId + &quot; for &quot; + pc.getPerson().getId());</span>
                }
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">                if (pc.getIsPrimary()) {</span>
<span class="nc" id="L105">                    throw new IllegalStateException(&quot;can't delete primary contact &quot; + deleteContactId);</span>
                }

<span class="fc" id="L108">                userManager.beginTransaction();</span>

<span class="fc" id="L110">                personContactManager.deleteContact(deleteContactId);</span>
<span class="fc" id="L111">                userManager.commitTransaction();</span>
<span class="fc" id="L112">                addActionMessage(getText(&quot;manageContactAction.msg.successfully_deleted&quot;));</span>
<span class="fc" id="L113">            } catch (Exception e) {</span>
<span class="fc" id="L114">                LOGGER.error(&quot;deleting {} for {}&quot;, deleteContactId, userId, e);</span>
<span class="fc" id="L115">                addActionError(getText(&quot;manageContactAction.msg.could_not_delete&quot;));</span>
            } finally {
<span class="fc" id="L117">                userManager.rollbackIfNotCommitted();</span>
            }
        }
<span class="fc" id="L120">        return SUCCESS;</span>
    }

    @SkipValidation
    public String resendContactConfirmation() {
<span class="fc" id="L125">        long userId = contextUserUtil.getContextOrLoggedInUserId();</span>

<span class="pc bpc" id="L127" title="1 of 2 branches missed.">        if (resendContactId != null) {</span>
            try {
<span class="fc" id="L129">                PersonContact pc = personContactManager.getPersonContact(userId, resendContactId);</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">                if (!pc.getPerson().getId().equals(userId)) {</span>
                    //noinspection ThrowCaughtLocally
<span class="nc" id="L132">                    throw new IllegalAccessException(&quot;User/context user is &quot; + userId +</span>
<span class="nc" id="L133">                            &quot;; can't send confirmation for contact &quot; + resendContactId + &quot; for &quot; + pc.getPerson().getId());</span>
                }

                // Resend email to confirm the contact
<span class="fc" id="L137">                pkbEmailMessageManager.sendEmailToConfirmNewContact(pc);</span>
<span class="fc" id="L138">                addActionMessage(getText(&quot;manageContactAction.msg.add_new_contact_success&quot;));</span>
<span class="nc" id="L139">            } catch (MailException e) {</span>
<span class="nc" id="L140">                LOGGER.error(&quot;mail error&quot;, e);</span>
<span class="nc" id="L141">                addActionError(getText(&quot;manageContactAction.err.mail_error_message&quot;));</span>
<span class="nc" id="L142">                return INPUT;</span>
<span class="nc" id="L143">            } catch (Exception e) {</span>
<span class="nc" id="L144">                LOGGER.error(&quot;error&quot;, e);</span>
<span class="nc" id="L145">                addActionError(getText(&quot;manageContactAction.err.mail_error_message&quot;));</span>
<span class="nc" id="L146">                return INPUT;</span>
<span class="fc" id="L147">            }</span>
        }
<span class="fc" id="L149">        return SUCCESS;</span>
    }

    @SkipValidation
    public String confirmContact() {
        // can't do this for a context user
<span class="fc" id="L155">        PKBPerson user = loggedInUserUtil.getLoggedInPerson();</span>

<span class="pc bpc" id="L157" title="1 of 2 branches missed.">        if (contactPublicId != null) {</span>
            try {
<span class="fc" id="L159">                PersonContact contact = personContactManager.getPersonEmailContactByPublicId(contactPublicId);</span>
<span class="pc bpc" id="L160" title="2 of 4 branches missed.">                if (contact != null &amp;&amp; canPersonConfirmContact(user, contact)) {</span>
<span class="fc" id="L161">                    personContactManager.confirmEmailContactForHuman(getEHRRequestContext(), contact);</span>
<span class="fc" id="L162">                    addActionMessage(getText(&quot;confirm.contact.success.message&quot;));</span>
                } else {
<span class="nc" id="L164">                    throw new IllegalAccessException(String.format(&quot;user=[%d] cannot confirm contact=[%d]&quot;, user.getId(), contactPublicId));</span>
                }
<span class="nc" id="L166">            } catch (Exception e) {</span>
<span class="nc" id="L167">                LOGGER.error(&quot;error confirming contact {}&quot;, contactPublicId, e);</span>
<span class="nc" id="L168">                addActionError(getText(&quot;confirm.contact.error.message&quot;));</span>
<span class="fc" id="L169">            }</span>
        }
<span class="pc bpc" id="L171" title="2 of 4 branches missed.">        switch (user.getUserType()) {</span>
<span class="nc" id="L172">            case INSTITUTE_ADMIN: return &quot;successCoordinator&quot;;</span>
<span class="nc" id="L173">            case SUPER_ADMIN: return &quot;successSuperadmin&quot;;</span>
<span class="fc" id="L174">            case PRIVACY_OFFICER: return &quot;successPrivacyOfficer&quot;;</span>
<span class="fc" id="L175">            default: return SUCCESS;</span>
        }
    }

    private boolean canPersonConfirmContact(@NotNull PKBPerson person, @NotNull PersonContact contact) {
<span class="fc" id="L180">        return getEquivalentPersonsForHuman(person).contains(contact.getPerson());</span>
    }

    private List&lt;PKBPerson&gt; getEquivalentPersonsForHuman(PKBPerson person) {
<span class="fc" id="L184">        List&lt;PKBPerson&gt; equivalentPersons = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">        if (isBlank(person.getHumanUUID())) {</span>
<span class="fc" id="L186">            equivalentPersons.add(person);</span>
        } else {
<span class="fc" id="L188">            equivalentPersons.addAll(userManager.getPersonsByHumanUuid(person.getHumanUUID()));</span>
        }
<span class="fc" id="L190">        return equivalentPersons;</span>
    }

    public String addNewContact() {
<span class="fc" id="L194">        Long contextUserId = contextUserUtil.getContextUserId();</span>
<span class="fc" id="L195">        long userId = contextUserUtil.getContextOrLoggedInUserId();</span>

<span class="fc bfc" id="L197" title="All 2 branches covered.">        if (isBlank(newEmailContactString)) {</span>
<span class="fc" id="L198">            addActionError(getText(&quot;manageContactAction.err.enter_email&quot;));</span>
<span class="fc" id="L199">            return INPUT;</span>
        } else {
            try {
<span class="fc" id="L202">                PKBPerson user = userManager.getPKBPerson(userId);</span>

<span class="fc" id="L204">                Email email = disclosingEmail(newEmailContactString);</span>
<span class="pc bpc" id="L205" title="1 of 2 branches missed.">                if (Option.of(userManager.getSinglePersonByEmail(email))</span>
<span class="pc bpc" id="L206" title="3 of 4 branches missed.">                        .map(owner -&gt; !owner.getId().equals(user.getId()) &amp;&amp; !owner.isLinkedToHuman(user))</span>
<span class="fc" id="L207">                        .getOrElse(false)) {</span>
<span class="nc" id="L208">                    addActionError(getText(&quot;manageContactAction.err.email_in_use&quot;, Collections.singletonList(email.address())));</span>
<span class="nc" id="L209">                    return INPUT;</span>
                }

<span class="fc" id="L212">                userManager.beginTransaction();</span>

                // Add the email address as a new contact for each PKBPerson associated with this human
<span class="fc" id="L215">                List&lt;PKBPerson&gt; equivalentPersons = getEquivalentPersonsForHuman(user);</span>
<span class="fc" id="L216">                boolean sendEmail = true;</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">                for (PKBPerson equivalentPerson : equivalentPersons) {</span>
<span class="fc" id="L218">                    addNewEmailAddressToPerson(equivalentPerson, email, sendEmail);</span>
                    // Only the first PKBPerson gets an email
<span class="fc" id="L220">                    sendEmail = false;</span>
<span class="fc" id="L221">                }</span>

<span class="fc" id="L223">                userManager.commitTransaction();</span>

<span class="fc bfc" id="L225" title="All 2 branches covered.">                if (contextUserId != null) {</span>
<span class="fc bfc" id="L226" title="All 2 branches covered.">                    boolean notify = formatter.getConfirmedOnlyPrimaryAndSecondaryContacts(user, new NoConsentsRequired()).getPrimaryAddress() != null;</span>
<span class="fc" id="L227">                    logActivityByOthers(Activity.Action.ADDED_CONTACT_OTHERS, dateTimeService.now(), notify /*notify*/, new NoConsentsRequired());</span>
<span class="fc" id="L228">                } else {</span>
<span class="fc" id="L229">                    notifySelfActivity(new NoConsentsRequired());</span>
                }

<span class="fc bfc" id="L232" title="All 2 branches covered.">                if (user.getStatus() == UserStatus.CREATED) {</span>
<span class="fc" id="L233">                    addActionMessage(getText(&quot;manageContactAction.msg.resent_invite_to_new_email&quot;));</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">                } else if (user.getStatus() == UserStatus.NOCONTACT) {</span>
<span class="fc" id="L235">                    addActionMessage(getText(&quot;manageContactAction.msg.sent_invite&quot;, Collections.singletonList(email.address())));</span>
                } else {
<span class="fc" id="L237">                    addActionMessage(getText(&quot;manageContactAction.msg.add_new_contact_success&quot;));</span>
                }
<span class="nc" id="L239">            } catch (MailException e) {</span>
<span class="nc" id="L240">                LOGGER.error(&quot;mail error adding contact for {}&quot;, userId, e);</span>
<span class="nc" id="L241">                addActionError(getText(&quot;manageContactAction.err.mail_error_message&quot;));</span>
<span class="nc" id="L242">                return INPUT;</span>
<span class="fc" id="L243">            } catch (Exception e) {</span>
<span class="fc" id="L244">                LOGGER.error(&quot;general error adding contact for {}&quot;, userId, e);</span>
<span class="fc" id="L245">                addActionError(getText(&quot;manageContactAction.err.mail_error_message&quot;));</span>
<span class="fc" id="L246">                return INPUT;</span>
            } finally {
<span class="fc" id="L248">                userManager.rollbackIfNotCommitted();</span>
            }
        }
<span class="fc" id="L251">        return SUCCESS;</span>
    }

    private void addNewEmailAddressToPerson(PKBPerson person, Email emailAddress, boolean sendEmail) throws MailException {
<span class="fc" id="L255">        List&lt;PersonContact&gt; contactList = personContactManager.getContactListDirect(person.getId());</span>
<span class="fc" id="L256">        boolean userAlreadyHasContact = false;</span>
<span class="fc" id="L257">        boolean userAlreadyHasConfirmedPrimaryEmailAddress = false;</span>
<span class="fc" id="L258">        PersonContact actualPrimaryContact = null;</span>
<span class="fc bfc" id="L259" title="All 2 branches covered.">        for (PersonContact pc : contactList) {</span>
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">            if (pc.getContactIfEmail().isDefined()) {</span>
<span class="fc" id="L261">                Email alreadyExistingEmail = pc.getContactIfEmail().get();</span>
<span class="fc bfc" id="L262" title="All 2 branches covered.">                if (pc.isPrimary()) {</span>
<span class="fc" id="L263">                    actualPrimaryContact = pc;</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">                    if (pc.isConfirmed()) {</span>
<span class="fc" id="L265">                        userAlreadyHasConfirmedPrimaryEmailAddress = true;</span>

                    }
                }
<span class="fc bfc" id="L269" title="All 2 branches covered.">                if (alreadyExistingEmail.equals(emailAddress)) {</span>
<span class="fc" id="L270">                    userAlreadyHasContact = true;</span>
                }
            }
<span class="fc" id="L273">        }</span>

<span class="fc bfc" id="L275" title="All 2 branches covered.">        if (!userAlreadyHasContact) {</span>
<span class="fc" id="L276">            PersonContact newContact = new PersonContact();</span>
<span class="fc" id="L277">            newContact.setPublicId(UUID.randomUUID());</span>
<span class="fc" id="L278">            newContact.setPerson(person);</span>
<span class="fc" id="L279">            newContact.setContactAsEmail(emailAddress);</span>
<span class="fc" id="L280">            newContact.setConfirmed(false);</span>
<span class="fc bfc" id="L281" title="All 2 branches covered.">            newContact.setPrimary(!userAlreadyHasConfirmedPrimaryEmailAddress);</span>

<span class="fc bfc" id="L283" title="All 4 branches covered.">            if (actualPrimaryContact != null &amp;&amp; newContact.isPrimary()) {</span>
<span class="fc" id="L284">                actualPrimaryContact.setPrimary(false);</span>
<span class="fc" id="L285">                personContactManager.saveContactList(getEHRRequestContext(), Collections.singletonList(actualPrimaryContact));</span>
            }

<span class="fc" id="L288">            newContact = personContactManager.save(newContact, VersionDetails.of(getEHRRequestContext(), dateTimeService.now()));</span>

<span class="fc bfc" id="L290" title="All 2 branches covered.">            if (sendEmail) {</span>
<span class="fc bfc" id="L291" title="All 4 branches covered.">                if (person.getStatus() == UserStatus.CREATED || person.getStatus() == UserStatus.NOCONTACT) {</span>
                    // First contact so send registration email
<span class="fc" id="L293">                    sendRegistrationEmailToNewOrNoContactUser(person);</span>
                } else {
<span class="fc" id="L295">                    pkbEmailMessageManager.sendEmailToConfirmNewContact(newContact);</span>
                }
            }

<span class="fc bfc" id="L299" title="All 2 branches covered.">            if (person.getStatus() == UserStatus.NOCONTACT) {</span>
<span class="fc" id="L300">                userManager.updateUserStatus(person.getId(), UserStatus.CREATED);</span>
            }
        }
<span class="fc" id="L303">    }</span>

    private void sendRegistrationEmailToNewOrNoContactUser(PKBPerson user) throws MailException {

        // Logged in user has to be a clinician/admin because patient cannot
        // login without email
<span class="fc" id="L309">        PKBPerson loggedUser = loggedInUserUtil.getLoggedInPerson();</span>
<span class="fc" id="L310">        Team team = loggedInUserUtil.getLoggedInUserPrimaryTeam();</span>

        // Get the password access for no contact patient
<span class="fc" id="L313">        PasswordAccess access = userAccessManager.getPasswordAccess(</span>
<span class="fc" id="L314">                user.getId(), getLoggedInEHRRequestContext());</span>
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">        if (access == null) {</span>
<span class="nc" id="L316">            throw new NullPointerException(&quot;No passwordAccess stored for no contact user &quot; + user.getId()); // TODO: handle this (old user) more politely</span>
        }
<span class="fc" id="L318">        user.setPassword(access.getPassword());</span>
<span class="fc" id="L319">        pkbEmailMessageManager.notifyPatientOfCreatedAccount(loggedUser, user,</span>
                team, &quot;&quot;);

        // Password should not get carried in rest of the flow
<span class="fc" id="L323">        user.setPassword(null);</span>
<span class="fc" id="L324">    }</span>

    public Long getDeleteContactId() {
<span class="fc" id="L327">        return deleteContactId;</span>
    }

    public void setDeleteContactId(Long deleteContactId) {
<span class="fc" id="L331">        this.deleteContactId = deleteContactId;</span>
<span class="fc" id="L332">    }</span>

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L335">        this.userManager = userManager;</span>
<span class="fc" id="L336">    }</span>

    public PersonContact getContact() {
<span class="fc" id="L339">        return contact;</span>
    }

    public void setContact(PersonContact contact) {
<span class="nc" id="L343">        this.contact = contact;</span>
<span class="nc" id="L344">    }</span>

    public void setUserAccessManager(UserAccessManager userAccessManager) {
<span class="fc" id="L347">        this.userAccessManager = userAccessManager;</span>
<span class="fc" id="L348">    }</span>

    public void setFormatter(IAddressInfoProvider formatter) {
<span class="fc" id="L351">        this.formatter = formatter;</span>
<span class="fc" id="L352">    }</span>

    public void setPersonContactManager(PersonContactManager personContactManager) {
<span class="fc" id="L355">        this.personContactManager = personContactManager;</span>
<span class="fc" id="L356">    }</span>

    public void setPkbEmailMessageManager(
            PKBEmailMessageManager pkbEmailMessageManager) {
<span class="fc" id="L360">        this.pkbEmailMessageManager = pkbEmailMessageManager;</span>
<span class="fc" id="L361">    }</span>

    public String getTab() {
<span class="fc" id="L364">        return tab;</span>
    }

    public Long getResendContactId() {
<span class="nc" id="L368">        return resendContactId;</span>
    }

    public void setResendContactId(Long resendContactId) {
<span class="fc" id="L372">        this.resendContactId = resendContactId;</span>
<span class="fc" id="L373">    }</span>

    public void setContactPublicId(UUID contactPublicId) {
<span class="fc" id="L376">        this.contactPublicId = contactPublicId;</span>
<span class="fc" id="L377">    }</span>

    public String getSubTab() {
<span class="fc" id="L380">        return subTab;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>