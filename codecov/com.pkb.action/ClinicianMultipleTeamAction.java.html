<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ClinicianMultipleTeamAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action</a> &gt; <span class="el_source">ClinicianMultipleTeamAction.java</span></div><h1>ClinicianMultipleTeamAction.java</h1><pre class="source lang-java linenums">/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package com.pkb.action;

import com.pkb.exception.PKBException;
import com.pkb.institute.entity.TeamWithPKBPerson;
import com.pkb.security.PKBAuthenticationDetails;
import com.pkb.service.team.TeamUserManager;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextImpl;
import org.springframework.security.web.savedrequest.DefaultSavedRequest;
import org.springframework.stereotype.Component;

import javax.naming.NamingException;
import java.util.List;
import java.util.UUID;

import static com.pkb.util.PKBWebUtil.SPRING_SECURITY_CONTEXT;


@Component
<span class="fc" id="L32">public class ClinicianMultipleTeamAction extends BaseAction {</span>
    private static final long serialVersionUID = -7552243661782061308L;
<span class="fc" id="L34">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    @Autowired
    @Qualifier(&quot;myAuthenticationManager&quot;)
    private AuthenticationManager authenticationManager;
    @Autowired
    private TeamUserManager teamUserManager;


    // Registration parameters
    private String icode;
    private Long uid;
    private String temp;

    // Team selection
    private Long selectedTeam;

    // E-mail comfirmation parameter
    private UUID contactPublicId;

    /**
     * This action has no UI, it's a redirect trick to get back to the registration
     * page as an authenticated user when a clinician joins a second (or third, etc)
     * team.
     * &lt;p&gt;
     * Normally the registration page is completed by an unauthenticated user. However,
     * if a clinician with an existing account is joining another team, we want them to
     * be able to login before accepting the invite. So the login link tries to come here,
     * gets intercepted by spring to go to the login page, then when authenticated we simply
     * redirect back to where they started (but this time logged in!)
     *
     * @return
     */
    public String registrationRedirectTrick() {
<span class="fc" id="L68">        return SUCCESS;</span>
    }

    public String displayTeamSelectForm() {
<span class="fc" id="L72">        return SUCCESS;</span>
    }

    public String displayTeamSelect() throws NamingException {

<span class="fc" id="L77">        List&lt;TeamWithPKBPerson&gt; availableTeams =</span>
<span class="fc" id="L78">                loggedInUserUtil.getLoggedInUserTeams();</span>

<span class="fc" id="L80">        LOGGER.info(&quot;Teams in team selector: {}&quot;, availableTeams);</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">        for (TeamWithPKBPerson t : availableTeams) {</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">            if (t.getInstituteUser().getId().equals(selectedTeam)) {</span>

<span class="fc" id="L84">                SecurityContextImpl userSession = (SecurityContextImpl) session</span>
<span class="fc" id="L85">                        .get(SPRING_SECURITY_CONTEXT);</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">                if (userSession != null) {</span>
<span class="fc" id="L87">                    Authentication auth = userSession.getAuthentication();</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">                    if (auth != null) {</span>

                        // Reauthenticate and set the new authentication info in the session
<span class="fc" id="L91">                        PKBAuthenticationDetails newAuthenticationDetails = PKBAuthenticationDetails.initializeIfSame(auth.getDetails())</span>
<span class="fc" id="L92">                                .userId(t.getPerson().getId()).build();</span>

<span class="fc" id="L94">                        UsernamePasswordAuthenticationToken authToken = new UsernamePasswordAuthenticationToken(</span>
<span class="fc" id="L95">                                t.getPerson().getEmail(), auth.getCredentials(), auth.getAuthorities());</span>
<span class="fc" id="L96">                        authToken.setDetails(newAuthenticationDetails);</span>
<span class="fc" id="L97">                        userSession.setAuthentication(authenticationManager.authenticate(authToken));</span>

                        // Set the 'team selected' flag in the session and refresh
<span class="fc" id="L100">                        loggedInUserUtil.markTeamSelected();</span>

<span class="fc" id="L102">                    } else {</span>
<span class="nc" id="L103">                        throw new PKBException(</span>
                                &quot;could not obtain authentication from security context&quot;);
                    }
<span class="fc" id="L106">                } else {</span>
<span class="nc" id="L107">                    throw new PKBException(&quot;could not obtain SecurityContextImpl from session&quot;);</span>
                }

                break;
            }
<span class="fc" id="L112">        }</span>

        /*
         * This is a bit hacky - if the user was redirected through the login flow, we should
         * redirect back where they came from. At the moment this is only of particular interest if
         * they logged-in from the registration page, see PHR-941 - so we check for the specific
         * path and repopulate the parameters This is only necessary because the team-select page
         * makes login a 2-step process but spring clears the saved redirect URL after the normal
         * username/password screen is submitted. Therefore, we can't rely on spring to do this
         * redirect for us
         */
<span class="fc" id="L123">        DefaultSavedRequest savedRequest = pkbWebUtil.getSavedRequest();</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">        if (savedRequest != null) {</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">            if (StringUtils.equals(savedRequest.getServletPath(),</span>
                    &quot;/auth/authBeforeJoiningTeam.action&quot;)) {
                // Before we came through this login flow, we were on the registration screen. Go back there
<span class="fc" id="L128">                icode = savedRequest.getParameterValues(&quot;icode&quot;)[0];</span>
<span class="fc" id="L129">                temp = savedRequest.getParameterValues(&quot;temp&quot;)[0];</span>
<span class="fc" id="L130">                uid = Long.parseLong(savedRequest.getParameterValues(&quot;uid&quot;)[0]);</span>
<span class="fc" id="L131">                return &quot;clinicianRegistration&quot;;</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">            } else if (StringUtils.equals(savedRequest.getServletPath(), &quot;/auth/confirmContact.action&quot;)) {</span>
<span class="fc" id="L133">                String[] contactPublicIdParam = savedRequest.getParameterValues(&quot;contactPublicId&quot;);</span>
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">                if (contactPublicIdParam != null) {</span>
<span class="fc" id="L135">                    contactPublicId = UUID.fromString(contactPublicIdParam[0]);</span>
                }
<span class="fc" id="L137">                return &quot;confirmContact&quot;;</span>
            }
        }
<span class="fc" id="L140">        return loggedInUserUtil.getLoggedInUserHomeResult().orElse(null);</span>
    }

    public String getIcode() {
<span class="fc" id="L144">        return icode;</span>
    }

    public void setIcode(String icode) {
<span class="fc" id="L148">        this.icode = icode;</span>
<span class="fc" id="L149">    }</span>

    public Long getUid() {
<span class="fc" id="L152">        return uid;</span>
    }

    public void setUid(Long uid) {
<span class="fc" id="L156">        this.uid = uid;</span>
<span class="fc" id="L157">    }</span>

    public String getTemp() {
<span class="fc" id="L160">        return temp;</span>
    }

    public void setTemp(String temp) {
<span class="fc" id="L164">        this.temp = temp;</span>
<span class="fc" id="L165">    }</span>

    public TeamUserManager getTeamUserManager() {
<span class="nc" id="L168">        return teamUserManager;</span>
    }

    public Long getSelectedTeam() {
<span class="fc" id="L172">        return selectedTeam;</span>
    }

    public void setSelectedTeam(Long selectedTeam) {
<span class="fc" id="L176">        this.selectedTeam = selectedTeam;</span>
<span class="fc" id="L177">    }</span>

    public UUID getContactPublicId() {
<span class="fc" id="L180">        return contactPublicId;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>