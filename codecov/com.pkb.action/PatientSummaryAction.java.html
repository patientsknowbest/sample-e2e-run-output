<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PatientSummaryAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action</a> &gt; <span class="el_source">PatientSummaryAction.java</span></div><h1>PatientSummaryAction.java</h1><pre class="source lang-java linenums">package com.pkb.action;

import com.opensymphony.xwork2.Action;
import com.pkb.action.support.AllergyGroupTransformer;
import com.pkb.action.support.DiagnosisGroupTransformer;
import com.pkb.action.userprofile.ManageUserProfileAction;
import com.pkb.allergy.entity.Allergy;
import com.pkb.app.dto.PageFilterDTO;
import com.pkb.bean.IMedicationWebBean;
import com.pkb.bean.impl.UserWebBean;
import com.pkb.consent.model.ConsentStatus;
import com.pkb.datamodel.consent.PatientConsentDTO;
import com.pkb.diagnosis.DiagnosisHelper;
import com.pkb.diagnosis.entity.Diagnosis;
import com.pkb.dto.AllergyGroupDto;
import com.pkb.dto.DiagnosisGroupDto;
import com.pkb.dto.PersonDto;
import com.pkb.entities.enums.AccessingEntityType;
import com.pkb.institute.entity.Team;
import com.pkb.mappers.ImmutableEntityDependency;
import com.pkb.medication.entity.Medication;
import com.pkb.phplan.entity.PHPlan;
import com.pkb.plan.support.PhPlanToPlanDtoConverter;
import com.pkb.questionnaires.action.QuestionnaireBaseAction;
import com.pkb.questionnaireservice.modelv2.Questionnaire;
import com.pkb.service.allergy.impl.AllergyManager;
import com.pkb.service.datapoint.DataWithUIPermissions;
import com.pkb.service.dataupload.impl.DataUploadManager;
import com.pkb.service.diagnosis.DiagnosisManager;
import com.pkb.service.medication.MedicationManager;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.phplan.PHPlanDTO;
import com.pkb.service.phplan.PlanManager;
import com.pkb.service.questionnaire.QuestionnaireManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PKBPersonIdentifierPair;
import com.pkb.user.entity.PersonSecurePropertyDTO;
import com.pkb.user.entity.PersonSecurePropertyDTO.PropertyName;
import com.pkb.util.MedicationDTO;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import java.lang.invoke.MethodHandles;
import java.util.List;
import java.util.Optional;

import static com.pkb.phplan.entity.PHPlan.Lazy.CREATOR_DETAILS;
import static com.pkb.phplan.entity.PHPlan.Lazy.LAST_EDITOR_DEATILS;
import static com.pkb.user.entity.PKBPerson.Lazy.CONTACTS;
import static com.pkb.user.entity.PKBPerson.Lazy.NATIONAL_AND_LOCAL_IDS;
import static com.pkb.user.entity.PKBPerson.Lazy.NATIONAL_AND_LOCAL_IDS_DEEP;
import static com.pkb.user.entity.PKBPerson.Lazy.PROPERTIES;
import static java.util.stream.Collectors.toList;
import static org.apache.commons.collections4.CollectionUtils.isEmpty;

<span class="fc" id="L59">public class PatientSummaryAction extends QuestionnaireBaseAction {</span>

    private static final long serialVersionUID = 1L;
<span class="fc" id="L62">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

    private DiagnosisManager diagnosisManager;
    private TeamUserManager teamUserManager;
    private PlanManager planManager;
    private MedicationManager medicationManager;
    private AllergyManager allergyManager;
    private UserWebBean userWebBean;
    private IMedicationWebBean medicationWebBean;
    private QuestionnaireManager questionnaireManager;
    private DiagnosisHelper diagnosisHelper;
    private DataUploadManager dataUploadManager;

    private PhPlanToPlanDtoConverter phPlanToPlanDtoConverter;
    private PatientConsentManager patientConsentManager;

    private String formattedDeathTimestamp;

    public String getTab() {
<span class="fc" id="L81">        return &quot;patientSummary&quot;;</span>
    }

    private Long loggedUserId;
    private Long patientId;
    private Long patientAccountId;
    private Team team;
    private boolean isTeamUser;
    private PersonDto patient;
    private boolean patientUnder18;
    private List&lt;PKBPerson&gt; carers;
    private String ethnicity;
    private List&lt;MedicationDTO&gt; currentMedications;
    private List&lt;AllergyGroupDto&gt; allergyGroups;
    private List&lt;DiagnosisGroupDto&gt; currentDiagnosisGroups;

    @Autowired
    private DiagnosisGroupTransformer diagnosisGroupTransformer;
    @Autowired
    private AllergyGroupTransformer allergyGroupTransformer;

    private ConsentStatus consentStatus;

    private PatientConsentDTO consent;

    private List&lt;Questionnaire&gt; questionnaires;

    public List&lt;Questionnaire&gt; getQuestionnaires() {
<span class="fc" id="L109">        return questionnaires;</span>
    }

    private List&lt;PHPlanDTO&gt; plans;

    private PKBPersonIdentifierPair identifierPair;

<span class="fc" id="L116">    private boolean hideOldPatientBanner = true;</span>

    private BaseAction.Users findUsers() {
<span class="fc" id="L119">        var users = getContextAndLoggedInUsers(NATIONAL_AND_LOCAL_IDS, NATIONAL_AND_LOCAL_IDS_DEEP, CONTACTS, PROPERTIES);</span>
<span class="fc" id="L120">        loggedUserId = users.loggedInUser().getId();</span>
<span class="fc" id="L121">        isTeamUser = teamUserManager.isTeamUser(loggedUserId);</span>
<span class="fc" id="L122">        patientId = users.contextUser().getId();</span>
<span class="fc" id="L123">        patientAccountId = userManager.getDefaultAccountId(patientId);</span>
<span class="fc" id="L124">        team = teamUserManager.findPrimaryTeam(getEHRRequestContext(), loggedUserId).orElse(null);</span>
<span class="fc" id="L125">        return users;</span>
    }

    public void loadEthnicity() {
<span class="fc" id="L129">        List&lt;PersonSecurePropertyDTO&gt; properties = userManager.getAllSecureProperties(getLoggedInEHRRequestContext(), patientId);</span>
<span class="fc" id="L130">        properties</span>
<span class="fc" id="L131">                .stream()</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">                .filter(property -&gt; (property.getPropertyName() == PropertyName.ethnicGroup) &amp;&amp;</span>
<span class="pc bpc" id="L133" title="3 of 4 branches missed.">                        ((property.getCountryOrNull() == null)</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">                                || ((team != null) &amp;&amp; (team.getCountry() != null)</span>
<span class="pc bnc" id="L135" title="All 2 branches missed.">                                &amp;&amp; team.getCountry().equals(property.getCountryOrNull()))))</span>
<span class="fc" id="L136">                .forEach(property -&gt; ethnicity = property.getValue());</span>
<span class="fc" id="L137">    }</span>

    public void loadMedications() {
<span class="fc" id="L140">        List&lt;DataWithUIPermissions&lt;Medication&gt;&gt; medications = medicationManager.getCurrentMedications(getLoggedInEHRRequestContext(), patientId, patientAccountId,</span>
                        false/*exclude medication not taken*/)
<span class="fc" id="L142">                .stream().map(DataWithUIPermissions::new).collect(toList());</span>
<span class="fc" id="L143">        currentMedications = medicationWebBean.convertMedicationsToDTOs(medications, ImmutableEntityDependency.&lt;Medication&gt;builder()</span>
<span class="fc" id="L144">                .locale(getLocale())</span>
<span class="fc" id="L145">                .iOSDevice(userAgentAnalyzerBean.isAnIOSDevice())</span>
<span class="fc" id="L146">                .loggedInRequestContext(getLoggedInEHRRequestContext())</span>
<span class="fc" id="L147">                .build());</span>
<span class="fc" id="L148">        currentMedications.sort(MedicationDTO.BY_REVERSE_START_DATE_THEN_ALPHABETIC_NAME);</span>
<span class="fc" id="L149">    }</span>

    public String viewSummary() {
        // load context info - current team, patientId etc
<span class="fc" id="L153">        var users = findUsers();</span>
<span class="fc" id="L154">        hideOldPatientBanner = config.isTimelineEnabled();</span>
        // Load patient

<span class="fc" id="L157">        PKBPerson person = users.contextUser();</span>
<span class="fc" id="L158">        patient = pkbPersonToPersonDtoMapper.personToPersonDto(person);</span>
<span class="fc" id="L159">        patientUnder18 = patient.isUnder18().orElse(true);</span>
<span class="fc" id="L160">        identifierPair = userManager.getIdentifierPair(patient.getId());</span>

<span class="fc" id="L162">        patient.getDeathTimestamp().ifPresent(dt -&gt; this.formattedDeathTimestamp = ManageUserProfileAction.formatDeathTimestamp(dt));</span>

        // Hack: if caller is an old-style carer with no account_org record, add him to the patient's org
<span class="fc" id="L165">        PKBPerson loggedInUser = users.loggedInUser();</span>

<span class="fc bfc" id="L167" title="All 2 branches covered.">        if (isCarerViewing()) {</span>
<span class="fc" id="L168">            questionnaireManager.getQuestionnaireListForCarer(loggedInUser, person)</span>
<span class="fc" id="L169">                    .peek(ques -&gt; questionnaires = ques)</span>
<span class="fc" id="L170">                    .peekLeft(this::handleQuestionnaireException);</span>
        }

        //loadClinicianList();
<span class="fc" id="L174">        carers = patientConsentManager.getCaregivers(patientId, CONTACTS);</span>
<span class="fc" id="L175">        loadEthnicity();</span>
<span class="fc" id="L176">        loadMedications();</span>

<span class="fc" id="L178">        List&lt;Allergy&gt; allergies = allergyManager.getAllergies(getLoggedInEHRRequestContext(), patientId, patientAccountId, 0, -1, false/*includeNegativeAllergies*/);</span>
<span class="fc" id="L179">        List&lt;DataWithUIPermissions&lt;Allergy&gt;&gt; allergiesWithPermissions = allergies.stream().map(DataWithUIPermissions::new).collect(toList());</span>
<span class="fc" id="L180">        allergyGroups = allergyGroupTransformer.groupByReverseLastActiveDateAndAlphabetical(allergiesWithPermissions);</span>

<span class="fc" id="L182">        PageFilterDTO pageFilterDTO = null;</span>
<span class="fc" id="L183">        List&lt;DataWithUIPermissions&lt;Diagnosis&gt;&gt; diagnoses = diagnosisManager.getDiagnoses(patientId, patientAccountId, pageFilterDTO, getLoggedInEHRRequestContext(),</span>
<span class="fc" id="L184">                false/*includeNegativeConditions*/).stream().map(DataWithUIPermissions::new).collect(toList());</span>
<span class="fc" id="L185">        currentDiagnosisGroups = diagnosisGroupTransformer.transformDiagnosisDTOsWithoutGrouping(</span>
<span class="fc" id="L186">                diagnoses.stream().filter(d -&gt; diagnosisHelper.isCurrent(d.getData())).collect(toList()),</span>
                false);

        try {
<span class="fc" id="L190">            List&lt;PHPlan&gt; planList = planManager.getPHPlans(getLoggedInEHRRequestContext(), loggedUserId, patientAccountId, 1000, 0, CREATOR_DETAILS, LAST_EDITOR_DEATILS);</span>
<span class="fc" id="L191">            var deletableByUniqueIdMap = planManager.planIsDeletableBy(planList, loggedInUser.getId());</span>
<span class="fc" id="L192">            plans = planList.stream()</span>
<span class="fc" id="L193">                    .map(p -&gt; phPlanToPlanDtoConverter.convert(p, loggedInUser, true, planManager.getPlanDeletableProvider(deletableByUniqueIdMap)))</span>
<span class="fc" id="L194">                    .collect(toList());</span>
<span class="nc" id="L195">        } catch (Exception e) {</span>
            // don't break the entire page... just log here and show a warning
            // TODO: Rob4826?
<span class="nc" id="L198">            LOGGER.error(&quot;Rob4826: failed loading plans for user {}&quot;, loggedUserId, e);</span>
<span class="nc" id="L199">            addActionError(getText(&quot;err.care.plan.loading&quot;));</span>
<span class="fc" id="L200">        }</span>

<span class="fc" id="L202">        consentStatus = getEHRRequestContext().getConsentStatus();</span>
<span class="fc" id="L203">        consent = consentStatus.getConsent().orElse(null);</span>

<span class="fc" id="L205">        return Action.SUCCESS;</span>
    }

    public boolean isCarerViewing() {
<span class="pc bpc" id="L209" title="1 of 4 branches missed.">        return contextUserUtil.getContextUser() != null &amp;&amp; isLoggedInUserPatient();</span>
    }

    public boolean isDischarged() {

<span class="pc bpc" id="L214" title="2 of 4 branches missed.">        if (patient != null &amp;&amp;</span>
                team != null) {
<span class="fc" id="L216">            Optional&lt;PatientConsentDTO&gt; consent = patientConsentManager.findPatientConsent(patient.getId(), team.getId(), AccessingEntityType.TEAM);</span>

<span class="fc" id="L218">            return consent.map(PatientConsentDTO::discharged).orElse(false);</span>

            //if there's no consent then we should hide the discharge button
        }

<span class="nc" id="L223">        return false;</span>
    }

    public ConsentStatus getConsentStatus() {
<span class="fc" id="L227">        return consentStatus;</span>
    }

    public void setConsentStatus(ConsentStatus consentStatus) {
<span class="nc" id="L231">        this.consentStatus = consentStatus;</span>
<span class="nc" id="L232">    }</span>

    public PatientConsentDTO getConsent() {
<span class="fc" id="L235">        return consent;</span>
    }

    public void setConsent(PatientConsentDTO consent) {
<span class="nc" id="L239">        this.consent = consent;</span>
<span class="nc" id="L240">    }</span>

    public boolean getIsTeamUser() {
<span class="nc" id="L243">        return isTeamUser;</span>
    }

    public void setTeamUser(boolean isTeamUser) {
<span class="nc" id="L247">        this.isTeamUser = isTeamUser;</span>
<span class="nc" id="L248">    }</span>

    public TeamUserManager getTeamUserManager() {
<span class="nc" id="L251">        return teamUserManager;</span>
    }

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L255">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L256">    }</span>

    public AllergyManager getAllergyManager() {
<span class="nc" id="L259">        return allergyManager;</span>
    }

    public void setAllergyManager(AllergyManager allergyManager) {
<span class="fc" id="L263">        this.allergyManager = allergyManager;</span>
<span class="fc" id="L264">    }</span>

    public MedicationManager getMedicationManager() {
<span class="nc" id="L267">        return medicationManager;</span>
    }

    public void setMedicationManager(MedicationManager medicationManager) {
<span class="fc" id="L271">        this.medicationManager = medicationManager;</span>
<span class="fc" id="L272">    }</span>

    public DiagnosisManager getDiagnosisManager() {
<span class="nc" id="L275">        return diagnosisManager;</span>
    }

    public void setDiagnosisManager(DiagnosisManager diagnosisManager) {
<span class="fc" id="L279">        this.diagnosisManager = diagnosisManager;</span>
<span class="fc" id="L280">    }</span>

    public UserManager getUserManager() {
<span class="nc" id="L283">        return userManager;</span>
    }

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L287">        this.userManager = userManager;</span>
<span class="fc" id="L288">    }</span>

    public PlanManager getPlanManager() {
<span class="nc" id="L291">        return planManager;</span>
    }

    public void setPlanManager(PlanManager planManager) {
<span class="fc" id="L295">        this.planManager = planManager;</span>
<span class="fc" id="L296">    }</span>


    public List&lt;MedicationDTO&gt; getCurrentMedications() {
<span class="fc" id="L300">        return currentMedications;</span>
    }

    public PersonDto getPatient() {
<span class="fc" id="L304">        return patient;</span>
    }

    public void setPatient(PersonDto patient) {
<span class="nc" id="L308">        this.patient = patient;</span>
<span class="nc" id="L309">    }</span>

    public String getEthnicity() {
<span class="fc" id="L312">        return ethnicity;</span>
    }

    public void setEthnicity(String ethnicity) {
<span class="nc" id="L316">        this.ethnicity = ethnicity;</span>
<span class="nc" id="L317">    }</span>

    public List&lt;PKBPerson&gt; getCarers() {
<span class="fc" id="L320">        return carers;</span>
    }

    public void setCarers(List&lt;PKBPerson&gt; carers) {
<span class="nc" id="L324">        this.carers = carers;</span>
<span class="nc" id="L325">    }</span>

    public List&lt;AllergyGroupDto&gt; getAllergyGroups() {
<span class="fc" id="L328">        return allergyGroups;</span>
    }

    public Long getPatientId() {
<span class="nc" id="L332">        return patientId;</span>
    }

    public void setPatientId(Long patientId) {
<span class="nc" id="L336">        this.patientId = patientId;</span>
<span class="nc" id="L337">    }</span>

    public UserWebBean getUserWebBean() {
<span class="nc" id="L340">        return userWebBean;</span>
    }

    public void setUserWebBean(UserWebBean userWebBean) {
<span class="fc" id="L344">        this.userWebBean = userWebBean;</span>
<span class="fc" id="L345">    }</span>

    public IMedicationWebBean getMedicationWebBean() {
<span class="nc" id="L348">        return medicationWebBean;</span>
    }

    public void setMedicationWebBean(IMedicationWebBean medicationWebBean) {
<span class="fc" id="L352">        this.medicationWebBean = medicationWebBean;</span>
<span class="fc" id="L353">    }</span>

    public DataUploadManager getDataUploadManager() {
<span class="nc" id="L356">        return dataUploadManager;</span>
    }

    public void setDataUploadManager(DataUploadManager dataUploadManager) {
<span class="fc" id="L360">        this.dataUploadManager = dataUploadManager;</span>
<span class="fc" id="L361">    }</span>

    public String getFormattedDeathTimestamp() {
<span class="fc" id="L364">        return formattedDeathTimestamp;</span>
    }

    public void setFormattedDeathTimestamp(String formattedDeathTimestamp) {
<span class="nc" id="L368">        this.formattedDeathTimestamp = formattedDeathTimestamp;</span>
<span class="nc" id="L369">    }</span>

    public void setPatientConsentManager(PatientConsentManager patientConsentManager) {
<span class="fc" id="L372">        this.patientConsentManager = patientConsentManager;</span>
<span class="fc" id="L373">    }</span>

    public PatientConsentManager getPatientConsentManager() {
<span class="nc" id="L376">        return patientConsentManager;</span>
    }

    public void setQuestionnaireManager(QuestionnaireManager questionnaireManager) {
<span class="fc" id="L380">        this.questionnaireManager = questionnaireManager;</span>
<span class="fc" id="L381">    }</span>

    public List&lt;DiagnosisGroupDto&gt; getCurrentDiagnosisGroups() {
<span class="fc" id="L384">        return currentDiagnosisGroups;</span>
    }

    public List&lt;PHPlanDTO&gt; getPlans() {
<span class="fc" id="L388">        return plans;</span>
    }

    public void setPlans(List&lt;PHPlanDTO&gt; plans) {
<span class="nc" id="L392">        this.plans = plans;</span>
<span class="nc" id="L393">    }</span>

    public PKBPersonIdentifierPair getIdentifierPair() {
<span class="nc" id="L396">        return identifierPair;</span>
    }

    public boolean isHideOldPatientBanner() {
<span class="nc" id="L400">        return hideOldPatientBanner;</span>
    }

    public &lt;T&gt; boolean isListUnavailable(List&lt;T&gt; list) {
<span class="fc" id="L404">        return isEmpty(list);</span>
    }

    public boolean isPatientUnder18() {
<span class="fc" id="L408">        return patientUnder18;</span>
    }

    public void setDiagnosisHelper(DiagnosisHelper diagnosisHelper) {
<span class="fc" id="L412">        this.diagnosisHelper = diagnosisHelper;</span>
<span class="fc" id="L413">    }</span>

    public void setPhPlanToPlanDtoConverter(PhPlanToPlanDtoConverter phPlanToPlanDtoConverter) {
<span class="fc" id="L416">        this.phPlanToPlanDtoConverter = phPlanToPlanDtoConverter;</span>
<span class="fc" id="L417">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>