<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DiscussDatapointService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action</a> &gt; <span class="el_source">DiscussDatapointService.java</span></div><h1>DiscussDatapointService.java</h1><pre class="source lang-java linenums">package com.pkb.action;

import com.pkb.action.library.LibraryUtil;
import com.pkb.action.message.ComposeMessageAction;
import com.pkb.action.message.UIDiscussDto;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.common.config.PhrConfig;
import com.pkb.institute.entity.InstituteLibraryEntry;
import com.pkb.institute.entity.Team;
import com.pkb.personallibrary.entity.PersonalLibraryEntryDTO;
import com.pkb.service.datapoint.impl.DataPointManager;
import com.pkb.service.personallibrary.PersonalLibraryManager;
import com.pkb.service.team.TeamUserManager;
import org.apache.commons.collections.CollectionUtils;
import org.immutables.value.Value;
import org.springframework.context.MessageSource;

import java.util.HashSet;
import java.util.List;
import java.util.Objects;
import java.util.Optional;

import static com.pkb.action.BaseAction.DISCUSS;
import static com.pkb.action.BaseAction.RELOAD;
import static com.pkb.action.library.ShowLibraryAction.PATIENT_REFERER;
import static com.pkb.datamodel.ui.ResponseMeta.ofActionError;

public class DiscussDatapointService extends AbstractService {

    private final PersonalLibraryManager personalLibraryManager;
    private final TeamUserManager teamUserManager;
    private final PhrConfig config;

    public DiscussDatapointService(DataPointManager dataPointManager, MessageSource messageSource, PersonalLibraryManager personalLibraryManager, TeamUserManager teamUserManager, PhrConfig config) {
<span class="fc" id="L35">        super(dataPointManager, messageSource);</span>
<span class="fc" id="L36">        this.personalLibraryManager = personalLibraryManager;</span>
<span class="fc" id="L37">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L38">        this.config = config;</span>
<span class="fc" id="L39">    }</span>

    interface DiscussRequest extends BaseRequest {
        boolean isEmpty();
        String emptyMessageKey();
        String topic();
        String buildMessageText(LoggedInEHRRequestContext loggedInContext, DiscussDatapointService service);
    }

    @Value.Immutable
    public interface DiscussLibraryRequest extends DiscussRequest {
        Optional&lt;List&lt;Long&gt;&gt; personalLibraryIds();
        Optional&lt;List&lt;String&gt;&gt; instituteLibraryIds();

        @Override
        default boolean isEmpty() {
<span class="fc bfc" id="L55" title="All 2 branches covered.">            return personalLibraryIds().map(CollectionUtils::isEmpty).orElse(true)</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">                    &amp;&amp; instituteLibraryIds().map(CollectionUtils::isEmpty).orElse(true);</span>
        }

        @Override
        default String emptyMessageKey() {
<span class="fc" id="L61">            return &quot;viewLibrariesAction.err.select_entry&quot;;</span>
        }

        @Override
        default String topic() {
<span class="fc" id="L66">            return ComposeMessageAction.TOPIC_LIBRARY_ENTRIES;</span>
        }

        @Override
        default String buildMessageText(LoggedInEHRRequestContext loggedInContext, DiscussDatapointService service) {
<span class="fc" id="L71">            StringBuilder messageText = new StringBuilder();</span>

<span class="fc" id="L73">            personalLibraryIds().filter(CollectionUtils::isNotEmpty).ifPresent(libraryIds -&gt; {</span>
<span class="fc" id="L74">                List&lt;PersonalLibraryEntryDTO&gt; entries = service.personalLibraryManager.getEntries(loggedInContext, libraryIds,</span>
<span class="fc" id="L75">                        loggedInContext.getContextOrAccessingUserId());</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">                if (entries != null) {</span>
<span class="fc" id="L77">                    entries.stream()</span>
<span class="fc" id="L78">                            .filter(Objects::nonNull)</span>
<span class="fc" id="L79">                            .forEach(entry -&gt; messageText</span>
<span class="fc" id="L80">                                    .append(&quot;\n\n&quot;)</span>
<span class="fc" id="L81">                                    .append(service.messageSource.getMessage(&quot;viewLibrariesAction.msg.my_library_entry_with_description&quot;,</span>
<span class="fc" id="L82">                                            new String[]{entry.getDescription()}, getLocale()))</span>
<span class="fc" id="L83">                                    .append(&quot;\n&quot;)</span>
<span class="fc" id="L84">                                    .append(service.messageSource.getMessage(&quot;viewLibrariesAction.msg.url&quot;,</span>
<span class="fc" id="L85">                                            new String[]{entry.getUrl()}, getLocale())));</span>
                }
<span class="fc" id="L87">            });</span>

<span class="fc" id="L89">            instituteLibraryIds().filter(CollectionUtils::isNotEmpty).ifPresent(libraryIds -&gt; {</span>
<span class="fc" id="L90">                List&lt;Team&gt; teams = service.teamUserManager.getUserTeamsStrictlyFiltered(loggedInContext, true, Team.Lazy.LIBRARY);</span>
<span class="fc" id="L91">                libraryIds.forEach(idString -&gt; {</span>
<span class="fc" id="L92">                    String[] parts = idString.split(&quot;,&quot;);</span>
<span class="fc" id="L93">                    Long id = Long.parseLong(parts[0]);</span>
<span class="fc" id="L94">                    Long teamId = Long.parseLong(parts[1]);</span>
<span class="fc" id="L95">                    new HashSet&lt;&gt;(teams).stream()</span>
<span class="fc" id="L96">                            .filter(t -&gt; (t.getId()).equals(teamId))</span>
<span class="fc" id="L97">                            .findFirst()</span>
<span class="fc" id="L98">                            .ifPresent(t -&gt; t.getLibraryEntries()</span>
<span class="fc" id="L99">                                    .stream()</span>
<span class="fc" id="L100">                                    .filter(candidate -&gt; candidate.getId().equals(id))</span>
<span class="fc" id="L101">                                    .forEach(candidate -&gt; messageText</span>
<span class="fc" id="L102">                                            .append(&quot;\n\n&quot;)</span>
<span class="fc" id="L103">                                            .append(service.messageSource.getMessage(&quot;viewLibrariesAction.msg.library_entry_for_team_with_description&quot;,</span>
<span class="fc" id="L104">                                                    new String[]{t.getOrg().getName() + &quot; &quot; + t.getName(), candidate.getDescription()}, getLocale()))</span>
<span class="fc" id="L105">                                            .append(&quot;\n&quot;)</span>
<span class="fc" id="L106">                                            .append(service.messageSource.getMessage(&quot;viewLibrariesAction.msg.url&quot;,</span>
<span class="fc" id="L107">                                                    new String[]{getURLForTeamEntryDiscussion(candidate, loggedInContext, service)}, getLocale()))));</span>
<span class="fc" id="L108">                });</span>
<span class="fc" id="L109">            });</span>

<span class="fc" id="L111">            return messageText.toString();</span>
        }

        default String getURLForTeamEntryDiscussion(InstituteLibraryEntry entry,
                                                    LoggedInEHRRequestContext loggedInContext,
                                                    DiscussDatapointService service) {
            // We have libraries with null content type in the production database
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">            if (entry.getContentType() == null) {</span>
<span class="nc" id="L119">                return entry.getUrl();</span>
            }

<span class="fc bfc" id="L122" title="All 3 branches covered.">            switch (entry.getContentType()) {</span>
                case FILE:
<span class="fc" id="L124">                    return LibraryUtil.buildLibraryFileURL(entry.getUrl());</span>
                case FOLDER:
<span class="fc" id="L126">                    var relativeURL = LibraryUtil.buildLibraryFolderURL(</span>
                            entry,
                            PATIENT_REFERER,
<span class="fc" id="L129">                            Optional.of(entry.getInstitute().getId()),</span>
<span class="fc" id="L130">                            loggedInContext.getContextUserId());</span>
<span class="fc" id="L131">                    return service.config.getBaseURL() + relativeURL;</span>
                default:
<span class="fc" id="L133">                    return entry.getUrl();</span>
            }
        }
    }

    public UIDiscussDto discuss(DiscussRequest request) {
<span class="fc" id="L139">        return request.getEHRRequestContext().getLoggedInContext()</span>
<span class="fc" id="L140">                .map(loggedInContext -&gt; {</span>
<span class="fc" id="L141">                    UIDiscussDto dto = new UIDiscussDto();</span>
<span class="fc bfc" id="L142" title="All 2 branches covered.">                    if (request.isEmpty()) {</span>
<span class="fc" id="L143">                        dto.setContextRecipientId(Optional.empty());</span>
<span class="fc" id="L144">                        dto.setResponseMeta(ofActionError(messageSource.getMessage(request.emptyMessageKey(),</span>
<span class="fc" id="L145">                                null, request.getLocale())));</span>
<span class="fc" id="L146">                        dto.setActionResult(RELOAD);</span>
                    } else {
<span class="fc" id="L148">                        dto.setDiscussMessage(request.buildMessageText(loggedInContext, this));</span>
<span class="fc" id="L149">                        dto.setDiscussTopic(request.topic());</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">                        dto.setContextRecipientId(loggedInContext.isUserInOwnAccount() ? Optional.empty() : loggedInContext.getContextUserId());</span>
<span class="fc" id="L151">                        dto.setActionResult(DISCUSS);</span>
                    }
<span class="fc" id="L153">                    return dto;</span>
                })
<span class="pc" id="L155">                .orElseThrow(() -&gt; new IllegalStateException(&quot;Non-existent logged in context: unable to discuss data point&quot;));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>