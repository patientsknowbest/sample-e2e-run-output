<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OtpAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action</a> &gt; <span class="el_source">OtpAction.java</span></div><h1>OtpAction.java</h1><pre class="source lang-java linenums">package com.pkb.action;

import com.pkb.entities.enums.Route;
import com.pkb.service.user.impl.UserManager;
import com.pkb.servlets.filter.PreAuthenticationSuccessHandler;
import com.pkb.util.PKBConstants;
import io.prometheus.client.Counter;
import org.apache.commons.lang3.StringUtils;
import org.apache.http.client.utils.URIBuilder;

/**
 * This Action allows PKB to offer a consistent URL that customers can use to
 * login via a OTP. The intention is that we can change the implementation of
 * the OTP login functionality without changing the external link that
 * customers will use.
 */
<span class="fc" id="L17">public class OtpAction extends BaseAction {</span>

    private static final long serialVersionUID = 1L;

<span class="fc" id="L21">    public static final Counter COUNTER = Counter.build()</span>
<span class="fc" id="L22">            .name(&quot;pkb_phr_otp_login_count&quot;)</span>
<span class="fc" id="L23">            .help(&quot;count of successful OTP (one-time password) logins&quot;)</span>
<span class="fc" id="L24">            .register();</span>

    /**
     * The OTP token will have been retrieved by the customer from the REST
     * API, very shortly before calling the OTP Action.
     */
    private String otpToken;

    /**
     * This Action will ultimately redirect to this URL to perform the login.
     */
    private String otpUrl;

    /**
     * This parameter can be used to request a redirect to a specific page
     * within PKB after OTP authentication.
     */
    private String redirect_uri;

    public String otpLogin() {
<span class="fc bfc" id="L44" title="All 2 branches covered.">        if (loggedInUserUtil.isUserLoggedIn()) {</span>
<span class="fc" id="L45">            userManager.logoutUser(loggedInUserUtil.getLoggedInUserId());</span>
        }

<span class="fc" id="L48">        URIBuilder builder = new URIBuilder()</span>
<span class="fc" id="L49">                .setPath(&quot;/j_spring_security_check&quot;)</span>
<span class="fc" id="L50">                .setParameter(&quot;j_username&quot;, otpToken);</span>

<span class="pc bpc" id="L52" title="2 of 4 branches missed.">        if (StringUtils.isNotBlank(redirect_uri) &amp;&amp; checkLink(redirect_uri)) {</span>
<span class="fc" id="L53">            builder.setParameter(PreAuthenticationSuccessHandler.REDIRECT_URI_PARAMETER, redirect_uri);</span>
        }

<span class="fc" id="L56">        otpUrl = builder.toString();</span>

<span class="fc" id="L58">        session.put(PKBConstants.ROUTE, Route.WEBAPP_OTP);</span>
<span class="fc" id="L59">        COUNTER.inc();</span>
<span class="fc" id="L60">        return &quot;otpLogin&quot;;</span>
    }

    /**
     * When a redirect is requested as part of an OTP login, this method checks
     * that the requested URI is valid. Only a relative link will be accepted;
     * no external links are permitted.
     *
     * @param uri
     * @return
     */
    private boolean checkLink(String uri) {
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">        if (!uri.contains(&quot;://&quot;)) {</span>
<span class="fc" id="L73">            LOGGER.info(&quot;URL rejected: relative URL&quot;);</span>
<span class="fc" id="L74">            return true;</span>
        }
<span class="nc" id="L76">        return false;</span>
    }

    public String getOtpToken() {
<span class="nc" id="L80">        return otpToken;</span>
    }

    public void setOtpToken(String otpToken) {
<span class="fc" id="L84">        this.otpToken = otpToken;</span>
<span class="fc" id="L85">    }</span>

    public String getOtpUrl() {
<span class="fc" id="L88">        return otpUrl;</span>
    }

    public void setOtpUrl(String otpUrl) {
<span class="nc" id="L92">        this.otpUrl = otpUrl;</span>
<span class="nc" id="L93">    }</span>

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L96">        this.userManager = userManager;</span>
<span class="fc" id="L97">    }</span>

    public String getRedirect_uri() {
<span class="nc" id="L100">        return redirect_uri;</span>
    }

    public void setRedirect_uri(String redirect_uri) {
<span class="fc" id="L104">        this.redirect_uri = redirect_uri;</span>
<span class="fc" id="L105">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>