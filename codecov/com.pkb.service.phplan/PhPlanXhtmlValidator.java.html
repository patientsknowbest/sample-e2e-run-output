<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PhPlanXhtmlValidator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.phplan</a> &gt; <span class="el_source">PhPlanXhtmlValidator.java</span></div><h1>PhPlanXhtmlValidator.java</h1><pre class="source lang-java linenums">package com.pkb.service.phplan;

import com.pkb.common.util.FrameFilter;
import com.pkb.phplan.entity.PHPlan;
import com.pkb.phplan.entity.PlanField;
import com.pkb.util.security.CustomStyledHtmlFilter;
import org.apache.commons.lang3.StringUtils;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NodeList;
import org.xml.sax.ErrorHandler;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;
import org.xml.sax.SAXParseException;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import java.io.IOException;
import java.io.StringReader;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.TreeMap;
import java.util.TreeSet;

@Component
<span class="fc" id="L34">public class PhPlanXhtmlValidator {</span>

<span class="fc" id="L36">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    @Autowired
    private CustomStyledHtmlFilter customHTMLFilter;

    public void validatePlan(PHPlan pHPlan) {
<span class="pc bpc" id="L42" title="1 of 2 branches missed.">        if (pHPlan != null) {</span>
<span class="fc" id="L43">            List&lt;PlanField&gt; planFields = pHPlan.getPlanFields();</span>
<span class="fc bfc" id="L44" title="All 2 branches covered.">            if (planFields != null) {</span>
<span class="fc bfc" id="L45" title="All 2 branches covered.">                for (PlanField planField : planFields) {</span>
<span class="fc bfc" id="L46" title="All 2 branches covered.">                    if (StringUtils.isEmpty(planField.getText())) {</span>
<span class="fc" id="L47">                        continue;</span>
                    }
<span class="fc bfc" id="L49" title="All 2 branches covered.">                    if (planField.getText().startsWith(&quot;&lt;div&quot;)) {</span>
<span class="fc" id="L50">                        validateXhtml(planField.getText(), planField.getLabel().toString(), false);</span>
                    }
<span class="fc" id="L52">                }</span>
            }
<span class="fc" id="L54">        } else {</span>
<span class="nc" id="L55">            RuntimeException e = new RuntimeException(&quot;PHR-7257: validatePlan called with null plan&quot;);</span>
<span class="nc" id="L56">            LOGGER.error(&quot;PHR-7257: validatePlan called with null plan&quot;, FrameFilter.filter(e));</span>
<span class="nc" id="L57">            throw e;</span>
        }
<span class="fc" id="L59">    }</span>

    /**
     * @return List&lt;String&gt; field errors
     * @throws ParserConfigurationException
     * @throws SAXException
     * @throws IOException
     */
    @NotNull
    public List&lt;String&gt; validateXhtml(String xhtml, String fieldName, boolean extraTemplateChecks) {
<span class="fc" id="L69">        List&lt;String&gt; errors = new ArrayList&lt;&gt;();</span>
        try {
<span class="fc" id="L71">            xhtml = customHTMLFilter.filter(xhtml);</span>

            // Check validity by building full parse tree

<span class="pc bpc" id="L75" title="1 of 2 branches missed.">            if (!xhtml.startsWith(&quot;&lt;!DOCTYPE&quot;)) {</span>
<span class="fc" id="L76">                xhtml = &quot;&lt;!DOCTYPE html PUBLIC \&quot;-//W3C//DTD XHTML 1.1 Transitional//EN\&quot; \&quot;&quot;</span>
                        + PlanManagerXhtmlValidationHelper.XHTML_TRANS_DTD_URI
                        + &quot;\&quot;&gt;&lt;html&gt;&lt;head&gt;&lt;title&gt;Dummy&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&lt;form action='dummy' name='dummy' &gt;&quot;
                        + xhtml + &quot;\n&lt;/form&gt;&lt;/body&gt;&lt;/html&gt;&quot;;
            }

<span class="fc" id="L82">            ErrorHandler eh = new ErrorHandler() {</span>

                @Override
                public void fatalError(SAXParseException e) throws SAXException {
<span class="nc" id="L86">                    addErrors(e, errors, fieldName);</span>
<span class="nc" id="L87">                }</span>

                private void addErrors(SAXParseException e, List&lt;String&gt; errors, String fieldName) throws SAXParseException {
<span class="nc" id="L90">                    long lineNumber = e.getLineNumber() - 1L;</span>
<span class="nc" id="L91">                    errors.add(&quot;Invalid html at line &lt;input type='button' value='&quot; + lineNumber + &quot;' onclick='selectLine(&quot; + lineNumber</span>
<span class="nc" id="L92">                            + &quot;,\&quot;&quot; + fieldName + &quot;\&quot;)'/&gt;&quot; + lineNumber + &quot;: &quot; + e.getMessage());</span>
<span class="nc" id="L93">                    throw e;</span>
                }

                @Override
                public void error(SAXParseException e) throws SAXException {
<span class="nc" id="L98">                    addErrors(e, errors, fieldName);</span>
<span class="nc" id="L99">                }</span>

                @Override
                public void warning(SAXParseException e) throws SAXException {
<span class="nc" id="L103">                    long lineNumber = e.getLineNumber() - 1L;</span>
<span class="nc" id="L104">                    LOGGER.info(&quot;Parse warning on line {} of {}: {}&quot;, lineNumber, fieldName, e.getMessage());</span>
<span class="nc" id="L105">                }</span>
            };

<span class="fc" id="L108">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span>
            //dbf.setValidating(true);
<span class="fc" id="L110">            DocumentBuilder db = dbf.newDocumentBuilder();</span>
            // hack: we don't want it to load the DTD from the network, so we'll provide our own
            // entity resolve that supplies it from a String.  Instant load!
<span class="fc" id="L113">            db.setEntityResolver((publicId, systemId) -&gt; {</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">                if (systemId.equals(PlanManagerXhtmlValidationHelper.XHTML_TRANS_DTD_URI)) {</span>
<span class="fc" id="L115">                    return new InputSource(new StringReader(PlanManagerXhtmlValidationHelper.XHTML_TRANS_DTD));</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">                } else if (systemId.endsWith(PlanManagerXhtmlValidationHelper.XHTML_LAT1_ENT_REF)) {</span>
<span class="fc" id="L117">                    return new InputSource(new StringReader(PlanManagerXhtmlValidationHelper.XHTML_LAT1_ENT));</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">                } else if (systemId.endsWith(PlanManagerXhtmlValidationHelper.XHTML_SYMBOL_ENT_REF)) {</span>
<span class="fc" id="L119">                    return new InputSource(new StringReader(PlanManagerXhtmlValidationHelper.XHTML_SYMBOL_ENT));</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">                } else if (systemId.endsWith(PlanManagerXhtmlValidationHelper.XHTML_SPECIAL_ENT_REF)) {</span>
<span class="fc" id="L121">                    return new InputSource(new StringReader(PlanManagerXhtmlValidationHelper.XHTML_SPECIAL_ENT));</span>
                } else {
<span class="nc" id="L123">                    LOGGER.warn(&quot;no match on entity: {} =&gt; {}&quot;, publicId, systemId);</span>
                    // Null is a valid value which means use the default resolver
                    //noinspection ReturnOfNull
<span class="nc" id="L126">                    return null;</span>
                }
            });
<span class="fc" id="L129">            db.setErrorHandler(eh);</span>
<span class="fc" id="L130">            InputSource input = new InputSource(new StringReader(xhtml));</span>
<span class="fc" id="L131">            Document dom = db.parse(input);</span>

<span class="fc bfc" id="L133" title="All 2 branches covered.">            if (extraTemplateChecks) {</span>
                // Check for specific cases where the html will not do what the author wants

<span class="fc" id="L136">                Element root = dom.getDocumentElement();</span>

<span class="fc" id="L138">                Set&lt;String&gt; selectNames = new TreeSet&lt;&gt;();</span>
<span class="fc" id="L139">                NodeList selectNodeList = root.getElementsByTagName(&quot;select&quot;);</span>
<span class="fc" id="L140">                List&lt;Element&gt; selects = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">                for (int i = 0; i &lt; selectNodeList.getLength(); ++i) {</span>
<span class="fc" id="L142">                    Element select = (Element) selectNodeList.item(i);</span>
<span class="fc" id="L143">                    String selectName = select.getAttribute(&quot;name&quot;);</span>
<span class="pc bpc" id="L144" title="2 of 4 branches missed.">                    if ((selectName != null) &amp;&amp; selectName.isEmpty()) {</span>
<span class="nc" id="L145">                        errors.add(&quot;Invalid html: there is a &amp;lt;select&amp;gt; without a name&quot;);</span>
<span class="nc" id="L146">                        return errors;</span>
                    }
<span class="pc bpc" id="L148" title="1 of 2 branches missed.">                    if (selectNames.contains(selectName)) {</span>
<span class="nc" id="L149">                        errors.add(&quot;Invalid html: there is more than one instance of &amp;lt;select name='&quot; + selectName + &quot;'&amp;gt;&quot;);</span>
<span class="nc" id="L150">                        return errors;</span>
                    }
<span class="fc" id="L152">                    selectNames.add(selectName);</span>

<span class="fc" id="L154">                    NodeList optionNodeList = select.getElementsByTagName(&quot;option&quot;);</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">                    for (int j = 0; j &lt; optionNodeList.getLength(); ++j) {</span>
<span class="fc" id="L156">                        Element option = (Element) optionNodeList.item(j);</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">                        if (StringUtils.isEmpty(getElementTextContent(option))) {</span>
<span class="nc" id="L158">                            errors.add(&quot;Invalid html: an option within &amp;lt;select name='&quot; + selectName + &quot;'&amp;gt; has no text content&quot;);</span>
<span class="nc" id="L159">                            return errors;</span>
                        }
                    }
                }

<span class="fc" id="L164">                NodeList nodeList = root.getElementsByTagName(&quot;input&quot;);</span>

<span class="fc" id="L166">                List&lt;Element&gt; radios = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L167">                List&lt;Element&gt; checkBoxes = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L168">                List&lt;Element&gt; texts = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L169">                List&lt;Element&gt; dates = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L171" title="All 2 branches covered.">                for (int i = 0; i &lt; nodeList.getLength(); ++i) {</span>
<span class="fc" id="L172">                    Element element = (Element) nodeList.item(i);</span>
<span class="fc bfc" id="L173" title="All 2 branches covered.">                    if (&quot;radio&quot;.equals(element.getAttribute(&quot;type&quot;))) {</span>
<span class="fc" id="L174">                        radios.add(element);</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">                    } else if (&quot;checkbox&quot;.equals(element.getAttribute(&quot;type&quot;))) {</span>
<span class="fc" id="L176">                        checkBoxes.add(element);</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">                    } else if (&quot;text&quot;.equals(element.getAttribute(&quot;type&quot;))) {</span>
<span class="fc" id="L178">                        texts.add(element);</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">                    } else if (&quot;date&quot;.equals(element.getAttribute(&quot;type&quot;))) {</span>
<span class="nc" id="L180">                        dates.add(element);</span>
                    }
                }

<span class="fc" id="L184">                Map&lt;String, Integer&gt; radioCounts = new TreeMap&lt;&gt;();</span>
<span class="fc bfc" id="L185" title="All 2 branches covered.">                for (Element radio : radios) {</span>
<span class="fc" id="L186">                    String radioName = radio.getAttribute(&quot;name&quot;);</span>
<span class="pc bpc" id="L187" title="2 of 4 branches missed.">                    if ((radioName != null) &amp;&amp; radioName.isEmpty()) {</span>
<span class="nc" id="L188">                        errors.add(&quot;Invalid html: there is an &amp;lt;input type='radio'&amp;gt; without a name&quot;);</span>
<span class="nc" id="L189">                        return errors;</span>
                    }
<span class="pc bpc" id="L191" title="2 of 4 branches missed.">                    if (StringUtils.isEmpty(getElementTextContent(radio)) &amp;&amp; StringUtils.isEmpty(radio.getAttribute(&quot;value&quot;))) {</span>
<span class="nc" id="L192">                        errors.add(&quot;Invalid html: &amp;lt;input type='radio' name='&quot; + radioName + &quot;'&amp;gt; has no text contents&quot;);</span>
<span class="nc" id="L193">                        return errors;</span>
                    }

<span class="fc bfc" id="L196" title="All 2 branches covered.">                    if (radioCounts.containsKey(radioName)) {</span>
<span class="fc" id="L197">                        radioCounts.put(radioName, radioCounts.get(radioName) + 1);</span>
                    } else {
<span class="fc" id="L199">                        radioCounts.put(radioName, 1);</span>
                    }
<span class="fc" id="L201">                }</span>

<span class="fc bfc" id="L203" title="All 2 branches covered.">                for (Map.Entry&lt;String, Integer&gt; radioCount : radioCounts.entrySet()) {</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">                    if (radioCount.getValue() == 1) {</span>
<span class="nc" id="L205">                        errors.add(&quot;Invalid html: There is only one instance of &amp;lt;input type='radio' name='&quot; + radioCount.getKey()</span>
                                + &quot;'&amp;gt;&quot;);
<span class="nc" id="L207">                        return errors;</span>
                    }
<span class="fc" id="L209">                }</span>

<span class="fc" id="L211">                Set&lt;String&gt; checkBoxNames = new TreeSet&lt;&gt;();</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">                for (Element checkBox : checkBoxes) {</span>
<span class="fc" id="L213">                    String checkBoxName = checkBox.getAttribute(&quot;name&quot;);</span>
<span class="pc bpc" id="L214" title="2 of 4 branches missed.">                    if ((checkBoxName != null) &amp;&amp; checkBoxName.isEmpty()) {</span>
<span class="nc" id="L215">                        errors.add(&quot;Invalid html: there is an &amp;lt;input type='checkbox'&amp;gt; without a name&quot;);</span>
<span class="nc" id="L216">                        return errors;</span>
                    }
<span class="pc bpc" id="L218" title="1 of 2 branches missed.">                    if (checkBoxNames.contains(checkBoxName)) {</span>
<span class="nc" id="L219">                        errors.add(&quot;Invalid html: there is more than one instance of &amp;lt;input type='checkbox' name='&quot; + checkBoxName</span>
                                + &quot;'&amp;gt;&quot;);
<span class="nc" id="L221">                        return errors;</span>
                    }
<span class="fc" id="L223">                    checkBoxNames.add(checkBoxName);</span>
<span class="pc bpc" id="L224" title="2 of 4 branches missed.">                    if (StringUtils.isEmpty(getElementTextContent(checkBox)) &amp;&amp; StringUtils.isEmpty(checkBox.getAttribute(&quot;value&quot;))) {</span>
<span class="nc" id="L225">                        errors.add(&quot;Invalid html: &amp;lt;input type='checkbox' name='&quot; + checkBoxName + &quot;'&amp;gt; has no text contents&quot;);</span>
<span class="nc" id="L226">                        return errors;</span>
                    }
<span class="fc" id="L228">                }</span>

<span class="fc" id="L230">                Set&lt;String&gt; textNames = new TreeSet&lt;&gt;();</span>
<span class="fc bfc" id="L231" title="All 2 branches covered.">                for (Element text : texts) {</span>
<span class="fc" id="L232">                    String textName = text.getAttribute(&quot;name&quot;);</span>
<span class="pc bpc" id="L233" title="2 of 4 branches missed.">                    if ((textName != null) &amp;&amp; textName.isEmpty()) {</span>
<span class="nc" id="L234">                        errors.add(&quot;Invalid html: there is an &amp;lt;input type='text'&amp;gt; without a name&quot;);</span>
<span class="nc" id="L235">                        return errors;</span>
                    }
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">                    if (textNames.contains(textName)) {</span>
<span class="nc" id="L238">                        errors.add(&quot;Invalid html: there is more than one instance of &amp;lt;input type='text' name='&quot; + textName + &quot;'&amp;gt;&quot;);</span>
<span class="nc" id="L239">                        return errors;</span>
                    }
<span class="fc" id="L241">                    textNames.add(textName);</span>
<span class="fc" id="L242">                }</span>

<span class="fc" id="L244">                Set&lt;String&gt; dateNames = new TreeSet&lt;&gt;();</span>
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">                for (Element date : dates) {</span>
<span class="nc" id="L246">                    String dateName = date.getAttribute(&quot;name&quot;);</span>
<span class="nc bnc" id="L247" title="All 4 branches missed.">                    if ((dateName == null) || dateName.isEmpty()) {</span>
<span class="nc" id="L248">                        errors.add(&quot;Invalid html: there is an &amp;lt;input type='date'&amp;gt; without a name&quot;);</span>
<span class="nc" id="L249">                        return errors;</span>
                    }
<span class="nc bnc" id="L251" title="All 2 branches missed.">                    if (dateNames.contains(dateName)) {</span>
<span class="nc" id="L252">                        errors.add(&quot;Invalid html: there is more than one instance of &amp;lt;input type='date' name='&quot; + dateName + &quot;'&amp;gt;&quot;);</span>
<span class="nc" id="L253">                        return errors;</span>
                    }
<span class="nc" id="L255">                    dateNames.add(dateName);</span>
<span class="nc" id="L256">                }</span>

<span class="fc" id="L258">                Set&lt;String&gt; textAreaNames = new TreeSet&lt;&gt;();</span>
<span class="fc" id="L259">                NodeList textAreaList = root.getElementsByTagName(&quot;textarea&quot;);</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">                for (int i = 0; i &lt; textAreaList.getLength(); ++i) {</span>
<span class="fc" id="L261">                    Element textArea = (Element) textAreaList.item(i);</span>
<span class="fc" id="L262">                    String textAreaName = textArea.getAttribute(&quot;name&quot;);</span>
<span class="pc bpc" id="L263" title="2 of 4 branches missed.">                    if ((textAreaName != null) &amp;&amp; textAreaName.isEmpty()) {</span>
<span class="nc" id="L264">                        errors.add(&quot;Invalid html: there is a &amp;lt;textarea&amp;gt; without a name&quot;);</span>
<span class="nc" id="L265">                        return errors;</span>
                    }
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">                    if (textAreaNames.contains(textAreaName)) {</span>
<span class="nc" id="L268">                        errors.add(&quot;Invalid html: there is more than one instance of &amp;lt;textarea name='&quot; + textAreaName + &quot;'&amp;gt;&quot;);</span>
<span class="nc" id="L269">                        return errors;</span>
                    }
<span class="fc" id="L271">                    textAreaNames.add(textAreaName);</span>
                }
            }
<span class="fc" id="L274">            return errors;</span>
<span class="nc" id="L275">        } catch (SAXParseException parseException) {</span>
<span class="nc" id="L276">            long lineNumber = parseException.getLineNumber();</span>
<span class="nc" id="L277">            errors.add(&quot;Invalid html at line &lt;input type='button' value='&quot; + lineNumber + &quot;' onclick='selectLine(&quot; + lineNumber + &quot;,\&quot;&quot;</span>
<span class="nc" id="L278">                    + fieldName + &quot;\&quot;)'/&gt;&quot; + lineNumber + &quot;: &quot; + parseException.getMessage());</span>
<span class="nc" id="L279">            return errors;</span>
<span class="nc" id="L280">        } catch (SAXException parseException) {</span>
<span class="nc" id="L281">            errors.add(&quot;Invalid html: general parse problem: &quot; + parseException.getMessage());</span>
<span class="nc" id="L282">            return errors;</span>
<span class="nc" id="L283">        } catch (Exception e) {</span>
<span class="nc" id="L284">            errors.add(&quot;Invalid html: unexpected validation problem: &quot; + e.getMessage());</span>
<span class="nc" id="L285">            return errors;</span>
        }
    }

    private String getElementTextContent(Element el) {
<span class="pc bpc" id="L290" title="1 of 4 branches missed.">        if ((el == null) || !el.hasChildNodes()) {</span>
<span class="fc" id="L291">            return null;</span>
        }

<span class="fc" id="L294">        String textVal = el.getFirstChild().getNodeValue();</span>
<span class="fc" id="L295">        return StringUtils.trimToEmpty(textVal);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>