<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlanTemplateManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.phplan</a> &gt; <span class="el_source">PlanTemplateManager.java</span></div><h1>PlanTemplateManager.java</h1><pre class="source lang-java linenums">//---------------------------------------------------------------------------
//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: PlanTemplateManager.java Jul 6, 2011 12:09:44 AM pravinam$
//
//---------------------------------------------------------------------------

package com.pkb.service.phplan;

import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.datamodel.ImmutablePrivacyFlags;
import com.pkb.datamodel.PrivacyFlags;
import com.pkb.datamodel.plantemplate.AutoSavePHPlanTemplate;
import com.pkb.datamodel.plantemplate.NewPHPlanTemplate;
import com.pkb.datamodel.plantemplate.PHPlanTemplate;
import com.pkb.datamodel.plantemplate.TemplateAttachment;
import com.pkb.datamodel.plantemplate.TemplateField;
import com.pkb.datamodel.team.TeamWithConsents;
import com.pkb.domain.PHPlanTemplateService;
import com.pkb.domain.duplicate.TeamDomainService;
import com.pkb.entities.enums.TemplateStatus;
import com.pkb.exception.PKBException;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.util.tolven.TolvenBeanFactory;
import com.pkb.util.tolven.TransactionManager;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Optional;

/**
 * Class implementing interface {@link PlanTemplateManager}
 *
 * @author pravinam
 */
public class PlanTemplateManager extends TransactionManager {

    private final PHPlanTemplateService phPlanTemplateService;
    private final TeamDomainService teamService;
    private final LegacyPlanTemplateManager templateManager;

    public PlanTemplateManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService,
                               UUIDProvider uuidProvider, PHPlanTemplateService phPlanTemplateService,
                               TeamDomainService teamService, LegacyPlanTemplateManager templateManager) {
<span class="fc" id="L48">        super(config, beanFactory, dateTimeService, uuidProvider);</span>
<span class="fc" id="L49">        this.phPlanTemplateService = phPlanTemplateService;</span>
<span class="fc" id="L50">        this.teamService = teamService;</span>
<span class="fc" id="L51">        this.templateManager = templateManager;</span>
<span class="fc" id="L52">    }</span>

    /**
     * Delete template ; Mark it inactive
     *
     * @param templateId template id
     */
    public void deleteTemplate(long templateId) {
        try {
<span class="fc" id="L61">            phPlanTemplateService.deleteTemplate(templateId);</span>
<span class="nc" id="L62">        } catch (Exception e) {</span>
<span class="nc" id="L63">            throw new PKBException(</span>
                    &quot;Error while deleting template-&quot; + templateId, e);
<span class="fc" id="L65">        }</span>
<span class="fc" id="L66">    }</span>

    /**
     * Fetch {@link PHPlanTemplate} from the Id
     *
     * @param templateId
     * @return {@link PHPlanTemplate} object
     */
    public PHPlanTemplate getPHPlanTemplate(Long templateId) {
        try {
<span class="fc" id="L76">            return phPlanTemplateService.getPHPlanTemplate(templateId)</span>
<span class="pc" id="L77">                    .orElseThrow(() -&gt; new RuntimeException(String.format(&quot;No template found for templateId: %d&quot;, templateId)));</span>
<span class="nc" id="L78">        } catch (Exception e) {</span>
<span class="nc" id="L79">            throw new PKBException(</span>
                    &quot;Error while getting template-&quot; + templateId, e);
        }
    }

    public Optional&lt;PHPlanTemplate&gt; getPlainTemplate(long templateId) {
<span class="fc" id="L85">        return phPlanTemplateService.getPHPlanTemplate(templateId);</span>
    }

    /**
     * Fetch {@link PHPlanTemplate} from the Id
     *
     * @param templateId
     * @return {@link PHPlanTemplate} object
     */
    public Optional&lt;com.pkb.phplan.entity.PHPlanTemplate&gt; getPHPlanTemplateOldStyleWithMetrics(Long templateId) {
<span class="fc" id="L95">        return templateManager.getPHPlanTemplateWithMetrics(templateId);</span>
    }

    /**
     * Fetch {@link PHPlanTemplate} from the Id
     *
     * @param templateId
     * @return {@link PHPlanTemplate} object
     */
    public Optional&lt;com.pkb.phplan.entity.PHPlanTemplate&gt; getPHPlanTemplateOldStyleWithFieldsAndMetrics(Long templateId) {
<span class="fc" id="L105">        return templateManager.getPHPlanTemplateWithFieldsAndMetrics(templateId);</span>
    }


    /**
     * Get the list of templates for an institute
     *
     * @param instituteId
     * @return List of {@link PlainPHPlanTemplate} object
     */
    public List&lt;PHPlanTemplate&gt; getTemplateList(Long instituteId) {
        try {
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">            if (instituteId != null) {</span>
<span class="fc" id="L118">                return phPlanTemplateService.getTemplateList(instituteId);</span>
            } else {
<span class="nc" id="L120">                return new ArrayList&lt;&gt;();</span>
            }
<span class="nc" id="L122">        } catch (Exception e) {</span>
<span class="nc" id="L123">            throw new PKBException(</span>
                    &quot;Error while getting templates for institute-&quot; + instituteId, e);
        }
    }

    /**
     * Save the autosave template
     *
     * @param planTemplate {@link AutoSavePHPlanTemplate}
     * @return template id
     */
    public Long autoSaveTemplate(AutoSavePHPlanTemplate autoSavePHPlanTemplate, long creatorId) {
        try {

<span class="fc" id="L137">            TeamWithConsents team = teamService.findTeamWithConsentsByCode(autoSavePHPlanTemplate.getInstituteCode().getCode())</span>
<span class="pc" id="L138">                    .orElseThrow(() -&gt; new RuntimeException(String.format(&quot;No team was found for teamCode: %s. PlanTemplate can not be saved without a TeamId&quot;, autoSavePHPlanTemplate.getInstituteCode().getCode())));</span>

<span class="fc" id="L140">            PrivacyFlags privacyFlags = ImmutablePrivacyFlags.builder()</span>
<span class="fc" id="L141">                    .generalRequired(team.isRequireGeneral())</span>
<span class="fc" id="L142">                    .sexualHealthRequired(team.isRequireSexualHealth())</span>
<span class="fc" id="L143">                    .mentalHealthRequired(team.isRequireMentalHealth())</span>
<span class="fc" id="L144">                    .socialCareRequired(team.isRequireSocialCare())</span>
<span class="fc" id="L145">                    .build();</span>

<span class="fc" id="L147">            return phPlanTemplateService.save(autoSavePHPlanTemplate, creatorId, team.getId(), privacyFlags, dateTimeService.now());</span>
<span class="nc" id="L148">        } catch (Exception e) {</span>
<span class="nc" id="L149">            throw new PKBException(</span>
                    &quot;Error while saving template&quot;, e);
        }
    }

    /**
     * Save the template
     *
     * @param planTemplate {@link PHPlanTemplate}
     * @return template id
     */
    public Long saveTemplate(NewPHPlanTemplate planTemplate) {
        try {
<span class="fc" id="L162">            return phPlanTemplateService.save(planTemplate);</span>
<span class="nc" id="L163">        } catch (Exception e) {</span>
<span class="nc" id="L164">            throw new PKBException(</span>
                    &quot;Error while saving template&quot;, e);
        }
    }

    /**
     * Mark the template complete
     *
     * @param planTemplate
     * @return
     */
    public Long completeTemplate(NewPHPlanTemplate planTemplate) {
        try {
<span class="fc" id="L177">            return phPlanTemplateService.completeTemplate(planTemplate);</span>
<span class="nc" id="L178">        } catch (Exception e) {</span>
<span class="nc" id="L179">            throw new PKBException(</span>
                    &quot;Error while marking the template complete&quot;, e);
        }
    }

    /**
     * Get the list of attachments for a template
     *
     * @param templateId
     * @return List of {@link TemplateAttachment} objects
     */
    public List&lt;TemplateAttachment&gt; getTemplateAttachments(Long templateId) {
        try {
<span class="fc bfc" id="L192" title="All 2 branches covered.">            if (templateId != null) {</span>
<span class="fc" id="L193">                return phPlanTemplateService.getTemplateAttachments(templateId);</span>
            } else {
<span class="fc" id="L195">                return Collections.emptyList();</span>
            }
<span class="nc" id="L197">        } catch (Exception e) {</span>
<span class="nc" id="L198">            throw new PKBException(</span>
                    &quot;Error while getting the template attachments&quot;, e);
        }
    }

    /**
     * Get the list of fields for a template
     *
     * @param templateId
     * @return List of {@link TemplateField} objects
     */
    public List&lt;TemplateField&gt; getTemplateFieldList(Long templateId) {
        try {
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">            if (templateId != null) {</span>
<span class="fc" id="L212">                return phPlanTemplateService.getTemplateFields(templateId);</span>
            } else {
<span class="nc" id="L214">                return Collections.emptyList();</span>
            }
<span class="nc" id="L216">        } catch (Exception e) {</span>
<span class="nc" id="L217">            throw new PKBException(</span>
                    &quot;Error while getting the template fields&quot;, e);
        }
    }

    /**
     * Get the template list with specified status
     *
     * @param instituteId
     * @param templateStatus
     * @return List of {@link PHPlanTemplate} objects
     */
    public List&lt;PHPlanTemplate&gt; getTemplateListByStatus(Long instituteId, TemplateStatus templateStatus) {
        try {
<span class="pc bpc" id="L231" title="1 of 2 branches missed.">            if (instituteId != null) {</span>
<span class="fc" id="L232">                return phPlanTemplateService.findAllByInstituteIdAndStatus(instituteId, templateStatus);</span>
            } else {
<span class="nc" id="L234">                return Collections.emptyList();</span>
            }
<span class="nc" id="L236">        } catch (Exception e) {</span>
<span class="nc" id="L237">            throw new PKBException(</span>
                    &quot;Error while getting templates for institute by status-&quot; + instituteId, e);
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>