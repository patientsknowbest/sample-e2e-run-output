<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CustomStyledHtmlFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.util.security</a> &gt; <span class="el_source">CustomStyledHtmlFilter.java</span></div><h1>CustomStyledHtmlFilter.java</h1><pre class="source lang-java linenums">package com.pkb.util.security;

import io.vavr.Tuple2;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Entities.EscapeMode;
import org.jsoup.safety.Cleaner;
import org.jsoup.safety.Safelist;
import org.owasp.validator.html.AntiSamy;
import org.owasp.validator.html.CleanResults;
import org.owasp.validator.html.Policy;
import org.owasp.validator.html.PolicyException;
import org.owasp.validator.html.ScanException;

import java.io.IOException;
import java.net.URL;
import java.util.Collections;
import java.util.List;
import java.util.regex.Pattern;

/**
 * A filter for custom html where styling is allowed. Either inline styles or inline css.
 */
public class CustomStyledHtmlFilter extends AbstractJsoupFilter {

<span class="fc" id="L26">    private static final Safelist EXTENDED = Safelist.relaxed()</span>
<span class="fc" id="L27">            .addTags(&quot;iframe&quot;, &quot;input&quot;, &quot;label&quot;, &quot;font&quot;, &quot;hr&quot;, &quot;s&quot;, &quot;ins&quot;, &quot;del&quot;, &quot;strike&quot;, &quot;tt&quot;, &quot;big&quot;, &quot;select&quot;, &quot;option&quot;, &quot;optgroup&quot;, &quot;style&quot;, &quot;textarea&quot;)</span>
<span class="fc" id="L28">            .addAttributes(&quot;:all&quot;, &quot;class&quot;, &quot;id&quot;, &quot;style&quot;, &quot;size&quot;, &quot;color&quot;, &quot;face&quot;, &quot;border&quot;, &quot;rows&quot;)</span>
<span class="fc" id="L29">            .addAttributes(&quot;a&quot;, &quot;alt&quot;, &quot;href&quot;, &quot;target&quot;, &quot;title&quot;)</span>
<span class="fc" id="L30">            .addAttributes(&quot;iframe&quot;, &quot;allowfullscreen&quot;, &quot;frameborder&quot;, &quot;height&quot;, &quot;mozallowfullscreen&quot;, &quot;src&quot;, &quot;webkitallowfullscreen&quot;, &quot;width&quot;)</span>
<span class="fc" id="L31">            .addAttributes(&quot;input&quot;, &quot;checked&quot;, &quot;id&quot;, &quot;name&quot;, &quot;onclick&quot;, &quot;placeholder&quot;, &quot;src&quot;, &quot;type&quot;, &quot;value&quot;)</span>
<span class="fc" id="L32">            .addAttributes(&quot;label&quot;, &quot;for&quot;)</span>
<span class="fc" id="L33">            .addAttributes(&quot;option&quot;, &quot;selected&quot;, &quot;value&quot;)</span>
<span class="fc" id="L34">            .addAttributes(&quot;optgroup&quot;, &quot;label&quot;)</span>
<span class="fc" id="L35">            .addAttributes(&quot;select&quot;, &quot;name&quot;)</span>
<span class="fc" id="L36">            .addAttributes(&quot;style&quot;, &quot;media&quot;)</span>
<span class="fc" id="L37">            .addAttributes(&quot;td&quot;, &quot;bgcolor&quot;)</span>
<span class="fc" id="L38">            .addAttributes(&quot;textarea&quot;, &quot;name&quot;, &quot;placeholder&quot;)</span>
<span class="fc" id="L39">            .addEnforcedAttribute(&quot;a&quot;, &quot;rel&quot;, &quot;nofollow&quot;)</span>
<span class="fc" id="L40">            .removeTags(&quot;code&quot;, &quot;cite&quot;, &quot;noscript&quot;)</span>
<span class="fc" id="L41">            .addProtocols(&quot;a&quot;, &quot;href&quot;, &quot;http&quot;, &quot;https&quot;, &quot;mailto&quot;)</span>
            // Enabling this can cause vulnerability issues. See https://www.zaproxy.org/docs/alerts/10051/
<span class="fc" id="L43">            .preserveRelativeLinks(false);</span>

<span class="fc" id="L45">    private static final Document.OutputSettings OUTPUT_SETTINGS = new Document.OutputSettings()</span>
<span class="fc" id="L46">            .syntax(Document.OutputSettings.Syntax.xml)</span>
<span class="fc" id="L47">            .escapeMode(EscapeMode.xhtml)</span>
<span class="fc" id="L48">            .prettyPrint(false);</span>

    private static final String MOZ_WEBKIT_KHTML_BORDER_RADIUS = &quot;(?:-moz|-webkit|-khtml)-border-radius&quot;;
    private static final String LENGTH = &quot;(?:(?:[-+])?0|(?:[-+])?(?:(?:[0-9]+(?:\\.[0-9]+)?)(?:em|ex|px|in|cm|mm|pt|pc|rem))\\s*){1,4}&quot;;
    private static final String PERCENTAGE = &quot;(?:[-+])?(?:[0-9]+(?:\\.[0-9]+)?)%&quot;;
<span class="fc" id="L53">    private static final Pattern MOZ_WEBKIT_KHTML_ATTRIBUTE = Pattern.compile(MOZ_WEBKIT_KHTML_BORDER_RADIUS + &quot;:\\s*(?:&quot; + LENGTH + &quot;|&quot; + PERCENTAGE + &quot;);&quot;);</span>
<span class="fc" id="L54">    private static final Tuple2&lt;String, List&lt;String&gt;&gt; EMPTY_RESULT = new Tuple2&lt;&gt;(&quot;&quot;, Collections.emptyList());</span>
    private static Policy customStylePolicy;

    static {
<span class="fc" id="L58">        URL policyUrl = Thread.currentThread().getContextClassLoader().getResource(&quot;style-filter-policy.xml&quot;);</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        if (policyUrl == null) {</span>
<span class="nc" id="L60">            throw new RuntimeException(&quot;Failed to load CustomStyledHtmlFilter policy file&quot;);</span>
        }
        try {
<span class="fc" id="L63">            customStylePolicy = Policy.getInstance(policyUrl.openStream());</span>
<span class="nc" id="L64">        } catch (PolicyException | IOException e) {</span>
<span class="nc" id="L65">            throw new RuntimeException(&quot;Error while reading policy file&quot;, e);</span>
<span class="fc" id="L66">        }</span>
<span class="fc" id="L67">    }</span>

    private final AntiSamy antiSamy;

    public CustomStyledHtmlFilter(String baseUrl) {
<span class="fc" id="L72">        super(baseUrl);</span>
<span class="fc" id="L73">        antiSamy = new AntiSamy(customStylePolicy);</span>
<span class="fc" id="L74">    }</span>

    @Override
    public String filter(String input) {
<span class="fc" id="L78">        return doFilter(input)._1;</span>
    }

    public Tuple2&lt;String, List&lt;String&gt;&gt; doFilter(String input) {
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (input == null) {</span>
<span class="nc" id="L83">            return EMPTY_RESULT;</span>
        }
<span class="fc" id="L85">        input = removeMozWebkitKhtmlBorderRadiusAttributes(input);</span>
<span class="fc" id="L86">        Tuple2&lt;String, List&lt;String&gt;&gt; cleanAndErrors = scanWithAntiSamy(input);</span>
<span class="fc" id="L87">        input = cleanWithJsoup(cleanAndErrors._1);</span>
<span class="fc" id="L88">        return new Tuple2&lt;&gt;(input, cleanAndErrors._2());</span>
    }

    private String removeMozWebkitKhtmlBorderRadiusAttributes(String input) {
<span class="fc" id="L92">        Document document = Jsoup.parseBodyFragment(input);</span>
<span class="fc" id="L93">        String style = &quot;style&quot;;</span>
<span class="fc" id="L94">        document.getElementsByAttributeValueMatching(style, MOZ_WEBKIT_KHTML_BORDER_RADIUS)</span>
<span class="fc" id="L95">                .forEach(element -&gt; element.attributes().forEach(attribute -&gt; {</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">                    if (attribute.getKey().equals(style)) {</span>
                        // Matches any of -moz-border-radius: 10px; -webkit-border-radius: 10%; -khtml-border-radius: 10px 20px; etc.
                        // AntySamy chops any attributes after these so we remove them
<span class="fc" id="L99">                        attribute.setValue(MOZ_WEBKIT_KHTML_ATTRIBUTE.matcher(attribute.getValue()).replaceAll(&quot;&quot;));</span>
                    }
<span class="fc" id="L101">                }));</span>
<span class="fc" id="L102">        document.outputSettings(OUTPUT_SETTINGS);</span>
<span class="fc" id="L103">        return document.body().html();</span>
    }

    private Tuple2&lt;String, List&lt;String&gt;&gt; scanWithAntiSamy(String dirty) {
        try {
            // TODO: Switch to default AntiSamy.SAX scanType PHR-8357
<span class="fc" id="L109">            CleanResults results = antiSamy.scan(dirty, AntiSamy.DOM);</span>
<span class="fc" id="L110">            return new Tuple2&lt;&gt;(results.getCleanHTML(), results.getErrorMessages());</span>
<span class="nc" id="L111">        } catch (ScanException e) {</span>
<span class="nc" id="L112">            throw new RuntimeException(&quot;Error while scanning HTML&quot;, e);</span>
<span class="nc" id="L113">        } catch (PolicyException e) {</span>
<span class="nc" id="L114">            throw new RuntimeException(&quot;Error while reading policy file&quot;, e);</span>
        }
    }

    private String cleanWithJsoup(String input) {
<span class="fc" id="L119">        Document dirty = Jsoup.parseBodyFragment(input, baseUrl);</span>
<span class="fc" id="L120">        Cleaner cleaner = new Cleaner(EXTENDED);</span>
<span class="fc" id="L121">        Document clean = cleaner.clean(dirty);</span>
<span class="fc" id="L122">        makePageAnchorsRelative(clean);</span>
<span class="fc" id="L123">        addNoopenerNoreferrerToThirdPartyLinksWithTargetBlankAttribute(clean);</span>
<span class="fc" id="L124">        addAttributeValueToBooleanAttributes(clean);</span>
<span class="fc" id="L125">        return clean.outputSettings(OUTPUT_SETTINGS).body().html();</span>
    }

    private void makePageAnchorsRelative(Document doc) {
        // Jsoup turns https://my.patientsknowbest.com/viewPlan.action?planId=378#top into https://my.patientsknowbest.com#top
<span class="fc" id="L130">        String baseUri = doc.baseUri();</span>
<span class="fc" id="L131">        String cleanedPageAnchorPattern = baseUri + &quot;#&quot;;</span>
<span class="fc" id="L132">        doc.select(&quot;a[href]&quot;).forEach(link -&gt; {</span>
<span class="fc" id="L133">            String href = link.attr(&quot;href&quot;);</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">            if  (href.startsWith(cleanedPageAnchorPattern)) {</span>
<span class="fc" id="L135">                String pageAnchor = href.replaceFirst(baseUri, &quot;&quot;);</span>
<span class="fc" id="L136">                link.attr(&quot;href&quot;, pageAnchor);</span>
            }
<span class="fc" id="L138">        });</span>
<span class="fc" id="L139">    }</span>

    /**
     * Not doing this can cause vulnerability issues because the linking page can be manipulated via the
     * {@code window.opener} object in Javascript.
     *
     * @see &lt;a href=&quot;https://medium.com/sedeo/how-to-fix-target-blank-a-security-and-performance-issue-in-web-pages-2118eba1ce2f&quot;&gt;
     *     How to fix target blank security and perofrmance issues in web pages&lt;/a&gt;
     */
    private void addNoopenerNoreferrerToThirdPartyLinksWithTargetBlankAttribute(Document doc) {
<span class="fc" id="L149">        doc.getElementsByAttributeValue(&quot;target&quot;, &quot;_blank&quot;).forEach(element -&gt; {</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">            if (!element.attr(&quot;href&quot;).contains(baseUrl)) {</span>
<span class="fc" id="L151">                String relKey = &quot;rel&quot;;</span>
<span class="fc" id="L152">                String currentRelValue = element.attr(relKey);</span>
<span class="fc" id="L153">                element.attr(relKey, currentRelValue + &quot; noopener noreferrer&quot;);</span>
            }
<span class="fc" id="L155">        });</span>
<span class="fc" id="L156">    }</span>

    /**
     * Jsoup turns &lt;input checked=&quot;checked&quot; ...&gt; into &lt;input checked ...&gt; and option selected=&quot;selected&quot;&gt; into
     * &lt;option selected&gt; which are not XHTML compliant so we need to populate them with values.
     *
     * @param doc the document to scan for boolean attributes
     */
    private void addAttributeValueToBooleanAttributes(Document doc) {
<span class="fc" id="L165">        String checked = &quot;checked&quot;;</span>
<span class="fc" id="L166">        String selected = &quot;selected&quot;;</span>
<span class="fc" id="L167">        doc.getElementsByAttribute(checked).attr(checked, checked);</span>
<span class="fc" id="L168">        doc.getElementsByAttribute(selected).attr(selected, selected);</span>
<span class="fc" id="L169">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>