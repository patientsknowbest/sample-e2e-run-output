<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractJsoupFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.util.security</a> &gt; <span class="el_source">AbstractJsoupFilter.java</span></div><h1>AbstractJsoupFilter.java</h1><pre class="source lang-java linenums">package com.pkb.util.security;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.nodes.Node;
import org.jsoup.nodes.TextNode;
import org.jsoup.safety.Cleaner;
import org.jsoup.safety.Safelist;

import java.util.List;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import static com.pkb.util.security.AbstractJsoupFilter.ConvertUrlToLink.CONVERT;
import static com.pkb.util.security.AbstractJsoupFilter.ConvertUrlToLink.NOT_CONVERT;

public abstract class AbstractJsoupFilter {

<span class="fc" id="L20">    enum ConvertUrlToLink {</span>
<span class="fc" id="L21">        CONVERT, NOT_CONVERT</span>
    }

<span class="fc" id="L24">    private static final Pattern URL = Pattern.compile(&quot;((https?|ftp)://[^\\s]+)&quot;, Pattern.CASE_INSENSITIVE);</span>

    protected final String baseUrl;

<span class="fc" id="L28">    public AbstractJsoupFilter(String baseUrl) {</span>
<span class="fc" id="L29">        this.baseUrl = baseUrl;</span>
<span class="fc" id="L30">    }</span>

    /**
     * Strips out not allowed tags and attributes. XSS filter for html content.
     * Does not escape output!
     * 
     * @param input
     * @return Filtered HTML
     */
    public abstract String filter(String input);

    /**
     * Remove every HTML tag.
     * Does not escape output!
     * 
     * @param input
     * @return
     */
    public String strip(String input) {
<span class="nc" id="L49">        return filter(input, Safelist.none());</span>
    }

    protected String filter(String input, Safelist safelist) {
<span class="fc" id="L53">        return filter(input, safelist, NOT_CONVERT);</span>
    }

    protected String filter(String input, Safelist safelist, ConvertUrlToLink conversion) {
<span class="pc bpc" id="L57" title="1 of 2 branches missed.">        if (input == null) {</span>
<span class="nc" id="L58">            return &quot;&quot;;</span>
        }
<span class="fc" id="L60">        Document clean = getCleanedUpDoc(input, safelist);</span>
<span class="fc" id="L61">        Element body = clean.body();</span>
<span class="fc bfc" id="L62" title="All 2 branches covered.">        if (conversion == CONVERT) {</span>
<span class="fc" id="L63">            body.html(convertUrlToLinks(body.childNodes()));</span>
        }
<span class="fc" id="L65">        return body.html();</span>
    }

    private Document getCleanedUpDoc(String input, Safelist safelist) {
<span class="fc" id="L69">        Document dirty = Jsoup.parseBodyFragment(input, baseUrl);</span>
<span class="fc" id="L70">        Cleaner cleaner = new Cleaner(safelist);</span>
<span class="fc" id="L71">        Document clean = cleaner.clean(dirty);</span>
<span class="fc" id="L72">        clean.outputSettings(new Document.OutputSettings().prettyPrint(false));</span>
<span class="fc" id="L73">        return clean;</span>
    }

    private String convertUrlToLinks(List&lt;Node&gt; childNodes) {
<span class="fc" id="L77">        StringBuilder html = new StringBuilder();</span>
<span class="fc" id="L78">        childNodes.forEach(node -&gt; {</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">            if (node instanceof TextNode) {</span>
<span class="fc" id="L80">                String text = ((TextNode) node).text();</span>
<span class="fc" id="L81">                Matcher matcher = URL.matcher(text);</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">                while (matcher.find()) {</span>
<span class="fc" id="L83">                    text = matcher.replaceAll(&quot;&lt;a href='$0' target='_blank' rel='noopener noreferrer nofollow'&gt;$0&lt;/a&gt;&quot;);</span>
                }
<span class="fc" id="L85">                html.append(text);</span>
<span class="fc" id="L86">            } else {</span>
<span class="fc" id="L87">                Element element = (Element) node;</span>
<span class="fc" id="L88">                String outerHtml = element.outerHtml();</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">                if (element.tagName().equals(&quot;a&quot;)) {</span>
<span class="fc" id="L90">                    html.append(outerHtml);</span>
                } else {
<span class="fc" id="L92">                    html.append(outerHtml.replace(element.html(), convertUrlToLinks(element.childNodes())));</span>
                }
            }
<span class="fc" id="L95">        });</span>
<span class="fc" id="L96">        return html.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>