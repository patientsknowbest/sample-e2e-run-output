<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.bean.impl</a> &gt; <span class="el_source">UserBean.java</span></div><h1>UserBean.java</h1><pre class="source lang-java linenums">package com.pkb.bean.impl;

import com.pkb.VersionDetails;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.bean.IUserBean;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.consent.entity.PatientConsent;
import com.pkb.consent.entity.PatientConsentReason;
import com.pkb.crypto.util.RandomUtil;
import com.pkb.datamodel.Email;
import com.pkb.encounter.entity.PKBInvitation;
import com.pkb.encounter.entity.PKBInvitationDetail;
import com.pkb.entities.enums.AccessingEntityType;
import com.pkb.entities.enums.ConsentReason;
import com.pkb.entities.enums.InvitationType;
import com.pkb.entities.enums.PhotoIdType;
import com.pkb.entities.enums.PrivacyFlag;
import com.pkb.entities.enums.SponsorshipStatus;
import com.pkb.entities.enums.UserStatus;
import com.pkb.entities.enums.UserType;
import com.pkb.entities.enums.VerificationStatus;
import com.pkb.institute.entity.InstituteUser;
import com.pkb.institute.entity.Team;
import com.pkb.mappers.SourceDetailsMapper;
import com.pkb.model.PKBPersonDTO;
import com.pkb.service.document.DocumentManager;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.invitation.impl.InvitationManager;
import com.pkb.service.patientconsent.DeprecatedPatientConsentManager;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.PersonContactManager;
import com.pkb.service.user.impl.UserAccessManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.user.entity.IdentityVerification;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PKBPersonProperty;
import com.pkb.user.entity.PasswordAccess;
import com.pkb.user.entity.PersonContact;
import com.pkb.util.PKBConstants;
import com.pkb.util.tolven.ConvertUtil;
import com.pkb.util.tolven.TolvenBeanFactory;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;

import java.util.Date;
import java.util.EnumSet;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

import static com.pkb.entities.enums.PropertyName.CONSENT_REVIEW_COMPLETED;

public class UserBean implements IUserBean {
    protected TeamUserManager teamUserManager;
    @SuppressWarnings(&quot;deprecation&quot;)
    protected DeprecatedPatientConsentManager deprecatedPatientConsentManager;
    protected UserManager userManager;
    protected InvitationManager invitationManager;
    protected TolvenBeanFactory tolvenBeanFactory;
    protected UserAccessManager userAccessManager;
    protected PersonContactManager personContactManager;
    protected PKBEmailMessageManager pkbEmailMessageManager;
    protected DateTimeService dateTimeService;
    protected ConvertUtil convertUtil;
    protected UUIDProvider uuidProvider;
    protected PatientConsentManager patientConsentManager;
    protected final SourceDetailsMapper sourceDetailsMapper;
    protected final DocumentManager documentManager;

    protected final PhrConfig config;

    public UserBean(
            TeamUserManager teamUserManager,
            @SuppressWarnings(&quot;deprecation&quot;)
                    DeprecatedPatientConsentManager deprecatedPatientConsentManager,
            UserManager userManager,
            InvitationManager invitationManager,
            TolvenBeanFactory tolvenBeanFactory,
            UserAccessManager userAccessManager,
            PersonContactManager personContactManager,
            PKBEmailMessageManager pkbEmailMessageManager,
            DateTimeService dateTimeService,
            ConvertUtil convertUtil,
            UUIDProvider uuidProvider, PatientConsentManager patientConsentManager,
            SourceDetailsMapper sourceDetailsMapper,
<span class="fc" id="L91">            DocumentManager documentManager, PhrConfig config) {</span>
<span class="fc" id="L92">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L93">        this.deprecatedPatientConsentManager = deprecatedPatientConsentManager;</span>
<span class="fc" id="L94">        this.userManager = userManager;</span>
<span class="fc" id="L95">        this.invitationManager = invitationManager;</span>
<span class="fc" id="L96">        this.tolvenBeanFactory = tolvenBeanFactory;</span>
<span class="fc" id="L97">        this.userAccessManager = userAccessManager;</span>
<span class="fc" id="L98">        this.personContactManager = personContactManager;</span>
<span class="fc" id="L99">        this.pkbEmailMessageManager = pkbEmailMessageManager;</span>
<span class="fc" id="L100">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L101">        this.convertUtil = convertUtil;</span>
<span class="fc" id="L102">        this.uuidProvider = uuidProvider;</span>
<span class="fc" id="L103">        this.patientConsentManager = patientConsentManager;</span>
<span class="fc" id="L104">        this.sourceDetailsMapper = sourceDetailsMapper;</span>
<span class="fc" id="L105">        this.documentManager = documentManager;</span>
<span class="fc" id="L106">        this.config = config;</span>
<span class="fc" id="L107">    }</span>

    @Override
    public PKBInvitation populateInvitation(String message, Long accountId, long authorId, @NotNull UserType authorUserType, EnumSet&lt;PrivacyFlag&gt; requestedConsents, @NotNull EHRRequestContext requestContext) {
<span class="fc" id="L111">        PKBInvitationDetail invitationDetail = new PKBInvitationDetail(new SourceDetails(requestContext));</span>
<span class="fc" id="L112">        PKBInvitation invitation = new PKBInvitation();</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">        if (authorUserType == UserType.REG_CLINICIAN) {</span>
<span class="fc" id="L114">            invitation.setInvitationType(InvitationType.PATIENT_INVITATION);</span>
        } else {
<span class="fc" id="L116">            invitation.setInvitationType(InvitationType.CLINICIAN_INVITATION);</span>
        }
<span class="fc" id="L118">        invitation.setAccountId(accountId); // may be null, if patient record hasn't been created yet</span>
<span class="fc" id="L119">        invitation.setCreated(dateTimeService.now());</span>

<span class="fc" id="L121">        invitation.setAuthorUserId(authorId);</span>
<span class="fc" id="L122">        invitationDetail.setContent(message);</span>
<span class="fc" id="L123">        invitation.setInvitationDetail(invitationDetail);</span>
<span class="fc" id="L124">        invitation.setGrantedConsents(requestedConsents);</span>
        // Needs to fill in icode and source
<span class="fc" id="L126">        return invitation;</span>
    }

    @Override
    public boolean updateOrCreateTeamConsentRecord(@NotNull EHRRequestContext requestContext, @Nullable Long patientId, Long teamId, PatientConsent modified) {
        // Reload the original consent for merging (creates a new in-memory object if none exists)
<span class="nc" id="L132">        Optional&lt;PatientConsent&gt; original = deprecatedPatientConsentManager.findPatientConsentWithoutReasons(patientId, teamId, AccessingEntityType.TEAM);</span>

<span class="nc" id="L134">        return updateOrCreateConsentRecord(requestContext, patientId, teamId, AccessingEntityType.TEAM, original, modified);</span>
    }

    @Override
    public boolean updateOrCreateConsentRecord(@NotNull EHRRequestContext requestContext, @Nullable Long patientId, Long accessingId,
                                               AccessingEntityType entityType, Optional&lt;PatientConsent&gt; original, PatientConsent modified) {
<span class="nc" id="L140">        return deprecatedPatientConsentManager.updateOrCreateConsentRecord(requestContext, patientId, accessingId, entityType, original, modified);</span>
    }

    @Override
    public void inviteCarerForPatient(@NotNull LoggedInEHRRequestContext requestContext,
                                      PKBPerson patient,
                                      PKBPerson author,
                                      @NotNull PKBPerson carerParam,
                                      EnumSet&lt;PrivacyFlag&gt; grantedConsents,
                                      String message) {

<span class="fc" id="L151">        userManager.transactional(() -&gt; {</span>
<span class="fc" id="L152">            PKBPerson carer = carerParam;</span>
<span class="fc" id="L153">            Long patientAccountId = userManager.getDefaultAccountId(patient.getId());</span>

<span class="fc bfc" id="L155" title="All 2 branches covered.">            boolean newCarer = carer.getId() == null;</span>
<span class="fc" id="L156">            UUID passwordDocId = null;</span>

<span class="fc bfc" id="L158" title="All 2 branches covered.">            if (newCarer) {</span>
                // Create carer
<span class="fc" id="L160">                carer.setUserType(UserType.PATIENT);</span>
<span class="fc" id="L161">                carer.setStatus(UserStatus.INVITED, dateTimeService.now());</span>

<span class="fc" id="L163">                PKBPersonDTO carerDTO = convertUtil.getPKBPersonFromPlugin(carer);</span>
<span class="fc" id="L164">                String password = RandomUtil.randomPassword(10);</span>
<span class="fc" id="L165">                carerDTO.setPassword(password);</span>

                // Revised 2016-08-23, always create a carer as a team patient, but with no team consents
<span class="fc" id="L168">                Team team = teamUserManager.getPrimaryTeam(requestContext, author.getId(), true/*activeOnly*/);</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">                if (team == null) {</span>
                    // user is not active in any team currently
<span class="fc" id="L171">                    List&lt;InstituteUser&gt; instituteUsers = teamUserManager.getInstituteUsersForPerson(requestContext, author.getId());</span>
<span class="pc bpc" id="L172" title="3 of 4 branches missed.">                    if (instituteUsers.size() == 1 &amp;&amp; instituteUsers.get(0).getSponsorshipStatus() != SponsorshipStatus.INACTIVE) {</span>
                        // user is self-registered or invited but not active yet so allowed to invite the carer
<span class="nc" id="L174">                        team = instituteUsers.get(0).getInstitute();</span>
                    }
                }

                // Do not take carer through consents on registration
                // (could have called userManager.setUserConsentReviewed() but that would be another database call)
<span class="fc" id="L180">                PKBPersonProperty alreadyConsented = new PKBPersonProperty();</span>
<span class="fc" id="L181">                alreadyConsented.setPropertyName(CONSENT_REVIEW_COMPLETED);</span>
<span class="fc" id="L182">                alreadyConsented.setPropertyValue(Boolean.TRUE.toString());</span>
<span class="fc" id="L183">                carerDTO.addProperty(alreadyConsented);</span>

<span class="fc bfc" id="L185" title="All 2 branches covered.">                userManager.registerUserFull(requestContext, carerDTO, team == null ? null : team.getId());</span>
<span class="fc" id="L186">                carer = userManager.getPKBPerson(carerDTO.getId(), PKBPerson.Lazy.CONTACTS);</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">                if (team != null) {</span>
                    //If there's a plausible team to attach to, create a dummy, discharged consent for this
                    //new carer so that they will show in org search and will be  accessible for e.g.
                    //password resets
<span class="fc" id="L191">                    var consent = new PatientConsent();</span>
<span class="fc" id="L192">                    consent.setDischarged(true);</span>
<span class="fc" id="L193">                    var reason = new PatientConsentReason(new SourceDetails(requestContext));</span>
<span class="fc" id="L194">                    reason.setAllReasons(ConsentReason.CREATED_ACCOUNT, &quot;Invited carer&quot;);</span>
<span class="fc" id="L195">                    consent.setReasons(reason);</span>
<span class="fc" id="L196">                    updateOrCreateTeamConsentRecord(requestContext, carer.getId(), team.getId(), consent);</span>
                }


<span class="fc bfc" id="L200" title="All 2 branches covered.">                if (!author.isPatient()) {</span>
                    // auto-identify the patient; the coord is vouching for them:
<span class="fc bfc" id="L202" title="All 2 branches covered.">                    PhotoIdType photoIdType = author.isPro() ? PhotoIdType.VOUCHED_FOR_BY_CLINICIAN</span>
<span class="fc" id="L203">                            : PhotoIdType.VOUCHED_FOR_BY_COORDINATOR;</span>
<span class="fc" id="L204">                    IdentityVerification verification = new IdentityVerification();</span>
<span class="fc" id="L205">                    verification.setPersonId(carer.getId());</span>
<span class="fc" id="L206">                    verification.setVerifierId(author.getId());</span>
<span class="fc" id="L207">                    verification.setVerificationDate(Date.from(dateTimeService.now()));</span>
<span class="fc" id="L208">                    verification.setStatus(VerificationStatus.VERIFIED);</span>
<span class="fc" id="L209">                    verification.setSignedConsentForm(false);</span>
<span class="fc" id="L210">                    verification.setPhotoIdType(photoIdType);</span>
<span class="fc" id="L211">                    verification.setPhotoIdNumber(&quot;Vouched for by &quot; + author.getTitle() + &quot; &quot;</span>
<span class="fc" id="L212">                            + author.getFirstName() + &quot; &quot; + author.getLastName()</span>
<span class="fc" id="L213">                            + &quot; of &quot; + team.getName());</span>
<span class="fc" id="L214">                    verification.setVerifyingTeam(team);</span>
<span class="fc" id="L215">                    teamUserManager.activateUserAccount(author.getId(), team.getId(), verification);</span>
                }

<span class="fc" id="L218">                carer.setPassword(password);</span>

                // save the temporary password in a document (for the author to retrieve for resending the invitation)
<span class="fc" id="L221">                Long authorAccountId = userManager.getDefaultAccountId(author.getId());</span>


<span class="fc" id="L224">                passwordDocId = documentManager.saveDocument(requestContext, author.getId(), authorAccountId, password);</span>

<span class="fc" id="L226">            } else {</span>

                //Note 2019-05-10 Lucian: This code doesn't work in many cases. It assumes that the current user has access
                // to the carer's account, but in the case of a patient inviting another (created, but not fully registered) patient
                // to be a carer, this assumption is incorrect. The only real fix for this is to move away from the broken model
                // of storing temporary passwords in miscellaneous random documents littered around the place, and instead have
                // one-off access tokens that are unique to each email that is sent out and do not need to be recovered
                // at some arbitrary point in the future. See PHR-4742.
<span class="fc" id="L234">                PasswordAccess passwordAccess = userAccessManager.getPasswordAccess(carer.getId(),</span>
                        requestContext);
<span class="fc bfc" id="L236" title="All 2 branches covered.">                if (passwordAccess != null) {</span>
<span class="fc" id="L237">                    carer.setPassword(passwordAccess.getPassword());</span>
                }
            }

            // Add contact record

<span class="fc" id="L243">            PersonContact personContact = new PersonContact();</span>
<span class="fc" id="L244">            personContact.setPublicId(UUID.randomUUID());</span>
<span class="fc" id="L245">            personContact.setToAlsoContact(carer);</span>
<span class="fc" id="L246">            personContact.setPerson(patient);</span>
<span class="fc" id="L247">        personContactManager.save(personContact, VersionDetails.of(requestContext, dateTimeService.now()));</span>
<span class="fc" id="L248">            invitationManager.inviteCarerForPatient(requestContext, patientAccountId, author, carer, message, grantedConsents, passwordDocId);</span>
<span class="fc" id="L249">        });</span>
<span class="fc" id="L250">    }</span>

    @Override
    public PKBPerson populateInvitee(@NotNull EHRRequestContext requestContext, String firstName, String lastName, Email email, String title, String languageCode) {
<span class="fc" id="L254">        VersionDetails versionDetails = VersionDetails.of(requestContext, dateTimeService.now());</span>

<span class="fc" id="L256">        PKBPerson person = new PKBPerson();</span>
<span class="fc" id="L257">        person.setTitle(title);</span>
<span class="fc" id="L258">        person.setFirstName(firstName);</span>
<span class="fc" id="L259">        person.setLastName(lastName);</span>
<span class="fc" id="L260">        person.setContacts(null);</span>
<span class="fc" id="L261">        person.setPrimaryEmail(email, versionDetails);</span>
<span class="fc" id="L262">        person.setStatus(UserStatus.INVITED, dateTimeService.now());</span>
<span class="fc" id="L263">        person.setPassword(UUID.randomUUID().toString().substring(5));</span>
<span class="fc" id="L264">        person.setLanguageCode(languageCode);</span>
<span class="fc" id="L265">        person.setTimeZoneId(PKBConstants.DEFAULT_TIMEZONE_ID);</span>
<span class="fc" id="L266">        person.setVersionDetails(versionDetails);</span>
<span class="fc" id="L267">        return person;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>