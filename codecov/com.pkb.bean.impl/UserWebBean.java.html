<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserWebBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.bean.impl</a> &gt; <span class="el_source">UserWebBean.java</span></div><h1>UserWebBean.java</h1><pre class="source lang-java linenums">package com.pkb.bean.impl;

import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.bean.IUserWebBean;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.consent.entity.PatientConsent;
import com.pkb.datamodel.Email;
import com.pkb.encounter.entity.PKBInvitation;
import com.pkb.encounter.entity.PKBInvitationDetail;
import com.pkb.entities.enums.AccessingEntityType;
import com.pkb.entities.enums.InvitationType;
import com.pkb.entities.enums.PrivacyFlag;
import com.pkb.entities.enums.UserStatus;
import com.pkb.entities.enums.UserType;
import com.pkb.exception.MailException;
import com.pkb.exception.PKBException;
import com.pkb.exception.PatientAlreadyInTeamException;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import com.pkb.mappers.SourceDetailsMapper;
import com.pkb.model.PKBPersonDTO;
import com.pkb.service.document.DocumentManager;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.invitation.impl.InvitationManager;
import com.pkb.service.patientconsent.DeprecatedPatientConsentManager;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.PersonContactManager;
import com.pkb.service.user.impl.UserAccessManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.user.entity.IdentityVerification;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PersonContact;
import com.pkb.util.LoggedInUserUtil;
import com.pkb.util.PKBWebUtil;
import com.pkb.util.tolven.ConvertUtil;
import com.pkb.util.tolven.TolvenBeanFactory;
import io.vavr.control.Option;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.EnumSet;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

@Component
public class UserWebBean extends UserBean implements IUserWebBean {
<span class="fc" id="L58">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private final TeamManager teamManager;
    private final LoggedInUserUtil loggedInUserUtil;
    private final PKBWebUtil pkbWebUtil;

    @Autowired
    public UserWebBean(UserManager userManager, PersonContactManager personContactManager,
                       InvitationManager invitationManager,
                       TeamUserManager teamUserManager, UserAccessManager userAccessManager,
                       TeamManager teamManager, PKBEmailMessageManager pkbEmailMessageManager, TolvenBeanFactory tolvenBeanFactory,
                       @SuppressWarnings(&quot;deprecation&quot;) DeprecatedPatientConsentManager deprecatedPatientConsentManager, LoggedInUserUtil loggedInUserUtil,
                       DateTimeService dateTimeService, ConvertUtil convertUtil, UUIDProvider uuidProvider, PKBWebUtil pkbWebUtil,
                       PatientConsentManager patientConsentManager, SourceDetailsMapper sourceDetailsMapper, DocumentManager documentManager, PhrConfig config) {
<span class="fc" id="L72">        super(teamUserManager, deprecatedPatientConsentManager, userManager, invitationManager, tolvenBeanFactory, userAccessManager,</span>
                personContactManager, pkbEmailMessageManager, dateTimeService, convertUtil, uuidProvider, patientConsentManager,
                sourceDetailsMapper, documentManager, config);
<span class="fc" id="L75">        this.teamManager = teamManager;</span>
<span class="fc" id="L76">        this.loggedInUserUtil = loggedInUserUtil;</span>
<span class="fc" id="L77">        this.pkbWebUtil = pkbWebUtil;</span>
<span class="fc" id="L78">    }</span>

    @Override
    public void inviteClinicianForPatient(@NotNull LoggedInEHRRequestContext requestContext, PKBPerson patient, PKBPerson author,
                                          @NotNull PKBPerson clinicianParam,
                                          String message, @NotNull EnumSet&lt;PrivacyFlag&gt; consentSettings) {
<span class="fc" id="L84">        invitationManager.transactional(() -&gt; {</span>
<span class="fc" id="L85">            PKBPerson clinician = clinicianParam;</span>
<span class="fc" id="L86">            Long clinicianAccountId = null;</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">            if (clinician.getId() != null) {</span>
<span class="fc" id="L88">                clinicianAccountId = userManager.getDefaultAccountId(clinician.getId());</span>
            }

<span class="fc" id="L91">            Long patientAccountId = userManager.getDefaultAccountId(patient.getId());</span>

<span class="fc" id="L93">            boolean accountKeyRequired = false;</span>
            // For clinicians without accounts -- set above to true and get this:


<span class="fc bfc" id="L97" title="All 2 branches covered.">            if (clinicianAccountId == null) {</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">                if (clinician.getId() == null) {</span>
<span class="fc" id="L99">                    clinician = userManager.beginNonInstRegistration(clinician); // Create PKBPerson only</span>
                }

<span class="fc" id="L102">                accountKeyRequired = true;</span>
            }



            // If clinician is existing team user, make sure patient isn't already seen by that team
<span class="fc bfc" id="L108" title="All 2 branches covered.">            if (teamUserManager.isTeamUser(clinician.getId())) {</span>
<span class="fc" id="L109">                Team clinicianTeam = teamUserManager.getClinicianTeam(requestContext, clinician.getId());</span>

<span class="fc" id="L111">                if (patientConsentManager.findPatientConsents(patient.getId(), AccessingEntityType.TEAM, false)</span>
<span class="fc" id="L112">                        .stream()</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">                        .anyMatch(consent -&gt; consent.getAccessingTeamOrPersonId().equals(clinicianTeam.getId()))) {</span>
<span class="fc" id="L114">                    throw new PatientAlreadyInTeamException(clinicianTeam.getName(),</span>
<span class="fc" id="L115">                            String.format(</span>
                                    &quot;patient %d is already associated with team %d&quot;,
<span class="fc" id="L117">                                    patient.getId(),</span>
<span class="fc" id="L118">                                    clinicianTeam.getId()));</span>
                }
            }


<span class="fc" id="L123">            invitationManager.inviteClinicianForPatient(</span>
                    requestContext,
                    patientAccountId,
                    author,
                    clinician,
                    accountKeyRequired,
                    message,
                    consentSettings);
<span class="fc" id="L131">        });</span>
<span class="fc" id="L132">    }</span>


    @Override
    public void acceptInvitationAndNotify(@NotNull LoggedInEHRRequestContext requestContext, UUID invitationId, PKBPerson accountOwner, PKBPerson author,
                                          PKBPerson invitee, PKBPerson acceptor) {
<span class="fc" id="L138">        invitationManager.acceptInvitation(requestContext, invitationId, acceptor, null);</span>
<span class="fc" id="L139">    }</span>

    @Override
    public boolean acceptNonInstInvitation(@NotNull EHRRequestContext requestContext, PKBInvitation invitation, String invitationKey) {
<span class="fc" id="L143">        return invitationManager.acceptInvitation(requestContext, invitation.getPublicId(), null, invitationKey);</span>
    }


    // End of May 2015 refactor

    @Override
    public PKBInvitation getInvitation(@NotNull LoggedInEHRRequestContext requestContext, UUID invitationId) {
<span class="nc" id="L151">        return invitationManager.getInvitation(requestContext, invitationId);</span>
    }
    @Override
    public boolean invitedAlready(Email clinicianEmailId) {
<span class="fc" id="L155">        return invitationManager.invitedAlready(Option.of(clinicianEmailId),loggedInUserUtil.getLoggedInUserAccountId());</span>
    }

    @Override
    public boolean isSameUser(@NotNull Email email) {
<span class="fc" id="L160">        PKBPerson currentUser = loggedInUserUtil.getLoggedInPerson();</span>
<span class="fc" id="L161">        var targetEmail = Option.of(email);</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">        for (PersonContact pc : currentUser.getContacts()) {</span>
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">            if (targetEmail.equals(pc.getContactIfEmail())) {</span>
                // possible other checks: confirmed, type EMAIL?
<span class="nc" id="L165">                return true;</span>
            }
<span class="fc" id="L167">        }</span>
<span class="fc" id="L168">        return false;</span>
    }

    @Override
    public String adminInvitesClinician(@NotNull LoggedInEHRRequestContext requestContext, String instituteCode,
                                        PKBPersonDTO clinicianDTO, PKBPerson clinician) throws MailException {

<span class="fc" id="L175">        PKBPerson invitingCoord = userManager.getPKBPerson(loggedInUserUtil.getLoggedInUserId(), PKBPerson.Lazy.CONTACTS);</span>
<span class="fc" id="L176">        Team team = teamManager.getTeamByCode(instituteCode);</span>

<span class="fc" id="L178">        List&lt;PKBPerson&gt; coordList = teamManager.getTeamCoord(team.getId());</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">        for (PKBPerson coord : coordList) {</span>
            // If there is already an open invitation, resend it
<span class="fc" id="L181">            UUID invitationPublicId = invitationManager.getOpenInvitationId(clinicianDTO.getEmailId(), coord.getId()).orElse(null);</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">            if (invitationPublicId != null) {</span>
<span class="nc" id="L183">                pkbEmailMessageManager.inviteClinicianToUpgrade(team, invitingCoord, clinician, invitationPublicId);</span>
<span class="nc" id="L184">                return &quot;resend&quot;;</span>
            }
<span class="fc" id="L186">        }</span>

<span class="fc" id="L188">        teamUserManager.inviteClinician(requestContext, team, clinicianDTO, invitingCoord, clinician);</span>
<span class="fc" id="L189">        return &quot;success&quot;;</span>
    }



    // TODO - use language code of org

    @Override
    public PKBPerson setupOrgCoordinator(@NotNull LoggedInEHRRequestContext requestContext, String title, String firstName,
                                         String lastName, Email emailId,
                                         PKBPerson creator, Org org) {
        // Create coord account

<span class="fc" id="L202">        return userManager.transactional(() -&gt; {</span>
            // Quick&amp;Crappy - lots of existing code breaks if we have a guy without a team, so assign him to the first team in the org
<span class="fc" id="L204">            Team team = org.getTeams().iterator().next();</span>

<span class="fc" id="L206">            PKBPersonDTO personDTO = PKBPersonDTO.of(title, firstName, lastName, emailId, UserType.ORG_COORD, creator.getLanguageCode(),</span>
<span class="fc" id="L207">                    team.getTimeZoneId()); // Expected by UserManager</span>
<span class="fc" id="L208">            PKBPerson newCoordinator = null;</span>


<span class="fc" id="L211">            userManager.registerUserFull(requestContext, personDTO, team.getId());</span>

<span class="fc" id="L213">            newCoordinator = userManager.getPKBPerson(personDTO.getId());</span>


<span class="fc" id="L216">            IdentityVerification verification = IdentityVerification.of(newCoordinator, creator, null/*team*/, dateTimeService.now());</span>
<span class="fc" id="L217">            teamUserManager.activateUserAccount(newCoordinator.getId(), team.getId(), verification);</span>

<span class="fc" id="L219">            return newCoordinator;</span>
        });
    }

    @Override
    public boolean hasIndivAccountAccess(PKBPerson invitee, PKBPerson patient) {
<span class="fc bfc" id="L225" title="All 2 branches covered.">        if (invitee.getStatus() == UserStatus.EMAIL_CONFIRMED &amp;&amp;</span>
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">                patient.isPatient()) {</span>
<span class="fc" id="L227">            return patientConsentManager.hasIndividualAccessToUser(invitee.getId(), patient.getId());</span>
        } else {
<span class="fc" id="L229">            return false;</span>
        }
    }

    @Override
    public PersonContact populateContact(Email email, boolean isPrimary) {
<span class="fc" id="L235">        PersonContact personContact = new PersonContact();</span>
<span class="fc" id="L236">        personContact.setPublicId(UUID.randomUUID());</span>
<span class="fc" id="L237">        personContact.setContactAsEmail(email);</span>
<span class="fc" id="L238">        personContact.setConfirmed(false);</span>
        // primary , since the only one
<span class="fc" id="L240">        personContact.setPrimary(isPrimary);</span>
<span class="fc" id="L241">        return personContact;</span>
    }

    /**
     * builds and returns invitation object
     *
     * @param message   message of the invitation
     * @param authorId
     * @param accountId Inviter account id
     * @return Invitation object
     */
    @Override
    public PKBInvitation populateInvitation(String message,
                                            Long authorId, Long accountId, InvitationType invitationType, EnumSet&lt;PrivacyFlag&gt; requestedConsents, EHRRequestContext requestContext) {
<span class="fc" id="L255">        PKBInvitationDetail invitationDetail = new PKBInvitationDetail(new SourceDetails(requestContext));</span>
<span class="fc" id="L256">        PKBInvitation invitation = new PKBInvitation();</span>
<span class="fc" id="L257">        invitation.setInvitationType(invitationType);</span>
<span class="fc" id="L258">        invitation.setAccountId(accountId);</span>
<span class="fc" id="L259">        invitation.setCreated(dateTimeService.now());</span>
<span class="fc" id="L260">        invitation.setAuthorUserId(authorId);</span>
<span class="fc" id="L261">        invitation.setAccountId(accountId);</span>
<span class="fc" id="L262">        invitationDetail.setContent(message);</span>
<span class="fc" id="L263">        invitation.setInvitationDetail(invitationDetail);</span>
<span class="fc" id="L264">        invitation.setGrantedConsents(requestedConsents);</span>
<span class="fc" id="L265">        return invitation;</span>
    }

    @Override
    public boolean breakTheGlass(@NotNull EHRRequestContext requestContext, long patientId, Team team) {
<span class="fc" id="L270">        Long userId = loggedInUserUtil.getLoggedInUserId();</span>
        try {
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">            if (team == null) {</span>
<span class="fc" id="L273">                team = loggedInUserUtil.getLoggedInUserPrimaryTeam(requestContext);</span>
            }
<span class="fc" id="L275">            teamUserManager.logBreakTheGlassEvent(patientId, team.getId(), userId);</span>
<span class="fc" id="L276">            return pkbWebUtil.breakTheGlassForPatient(patientId);</span>
<span class="nc" id="L277">        } catch (PKBException ex) {</span>
<span class="nc" id="L278">            LOGGER.error(&quot;failed to log break-the-glass access (user {}, patient {}) - denying access&quot;, userId, patientId, ex);</span>
<span class="nc" id="L279">            return false;</span>
        }
    }

    @Override
    public boolean updateOrCreateTeamConsentRecord(@NotNull EHRRequestContext requestContext, @Nullable Long patientId, Long teamId,
                                                   PatientConsent modified) {
        // Reload the original consent for merging (creates a new in-memory object if none exists)
<span class="fc" id="L287">        Optional&lt;PatientConsent&gt; original = deprecatedPatientConsentManager.findPatientConsentWithoutReasons(patientId, teamId, AccessingEntityType.TEAM);</span>
<span class="fc" id="L288">        return updateOrCreateConsentRecord(requestContext, patientId, teamId, AccessingEntityType.TEAM, original, modified);</span>
    }

    @Override
    public boolean updateOrCreateConsentRecord(@NotNull EHRRequestContext requestContext, @Nullable Long patientId, Long accessingId,
                                               AccessingEntityType entityType, Optional&lt;PatientConsent&gt; original, PatientConsent modified) {
<span class="fc" id="L294">        return deprecatedPatientConsentManager.updateOrCreateConsentRecord(requestContext, patientId, accessingId, entityType, original, modified);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>