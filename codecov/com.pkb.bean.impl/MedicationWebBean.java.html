<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MedicationWebBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.bean.impl</a> &gt; <span class="el_source">MedicationWebBean.java</span></div><h1>MedicationWebBean.java</h1><pre class="source lang-java linenums">package com.pkb.bean.impl;

import com.google.common.collect.ImmutableMap;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.bean.IMedicationWebBean;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.document.entity.Attachment;
import com.pkb.institute.entity.Team;
import com.pkb.mappers.EntityDependency;
import com.pkb.medication.entity.Medication;
import com.pkb.medication.entity.PKBMedicationFrequency;
import com.pkb.service.datapoint.DataWithUIPermissions;
import com.pkb.service.datapoint.impl.DataPointManager;
import com.pkb.service.medication.MedicationManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.util.AttachmentUtil;
import com.pkb.util.Constants;
import com.pkb.util.ContextUserUtil;
import com.pkb.util.LocalizedTextProvider;
import com.pkb.util.LoggedInUserUtil;
import com.pkb.util.MedicationDTO;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.lang.invoke.MethodHandles;
import java.time.ZoneId;
import java.time.format.DateTimeFormatter;
import java.util.Date;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

import static java.util.stream.Collectors.toList;

@Component
public class MedicationWebBean implements IMedicationWebBean {

<span class="fc" id="L46">    private static final Map&lt;String, String&gt; EXTENDED_PARAMETERS = ImmutableMap.of(</span>
            &quot;tab&quot;, &quot;treatments&quot;,
            &quot;subTab&quot;, &quot;medications&quot;
    );
    private static final long serialVersionUID = 8867190179028976226L;
<span class="fc" id="L51">    private static final Pattern DOSE_FORMAT_PATTERN = Pattern.compile(&quot;\\.[0]*$&quot;);</span>
    private final MedicationManager medicationManager;
    private final UserManager userManager;
    private final DataPointManager dataPointManager;
    private final LocalizedTextProvider textProvider;
    private final LoggedInUserUtil loggedInUserUtil;
    private final ContextUserUtil contextUserUtil;
    private final AttachmentUtil attachmentUtil;
    private final DateTimeService dateTimeService;

<span class="fc" id="L61">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

    @Autowired
    public MedicationWebBean(MedicationManager medicationManager,
                             UserManager userManager,
                             DataPointManager dataPointManager,
                             LocalizedTextProvider textProvider,
                             LoggedInUserUtil loggedInUserUtil,
                             ContextUserUtil contextUserUtil,
                             AttachmentUtil attachmentUtil,
<span class="fc" id="L71">                             DateTimeService dateTimeService) {</span>
<span class="fc" id="L72">        this.medicationManager = medicationManager;</span>
<span class="fc" id="L73">        this.userManager = userManager;</span>
<span class="fc" id="L74">        this.dataPointManager = dataPointManager;</span>
<span class="fc" id="L75">        this.textProvider = textProvider;</span>
<span class="fc" id="L76">        this.loggedInUserUtil = loggedInUserUtil;</span>
<span class="fc" id="L77">        this.contextUserUtil = contextUserUtil;</span>
<span class="fc" id="L78">        this.attachmentUtil = attachmentUtil;</span>
<span class="fc" id="L79">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L80">    }</span>

    public static String formatDose(Double d) {
<span class="fc" id="L83">        return DOSE_FORMAT_PATTERN.matcher(d.toString()).replaceAll(&quot;&quot;); // Easiest way to do what we want!</span>
    }

    @Override
    public String getMedicationAsHtml(@NotNull LoggedInEHRRequestContext requestContext, Long accountId,
            Long medicationId, Locale locale, ZoneId zone) {
        try {

<span class="fc" id="L91">            Optional&lt;Medication&gt; maybeMedication = medicationManager.findMedication(</span>
                    requestContext,
                    accountId, medicationId);

<span class="fc bfc" id="L95" title="All 2 branches covered.">            if (!maybeMedication.isPresent()) {</span>
<span class="fc" id="L96">                LOGGER.error(&quot;Medication to show as HTML not found: {}, acct {}&quot;, medicationId, accountId);</span>
<span class="fc" id="L97">                return &quot;&lt;br/&gt;&lt;i&gt;Medication not found.&lt;/i&gt;&quot;;</span>
            }

<span class="fc" id="L100">            Medication medication = maybeMedication.get();</span>

<span class="fc" id="L102">            DateTimeFormatter dateTimeFormatter = DateTimeFormatter.ofPattern(textProvider.getText(&quot;global.format.date_output&quot;)).withLocale(locale).withZone(zone);</span>
<span class="fc" id="L103">            StringBuilder result = new StringBuilder(250);</span>

<span class="fc" id="L105">            result.append(&quot;&lt;div class=\&quot;prescription\&quot;&gt;&lt;h1&gt;&quot;)</span>
<span class="fc" id="L106">                    .append(medication.getMedication().getTextForDisplay())</span>
<span class="fc" id="L107">                    .append(&quot;&lt;/h1&gt;&quot;);</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">            if (medication.getDoseValue() != null) {</span>
<span class="fc" id="L109">                result.append(&quot;&lt;p class=\&quot;dose\&quot;&gt;&lt;span=\&quot;label\&quot;&gt;Dose&lt;/span&gt;: &quot;);</span>
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">                if (medication.getDoseUnitPkbId() != null) {</span>
<span class="nc" id="L111">                    result.append(formatDose(medication.getDoseValue()) + &quot; &quot; + textProvider.getText(medication.getDoseUnitKey()));</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">                } else if (medication.getDoseUnit() != null) {</span>
<span class="fc" id="L113">                    result.append(formatDose(medication.getDoseValue()) + &quot; &quot; + medication.getDoseUnit().getTextForDisplay());</span>
                } else {
<span class="nc" id="L115">                    result.append(formatDose(medication.getDoseValue()));</span>
                }
<span class="fc" id="L117">                result.append(&quot;&lt;/p&gt;&quot;);</span>
            }

<span class="fc" id="L120">            result.append(&quot;&lt;p class=\&quot;frequency\&quot;&gt;&lt;span=\&quot;label\&quot;&gt;Frequency&lt;/span&gt;: &quot;);</span>
<span class="pc bpc" id="L121" title="1 of 4 branches missed.">            if (medication.getFrequency() != null &amp;&amp; medication.getFrequency() != PKBMedicationFrequency.BLANK) {</span>
<span class="fc" id="L122">                result.append(textProvider.getText(medication.getFrequency().getValue()));</span>
            } else {
<span class="fc" id="L124">                result.append(medication.getFrequencyDisplayStr());</span>
            }
<span class="fc" id="L126">            result.append(&quot;&lt;/p&gt;&quot;)</span>
<span class="fc" id="L127">                    .append(&quot;&lt;p class=\&quot;instructions\&quot;&gt;&lt;span=\&quot;label\&quot;&gt;Instructions&lt;/span&gt;: &quot;)</span>
<span class="fc" id="L128">                    .append(getString(medication.getInstructions()))</span>
<span class="fc" id="L129">                    .append(&quot;&lt;/p&gt;&quot;)</span>
<span class="fc" id="L130">                    .append(&quot;&lt;p class=\&quot;order_date\&quot;&gt;&lt;span=\&quot;label\&quot;&gt;Order date&lt;/span&gt;: &quot;)</span>
<span class="fc" id="L131">                    .append(convertDateToString(medication.getOrderDate(), dateTimeFormatter))</span>
<span class="fc" id="L132">                    .append(&quot;&lt;/p&gt;&quot;)</span>
<span class="fc" id="L133">                    .append(&quot;&lt;p class=\&quot;start_date\&quot;&gt;&lt;span=\&quot;label\&quot;&gt;Start date&lt;/span&gt;: &quot;)</span>
<span class="fc" id="L134">                    .append(convertDateToString(medication.getStartDate(), dateTimeFormatter))</span>
<span class="fc" id="L135">                    .append(&quot;&lt;/p&gt;&quot;)</span>
<span class="fc" id="L136">                    .append(&quot;&lt;p class=\&quot;end_date\&quot;&gt;&lt;span=\&quot;label\&quot;&gt;End date&lt;/span&gt;: &quot;)</span>
<span class="fc" id="L137">                    .append(convertDateToString(medication.getEndDate(), dateTimeFormatter))</span>
<span class="fc" id="L138">                    .append(&quot;&lt;/p&gt;&quot;)</span>
<span class="fc" id="L139">                    .append(&quot;&lt;p class=\&quot;patient\&quot;&gt;&lt;span=\&quot;label\&quot;&gt;Patient&lt;/span&gt;: &quot;)</span>
<span class="fc" id="L140">                    .append(getPersonName(medication.getPatientLdapUID()))</span>
<span class="fc" id="L141">                    .append(&quot;&lt;/p&gt;&lt;/div&gt;&quot;);</span>

<span class="pc bpc" id="L143" title="1 of 2 branches missed.">            if (medication.getAttachments() != null) {</span>
<span class="fc" id="L144">                result.append(&quot;&lt;div class=\&quot;prescription\&quot;&gt;&quot;);</span>
<span class="pc bpc" id="L145" title="1 of 2 branches missed.">                for (Attachment attachment : medication.getAttachments()) {</span>
<span class="nc" id="L146">                    result.append(&quot;&lt;p&gt;&quot; + attachment.getFilename() + &quot;: &quot;</span>
<span class="nc" id="L147">                            + &quot;&lt;a href='/auth/getAttachment.action?attachmentId=&quot; + attachment.getId() + &quot;&amp;amp;fileName=\&quot;&quot;</span>
<span class="nc" id="L148">                            + attachment.getFilename() + &quot;\&quot;'&quot;</span>
                            + &quot; title='Download attached file' target='_blank'&gt;&quot;
                            + &quot;download&lt;/a&gt;&quot;);
<span class="nc" id="L151">                }</span>
<span class="fc" id="L152">                result.append(&quot;&lt;/div&gt;&quot;);</span>
            }

<span class="fc" id="L155">            return result.toString();</span>
<span class="nc" id="L156">        } catch (Exception e) {</span>
            // don't crash; log it and return a polite error
            // TODO: get message from properties file
<span class="nc" id="L159">            LOGGER.error(&quot;Failed loading medication to show as HTML: {}, acct {}&quot;, medicationId, accountId, e);</span>
<span class="nc" id="L160">            return &quot;&lt;br/&gt;&lt;i&gt;There was a problem loading this medication.&lt;/i&gt;&quot;;</span>
        }
    }

    @Override
    public List&lt;MedicationDTO&gt; convertMedicationsToDTOs(List&lt;DataWithUIPermissions&lt;Medication&gt;&gt; medications,
                                                        EntityDependency&lt;Medication&gt; entityDependency) {
<span class="fc" id="L167">        Set&lt;Long&gt; editorIds = medications.stream()</span>
<span class="fc" id="L168">                .map(DataWithUIPermissions::getData)</span>
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">                .filter(m -&gt; m.getSource() != null)</span>
<span class="fc bfc" id="L170" title="All 2 branches covered.">                .filter(m -&gt; m.getSource().getPersonId() != null)</span>
<span class="fc" id="L171">                .map(m -&gt; m.getSource().getPersonId())</span>
<span class="fc" id="L172">                .collect(Collectors.toSet());</span>

<span class="fc" id="L174">        Map&lt;Long, PKBPerson&gt; personMap = userManager.getPKBPersonList(editorIds).stream().collect(Collectors.toMap(</span>
<span class="pc" id="L175">                PKBPerson::getId, pkbPerson -&gt; pkbPerson, (pkbPerson, duplicate) -&gt; pkbPerson));</span>

<span class="fc" id="L177">        return medications.stream().map(m -&gt; convertMedicationToDTO(m, personMap, entityDependency)).collect(toList());</span>
    }

    @Override
    public Medication setMedicationUp(@NotNull LoggedInEHRRequestContext context, Team team, Long medicationId) {
        Medication medication;

<span class="fc" id="L184">        PKBPerson loggedInUser = loggedInUserUtil.getLoggedInUser();</span>
<span class="fc" id="L185">        long patientId = contextUserUtil.getContextOrLoggedInUserId();</span>
<span class="fc" id="L186">        long userId = loggedInUserUtil.getLoggedInUserId();</span>
<span class="fc" id="L187">        Long patientAccountId = userManager.getDefaultAccountId(patientId);</span>

<span class="pc bpc" id="L189" title="2 of 4 branches missed.">        if ((medicationId != null) &amp;&amp; (medicationId != 0)) {</span>
<span class="fc" id="L190">            medication = medicationManager.getMedication(context, patientAccountId, medicationId);</span>

<span class="fc" id="L192">            DataWithUIPermissions&lt;Medication&gt; medicationWithPermissions = dataPointManager.getPermission(medication, loggedInUser, team);</span>
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">            if (!medicationWithPermissions.isPrivacyFlagEditable()) {</span>
<span class="nc" id="L194">                throw new RuntimeException(&quot;User-&quot; + userId + &quot; attempting to edit medication-&quot; + medicationId + &quot; created by user-&quot;</span>
<span class="nc" id="L195">                        + medication.getSource().getPersonId());</span>
            }
<span class="fc" id="L197">        } else {</span>
<span class="nc" id="L198">            throw new IllegalStateException(&quot;Wrong medication&quot;);</span>
        }

<span class="fc" id="L201">        return medication;</span>
    }

    @NotNull
    private MedicationDTO convertMedicationToDTO(DataWithUIPermissions&lt;Medication&gt; medication,
                                                 Map&lt;Long, PKBPerson&gt; personMap,
                                                 EntityDependency&lt;Medication&gt; entityDependency) {
<span class="fc" id="L208">        MedicationDTO medicationDTO = new MedicationDTO();</span>
<span class="fc" id="L209">        medicationDTO.setPatientOnMedication(medication.getData().getPatientOnMedication());</span>
<span class="fc" id="L210">        medicationDTO.setId(medication.getData().getId());</span>
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">        if (medication.getData().getMedication() != null) {</span>
<span class="fc" id="L212">            medicationDTO.setSubstance(medication.getData().getMedication().getTextForDisplay());</span>
        }
<span class="fc bfc" id="L214" title="All 2 branches covered.">        if (medication.getData().getDoseValue() != null) {</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">            if (medication.getData().getDoseUnitPkbId() != null) {</span>
<span class="fc" id="L216">                medicationDTO.setDose(formatDose(medication.getData().getDoseValue()) + &quot; &quot; + textProvider.getText(medication.getData().getDoseUnitKey()));</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">            } else if (medication.getData().getDoseUnit() != null) {</span>
<span class="fc" id="L218">                medicationDTO.setDose(formatDose(medication.getData().getDoseValue()) + &quot; &quot; + medication.getData().getDoseUnit().getTextForDisplay());</span>
            } else {
<span class="fc" id="L220">                medicationDTO.setDose(formatDose(medication.getData().getDoseValue()));</span>
            }
        }

<span class="fc bfc" id="L224" title="All 2 branches covered.">        medicationDTO.setStartDate(medication.getData().getStartDate() == null ? null : medication.getData().getStartDate().toInstant());</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">        medicationDTO.setEndDate(medication.getData().getEndDate() == null ? null : medication.getData().getEndDate().toInstant());</span>
<span class="pc bpc" id="L226" title="1 of 4 branches missed.">        if (medicationDTO.getEndDate() != null &amp;&amp; !medicationDTO.isPast()) {</span>
<span class="fc" id="L227">            medicationDTO.setPast(medicationDTO.getEndDate().isBefore(dateTimeService.today().atStartOfDay(Constants.APPLICATION_TZ).toInstant()));</span>
        }

<span class="pc bpc" id="L230" title="1 of 4 branches missed.">        if (medication.getData().getFrequency() != null &amp;&amp; medication.getData().getFrequency() != PKBMedicationFrequency.BLANK) {</span>
<span class="fc" id="L231">            medicationDTO.setFrequency(textProvider.getText(medication.getData().getFrequency().getValue()));</span>
        } else {
<span class="fc" id="L233">            medicationDTO.setFrequency(medication.getData().getFrequencyDisplayStr());</span>
        }

<span class="fc" id="L236">        medicationDTO.setAdditionalInstructions(medication.getData().getInstructions());</span>
<span class="fc" id="L237">        medicationDTO.setAttachments(attachmentUtil.buildAttachments(medication.getData().getAttachments(), EXTENDED_PARAMETERS, entityDependency));</span>

<span class="pc bpc" id="L239" title="1 of 2 branches missed.">        if (medication.getData().getSource() != null) {</span>
<span class="fc" id="L240">            medicationDTO.setSource(medication.getData().getSource());</span>
<span class="fc" id="L241">            Long editorId = medication.getData().getSource().getPersonId();</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">            if (editorId != null) {</span>
<span class="fc" id="L243">                PKBPerson editor = personMap.get(editorId);</span>
<span class="pc bpc" id="L244" title="1 of 2 branches missed.">                if (editor == null) {</span>
<span class="nc" id="L245">                    LOGGER.error(&quot;NOTHROW: error getting pkbperson for med-{} editor-{}&quot;, medication.getData().getId(), editorId);</span>
                } else {
<span class="fc" id="L247">                    medicationDTO.setNotedBy(editor);</span>
                }
            }
        }

<span class="fc bfc" id="L252" title="All 2 branches covered.">        if (medication.getData().getStatus() != null) {</span>
<span class="fc" id="L253">            medicationDTO.setStatus(medication.getData().getStatus().toString());</span>
<span class="fc bfc" id="L254" title="All 2 branches covered.">            if (!medicationDTO.isPast()) {</span>
<span class="fc bfc" id="L255" title="All 2 branches covered.">                medicationDTO.setPast(medication.getData().getStatus() == Medication.MedicationStatus.INACTIVE);</span>
            }
        }

<span class="fc" id="L259">        medicationDTO.setBaseFields(medication.getData().getBaseFields());</span>
<span class="fc" id="L260">        medicationDTO.setMedication(medication.getData().getMedication());</span>
<span class="fc" id="L261">        medicationDTO.setDoseUnit(medication.getData().getDoseUnit());</span>
<span class="fc" id="L262">        medication.copyPermissionsInto(medicationDTO);</span>
<span class="fc" id="L263">        return medicationDTO;</span>
    }

    private String convertDateToString(Date date, DateTimeFormatter dateTimeFormatter) {
<span class="pc bpc" id="L267" title="1 of 2 branches missed.">        if (date == null) {</span>
<span class="nc" id="L268">            return &quot;&quot;;</span>
        }
<span class="fc" id="L270">        return dateTimeService.dateToString(date, dateTimeFormatter);</span>
    }

    private String getDoubleString(Double doub) {
<span class="nc bnc" id="L274" title="All 2 branches missed.">        if (doub == null) {</span>
<span class="nc" id="L275">            return &quot;&quot;;</span>
        }
<span class="nc" id="L277">        return Double.toString(doub);</span>
    }

    private String getString(String string) {
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">        if (string == null) {</span>
<span class="nc" id="L282">            return &quot;&quot;;</span>
        }
<span class="fc" id="L284">        return string;</span>
    }

    private String getLongString(Long l) {
<span class="nc bnc" id="L288" title="All 2 branches missed.">        if (l == null) {</span>
<span class="nc" id="L289">            return &quot;&quot;;</span>
        }
<span class="nc" id="L291">        return l.toString();</span>
    }

    private String getPersonName(String ldapUID) throws NumberFormatException {
<span class="pc bpc" id="L295" title="3 of 4 branches missed.">        if ((ldapUID == null) || ldapUID.isEmpty()) {</span>
<span class="fc" id="L296">            return &quot;&quot;;</span>
        }
<span class="nc" id="L298">        PKBPerson person = userManager.getPKBPerson(Long.parseLong(ldapUID));</span>
<span class="nc" id="L299">        return person.getTitle() + &quot; &quot; + person.getFirstName() + &quot; &quot;</span>
<span class="nc" id="L300">                + person.getLastName();</span>
    }

    public MedicationManager getMedicationManager() {
<span class="nc" id="L304">        return medicationManager;</span>
    }

    public UserManager getUserManager() {
<span class="nc" id="L308">        return userManager;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>