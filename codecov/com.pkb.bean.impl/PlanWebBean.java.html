<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlanWebBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.bean.impl</a> &gt; <span class="el_source">PlanWebBean.java</span></div><h1>PlanWebBean.java</h1><pre class="source lang-java linenums">package com.pkb.bean.impl;

import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.bean.IPlanWebBean;
import com.pkb.phplan.entity.PHPlan;
import com.pkb.phplan.entity.PHPlanAttachment;
import com.pkb.phplan.entity.PHPlanTemplate.TemplateFieldLabel;
import com.pkb.phplan.entity.PlanField;
import com.pkb.service.phplan.PlanManager;
import com.pkb.util.LocalizedTextProvider;
import org.apache.commons.text.StringEscapeUtils;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.w3c.dom.Text;
import org.xml.sax.InputSource;
import org.xml.sax.SAXParseException;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import java.io.ByteArrayInputStream;
import java.io.StringReader;
import java.io.StringWriter;
import java.io.Writer;
import java.lang.invoke.MethodHandles;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.List;
import java.util.Locale;
import java.util.Optional;
import java.util.UUID;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import static com.pkb.util.Constants.APPLICATION_TZ;
import static com.pkb.util.StringUtil.containsLineBreak;
import static com.pkb.util.StringUtil.newLineToBR;
import static java.nio.charset.StandardCharsets.UTF_8;
import static org.apache.commons.text.StringEscapeUtils.unescapeHtml4;

@Component
public class PlanWebBean implements IPlanWebBean {

    private static final long serialVersionUID = -7009068977149785961L;

<span class="fc" id="L57">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

    private final PlanManager planManager;

    private final LocalizedTextProvider textProvider;

    @Autowired
<span class="fc" id="L64">    public PlanWebBean(PlanManager planManager, LocalizedTextProvider textProvider) {</span>
<span class="fc" id="L65">        this.planManager = planManager;</span>
<span class="fc" id="L66">        this.textProvider = textProvider;</span>
<span class="fc" id="L67">    }</span>

    @Override
    public String getPHPlanAsHtml(@NotNull LoggedInEHRRequestContext requestContext, Long accountId, UUID planUniqueId) {
        try {
<span class="nc" id="L72">            PHPlan plan = planManager.getPHPlanForAccountId(planUniqueId, requestContext, accountId);</span>
<span class="nc" id="L73">            return formatPHPlanAsHtml(requestContext, plan, accountId);</span>
<span class="nc" id="L74">        } catch (Exception e) {</span>
<span class="nc" id="L75">            throw new RuntimeException(&quot;Error while getting PH Plan-&quot; + planUniqueId, e);</span>
        }
    }

    @Override
    public String getPHPlanAsHtml(@NotNull LoggedInEHRRequestContext requestContext, Long accountId, UUID planUniqueId, Long versionNumber, PHPlan.Lazy... fields) {
        try {
<span class="fc" id="L82">            PHPlan plan = planManager.getPHPlanForAccountIdAndVersionNumber(requestContext, accountId, planUniqueId, versionNumber, fields);</span>
<span class="fc" id="L83">            return formatPHPlanAsHtml(requestContext, plan, accountId);</span>
<span class="nc" id="L84">        } catch (Exception e) {</span>
<span class="nc" id="L85">            throw new RuntimeException(&quot;Error while getting PH Plan-&quot; + planUniqueId + &quot; version-&quot; + versionNumber, e);</span>
        }
    }

    private String formatPHPlanAsHtml(@NotNull LoggedInEHRRequestContext requestContext, PHPlan plan, Long accountId) throws Exception {
<span class="fc" id="L90">        DateTimeFormatter formatter = DateTimeFormatter.ofPattern(textProvider.getText(&quot;global.format.date_output&quot;)).withLocale(Locale.UK).withZone(APPLICATION_TZ);</span>

<span class="fc" id="L92">        PlanField actionPlanField = plan.getPlanField(TemplateFieldLabel.ACTION_PLAN);</span>
<span class="fc" id="L93">        PlanField greenField = plan.getPlanField(TemplateFieldLabel.GREEN);</span>
<span class="fc" id="L94">        PlanField amberField = plan.getPlanField(TemplateFieldLabel.AMBER);</span>
<span class="fc" id="L95">        PlanField redField = plan.getPlanField(TemplateFieldLabel.RED);</span>

<span class="fc bfc" id="L97" title="All 2 branches covered.">        String actionPlanText = actionPlanField == null ? null : actionPlanField.getText();</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">        String greenPlanText = greenField == null ? null : greenField.getText();</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">        String amberPlanText = amberField == null ? null : amberField.getText();</span>
<span class="fc bfc" id="L100" title="All 2 branches covered.">        String redPlanText = redField == null ? null : redField.getText();</span>

<span class="fc bfc" id="L102" title="All 2 branches covered.">        if (actionPlanText != null) {</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">            if (actionPlanText.startsWith(&quot;&lt;div&quot;)) {</span>
<span class="fc" id="L104">                actionPlanText = expandHtmlWidgets(actionPlanText);</span>
            } else {
<span class="nc" id="L106">                actionPlanText = StringEscapeUtils.escapeHtml4(actionPlanText);</span>
            }
        }

<span class="fc bfc" id="L110" title="All 2 branches covered.">        if (greenPlanText != null) {</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">            if (greenPlanText.startsWith(&quot;&lt;div&quot;)) {</span>
<span class="nc" id="L112">                greenPlanText = expandHtmlWidgets(greenPlanText);</span>
            } else {
<span class="fc" id="L114">                greenPlanText = StringEscapeUtils.escapeHtml4(greenPlanText);</span>
            }
        }

<span class="fc bfc" id="L118" title="All 2 branches covered.">        if (amberPlanText != null) {</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">            if (amberPlanText.startsWith(&quot;&lt;div&quot;)) {</span>
<span class="nc" id="L120">                amberPlanText = expandHtmlWidgets(amberPlanText);</span>
            } else {
<span class="fc" id="L122">                amberPlanText = StringEscapeUtils.escapeHtml4(amberPlanText);</span>
            }
        }

<span class="fc bfc" id="L126" title="All 2 branches covered.">        if (redPlanText != null) {</span>
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">            if (redPlanText.startsWith(&quot;&lt;div&quot;)) {</span>
<span class="nc" id="L128">                redPlanText = expandHtmlWidgets(redPlanText);</span>
            } else {
<span class="fc" id="L130">                redPlanText = StringEscapeUtils.escapeHtml4(redPlanText);</span>
            }
        }

<span class="fc" id="L134">        StringBuilder html = new StringBuilder();</span>
<span class="fc" id="L135">        html.append(&quot;&lt;div class='phplan'&gt;&quot; + &quot;&lt;h1&gt;&quot;)</span>
<span class="fc" id="L136">                .append(plan.getName())</span>
<span class="fc" id="L137">                .append(&quot;&lt;/h1&gt;&quot;)</span>
<span class="fc" id="L138">                .append(&quot;&lt;div class='date'&gt;&lt;p&gt;&lt;span='label'&gt;Date&lt;/span&gt;: &quot;)</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">                .append((plan.getLastEditedOn() == null) ? &quot;Unknown&quot; : formatter.format(plan.getLastEditedOn().toInstant()))</span>
<span class="fc" id="L140">                .append(&quot;&lt;/p&gt;&lt;/div&gt;&quot;);</span>

<span class="fc bfc" id="L142" title="All 2 branches covered.">        if (actionPlanText != null) {</span>
<span class="fc" id="L143">            html.append(&quot;&lt;div class='actionPlan'&gt;&lt;p&gt;&lt;span='label'&gt;&quot;)</span>
<span class="fc" id="L144">                    .append(textProvider.getText(&quot;viewPlan.txt.action_plan&quot;))</span>
<span class="fc" id="L145">                    .append(&quot;&lt;/span&gt;: &quot;).append(actionPlanText)</span>
<span class="fc" id="L146">                    .append(&quot;&lt;/p&gt;&lt;/div&gt;&quot;);</span>
        }

<span class="fc bfc" id="L149" title="All 2 branches covered.">        if (greenPlanText != null) {</span>
<span class="fc" id="L150">            html.append(&quot;&lt;div class='green'&gt;&lt;p&gt;&lt;span='label'&gt;&quot;)</span>
<span class="fc" id="L151">                    .append(textProvider.getText(&quot;viewPlan.txt.green&quot;))</span>
<span class="fc" id="L152">                    .append(&quot;&lt;/span&gt;: &quot;)</span>
<span class="fc" id="L153">                    .append(greenPlanText).append(&quot;&lt;/p&gt;&lt;/div&gt;&quot;);</span>
        }

<span class="fc bfc" id="L156" title="All 2 branches covered.">        if (amberPlanText != null) {</span>
<span class="fc" id="L157">            html.append(&quot;&lt;div class='amber'&gt;&lt;p&gt;&lt;span='label'&gt;&quot;)</span>
<span class="fc" id="L158">                    .append(textProvider.getText(&quot;viewPlan.txt.amber&quot;))</span>
<span class="fc" id="L159">                    .append(&quot;&lt;/span&gt;: &quot;)</span>
<span class="fc" id="L160">                    .append(amberPlanText)</span>
<span class="fc" id="L161">                    .append(&quot;&lt;/p&gt;&lt;/div&gt;&quot;);</span>
        }

<span class="fc bfc" id="L164" title="All 2 branches covered.">        if (redPlanText != null) {</span>
<span class="fc" id="L165">            html.append(&quot;&lt;div class='red'&gt;&lt;p&gt;&lt;span='label'&gt;&quot;)</span>
<span class="fc" id="L166">                    .append(textProvider.getText(&quot;viewPlan.txt.red&quot;))</span>
<span class="fc" id="L167">                    .append(&quot;&lt;/span&gt;: &quot;)</span>
<span class="fc" id="L168">                    .append(redPlanText)</span>
<span class="fc" id="L169">                    .append(&quot;&lt;/p&gt;&lt;/div&gt;&quot;);</span>
        }

        try {
            // Attachments go here!
<span class="fc" id="L174">            List&lt;PHPlanAttachment&gt; attachmentList = planManager.getAttachments(plan.getId(), requestContext, accountId);</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">            for (PHPlanAttachment attachment : attachmentList) {</span>
<span class="fc" id="L176">                html.append(&quot;&lt;div&gt;&quot;);</span>
<span class="pc bpc" id="L177" title="1 of 4 branches missed.">                if (attachment.isPdf() || attachment.isConvertibleToPdf()) {</span>
                    // Cribbed from discussionCenter.jsp
<span class="fc" id="L179">                    html.append(&quot;&lt;div class='hidden-phone hidden-tablet'&gt;&quot;);</span>
<span class="fc" id="L180">                    html.append(&quot; &lt;object data='getPlanImage.action?attachmentId=&quot;)</span>
<span class="fc" id="L181">                            .append(attachment.getAttachmentId())</span>
<span class="fc" id="L182">                            .append(&quot;&amp;contentDisposition=inline' type='application/pdf' width='200'&gt;&quot;);</span>
<span class="fc" id="L183">                    html.append(&quot;   &quot;)</span>
<span class="fc" id="L184">                            .append(textProvider.getText(&quot;viewPlan.txt.download_file&quot;))</span>
<span class="fc" id="L185">                            .append(&quot;: &lt;a class='link' href='getPlanImage.action?attachmentId=&quot;)</span>
<span class="fc" id="L186">                            .append(attachment.getAttachmentId())</span>
<span class="fc" id="L187">                            .append(&quot;'&gt;&quot;);</span>
<span class="fc" id="L188">                    html.append(&quot;     &quot;)</span>
<span class="fc" id="L189">                            .append(attachment.getLabel());</span>
<span class="fc" id="L190">                    html.append(&quot;   &lt;/a&gt;&quot;);</span>
<span class="fc" id="L191">                    html.append(&quot;  &lt;/object&gt;&quot;);</span>
<span class="fc" id="L192">                    html.append(&quot;&lt;/div&gt;&quot;);</span>
<span class="fc" id="L193">                    html.append(&quot;&lt;div class='visible-phone visible-tablet' style='display:none;'&gt;&quot;);</span>
<span class="fc" id="L194">                    html.append(&quot;  &quot;).append(textProvider.getText(&quot;viewPlan.txt.pdf_is_best_viewed_on_desktop&quot;));</span>
<span class="fc" id="L195">                    html.append(&quot;  &lt;a class='link' href='getPlanImage.action?attachmentId=&quot;)</span>
<span class="fc" id="L196">                            .append(attachment.getAttachmentId()).append(&quot;'&gt;&quot;)</span>
<span class="fc" id="L197">                            .append(attachment.getLabel())</span>
<span class="fc" id="L198">                            .append(&quot;&lt;i class='fa fa-arrow-right icon-arrow-right'&gt;&lt;/i&gt;&lt;/a&gt;&quot;);</span>
<span class="fc" id="L199">                    html.append(&quot;&lt;/div&gt;&quot;);</span>
                } else {
<span class="fc" id="L201">                    html.append(&quot;&lt;img src='getPlanImage.action?attachmentId=&quot;)</span>
<span class="fc" id="L202">                            .append(attachment.getAttachmentId())</span>
<span class="fc" id="L203">                            .append(&quot;' alt='image' width='200'/&gt;&quot;);</span>
                }
<span class="fc" id="L205">                html.append(&quot;&lt;br/&gt;&quot;)</span>
<span class="fc" id="L206">                        .append(attachment.getLabel())</span>
<span class="fc" id="L207">                        .append(&quot;&lt;/div&gt;&quot;);</span>
<span class="fc" id="L208">                planManager.ensureImageIsCached(requestContext, attachment);</span>
<span class="fc" id="L209">            }</span>
<span class="nc" id="L210">        } catch (Exception e) {</span>
<span class="nc" id="L211">            LOGGER.error(&quot;Error getting attachments for plan {} by user {}&quot;, plan.getId(), requestContext.getAccessingUserId(), e);</span>
            // if there was a problem fetching attachments , show message informing the same
<span class="nc" id="L213">            html.append(&quot;&lt;br/&gt;&quot;).append(textProvider.getText(&quot;viewPlan.txt.refer_to_patient_copy&quot;));</span>
<span class="fc" id="L214">        }</span>
<span class="fc" id="L215">        html.append(&quot;&lt;/div&gt;&quot;);</span>
<span class="fc" id="L216">        return html.toString();</span>

    }

    @Override
    public String expandHtmlWidgets(String actionPlanText) throws Exception {
        try {
<span class="fc" id="L223">            DocumentBuilderFactory dbf = DocumentBuilderFactory.newInstance();</span>
<span class="fc" id="L224">            DocumentBuilder db = dbf.newDocumentBuilder();</span>
<span class="fc" id="L225">            InputSource input = new InputSource(new StringReader(actionPlanText));</span>
<span class="fc" id="L226">            Document dom = db.parse(input);</span>

<span class="fc" id="L228">            Element root = dom.getDocumentElement();</span>

<span class="fc" id="L230">            NodeList selectNodeList = root.getElementsByTagName(&quot;select&quot;);</span>
<span class="fc" id="L231">            List&lt;Element&gt; selects = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L232" title="All 2 branches covered.">            for (int i = 0; i &lt; selectNodeList.getLength(); ++i) {</span>
<span class="fc" id="L233">                selects.add((Element) selectNodeList.item(i));</span>
            }

<span class="fc bfc" id="L236" title="All 2 branches covered.">            for (Element select : selects) {</span>
<span class="fc" id="L237">                String value = &quot;&quot;;</span>

<span class="fc" id="L239">                NodeList optionNodeList = select.getElementsByTagName(&quot;option&quot;);</span>
<span class="pc bpc" id="L240" title="1 of 2 branches missed.">                for (int j = 0; j &lt; optionNodeList.getLength(); ++j) {</span>
<span class="fc" id="L241">                    Element option = (Element) optionNodeList.item(j);</span>
<span class="fc bfc" id="L242" title="All 2 branches covered.">                    if (&quot;selected&quot;.equals(option.getAttribute(&quot;selected&quot;))) {</span>
<span class="fc" id="L243">                        value = option.getAttribute(&quot;value&quot;);</span>
<span class="fc" id="L244">                        break;</span>
                    }
                }
<span class="fc" id="L247">                Text replacementNode = dom.createTextNode(value);</span>
<span class="fc" id="L248">                select.getParentNode().replaceChild(replacementNode, select);</span>
<span class="fc" id="L249">            }</span>

<span class="fc" id="L251">            NodeList inputNodeList = root.getElementsByTagName(&quot;input&quot;);</span>
<span class="fc" id="L252">            List&lt;Element&gt; inputs = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L253">            List&lt;Element&gt; checkableInputs = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L254">            List&lt;Element&gt; textualInputs = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L255">            List&lt;Element&gt; checkboxes = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L257" title="All 2 branches covered.">            for (int i = 0; i &lt; inputNodeList.getLength(); ++i) {</span>
<span class="fc" id="L258">                inputs.add((Element) inputNodeList.item(i));</span>
<span class="fc" id="L259">                Element inputElement = (Element) inputNodeList.item(i);</span>

<span class="fc bfc" id="L261" title="All 2 branches covered.">                if (&quot;radio&quot;.equals(inputElement.getAttribute(&quot;type&quot;))</span>
<span class="fc bfc" id="L262" title="All 2 branches covered.">                        || &quot;checkbox&quot;.equals(inputElement.getAttribute(&quot;type&quot;))) {</span>
<span class="fc" id="L263">                    checkableInputs.add(inputElement);</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">                } else if (&quot;text&quot;.equals(inputElement.getAttribute(&quot;type&quot;))</span>
<span class="pc bpc" id="L265" title="1 of 2 branches missed.">                        || &quot;date&quot;.equals(inputElement.getAttribute(&quot;type&quot;))) {</span>
<span class="fc" id="L266">                    textualInputs.add(inputElement);</span>
                }

            }

<span class="fc" id="L271">            checkableInputs.forEach(e -&gt; replaceCheckableInput(e, dom));</span>
<span class="fc" id="L272">            textualInputs.forEach(e -&gt; replaceTextualInput(e, dom));</span>

<span class="fc" id="L274">            NodeList textAreaNodeList = root.getElementsByTagName(&quot;textarea&quot;);</span>
<span class="fc" id="L275">            List&lt;Element&gt; textAreas = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L276" title="All 2 branches covered.">            for (int i = 0; i &lt; textAreaNodeList.getLength(); ++i) {</span>
<span class="fc" id="L277">                Element textArea = (Element) textAreaNodeList.item(i);</span>
<span class="fc" id="L278">                textAreas.add(textArea);</span>
            }

<span class="fc bfc" id="L281" title="All 2 branches covered.">            for (Element textArea : textAreas) {</span>
<span class="fc" id="L282">                String value = textArea.getTextContent().replace(&quot;&amp;&quot;,&quot;&amp;amp;&quot;); // getTextContent() gets unescaped &amp; which breaks db.parse()</span>
                Node replacementNode;
<span class="fc bfc" id="L284" title="All 2 branches covered.">                if (containsLineBreak(value)) {</span>
<span class="fc" id="L285">                    String html = newLineToBR(&quot;&lt;span&gt;&quot; + value + &quot;&lt;/span&gt;&quot;);</span>
<span class="fc" id="L286">                    Document node = db.parse(new ByteArrayInputStream(html.getBytes(UTF_8)));</span>
<span class="fc" id="L287">                    replacementNode = node.getFirstChild();</span>
<span class="fc" id="L288">                    dom.adoptNode(replacementNode);</span>
<span class="fc" id="L289">                } else {</span>
<span class="fc" id="L290">                    replacementNode = dom.createTextNode(unescapeHtml4(value));</span>
                }
<span class="fc" id="L292">                textArea.getParentNode().replaceChild(replacementNode, textArea);</span>
<span class="fc" id="L293">            }</span>

<span class="fc" id="L295">            root.normalize();</span>

<span class="fc" id="L297">            TransformerFactory tFactory = TransformerFactory.newInstance();</span>
<span class="fc" id="L298">            Transformer transformer = tFactory.newTransformer();</span>
<span class="fc" id="L299">            transformer.setOutputProperty(OutputKeys.ENCODING, &quot;UTF-16&quot;);</span>
<span class="fc" id="L300">            transformer.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, &quot;yes&quot;);</span>
<span class="fc" id="L301">            DOMSource source = new DOMSource(dom);</span>
<span class="fc" id="L302">            Writer writer = new StringWriter();</span>
<span class="fc" id="L303">            StreamResult transformerResult = new StreamResult(writer);</span>
<span class="fc" id="L304">            transformer.transform(source, transformerResult);</span>

            // Hack - replace &lt;iframe ... /&gt; with &lt;iframe ...&gt;&lt;/iframe&gt;
<span class="fc" id="L307">            StringBuilder result = new StringBuilder();</span>
<span class="fc" id="L308">            Matcher tagMatcher = Pattern.compile(&quot;&lt;iframe (.*?)/&gt;&quot;).matcher(writer.toString());</span>
<span class="fc bfc" id="L309" title="All 2 branches covered.">            while (tagMatcher.find()) {</span>
<span class="fc" id="L310">                tagMatcher.appendReplacement(result, &quot;&lt;iframe &quot; + tagMatcher.group(1) + &quot;&gt;&lt;/iframe&gt;&quot;);</span>
            }
<span class="fc" id="L312">            tagMatcher.appendTail(result);</span>

<span class="fc" id="L314">            return result.toString();</span>

<span class="nc" id="L316">        } catch (SAXParseException spe) {</span>
<span class="nc" id="L317">            LOGGER.warn(&quot;Error in expandHtmlWidgets(); continuing without expansion (for HL7-uploaded HTML plans)&quot;, spe);</span>
<span class="nc" id="L318">            return actionPlanText;</span>
        }
    }

    private void replaceTextualInput(Element input, Document dom) {
<span class="fc" id="L323">        String value = input.getAttribute(&quot;value&quot;);</span>
<span class="fc" id="L324">        Text replacementNode = dom.createTextNode(unescapeHtml4(value));</span>
<span class="fc" id="L325">        input.getParentNode().replaceChild(replacementNode, input);</span>
<span class="fc" id="L326">    }</span>

    private void replaceCheckableInput(Element input, Document dom) {
<span class="fc" id="L329">        Optional&lt;String&gt; maybeId = Optional.ofNullable(input.getAttribute(&quot;id&quot;));</span>
        // customStyledHtmlFilter.filter() turns &lt;input ...&gt;Label&lt;/input&gt; into &lt;input ... /&gt;Label
<span class="fc" id="L331">        Optional&lt;Text&gt; maybeLabelInInputTag = Optional.ofNullable(input.getNextSibling())</span>
<span class="fc" id="L332">                .filter(n -&gt; n instanceof Text)</span>
<span class="fc" id="L333">                .map(n -&gt; (Text) n);</span>
<span class="fc" id="L334">        Optional&lt;Element&gt; maybeLabelInLabelTag = Optional.empty();</span>
<span class="fc" id="L335">        NodeList childNodes = input.getParentNode().getChildNodes();</span>
<span class="fc bfc" id="L336" title="All 2 branches covered.">        for (int i = 0; i &lt; childNodes.getLength(); ++i) {</span>
<span class="fc" id="L337">            maybeLabelInLabelTag = Optional.of(childNodes.item(i))</span>
<span class="fc" id="L338">                    .filter(n -&gt; n instanceof Element)</span>
<span class="fc" id="L339">                    .map(n -&gt; (Element) n)</span>
<span class="fc" id="L340">                    .filter(e -&gt; e.getTagName().equalsIgnoreCase(&quot;label&quot;))</span>
<span class="pc bpc" id="L341" title="2 of 4 branches missed.">                    .filter(e -&gt; maybeId.isPresent() &amp;&amp; maybeId.get().equalsIgnoreCase(e.getAttribute(&quot;for&quot;)));</span>
<span class="fc bfc" id="L342" title="All 2 branches covered.">            if (maybeLabelInLabelTag.isPresent()) {</span>
<span class="fc" id="L343">                break;</span>
            }
        }
<span class="fc" id="L346">        boolean checked = &quot;checked&quot;.equals(input.getAttribute(&quot;checked&quot;));</span>

<span class="fc" id="L348">        Node parent = input.getParentNode();</span>
<span class="fc bfc" id="L349" title="All 2 branches covered.">        if (checked) {</span>
            // Label within &lt;label for=&quot;id&quot;&gt; tag is the valid HTML so it has precedence
<span class="fc" id="L351">            String content = maybeLabelInLabelTag</span>
<span class="fc" id="L352">                    .map(Element::getTextContent)</span>
<span class="fc" id="L353">                    .orElse(maybeLabelInInputTag.map(Text::getTextContent).orElse(&quot;&quot;));</span>
<span class="fc" id="L354">            Text replacementNode = dom.createTextNode(content);</span>
<span class="fc" id="L355">            parent.replaceChild(replacementNode, input);</span>
<span class="fc" id="L356">        } else {</span>
<span class="fc" id="L357">            parent.removeChild(input);</span>
        }
        // also remove label
<span class="fc" id="L360">        maybeLabelInLabelTag.ifPresent(parent::removeChild);</span>
<span class="fc" id="L361">        maybeLabelInInputTag.ifPresent(parent::removeChild);</span>
<span class="fc" id="L362">    }</span>

    public PlanManager getPlanManager() {
<span class="nc" id="L365">        return planManager;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>