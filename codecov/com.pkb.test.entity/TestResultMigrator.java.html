<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TestResultMigrator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.test.entity</a> &gt; <span class="el_source">TestResultMigrator.java</span></div><h1>TestResultMigrator.java</h1><pre class="source lang-java linenums">package com.pkb.test.entity;

import com.pkb.PrivateIdMigrator;
import com.pkb.annotation.EHRMigratorBase;
import com.pkb.annotation.EHRVersionMigrator;
import com.pkb.app.entity.DTOMapping;
import com.pkb.app.entity.EHRData;
import com.pkb.coding.entity.CodeableConcept;
import com.pkb.coding.entity.Coding;
import com.pkb.util.ValueMappingUtil;

import java.util.OptionalDouble;

import static org.apache.commons.lang3.StringUtils.contains;
import static org.apache.commons.lang3.StringUtils.containsOnly;
import static org.apache.commons.lang3.StringUtils.isNotBlank;
import static org.apache.commons.lang3.StringUtils.isNumeric;
import static org.apache.commons.text.StringEscapeUtils.unescapeXml;

/**
 * To migrate:
 * encrypted &quot;value&quot; oddities -- make Double if decimal value; else be sure stored in &quot;textValue&quot;
 *
 * @author robwhelan
 */
<span class="fc" id="L26">public class TestResultMigrator extends EHRMigratorBase {</span>

<span class="fc" id="L28">    private static final Migrators MIGRATORS = Migrators.of(</span>
<span class="fc" id="L29">            EHRVersionMigrator.of(TestResultMigrator::migrateV1, 1),</span>
<span class="fc" id="L30">            PrivateIdMigrator.migratorFor(TestResultDTO.class, &quot;loincTestId&quot;, &quot;string01&quot;, 2),</span>
<span class="fc" id="L31">            PrivateIdMigrator.migratorFor(TestResultDTO.class, &quot;loincMappingId&quot;, &quot;string02&quot;, 3),</span>
<span class="fc" id="L32">            EHRVersionMigrator.of(TestResultMigrator::migrateFieldsToCodeableConcept, 4));</span>
    private static final String OLD_CODE_FIELD = &quot;testCodeFromSource&quot;;
    private static final String OLD_CODING_SYSTEM_FIELD = &quot;testCodingSystemFromSource&quot;;
    private static final String NEW_CODING_FIELD = &quot;coding&quot;;

    @Override
    public Migrators getMigrators() {
<span class="fc" id="L39">        return MIGRATORS;</span>
    }

    private static void migrateV1(EHRData ehr) {
<span class="nc" id="L43">        migrateSourcePersonId(ehr);</span>

<span class="nc" id="L45">        String comments = unescapeXmlContentInField(ehr, TestResultDTO.COMMENTS);</span>
<span class="nc" id="L46">        String textValue = unescapeXmlContentInField(ehr, TestResultDTO.TEXT_VALUE);</span>

<span class="nc" id="L48">        OptionalDouble maybeValueAsDouble = migrateTypeOfValueFromStringToDouble(ehr);</span>

<span class="nc bnc" id="L50" title="All 4 branches missed.">        if (isMultiLineComment(comments) &amp;&amp; maybeValueAsDouble.isEmpty()) {</span>
<span class="nc" id="L51">            fixReport(ehr, comments, textValue);</span>
        }
<span class="nc" id="L53">    }</span>

    /**
     * encrypted &quot;dataEntererUid&quot; to sourcePersonId
     */
    private static void migrateSourcePersonId(EHRData ehr) {
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (ehr.getSourcePersonId() == null) {</span>
<span class="nc" id="L60">            String dataEntererUid = (String) ehr.getEncryptedField(&quot;dataEntererUid&quot;);</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">            if (isNumeric(dataEntererUid)) {</span>
<span class="nc" id="L62">                ehr.setSourcePersonId(Long.parseLong(dataEntererUid));</span>
            }
        }
<span class="nc" id="L65">    }</span>

    /**
     * XML-unescaping: apply to textValue and comments
     */
    private static String unescapeXmlContentInField(EHRData ehr, String fieldName) {
<span class="nc" id="L71">        String comments = (String) ehr.getEncryptedField(fieldName);</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (isNotBlank(comments)) {</span>
<span class="nc" id="L73">            comments = unescapeXml(comments);</span>
<span class="nc" id="L74">            ehr.setEncryptedField(fieldName, comments);</span>
        }
<span class="nc" id="L76">        return comments;</span>
    }

    private static OptionalDouble migrateTypeOfValueFromStringToDouble(EHRData ehr) {
<span class="nc" id="L80">        OptionalDouble maybeDoubleValue = OptionalDouble.empty();</span>
<span class="nc" id="L81">        Object valueObj = ehr.getEncryptedField(TestResultDTO.VALUE);</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">        if (isDecimalString(valueObj)) {</span>
<span class="nc" id="L83">            double doubleValue = Double.valueOf((String) valueObj);</span>
<span class="nc" id="L84">            ehr.setEncryptedField(TestResultDTO.VALUE, doubleValue);</span>
<span class="nc" id="L85">            maybeDoubleValue = OptionalDouble.of(doubleValue);</span>
        }
<span class="nc" id="L87">        return maybeDoubleValue;</span>
    }

    private static void migrateFieldsToCodeableConcept(EHRData ehr) {
<span class="nc" id="L91">        Object testCodeFromSource = ehr.getEncryptedField(OLD_CODE_FIELD);</span>
<span class="nc" id="L92">        Object testCodingSystemFromSource = ehr.getEncryptedField(OLD_CODING_SYSTEM_FIELD);</span>

<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (testCodeFromSource == null) {</span>
<span class="nc" id="L95">            return;</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">        } else if (!(testCodeFromSource instanceof String)) {</span>
<span class="nc" id="L97">            throw new IllegalStateException(&quot;Encrypted value for testCodeFromSource: expected String, found &quot; + testCodeFromSource.getClass());</span>
<span class="nc bnc" id="L98" title="All 4 branches missed.">        } else if (testCodingSystemFromSource != null &amp;&amp; !(testCodingSystemFromSource instanceof String)) {</span>
<span class="nc" id="L99">            throw new IllegalStateException(&quot;Encrypted value for testCodingSystemFromSource: expected String, found &quot; + testCodingSystemFromSource.getClass());</span>
        }

<span class="nc" id="L102">        CodeableConcept cc = new CodeableConcept.Builder()</span>
<span class="nc" id="L103">                .coding(new Coding.Builder((String) testCodeFromSource, (String) testCodingSystemFromSource).build())</span>
<span class="nc" id="L104">                .build();</span>
<span class="nc" id="L105">        ehr.setEncryptedField(NEW_CODING_FIELD, toMap(cc));</span>
<span class="nc" id="L106">    }</span>

    private static Object toMap(CodeableConcept cc) {
<span class="nc" id="L109">        DTOMapping&lt;TestResultDTO&gt; testResultMapping = DTOMapping.get(TestResultDTO.class);</span>
<span class="nc" id="L110">        DTOMapping&lt;?&gt; dtoMapping = testResultMapping.getNestedDtoMapping(TestResultDTO.TEST_RESULT_CODING);</span>
<span class="nc" id="L111">        return ValueMappingUtil.prepValueForEHRData(cc, dtoMapping);</span>
    }

    private static boolean isMultiLineComment(String comments) {
<span class="nc" id="L115">        return contains(comments, '\n');</span>
    }

    /**
     * Fix text reports that were saved with one line in &quot;textValue&quot; and others in &quot;comments&quot;. Prev notes:
     * temporary: previously text reports were saved with the first line in text value, and others in comments
     * so if we have multiple comment lines and no numeric value, shift that line into comments here
     */
    private static void fixReport(EHRData ehr, String comments, String textValue) {
<span class="nc" id="L124">        ehr.setEncryptedField(TestResultDTO.TEXT_VALUE, &quot;&quot;);</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">        ehr.setEncryptedField(TestResultDTO.COMMENTS, textValue == null ? comments : textValue + &quot;\n&quot; + comments);</span>
<span class="nc" id="L126">    }</span>

    private static boolean isDecimalString(Object value) {
<span class="nc bnc" id="L129" title="All 4 branches missed.">        return value instanceof String &amp;&amp; isDecimal(String.class.cast(value));</span>
    }

    private static boolean isDecimal(String valueAsString) {
<span class="nc bnc" id="L133" title="All 4 branches missed.">        return isNotBlank(valueAsString) &amp;&amp; containsOnly(valueAsString, &quot;0123456789.-E&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>