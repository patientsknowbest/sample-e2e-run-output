<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MeasurementMigrator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.test.entity</a> &gt; <span class="el_source">MeasurementMigrator.java</span></div><h1>MeasurementMigrator.java</h1><pre class="source lang-java linenums">//---------------------------------------------------------------------------
//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: MesurementMigrator.java 05-Mar-2015 1:25:22 am pravina$
//
//---------------------------------------------------------------------------

package com.pkb.test.entity;

import com.pkb.PrivateIdMigrator;
import com.pkb.annotation.EHRMigratorBase;
import com.pkb.annotation.EHRVersionMigrator;
import com.pkb.app.entity.EHRData;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * version 1 : migrate the dataEntererUid to source person id
 * version 2 : migrate the measurements which were stored before conversion like height in ft, inches not converted into cm
 *
 * @author pravina
 */
<span class="fc" id="L25">public class MeasurementMigrator extends EHRMigratorBase {</span>

<span class="fc" id="L27">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

<span class="fc" id="L29">    private static final Migrators MIGRATORS = Migrators.of(</span>
<span class="fc" id="L30">            EHRVersionMigrator.of(MeasurementMigrator::migrateV1, 1),</span>
<span class="fc" id="L31">            EHRVersionMigrator.of(MeasurementMigrator::migrateV2, 2),</span>
<span class="fc" id="L32">            PrivateIdMigrator.migratorFor(MeasurementDTO.class, &quot;measurementTypeId&quot;, &quot;string01&quot;,3));</span>

    @Override
    public Migrators getMigrators() {
<span class="fc" id="L36">        return MIGRATORS;</span>
    }

    private static void migrateV1(EHRData ehr) {
        // short-circuit if sourcePersonId is already set
<span class="nc bnc" id="L41" title="All 2 branches missed.">        if (ehr.getSourcePersonId() != null) {</span>
<span class="nc" id="L42">            return;</span>
        }

<span class="nc" id="L45">        Object obj = ehr.getEncryptedField(&quot;dataEntererUid&quot;);</span>
        // migrate only if it is a String
<span class="nc bnc" id="L47" title="All 2 branches missed.">        if (obj instanceof String) {</span>
<span class="nc" id="L48">            String uid = (String) obj;</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">            if (StringUtils.isNotBlank(uid)) {</span>
<span class="nc" id="L50">                ehr.setSourcePersonId(Long.parseLong(uid));</span>
            }
        }
<span class="nc" id="L53">    }</span>

    private static void migrateV2(EHRData ehr) {
<span class="nc" id="L56">        Object obj = ehr.getEncryptedField(&quot;measurementTypeId&quot;);</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">        if (obj instanceof String) {</span>
<span class="nc" id="L58">            Long measurementTypeId = Long.valueOf((String) obj);</span>
            // first do any conversion needed
<span class="nc" id="L60">            PredefinedMeasurementType predefinedMeasurementType = PredefinedMeasurementType.getById(measurementTypeId);</span>

            // if the type has no parent type, it's fine; short-circuit
<span class="nc bnc" id="L63" title="All 2 branches missed.">            if (predefinedMeasurementType.getType().parentType().isEmpty()) {</span>
<span class="nc" id="L64">                return;</span>
            }

<span class="nc" id="L67">            MeasurementDTO measurementDTO = new MeasurementDTO();</span>
<span class="nc" id="L68">            Object value = ehr.getEncryptedField(&quot;value&quot;);</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">            if (value != null) {</span>
<span class="nc" id="L70">                measurementDTO.setValue((Double) value);</span>
            }
<span class="nc" id="L72">            Object value2 = ehr.getEncryptedField(&quot;value2&quot;);</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">            if (value2 != null) {</span>
<span class="nc" id="L74">                measurementDTO.setValue2((Double) value2);</span>
            }
<span class="nc" id="L76">            measurementDTO.setMeasurementType(PredefinedMeasurementType.getById(measurementTypeId));</span>
            // This may change the measurement type
<span class="nc" id="L78">            predefinedMeasurementType.getType().convertFromInput(measurementDTO);</span>

            // now grab type again (may have changed)
<span class="nc" id="L81">            Long newMeasurementTypeId = measurementDTO.getMeasurementType().id().asInternalId().getOrElseThrow(() -&gt; new IllegalStateException(&quot;Attempted migration of DTO with non-internal measurement type&quot;));</span>
<span class="nc bnc" id="L82" title="All 2 branches missed.">            if (!measurementTypeId.equals(newMeasurementTypeId)) {</span>
                // save updated type id and (post-conversion) values
<span class="nc" id="L84">                ehr.setEncryptedField(&quot;measurementTypeId&quot;, newMeasurementTypeId.toString());</span>
<span class="nc" id="L85">                ehr.setString01(null); // pseudonym; leave null</span>
<span class="nc" id="L86">                ehr.setEncryptedField(&quot;value&quot;, measurementDTO.getValue());</span>
<span class="nc" id="L87">                ehr.setEncryptedField(&quot;value2&quot;, measurementDTO.getValue2());</span>
            }
<span class="nc bnc" id="L89" title="All 2 branches missed.">        } else if (obj != null) {</span>
<span class="nc" id="L90">            LOGGER.warn(&quot;encrypted field NOT string: {}/{}&quot;, obj.getClass(), obj);</span>
        } else {
<span class="nc" id="L92">            LOGGER.warn(&quot;encrypted measurementTypeId was null for id {}&quot;, ehr.getId());</span>
        }
<span class="nc" id="L94">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>