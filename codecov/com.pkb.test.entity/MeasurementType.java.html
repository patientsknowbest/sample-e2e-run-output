<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MeasurementType.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.test.entity</a> &gt; <span class="el_source">MeasurementType.java</span></div><h1>MeasurementType.java</h1><pre class="source lang-java linenums">package com.pkb.test.entity;

import com.fasterxml.jackson.databind.annotation.JsonDeserialize;
import com.fasterxml.jackson.databind.annotation.JsonSerialize;
import io.vavr.Tuple;
import io.vavr.Tuple2;
import io.vavr.control.Option;
import org.apache.commons.lang3.math.NumberUtils;
import org.immutables.value.Value;
import org.jetbrains.annotations.Nullable;

import java.io.Serializable;
import java.math.BigDecimal;
import java.math.MathContext;
import java.text.DecimalFormat;
import java.util.function.Supplier;

import static com.pkb.test.entity.MeasurementTypeValidation.BLOOD_PRESSURE;
import static com.pkb.test.entity.MeasurementTypeValidation.FOOT_AND_INCHES;
import static com.pkb.test.entity.MeasurementTypeValidation.HEIGHT;
import static com.pkb.test.entity.MeasurementTypeValidation.HOURS_AND_MINUTES;
import static com.pkb.test.entity.MeasurementTypeValidation.POUNDS_AND_OUNCES;
import static com.pkb.test.entity.MeasurementTypeValidation.STONE_AND_POUNDS;
import static com.pkb.test.entity.MeasurementValidator.convertHeightToCm;
import static com.pkb.test.entity.MeasurementValidator.validateBloodPressure;
import static com.pkb.test.entity.MeasurementValidator.validateDuration;
import static com.pkb.test.entity.MeasurementValidator.validateLengthFeetInches;
import static com.pkb.test.entity.MeasurementValidator.validateWeightPoundsOunces;
import static com.pkb.test.entity.MeasurementValidator.validateWeightStonePounds;
import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.Match;
import static io.vavr.Patterns.$None;
import static io.vavr.Patterns.$Some;
import static org.apache.commons.lang3.StringUtils.isNotBlank;

@Value.Immutable
@Value.Style(strictBuilder = true, stagedBuilder = true)
@JsonSerialize(as = ImmutableMeasurementType.class)
@JsonDeserialize(as = ImmutableMeasurementType.class)
public interface MeasurementType extends Serializable {


    MeasurementTypeId id();

    String displayName();

    /**
     * used for API references. Blood pressure =&gt; bloodPressure
     */
    Option&lt;String&gt; apiRef();

    MeasurementCategory category();

    String unit();

    Option&lt;String&gt; formattedUnit();

    Option&lt;String&gt; code();

    Option&lt;String&gt; codeSystem();

    Option&lt;String&gt; codeSystemName();

    // for measurements like BP with two data points -- all codes use the same coding system
    Option&lt;String&gt; code2();

    Option&lt;String&gt; unit2();

    Option&lt;String&gt; formattedUnit2();

    /* if this measurement contains 2 data points, there may be a code referring the whole thing (e.g., standing BP) */
    Option&lt;String&gt; codeOfWhole();

    boolean derived(); // Derived measurements, such as BMI, cannot be directly input

    Option&lt;PredefinedMeasurementType&gt; parentType();

    Option&lt;Double&gt; displayAsDividedBy();

    boolean isDisplayedThreeSigFigures();

    @Value.Default
    default boolean isNumeric() {
<span class="fc" id="L85">        return true;</span>
    }

    default String convertForDisplay(Double value) {
<span class="fc" id="L89">        var defaultFormat = new DecimalFormat(&quot;###0.#&quot;);</span>
<span class="fc" id="L90">        Double v = displayAsDividedBy().map(div -&gt; value / div).getOrElse(value);</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">        if (isDisplayedThreeSigFigures()) {</span>
<span class="pc bpc" id="L92" title="2 of 4 branches missed.">            if (v.isInfinite() || v.isNaN()) {</span>
<span class="nc" id="L93">                return defaultFormat.format(v);</span>
            } else {
<span class="fc" id="L95">                BigDecimal bd = new BigDecimal(v, new MathContext(3));</span>
<span class="fc" id="L96">                return defaultFormat.format(bd);</span>
            }
        } else {
<span class="fc" id="L99">            return defaultFormat.format(v);</span>
        }
    }

    Option&lt;MeasurementTypeValidation&gt; validationKind();

    default String getValidationError(String value, String value2) {
<span class="fc" id="L106">        return Match(validationKind()).of(</span>
<span class="fc" id="L107">                Case($None(), () -&gt; {</span>
<span class="fc bfc" id="L108" title="All 2 branches covered.">                    if (isNotBlank(value)) {</span>
                        try {
<span class="fc" id="L110">                            Double.parseDouble(value);</span>
<span class="fc" id="L111">                        } catch (NumberFormatException ignored) {</span>
<span class="fc" id="L112">                            return &quot;.err.value_not_number&quot;;</span>
<span class="fc" id="L113">                        }</span>
                    }
<span class="fc" id="L115">                    return &quot;&quot;;</span>
                }),
<span class="fc" id="L117">                Case($Some($(HOURS_AND_MINUTES)), () -&gt; validateDuration(value, value2)),</span>
<span class="fc" id="L118">                Case($Some($(POUNDS_AND_OUNCES)), () -&gt; validateWeightPoundsOunces(value, value2)),</span>
<span class="fc" id="L119">                Case($Some($(STONE_AND_POUNDS)), () -&gt; validateWeightStonePounds(value, value2)),</span>
<span class="fc" id="L120">                Case($Some($(HEIGHT)), () -&gt; {</span>
<span class="fc bfc" id="L121" title="All 2 branches covered.">                    if (isNotBlank(value)) {</span>
<span class="fc" id="L122">                        Double number = null;</span>
                        try {
<span class="fc" id="L124">                            number = Double.parseDouble(value);</span>
<span class="fc" id="L125">                        } catch (NumberFormatException ignored) {</span>
<span class="fc" id="L126">                            return &quot;.err.value_not_number&quot;;</span>
<span class="fc" id="L127">                        }</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">                        if (number &lt;= 0) {</span>
<span class="fc" id="L129">                            return &quot;.err.height_0_or_less&quot;;</span>
                        }
                    }
<span class="fc" id="L132">                    return &quot;&quot;;</span>
                }),
<span class="fc" id="L134">                Case($Some($(FOOT_AND_INCHES)), () -&gt; {</span>
<span class="fc" id="L135">                    String error = validateLengthFeetInches(value, value2);</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">                    if (isNotBlank(error)) {</span>
<span class="fc" id="L137">                        return error;</span>
<span class="fc bfc" id="L138" title="All 4 branches covered.">                    } else if (isNotBlank(value) || isNotBlank(value2)) {</span>
<span class="fc" id="L139">                        Double cm = convertHeightToCm(value, value2);</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">                        if (cm &lt;= 0) {</span>
<span class="fc" id="L141">                            return &quot;.err.height_0_or_less&quot;;</span>
                        }
                    }
<span class="fc" id="L144">                    return &quot;&quot;;</span>
                }),
<span class="fc" id="L146">                Case($Some($(BLOOD_PRESSURE)), () -&gt; validateBloodPressure(value, value2))</span>
        );
    }

    Option&lt;Long&gt; singleInputType();

    Option&lt;MeasurementTypeCustomFormatting&gt; customFormatting();

    // format value for display on the measurement screens (use convertForDisplay() to affect graph too)
    default String format(Double value) {
<span class="fc" id="L156">        Supplier&lt;String&gt; def = () -&gt; {</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">            if (value == null) {</span>
<span class="fc" id="L158">                return &quot;&quot;;</span>
            }
<span class="fc" id="L160">            String displayValue = convertForDisplay(value);</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">            return NumberUtils.isCreatable(displayValue) ? new DecimalFormat(&quot;#,##0.#&quot;).format(Double.valueOf(displayValue)) : displayValue;</span>
        };

<span class="fc" id="L164">        return Match(customFormatting()).of(</span>
<span class="fc" id="L165">                Case($None(), def),</span>
<span class="fc" id="L166">                Case($Some($(MeasurementTypeCustomFormatting.SECONDS_TO_HOURS_AND_MINUTES)), () -&gt; String.valueOf((int) Math.floor(value / 60 / 60)))</span>
        );
    }

    default String format2(Double value, Double value2) {
<span class="fc" id="L171">        return Match(customFormatting()).of(</span>
<span class="fc" id="L172">                Case($None(), () -&gt; format(value2)),</span>
<span class="fc" id="L173">                Case($Some($(MeasurementTypeCustomFormatting.SECONDS_TO_HOURS_AND_MINUTES)), () -&gt; String.valueOf(Math.round((value % 3600) / 60)))</span>
        );
    }

    Option&lt;Tuple2&lt;MeasurementTypeLinearConversion, PredefinedMeasurementType&gt;&gt; normalization();

    default void convertFromInput(MeasurementDTO m) {
<span class="fc" id="L180">        normalization().peek(n -&gt; {</span>
<span class="fc" id="L181">            PredefinedMeasurementType target = n._2();</span>
<span class="fc" id="L182">            MeasurementTypeLinearConversion conversion = n._1();</span>

<span class="fc" id="L184">            m.setMeasurementType(target);</span>
<span class="fc" id="L185">            Tuple2&lt;Double, Double&gt; converted = conversion.convert(Tuple.of(m.getValue(), m.getValue2()));</span>
<span class="fc" id="L186">            m.setValue(converted._1());</span>
<span class="fc" id="L187">            m.setValue2(converted._2());</span>
<span class="fc" id="L188">        });</span>
<span class="fc" id="L189">    }</span>

    default MeasurementDisplayCategory getDisplayCategory() {
<span class="fc bfc" id="L192" title="All 5 branches covered.">        switch (category()) {</span>
            case NUTRITION:
<span class="fc" id="L194">                return MeasurementDisplayCategory.NUTRITION;</span>
            case FITNESS:
<span class="fc" id="L196">                return MeasurementDisplayCategory.FITNESS;</span>
            case ROUTINE:
<span class="fc" id="L198">                return MeasurementDisplayCategory.FITNESS;</span>
            case SLEEP:
<span class="fc" id="L200">                return MeasurementDisplayCategory.SLEEP;</span>
            default:
<span class="fc" id="L202">                return MeasurementDisplayCategory.GENERAL;</span>
        }
    }

    default boolean is(PredefinedMeasurementType target) {
<span class="fc" id="L207">        return target.id().equals(this.id());</span>
    }

    default Option&lt;PredefinedMeasurementType&gt; getAsPredefinedMeasurementType() {
<span class="fc" id="L211">        return this.id().asInternalId().flatMap(iId -&gt; Option.of(PredefinedMeasurementType.getById(iId)));</span>
    }

    default boolean isMultiValueMeasurement() {
<span class="fc" id="L215">        return getAsPredefinedMeasurementType().map(PredefinedMeasurementType::isMultiValueMeasurement).getOrElse(false);</span>
    }

    default void writeToMeasurement(MeasurementDTO m, String value, @Nullable String value2) {
<span class="fc" id="L219">        m.setCompositeMeasurementTypeId(this.id());</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">        if (isNumeric()) {</span>
<span class="fc" id="L221">            m.setValue(Double.parseDouble(value));</span>
        } else {
<span class="fc" id="L223">            m.setValueNonNumeric(value);</span>
        }
<span class="fc bfc" id="L225" title="All 2 branches covered.">        if (value2 != null) {</span>
<span class="fc" id="L226">            m.setValue2(Double.parseDouble(value2));</span>
        }
<span class="fc" id="L228">    }</span>

    default boolean isBloodPressure() {
<span class="fc" id="L231">        return getAsPredefinedMeasurementType().map(PredefinedMeasurementType::isBloodPressure).getOrElse(false);</span>
    }

    default String getFormattedUnitOrUnitAsDefault() {
<span class="fc" id="L235">        return formattedUnit().getOrElse(unit());</span>
    }

    @Nullable
    default String getFormattedUnit2OrUnit2AsDefault() {
<span class="fc" id="L240">        return formattedUnit2().getOrElse(unit2().getOrNull());</span>
    }

    Option&lt;MeasurementTypeCompoundParentInfo&gt; compoundParent();
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>