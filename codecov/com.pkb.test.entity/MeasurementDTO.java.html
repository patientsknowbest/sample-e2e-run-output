<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MeasurementDTO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.test.entity</a> &gt; <span class="el_source">MeasurementDTO.java</span></div><h1>MeasurementDTO.java</h1><pre class="source lang-java linenums">package com.pkb.test.entity;

import com.google.common.base.MoreObjects;
import com.pkb.annotation.EHRField;
import com.pkb.annotation.EHRField.QueryField;
import com.pkb.annotation.EHRMigration;
import com.pkb.app.dto.DTOBaseFields;
import com.pkb.app.entity.SourceDetails;
import com.pkb.app.interfaces.EncryptedDataPoint;
import com.pkb.app.interfaces.IBaseDTO;
import com.pkb.coding.entity.CodeableConcept;
import com.pkb.dto.I18nTextDTO;
import com.pkb.entities.enums.MenuDataType;
import io.vavr.control.Option;
import org.apache.commons.lang3.StringUtils;

import java.io.Serializable;
import java.time.Instant;
import java.util.EnumSet;
import java.util.List;
import java.util.Set;

import static com.pkb.PKBConstants.CODE_SYSTEM_SNOMED_CT_ID;
import static com.pkb.PKBConstants.CODE_SYSTEM_SNOMED_CT_NAME;
import static com.pkb.entities.enums.Route.CORE_DEVICES;
import static com.pkb.test.entity.MeasurementCategory.ROUTINE;
import static com.pkb.test.entity.PredefinedMeasurementType.CALORIES_BURNED_FITNESS;
import static com.pkb.test.entity.PredefinedMeasurementType.CIGARETTES_PER_DAY;
import static com.pkb.test.entity.PredefinedMeasurementType.DISTANCE_FITNESS;
import static com.pkb.test.entity.PredefinedMeasurementType.DISTANCE_FITNESS_KM;
import static com.pkb.test.entity.PredefinedMeasurementType.DISTANCE_FITNESS_MILES;
import static com.pkb.test.entity.PredefinedMeasurementType.DURATION;
import static com.pkb.test.entity.PredefinedMeasurementType.DURATION_MIN;
import static io.vavr.API.None;
import static org.apache.commons.collections.SetUtils.unmodifiableSet;

/**
 * A measurement - one or two data points (blood pressure being the exception with more than one...).
 * No range, etc. provided; stored flat (value1, value2) for now.
 */
@EHRMigration(migratorClass = MeasurementMigrator.class)
public class MeasurementDTO implements IBaseDTO, EncryptedDataPoint, Serializable {

    private static final long serialVersionUID = 8322647369112978997L;
<span class="fc" id="L45">    private static final Set&lt;PredefinedMeasurementType&gt; CUMULATIVE_FITNESS_MEASUREMENTS = unmodifiableSet(EnumSet.of(DISTANCE_FITNESS_MILES,</span>
            DISTANCE_FITNESS_KM,
            DISTANCE_FITNESS,
            DURATION_MIN,
            DURATION,
            CALORIES_BURNED_FITNESS,
            CIGARETTES_PER_DAY));

<span class="fc" id="L53">    public static final MenuDataType MS_PATH = MenuDataType.measurement;</span>

    // field names for menu data and trim source

    public static final String MEASUREMENT_TYPE_ID = &quot;measurementTypeId&quot;;

    public static final String CODING_MATCH_ID = &quot;codingMatchId&quot;;

    public static final String UNIT_FIELD = &quot;unit&quot;;

    public static final String MEASUREMENT_TYPE = &quot;measurementType&quot;;

    public static final String MEASURE_DATE = &quot;measureDate&quot;;

    public static final String VALUE = &quot;value&quot;;

    public static final String VALUE2 = &quot;value2&quot;;

    public static final String SOURCE = &quot;source&quot;; // obsolete

    public static final String UPLOADED_DATA_ID = &quot;uploadedDataId&quot;;

    public static final String LAB_ORDER_ID = &quot;labOrderId&quot;;

    @EHRField(queryField = QueryField.id)
    private Long id; // this is a menudata id

    @EHRField(queryField = QueryField.long01)
    private Long measurementTypeId;

    @EHRField(queryField = QueryField.date01)
    private Instant measureDate;

    @EHRField
    private Double value;

    @EHRField
    private String valueNonNumeric;

    @EHRField
    private Double value2;

    @EHRField(valueDtoType = EHRField.ValueDTOType.NESTED)
    private CodeableConcept codeableConcept;

    @EHRField(queryField = QueryField.long03)
    private Long codingMatchId;

    @EHRField(queryField = QueryField.accountId)
    private Long patientAccountId;

    @EHRField(queryField = QueryField.string02)
    private String unit;

    @EHRField
    private Long codingReceivedId;

    /**
     * The term &quot;lab order&quot; is a little unintuitive, but intentionally matches TestResultDTO.labOrderId to be clear that
     * these both track the same semantic concept, and are both populated from the same field in an HL7 ORU R01 message.
     * &lt;p&gt;
     * Multiple lab results and measurements sent via HL7 are grouped together under this single externally-provided
     * identifier.
     */
    @EHRField(queryField = QueryField.string03)
    private String labOrderId;

    private Long uploadedDataId;

    private String measurementCode;// not saved in DB ; for use by internal layers

    private SourceDetails source;

<span class="fc" id="L126">    private final DTOBaseFields baseFields = new DTOBaseFields();</span>

    private List&lt;I18nTextDTO&gt; explanatoryText;

    private List&lt;I18nTextDTO&gt; warnings;

    /**
     * DELIBERATELY PROTECTED DO NOT CHANGE! Use the available constructors!
     * &lt;p&gt;
     * Would have even less visibility but JPA spec &amp; Hibernate requires a no arg const. which is public or protected.
     * Other than those, nothing should be able to construct without parameters, as changelog wouldn't be filled correctly etc.
     */
<span class="fc" id="L138">    protected MeasurementDTO() {</span>
<span class="fc" id="L139">        this.source = new SourceDetails();</span>
<span class="fc" id="L140">    }</span>

<span class="fc" id="L142">    public MeasurementDTO(SourceDetails source) {</span>
<span class="fc" id="L143">        this.source = source;</span>
<span class="fc" id="L144">    }</span>

    // debugging util
    @Override
    public String toString() {
<span class="fc" id="L149">        return MoreObjects.toStringHelper(MeasurementDTO.class)</span>
<span class="fc" id="L150">                .add(&quot;id&quot;, id)</span>
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">                .add(&quot;measurementType&quot;, measurementTypeId == null ? &quot;NONE&quot; : measurementTypeId)</span>
<span class="fc" id="L152">                .add(&quot;codingReceivedId&quot;, codingReceivedId)</span>
<span class="fc" id="L153">                .toString();</span>
    }

    public String getValueFormatted() {
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">        if (valueNonNumeric != null) {</span>
<span class="nc" id="L158">            return valueNonNumeric;</span>
        } else {
<span class="fc" id="L160">            return getMeasurementType().format(value);</span>
        }
    }

    public String getValue2Formatted() {
<span class="fc" id="L165">        return getMeasurementType().format2(value, value2);</span>
    }

    public boolean isUpdatedBy(MeasurementDTO measurement) {
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">        return measureDate.equals(measurement.getMeasureDate())</span>
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">                &amp;&amp; getMeasurementType().id().equals(measurement.getMeasurementType().id())</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">                &amp;&amp; source.getRoute() == measurement.getSource().getRoute()</span>
<span class="pc bpc" id="L172" title="1 of 2 branches missed.">                &amp;&amp; id &lt; measurement.getId();</span>
    }

    public boolean isDailyCumulativeDeviceData() {
<span class="fc bfc" id="L176" title="All 2 branches covered.">        return CORE_DEVICES == getSource().getRoute()</span>
<span class="fc bfc" id="L177" title="All 2 branches covered.">                &amp;&amp; (ROUTINE == getMeasurementType().category()</span>
<span class="fc" id="L178">                || getMeasurementType().getAsPredefinedMeasurementType()</span>
<span class="fc bfc" id="L179" title="All 2 branches covered.">                .map(CUMULATIVE_FITNESS_MEASUREMENTS::contains).getOrElse(false));</span>
    }

    /**
     * Multi-value measurements (BP) must have both values set unless it's Blood pressure.
     * In case of Blood pressure it's enough to have at least one value.
     */
    public boolean isValidMultiValueMeasurement() {
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">        if (!getMeasurementType().isMultiValueMeasurement()) {</span>
<span class="nc" id="L188">            return false;</span>
        }

<span class="pc bpc" id="L191" title="2 of 6 branches missed.">        if (getMeasurementType().isBloodPressure() &amp;&amp; (getValue() != null || getValue2() != null)) {</span>
<span class="fc" id="L192">            return true;</span>
        }

<span class="nc bnc" id="L195" title="All 4 branches missed.">        return getValue() != null &amp;&amp; getValue2() != null;</span>
    }

    public boolean hasValue() {
<span class="pc bpc" id="L199" title="1 of 6 branches missed.">        return value != null || value2 != null || StringUtils.isNotBlank(valueNonNumeric);</span>
    }

    // getters/setters

    @Override
    public MenuDataType getDataType() {
<span class="fc" id="L206">        return MenuDataType.measurement;</span>
    }

    @Override
    public Long getPatientAccountId() {
<span class="fc" id="L211">        return patientAccountId;</span>
    }

    @Override
    public Long getId() {
<span class="fc" id="L216">        return id;</span>
    }

    @Override
    public void setId(Long id) {
<span class="fc" id="L221">        this.id = id;</span>
<span class="fc" id="L222">    }</span>

    public void setMeasurementType(PredefinedMeasurementType type) {
<span class="fc" id="L225">        setMeasurementTypeId(type.id().asInternalId().getOrNull());</span>
<span class="fc" id="L226">    }</span>

    public void setCompositeMeasurementTypeId(MeasurementTypeId id) {
<span class="fc" id="L229">        id.peek(predefined -&gt; setMeasurementType(PredefinedMeasurementType.getById(predefined)),</span>
                codingMatchAndUnit -&gt; {
<span class="nc" id="L231">                    setCodingMatchId(codingMatchAndUnit._1());</span>
<span class="nc" id="L232">                    setUnit(codingMatchAndUnit._2());</span>
<span class="nc" id="L233">                });</span>
<span class="fc" id="L234">    }</span>

    // here for migrators
    public void setMeasurementTypeId(Long measurementTypeId) {
<span class="fc" id="L238">        this.measurementTypeId = measurementTypeId;</span>
<span class="fc" id="L239">    }</span>

    // here for migrators
    public Long getMeasurementTypeId() {
<span class="fc" id="L243">        return this.measurementTypeId;</span>
    }

    public Instant getMeasureDate() {
<span class="fc" id="L247">        return measureDate;</span>
    }

    public void setMeasureDate(Instant measureDate) {
<span class="fc" id="L251">        this.measureDate = measureDate;</span>
<span class="fc" id="L252">    }</span>

    public Double getValue() {
<span class="fc" id="L255">        return value;</span>
    }

    public void setValue(Double value) {
<span class="fc" id="L259">        this.value = value;</span>
<span class="fc" id="L260">    }</span>

    public String getValueNonNumeric() {
<span class="fc" id="L263">        return valueNonNumeric;</span>
    }

    public void setValueNonNumeric(String valueNonNumeric) {
<span class="fc" id="L267">        this.valueNonNumeric = valueNonNumeric;</span>
<span class="fc" id="L268">    }</span>

    public Double getValue2() {
<span class="fc" id="L271">        return value2;</span>
    }

    public void setValue2(Double value2) {
<span class="fc" id="L275">        this.value2 = value2;</span>
<span class="fc" id="L276">    }</span>

    public Long getUploadedDataId() {
<span class="nc" id="L279">        return uploadedDataId;</span>
    }

    public void setUploadedDataId(Long uploadedDataId) {
<span class="fc" id="L283">        this.uploadedDataId = uploadedDataId;</span>
<span class="fc" id="L284">    }</span>

    @Override
    public DTOBaseFields getBaseFields() {
<span class="fc" id="L288">        return baseFields;</span>
    }

    @Override
    public SourceDetails getSource() {
<span class="fc" id="L293">        return source;</span>
    }

    public String getMeasurementCode() {
<span class="nc" id="L297">        return measurementCode;</span>
    }

    public void setMeasurementCode(String measurementCode) {
<span class="fc" id="L301">        this.measurementCode = measurementCode;</span>
<span class="fc" id="L302">    }</span>

    public List&lt;I18nTextDTO&gt; getExplanatoryText() {
<span class="nc" id="L305">        return explanatoryText;</span>
    }

    public void setExplanatoryText(List&lt;I18nTextDTO&gt; explanatoryText) {
<span class="nc" id="L309">        this.explanatoryText = explanatoryText;</span>
<span class="nc" id="L310">    }</span>

    public List&lt;I18nTextDTO&gt; getWarnings() {
<span class="fc" id="L313">        return warnings;</span>
    }

    public void setWarnings(List&lt;I18nTextDTO&gt; warnings) {
<span class="fc" id="L317">        this.warnings = warnings;</span>
<span class="fc" id="L318">    }</span>

    public Option&lt;MeasurementTypeId&gt; toMeasurementTypeId() {
<span class="nc" id="L321">        return MeasurementTypeId.of(measurementTypeId, codingMatchId, unit);</span>
    }

    public MeasurementType getMeasurementType() {
<span class="fc" id="L325">        return Option.of(measurementTypeId)</span>
<span class="fc" id="L326">                .map(typeId -&gt; PredefinedMeasurementType.getById(typeId))</span>
<span class="fc" id="L327">                .map(PredefinedMeasurementType::getType)</span>
<span class="fc" id="L328">                .getOrElse(() -&gt; {</span>
<span class="pc bpc" id="L329" title="2 of 6 branches missed.">                    if (codingReceivedId != null &amp;&amp; codeableConcept != null &amp;&amp; codingMatchId != null) {</span>
<span class="fc" id="L330">                        var notNullUnit = Option.of(unit).getOrElse(&quot;&quot;);</span>
<span class="fc" id="L331">                        var snomed = codeableConcept.getSnomed();</span>

<span class="fc" id="L333">                        return ImmutableMeasurementType.builder()</span>
<span class="fc" id="L334">                                .id(MeasurementTypeId.ofCodingMatchAndUnit(codingMatchId, notNullUnit))</span>
<span class="fc" id="L335">                                .displayName(codeableConcept.getDisplayText())</span>
<span class="fc" id="L336">                                .apiRef(None())</span>
<span class="fc" id="L337">                                .category(MeasurementCategory.OTHER)</span>
<span class="fc" id="L338">                                .unit(notNullUnit)</span>
<span class="fc" id="L339">                                .formattedUnit(None())</span>
<span class="fc" id="L340">                                .code(snomed)</span>
<span class="fc" id="L341">                                .codeSystem(snomed.map(ignored -&gt; CODE_SYSTEM_SNOMED_CT_ID))</span>
<span class="fc" id="L342">                                .codeSystemName(snomed.map(ignored -&gt; CODE_SYSTEM_SNOMED_CT_NAME))</span>
<span class="fc" id="L343">                                .code2(None())</span>
<span class="fc" id="L344">                                .unit2(None())</span>
<span class="fc" id="L345">                                .formattedUnit2(None())</span>
<span class="fc" id="L346">                                .codeOfWhole(None())</span>
<span class="fc" id="L347">                                .derived(false)</span>
<span class="fc" id="L348">                                .parentType(None())</span>
<span class="fc" id="L349">                                .displayAsDividedBy(None())</span>
<span class="fc" id="L350">                                .isDisplayedThreeSigFigures(false)</span>
<span class="fc" id="L351">                                .validationKind(None())</span>
<span class="fc" id="L352">                                .singleInputType(None())</span>
<span class="fc" id="L353">                                .customFormatting(None())</span>
<span class="fc" id="L354">                                .normalization(None())</span>
<span class="fc" id="L355">                                .compoundParent(None())</span>
<span class="fc" id="L356">                                .build();</span>
                    } else {
<span class="fc" id="L358">                        return null;</span>
                    }
                });
    }

    public void setSource(SourceDetails source) {
<span class="fc" id="L364">        this.source = source;</span>
<span class="fc" id="L365">    }</span>

    public Long getCodingReceivedId() {
<span class="fc" id="L368">        return codingReceivedId;</span>
    }

    public void setCodingReceivedId(Long codingReceivedId) {
<span class="fc" id="L372">        this.codingReceivedId = codingReceivedId;</span>
<span class="fc" id="L373">    }</span>

    public String getUnit() {
<span class="fc" id="L376">        return unit;</span>
    }

    public void setUnit(String unit) {
<span class="fc" id="L380">        this.unit = unit;</span>
<span class="fc" id="L381">    }</span>

    public CodeableConcept getCodeableConcept() {
<span class="fc" id="L384">        return codeableConcept;</span>
    }

    public void setCodeableConcept(CodeableConcept codeableConcept) {
<span class="fc" id="L388">        this.codeableConcept = codeableConcept;</span>
<span class="fc" id="L389">    }</span>

    public void setPatientAccountId(Long patientAccountId) {
<span class="fc" id="L392">        this.patientAccountId = patientAccountId;</span>
<span class="fc" id="L393">    }</span>

    public Long getCodingMatchId() {
<span class="fc" id="L396">        return codingMatchId;</span>
    }

    public void setCodingMatchId(Long codingMatchId) {
<span class="fc" id="L400">        this.codingMatchId = codingMatchId;</span>
<span class="fc" id="L401">    }</span>

    public String getLabOrderId() {
<span class="fc" id="L404">        return labOrderId;</span>
    }

    public void setLabOrderId(String labOrderId) {
<span class="fc" id="L408">        this.labOrderId = labOrderId;</span>
<span class="fc" id="L409">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>