<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CreateSSOAuthKeysAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.sso.emis</a> &gt; <span class="el_source">CreateSSOAuthKeysAction.java</span></div><h1>CreateSSOAuthKeysAction.java</h1><pre class="source lang-java linenums">package com.pkb.action.sso.emis;

import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.PersonAuthInfo;
import com.pkb.datamodel.Email;
import com.pkb.domain.SSOService;
import com.pkb.entities.enums.SSOType;
import com.pkb.exception.PKBException;
import com.pkb.security.LoginAttemptAuditor;
import com.pkb.security.TooManyLoginAttemptsException;
import com.pkb.service.sso.impl.emis.EMISSSOAuthManager;
import com.pkb.service.user.impl.UserManager;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import static com.pkb.entities.enums.LoginAttemptLogResult.FAIL_BAD_PASSWORD;

/**
 * pre-condition : EMIS user (professional) has to generate SSO creds via PKB webapp and configure EMIS client with these creds
 * &lt;p&gt;
 * This action is invoked when an EMIS user (professional) tries to connect to PKB via EMIS client
 * Few interceptors which depend on logged-in user data are switched-off for the URL mapped to this Action class
 * &lt;p&gt;
 * Input : PKB email and password from SSO User
 * &lt;p&gt;
 * createSSOAuthKeys :
 * &lt;ul&gt;
 * &lt;li&gt;Use PKB creds to get UserPrivateKey and save a PublicSSOAuthRecord in DB&lt;/li&gt;
 * &lt;li&gt;Redirect to patient summary page&lt;/li&gt;
 * &lt;p&gt;
 * &lt;/ul&gt;
 */
<span class="fc" id="L36">public class CreateSSOAuthKeysAction extends BaseAction {</span>

    private static final String FIRST_SSO_REQUEST_PAGE = &quot;firstSSORequestPage&quot;;

    private Email email; //PKB registration email

    private String password; // Password to PKB site

    private String emisSSOKey; // As sent in session request

    private String emisSSOUserName; // As sent in session request

    private String emisPasswordHash; // As sent in session request

    private SSOService ssoService;

    private LoginAttemptAuditor.Factory loginAttemptAuditorFactory;

    private EMISSSOAuthManager ssoAuthManager;

<span class="fc" id="L56">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    public String createSSOAuthKeys() {
<span class="fc" id="L59">        return ssoService.getSSOIdLinkForSSOUsernameAndSSOType(emisSSOUserName, SSOType.EMIS).map(ssoIdLink -&gt; {</span>
<span class="fc" id="L60">            LoginAttemptAuditor loginAttemptAuditor = loginAttemptAuditorFactory.createAuditor(request.getRemoteAddr());</span>
<span class="fc" id="L61">            long personId = ssoIdLink.getPersonId();</span>
            // authenticate use by PKB creds
            try {
<span class="fc" id="L64">                loginAttemptAuditor.checkForTooManyRecentLoginAttempts(personId);</span>
<span class="fc" id="L65">                PersonAuthInfo pkbUser = userManager.authenticateUser(personId, password);</span>
<span class="fc" id="L66">                LoggedInEHRRequestContext requestContext = getEHRRequestContext().afterUserLoggedIn(pkbUser);</span>
                try {
<span class="pc bpc" id="L68" title="1 of 2 branches missed.">                    if (ssoService.isEmisKeyValid(requestContext.getAccessingUserPublicId(), emisPasswordHash)) {</span>
                        // First SSO request ; Create necessary SSO Auth record for subsequent SSO requests
<span class="fc" id="L70">                        ssoService.createSsoAuthRecord(emisSSOKey, requestContext.getAccessingUserPublicId(), SSOType.EMIS);</span>
                    } else {
                        // invalid SSO creds , flag error
<span class="nc" id="L73">                        addActionError(getText(&quot;ssoEMISError.err.invalid_password_hash&quot;));</span>
<span class="nc" id="L74">                        return Action.ERROR;</span>
                    }
<span class="nc" id="L76">                } catch (Exception e) {</span>
<span class="nc" id="L77">                    logAndAddError(e,&quot;ssoEMISError.err.failed_password_hash_validation&quot;);</span>
<span class="fc" id="L78">                }</span>
<span class="fc" id="L79">            } catch (PKBException e) {</span>
<span class="fc" id="L80">                logAndAddError(e,&quot;ssoEMISError.err.invalid_email_password&quot;);</span>
<span class="fc" id="L81">            } catch (TooManyLoginAttemptsException e) {</span>
<span class="fc" id="L82">                logAndAddError(e,&quot;ssoEMISError.err.too_many_login_attempts&quot;);</span>
<span class="fc" id="L83">            }</span>

<span class="fc bfc" id="L85" title="All 2 branches covered.">            if (getActionErrors().isEmpty()) {</span>
<span class="fc" id="L86">                return Action.SUCCESS;</span>
            } else {
<span class="fc" id="L88">                loginAttemptAuditor.logAttempt(FAIL_BAD_PASSWORD, personId);</span>
<span class="fc" id="L89">                return FIRST_SSO_REQUEST_PAGE;</span>
            }
<span class="fc" id="L91">        }).orElseGet(() -&gt; {</span>
<span class="nc" id="L92">            addActionError(getText(&quot;ssoEMISError.err.pkb_emis_link_absent&quot;));</span>
<span class="nc" id="L93">            return Action.ERROR;</span>
        });
    }

    private void logAndAddError(Exception e, String errorTextKey) {
<span class="fc" id="L98">        LOGGER.error(&quot;Exception while creating SSO Auth keys: &quot;, e);</span>
<span class="fc" id="L99">        addActionError(getText(errorTextKey));</span>
<span class="fc" id="L100">    }</span>

    public Email getEmail() {
<span class="fc" id="L103">        return email;</span>
    }

    public void setEmail(Email email) {
<span class="fc" id="L107">        this.email = email;</span>
<span class="fc" id="L108">    }</span>

    public String getPassword() {
<span class="nc" id="L111">        return password;</span>
    }

    public void setPassword(String password) {
<span class="fc" id="L115">        this.password = password;</span>
<span class="fc" id="L116">    }</span>

    public String getEmisSSOKey() {
<span class="fc" id="L119">        return emisSSOKey;</span>
    }

    public void setEmisSSOKey(String emisSSOKey) {
<span class="fc" id="L123">        this.emisSSOKey = emisSSOKey;</span>
<span class="fc" id="L124">    }</span>

    public String getEmisSSOUserName() {
<span class="fc" id="L127">        return emisSSOUserName;</span>
    }

    public void setEmisSSOUserName(String emisSSOUsername) {
<span class="fc" id="L131">        this.emisSSOUserName = emisSSOUsername;</span>
<span class="fc" id="L132">    }</span>

    public String getEmisPasswordHash() {
<span class="fc" id="L135">        return emisPasswordHash;</span>
    }

    public void setEmisPasswordHash(String emisPasswordHash) {
<span class="fc" id="L139">        this.emisPasswordHash = emisPasswordHash;</span>
<span class="fc" id="L140">    }</span>

    @Autowired
    public void setUserManager(UserManager userManager) {
<span class="fc" id="L144">        this.userManager = userManager;</span>
<span class="fc" id="L145">    }</span>

    @Autowired
    public void setSsoService(SSOService ssoService) {
<span class="fc" id="L149">        this.ssoService = ssoService;</span>
<span class="fc" id="L150">    }</span>

    @Autowired
    public void setLoginAttemptAuditorFactory(LoginAttemptAuditor.Factory loginAttemptAuditorFactory) {
<span class="fc" id="L154">        this.loginAttemptAuditorFactory = loginAttemptAuditorFactory;</span>
<span class="fc" id="L155">    }</span>

    @Autowired
    public void setSsoAuthManager(EMISSSOAuthManager ssoAuthManager) {
<span class="fc" id="L159">        this.ssoAuthManager = ssoAuthManager;</span>
<span class="fc" id="L160">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>