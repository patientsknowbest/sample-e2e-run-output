<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AppointmentsApiController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.internal.appointments</a> &gt; <span class="el_source">AppointmentsApiController.java</span></div><h1>AppointmentsApiController.java</h1><pre class="source lang-java linenums">package com.pkb.api.internal.appointments;

import com.pkb.action.diary.AppointmentsService;
import com.pkb.action.diary.ImmutableComposeAppointmentRequestMessageRequest;
import com.pkb.action.diary.ImmutableConfirmAppointmentRequestRequest;
import com.pkb.action.diary.ImmutableCreateAppointmentFormRequest;
import com.pkb.action.diary.ImmutableEditAppointmentRequest;
import com.pkb.action.diary.ImmutableFinishAppointmentRequestRequest;
import com.pkb.action.diary.ImmutableIntroduceAppointmentRequestRequest;
import com.pkb.action.diary.ImmutableListAppointmentRequest;
import com.pkb.action.diary.ImmutableReviewAppointmentRequestMessageRequest;
import com.pkb.action.diary.ImmutableSaveAppointmentRequest;
import com.pkb.action.diary.ImmutableSendAppointmentRequestMessageRequest;
import com.pkb.action.diary.ImmutableViewAppointmentRequest;
import com.pkb.action.diary.ImmutableViewEmisAppointmentRequest;
import com.pkb.action.diary.UIAppointmentDto;
import com.pkb.action.diary.UIComposeAppointmentRequestDto;
import com.pkb.api.aspect.annotation.RequiresScope;
import com.pkb.api.internal.AbstractInternalApiController;
import com.pkb.api.internal.ReviewAppointmentRequestDto;
import com.pkb.api.internal.SaveAppointmentRequestDto;
import com.pkb.api.internal.SendAppointmentRequestDto;
import com.pkb.api.util.v2.RestUtil;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestBody;

import javax.ws.rs.Consumes;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import java.util.List;
import java.util.Locale;
import java.util.UUID;

import static com.pkb.entities.enums.api.ApiClientScope.CLINICIAN;
import static com.pkb.entities.enums.api.ApiClientScope.PATIENT;

@Controller
@Path(AppointmentsApiController.APPOINTMENTS_PATH)
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
@Api(tags = { &quot;Appointments&quot; }, value = &quot;API for appointments&quot;)
<span class="fc" id="L50">public class AppointmentsApiController extends AbstractInternalApiController {</span>

    static final String APPOINTMENTS_PATH = &quot;/appointments&quot;;
    
    @Autowired
    private AppointmentsService appointmentsService;

    @Autowired
    private RestUtil restUtil;

    @GET
    @Path(&quot;/list&quot;)
    @ApiOperation(value = &quot;Appointments list&quot;)
    @RequiresScope(scopes = { PATIENT, CLINICIAN })
    public Response listAppointments(
            @QueryParam(&quot;locale&quot;) String locale,
            @QueryParam(&quot;pastPageCount&quot;) int pastPageCount,
            @QueryParam(&quot;upcomingPageCount&quot;) int upcomingPageCount) {
<span class="fc" id="L68">        var request = ImmutableListAppointmentRequest.builder()</span>
<span class="fc" id="L69">                .eHRRequestContext(restUtil.getCommonParams().getRequestContext())</span>
<span class="fc" id="L70">                .locale(Locale.forLanguageTag(locale))</span>
<span class="fc" id="L71">                .pastPageCount(pastPageCount)</span>
<span class="fc" id="L72">                .upcomingPageCount(upcomingPageCount)</span>
<span class="fc" id="L73">                .isFromPartner(false)</span>
<span class="fc" id="L74">                .build();</span>
<span class="fc" id="L75">        return ok(appointmentsService.listAppointments(request));</span>
    }

    @GET
    @Path(&quot;/create&quot;)
    @ApiOperation(value = &quot;Create appointment form&quot;)
    @RequiresScope(scopes = { PATIENT, CLINICIAN })
    public Response createAppointmentForm(@QueryParam(&quot;locale&quot;) String locale) {
<span class="fc" id="L83">        var request = ImmutableCreateAppointmentFormRequest.builder()</span>
<span class="fc" id="L84">                .eHRRequestContext(restUtil.getCommonParams().getRequestContext())</span>
<span class="fc" id="L85">                .locale(Locale.forLanguageTag(locale))</span>
<span class="fc" id="L86">                .build();</span>
<span class="fc" id="L87">        return ok(appointmentsService.createAppointmentForm(request));</span>
    }

    @GET
    @Path(&quot;/view&quot;)
    @ApiOperation(value = &quot;View appointment&quot;)
    @RequiresScope(scopes = { PATIENT, CLINICIAN })
    public Response viewAppointment(
            @QueryParam(&quot;locale&quot;) String locale,
            @QueryParam(&quot;uniqueId&quot;) UUID uniqueId,
            @QueryParam(&quot;nhsStyle&quot;) boolean nhsStyle) {
<span class="fc" id="L98">        var request = ImmutableViewAppointmentRequest.builder()</span>
<span class="fc" id="L99">                .eHRRequestContext(restUtil.getCommonParams().getRequestContext())</span>
<span class="fc" id="L100">                .locale(Locale.forLanguageTag(locale))</span>
<span class="fc" id="L101">                .uniqueId(uniqueId)</span>
<span class="fc" id="L102">                .nhsStyle(nhsStyle)</span>
<span class="fc" id="L103">                .build();</span>
<span class="fc" id="L104">        return ok(appointmentsService.viewAppointment(request));</span>
    }

    @GET
    @Path(&quot;/viewEmis&quot;)
    @ApiOperation(value = &quot;View EMIS appointment&quot;)
    @RequiresScope(scopes = { PATIENT, CLINICIAN })
    public Response viewEmisAppointment(
            @QueryParam(&quot;locale&quot;) String locale,
            @QueryParam(&quot;slotId&quot;) long slotId,
            @QueryParam(&quot;nhsStyle&quot;) boolean nhsStyle) {
<span class="fc" id="L115">        var request = ImmutableViewEmisAppointmentRequest.builder()</span>
<span class="fc" id="L116">                .eHRRequestContext(restUtil.getCommonParams().getRequestContext())</span>
<span class="fc" id="L117">                .locale(Locale.forLanguageTag(locale))</span>
<span class="fc" id="L118">                .emisSlotId(slotId)</span>
<span class="fc" id="L119">                .nhsStyle(nhsStyle)</span>
<span class="fc" id="L120">                .build();</span>
<span class="fc" id="L121">        return ok(appointmentsService.viewEmisAppointment(request));</span>
    }

    @GET
    @Path(&quot;/edit&quot;)
    @ApiOperation(value = &quot;Edit appointment form&quot;)
    @RequiresScope(scopes = { PATIENT, CLINICIAN })
    public Response editAppointmentForm(
            @QueryParam(&quot;locale&quot;) String locale,
            @QueryParam(&quot;uniqueId&quot;) UUID uniqueId) {
<span class="nc" id="L131">        var request = ImmutableEditAppointmentRequest.builder()</span>
<span class="nc" id="L132">                .eHRRequestContext(restUtil.getCommonParams().getRequestContext())</span>
<span class="nc" id="L133">                .locale(Locale.forLanguageTag(locale))</span>
<span class="nc" id="L134">                .uniqueId(uniqueId)</span>
<span class="nc" id="L135">                .build();</span>
<span class="nc" id="L136">        return ok(appointmentsService.editAppointment(request));</span>
    }

    @POST
    @Path(&quot;/save&quot;)
    @ApiOperation(value = &quot;Save/submit appointment&quot;)
    @RequiresScope(scopes = { PATIENT, CLINICIAN })
    public Response saveAppointment(@RequestBody SaveAppointmentRequestDto requestDto) {
<span class="fc" id="L144">        var request = ImmutableSaveAppointmentRequest.builder()</span>
<span class="fc" id="L145">                .eHRRequestContext(restUtil.getCommonParams().getRequestContext())</span>
<span class="fc" id="L146">                .locale(Locale.forLanguageTag(requestDto.getLocale()))</span>
<span class="fc" id="L147">                .uniqueId(requestDto.getUniqueId())</span>
<span class="fc" id="L148">                .activityUrl(requestDto.getActivityUrl())</span>
<span class="fc" id="L149">                .privacy(requestDto.getPrivacy())</span>
<span class="fc" id="L150">                .dto(createAppointmentDtoFrom(requestDto))</span>
<span class="fc" id="L151">                .nhsStyle(requestDto.getNhsStyle())</span>
<span class="fc" id="L152">                .returnToAppointment(requestDto.getReturnToAppointment())</span>
<span class="fc" id="L153">                .build();</span>
<span class="fc" id="L154">        return ok(appointmentsService.saveAppointment(request));</span>
    }

    @GET
    @Path(&quot;/introduceAppointmentRequest&quot;)
    @ApiOperation(value = &quot;View introduction for appointment requests&quot;)
    @RequiresScope(scopes = PATIENT)
    public Response introduceAppointmentRequest(
            @QueryParam(&quot;locale&quot;) String locale,
            @QueryParam(&quot;uniqueId&quot;) UUID uniqueId,
            @QueryParam(&quot;requestType&quot;) String requestType,
            @QueryParam(&quot;nhsStyle&quot;) boolean nhsStyle) {
<span class="fc" id="L166">        var request = ImmutableIntroduceAppointmentRequestRequest.builder()</span>
<span class="fc" id="L167">                .eHRRequestContext(restUtil.getCommonParams().getRequestContext())</span>
<span class="fc" id="L168">                .locale(Locale.forLanguageTag(locale))</span>
<span class="fc" id="L169">                .uniqueId(uniqueId)</span>
<span class="fc" id="L170">                .requestType(AppointmentsService.AppointmentRequestType.valueOf(requestType))</span>
<span class="fc" id="L171">                .nhsStyle(nhsStyle)</span>
<span class="fc" id="L172">                .build();</span>
<span class="fc" id="L173">        return ok(appointmentsService.introduceAppointmentRequest(request));</span>
    }

    @GET
    @Path(&quot;/composeAppointmentRequestMessage&quot;)
    @ApiOperation(value = &quot;Compose appointment request message form&quot;)
    @RequiresScope(scopes = PATIENT)
    public Response composeAppointmentRequestMessage(
            @QueryParam(&quot;locale&quot;) String locale,
            @QueryParam(&quot;uniqueId&quot;) UUID uniqueId,
            @QueryParam(&quot;requestType&quot;) String requestType,
            @QueryParam(&quot;nhsStyle&quot;) boolean nhsStyle) {
<span class="fc" id="L185">        var request = ImmutableComposeAppointmentRequestMessageRequest.builder()</span>
<span class="fc" id="L186">                .eHRRequestContext(restUtil.getCommonParams().getRequestContext())</span>
<span class="fc" id="L187">                .locale(Locale.forLanguageTag(locale))</span>
<span class="fc" id="L188">                .uniqueId(uniqueId)</span>
<span class="fc" id="L189">                .requestType(AppointmentsService.AppointmentRequestType.valueOf(requestType))</span>
<span class="fc" id="L190">                .nhsStyle(nhsStyle)</span>
<span class="fc" id="L191">                .build();</span>
<span class="fc" id="L192">        return ok(appointmentsService.composeAppointmentRequestMessage(request));</span>
    }

    @POST
    @Path(&quot;/reviewAppointmentRequestMessage&quot;)
    @ApiOperation(value = &quot;Review the composed appointment request message&quot;)
    @RequiresScope(scopes = PATIENT)
    public Response reviewAppointmentRequestMessage(@RequestBody ReviewAppointmentRequestDto requestDto) {
<span class="fc" id="L200">        var composeDto = new UIComposeAppointmentRequestDto();</span>
<span class="fc" id="L201">        composeDto.setMessageSubject(requestDto.getMessageSubject());</span>
<span class="fc" id="L202">        composeDto.setMessage(requestDto.getMessage());</span>
<span class="fc" id="L203">        composeDto.setRecipientIds(requestDto.getRecipientIds());</span>
<span class="fc" id="L204">        composeDto.setPrivacy(requestDto.getPrivacy());</span>
<span class="fc" id="L205">        var request = ImmutableReviewAppointmentRequestMessageRequest.builder()</span>
<span class="fc" id="L206">                .eHRRequestContext(restUtil.getCommonParams().getRequestContext())</span>
<span class="fc" id="L207">                .locale(Locale.forLanguageTag(requestDto.getLocale()))</span>
<span class="fc" id="L208">                .uniqueId(requestDto.getUniqueId())</span>
<span class="fc" id="L209">                .requestType(AppointmentsService.AppointmentRequestType.valueOf(requestDto.getRequestType()))</span>
<span class="fc" id="L210">                .dto(composeDto)</span>
<span class="fc" id="L211">                .nhsStyle(requestDto.getNhsStyle())</span>
<span class="fc" id="L212">                .build();</span>
<span class="fc" id="L213">        return ok(appointmentsService.reviewAppointmentRequestMessage(request));</span>
    }

    @POST
    @Path(&quot;/sendAppointmentRequestMessage&quot;)
    @ApiOperation(value = &quot;Send the reviewed appointment request message&quot;)
    @RequiresScope(scopes = PATIENT)
    public Response sendAppointmentRequestMessage(@RequestBody SendAppointmentRequestDto requestDto) {
<span class="fc" id="L221">        var composeDto = new UIComposeAppointmentRequestDto();</span>
<span class="fc" id="L222">        composeDto.setMessageSubject(requestDto.getMessageSubject());</span>
<span class="fc" id="L223">        composeDto.setMessage(requestDto.getMessage());</span>
<span class="fc" id="L224">        composeDto.setRecipientIds(requestDto.getRecipientIds());</span>
<span class="fc" id="L225">        composeDto.setPrivacy(requestDto.getPrivacy());</span>
<span class="fc" id="L226">        composeDto.setConfirm(requestDto.getConfirm());</span>
<span class="fc" id="L227">        var request = ImmutableSendAppointmentRequestMessageRequest.builder()</span>
<span class="fc" id="L228">                .eHRRequestContext(restUtil.getCommonParams().getRequestContext())</span>
<span class="fc" id="L229">                .locale(Locale.forLanguageTag(requestDto.getLocale()))</span>
<span class="fc" id="L230">                .uniqueId(requestDto.getUniqueId())</span>
<span class="fc" id="L231">                .requestType(AppointmentsService.AppointmentRequestType.valueOf(requestDto.getRequestType()))</span>
<span class="fc" id="L232">                .dto(composeDto)</span>
<span class="fc" id="L233">                .build();</span>
<span class="fc" id="L234">        return ok(appointmentsService.sendAppointmentRequestMessage(request));</span>
    }

    @GET
    @Path(&quot;/confirmAppointmentRequest&quot;)
    @ApiOperation(value = &quot;Confirm the delivery of the appointment request message&quot;)
    @RequiresScope(scopes = PATIENT)
    public Response confirmAppointmentRequestMessage(
            @QueryParam(&quot;locale&quot;) String locale,
            @QueryParam(&quot;uniqueId&quot;) UUID uniqueId,
            @QueryParam(&quot;requestType&quot;) String requestType,
            @QueryParam(&quot;nhsStyle&quot;) boolean nhsStyle) {
<span class="fc" id="L246">        var request = ImmutableConfirmAppointmentRequestRequest.builder()</span>
<span class="fc" id="L247">                .eHRRequestContext(restUtil.getCommonParams().getRequestContext())</span>
<span class="fc" id="L248">                .locale(Locale.forLanguageTag(locale))</span>
<span class="fc" id="L249">                .uniqueId(uniqueId)</span>
<span class="fc" id="L250">                .requestType(AppointmentsService.AppointmentRequestType.valueOf(requestType))</span>
<span class="fc" id="L251">                .nhsStyle(nhsStyle)</span>
<span class="fc" id="L252">                .build();</span>
<span class="fc" id="L253">        return ok(appointmentsService.confirmAppointmentRequest(request));</span>
    }

    @GET
    @Path(&quot;/finishAppointmentRequest&quot;)
    @ApiOperation(value = &quot;Finish the appointment request flow&quot;)
    @RequiresScope(scopes = PATIENT)
    public Response finishAppointmentRequest(
            @QueryParam(&quot;locale&quot;) String locale,
            @QueryParam(&quot;uniqueId&quot;) UUID uniqueId,
            @QueryParam(&quot;requestType&quot;) String requestType) {
<span class="fc" id="L264">        var request = ImmutableFinishAppointmentRequestRequest.builder()</span>
<span class="fc" id="L265">                .eHRRequestContext(restUtil.getCommonParams().getRequestContext())</span>
<span class="fc" id="L266">                .locale(Locale.forLanguageTag(locale))</span>
<span class="fc" id="L267">                .uniqueId(uniqueId)</span>
<span class="fc" id="L268">                .requestType(AppointmentsService.AppointmentRequestType.valueOf(requestType))</span>
<span class="fc" id="L269">                .build();</span>
<span class="fc" id="L270">        return ok(appointmentsService.finishAppointmentRequest(request));</span>
    }

    private UIAppointmentDto createAppointmentDtoFrom(SaveAppointmentRequestDto requestDto) {
<span class="fc" id="L274">        var dto = new UIAppointmentDto(List.of(requestDto.getPatientId()));</span>
<span class="fc" id="L275">        dto.setSubject(requestDto.getSubject());</span>
<span class="fc" id="L276">        dto.setLocation(requestDto.getLocation());</span>
<span class="fc" id="L277">        dto.setTypeCode(requestDto.getTypeCode());</span>
<span class="fc" id="L278">        dto.setDescription(requestDto.getDescription());</span>
<span class="fc" id="L279">        dto.setStartDate(requestDto.getStartDate());</span>
<span class="fc" id="L280">        dto.setStartTime(requestDto.getStartTime());</span>
<span class="fc" id="L281">        requestDto.getEndDate().ifPresent(dto::setEndDate);</span>
<span class="fc" id="L282">        requestDto.getEndTime().ifPresent(dto::setEndTime);</span>
<span class="fc" id="L283">        return dto;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>