<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AddFileAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.file</a> &gt; <span class="el_source">AddFileAction.java</span></div><h1>AddFileAction.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------
//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: ReplyMessageAction.java Jun 2, 2009 1:14:43 AM mahendera$
//
//------------------------------------------------------------------------------

package com.pkb.action.file;

import com.pkb.app.entity.SourceDetails;
import com.pkb.document.entity.Attachment;
import com.pkb.file.FileDtoType;
import com.pkb.file.entity.FileDTO;
import com.pkb.notification.entity.Activity;
import com.pkb.service.file.FileManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.util.PKBConstants;
import org.apache.commons.lang3.StringUtils;
import org.apache.struts2.interceptor.validation.SkipValidation;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.time.Instant;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.Date;
import java.util.UUID;

import static java.nio.charset.StandardCharsets.UTF_8;

/**
 * Upload file plus a few user-set fields
 *
 * @author robwhelan
 * @author pravina added large file upload functionality
 */
<span class="fc" id="L40">public class AddFileAction extends ChunkedUploadAction {</span>

    private static final long serialVersionUID = -6338006964925286293L;
    private static final String NAMESPACE_FILE = &quot;file&quot;;

    private String date;

    private String notes;

    private String fileUploadErrorMessage;

    FileManager fileManager;

    private DateTimeFormatter dateFormat;


<span class="fc" id="L56">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    @Override
    public String execute() {
<span class="fc" id="L60">        String result = SUCCESS;</span>
        // save the file if all is well
        // show success message back on orig screen
        try {
<span class="fc" id="L64">            PKBPerson patient = contextUserUtil.getContextUser();</span>
<span class="fc bfc" id="L65" title="All 2 branches covered.">            if (patient == null) {</span>
<span class="fc" id="L66">                patient = userManager.getPKBPerson(loggedInUserUtil.getLoggedInUserId());</span>
            }
<span class="fc" id="L68">            Long patientAccountId = userManager.getDefaultAccountId(patient.getId());</span>

            // parse date; format already checked somewhat in validate xml
            // (check fully in validate() here?)
<span class="fc" id="L72">            Instant parsed = null;</span>
            try {
<span class="fc" id="L74">                parsed = parseToInstantWithFormatter(getDate(), dateFormat);</span>
<span class="nc" id="L75">            } catch (DateTimeParseException ignored) {</span>
<span class="nc" id="L76">                addFieldError(&quot;date&quot;, getText(&quot;addFileAction.err.invalid_date&quot;));</span>
<span class="nc" id="L77">                return input();</span>
<span class="fc" id="L78">            }</span>

            // store file upload if selected (optional field)
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">            if (upload != null) {</span>
<span class="nc" id="L82">                getSession().put(ACCOUNT_ID, patientAccountId);</span>
<span class="nc" id="L83">                long fileSize = upload.length();</span>

<span class="nc bnc" id="L85" title="All 2 branches missed.">                if (fileSize &lt; getFileChunkSizeInBytes()) {</span>
                    // No need to upload in chunks
<span class="nc" id="L87">                    UUID docId = processFilePart(uploadFileName, patientAccountId, getContents(upload), null);</span>
<span class="nc" id="L88">                    getSession().put(BASE_FILE_ID, docId.toString());</span>
<span class="nc" id="L89">                    result = SUCCESS;</span>
<span class="nc" id="L90">                } else {</span>
<span class="nc" id="L91">                    uploadInChunks(upload);</span>
                }
            }

<span class="fc bfc" id="L95" title="All 2 branches covered.">            if (getSession().get(BASE_FILE_ID) != null) {</span>
<span class="fc" id="L96">                saveFileDTO(patient.getId(), uploadFileName, parsed);</span>
            } else {
<span class="fc" id="L98">                fileUploadErrorMessage = getText(&quot;addFileActionValidation.err.select_file&quot;);</span>
<span class="fc" id="L99">                return input();</span>
            }

<span class="nc" id="L102">        } catch (Exception e) {</span>
<span class="nc" id="L103">            result = ERROR;</span>
<span class="nc" id="L104">            LOGGER.error(&quot;&quot;, e);</span>
<span class="nc" id="L105">            addActionError(getText(&quot;addFileActionValidation.err.uploading.file&quot;));</span>
        } finally {
<span class="fc" id="L107">            clearSession();</span>
        }
<span class="fc" id="L109">        LOGGER.info(&quot;Exiting execute&quot;);</span>
<span class="fc" id="L110">        return result;</span>
    }

    @SkipValidation
    public String uploadFileInChunk() throws IOException {
<span class="fc" id="L115">        PKBPerson patient = contextUserUtil.getContextUser();</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">        if (patient == null) {</span>
<span class="fc" id="L117">            patient = userManager.getPKBPerson(loggedInUserUtil.getLoggedInUserId());</span>
        }
<span class="fc" id="L119">        Long patientAccountId = userManager.getDefaultAccountId(patient.getId());</span>

<span class="pc bpc" id="L121" title="1 of 2 branches missed.">        if (upload != null) {</span>
<span class="pc bpc" id="L122" title="1 of 2 branches missed.">            if (upload.length() &lt;= 0) {</span>
<span class="nc" id="L123">                fileUploadErrorMessage = getText(&quot;addFileAction.err.empty_file&quot;);</span>
            } else {

<span class="fc" id="L126">                byte[] content = getContents(upload);</span>
<span class="fc" id="L127">                getSession().put(ACCOUNT_ID, patientAccountId);</span>

<span class="fc" id="L129">                UUID parentId = null;</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">                if (!StringUtils.isEmpty(baseDocId)) {</span>
<span class="nc" id="L131">                    parentId = UUID.fromString(baseDocId);</span>
                }
<span class="fc" id="L133">                UUID docId = processFilePart(uploadFileName, patientAccountId, content, parentId);</span>
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">                if (parentId == null) {</span>
<span class="fc" id="L135">                    baseDocId = docId.toString();</span>
<span class="fc" id="L136">                    getSession().put(BASE_FILE_ID, docId.toString());</span>

<span class="fc" id="L138">                    Attachment att = new Attachment();</span>
<span class="fc" id="L139">                    att.setDocMetadataId(docId);</span>
                    //att.setUserId(patient.getIdString());
                    //att.setAccountId(patientAccountId);
<span class="fc" id="L142">                    att.setFilename(uploadFileName);</span>
<span class="fc" id="L143">                    att.setMediaType(uploadContentType);</span>
<span class="fc" id="L144">                    att.setUploadTime(Date.from(dateTimeService.now()));</span>

<span class="fc" id="L146">                    getSession().put(PKBConstants.UPLOADED_CHUNKED_FILE, att);</span>
                }

<span class="fc" id="L149">                upload = null;</span>
            }
        }

<span class="fc" id="L153">        byte[] resultArray = getSession().get(BASE_FILE_ID).toString().getBytes(UTF_8);</span>
<span class="fc" id="L154">        result = new ByteArrayInputStream(resultArray);</span>
<span class="fc" id="L155">        return SUCCESS;</span>
    }

    protected Long saveFileDTO(long userId, String fileName, Instant uploadDate) throws IOException {
<span class="fc" id="L159">        Long[] fileId = {null};</span>
<span class="fc" id="L160">        LOGGER.info(&quot;saveFileDTO: start&quot;);</span>
<span class="fc" id="L161">        FileDTO fileDTO = new FileDTO(new SourceDetails(getEHRRequestContext()));</span>
<span class="fc" id="L162">        Attachment attachment = (Attachment) getSession().get(PKBConstants.UPLOADED_CHUNKED_FILE);</span>
        //fileDTO.setContent(data);
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">        fileDTO.setDate(uploadDate == null ? null : Date.from(uploadDate));</span>
<span class="fc" id="L165">        fileDTO.setFileName(fileName);</span>
<span class="fc" id="L166">        fileDTO.setMediaType(attachment.getMediaType());</span>
<span class="fc" id="L167">        fileDTO.setNotes(getNotes());</span>
<span class="fc" id="L168">        fileDTO.getBaseFields().generateNewRandomUniqueId();</span>
<span class="fc" id="L169">        UUID documentId = UUID.fromString(getSession().get(BASE_FILE_ID).toString());</span>
<span class="fc" id="L170">        fileDTO.setDocumentMetadataId(documentId);</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">        if (privacy != null) {</span>
<span class="fc" id="L172">            fillPrivacyFlagIn(fileDTO);</span>
        }

<span class="fc" id="L175">        userManager.transactional(() -&gt; {</span>
<span class="fc" id="L176">            fileManager.addFile(getEHRRequestContext(), fileDTO, userId, FileDtoType.FILE);</span>
<span class="fc" id="L177">            fileId[0] = fileDTO.getId();</span>
<span class="fc" id="L178">            logActivityByOthers(Activity.Action.ADDED_FILE, dateTimeService.now(), true, fileDTO, getLoggedInEHRRequestContext());</span>
<span class="fc" id="L179">        }, this::undoFileUpload);</span>

<span class="fc" id="L181">        LOGGER.info(&quot;saveFileDTO: end&quot;);</span>
<span class="fc" id="L182">        return fileId[0];</span>
    }

    @Override
    public String input() {
        // default to current date
<span class="fc" id="L188">        setDefaultFlag();</span>
<span class="fc" id="L189">        setDate(dateTimeService.nowLocalDateTime().format(dateFormat));</span>
<span class="fc" id="L190">        return INPUT;</span>
    }

    public String cancel() {
        // redirect to myFiles; no message
<span class="nc" id="L195">        return SUCCESS;</span>
    }

    public String getDate() {
<span class="fc" id="L199">        return date;</span>
    }

    public void setDate(String date) {
<span class="fc" id="L203">        this.date = date;</span>
<span class="fc" id="L204">    }</span>

    public String getNotes() {
<span class="fc" id="L207">        return notes;</span>
    }

    public void setNotes(String notes) {
<span class="fc" id="L211">        this.notes = notes;</span>
<span class="fc" id="L212">    }</span>

    public String getTab() {
<span class="fc" id="L215">        return &quot;files&quot;;</span>
    }

    public String getSubTab() {
<span class="fc" id="L219">        return &quot;addFile&quot;;</span>
    }

    public void setFileManager(FileManager fileManager) {
<span class="fc" id="L223">        this.fileManager = fileManager;</span>
<span class="fc" id="L224">    }</span>

    public String getFileUploadErrorMessage() {
<span class="fc" id="L227">        return fileUploadErrorMessage;</span>
    }

    public void setFileUploadErrorMessage(String fileUploadErrorMessage) {
<span class="fc" id="L231">        this.fileUploadErrorMessage = fileUploadErrorMessage;</span>
<span class="fc" id="L232">    }</span>

    @Override
    public void prepare() throws Exception {
<span class="fc" id="L236">        super.prepare();</span>
<span class="fc" id="L237">        dateFormat = getGlobalDateInputFormatter();</span>

<span class="fc" id="L239">    }</span>

    @Override
    public String getNamespace() {
<span class="fc" id="L243">        return NAMESPACE_FILE;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>