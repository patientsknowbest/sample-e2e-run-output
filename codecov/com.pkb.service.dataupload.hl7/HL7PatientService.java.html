<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HL7PatientService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.dataupload.hl7</a> &gt; <span class="el_source">HL7PatientService.java</span></div><h1>HL7PatientService.java</h1><pre class="source lang-java linenums">package com.pkb.service.dataupload.hl7;

import com.pkb.VersionDetails;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.datamodel.Account;
import com.pkb.datamodel.Email;
import com.pkb.domain.AccountService;
import com.pkb.exception.ApiCallMalformedException;
import com.pkb.exception.IllegalReuseOfEmailAddressException;
import com.pkb.institute.entity.Team;
import com.pkb.service.dataupload.hl7.segment.HL7Patient;
import com.pkb.service.user.impl.PersonContactManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PersonContact;
import io.micrometer.core.instrument.Counter;
import io.micrometer.core.instrument.Metrics;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.List;
import java.util.Optional;
import java.util.UUID;

import static com.pkb.entities.enums.UserStatus.DEAD;
import static com.pkb.entities.enums.UserStatus.NOCONTACT;
import static io.micrometer.core.instrument.Metrics.counter;
import static java.lang.invoke.MethodHandles.lookup;
import static java.util.stream.Collectors.toList;
import static org.slf4j.LoggerFactory.getLogger;

@Component
<span class="fc" id="L35">public class HL7PatientService {</span>

<span class="fc" id="L37">    private static final Logger LOGGER = getLogger(lookup().lookupClass());</span>
    private static final String ACCOUNT_ACCESS_COUNTER_NAME = &quot;pkb_phr_integration_hl7_addemail_accountaccess&quot;;
    private static final String ACCOUNT_ACCESS_TAG_KEY = &quot;success&quot;;
<span class="fc" id="L40">    private static final Counter ACCOUNT_ACCESS = Counter.builder(ACCOUNT_ACCESS_COUNTER_NAME)</span>
<span class="fc" id="L41">            .description(&quot;Number of patient who can/can not access their account when adding primary email address to them&quot;)</span>
<span class="fc" id="L42">            .tags(ACCOUNT_ACCESS_TAG_KEY, &quot;true&quot;, ACCOUNT_ACCESS_TAG_KEY, &quot;false&quot;)</span>
<span class="fc" id="L43">            .register(Metrics.globalRegistry);</span>

    @Autowired
    private HL7TeamService hl7TeamService;
    @Autowired
    private AccountService accountService;
    @Autowired
    private UserManager userManager;
    @Autowired
    private PersonContactManager personContactManager;

    /**
     * Add any new email from HL7 message which is not already persisted to the patient
     *
     * @return list of email addresses which are newly added to the patient
     * @throws ApiCallMalformedException           when any of the email addresses is already active in PKB
     * @throws IllegalReuseOfEmailAddressException when any of the email addresses is associated with multiple persons
     */
    List&lt;PersonContact&gt; addEmails(List&lt;Email&gt; emailAddresses, AddEmailContext addEmailContext) {
<span class="fc" id="L62">        return emailAddresses.stream()</span>
<span class="fc bfc" id="L63" title="All 2 branches covered.">                .filter(email -&gt; !addEmailContext.patient.hasEmail(email))</span>
<span class="fc" id="L64">                .map(email -&gt; addEmail(email, addEmailContext))</span>
<span class="fc" id="L65">                .flatMap(Optional::stream)</span>
<span class="fc" id="L66">                .collect(toList());</span>
    }

    /**
     * Add email to patient as primary email address if patient doesn't have primary email address,
     * otherwise add it as secondary email address if they can be contacted.
     *
     * @return a contact if the contact was added to the patient as a secondary address
     *         or as a primary address when the patient can access their account
     */
    @NotNull
    private Optional&lt;PersonContact&gt; addEmail(Email email, AddEmailContext addEmailContext) {
        try {
<span class="fc bfc" id="L79" title="All 2 branches covered.">            if (!hasPrimaryEmail(addEmailContext.patient)) {</span>
                // Add primary email to patient if not marked as deceased
<span class="fc bfc" id="L81" title="All 4 branches covered.">                if (addEmailContext.hl7Patient.isMarkedAsDeceased() || addEmailContext.hl7Patient.isDeathTimestampProvided()) {</span>
<span class="fc" id="L82">                    LOGGER.info(&quot;Patient {} marked as deceased. Primary email address {} is not going to be saved and not sending invitation.&quot;,</span>
<span class="fc" id="L83">                            addEmailContext.patient.getId(), email);</span>
<span class="fc" id="L84">                    return Optional.empty();</span>
                }

<span class="fc" id="L87">                Team team = hl7TeamService.getCreatingTeam(addEmailContext.hl7ConnContext);</span>
<span class="pc bpc" id="L88" title="1 of 2 branches missed.">                if (team == null) {</span>
<span class="nc" id="L89">                    LOGGER.error(&quot;Can't add email address {} to patient {} without resolving creating team.&quot;,</span>
<span class="nc" id="L90">                            email, addEmailContext.patient.getId());</span>
<span class="nc" id="L91">                    return Optional.empty();</span>
                }

<span class="fc" id="L94">                PersonContact contact = persistEmail(addEmailContext, email, true);</span>
<span class="fc" id="L95">                addEmailContext.patient.setPwdAccessDocumentMetadataId(null);</span>

<span class="fc" id="L97">                UUID accountPublicId = accountService</span>
<span class="fc" id="L98">                        .findPatientAccount(addEmailContext.patient.getPublicId())</span>
<span class="fc" id="L99">                        .map(Account::getPublicId)</span>
<span class="pc" id="L100">                        .orElseThrow(() -&gt; new RuntimeException(&quot;Can't find account for patient &quot; +</span>
<span class="nc" id="L101">                                addEmailContext.patient.getId()));</span>

                // Can patient access their own account?
<span class="fc" id="L104">                if (userManager.recreateOwnerAccessToAccount(addEmailContext.requestContext.getCorrelationId().toString(),</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">                        accountPublicId, addEmailContext.patient.getPublicId()).succesfullyRecreated()) {</span>
<span class="fc" id="L106">                    counter(ACCOUNT_ACCESS_COUNTER_NAME, ACCOUNT_ACCESS_TAG_KEY, &quot;true&quot;).increment();</span>
<span class="fc" id="L107">                    return Optional.of(contact);</span>
                }

<span class="fc" id="L110">                userManager.recordInvitationRepairJob(addEmailContext.patient, accountPublicId, team);</span>
<span class="fc" id="L111">                counter(ACCOUNT_ACCESS_COUNTER_NAME, ACCOUNT_ACCESS_TAG_KEY, &quot;false&quot;).increment();</span>

<span class="fc" id="L113">                return Optional.empty();</span>
            }

            // don't handle here (yet) if this is a no-contact patient, or dead
<span class="fc bfc" id="L117" title="All 2 branches covered.">            if (canBeContacted(addEmailContext.patient, addEmailContext.hl7Patient)) {</span>
                // add it as a new, non-primary, non-confirmed contact
<span class="fc" id="L119">                PersonContact contact = persistEmail(addEmailContext, email, false);</span>
<span class="fc" id="L120">                return Optional.of(contact);</span>
            }
<span class="nc" id="L122">        } catch (Exception e) {</span>
<span class="nc" id="L123">            LOGGER.error(&quot;Can't add email {} to patient {}.&quot;, email, addEmailContext.patient.getId(), e);</span>
<span class="fc" id="L124">        }</span>

<span class="fc" id="L126">        return Optional.empty();</span>
    }

    @NotNull
    private PersonContact persistEmail(AddEmailContext addEmailContext, Email email, boolean primary) {
<span class="fc" id="L131">        var contact = new PersonContact();</span>
<span class="fc" id="L132">        contact.setPublicId(UUID.randomUUID());</span>
<span class="fc" id="L133">        contact.setPerson(addEmailContext.patient);</span>
<span class="fc" id="L134">        contact.setContactAsEmail(email);</span>
<span class="fc" id="L135">        contact.setConfirmed(false);</span>
<span class="fc" id="L136">        contact.setPrimary(primary);</span>

<span class="fc" id="L138">        return personContactManager.save(contact, addEmailContext.versionDetails);</span>
    }

    private boolean canBeContacted(PKBPerson patient, HL7Patient hl7Patient) {
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">        return patient.hasContact()</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">                &amp;&amp; patient.getStatus() != NOCONTACT</span>
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">                &amp;&amp; patient.getStatus() != DEAD</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">                &amp;&amp; !hl7Patient.isMarkedAsDeceased();</span>
    }

    private boolean hasPrimaryEmail(PKBPerson person) {
<span class="fc bfc" id="L149" title="All 2 branches covered.">        return person.hasContact()</span>
<span class="fc" id="L150">                &amp;&amp; person.getContacts().stream()</span>
<span class="fc" id="L151">                .filter(PersonContact::isEmail)</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">                .anyMatch(PersonContact::isPrimary);</span>
    }

    static class AddEmailContext {
        private final EHRRequestContext requestContext;
        private final HL7ConnContext hl7ConnContext;
        private final PKBPerson patient;
        private final HL7Patient hl7Patient;
        private final VersionDetails versionDetails;

        AddEmailContext(EHRRequestContext requestContext, HL7ConnContext hl7ConnContext, PKBPerson patient,
<span class="fc" id="L163">                        HL7Patient hl7Patient, VersionDetails versionDetails) {</span>
<span class="fc" id="L164">            this.requestContext = requestContext;</span>
<span class="fc" id="L165">            this.hl7ConnContext = hl7ConnContext;</span>
<span class="fc" id="L166">            this.patient = patient;</span>
<span class="fc" id="L167">            this.hl7Patient = hl7Patient;</span>
<span class="fc" id="L168">            this.versionDetails = versionDetails;</span>
<span class="fc" id="L169">        }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>