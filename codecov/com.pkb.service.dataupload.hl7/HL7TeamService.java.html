<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HL7TeamService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.dataupload.hl7</a> &gt; <span class="el_source">HL7TeamService.java</span></div><h1>HL7TeamService.java</h1><pre class="source lang-java linenums">package com.pkb.service.dataupload.hl7;

import com.google.common.annotations.VisibleForTesting;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.exception.ApiCallMalformedException;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import com.pkb.model.RecordWithId;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamService;
import com.pkb.user.entity.PKBPerson;
import io.prometheus.client.Summary;
import io.vavr.Tuple;
import io.vavr.Tuple2;
import org.apache.commons.lang3.StringUtils;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Collection;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.UUID;
import java.util.function.Function;
import java.util.function.Supplier;
import java.util.stream.Stream;

import static com.pkb.service.dataupload.hl7.HL7MessageType.ADT_A28;
import static com.pkb.service.dataupload.hl7.HL7MessageType.ADT_A31;
import static com.pkb.service.dataupload.hl7.HL7MessageType.QRY_A19;
import static java.lang.String.format;
import static java.util.Collections.emptyList;
import static java.util.Collections.emptySet;
import static java.util.function.Function.identity;
import static java.util.stream.Collectors.toList;
import static java.util.stream.Collectors.toMap;
import static java.util.stream.Collectors.toSet;
import static org.apache.commons.collections4.CollectionUtils.isEmpty;
import static org.apache.commons.collections4.CollectionUtils.isNotEmpty;
import static org.apache.commons.lang3.StringUtils.isNotBlank;

@Component
<span class="fc" id="L48">public class HL7TeamService {</span>
<span class="fc" id="L49">    private static final Summary ALIAS_RESOLUTION_DURATION_SECS = Summary.build()</span>
<span class="fc" id="L50">            .name(&quot;pkb_phr_integration_hl7_alias_resolution_duration_secs&quot;)</span>
<span class="fc" id="L51">            .help(&quot;Time needed to resolve aliases in a HL7 message&quot;)</span>
<span class="fc" id="L52">            .register();</span>


    @Autowired
    private HL7ParsingManager hl7ParsingManager;
    @Autowired
    private TeamService teamService;
    @Autowired
    private TeamManager teamManager;

    /**
     * It adds an existing patient to creation teams by creating consent and institute user records.
     * Patient and carers (if any) receive notifications.
     *
     * @return number of teams where the patient was added to
     */
    public long addToTeams(PKBPerson patient, HL7XmlDoc message, HL7ConnContext context) {
<span class="fc bfc" id="L69" title="All 2 branches covered.">        if (!canBeAddedToTeams(patient, message)) {</span>
<span class="fc" id="L70">            return 0;</span>
        }

<span class="fc" id="L73">        var creationTeams = getCreationTeams(message, context).getCreationTeams();</span>

<span class="fc" id="L75">        return teamService.addToTeams(patient, creationTeams, context.getEHRRequestContext());</span>
    }

    public &lt;ID&gt; List&lt;RecordWithId&lt;ID, Long&gt;&gt; addToTeams(Collection&lt;RecordWithId&lt;ID, HL7Wrapper&gt;&gt; hl7wrappers, PKBPerson patient) {
<span class="pc bpc" id="L79" title="1 of 4 branches missed.">        if (patient == null || isEmpty(hl7wrappers)) {</span>
<span class="fc" id="L80">            return emptyList();</span>
        }
<span class="fc" id="L82">        List&lt;RecordWithId&lt;ID, HL7Wrapper&gt;&gt; canBeAddedToTeams = hl7wrappers.stream().filter(r -&gt; canBeAddedToTeams(patient, r.record().getHL7Xml())).collect(toList());</span>
<span class="fc" id="L83">        Map&lt;ID, CreationTeamsResponse&gt; creationTeamsResponseMap = getCreationTeams(canBeAddedToTeams).collect(toMap(RecordWithId::id, RecordWithId::record));</span>

<span class="fc" id="L85">        List&lt;RecordWithId&lt;ID, Tuple2&lt;EHRRequestContext, Set&lt;Team&gt;&gt;&gt;&gt; addToTeamsList = hl7wrappers.stream()</span>
<span class="fc" id="L86">                .map(hl7w -&gt; hl7w.switchRecord(Tuple.of(hl7w.record().getHl7ConnContext().getEHRRequestContext(), creationTeamsResponseMap.get(hl7w.id()).getCreationTeams())))</span>
<span class="fc" id="L87">                .collect(toList());</span>

<span class="fc" id="L89">        Map&lt;ID, Long&gt; result = teamService.addToTeams(patient, addToTeamsList)</span>
<span class="fc" id="L90">                .collect(toMap(RecordWithId::id, RecordWithId::record));</span>

<span class="fc" id="L92">        return hl7wrappers.stream()</span>
<span class="fc" id="L93">                .map(r -&gt; {</span>
<span class="fc" id="L94">                    Long addToTeamsResult = result.get(r.id());</span>
<span class="fc bfc" id="L95" title="All 2 branches covered.">                    if (addToTeamsResult == null) {</span>
<span class="fc" id="L96">                        return r.switchRecord(0L);</span>
                    }
<span class="fc" id="L98">                    return r.switchRecord(addToTeamsResult);</span>
<span class="fc" id="L99">                }).collect(toList());</span>
    }

    public &lt;ID&gt; Stream&lt;RecordWithId&lt;ID, CreationTeamsResponse&gt;&gt; getCreationTeams(Collection&lt;RecordWithId&lt;ID, HL7Wrapper&gt;&gt; hl7wrappers) {
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">        if (isEmpty(hl7wrappers)) {</span>
<span class="nc" id="L104">            return Stream.empty();</span>
        }

<span class="fc" id="L107">        Map&lt;ID, String&gt; creatingTeamCodesMap = new HashMap&lt;&gt;(hl7wrappers.size());</span>
<span class="fc" id="L108">        Map&lt;ID, List&lt;String&gt;&gt; aliasesFromZtmMap = new HashMap&lt;&gt;(hl7wrappers.size());</span>

<span class="fc bfc" id="L110" title="All 2 branches covered.">        for (RecordWithId&lt;ID, HL7Wrapper&gt; r : hl7wrappers) {</span>
<span class="fc" id="L111">            var hl7Context = r.record().getHl7ConnContext();</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">            String teamCode = hl7Context.getHl7Partner().isPresent() ? hl7Context.getPartnerGrantNewPatientTeamCode().orElse(&quot;&quot;) : hl7Context.getSourceOrg().getHl7NewPatientTeamCode();</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">            if (isNotBlank(teamCode)) {</span>
<span class="fc" id="L114">                creatingTeamCodesMap.put(r.id(), teamCode);</span>
            }
<span class="fc" id="L116">            aliasesFromZtmMap.put(r.id(), r.record().getHL7Xml().parseZtm());</span>
<span class="fc" id="L117">        }</span>

<span class="fc" id="L119">        var serializableSetOfCreatingTeamCodes = Set.copyOf(creatingTeamCodesMap.values()); //To make RMI happy...</span>
<span class="fc" id="L120">        Map&lt;String, Team&gt; teamByCodeMap = teamManager.getTeamsByCode(serializableSetOfCreatingTeamCodes).stream().collect(toMap(t -&gt; t.getCode(), identity()));</span>

<span class="fc" id="L122">        return hl7wrappers.stream().map(hl7w -&gt; {</span>
<span class="fc" id="L123">            Team creatingTeam = getCreatingTeam(hl7w.record().getHl7ConnContext(), teamByCodeMap::get);</span>
            //TODO: getTeamsFromAliases still initiates ~10 db calls for each record, and its called for each hl7 message, so still room for optimization...
<span class="pc" id="L125">            return hl7w.switchRecord(getCreationTeams(hl7w.record().getHL7Xml(), creatingTeam, () -&gt; aliasesFromZtmMap.get(hl7w.id()), aliasesFromZtm -&gt; getTeamsFromAliases(hl7w.record().getHl7ConnContext(), aliasesFromZtm, creatingTeam)));</span>
        });
    }

    @NotNull
    public CreationTeamsResponse getCreationTeams(HL7XmlDoc message, HL7ConnContext context) {
<span class="fc" id="L131">        Team creatingTeam = getCreatingTeam(context, teamManager::getTeamByCode);</span>
<span class="fc" id="L132">        return getCreationTeams(message, creatingTeam, message::parseZtm, aliasesFromZtm -&gt; getTeamsFromAliases(context, aliasesFromZtm, creatingTeam));</span>
    }

    private CreationTeamsResponse getCreationTeams(HL7XmlDoc message, Team creatingTeam, Supplier&lt;List&lt;String&gt;&gt; aliasesProvider, Function&lt;List&lt;String&gt;, Set&lt;Team&gt;&gt; teamFromAliasProvider) {
<span class="fc" id="L136">        var aliasesFromZtm = aliasesProvider.get();</span>

        // ZTM segment provided
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (isNotEmpty(aliasesFromZtm)) {</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">            if (isZtmNotSupported(message)) {</span>
<span class="nc" id="L141">                throw new ApiCallMalformedException(&quot;ZTM segments are only supported for ADT A28/A31 messages&quot;);</span>
            }
<span class="fc" id="L143">            return CreationTeamsResponse.of(creatingTeam, teamFromAliasProvider.apply(aliasesFromZtm));</span>
        } else {
<span class="fc" id="L145">            return CreationTeamsResponse.of(creatingTeam);</span>
        }
    }

    @NotNull
    public CreationTeamsResponse getCreationTeams(List&lt;String&gt; teamAliases, HL7ConnContext context) {
<span class="fc" id="L151">        Team creatingTeam = getCreatingTeam(context);</span>
<span class="fc bfc" id="L152" title="All 2 branches covered.">        return teamAliases.isEmpty() ? CreationTeamsResponse.of(creatingTeam)</span>
<span class="fc" id="L153">                : CreationTeamsResponse.of(creatingTeam, getTeamsFromAliases(context, teamAliases, creatingTeam));</span>
    }

    @Nullable
    public Team getCreatingTeam(HL7ConnContext context) {
<span class="fc" id="L158">        return getCreatingTeam(context, teamManager::getTeamByCode);</span>
    }

    @Nullable
    private Team getCreatingTeam(HL7ConnContext context, Function&lt;String, Team&gt; teamByCodeProvider) {
<span class="fc bfc" id="L163" title="All 2 branches covered.">        return context.getHl7Partner().isPresent()</span>
<span class="fc" id="L164">                ? context.getPartnerGrantNewPatientTeamCode().map(teamByCodeProvider).orElse(null)</span>
<span class="fc" id="L165">                : context.getSourceTeam().orElseGet(() -&gt; teamByCodeProvider.apply(context.getSourceOrg().getHl7NewPatientTeamCode()));</span>
    }

    @VisibleForTesting
    @NotNull
    Set&lt;Team&gt; getTeamsFromAliases(@NotNull HL7ConnContext hl7ConnContext, @NotNull List&lt;String&gt; aliases, Team creatingTeam) {
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">        if (hl7ConnContext.getConnectingTeam().isPresent()) {</span>
<span class="nc" id="L172">            return emptySet();</span>
        }

<span class="fc" id="L175">        try (var ignored = ALIAS_RESOLUTION_DURATION_SECS.startTimer()) {</span>

<span class="fc" id="L177">            var connectingOrgTeamPartners = hl7ParsingManager.getOrgOrTeamFromAliasMap(aliases, hl7ConnContext.hl7UploadSourceWhitelist());</span>

<span class="fc" id="L179">            Set&lt;String&gt; parnterTeamCodes = connectingOrgTeamPartners.values().stream()</span>
<span class="fc" id="L180">                    .filter(otpr -&gt; otpr.isOrg())</span>
<span class="fc" id="L181">                    .map(otpr -&gt; otpr.getOrg().getHl7NewPatientTeamCode())</span>
<span class="fc" id="L182">                    .filter(StringUtils::isNotBlank)</span>
<span class="fc" id="L183">                    .collect(toSet());</span>
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">            if (hl7ConnContext.getSourceOrg().getHl7NewPatientTeamCode() != null) {</span>
<span class="fc" id="L185">                parnterTeamCodes.add(hl7ConnContext.getSourceOrg().getHl7NewPatientTeamCode());</span>
            }

<span class="fc" id="L188">            Map&lt;String, Team&gt; teamsByCode = teamManager.getTeamsByCode(parnterTeamCodes).stream()</span>
<span class="pc" id="L189">                    .collect(toMap(t -&gt; t.getCode(), identity(), (t1, t2) -&gt; t1));</span>

<span class="fc" id="L191">            var teams = aliases.stream()</span>
<span class="fc" id="L192">                    .map(alias -&gt; resolveAlias(alias, connectingOrgTeamPartners, teamsByCode)</span>
<span class="fc" id="L193">                            .orElse(teamsByCode.get(hl7ConnContext.getSourceOrg().getHl7NewPatientTeamCode())))</span>
<span class="fc" id="L194">                    .filter(Objects::nonNull)</span>
<span class="fc" id="L195">                    .collect(toSet());</span>

<span class="pc bpc" id="L197" title="1 of 4 branches missed.">            if (creatingTeam != null &amp;&amp; !teams.contains(creatingTeam)) {</span>
<span class="fc" id="L198">                throw new ApiCallMalformedException(&quot;A ZTM segment cannot exclude the Creating Team&quot;);</span>
            }

<span class="fc" id="L201">            return teams;</span>
        }
    }

    public Optional&lt;Org&gt; getOrgByPublicId(UUID publicId) {
<span class="fc" id="L206">        return teamManager.getOrgByPublicId(publicId, Org.Lazy.TEAMS, Org.Lazy.EXTERNAL_IDS);</span>
    }

    private Optional&lt;Team&gt; resolveAlias(String alias, Map&lt;String, HL7ParsingManager.OrgTeamPartnerResult&gt; connectingOrgTeamPartners, Map&lt;String, Team&gt; teamsByCode) {
<span class="fc" id="L210">        return resolveAlias(alias, Optional.ofNullable(connectingOrgTeamPartners.get(alias)), teamsByCode::get);</span>
    }

    private Optional&lt;Team&gt; resolveAlias(String alias, Optional&lt;HL7ParsingManager.OrgTeamPartnerResult&gt; maybeOrgOrTeam, Function&lt;String, Team&gt; teamProvider) {
<span class="fc" id="L214">        return maybeOrgOrTeam.flatMap(orgOrTeam -&gt; {</span>
<span class="fc bfc" id="L215" title="All 2 branches covered.">            if (orgOrTeam.isTeam()) {</span>
<span class="fc" id="L216">                return Optional.of(orgOrTeam.getTeamWithOrg()._1());</span>
<span class="pc bpc" id="L217" title="1 of 2 branches missed.">            } else if (orgOrTeam.isOrg()) {</span>
<span class="fc" id="L218">                var team = teamProvider.apply(orgOrTeam.getOrg().getHl7NewPatientTeamCode());</span>
<span class="pc bpc" id="L219" title="1 of 2 branches missed.">                if (team == null) {</span>
<span class="nc" id="L220">                    throw new ApiCallMalformedException(</span>
<span class="nc" id="L221">                            format(&quot;Contact support: cannot create patient without default team code configured for ZTM org alias %s&quot;,</span>
                                    alias));
                }
<span class="fc" id="L224">                return Optional.of(team);</span>
            }
<span class="nc" id="L226">            throw new IllegalStateException(format(&quot;Unexpected other destination team alias for %s: %s&quot;,</span>
<span class="nc" id="L227">                    alias, orgOrTeam.getResultType()));</span>
        });
    }

    private boolean isZtmNotSupported(HL7XmlDoc message) {
<span class="pc bpc" id="L232" title="3 of 4 branches missed.">        return message.getMessageType() != ADT_A28 &amp;&amp; message.getMessageType() != ADT_A31;</span>
    }

    private boolean canBeAddedToTeams(PKBPerson patient, HL7XmlDoc message) {
<span class="pc bpc" id="L236" title="1 of 4 branches missed.">        return patient != null &amp;&amp; message.getMessageType() != QRY_A19;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>