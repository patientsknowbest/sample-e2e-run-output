<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HL7ConnContext.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.dataupload.hl7</a> &gt; <span class="el_source">HL7ConnContext.java</span></div><h1>HL7ConnContext.java</h1><pre class="source lang-java linenums">package com.pkb.service.dataupload.hl7;

import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.EHRRequestContext.AccountLinkType;
import com.pkb.app.entity.ImmutableLoggedOutEHRRequestContext;
import com.pkb.app.entity.ImmutableLoggedOutEHRRequestContext.Builder;
import com.pkb.consent.model.ConsentStatus;
import com.pkb.datamodel.Hl7Partner;
import com.pkb.entities.enums.NationalIdType;
import com.pkb.entities.enums.Route;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import org.immutables.value.Value;
import org.jetbrains.annotations.Nullable;

import java.util.Optional;
import java.util.Set;
import java.util.UUID;

import static com.pkb.entities.enums.Route.HL7_API;

/**
 * @see HL7ConnContextFactory
 */
@Value.Style(
        get = {&quot;is*&quot;, &quot;get*&quot;},
        stagedBuilder = true,
        depluralize = true)
@Value.Immutable
public interface HL7ConnContext {

    Org getSourceOrg();

    Optional&lt;Team&gt; getSourceTeam();

    Org getConnectingOrg();

    Optional&lt;Team&gt; getConnectingTeam();

    Optional&lt;Hl7Partner&gt; getHl7Partner();

    Optional&lt;NationalIdType&gt; getNationalIdType();

    Set&lt;String&gt; dataUploadIpWhitelist();

    Set&lt;String&gt; hl7UploadSourceWhitelist();

    /* ImmutableSet of enum values; it's a fixed set */
    Set&lt;String&gt; hl7UploadValidatePidList();

    boolean getHl7AutoCreateRecords();

    boolean getHl7CheckNhsNumberStatus();

    String getTimeZoneId();

    UUID getCorrelationId();

    Optional&lt;String&gt; getPartnerGrantNewPatientTeamCode();

    Optional&lt;String&gt; getMaybeResponsibleOrganisationIdentifier();

    @Value.Default
    default Route getApiRoute() {
<span class="fc" id="L65">        return HL7_API;</span>
    }

    /**
     * Determines whether we have a source Team. If we do, this should be used in preference to any Org information. For example, when returning a
     * name.
     *
     * @return true - if team is not null. false - otherwise.
     */
    @Value.Derived
    default boolean hasSourceTeam() {
<span class="fc" id="L76">        return getSourceTeam().isPresent();</span>
    }

    @Value.Derived
    default String getName() {
<span class="fc" id="L81">        return getSourceTeam()</span>
<span class="fc" id="L82">                .map(Team::getName)</span>
<span class="fc" id="L83">                .orElse(getSourceOrg().getName());</span>
    }

    @Value.Derived
    default String getCountry() {
<span class="fc" id="L88">        return getSourceTeam()</span>
<span class="fc" id="L89">                .map(Team::getCountry)</span>
<span class="fc" id="L90">                .orElse(getSourceOrg().getCountry());</span>
    }

    @Value.Derived
    default String getCode() {
<span class="fc" id="L95">        return getSourceTeam()</span>
<span class="fc" id="L96">                .map(Team::getCode)</span>
<span class="fc" id="L97">                .orElse(getSourceOrg().getCode());</span>
    }

    @Value.Derived
    default Long getId() {
<span class="fc" id="L102">        return getSourceTeam()</span>
<span class="fc" id="L103">                .map(Team::getId)</span>
<span class="fc" id="L104">                .orElse(getSourceOrg().getId());</span>
    }

    @Value.Derived
    default long getSourceOrgId() {
<span class="fc" id="L109">        return getSourceOrg().getId();</span>
    }

    @Value.Derived
    default Optional&lt;Long&gt; getSourceTeamId() {
<span class="fc" id="L114">        return getSourceTeam().map(Team::getId);</span>
    }


    @Value.Derived
    default EHRRequestContext getEHRRequestContext() {
<span class="fc" id="L120">        Builder builder = ImmutableLoggedOutEHRRequestContext.builder().accessRoute(getApiRoute()).accountLinkType(AccountLinkType.ORG)</span>
<span class="fc" id="L121">                .correlationId(getCorrelationId())</span>
<span class="fc" id="L122">                .consentStatus(ConsentStatus.builder().build());</span>
<span class="fc" id="L123">        getSourceTeamId().ifPresent(builder::teamId);</span>
<span class="fc" id="L124">        builder.org(getSourceOrg());</span>
<span class="fc" id="L125">        builder.maybeConnectingOrg(getConnectingOrg());</span>
<span class="fc" id="L126">        builder.maybeHl7Partner(getHl7Partner());</span>
<span class="fc" id="L127">        builder.maybeResponsibleOrganisationIdentifier(getMaybeResponsibleOrganisationIdentifier());</span>
<span class="fc" id="L128">        return builder.build();</span>
    }

    @Nullable
    @Value.Derived
    default String getNewPatientTeamCode() {
<span class="fc bfc" id="L134" title="All 2 branches covered.">        if (getHl7Partner().isPresent()) {</span>
<span class="fc" id="L135">            return getPartnerGrantNewPatientTeamCode().orElse(null);</span>
        }

<span class="fc" id="L138">        return getSourceOrg().getHl7NewPatientTeamCode();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>