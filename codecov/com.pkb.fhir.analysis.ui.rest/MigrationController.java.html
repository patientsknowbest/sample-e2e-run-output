<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MigrationController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.fhir.analysis.ui.rest</a> &gt; <span class="el_source">MigrationController.java</span></div><h1>MigrationController.java</h1><pre class="source lang-java linenums">package com.pkb.fhir.analysis.ui.rest;

import com.pkb.entities.enums.MenuDataType;
import com.pkb.fhir.analysis.core.domain.EhrDataProcessingContext;
import com.pkb.fhir.analysis.core.domain.MigrationParameters;
import com.pkb.fhir.analysis.core.threading.EhrDataMigrationBootstrapper;
import com.pkb.fhir.analysis.process.domain.ProcessorEnum;
import org.apache.commons.lang3.EnumUtils;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import java.util.Arrays;

/**
 * The web layer for ehrmigrator consists of this controller class and Swagger UI which helps us manually kick off discrete tasks.
 * We can initiate data processing (decrypt - transform - validate - store) by entering all the required parameters,
 * display/erase status info and stop running processes. To perform these tasks, we call into {@link EhrDataMigrationBootstrapper}.
 * The UI can be reached on the following link after the local stack has been started.
 * @see &lt;a href=&quot;http://localhost:30080/swagger-ui/index.html&quot;&gt;Migrator UI&lt;/a&gt;
 */
@RestController
public class MigrationController {
    private EhrDataMigrationBootstrapper ehrDataMigrationBootstrapper;

<span class="fc" id="L27">    public MigrationController(EhrDataMigrationBootstrapper ehrDataMigrationBootstrapper) {</span>
<span class="fc" id="L28">        this.ehrDataMigrationBootstrapper = ehrDataMigrationBootstrapper;</span>
<span class="fc" id="L29">    }</span>

    @GetMapping(&quot;/status&quot;)
    EhrDataProcessingContext status() {
<span class="fc" id="L33">        return ehrDataMigrationBootstrapper.getState();</span>
    }

    @PostMapping(&quot;/bootstrap&quot;)
    String bootstrapDataProcessing(String menuDataType, ProcessorEnum processEnum, int dataPageSize, int maxThreads,
                                   @RequestParam(required = false) Long startFromId,
                                   @RequestParam(required = false) Long endBeforeId,
                                   @RequestParam(required = false) boolean overrideExisting) {
        String result;
<span class="fc" id="L42">        MenuDataType resolvedMenuDataType = EnumUtils.getEnum(MenuDataType.class, menuDataType);</span>
<span class="fc bfc" id="L43" title="All 2 branches covered.">        if (resolvedMenuDataType == null) {</span>
<span class="fc" id="L44">            return String.format(&quot;Please provide a valid menu data type. Possible values: %s&quot;, Arrays.asList(MenuDataType.values()));</span>
        } else {
            try {
<span class="fc" id="L47">                MigrationParameters migrationParameters = new MigrationParameters();</span>
<span class="fc" id="L48">                migrationParameters.setDataPageSize(dataPageSize);</span>
<span class="fc" id="L49">                migrationParameters.setEndBeforeId(endBeforeId);</span>
<span class="fc" id="L50">                migrationParameters.setMaxThreads(maxThreads);</span>
<span class="fc" id="L51">                migrationParameters.setStartFromId(startFromId);</span>
<span class="fc" id="L52">                migrationParameters.setMenuDataType(resolvedMenuDataType);</span>
<span class="fc" id="L53">                migrationParameters.setOverrideExisting(overrideExisting);</span>
<span class="fc" id="L54">                migrationParameters.setProcessorEnum(processEnum);</span>
<span class="fc" id="L55">                ehrDataMigrationBootstrapper.bootstrapProcessorWorkers(migrationParameters);</span>

<span class="fc" id="L57">                result = &quot;Started&quot;;</span>
<span class="fc" id="L58">            } catch (Exception e) {</span>
<span class="fc" id="L59">                result = &quot;Failed to bootstrap: &quot; + e.getMessage();</span>
<span class="fc" id="L60">            }</span>
        }
<span class="fc" id="L62">        return result;</span>
    }

    @PostMapping(&quot;/shutdown&quot;)
    String shutdown() {
<span class="nc" id="L67">        ehrDataMigrationBootstrapper.shutdown();</span>
<span class="nc" id="L68">        return &quot;Shut down&quot;;</span>
    }

    @PostMapping(&quot;/eraseStatus&quot;)
    String eraseStatus() {
<span class="fc bfc" id="L73" title="All 2 branches covered.">        if (ehrDataMigrationBootstrapper.tearDownProcesses()) {</span>
<span class="fc" id="L74">            return &quot;Erased&quot;;</span>
        } else {
<span class="fc" id="L76">            return &quot;Failed to tear down, please wait for running processes to finish&quot;;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>