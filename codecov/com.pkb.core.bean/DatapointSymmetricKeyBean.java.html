<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DatapointSymmetricKeyBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.core.bean</a> &gt; <span class="el_source">DatapointSymmetricKeyBean.java</span></div><h1>DatapointSymmetricKeyBean.java</h1><pre class="source lang-java linenums">package com.pkb.core.bean;

import com.pkb.app.dto.AccountSymmetricKeyDto;
import com.pkb.core.DatapointSymmetricKeyLocal;
import com.pkb.core.DatapointSymmetricKeyRemote;
import com.pkb.core.entity.DatapointSymmetricKey;
import com.pkb.crypto.AccountKeys;
import com.pkb.crypto.EncryptedBytesAndNonce;
import com.pkb.crypto.SymmetricKey;
import com.pkb.entities.enums.core.EncryptionAlgorithm;
import com.pkb.util.DbUtil;

import javax.ejb.Local;
import javax.ejb.Remote;
import javax.ejb.Stateless;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.UUID;

@Stateless(mappedName = &quot;DatapointSymmetricKeyBean&quot;)
@Local(DatapointSymmetricKeyLocal.class)
@Remote(DatapointSymmetricKeyRemote.class)
<span class="fc" id="L30">public class DatapointSymmetricKeyBean implements DatapointSymmetricKeyRemote, DatapointSymmetricKeyLocal {</span>

    @PersistenceContext
    private EntityManager em;

    @Override
    public Optional&lt;DatapointSymmetricKey&gt; findDatapointLevelKey(UUID keyId, long accountId) {
<span class="fc" id="L37">        TypedQuery&lt;DatapointSymmetricKey&gt; query = em.createQuery(</span>
                        &quot;SELECT dsk FROM DatapointSymmetricKey dsk \n&quot; +
                                &quot;WHERE dsk.keyId = :keyId\n&quot; +
                                &quot;AND dsk.accountId = :accountId\n&quot;,
                        DatapointSymmetricKey.class)
<span class="fc" id="L42">                .setParameter(&quot;keyId&quot;, keyId)</span>
<span class="fc" id="L43">                .setParameter(&quot;accountId&quot;, accountId);</span>

<span class="fc" id="L45">        return Optional.ofNullable(DbUtil.getExactlyOneResultOrNull(query));</span>
    }

    @Override
    public Optional&lt;DatapointSymmetricKey&gt; findDatapointLevelKey(UUID keyId, Collection&lt;Long&gt; accountIds) {
<span class="fc" id="L50">        List&lt;DatapointSymmetricKey&gt; datapointSymmetricKeys = em.createQuery(</span>
                        &quot;SELECT dsk FROM DatapointSymmetricKey dsk \n&quot; +
                                &quot;WHERE dsk.keyId = :keyId\n&quot; +
                                &quot;AND dsk.accountId IN (:accountIds)&quot;,
                        DatapointSymmetricKey.class)
<span class="fc" id="L55">                .setParameter(&quot;keyId&quot;, keyId)</span>
<span class="fc" id="L56">                .setParameter(&quot;accountIds&quot;, accountIds)</span>
<span class="fc" id="L57">                .getResultList();</span>

<span class="fc bfc" id="L59" title="All 2 branches covered.">        if (datapointSymmetricKeys.isEmpty()) {</span>
<span class="fc" id="L60">            return Optional.empty();</span>
        }

<span class="fc" id="L63">        return Optional.of(datapointSymmetricKeys.get(0));</span>
    }

    @Override
    public List&lt;DatapointSymmetricKey&gt; findDatapointLevelKeys(Collection&lt;UUID&gt; keyIds, Collection&lt;Long&gt; accountIds) {
<span class="fc bfc" id="L68" title="All 2 branches covered.">        if (accountIds.size() &lt;= keyIds.size()) {</span>
<span class="fc" id="L69">            return DbUtil.getInBatches(keyIds, batch -&gt; em.createQuery(</span>
                            &quot;SELECT dsk FROM DatapointSymmetricKey dsk \n&quot; +
                                    &quot;WHERE dsk.keyId IN (:keyIds)\n&quot; +
                                    &quot;AND dsk.accountId IN (:accountIds)\n&quot;,
                            DatapointSymmetricKey.class)
<span class="fc" id="L74">                    .setParameter(&quot;keyIds&quot;, batch)</span>
<span class="fc" id="L75">                    .setParameter(&quot;accountIds&quot;, accountIds)</span>
<span class="fc" id="L76">                    .getResultList());</span>
        } else {
<span class="fc" id="L78">            return DbUtil.getInBatches(accountIds, batch -&gt; em.createQuery(</span>
                            &quot;SELECT dsk FROM DatapointSymmetricKey dsk \n&quot; +
                                    &quot;WHERE dsk.keyId IN (:keyIds)\n&quot; +
                                    &quot;AND dsk.accountId IN (:accountIds)\n&quot;,
                            DatapointSymmetricKey.class)
<span class="fc" id="L83">                    .setParameter(&quot;keyIds&quot;, keyIds)</span>
<span class="fc" id="L84">                    .setParameter(&quot;accountIds&quot;, batch)</span>
<span class="fc" id="L85">                    .getResultList());</span>
        }
    }

    @Override
    public DatapointSymmetricKey saveDatapointLevelKey(long accountId, SymmetricKey dplKey, AccountSymmetricKeyDto accountSymmetricKey) {
<span class="fc" id="L91">        DatapointSymmetricKey dsk = newDplKey(UUID.randomUUID(), accountId, dplKey, accountSymmetricKey);</span>
<span class="fc" id="L92">        em.persist(dsk);</span>
<span class="fc" id="L93">        return dsk;</span>
    }

    @Override
    public List&lt;DatapointSymmetricKey&gt; copyDatapointLevelKeys(List&lt;UUID&gt; keyIds, long currentAccountId, AccountKeys currentAccountKeys, Map&lt;Long, AccountSymmetricKeyDto&gt; newAccountKeys) {
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">        if (keyIds.isEmpty()) {</span>
<span class="nc" id="L99">            return Collections.emptyList();</span>
        }

<span class="fc" id="L102">        List&lt;DatapointSymmetricKey&gt; dplKeys = findDatapointLevelKeys(keyIds, Collections.singletonList(currentAccountId));</span>
<span class="fc" id="L103">        List&lt;DatapointSymmetricKey&gt; newKeys = new ArrayList&lt;&gt;(keyIds.size() * newAccountKeys.size());</span>

<span class="fc" id="L105">        dplKeys.forEach(dplKeyRecord -&gt; {</span>
<span class="fc" id="L106">            byte[] decryptedBytes = currentAccountKeys.getSymmetricKeys().get(dplKeyRecord.getAccountLevelKeyId()).decrypt(dplKeyRecord.getEncryptedKey(), dplKeyRecord.getNonce());</span>
<span class="fc" id="L107">            SymmetricKey dplKey = SymmetricKey.symmetricKey(decryptedBytes, dplKeyRecord.getEncryptionAlgorithm().toString());</span>
<span class="fc" id="L108">            List&lt;Long&gt; accountsThatHaveThisKey = findAccountIdsForKey(dplKeyRecord.getKeyId());</span>
<span class="fc" id="L109">            newAccountKeys.forEach((accountId, newAccountKey) -&gt; {</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">                if (!accountsThatHaveThisKey.contains(accountId)) {</span>
<span class="fc" id="L111">                    DatapointSymmetricKey newDplKey = newDplKey(dplKeyRecord.getKeyId(), accountId, dplKey, newAccountKey);</span>
<span class="fc" id="L112">                    em.persist(newDplKey);</span>
<span class="fc" id="L113">                    newKeys.add(newDplKey);</span>
                }
<span class="fc" id="L115">            });</span>
<span class="fc" id="L116">        });</span>

<span class="fc" id="L118">        return newKeys;</span>
    }

    private List&lt;Long&gt; findAccountIdsForKey(UUID keyId) {
<span class="fc" id="L122">        return em.createQuery(</span>
                        &quot;SELECT dsk.accountId FROM DatapointSymmetricKey dsk \n&quot; +
                                &quot;WHERE dsk.keyId = :keyId&quot;)
<span class="fc" id="L125">                .setParameter(&quot;keyId&quot;, keyId)</span>
<span class="fc" id="L126">                .getResultList();</span>
    }

    private DatapointSymmetricKey newDplKey(UUID keyId, long accountId, SymmetricKey dplKey, AccountSymmetricKeyDto accountSymmetricKey) {
<span class="fc" id="L130">        DatapointSymmetricKey dsk = new DatapointSymmetricKey();</span>
<span class="fc" id="L131">        dsk.setKeyId(keyId);</span>
<span class="fc" id="L132">        dsk.setAccountId(accountId);</span>
<span class="fc" id="L133">        EncryptedBytesAndNonce bytesAndNonce = accountSymmetricKey.key().encrypt(dplKey.getKeyBytes());</span>
<span class="fc" id="L134">        dsk.setEncryptedKey(bytesAndNonce.encryptedBytes());</span>
<span class="fc" id="L135">        dsk.setEncryptionAlgorithm(EncryptionAlgorithm.valueOf(dplKey.getAlgorithm()));</span>
<span class="fc" id="L136">        dsk.setNonce(bytesAndNonce.nonce());</span>
<span class="fc" id="L137">        dsk.setAccountLevelKeyId(accountSymmetricKey.id());</span>
<span class="fc" id="L138">        return dsk;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>