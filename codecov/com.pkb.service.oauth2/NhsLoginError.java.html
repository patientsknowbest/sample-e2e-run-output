<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NhsLoginError.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.oauth2</a> &gt; <span class="el_source">NhsLoginError.java</span></div><h1>NhsLoginError.java</h1><pre class="source lang-java linenums">package com.pkb.service.oauth2;

import com.google.common.annotations.VisibleForTesting;
import com.pkb.common.base.Error;
import com.pkb.datamodel.user.PersonIdsWithNhsLoginStatus;
import com.pkb.dto.NhsLoginInfo;
import com.pkb.kms.shared.representation.KmsError;
import io.prometheus.client.Counter;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.invoke.MethodHandles;
import java.util.Optional;

import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.Match;

public class NhsLoginError extends Error {

    public static final String PERSON_DEMOGRAPHICS_CONFLICT = &quot;demographics.conflict&quot;;
    public static final String PERSON_DIFFERENT_RECORDS = &quot;different.records&quot;;
    public static final String PERSON_DOES_NOT_EXIST = &quot;does.not.exist&quot;;
    public static final String PERSON_EXISTS_BUT_NO_NHS_CREDENTIALS = &quot;no.nhs.credentials&quot;;
    public static final String PERSON_MISSING_DEFAULT_ACCOUNT_ID = &quot;missing.defaultaccountid&quot;;
    public static final String PERSON_NOT_PATIENT = &quot;not.patient&quot;;
    public static final String PERSON_OUT_OF_AREA = &quot;out.of.area&quot;;
    public static final String PERSON_UNDER_AGE_LIMIT = &quot;age.limit&quot;;
    public static final String BAD_CREDENTIALS_ERROR = &quot;bad.credentials&quot;;
    public static final String PERSON_IS_DEAD = &quot;contact.team.for.access&quot;;
    public static final String PERSON_HAS_ACCESS_FROZEN = &quot;person.has.access.frozen&quot;;

    private static final String INVALID_NHS_NUMBER_ERROR = &quot;invalid.nhs.number.error&quot;;
    private static final String UNEXPECTED_REPOSITORY_ERROR = &quot;unexpected.repository.error&quot;;
    private static final String UNEXPECTED_KMS_ERROR = &quot;unexpected.kms.error&quot;;

<span class="fc" id="L38">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

<span class="fc" id="L40">    private static final Counter PHR_8050_BAD_NEW_CREDENTIALS_COUNTER = Counter.build()</span>
<span class="fc" id="L41">            .name(&quot;pkb_integrations_nhslogin_bad_credentials&quot;)</span>
<span class="fc" id="L42">            .labelNames(&quot;newMetadata&quot;, &quot;forceNewMetadata&quot;)</span>
<span class="fc" id="L43">            .help(&quot;Number of invalid credentials provided, with creation state&quot;)</span>
<span class="fc" id="L44">            .register();</span>

    private Optional&lt;PersonIdsWithNhsLoginStatus&gt; personIds;

    private Optional&lt;Long&gt; personId;

    @VisibleForTesting
    public NhsLoginError(@NotNull String errorCode, Optional&lt;PersonIdsWithNhsLoginStatus&gt; personIds, @NotNull String description, String... arguments) {
<span class="fc" id="L52">        super(errorCode, description, arguments);</span>
<span class="fc" id="L53">        this.personIds = personIds;</span>
<span class="fc" id="L54">        this.personId = Optional.empty();</span>
<span class="fc" id="L55">    }</span>

    @VisibleForTesting
    public NhsLoginError(@NotNull String errorCode, long personId, @NotNull String description, String... arguments) {
<span class="fc" id="L59">        super(errorCode, description, arguments);</span>
<span class="fc" id="L60">        this.personId = Optional.of(personId);</span>
<span class="fc" id="L61">        this.personIds = Optional.empty();</span>
<span class="fc" id="L62">    }</span>

    public Optional&lt;PersonIdsWithNhsLoginStatus&gt; getPersonIds() {
<span class="fc" id="L65">        return personIds;</span>
    }

    public Optional&lt;Long&gt; getPersonId() {
<span class="fc" id="L69">        return personId;</span>
    }

    static NhsLoginError ofKmsError(PersonIdsWithNhsLoginStatus personIdsWithNhsLoginStatus, NhsLoginInfo info, KmsError error) {
<span class="fc" id="L73">        return Match(error.getError()).of(</span>
<span class="fc" id="L74">                Case($(&quot;nhslogin.credentials.not.found&quot;), $ -&gt; noCredentials(personIdsWithNhsLoginStatus)),</span>
<span class="fc" id="L75">                Case($(&quot;user.private.key.decryption.failed&quot;), $ -&gt; brokenCredentials(personIdsWithNhsLoginStatus, info)),</span>
<span class="pc" id="L76">                Case($(), $ -&gt; unexpectedKmsError(personIdsWithNhsLoginStatus, error)));</span>
    }

    @VisibleForTesting
    public static NhsLoginError unexpectedKmsError(PersonIdsWithNhsLoginStatus personIdsWithNhsLoginStatus, KmsError error) {
<span class="nc" id="L81">        return new NhsLoginError(UNEXPECTED_KMS_ERROR,</span>
<span class="nc" id="L82">                                 Optional.of(personIdsWithNhsLoginStatus),</span>
                                 &quot;Unexpected error from kms %s&quot;,
<span class="nc" id="L84">                                 error.toString());</span>
    }

    @VisibleForTesting
    public static NhsLoginError unexpectedRepositoryError(PersonIdsWithNhsLoginStatus idsWithStatus) {
<span class="nc" id="L89">        return new NhsLoginError(UNEXPECTED_REPOSITORY_ERROR, idsWithStatus.getId(), &quot;Unexpected error %s&quot;, idsWithStatus.getNhsLoginStatus().name());</span>
    }

    @VisibleForTesting
    public static NhsLoginError invalidNhsNumberError(String nhsNumber) {
<span class="fc" id="L94">        return new NhsLoginError(INVALID_NHS_NUMBER_ERROR, Optional.empty(), &quot;Invalid NHS number %s&quot;, nhsNumber);</span>
    }

    @VisibleForTesting
    public static NhsLoginError personDoesNotExist() {
<span class="fc" id="L99">        return new NhsLoginError(PERSON_DOES_NOT_EXIST, Optional.empty(), &quot;Person does not exist&quot;);</span>
    }

    @VisibleForTesting
    public static NhsLoginError noCredentials(PersonIdsWithNhsLoginStatus personIdsWithNhsLoginStatus) {
<span class="fc" id="L104">        return new NhsLoginError(PERSON_EXISTS_BUT_NO_NHS_CREDENTIALS,</span>
<span class="fc" id="L105">                Optional.of(personIdsWithNhsLoginStatus),</span>
                &quot;Person %s found, but they have no NHS credentials&quot;,
<span class="fc" id="L107">                personIdsWithNhsLoginStatus.getPublicId().toString());</span>
    }

    @VisibleForTesting
    public static NhsLoginError brokenCredentials(PersonIdsWithNhsLoginStatus personIdsWithNhsLoginStatus, NhsLoginInfo info) {

        // PHR-8050. If we got a decryption failure, check the state of the metadata flags to figure out what oidc did
<span class="pc bpc" id="L114" title="3 of 4 branches missed.">        if (info.isNewMetadata() &amp;&amp; !info.isForceNewMetadata()) {</span>
<span class="nc" id="L115">            LOGGER.error(&quot;PHR-8050: Invalid new credentials received for person {}&quot;, personIdsWithNhsLoginStatus.getPublicId());</span>
        }
<span class="fc" id="L117">        PHR_8050_BAD_NEW_CREDENTIALS_COUNTER</span>
<span class="fc" id="L118">                .labels(String.valueOf(info.isNewMetadata()), String.valueOf(info.isForceNewMetadata()))</span>
<span class="fc" id="L119">                .inc();</span>

<span class="fc" id="L121">        return new NhsLoginError(BAD_CREDENTIALS_ERROR, Optional.of(personIdsWithNhsLoginStatus),</span>
                &quot;Person %s found, but provided NHS credentials are not valid&quot;,
<span class="fc" id="L123">                personIdsWithNhsLoginStatus.getPublicId().toString());</span>
    }

    @VisibleForTesting
    public static NhsLoginError demographicsConflict() {
<span class="nc" id="L128">        return new NhsLoginError(PERSON_DEMOGRAPHICS_CONFLICT, Optional.empty(), &quot;Conflicting error in demographics&quot;);</span>
    }

    @VisibleForTesting
    public static NhsLoginError differentRecords() {
<span class="fc" id="L133">        return new NhsLoginError(PERSON_DIFFERENT_RECORDS, Optional.empty(), &quot;Existing email and NHS number in PKB belonging to different records&quot;);</span>
    }

    @VisibleForTesting
    public static NhsLoginError unregisteredPerson(PersonIdsWithNhsLoginStatus idsWithNhsLoginStatus) {
<span class="fc" id="L138">        return new NhsLoginError(PERSON_OUT_OF_AREA, Optional.of(idsWithNhsLoginStatus), &quot;Existing person in PKB but not fully registered&quot;);</span>
    }

    @VisibleForTesting
    public static NhsLoginError ageLimitNotReached() {
<span class="fc" id="L143">        return new NhsLoginError(PERSON_UNDER_AGE_LIMIT, Optional.empty(), &quot;Age limit is not reached.&quot;);</span>
    }

    @VisibleForTesting
    public static NhsLoginError personIsNotPatient(long id) {
<span class="fc" id="L148">        return new NhsLoginError(PERSON_NOT_PATIENT, id, &quot;Existing person is not a patient.&quot;);</span>
    }

    @VisibleForTesting
    public static NhsLoginError missingDefaultAccountId(long id) {
<span class="fc" id="L153">        return new NhsLoginError(PERSON_MISSING_DEFAULT_ACCOUNT_ID, id, &quot;DefaultAcountId is null.&quot;);</span>
    }

    @VisibleForTesting
    public static NhsLoginError personIsDead(long id) {
<span class="fc" id="L158">        return new NhsLoginError(PERSON_IS_DEAD, id, &quot;Person is marked deceased in PKB.&quot;);</span>
    }

    @VisibleForTesting
    public static NhsLoginError personHasAccessFrozen(long id) {
<span class="fc" id="L163">        return new NhsLoginError(PERSON_HAS_ACCESS_FROZEN, id, &quot;Person has access frozen in PKB.&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>