<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DefaultCacheHeadersFilter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.servlets.filter</a> &gt; <span class="el_source">DefaultCacheHeadersFilter.java</span></div><h1>DefaultCacheHeadersFilter.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------
//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: SubscriptionVerificationFilter.java Jun 10, 2009 11:59:39 AM prabodhs$
//
//------------------------------------------------------------------------------

package com.pkb.servlets.filter;

import com.pkb.common.config.PhrConfig;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.regex.Pattern;

<span class="fc" id="L27">public class DefaultCacheHeadersFilter implements Filter {</span>

<span class="fc" id="L29">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private static final int YEAR_IN_SECONDS = 365 * 24 * 60 * 60;
    private static final int MINUTE_IN_SECONDS = 60;

    // TODO: PHR-5575
    // TODO: It's not applied to each request. Security filters are disabled for certain URIs
    // TODO: Nevertheless it seems to be needless. Struts was upgraded some time ago.
    // workaround CVE-2017-5638
<span class="fc" id="L38">    private static Pattern cve_2017_5638 = Pattern.compile(&quot;[%{#]&quot;);</span>

    @Autowired
    private PhrConfig config;

    @Override
    public void init(FilterConfig filterConfig) throws ServletException {
<span class="nc" id="L45">    }</span>

    /**
     * Exclude .jsp and .action URIs -- set no-cache headers on all other resources.
     * This filter will be unused in the production environment (where Tomcat will ONLY
     * handle .jsp and .action URIs) but is still useful for development.
     */
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
<span class="pc bpc" id="L55" title="1 of 4 branches missed.">        if (request.getContentType() != null &amp;&amp; cve_2017_5638.matcher(request.getContentType()).find()) {</span>
<span class="nc" id="L56">            String emsg = &quot;Content header contains suspicious characters, throwing the request away. Content-type was &quot;</span>
<span class="nc" id="L57">                    + request.getContentType();</span>
<span class="nc" id="L58">            LOGGER.error(emsg);</span>
<span class="nc" id="L59">            throw new ServletException(emsg);</span>
        }
<span class="fc" id="L61">        LOGGER.trace(&quot;Enter doFilter &quot;);</span>
<span class="fc" id="L62">        HttpServletRequest httpRequest = (HttpServletRequest) request;</span>
<span class="fc" id="L63">        HttpServletResponse httpResponse = (HttpServletResponse) response;</span>

<span class="fc" id="L65">        String URI = httpRequest.getRequestURI();</span>
<span class="pc bpc" id="L66" title="1 of 2 branches missed.">        if (URI == null) {</span>
<span class="nc" id="L67">            URI = &quot;&quot;;</span>
        }

<span class="pc bpc" id="L70" title="1 of 2 branches missed.">        if (config.isClientCachingOfStaticFilesEnabled() &amp;&amp;</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">                (URI.endsWith(&quot;.js&quot;) ||</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">                        URI.endsWith(&quot;.css&quot;) ||</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">                        URI.endsWith(&quot;.swf&quot;) ||</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">                        URI.endsWith(&quot;.png&quot;) ||</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">                        URI.endsWith(&quot;.jpg&quot;) ||</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">                        URI.endsWith(&quot;.woff&quot;) ||</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">                        URI.endsWith(&quot;.woff2&quot;) ||</span>
<span class="fc bfc" id="L78" title="All 2 branches covered.">                        URI.endsWith(&quot;.gif&quot;) ||</span>
<span class="pc bpc" id="L79" title="1 of 2 branches missed.">                        URI.endsWith(&quot;.ttf&quot;) ||</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">                        URI.endsWith(&quot;.eot&quot;))) {</span>

<span class="pc bpc" id="L82" title="1 of 2 branches missed.">            if (URI.startsWith(config.getInstituteLogoBaseDir())) {</span>
<span class="nc" id="L83">                httpResponse.addHeader(&quot;Cache-Control&quot;, &quot;max-age=&quot; + 10 * MINUTE_IN_SECONDS);</span>
            } else {
<span class="fc" id="L85">                httpResponse.addHeader(&quot;Cache-Control&quot;, &quot;max-age=&quot; + YEAR_IN_SECONDS);</span>
            }
<span class="fc bfc" id="L87" title="All 2 branches covered.">        } else if (!URI.endsWith(&quot;.jsp&quot;) &amp;&amp;</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">                !URI.endsWith(&quot;.action&quot;)) {</span>
<span class="fc" id="L89">            httpResponse.setHeader(&quot;Cache-Control&quot;, &quot;max-age=0, no-store, no-cache, must-revalidate&quot;);</span>
<span class="fc" id="L90">            httpResponse.setHeader(&quot;Pragma&quot;, &quot;no-cache&quot;);</span>
<span class="fc" id="L91">            httpResponse.setDateHeader(&quot;Expires&quot;, 0); // prevents caching at the</span>
                                                      // proxy server
        }

<span class="fc" id="L95">        chain.doFilter(request, response);</span>

<span class="fc" id="L97">        LOGGER.trace(&quot;Exit doFilter&quot;);</span>
<span class="fc" id="L98">    }</span>

    @Override
    public void destroy() {
        //		log.info(&quot;Enter destroy&quot;);
        //		log.info(&quot;Exit destroy&quot;);
<span class="nc" id="L104">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>