<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CryptoAccessGrantService.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.backgroundtasks.service</a> &gt; <span class="el_source">CryptoAccessGrantService.kt</span></div><h1>CryptoAccessGrantService.kt</h1><pre class="source lang-java linenums">package com.pkb.backgroundtasks.service

import com.pkb.backgroundtasks.AccountPublicId
import com.pkb.backgroundtasks.OrgPrivateId
import com.pkb.backgroundtasks.entity.OrgAccessTaskComplete
import com.pkb.backgroundtasks.entity.OrgAccessTaskPending
import com.pkb.backgroundtasks.repository.AccountRepository
import com.pkb.backgroundtasks.repository.OrgAccessTaskCompleteRepository
import com.pkb.backgroundtasks.repository.OrgAccessTaskPendingRepository
import com.pkb.backgroundtasks.routing.CryptoAccessGrantRouteBuilder
import com.pkb.backgroundtasks.routing.KeyAvailableRouteBuilder
import com.pkb.backgroundtasks.service.taskexecutors.GrantOrgAccessTaskDetails
import com.pkb.backgroundtasks.util.RequestIdUtil
import com.pkb.domain.pubsub.payload.GrantAccessToOrgRequest
import com.pkb.domain.pubsub.payload.GrantOrgAccessRequest
import com.pkb.kms.client.core.Kms
import com.pkb.kms.shared.representation.GrantUserAccessToAccountRequest
import com.pkb.kms.shared.representation.KmsError
import com.pkb.kms.shared.structures.pubsub.KeyAvailable
import org.apache.camel.Consume
import org.slf4j.Logger
import org.slf4j.LoggerFactory
import org.springframework.data.repository.findByIdOrNull
import org.springframework.scheduling.annotation.Scheduled
import org.springframework.stereotype.Service
import java.lang.invoke.MethodHandles
import java.util.UUID

<span class="fc" id="L29">@Service</span>
<span class="fc" id="L30">class CryptoAccessGrantService(</span>
<span class="fc" id="L31">    private val pendingRepo: OrgAccessTaskPendingRepository,</span>
<span class="fc" id="L32">    private val completeRepo: OrgAccessTaskCompleteRepository,</span>
<span class="fc" id="L33">    private val accountRepo: AccountRepository,</span>
<span class="fc" id="L34">    private val accountTaskService: AccountTaskService,</span>
<span class="fc" id="L35">    private val kms: Kms,</span>
<span class="fc" id="L36">    private val requestIdUtil: RequestIdUtil</span>
) {

<span class="fc" id="L39">    private val log: Logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass())</span>

    //Run once on startup
    @Scheduled(
        initialDelay = 0,
        fixedDelay = Long.MAX_VALUE
    )
    fun processBackLog() {
<span class="nc" id="L47">        val orgAccountCache = HashMap&lt;OrgPrivateId, AccountPublicId&gt;()</span>
<span class="nc" id="L48">        pendingRepo.processAllPendingRows {</span>
<span class="nc" id="L49">            grantAccess(orgAccountCache.computeIfAbsent(it.orgId, accountRepo::getOrgAccountPublicId), it)</span>
<span class="nc" id="L50">        }</span>
<span class="nc" id="L51">    }</span>

    @Consume(CryptoAccessGrantRouteBuilder.INBOUND_GRANT_ORG_ACCESS_REQUEST)
    fun queueOrgAccessGrant(request: GrantOrgAccessRequest) {
<span class="fc" id="L55">        accountTaskService.enqueueTask(UUID.fromString(request.personAccountPublicId), GrantOrgAccessTaskDetails(listOf(UUID.fromString(request.orgPublicId))))</span>
<span class="fc" id="L56">    }</span>

    @Consume(CryptoAccessGrantRouteBuilder.INBOUND_GRANT_ACCESS_TO_ORG_REQUEST)
    fun queueAccessToOrgGrant(request: GrantAccessToOrgRequest) {
<span class="fc" id="L60">        pendingRepo.save(OrgAccessTaskPending(UUID.randomUUID(), request.orgPrivateId, UUID.fromString(request.personPublicId)))</span>
<span class="fc" id="L61">    }</span>


    @Consume(KeyAvailableRouteBuilder.INBOUND_ORG_ACCOUNT_KEY_AVAILABLE)
    fun triggerTasks(keyAvailable: KeyAvailable) {
<span class="fc" id="L66">        triggerForOrg(keyAvailable.orgPrivateId)</span>
<span class="fc" id="L67">    }</span>

    fun triggerForOrg(orgPrivateId: OrgPrivateId) {
<span class="fc" id="L70">        val pending = pendingRepo.getPendingForOrgId(orgPrivateId)</span>
<span class="fc" id="L71">        val orgAccountId = accountRepo.getOrgAccountPublicId(orgPrivateId)</span>
<span class="fc" id="L72">        pending.forEach { grantAccess(orgAccountId, it) }</span>
<span class="fc" id="L73">    }</span>

    private fun grantAccess(orgAccountId: AccountPublicId, pending: OrgAccessTaskPending) =
<span class="fc" id="L76">        kms.grantAccessToAccountTrusted(requestIdUtil.getRequestId(), GrantUserAccessToAccountRequest(orgAccountId, pending.personPublicId))</span>
<span class="fc" id="L77">            .map {</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">                completeRepo.findByIdOrNull(pending.id) ?: completeRepo.saveWithNewTransaction(OrgAccessTaskComplete(pending, requestIdUtil.getRequestId()))</span>
            }
<span class="pc" id="L80">            .peekLeft { error -&gt;</span>
<span class="nc bnc" id="L81" title="All 2 branches missed.">                if (error.type == KmsError.Type.NOT_FOUND) {</span>
<span class="nc" id="L82">                    log.info(&quot;Org key not available from KMS for org {}&quot;, pending.orgId)</span>
                } else {
<span class="nc" id="L84">                    log.error(&quot;Error attempting to grant access to org account of {} for user {}&quot;, pending.orgId, pending.personPublicId)</span>
                }
<span class="pc" id="L86">            }</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>