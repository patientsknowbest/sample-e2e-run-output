<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TeamManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.team</a> &gt; <span class="el_source">TeamManager.java</span></div><h1>TeamManager.java</h1><pre class="source lang-java linenums">package com.pkb.service.team;

import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.datamodel.team.TeamWithOrg;
import com.pkb.domain.TeamResearchPartnerService;
import com.pkb.domain.duplicate.TeamDomainService;
import com.pkb.dto.TeamResearchPartnerDto;
import com.pkb.entities.enums.OrgExternalIdType;
import com.pkb.entities.enums.ResearchScope;
import com.pkb.entities.enums.SponsorshipStatus;
import com.pkb.exception.MailException;
import com.pkb.exception.TeamNotFoundException;
import com.pkb.institute.entity.InstituteUserEntity;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import com.pkb.mappers.TeamResearchPartnerMapper;
import com.pkb.repository.legacy.LegacyInstituteUserRepository;
import com.pkb.repository.legacy.LegacyOrgRepository;
import com.pkb.repository.legacy.LegacyTeamRepository;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.instituteuser.InstituteUserManager;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.TeamLevelIdType;
import com.pkb.util.tolven.TolvenBeanFactory;
import com.pkb.util.tolven.TransactionManager;
import io.vavr.control.Try;
import org.apache.commons.lang3.StringUtils;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;

import java.time.Instant;
import java.util.Arrays;
import java.util.Collection;
import java.util.Date;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.TreeSet;
import java.util.UUID;
import java.util.stream.Collectors;

import static java.lang.String.format;
import static java.util.Collections.emptyList;
import static org.apache.commons.collections4.CollectionUtils.isEmpty;

public class TeamManager extends TransactionManager {

    private PKBEmailMessageManager emailMessageManager;
    private final TeamResearchPartnerService teamResearchPartnerService;
    private final TeamResearchPartnerMapper teamResearchPartnerMapper;
    private final TeamDomainService teamDomainService;
    private final LegacyTeamRepository teamRepository;
    private final LegacyInstituteUserRepository instituteUserRepository;
    private final InstituteUserManager instituteUserManager;
    private final LegacyOrgRepository orgRepository;

    public TeamManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider,
                       TeamResearchPartnerService teamResearchPartnerService, TeamResearchPartnerMapper teamResearchPartnerMapper,
                       TeamDomainService teamDomainService, LegacyTeamRepository teamRepository,
                       LegacyInstituteUserRepository instituteUserRepository, InstituteUserManager instituteUserManager,
                       LegacyOrgRepository orgRepository) {
<span class="fc" id="L65">        super(config, beanFactory, dateTimeService, uuidProvider);</span>
<span class="fc" id="L66">        this.teamResearchPartnerService = teamResearchPartnerService;</span>
<span class="fc" id="L67">        this.teamResearchPartnerMapper = teamResearchPartnerMapper;</span>
<span class="fc" id="L68">        this.teamDomainService = teamDomainService;</span>
<span class="fc" id="L69">        this.teamRepository = teamRepository;</span>
<span class="fc" id="L70">        this.instituteUserRepository = instituteUserRepository;</span>
<span class="fc" id="L71">        this.instituteUserManager = instituteUserManager;</span>
<span class="fc" id="L72">        this.orgRepository = orgRepository;</span>
<span class="fc" id="L73">    }</span>

    public Map&lt;ResearchScope, TeamResearchPartnerDto&gt; getResearchPartners(Long teamId) {
<span class="fc" id="L76">        return teamResearchPartnerMapper.entitiesToDtoMap(teamResearchPartnerService.findAllByTeamId(teamId));</span>
    }

    public void setResearchPartners(Long teamId, Map&lt;ResearchScope, TeamResearchPartnerDto&gt; partners) {
<span class="fc" id="L80">        teamResearchPartnerService.setResearchPartners(teamResearchPartnerMapper.dtoMapToEntities(teamId, partners));</span>
<span class="fc" id="L81">    }</span>

    //FIXME Circular dependency...
    public void setEmailMessageManager(PKBEmailMessageManager emailMessageManager) {
<span class="fc" id="L85">        this.emailMessageManager = emailMessageManager;</span>
<span class="fc" id="L86">    }</span>

    /**
     * Create Team
     *
     * @param team {@link Team} object
     * @return team id
     */
    public long createTeam(Team team) {
        // ensure it has at least one team-level ID type
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">        if (team.getTeamLevelIdTypes().isEmpty()) {</span>
<span class="fc" id="L97">            TeamLevelIdType idType = new TeamLevelIdType();</span>
<span class="fc" id="L98">            idType.setName(team.getName() + &quot; ID&quot;);</span>
<span class="fc" id="L99">            idType.setTeam(team);</span>
<span class="fc" id="L100">            idType.setHl7AssigningAuthority(&quot;&quot;);</span>
<span class="fc" id="L101">            idType.setHl7TypeCode(&quot;&quot;);</span>
<span class="fc" id="L102">            team.setTeamLevelIdTypes(new TreeSet&lt;&gt;(Arrays.asList(idType)));</span>
        }
<span class="fc" id="L104">        return teamRepository.saveAndFlush(team).getId();</span>
    }


    /**
     * Get team object by id
     *
     * @param teamId
     * @return
     */
    @Nullable
    public Team getTeam(Long teamId, Team.Lazy... fields) {
        // shortcut if no valid id
<span class="pc bpc" id="L117" title="1 of 4 branches missed.">        if ((teamId == null) || (teamId.intValue() &lt;= 0)) {</span>
<span class="fc" id="L118">            return null;</span>
        }

<span class="fc" id="L121">        return teamRepository.getInstitute(teamId, fields);</span>
    }

    public List&lt;Team&gt; getTeams(Collection&lt;Long&gt; teamId, Team.Lazy... fields) {
<span class="fc bfc" id="L125" title="All 2 branches covered.">        if (isEmpty(teamId)) {</span>
<span class="fc" id="L126">            return emptyList();</span>
        }
<span class="fc" id="L128">        Set&lt;Long&gt; validIds = teamId.stream()</span>
<span class="pc bpc" id="L129" title="1 of 2 branches missed.">                .filter(id -&gt; 0 &lt; id) // Original impl. does it see above...</span>
<span class="fc" id="L130">                .collect(Collectors.toSet());</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">        if (isEmpty(validIds)) {</span>
<span class="nc" id="L132">            return emptyList();</span>
        }
<span class="fc" id="L134">        return teamRepository.getInstitutes(validIds, fields);</span>
    }

    public Optional&lt;Org&gt; getOrg(Long orgId, Org.Lazy... fields) {
        // shortcut if no valid id
<span class="pc bpc" id="L139" title="2 of 4 branches missed.">        if ((orgId == null) || (orgId &lt;= 0)) {</span>
<span class="nc" id="L140">            return Optional.empty();</span>
        }
<span class="fc" id="L142">        return orgRepository.getOrg(orgId, fields);</span>
    }

    public List&lt;Org&gt; getOrgs(Collection&lt;Long&gt; orgIds, Org.Lazy... fields) {
<span class="fc bfc" id="L146" title="All 2 branches covered.">        if (isEmpty(orgIds)) {</span>
<span class="fc" id="L147">            return emptyList();</span>
        }
<span class="fc" id="L149">        Set&lt;Long&gt; validIds = orgIds.stream()</span>
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">                .filter(id -&gt; 0 &lt; id) // Original impl. does it see above...</span>
<span class="fc" id="L151">                .collect(Collectors.toSet());</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">        if (isEmpty(validIds)) {</span>
<span class="nc" id="L153">            return emptyList();</span>
        }
<span class="fc" id="L155">        return orgRepository.getOrgs(validIds, fields);</span>
    }

    public Optional&lt;Org&gt; getOrgByCode(String orgCode, Org.Lazy... fields) {
        // shortcut if no valid id
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        if (orgCode == null) {</span>
<span class="nc" id="L161">            return Optional.empty();</span>
        }
<span class="fc" id="L163">        return orgRepository.getOrgByCode(orgCode, fields);</span>
    }

    public List&lt;Org&gt; getOrgByCodes(Collection&lt;String&gt; orgCodes, Org.Lazy... fields) {
<span class="fc bfc" id="L167" title="All 2 branches covered.">        if (isEmpty(orgCodes)) {</span>
<span class="fc" id="L168">            return emptyList();</span>
        }
<span class="fc" id="L170">        return orgRepository.getOrgsByCodes(orgCodes, fields);</span>
    }

    public Optional&lt;Org&gt; getOrgByOrgExternalIdType(OrgExternalIdType idType, String idValue, Org.Lazy... fields) {
        // shortcut if no valid id
<span class="nc bnc" id="L175" title="All 4 branches missed.">        if ((idType == null) || StringUtils.isEmpty(idValue)) {</span>
<span class="nc" id="L176">            return Optional.empty();</span>
        }
<span class="nc" id="L178">        return orgRepository.getOrgByOrgExternalIdType(idType, idValue, fields);</span>
    }

    public List&lt;Org&gt; getOrgsByOrgExternalIdType(OrgExternalIdType idType, Collection&lt;String&gt; idValues, Org.Lazy... fields) {
        // shortcut if no valid id
<span class="pc bpc" id="L183" title="1 of 4 branches missed.">        if ((idType == null) || isEmpty(idValues)) {</span>
<span class="fc" id="L184">            return emptyList();</span>
        }
<span class="fc" id="L186">        return orgRepository.getOrgsByOrgExternalIdType(idType, idValues, fields);</span>
    }

    public Optional&lt;Org&gt; getOrgByPublicId(UUID publicId, Org.Lazy... fields) {
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">        if (publicId == null) {</span>
<span class="nc" id="L191">            return Optional.empty();</span>
        }
<span class="fc" id="L193">        return orgRepository.getOrgByPublicId(publicId, fields);</span>
    }

    /**
     * Get team object by code
     *
     * @param code team code
     * @return {@link Team}
     */
    @Nullable
    public Team getTeamByCode(String code, Team.Lazy... fields) {
        // shortcut if no code
<span class="fc bfc" id="L205" title="All 2 branches covered.">        if (StringUtils.isBlank(code)) {</span>
<span class="fc" id="L206">            return null;</span>
        }

        try {
<span class="fc" id="L210">            return teamRepository.getInstituteByCode(code, fields);</span>
<span class="nc" id="L211">        } catch (Exception e) {</span>
<span class="nc" id="L212">            throw new RuntimeException(&quot;Error while getting team by code -&quot; + code, e);</span>
        }
    }

    public List&lt;Team&gt; getTeamsByCode(Collection&lt;String&gt; codes, Team.Lazy... fields) {
<span class="fc bfc" id="L217" title="All 2 branches covered.">        if (isEmpty(codes)) {</span>
<span class="fc" id="L218">            return emptyList();</span>
        }
<span class="fc" id="L220">        return teamRepository.getTeamsByCode(codes, fields);</span>
    }

    @NotNull
    public Team getTeamByPublicId(UUID teamPublicId) {
<span class="fc" id="L225">        return Try.of(() -&gt; teamRepository.getInstituteByPublicId(teamPublicId))</span>
<span class="pc" id="L226">                .getOrElseThrow(ex -&gt; new TeamNotFoundException(&quot;Could not find team &quot; + teamPublicId, ex));</span>
    }

    public List&lt;Team&gt; getTeamsByPublicIds(Collection&lt;UUID&gt; teamPublicIds) {
<span class="fc" id="L230">        return teamRepository.getTeamsByPublicIds(teamPublicIds);</span>
    }

    public List&lt;UUID&gt; getTeamPublicIdsByIds(List&lt;Long&gt; teamIds) {
<span class="fc" id="L234">        return teamRepository.getTeamPublicIdsByIds(teamIds);</span>
    }

    public UUID getTeamPublicIdByTeamCode(String teamCode) {
<span class="fc" id="L238">        return Try.of(() -&gt; teamRepository.getTeamPublicIdByTeamCode(teamCode))</span>
<span class="pc" id="L239">                .getOrElseThrow(ex -&gt; new TeamNotFoundException(&quot;Could not find team with code &quot; + teamCode, ex));</span>
    }

    /**
     * Get the list of orgs ordered by name
     *
     * @return List of {@link Org} objects
     */
    public List&lt;Org&gt; getOrgList(Org.Lazy... fields) {
        try {
<span class="fc" id="L249">            return orgRepository.getOrgList(fields);</span>
<span class="nc" id="L250">        } catch (Exception e) {</span>
<span class="nc" id="L251">            throw new RuntimeException(&quot;Error while getting org list&quot;, e);</span>
        }
    }

    /**
     * Get the team coordinator
     *
     * @param teamId team id
     * @return {@link PKBPerson}
     */
    public List&lt;PKBPerson&gt; getTeamCoord(Long teamId) {
        try {
<span class="fc" id="L263">            return instituteUserManager.getInstituteAdmin(teamId);</span>
<span class="nc" id="L264">        } catch (Exception e) {</span>
<span class="nc" id="L265">            throw new RuntimeException(&quot;Error while getting team coord&quot;, e);</span>
        }
    }

    /**
     * Get the active team coordinators
     *
     * @param teamId team id
     * @return {@link PKBPerson}
     */
    public List&lt;PKBPerson&gt; getActiveTeamCoord(Long teamId) {
        try {
<span class="fc" id="L277">            return instituteUserManager.getActiveInstituteAdmin(teamId);</span>
<span class="nc" id="L278">        } catch (Exception e) {</span>
<span class="nc" id="L279">            throw new RuntimeException(&quot;Error while getting team coord&quot;, e);</span>
        }
    }

    /**
     * Deletes all linked symptomsToMonitor for the given team.
     * It is basically a hack to get around the fact that the
     * way how we use Hibernate is not exactly correct.
     * 03/jan/2017 @mvarga
     */
    public void deleteSymptomsToMonitor(Team team) {
<span class="fc" id="L290">        teamRepository.deleteSymptomsToMonitor(team);</span>
<span class="fc" id="L291">    }</span>

    /**
     * Update Team information
     *
     * @param team {@link Team} object
     */
    public void updateTeam(Team team) {
        try {
<span class="fc" id="L300">            teamRepository.saveAndFlush(team);</span>
<span class="nc" id="L301">        } catch (Exception e) {</span>
<span class="nc" id="L302">            throw new RuntimeException(&quot;Error while updating team-&quot; + team.getName(), e);</span>
<span class="fc" id="L303">        }</span>
<span class="fc" id="L304">    }</span>

    /**
     * Get number of teams in the system
     *
     * @return count of teams
     */
    public int getTeamCount() {
        try {
<span class="fc" id="L313">            return (int)teamRepository.count();</span>
<span class="nc" id="L314">        } catch (Exception e) {</span>
<span class="nc" id="L315">            throw new RuntimeException(&quot;Error while getting team count&quot;, e);</span>
        }
    }

    /**
     * Get the list of teams by specified sponsorship status
     *
     * @param userId id of the user
     * @param status {@link SponsorshipStatus}
     * @return List of {@link Team} objects
     */
    public List&lt;Team&gt; getUserTeamsByStatus(long userId,
                                           SponsorshipStatus status) {
        try {
<span class="fc" id="L329">            return teamRepository.getUserInstitutesByStatus(userId, status);</span>
<span class="nc" id="L330">        } catch (Exception e) {</span>
<span class="nc" id="L331">            throw new RuntimeException(&quot;Error while getting team list with status-&quot; + status, e);</span>
        }
    }

    /**
     * Send a notification to team coord to activate the newly registered user
     *
     * @param newUser newly registered user
     * @param team    {@link Team}
     * @throws MailException
     */
    public void notifyTeamCoordToActivateUser(PKBPerson newUser, Team team)
            throws MailException {
<span class="fc" id="L344">        List&lt;PKBPerson&gt; teamCoords = getActiveTeamCoord(team.getId());</span>
<span class="fc bfc" id="L345" title="All 2 branches covered.">        for (PKBPerson teamCoord : teamCoords) {</span>
<span class="fc" id="L346">            emailMessageManager.requestActivationToInstituteAdmin(newUser, team, teamCoord);</span>
<span class="fc" id="L347">        }</span>
<span class="fc" id="L348">    }</span>

    /**
     * Get the number of patient registered between date 1 and date 2 for the team
     *
     * @param teamId
     * @param date1
     * @param date2
     * @return
     */
    public int getNumOfPatientsRegistered(Long teamId, Instant date1, Instant date2) {
<span class="fc" id="L359">        return instituteUserRepository.getNumberOfPatientsRegistered(teamId, Date.from(date1), Date.from(date2));</span>
    }

    /**
     * Get the list of teams for the organization id sorted in alpha
     *
     * @param orgId
     * @return
     */
    public List&lt;Team&gt; getTeamsForOrg(Long orgId) {
<span class="fc" id="L369">        return teamRepository.findByOrg_IdOrderByName(orgId);</span>
    }

    /**
     * Update Org
     *
     * @param org {@link Org} object
     * @return org id
     */
    public Long updateOrg(Org org) {
        try {
<span class="fc" id="L380">            return orgRepository.saveAndFlush(org).getId();</span>
<span class="nc" id="L381">        } catch (Exception e) {</span>
<span class="nc" id="L382">            throw new RuntimeException(&quot;Error while updating org&quot;, e);</span>
        }
    }

    /**
     * Check if user is active in any team
     *
     * @param userId
     * @return List of {@link Team} in which the user is active
     */
    public boolean isActiveTeamUser(long userId) {
<span class="fc" id="L393">        return instituteUserRepository.isActiveTeamUser(userId);</span>
    }

    /**
     * Retrieves the active Org for the specified org admin, professional, or team coord. This lookup is performed on ACTIVE InstituteUser
     * entries.
     *
     * @param personId The person whose Org should be retrieved.
     * @return The Org associated with the person.
     */
    public Org getOrgByActiveIUForPerson(long personId) {
<span class="fc" id="L404">        InstituteUserEntity instituteUser = instituteUserRepository.getInstituteUserForPerson(personId);</span>
<span class="fc" id="L405">        return Try.of(() -&gt; instituteUser)</span>
<span class="fc" id="L406">                .map(iu -&gt; iu.getInstitute().getOrg())</span>
<span class="pc" id="L407">                .getOrElseThrow(ex -&gt; new RuntimeException(</span>
<span class="nc" id="L408">                        format(&quot;Error getting active IU records for person %d&quot;, personId), ex));</span>
    }

    public Optional&lt;TeamWithOrg&gt; findVerifyingTeamForPersonId(long personId) {
<span class="fc" id="L412">        return teamDomainService.findVerifyingTeamForPersonId(personId);</span>
    }

    public List&lt;Team&gt; getTeamsWithActiveAlarms(long patientId) {
<span class="fc" id="L416">        return teamRepository.getTeamsWithActiveAlarms(patientId);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>