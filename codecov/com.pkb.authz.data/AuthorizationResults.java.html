<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthorizationResults.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.authz.data</a> &gt; <span class="el_source">AuthorizationResults.java</span></div><h1>AuthorizationResults.java</h1><pre class="source lang-java linenums">package com.pkb.authz.data;

import com.pkb.authz.AuthzImmutableStyle;
import com.pkb.authz.NotAuthorizedException;
import com.pkb.authz.TargetMeta;
import com.pkb.authz.action.Action;
import com.pkb.authz.condition.ConditionFailure;
import com.pkb.authz.condition.NotFound;
import com.pkb.authz.permission.Permissions;
import com.pkb.datamodel.authorization.TargetOwnerData;
import io.vavr.Tuple2;
import io.vavr.collection.Map;
import io.vavr.collection.Set;
import io.vavr.control.Either;
import io.vavr.control.Option;
import org.immutables.value.Value;
import org.jetbrains.annotations.NotNull;

import java.util.function.BiPredicate;
import java.util.function.Function;
import java.util.function.Predicate;
import java.util.function.Supplier;

import static com.google.common.base.Preconditions.checkState;
import static com.pkb.authz.NotFoundException.notFoundForTargetOwner;
import static com.pkb.authz.NotFoundException.notFoundTarget;
import static com.pkb.authz.permission.ImmutableDenied.denied;
import static com.pkb.authz.permission.ImmutableTextualJustification.justification;
import static io.vavr.API.List;
import static io.vavr.API.Set;
import static io.vavr.control.Either.left;
import static io.vavr.control.Either.right;

/**
 * The results of an authorization call.
 * The user can request more than one object, and may be allowed access to
 * some but not all of them, so results must be for each object requested.
 */
@Value.Immutable
@Value.Style(builder = &quot;authzResults&quot;)
@AuthzImmutableStyle
<span class="fc" id="L42">public abstract class AuthorizationResults {</span>

    public abstract AuthorizationData data();

    public abstract Map&lt;TargetMeta&lt;?&gt;, AuthorizationResult&gt; results();

    /**
     * Having just a single result is a common case, so define some shortcuts here to make it obvious
     * to developers what to do.
     */
    public final AuthorizationResult singleResult() {
<span class="nc bnc" id="L53" title="All 2 branches missed.">        checkState(results().size() == 1, &quot;Expected exactly 1 authorization result&quot;);</span>
<span class="nc" id="L54">        return results().values().head();</span>
    }

    public final TargetMeta singleTarget() {
<span class="pc bpc" id="L58" title="1 of 2 branches missed.">        checkState(data().inputs().targets().size() == 1, &quot;Expected exactly 1 authorization result&quot;);</span>
<span class="fc" id="L59">        return data().inputs().targets().head();</span>
    }

    public final @NotNull Map&lt;TargetMeta&lt;?&gt;, TargetOwnerData&gt; allowedTargetOwnersByTargets() {
<span class="fc" id="L63">        Set&lt;Action&gt; actions = Set(data().inputs().action());</span>

<span class="fc" id="L65">        Set&lt;TargetMeta&lt;?&gt;&gt; allowedTargets = results()</span>
<span class="fc" id="L66">                .filter(actionsArePermittedOnTarget(actions))</span>
<span class="fc" id="L67">                .keySet();</span>

<span class="fc" id="L69">        return data().targetOwnerData()</span>
<span class="fc" id="L70">                .filter((target, targetOwner) -&gt; allowedTargets.contains(target));</span>
    }

    private &lt;T&gt; Either&lt;RuntimeException, T&gt; checkSingleResult(Option&lt;Tuple2&lt;TargetMeta&lt;?&gt;, AuthorizationResult&gt;&gt; targetAndResult, Supplier&lt;T&gt; onAuthSuccess, TargetMeta&lt;?&gt; singleTarget) {
<span class="fc" id="L74">        return targetAndResult</span>
<span class="fc" id="L75">                .map(Tuple2::_2)</span>
<span class="fc" id="L76">                .map(AuthorizationResult::result)</span>
<span class="fc" id="L77">                .map(res -&gt; res</span>
<span class="fc" id="L78">                        .mapLeft(mapConditionFailures(singleTarget))</span>
<span class="fc" id="L79">                        .flatMap(mapPermissions(onAuthSuccess, singleTarget)))</span>
<span class="fc" id="L80">                .getOrElse(() -&gt; {</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">                    if (singleTarget.identifiers().isEmpty()) {</span>
<span class="fc" id="L82">                        return left(singleTarget.personId()</span>
<span class="fc" id="L83">                                .map(targetOwnerId -&gt; notFoundForTargetOwner(targetOwnerId, singleTarget.targetType()))</span>
<span class="pc" id="L84">                                .getOrElseThrow(() -&gt; notAuthorized(singleTarget)));</span>
                    } else {
<span class="fc" id="L86">                        return left(notFoundTarget(singleTarget.identifiers().iterator().next(), singleTarget.targetType()));</span>
                    }
                });
    }

    public final &lt;T&gt; Either&lt;RuntimeException, T&gt; checkSingleResult(Supplier&lt;T&gt; onAuthSuccess) {
<span class="fc" id="L92">        return checkSingleResult(results().headOption(), onAuthSuccess, singleTarget());</span>
    }

    public final &lt;T&gt; Either&lt;RuntimeException, T&gt; checkFilteredSingleResult(Predicate&lt;? super TargetMeta&lt;?&gt;&gt; keyFilter, Supplier&lt;T&gt; onAuthSuccess) {
<span class="fc" id="L96">        return checkSingleResult(results().filterKeys(keyFilter).headOption(), onAuthSuccess, data().inputs().targets().filter(keyFilter).get());</span>
    }

    private Function&lt;Set&lt;ConditionFailure&gt;, RuntimeException&gt; mapConditionFailures(TargetMeta&lt;?&gt; singleTarget) {
<span class="fc" id="L100">        return conditionFailures -&gt; conditionFailures</span>
<span class="fc" id="L101">                .filter(NotFound.class::isInstance).map(NotFound.class::cast)</span>
<span class="fc" id="L102">                .map(notFound -&gt; (RuntimeException) notFoundTarget(notFound.id(), notFound.objectType()))</span>
<span class="fc" id="L103">                .getOrElse(() -&gt; new NotAuthorizedException(singleTarget, conditionFailures));</span>
    }

    /** Permissions might still be a DENY */
    private &lt;T&gt; Function&lt;Permissions, Either&lt;RuntimeException, T&gt;&gt; mapPermissions(Supplier&lt;T&gt; onAuthSuccess, TargetMeta&lt;?&gt; singleTarget) {
<span class="fc" id="L108">        Set&lt;Action&gt; actions = Set(data().inputs().action());</span>

<span class="fc bfc" id="L110" title="All 2 branches covered.">        return permissions -&gt; permissions.allowToPerform(actions) ? //</span>
<span class="fc" id="L111">                right(onAuthSuccess.get()) : //</span>
<span class="fc" id="L112">                left(new NotAuthorizedException(singleTarget, permissions.permissionsForActions(actions)));</span>
    }

    private NotAuthorizedException notAuthorized(TargetMeta&lt;?&gt; singleTarget) {
<span class="nc" id="L116">        return new NotAuthorizedException(singleTarget, List(denied(data().inputs().action(), List(justification(&quot;Could not determine permissions&quot;)))));</span>
    }

    private BiPredicate&lt;TargetMeta, AuthorizationResult&gt; actionsArePermittedOnTarget(Set&lt;Action&gt; actions) {
<span class="fc" id="L120">        return ($, authorizationResult) -&gt; authorizationResult.result()</span>
<span class="fc" id="L121">                .map(permissions -&gt; permissions.allowToPerform(actions))</span>
<span class="fc" id="L122">                .getOrElse(false);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>