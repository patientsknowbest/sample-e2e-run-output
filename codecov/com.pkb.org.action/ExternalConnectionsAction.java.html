<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ExternalConnectionsAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.org.action</a> &gt; <span class="el_source">ExternalConnectionsAction.java</span></div><h1>ExternalConnectionsAction.java</h1><pre class="source lang-java linenums">package com.pkb.org.action;

import com.pkb.action.BaseAction;
import com.pkb.crypto.dto.AccountPrivateKeyDTO;
import com.pkb.institute.entity.Org;
import com.pkb.oauth2.client.Oauth2Client;
import com.pkb.oauth2.client.model.ThirdPartyApplication;
import com.pkb.oauth2.client.model.ThirdPartyClientOrgGrantRequest;
import com.pkb.service.user.impl.UserAccessManager;
import org.apache.commons.lang3.StringUtils;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import javax.inject.Inject;
import java.util.ArrayList;
import java.util.Base64;
import java.util.List;
import java.util.UUID;
import java.util.stream.Collectors;

import static com.pkb.oauth2.client.model.ImmutableThirdPartyClientOrgGrantRequest.thirdPartyClientOrgGrantRequest;

<span class="fc" id="L25">public class ExternalConnectionsAction extends BaseAction {</span>

<span class="fc" id="L27">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

<span class="fc" id="L29">    private final String tab = &quot;externalConnections&quot;;</span>
<span class="fc" id="L30">    private List&lt;ThirdPartyApplication&gt; grantedClients = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L31">    private List&lt;ThirdPartyApplication&gt; availableClients = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L32">    private List&lt;ThirdPartyApplication&gt; filteredAvailableClients = new ArrayList&lt;&gt;();</span>
    private String selectedConnectionPublicId;
    private String searchText;
    @Autowired
    private Oauth2Client oauth2Client;
    @Inject
    private UserAccessManager userAccessManager;

    @Override
    public String execute() throws Exception {
<span class="fc" id="L42">        return SUCCESS;</span>
    }

    public String allConnections() {
        try {
<span class="fc" id="L47">            Org loggedInUserOrg = loggedInUserUtil.getLoggedInUserOrg();</span>
<span class="fc" id="L48">            fetchGrantedClients(loggedInUserOrg);</span>
<span class="fc" id="L49">            fetchAvailableClients();</span>
<span class="nc" id="L50">        } catch (Exception e) {</span>
<span class="nc" id="L51">            LOGGER.error(&quot;Exception while building External Connections page&quot;, e);</span>
<span class="fc" id="L52">        }</span>
<span class="fc" id="L53">        return SUCCESS;</span>
    }

    public String grantedConnections() {
        try {
<span class="fc" id="L58">            Org loggedInUserOrg = loggedInUserUtil.getLoggedInUserOrg();</span>
<span class="fc" id="L59">            fetchGrantedClients(loggedInUserOrg);</span>
<span class="nc" id="L60">        } catch (Exception e) {</span>
<span class="nc" id="L61">            LOGGER.error(&quot;Exception while building External Connections page&quot;, e);</span>
<span class="fc" id="L62">        }</span>
<span class="fc" id="L63">        return SUCCESS;</span>
    }

    public boolean isFilteredClientsNotEmpty() {
<span class="fc" id="L67">        filteredAvailableClients = availableClients.stream()</span>
<span class="fc bfc" id="L68" title="All 4 branches covered.">                .filter(thirdPartyApplication -&gt; StringUtils.isNotBlank(searchText) &amp;&amp; searchFilter(thirdPartyApplication))</span>
<span class="fc" id="L69">                .collect(Collectors.toList());</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">        return !filteredAvailableClients.isEmpty();</span>
    }

    private boolean searchFilter(ThirdPartyApplication thirdPartyApplication) {
<span class="fc bfc" id="L74" title="All 2 branches covered.">        return (thirdPartyApplication.getName().equalsIgnoreCase(searchText)</span>
<span class="pc bpc" id="L75" title="1 of 2 branches missed.">                || thirdPartyApplication.getPublicId().toString().equalsIgnoreCase(searchText)</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">                || thirdPartyApplication.getOwner().equalsIgnoreCase(searchText))</span>
<span class="fc" id="L77">                &amp;&amp; !grantedClients.stream()</span>
<span class="fc" id="L78">                .map(ThirdPartyApplication::getPublicId)</span>
<span class="fc" id="L79">                .collect(Collectors.toList())</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">                .contains(thirdPartyApplication.getPublicId());</span>
    }

    private void fetchGrantedClients(@NotNull Org loggedInUserOrg) {
<span class="fc" id="L84">        grantedClients = oauth2Client.getGrantedClients(loggedInUserOrg.getPublicId())</span>
<span class="fc" id="L85">                .getOrElseGet(error -&gt; {</span>
<span class="nc" id="L86">                    addActionError(getText(&quot;something.went.wrong&quot;));</span>
<span class="nc" id="L87">                    LOGGER.error(error.getDescription());</span>
<span class="nc" id="L88">                    return new ArrayList&lt;&gt;();</span>
                });
<span class="fc" id="L90">    }</span>

    private void fetchAvailableClients() {
<span class="fc" id="L93">        availableClients = oauth2Client.getAvailableClients()</span>
<span class="fc" id="L94">                .getOrElseGet(error -&gt; {</span>
<span class="nc" id="L95">                    addActionError(getText(&quot;something.went.wrong&quot;));</span>
<span class="nc" id="L96">                    LOGGER.error(error.getDescription());</span>
<span class="nc" id="L97">                    return new ArrayList&lt;&gt;();</span>
                });
<span class="fc" id="L99">    }</span>

    public String back() {
<span class="fc" id="L102">        return &quot;back&quot;;</span>
    }

    public String revoke() {
<span class="fc" id="L106">        getSelectedConnection().getOrgGrants().ifPresent(orgGrant -&gt; {</span>
<span class="fc" id="L107">            oauth2Client.revokeAccessForGrant(orgGrant.get(0).getId())</span>
<span class="fc" id="L108">                    .getOrElseGet(error -&gt; {</span>
<span class="nc" id="L109">                        LOGGER.warn(error.getDescription());</span>
<span class="nc" id="L110">                        return &quot;&quot;;</span>
                    });
<span class="fc" id="L112">        });</span>
<span class="fc" id="L113">        return &quot;revoke&quot;;</span>
    }

    public String grant() {
<span class="fc" id="L117">        String privateKeyAsbease64String = getPrivateKey();</span>
<span class="fc" id="L118">        UUID publicId = loggedInUserUtil.getLoggedInUserOrg().getPublicId();</span>
<span class="fc" id="L119">        ThirdPartyClientOrgGrantRequest request = createThirdPartyClientOrgGrantRequest(UUID.fromString(selectedConnectionPublicId), publicId, privateKeyAsbease64String);</span>

<span class="fc" id="L121">        oauth2Client.addOrgGrantToThirdPartyClient(request)</span>
<span class="fc" id="L122">                .getOrElseGet(error -&gt; {</span>
<span class="nc" id="L123">                    LOGGER.warn(error.getDescription());</span>
<span class="nc" id="L124">                    return &quot;&quot;;</span>
                });
<span class="fc" id="L126">        return &quot;grant&quot;;</span>
    }

    private ThirdPartyClientOrgGrantRequest createThirdPartyClientOrgGrantRequest(UUID selectedConnectionPublicId, UUID orgPublicId, String privateKey) {
<span class="fc" id="L130">        return thirdPartyClientOrgGrantRequest()</span>
<span class="fc" id="L131">                .clientPublicId(selectedConnectionPublicId)</span>
<span class="fc" id="L132">                .orgCoordinator(loggedInUserUtil.getLoggedInUser().getFirstName() + &quot; &quot; + loggedInUserUtil.getLoggedInUser().getLastName())</span>
<span class="fc" id="L133">                .orgPublicId(orgPublicId)</span>
<span class="fc" id="L134">                .privateOrgAccountKeyBase64(privateKey)</span>
<span class="fc" id="L135">                .build();</span>
    }

    private String getPrivateKey() {
<span class="fc" id="L139">        AccountPrivateKeyDTO privateKey = userAccessManager.getOrgAccountPrivateKey(getLoggedInEHRRequestContext());</span>
<span class="fc" id="L140">        return Base64.getEncoder().encodeToString(privateKey.getKeyBytes());</span>
    }

    public String getTab() {
<span class="fc" id="L144">        return tab;</span>
    }

    public boolean isExternalConnectionsListNotEmpty() {
<span class="fc bfc" id="L148" title="All 2 branches covered.">        return !grantedClients.isEmpty();</span>
    }

    public List&lt;ThirdPartyApplication&gt; getGrantedClients() {
<span class="fc" id="L152">        return grantedClients;</span>
    }

    public String getSearchText() {
<span class="nc" id="L156">        return searchText;</span>
    }

    public void setSearchText(String searchText) {
<span class="fc" id="L160">        this.searchText = searchText;</span>
<span class="fc" id="L161">    }</span>

    public ThirdPartyApplication getSelectedConnection() {
<span class="fc" id="L164">        UUID orgPublicId = loggedInUserUtil.getLoggedInUserOrg().getPublicId();</span>
<span class="fc" id="L165">        return oauth2Client.getSingleClientForOrg(orgPublicId, UUID.fromString(selectedConnectionPublicId))</span>
<span class="fc" id="L166">                .getOrElseGet(error -&gt; {</span>
<span class="nc" id="L167">                    addActionError(getText(&quot;something.went.wrong&quot;));</span>
<span class="nc" id="L168">                    LOGGER.error(error.getDescription());</span>
<span class="nc" id="L169">                    return null;</span>
                });
    }

    public List&lt;ThirdPartyApplication&gt; getAvailableClients() {
<span class="nc" id="L174">        return availableClients;</span>
    }

    public void setAvailableClients(List&lt;ThirdPartyApplication&gt; availableClients) {
<span class="nc" id="L178">        this.availableClients = availableClients;</span>
<span class="nc" id="L179">    }</span>

    public List&lt;ThirdPartyApplication&gt; getFilteredAvailableClients() {
<span class="fc" id="L182">        return filteredAvailableClients;</span>
    }

    public void setFilteredAvailableClients(List&lt;ThirdPartyApplication&gt; filteredAvailableClients) {
<span class="nc" id="L186">        this.filteredAvailableClients = filteredAvailableClients;</span>
<span class="nc" id="L187">    }</span>

    public boolean isSearchFieldNotBlank() {
<span class="fc" id="L190">        return StringUtils.isNotBlank(searchText);</span>
    }

    public String getSelectedConnectionPublicId() {
<span class="fc" id="L194">        return selectedConnectionPublicId;</span>
    }

    public void setSelectedConnectionPublicId(String selectedConnectionPublicId) {
<span class="fc" id="L198">        this.selectedConnectionPublicId = selectedConnectionPublicId;</span>
<span class="fc" id="L199">    }</span>

    public boolean isSystmOneSsoEnabled() {
<span class="fc" id="L202">        return config.isSystmOneSsoEnabled();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>