<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PatientConsentDTO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.datamodel.consent</a> &gt; <span class="el_source">PatientConsentDTO.java</span></div><h1>PatientConsentDTO.java</h1><pre class="source lang-java linenums">package com.pkb.datamodel.consent;

import com.google.common.base.Preconditions;
import com.pkb.entities.enums.AccessingEntityType;
import com.pkb.entities.enums.PrivacyFlag;
import io.vavr.Tuple2;
import org.immutables.serial.Serial;
import org.immutables.value.Value;

import java.time.Instant;
import java.util.Optional;
import java.util.UUID;

import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.Match;
import static io.vavr.API.Tuple;

/**
 * Used in the web &amp; service layers for accessing information about who has consent
 * to view what data in a patient's record.
 * &lt;p&gt;
 * This DTO is for _reading_ only. For updates use {@link PatientConsentUpdateDTO},
 * which has fields for update reasons (mandatory when you change consent, but most
 * places don't care about looking at the reasons).
 */
@Value.Immutable
@Value.Modifiable
@Serial.Structural
@Value.Style(stagedBuilder = true)
public interface PatientConsentDTO extends PatientConsentBaseDTO {

    long id();

    UUID uniqueId();

    AccessingEntityType accessingEntityType();

    /**
     * Either this or {@link #accessingPersonId()} must be set, depending on
     * the value of {@link #accessingEntityType()}.
     */
    Optional&lt;Long&gt; accessingTeamId();

    /**
     * Either this or {@link #accessingTeamId()} must be set, depending on
     * the value of {@link #accessingEntityType()}.
     */
    Optional&lt;Long&gt; accessingPersonId();

    Optional&lt;UUID&gt; accessingPersonPublicId();

    long patientPersonId();

    Instant added();

    Instant updated();

    default boolean hasConsent(PrivacyFlag flag) {
<span class="pc bpc" id="L60" title="2 of 5 branches missed.">        switch (flag) {</span>
            case GENERAL:
<span class="nc" id="L62">                return generalHealthConsentGranted();</span>
            case SEXUAL_HEALTH:
<span class="fc" id="L64">                return sexualHealthConsentGranted();</span>
            case MENTAL_HEALTH:
<span class="fc" id="L66">                return mentalHealthConsentGranted();</span>
            case SOCIAL_CARE:
<span class="fc" id="L68">                return socialCareConsentGranted();</span>
            default:
<span class="nc" id="L70">                throw new RuntimeException(&quot;Checking non-existing privacy flag&quot;); }</span>
    }

    @Value.Check
    default void teamOrPersonIdIsSet() {
<span class="fc" id="L75">        Tuple2&lt;Boolean, String&gt; conditionAndMessage = Match(accessingEntityType()).of(</span>
<span class="fc" id="L76">                Case($(AccessingEntityType.TEAM), () -&gt; Tuple(accessingTeamId().isPresent(), &quot;accessingTeamId must be defined&quot;)),</span>
<span class="fc" id="L77">                Case($(AccessingEntityType.CARER), () -&gt; Tuple(accessingPersonId().isPresent(), &quot;accessingPersonId must be defined&quot;)),</span>
<span class="fc" id="L78">                Case($(AccessingEntityType.INDIVIDUAL), () -&gt; Tuple(accessingPersonId().isPresent(), &quot;accessingPersonId must be defined&quot;))</span>
        );
<span class="fc" id="L80">        Preconditions.checkState(conditionAndMessage._1, conditionAndMessage._2);</span>
<span class="fc" id="L81">    }</span>

    /**
     * Returns true if this consent object covers the specified required consent categories
     */
    default boolean isEntityVisible(RequiresConsent checkable) {
<span class="fc bfc" id="L87" title="All 2 branches covered.">        return checkConsent(checkable.getRequireGeneral(), generalHealthConsentGranted())</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">                &amp;&amp; checkConsent(checkable.getRequireSexualHealth(), sexualHealthConsentGranted())</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">                &amp;&amp; checkConsent(checkable.getRequireMentalHealth(), mentalHealthConsentGranted())</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">                &amp;&amp; checkConsent(checkable.getRequireSocialCare(), socialCareConsentGranted());</span>
    }

    private boolean checkConsent(boolean required, boolean granted) {
        // If this category isn't required, we're OK
<span class="fc bfc" id="L95" title="All 4 branches covered.">        return (!required) || granted; // If it is required, then it must also be granted</span>
    }

    default long requireTeamId() {
<span class="nc" id="L99">        return accessingTeamId().orElseThrow(() -&gt; new IllegalStateException(&quot;teamId is not set!&quot;));</span>
    }

    default long requirePersonId() {
<span class="pc" id="L103">        return accessingPersonId().orElseThrow(() -&gt; new IllegalStateException(&quot;personId is not set!&quot;));</span>
    }

    default Long getAccessingTeamOrPersonId() {
<span class="pc" id="L107">        return accessingTeamId().orElseGet(() -&gt; accessingPersonId().orElseThrow(() -&gt; new IllegalStateException(&quot;No team or person id in consent!&quot;)));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>