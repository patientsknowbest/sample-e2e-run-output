<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InstituteUserRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.domain.internal.repository</a> &gt; <span class="el_source">InstituteUserRepository.java</span></div><h1>InstituteUserRepository.java</h1><pre class="source lang-java linenums">package com.pkb.domain.internal.repository;

import com.google.common.annotations.VisibleForTesting;
import com.google.common.collect.Ordering;
import com.pkb.entities.enums.SponsorshipStatus;
import com.pkb.entities.enums.UserType;
import com.pkb.entities.pub.PublicInstituteUser;
import io.vavr.collection.List;
import io.vavr.collection.Set;
import io.vavr.control.Option;
import org.jetbrains.annotations.NotNull;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.Repository;

import static com.google.common.base.Preconditions.checkState;
import static io.vavr.API.List;
import static java.lang.String.format;
import static java.util.Comparator.comparing;

public interface InstituteUserRepository extends Repository&lt;PublicInstituteUser, Long&gt; {

    default Option&lt;PublicInstituteUser&gt; findCliniciansTeamUser(long clinicianId) {
<span class="fc" id="L23">        return findClinicianActiveTeamFromClinicianIdList(List(clinicianId))</span>
<span class="fc" id="L24">                .headOption();</span>
    }

    // this will find either 0 or 1 active team for each clinician
    default List&lt;PublicInstituteUser&gt; findClinicianActiveTeamFromClinicianIdList(List&lt;Long&gt; clinicianIds) {
<span class="fc" id="L29">        List&lt;PublicInstituteUser&gt; teamsForUsers = findTeamsForUsers(clinicianIds, UserType.REG_CLINICIAN, SponsorshipStatus.ACTIVE);</span>
<span class="fc" id="L30">        checkState(allUniquePersons(teamsForUsers), format(&quot;Multiple teams found for at least one clinician in list [%s]&quot;, clinicianIds));</span>
<span class="fc" id="L31">        return teamsForUsers.sorted(comparing(PublicInstituteUser::getPersonId, Ordering.explicit(clinicianIds)));</span>
    }

    default List&lt;PublicInstituteUser&gt; findActiveTeamsForPatients(List&lt;Long&gt; patientIds) {
<span class="fc" id="L35">        return findTeamsForUsers(patientIds, UserType.PATIENT, SponsorshipStatus.ACTIVE);</span>
    }

    @VisibleForTesting
    @Query(&quot;SELECT iu FROM PublicInstituteUser iu &quot; +
            &quot;JOIN FETCH iu.team t &quot; +
            &quot;JOIN FETCH t.org &quot; +
            &quot;WHERE iu.personId IN (:ids) &quot; +
            &quot;AND iu.userType = :userType &quot; +
            &quot;AND iu.sponsorshipStatus = :sponsorshipStatus&quot;)
    List&lt;PublicInstituteUser&gt; findTeamsForUsers(List&lt;Long&gt; ids,
                                                UserType userType,
                                                SponsorshipStatus sponsorshipStatus);

    private static boolean allUniquePersons(@NotNull List&lt;PublicInstituteUser&gt; instituteUsers) {
<span class="fc" id="L50">        var personIds = instituteUsers.map(PublicInstituteUser::getPersonId);</span>
<span class="pc bpc" id="L51" title="1 of 2 branches missed.">        return personIds.size() == personIds.distinct().size();</span>
    }

    @Query(&quot;SELECT iu.personId FROM PublicInstituteUser iu &quot; +
            &quot; JOIN iu.team team &quot; +
            &quot; JOIN team.org org &quot; +
            &quot; WHERE org.id = :orgId &quot; +
            &quot; AND iu.personId IN (:personIds)&quot;)
    List&lt;Long&gt; filterPersonIdsInOrg(Long orgId, Set&lt;Long&gt; personIds);
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>