<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PhrReferenceHelper.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.aggregator.service.reference</a> &gt; <span class="el_source">PhrReferenceHelper.kt</span></div><h1>PhrReferenceHelper.kt</h1><pre class="source lang-java linenums">package com.pkb.aggregator.service.reference

import com.pkb.aggregator.R4Extension
import com.pkb.aggregator.R4IdType
import com.pkb.aggregator.R4Reference
import com.pkb.aggregator.configuration.PhrMigrationConfiguration
import com.pkb.aggregator.configuration.PhrMigrationConfiguration.Companion.CONNECTING_ORG
import com.pkb.aggregator.configuration.PhrMigrationConfiguration.Companion.FROZEN_BY_TEAM
import com.pkb.aggregator.configuration.PhrMigrationConfiguration.Companion.PRIVACY_OVERRIDE_ORG
import com.pkb.aggregator.configuration.PhrMigrationConfiguration.Companion.SOURCE_ORG
import com.pkb.aggregator.configuration.PhrMigrationConfiguration.Companion.SOURCE_TEAM
import com.pkb.aggregator.extension.isPlainUuidReference
import com.pkb.aggregator.service.FHIR_TYPE_ORGANIZATION
import org.springframework.stereotype.Service

/**
 * Helps work with value references stored in extensions by ehrmigrator
 */
<span class="fc" id="L19">@Service</span>
<span class="fc" id="L20">class PhrReferenceHelper(private val phrMigrationConfiguration: PhrMigrationConfiguration) {</span>

    fun findPhrValueReference(extension: R4Extension) =
<span class="fc" id="L23">        when {</span>
<span class="fc bfc" id="L24" title="All 2 branches covered.">            isPhrExtension(extension) -&gt; getIdFromExtensionValue(extension)</span>
<span class="fc" id="L25">            else -&gt; null</span>
<span class="fc" id="L26">        }</span>

    private fun isPhrExtension(extension: R4Extension) =
<span class="fc" id="L29">        phrMigrationConfiguration.extensionSystems.containsValue(extension.url)</span>

    private fun getIdFromExtensionValue(extension: R4Extension) =
<span class="fc" id="L32">        when (val value = extension.value) {</span>
<span class="pc bpc" id="L33" title="1 of 2 branches missed.">            is R4Reference -&gt; getIdFromReference(value, extension.url)</span>
<span class="nc" id="L34">            else -&gt; null</span>
<span class="fc" id="L35">        }</span>

    /*
    Value references can be handled in multiple ways: we support two of them here. The easier one is when the reference
    is populated, like this:

    {
        &quot;url&quot;: &quot;http://fhir.patientsknowbest.com/structuredefinition/source-organisation&quot;,
        &quot;valueReference&quot;: {
            &quot;reference&quot;: &quot;Organization/938168d0-1b0c-3329-9dc4-8dedde428c64&quot;
        }
    }

    In which case we can just stuff the reference straight into an id type.

    The fiddlier one is like this:

    {
        &quot;url&quot;: &quot;http://fhir.patientsknowbest.com/structuredefinition/connecting-org&quot;,
        &quot;valueReference&quot;: {
            &quot;id&quot;: &quot;ca8b3ba9-d8c4-4c90-8287-ea921a8ddae7&quot;,
            &quot;resourceType&quot;: &quot;Organization&quot;
        }
    }

    HAPI is weird with this, because it creates a reference where _only_ the id part is populated, and for some reason
    not the resource type. This might be a bug, not sure. Anyway, it means we have to look at the url to figure out the
    resource type and then combine it with the id part

    TODO PHR-10107 resolve as either Patient or Practitioner
    Sometimes references are plain uuid without meaning:

    {
        &quot;url&quot;: &quot;http://fhir.patientsknowbest.com/structuredefinition/source-person&quot;,
        &quot;valueReference&quot;: {
            &quot;identifier&quot;: {
                &quot;system&quot;: &quot;urn:uuid:cd97da65-0aa4-43a6-b695-cfd0c6f3267d&quot;,
                &quot;value&quot;: &quot;3fac4f01-3794-4f4a-85ef-32f6b84493a3&quot;
            }
        }
    }

    In the case above we don't know if this is a patient or practitioner, so we just copy as-is.
     */
    private fun getIdFromReference(reference: R4Reference, extensionUrl: String) =
<span class="fc" id="L80">        when {</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">            reference.reference != null -&gt; R4IdType(reference.reference)</span>
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">            reference.id != null -&gt; R4IdType(resolveResourceType(extensionUrl), reference.id)</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">            reference.isPlainUuidReference() -&gt; null</span>
            else -&gt; {
<span class="nc" id="L85">                throw RuntimeException(&quot;Reference resolution is not implemented for PHR extension $extensionUrl&quot;)</span>
            }
<span class="fc" id="L87">        }</span>

<span class="nc" id="L89">    private fun resolveResourceType(url: String) = when (url) {</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">        phrMigrationConfiguration.extensionSystems[FROZEN_BY_TEAM] -&gt; FHIR_TYPE_ORGANIZATION</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">        phrMigrationConfiguration.extensionSystems[SOURCE_TEAM] -&gt; FHIR_TYPE_ORGANIZATION</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        phrMigrationConfiguration.extensionSystems[SOURCE_ORG] -&gt; FHIR_TYPE_ORGANIZATION</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        phrMigrationConfiguration.extensionSystems[PRIVACY_OVERRIDE_ORG] -&gt; FHIR_TYPE_ORGANIZATION</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">        phrMigrationConfiguration.extensionSystems[CONNECTING_ORG] -&gt; FHIR_TYPE_ORGANIZATION</span>
<span class="nc" id="L95">        else -&gt; throw RuntimeException(&quot;Unexpected PHR extension url $url&quot;)</span>
<span class="nc" id="L96">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>