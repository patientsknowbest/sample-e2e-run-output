<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuestionnaireService.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.questionnaireservice.service</a> &gt; <span class="el_source">QuestionnaireService.kt</span></div><h1>QuestionnaireService.kt</h1><pre class="source lang-java linenums">package com.pkb.questionnaireservice.service

import com.pkb.questionnaireservice.QuestionnaireId
import com.pkb.questionnaireservice.QuestionnaireRequestId
import com.pkb.questionnaireservice.TeamPublicId
import com.pkb.questionnaireservice.entities.QuestionnaireEntity
import com.pkb.questionnaireservice.entities.QuestionnaireTeamEntity
import com.pkb.questionnaireservice.mapper.mapRepositoryErrorOnSave
import com.pkb.questionnaireservice.mapper.mapResultsPageToSearchResults
import com.pkb.questionnaireservice.modelv2.QuestionnaireResponseCount
import com.pkb.questionnaireservice.modelv2.QuestionnaireServiceError
import com.pkb.questionnaireservice.modelv2.SearchResults
import com.pkb.questionnaireservice.repositories.ques.QuestionnaireRepository
import com.pkb.questionnaireservice.repositories.ques.QuestionnaireResponseRepository
import com.pkb.questionnaireservice.repositories.ques.QuestionnaireTeamRepository
import io.vavr.control.Either
import org.springframework.data.domain.Pageable
import org.springframework.stereotype.Service
import org.springframework.transaction.annotation.Transactional

<span class="fc" id="L21">@Service</span>
<span class="fc" id="L22">class QuestionnaireService(</span>
<span class="fc" id="L23">        private val questionnaireRepository: QuestionnaireRepository,</span>
<span class="fc" id="L24">        private val questionnaireTeamRepository: QuestionnaireTeamRepository,</span>
<span class="fc" id="L25">        private val questionnaireResponseRepository: QuestionnaireResponseRepository</span>
) {

    fun post(questionnaire: QuestionnaireEntity): Either&lt;QuestionnaireServiceError, QuestionnaireEntity&gt; =
<span class="nc" id="L29">            kotlin.runCatching { questionnaireRepository.save(questionnaire) }</span>
<span class="nc bnc" id="L30" title="All 2 branches missed.">                    .fold({ Either.right(it) },</span>
<span class="nc" id="L31">                            { Either.left(mapRepositoryErrorOnSave(it, questionnaire)) })</span>

    fun getQuestionnaireById(id: QuestionnaireId): Either&lt;QuestionnaireServiceError, QuestionnaireEntity&gt; =
<span class="fc" id="L34">            questionnaireRepository.findById(id).map {</span>
<span class="fc" id="L35">                Either.right&lt;QuestionnaireServiceError, QuestionnaireEntity&gt;(it)</span>
<span class="fc" id="L36">            }.orElseGet {</span>
<span class="fc" id="L37">                Either.left(QuestionnaireServiceError.NotFoundError(&quot;Questionnaire with id $id not found&quot;))</span>
<span class="fc" id="L38">            }</span>

<span class="nc" id="L40">    fun getQuestionnairesInTeams(teamsIds: List&lt;TeamPublicId&gt;, includeHidden: Boolean = false, pageable: Pageable): Either&lt;QuestionnaireServiceError, SearchResults&lt;QuestionnaireEntity&gt;&gt; {</span>
<span class="fc" id="L41">        return Either.right(</span>
<span class="fc" id="L42">                mapResultsPageToSearchResults(questionnaireRepository.findQuestionnairesByTeamIds(teamsIds, includeHidden,</span>
<span class="fc" id="L43">                        pageable)))</span>
    }

    fun checkIfQuestionnaireNameExists(id: TeamPublicId, name: String) =
<span class="fc" id="L47">            questionnaireRepository.findQuestionnaireByTeamIdAndName(id, name).isPresent</span>

    fun postQuestionnaireAndLinkToTeam(questAndTeamId: QuestionnaireTeamEntity): Either&lt;QuestionnaireServiceError, QuestionnaireTeamEntity&gt; =
<span class="fc bfc" id="L50" title="All 2 branches covered.">            if (checkIfQuestionnaireNameExists(questAndTeamId.teamId, questAndTeamId.questionnaire.name))</span>
<span class="fc" id="L51">                Either.left(QuestionnaireServiceError.NameInUseError(&quot;Questionnaire with name '${questAndTeamId.questionnaire.name}' already exists in team with id ${questAndTeamId.teamId}&quot;))</span>
            else
<span class="pc" id="L53">                kotlin.runCatching { saveQuestionnaireAndTeamLink(questAndTeamId) }</span>
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">                        .fold({ Either.right(it) },</span>
<span class="pc" id="L55">                                { Either.left(mapRepositoryErrorOnSave(it, questAndTeamId.questionnaire)) })</span>

    fun updateTeamLink(questAndTeamId: QuestionnaireTeamEntity): Either&lt;QuestionnaireServiceError, QuestionnaireTeamEntity&gt; =
<span class="pc" id="L58">            kotlin.runCatching {</span>
<span class="fc" id="L59">                questionnaireTeamRepository.save(questAndTeamId)</span>
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">            }.fold({ Either.right(it) }, { Either.left(mapRepositoryErrorOnSave(it, questAndTeamId.questionnaire)) })</span>

    fun getQuestionnaireTeamByQuestionnaireIdAndTeamId(id: QuestionnaireId, teamIds: List&lt;TeamPublicId&gt;): Either&lt;QuestionnaireServiceError, List&lt;QuestionnaireTeamEntity&gt;&gt; =
<span class="fc" id="L63">            Either.right(questionnaireTeamRepository.getByQuestionnaireIdAndTeamIsInOrderByTeamId(id, teamIds))</span>

    fun getQuestionnaireTeamByQuestionnaireRequestId(id: QuestionnaireRequestId): Either&lt;QuestionnaireServiceError, QuestionnaireTeamEntity&gt; =
<span class="fc" id="L66">            questionnaireTeamRepository.getQuestionnaireTeamByQuestionnaireRequestId(id)</span>
<span class="fc" id="L67">                    .map { Either.right&lt;QuestionnaireServiceError, QuestionnaireTeamEntity&gt;(it) }</span>
<span class="fc" id="L68">                    .orElseGet {</span>
<span class="nc" id="L69">                        Either.left(QuestionnaireServiceError.NotFoundError(&quot;QuestionnaireTeam with questionnaireRequest id $id not found&quot;))</span>
<span class="fc" id="L70">                    }</span>

    fun getQuestionnaireResponseCountsByTeamId(teamId: TeamPublicId): Either&lt;QuestionnaireServiceError, List&lt;QuestionnaireResponseCount&gt;&gt; {
<span class="fc" id="L73">        val questionnaireTeams = questionnaireTeamRepository.getQuestionnaireTeamsInTeams(listOf(teamId), true)</span>
<span class="fc" id="L74">        val responseCountsByQuestionnaireIdMap = questionnaireResponseRepository.countQuestionnaireResponses(questionnaireTeams.map { it.questionnaire.id })</span>
<span class="fc" id="L75">                .associateBy({ it.questionnaireId }, { it.responseCount })</span>
<span class="fc" id="L76">        return Either.right(questionnaireTeams.map { QuestionnaireResponseCount(it, responseCountsByQuestionnaireIdMap.getOrDefault(it.questionnaire.id, 0)) })</span>
    }

    fun getQuestionnaireTeamsInTeams(ids: List&lt;TeamPublicId&gt;, includeHidden: Boolean): Either&lt;QuestionnaireServiceError, List&lt;QuestionnaireTeamEntity&gt;&gt; =
<span class="fc" id="L80">            Either.right((questionnaireTeamRepository.getQuestionnaireTeamsInTeams(ids, includeHidden)))</span>
    
    @Transactional
    fun saveQuestionnaireAndTeamLink(questAndTeamId: QuestionnaireTeamEntity): QuestionnaireTeamEntity {
<span class="fc" id="L84">        questionnaireRepository.save(questAndTeamId.questionnaire)</span>
<span class="fc" id="L85">        return questionnaireTeamRepository.save(questAndTeamId)</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>