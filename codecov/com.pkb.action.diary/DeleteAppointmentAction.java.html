<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DeleteAppointmentAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.diary</a> &gt; <span class="el_source">DeleteAppointmentAction.java</span></div><h1>DeleteAppointmentAction.java</h1><pre class="source lang-java linenums">
package com.pkb.action.diary;


import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.calendar.entity.AppointmentDTO;
import com.pkb.calendar.entity.AppointmentRequestDTO;
import com.pkb.institute.entity.Team;
import com.pkb.notification.entity.Activity;
import com.pkb.service.calendar.impl.CalendarManager;
import com.pkb.service.user.impl.UserAccessManager;
import com.pkb.user.entity.PKBPerson;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.Optional;
import java.util.UUID;

import static java.util.Collections.singletonList;

/**
 * For deleting {@link Appointment}s -- confirm and delete.

import io.vavr.Tuple2;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.Optional;
import java.util.UUID;

import static java.util.Collections.singletonList;

/**
 * For deleting {@link Appointment}s -- confirm and delete.


import java.util.Optional;
import java.util.UUID;

import static java.util.Collections.singletonList;

/**
 * For deleting {@link Appointment}s -- confirm and delete.
 *
 * Actions: DELETED_APPOINTMENT
 *
 * @author robwhelan
 */
<span class="fc" id="L52">public class DeleteAppointmentAction extends BaseAction {</span>
    private static final long serialVersionUID = 1L;

<span class="fc" id="L55">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private int month;
    private int year;

    @Autowired
    private UserAccessManager userAccessManager;

    @Autowired
    private CalendarManager calendarManager;

    private UUID uniqueId;

    private AppointmentDTO appointment;

    private Long loggedUserId;
    private boolean callerIsClinician;
    private Long callerTeamId;
    private boolean returnToAppointment;

    private BaseAction.Users setUpVariables() {
<span class="fc" id="L76">        var users = getContextAndLoggedInUsers();</span>
<span class="fc" id="L77">        loggedUserId = users.loggedInUser().getId();</span>
<span class="fc" id="L78">        PKBPerson contextUser = contextUserUtil.getContextUser();</span>

<span class="fc" id="L80">        callerIsClinician = isLoggedInUserProfessional();</span>

<span class="fc" id="L82">        Team callerTeam = loggedInUserUtil.getLoggedInUserPrimaryTeam();</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">        callerTeamId = callerTeam == null ? null : callerTeam.getId();</span>
<span class="fc" id="L84">        return users;</span>
    }

    public String getTab() {
<span class="fc bfc" id="L88" title="All 2 branches covered.">        if (getLoggedInEHRRequestContext().isPatient()) {</span>
<span class="fc" id="L89">            return &quot;diary&quot;;</span>
        } else {
<span class="fc" id="L91">            return &quot;schedule&quot;;</span>
        }
    }

    public String getSubTab() {
<span class="fc" id="L96">        return &quot;calendar&quot;;</span>
    }

    @Override
    public String input() {
<span class="fc bfc" id="L101" title="All 2 branches covered.">        if (uniqueId == null) {</span>
<span class="fc" id="L102">            addActionError(getText(&quot;deleteAppointmentConfirm.txt.noId&quot;));</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">            return returnToAppointment ? RETURN_TO_APPOINTMENT : RETURN_TO_APPOINTMENTS_LIST;</span>
        }

<span class="fc" id="L106">        Optional&lt;AppointmentDTO&gt; maybeAppointment = calendarManager.getAppointmentByUniqueId(getLoggedInEHRRequestContext(), uniqueId, chooseAccountId());</span>

<span class="fc bfc" id="L108" title="All 2 branches covered.">        if (maybeAppointment.isPresent()) {</span>
<span class="fc" id="L109">            appointment = maybeAppointment.get();</span>
        } else {
<span class="fc" id="L111">            addActionError(getText(&quot;deleteAppointmentConfirm.txt.notFound&quot;, singletonList(uniqueId)));</span>
<span class="pc bpc" id="L112" title="1 of 2 branches missed.">            return returnToAppointment ? RETURN_TO_APPOINTMENT : RETURN_TO_APPOINTMENTS_LIST;</span>
        }

<span class="fc" id="L115">        var users = setUpVariables();</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">        if(hasNotPermissionsToDeleteDatapoint(appointment, users.loggedInUser(), loggedInUserUtil.getLoggedInUserPrimaryTeam())){</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">            return returnToAppointment ? RETURN_TO_APPOINTMENT : RETURN_TO_APPOINTMENTS_LIST;</span>
        }

<span class="fc" id="L120">        return Action.SUCCESS;</span>
    }

    @Override
    public String execute() {
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        if (uniqueId == null) {</span>
<span class="nc" id="L126">            addActionError(getText(&quot;deleteAppointmentConfirm.txt.noId&quot;));</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">            return returnToAppointment ? RETURN_TO_APPOINTMENT : RETURN_TO_APPOINTMENTS_LIST;</span>
        }

<span class="fc" id="L130">        Long accountId = chooseAccountId();</span>

<span class="fc" id="L132">        Optional&lt;AppointmentDTO&gt; maybeAppointment = calendarManager.getAppointmentByUniqueId(getLoggedInEHRRequestContext(), uniqueId, chooseAccountId());</span>

<span class="pc bpc" id="L134" title="1 of 2 branches missed.">        if (maybeAppointment.isPresent()) {</span>
<span class="fc" id="L135">            appointment = maybeAppointment.get();</span>
        } else {
<span class="nc" id="L137">            addActionError(getText(&quot;deleteAppointmentConfirm.txt.notFound&quot;, singletonList(uniqueId)));</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">            return returnToAppointment ? RETURN_TO_APPOINTMENT : RETURN_TO_APPOINTMENTS_LIST;</span>
        }
<span class="fc" id="L140">        var users = setUpVariables();</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">        if(hasNotPermissionsToDeleteDatapoint(appointment, users.loggedInUser(), loggedInUserUtil.getLoggedInUserPrimaryTeam())){</span>
<span class="nc bnc" id="L142" title="All 2 branches missed.">            return returnToAppointment ? RETURN_TO_APPOINTMENT : RETURN_TO_APPOINTMENTS_LIST;</span>
        }

<span class="fc" id="L145">        boolean deleted = calendarManager.deleteAppointment(getLoggedInEHRRequestContext(), appointment.getId(), accountId);</span>
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        if (deleted) {</span>
            // notify all participants
<span class="fc" id="L148">            long loggedInUser = loggedInUserUtil.getLoggedInUserId();</span>
<span class="fc bfc" id="L149" title="All 2 branches covered.">            for (AppointmentRequestDTO req : appointment.getAppointmentRequestList()) {</span>
<span class="fc" id="L150">                logActivity(getActivity(Activity.Action.DELETED_APPOINTMENT,</span>
<span class="fc" id="L151">                        appointment.getStartTimestamp(),</span>
<span class="fc" id="L152">                        Long.parseLong(req.getParticipantId()),</span>
<span class="fc" id="L153">                        loggedInUser,</span>
<span class="fc" id="L154">                        appointment.getBaseFields().getUniqueId()),</span>
                        true/*notify*/,
                        null,
                        appointment);
<span class="fc" id="L158">            }</span>
        }
<span class="fc" id="L160">        addActionMessage(getText(&quot;deleteAppointmentConfirm.txt.deleted&quot;));</span>
<span class="fc" id="L161">        return RETURN_TO_APPOINTMENTS_LIST;</span>
    }

    public String cancel() {
<span class="fc bfc" id="L165" title="All 2 branches covered.">        return returnToAppointment ? RETURN_TO_APPOINTMENT : RETURN_TO_APPOINTMENTS_LIST;</span>
    }

    /*
     * If we're a carer or clinician in the patient's account, return the patient's account ID.
     * Otherwise, return the current user's account ID.
     */
    private Long chooseAccountId() {
<span class="fc" id="L173">        Long contextUserId = contextUserUtil.getContextUserId();</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">        if (contextUserId == null) {</span>
<span class="fc" id="L175">            return loggedInUserUtil.getLoggedInUserAccountId();</span>
        } else {
<span class="fc" id="L177">            return userManager.getDefaultAccountId(contextUserId);</span>
        }
    }

    public int getMonth() {
<span class="fc" id="L182">        return month;</span>
    }

    public void setMonth(int month) {
<span class="fc" id="L186">        this.month = month;</span>
<span class="fc" id="L187">    }</span>

    public int getYear() {
<span class="fc" id="L190">        return year;</span>
    }

    public void setYear(int year) {
<span class="fc" id="L194">        this.year = year;</span>
<span class="fc" id="L195">    }</span>

    public AppointmentDTO getAppointment() {
<span class="fc" id="L198">        return appointment;</span>
    }

    public void setAppointment(AppointmentDTO appointment) {
<span class="nc" id="L202">        this.appointment = appointment;</span>
<span class="nc" id="L203">    }</span>

    public void setUniqueId(UUID uniqueId) {
<span class="fc" id="L206">        this.uniqueId = uniqueId;</span>
<span class="fc" id="L207">    }</span>

    public UUID getUniqueId() {
<span class="fc" id="L210">        return uniqueId;</span>
    }

    public boolean isGeneralHealth() {
<span class="pc bpc" id="L214" title="1 of 4 branches missed.">        return appointment == null || appointment.getBaseFields().isGeneralHealthConsentRequired();</span>
    }

    public boolean isMentalHealth() {
<span class="fc" id="L218">        return appointment.getBaseFields().isMentalHealthConsentRequired();</span>
    }

    public boolean isSexualHealth() {
<span class="fc" id="L222">        return appointment.getBaseFields().isSexualHealthConsentRequired();</span>
    }

    public boolean isSocialCare() {
<span class="fc" id="L226">        return appointment.getBaseFields().isSocialCareConsentRequired();</span>
    }

    public boolean isReturnToAppointment() {
<span class="fc" id="L230">        return returnToAppointment;</span>
    }

    public void setReturnToAppointment(boolean returnToAppointment) {
<span class="fc" id="L234">        this.returnToAppointment = returnToAppointment;</span>
<span class="fc" id="L235">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>