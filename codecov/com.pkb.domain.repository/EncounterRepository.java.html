<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EncounterRepository.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.domain.repository</a> &gt; <span class="el_source">EncounterRepository.java</span></div><h1>EncounterRepository.java</h1><pre class="source lang-java linenums">package com.pkb.domain.repository;

import com.pkb.annotation.EHRField.QueryField;
import com.pkb.datamodel.Account;
import com.pkb.datamodel.AccountKeys;
import com.pkb.datamodel.AppMenuDataWithSourceObjects;
import com.pkb.datamodel.Encounter;
import com.pkb.datamodel.ReferenceDatumCache;
import com.pkb.datamodel.authorization.TargetOwnerData;
import com.pkb.datamodel.entity.mapper.EncounterMapper;
import com.pkb.datamodel.user.Patient;
import com.pkb.domain.criteria.CriteriaResult;
import com.pkb.domain.criteria.ImmutableCriteriaResult;
import com.pkb.domain.internal.repository.AbstractMenuDataRepository;
import com.pkb.domain.internal.repository.AppMenuDataRepository;
import com.pkb.domain.internal.repository.JooqSupportRepository;
import com.pkb.domain.internal.repository.ReferenceDatumRepository;
import com.pkb.domain.repository.mapper.AccessFilterMapper;
import com.pkb.ehrdata.AccessFilter;
import com.pkb.ehrdata.Filter;
import com.pkb.ehrdata.ImmutableOrderBy;
import com.pkb.ehrdata.ImmutableSearchSpec;
import com.pkb.ehrdata.SearchSpec;
import com.pkb.entities.enums.MenuDataType;
import com.pkb.entities.enums.ReferenceDataType;
import io.vavr.collection.List;
import io.vavr.control.Option;
import org.hibernate.type.PostgresUUIDType;
import org.jetbrains.annotations.NotNull;
import org.jooq.Condition;
import org.jooq.Query;

import java.time.LocalDateTime;
import java.util.UUID;

import static com.pkb.domain.criteria.CriteriaResult.emptyCriteriaResult;
import static com.pkb.domain.criteria.LowerBound.GREATER_OR_EQUAL;
import static com.pkb.domain.criteria.UpperBound.LESS_OR_EQUAL;
import static com.pkb.ehrdata.Filter.filter;
import static com.pkb.ehrdata.OrderBy.Direction.Asc;
import static io.vavr.API.List;
import static java.util.Comparator.comparing;
import static org.jooq.impl.DSL.field;
import static org.jooq.impl.DSL.inline;
import static org.jooq.impl.DSL.table;
import static org.jooq.impl.SQLDataType.BIGINT;

/**
 * Not a Spring data JPA repository.
 */
public class EncounterRepository extends AbstractMenuDataRepository {
    private final EncounterMapper encounterMapper;
    private final AccessFilterMapper accessFilterMapper;
    private final JooqSupportRepository jooqSupportRepository;

    public EncounterRepository(AppMenuDataRepository menuDataRepository,
                               ReferenceDatumRepository referenceDatumRepository,
                               EncounterMapper encounterMapper,
                               AccessFilterMapper accessFilterMapper,
                               JooqSupportRepository jooqSupportRepository,
                               PersonRepository personRepository) {
<span class="fc" id="L62">        super(menuDataRepository, referenceDatumRepository, personRepository);</span>
<span class="fc" id="L63">        this.encounterMapper = encounterMapper;</span>
<span class="fc" id="L64">        this.accessFilterMapper = accessFilterMapper;</span>
<span class="fc" id="L65">        this.jooqSupportRepository = jooqSupportRepository;</span>
<span class="fc" id="L66">    }</span>

    public @NotNull CriteriaResult&lt;Encounter&gt; findBy(EncounterQuery query) {

<span class="fc" id="L70">        AccessFilter accessFilter = accessFilterMapper.buildAccessFilter(query.authData());</span>
<span class="fc" id="L71">        TargetOwnerData targetOwnerData = query.authData().requireSingleTargetData();</span>
<span class="fc" id="L72">        Account account = targetOwnerData.account();</span>

        // Step 1: find encounter.ids for candidate events which have at least one record in the required range

<span class="fc" id="L76">        Option&lt;LocalDateTime&gt; lowerBound = Option.of(query.dateRestriction()</span>
<span class="fc" id="L77">                .getLowerBound()</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">                .map(restriction -&gt; restriction.getConstraint() == GREATER_OR_EQUAL ?</span>
<span class="nc" id="L79">                        restriction.getValue().atStartOfDay() :</span>
<span class="fc" id="L80">                        restriction.getValue().plusDays(1L).atStartOfDay())</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">                .getOrElse(() -&gt; query.dateRestriction().getEquality().isDefined() ?</span>
<span class="fc" id="L82">                        query.dateRestriction().getEquality().get().atStartOfDay() :</span>
<span class="fc" id="L83">                        null));</span>
<span class="fc" id="L84">        Option&lt;LocalDateTime&gt; upperBound = Option.of(query.dateRestriction()</span>
<span class="fc" id="L85">                .getUpperBound()</span>
<span class="pc bpc" id="L86" title="1 of 2 branches missed.">                .map(restriction -&gt; restriction.getConstraint() == LESS_OR_EQUAL ?</span>
<span class="nc" id="L87">                        restriction.getValue().plusDays(1L).atStartOfDay() :</span>
<span class="fc" id="L88">                        restriction.getValue().atStartOfDay())</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">                .getOrElse(() -&gt; query.dateRestriction().getEquality().isDefined() ?</span>
<span class="fc" id="L90">                        query.dateRestriction().getEquality().get().plusDays(1L).atStartOfDay() :</span>
<span class="fc" id="L91">                        null));</span>

<span class="fc" id="L93">        List&lt;UUID&gt; candidateEncounterIds = null;</span>
<span class="fc" id="L94">        Long accountId = account.getId();</span>

<span class="fc bfc" id="L96" title="All 4 branches covered.">        if (lowerBound.isDefined() || upperBound.isDefined()) {</span>

<span class="fc" id="L98">            List&lt;Condition&gt; conditions = List(</span>
<span class="fc" id="L99">                field(&quot;account_id&quot;, BIGINT).eq(inline(accountId)),</span>
<span class="fc" id="L100">                field(&quot;datatype&quot;).eq(inline(MenuDataType.encounterEvent.name())),</span>
<span class="fc" id="L101">                field(&quot;string14&quot;).isNull() // Hack to exclude documents - see GDE-80</span>
            );
<span class="fc" id="L103">            conditions = conditions.appendAll(lowerBound.map(b -&gt; field(&quot;date01&quot;).ge(inline(b))));</span>
<span class="fc" id="L104">            conditions = conditions.appendAll(upperBound.map(b -&gt; field(&quot;date01&quot;).lt(inline(b))));</span>

<span class="fc" id="L106">            Query jooqQuery = jooqSupportRepository.context().selectDistinct(field(QueryField.uuid01.name())).from(table(&quot;app.menu_data&quot;)).where(conditions.toJavaList()).getQuery();</span>
            //noinspection unchecked
<span class="fc" id="L108">            candidateEncounterIds = jooqSupportRepository.nativeListQuery(jooqQuery, jpaQ -&gt; jpaQ.unwrap(org.hibernate.query.NativeQuery.class).addScalar(QueryField.uuid01.name(), PostgresUUIDType.INSTANCE));</span>

<span class="fc bfc" id="L110" title="All 2 branches covered.">            if (candidateEncounterIds.isEmpty()) {</span>
<span class="fc" id="L111">                return emptyCriteriaResult();</span>
            }
        }

        // Step 2: find all encounters the caller is allowed to see
<span class="fc" id="L116">        ImmutableSearchSpec.Builder searchSpecBuilder = ImmutableSearchSpec.builder()</span>
<span class="fc" id="L117">                .addAccountId(accountId)</span>
<span class="fc" id="L118">                .addDataType(MenuDataType.encounterEvent.name())</span>
<span class="fc" id="L119">                .addFilter(filter(&quot;string14&quot;, Filter.Operator.IS_NULL)) // Hack to exclude documents - see GDE-80</span>
<span class="fc" id="L120">                .orderBy(ImmutableOrderBy.builder().direction(Asc).field(&quot;date01&quot;).build())</span>
<span class="fc" id="L121">                .includeDeleted(false);</span>

<span class="fc bfc" id="L123" title="All 2 branches covered.">        if (candidateEncounterIds != null) {</span>
<span class="fc" id="L124">            searchSpecBuilder.addFilter(filter(QueryField.uuid01.name(), Filter.Operator.IN, candidateEncounterIds.asJava()));</span>
        }

<span class="fc" id="L127">        SearchSpec searchSpec = searchSpecBuilder.build();</span>

<span class="fc" id="L129">        List&lt;Long&gt; ids = find(searchSpec, accessFilter);</span>
<span class="fc bfc" id="L130" title="All 2 branches covered.">        if (ids.isEmpty()) {</span>
<span class="fc" id="L131">            return emptyCriteriaResult();</span>
        }

<span class="fc" id="L134">        List&lt;AppMenuDataWithSourceObjects&gt; records = findMenuDatasByIds(ids);</span>

        // Extract data id/text, and map by org id
<span class="fc" id="L137">        ReferenceDatumCache referenceDatumCache = getReferenceDatumCache(records, ReferenceDataType.HOSPITAL_SERVICE);</span>

        // Shortcut here, don't re-fetch the patient we already have them in the auth data.
<span class="fc" id="L140">        Patient patient = (Patient) query.authData().requireSingleTargetData().person();</span>
<span class="fc" id="L141">        AccountKeys accountKeys = checkAccountKeys(targetOwnerData, records);</span>
<span class="fc" id="L142">        List&lt;Encounter&gt; events = encounterMapper.menuDatasToEncounters(accountKeys, records, patient, referenceDatumCache)</span>
<span class="fc" id="L143">                .filter(encounter -&gt; {</span>
                    // Equal search does not allow date range intersection. The range of the search value fully
                    // contains the range of the target value therefore we filter fully contained Encounters only.
<span class="fc bfc" id="L146" title="All 2 branches covered.">                    return !query.dateRestriction().getEquality().isDefined() ||</span>
<span class="pc bpc" id="L147" title="1 of 4 branches missed.">                            (lowerBound.isDefined() &amp;&amp; encounter.getStart().isAfter(lowerBound.get().atZone(encounter.getStart().getZone())) &amp;&amp;</span>
<span class="pc bpc" id="L148" title="1 of 4 branches missed.">                            upperBound.isDefined() &amp;&amp; encounter.getEnd().isBefore(upperBound.get().atZone(encounter.getEnd().getZone())));</span>
                })
<span class="fc" id="L150">                .sorted(comparing(Encounter::getStart).thenComparing(Encounter::getId));</span>

        // Quick implementation of maxNumberOfResources
<span class="fc" id="L153">        long total = events.size();</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if (total &gt; query.maxNumberOfResources()) {</span>
<span class="nc" id="L155">            events = events.take(query.maxNumberOfResources());</span>
        }

<span class="fc" id="L158">        return ImmutableCriteriaResult.&lt;Encounter&gt;builder()</span>
<span class="fc" id="L159">                .addAllPage(events)</span>
<span class="fc" id="L160">                .total(total)</span>
<span class="fc" id="L161">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>