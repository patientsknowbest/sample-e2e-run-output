<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractAggregatedResourceSearch.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.aggregator.camel.bean.search</a> &gt; <span class="el_source">AbstractAggregatedResourceSearch.kt</span></div><h1>AbstractAggregatedResourceSearch.kt</h1><pre class="source lang-java linenums">package com.pkb.aggregator.camel.bean.search

import com.pkb.aggregator.camel.DOWNSTREAM_RESOURCE_ID_PROPERTY
import com.pkb.aggregator.camel.IDENTIFIERS_PROPERTY
import com.pkb.aggregator.camel.RELOAD_REQUEST_PROPERTY
import com.pkb.aggregator.camel.SOURCED_RESOURCE_PROPERTY
import com.pkb.aggregator.camel.UPSTREAM_IDENTIFIERS_PROPERTY
import com.pkb.aggregator.camel.UPSTREAM_IDENTIFIER_SEARCH_TERM_PROPERTY
import com.pkb.aggregator.camel.UPSTREAM_SOURCE_ID_PROPERTY
import com.pkb.aggregator.camel.routing.createFhirIdentifierSearch
import com.pkb.aggregator.persistence.entity.IdentifierMapEntry
import com.pkb.aggregator.persistence.entity.embeddable.UpstreamIdentifier
import com.pkb.aggregator.persistence.entity.embeddable.UpstreamResource
import com.pkb.aggregator.service.DownstreamClient
import com.pkb.aggregator.service.dto.ReloadRequest
import com.pkb.aggregator.service.dto.ResourceWithSourceId
import com.pkb.aggregator.service.paginate.ResourcePaginator
import org.apache.camel.Body
import org.apache.camel.ExchangeProperties
import org.apache.camel.ExchangeProperty
import org.hl7.fhir.instance.model.api.IAnyResource
import org.hl7.fhir.instance.model.api.IBaseBundle
import org.hl7.fhir.instance.model.api.IDomainResource

<span class="fc" id="L25">abstract class AbstractAggregatedResourceSearch&lt;in T : IDomainResource, E : IdentifierMapEntry&gt;(</span>
<span class="fc" id="L26">    private val resourcePaginator: ResourcePaginator,</span>
<span class="fc" id="L27">    private val downstreamClient: DownstreamClient,</span>
) : PaginatedSearch {

    fun findAllIdentifiers(
        @Body resourceWithSourceId: ResourceWithSourceId&lt;T&gt;,
        @ExchangeProperties properties: MutableMap&lt;String, Any&gt;
    ) {
<span class="fc" id="L34">        val resource = resourceWithSourceId.resource</span>
<span class="fc" id="L35">        val identifiers = findIdentifiers(resource)</span>

<span class="fc" id="L37">        properties[SOURCED_RESOURCE_PROPERTY] = resourceWithSourceId</span>
<span class="fc" id="L38">        properties[IDENTIFIERS_PROPERTY] = identifiers</span>

<span class="fc bfc" id="L40" title="All 4 branches covered.">        if (identifiers.isNotEmpty()) {</span>
<span class="fc" id="L41">            assertSameDownstreamResourceId(identifiers, resourceWithSourceId)</span>
<span class="fc" id="L42">            properties[DOWNSTREAM_RESOURCE_ID_PROPERTY] = getDownstreamResourceId(identifiers)</span>
        }
<span class="fc" id="L44">    }</span>

    fun findDownstreamIdByDeltaNotification(
        @ExchangeProperties properties: MutableMap&lt;String, Any&gt;,
        @ExchangeProperty(UPSTREAM_SOURCE_ID_PROPERTY) upstreamSourceId: UpstreamResource,
    ) {
<span class="nc bnc" id="L50" title="All 2 branches missed.">        properties[DOWNSTREAM_RESOURCE_ID_PROPERTY] = findIdentifiers(upstreamSourceId)</span>
<span class="nc" id="L51">            .firstOrNull()</span>
<span class="nc bnc" id="L52" title="All 2 branches missed.">            ?.downstreamResourceId</span>
<span class="nc" id="L53">            ?: throw RuntimeException(&quot;Could not find downstream resource id for ${upstreamSourceId.upstreamResourceId}&quot;)</span>
<span class="nc" id="L54">    }</span>

    open fun createSearchUrl(
        @Body request: ReloadRequest,
        @ExchangeProperties properties: MutableMap&lt;String, Any&gt;,
    ): String {
<span class="nc" id="L60">        val knownIdentifiers = findSearchIdentifiers(request.system, request.value)</span>
<span class="nc bnc" id="L61" title="All 4 branches missed.">        val searchIdentifiers = if (knownIdentifiers.isNotEmpty()) {</span>
<span class="nc" id="L62">            properties[DOWNSTREAM_RESOURCE_ID_PROPERTY] = getDownstreamResourceId(knownIdentifiers)</span>
<span class="nc" id="L63">            knownIdentifiers.map { it.mapEntryKey.identifier }</span>
        } else {
<span class="nc" id="L65">            listOf(UpstreamIdentifier(request.system, request.value))</span>
        }

<span class="nc" id="L68">        return createAndTrackSearchInfo(request, properties, searchIdentifiers)</span>
    }

<span class="nc" id="L71">    override fun processBundle(bundle: IBaseBundle) = resourcePaginator.processBundle(bundle)</span>

    override fun getAccumulatedResources(properties: Map&lt;String, Any&gt;): MutableList&lt;IAnyResource&gt; {
<span class="nc" id="L74">        throw NotImplementedError(&quot;Not implemented for ${this.javaClass.canonicalName}&quot;)</span>
    }

    override fun getAccumulatedPageLinks(properties: Map&lt;String, Any&gt;): MutableList&lt;String&gt; {
<span class="nc" id="L78">        throw NotImplementedError(&quot;Not implemented for ${this.javaClass.canonicalName}&quot;)</span>
    }

    protected fun createAndTrackSearchInfo(
        request: ReloadRequest,
        properties: MutableMap&lt;String, Any&gt;,
        searchIdentifiers: List&lt;UpstreamIdentifier&gt;
    ): String {
<span class="nc" id="L86">        properties[RELOAD_REQUEST_PROPERTY] = request</span>
<span class="nc" id="L87">        properties[UPSTREAM_IDENTIFIERS_PROPERTY] = searchIdentifiers</span>
<span class="nc" id="L88">        val identifierSearch = createFhirIdentifierSearch(searchIdentifiers)</span>
<span class="nc" id="L89">        properties[UPSTREAM_IDENTIFIER_SEARCH_TERM_PROPERTY] = identifierSearch</span>
<span class="nc" id="L90">        return identifierSearch</span>
    }

    protected abstract fun findIdentifiers(resource: T): List&lt;E&gt;
    protected abstract fun findIdentifiers(upstreamSourceId: UpstreamResource): List&lt;E&gt;
    protected abstract fun findSearchIdentifiers(upstreamSystem: String, upstreamValue: String): List&lt;E&gt;
    protected abstract fun getDownstreamResourceId(identifiers: List&lt;E&gt;): String

    private fun assertSameDownstreamResourceId(identifiers: List&lt;E&gt;, resourceWithSourceId: ResourceWithSourceId&lt;T&gt;) {
<span class="fc" id="L99">        val downstreamResourceIds = identifiers.map { it.downstreamResourceId }.toSet()</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">        if (downstreamResourceIds.size &gt; 1) {</span>
<span class="nc" id="L101">            val (source, resource) = resourceWithSourceId</span>
<span class="nc" id="L102">            throw RuntimeException(&quot;Found multiple downstream resource ids for ${resource.id} from $source: $downstreamResourceIds&quot;)</span>
        }
<span class="fc" id="L104">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>