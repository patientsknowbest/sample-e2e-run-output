<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PKBEmailMessageManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.emailmessage.impl</a> &gt; <span class="el_source">PKBEmailMessageManager.java</span></div><h1>PKBEmailMessageManager.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------
//
//Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: file_name May 25, 2009 1:16:38 PM prabodhs$
//
//------------------------------------------------------------------------------
package com.pkb.service.emailmessage.impl;

import com.google.common.annotations.VisibleForTesting;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.interfaces.IBaseDTO;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.consent.model.NoConsentsRequired;
import com.pkb.datamodel.Email;
import com.pkb.datamodel.OrgNetwork;
import com.pkb.datamodel.OrgNetworkExisting;
import com.pkb.datamodel.OrgNetworkMemberView;
import com.pkb.datamodel.consent.PatientConsentBaseDTO;
import com.pkb.datamodel.consent.PatientConsentDTO;
import com.pkb.datamodel.consent.RequiresConsent;
import com.pkb.datamodel.team.TeamWithOrg;
import com.pkb.encounter.entity.PKBInvitation;
import com.pkb.entities.enums.AccessingEntityType;
import com.pkb.entities.enums.MenuDataType;
import com.pkb.entities.enums.Message;
import com.pkb.entities.enums.PrivacyFlag;
import com.pkb.entities.enums.UserStatus;
import com.pkb.entities.enums.UserType;
import com.pkb.exception.FormattingException;
import com.pkb.exception.InvalidEmailAddressException;
import com.pkb.exception.MailException;
import com.pkb.exception.NoEmailAddressException;
import com.pkb.exception.PKBException;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import com.pkb.notification.entity.Activity;
import com.pkb.phplan.entity.PHPlanTemplate;
import com.pkb.reminders.dto.EHRMessageDTO;
import com.pkb.service.emailmessage.IAddressInfoProvider;
import com.pkb.service.notification.impl.tolven.AccessUpdate;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.phplan.PlanExportManager;
import com.pkb.service.reminders.ReminderManager;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PersonContact;
import com.pkb.util.AppResourceBundle;
import com.pkb.util.Constants;
import com.pkb.util.EmailUtil;
import com.pkb.util.PKBConstants;
import io.prometheus.client.Counter;
import io.prometheus.client.Summary;
import io.vavr.collection.Stream;
import io.vavr.control.Option;
import org.apache.commons.lang3.StringUtils;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.Instant;
import java.time.ZoneOffset;
import java.time.ZonedDateTime;
import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Optional;
import java.util.UUID;
import java.util.function.BiConsumer;
import java.util.function.BiFunction;
import java.util.function.BiPredicate;
import java.util.function.Consumer;
import java.util.regex.Pattern;

import static com.google.common.base.Preconditions.checkArgument;
import static com.pkb.entities.enums.Message.NOTIFY_COORDINATOR_BULK_ACCOUNT_CREATION_COMPLETED;
import static com.pkb.entities.enums.Message.NOTIFY_COORDINATOR_BULK_ACCOUNT_CREATION_FAILED;
import static com.pkb.entities.enums.Message.PRIVACY_LABEL_NOTIFICATION_TO_PATIENT;
import static com.pkb.entities.enums.Message.RESET_PASSWORD;
import static com.pkb.entities.enums.Message.RESET_PASSWORD_BY_SUPER_ADMIN;
import static com.pkb.entities.enums.Message.UNREAD_DOCUMENT_REMINDER;
import static com.pkb.entities.enums.UserType.PATIENT;
import static com.pkb.notification.entity.Activity.Action.ACCEPTED_INVITATION;
import static com.pkb.notification.entity.Activity.Action.CREATED_ACCOUNT;
import static com.pkb.notification.entity.Activity.Action.DOCUMENT_RECEIVED;
import static com.pkb.notification.entity.Activity.Action.EXPORTED_PLANS;
import static com.pkb.notification.entity.Activity.Action.SENT_INVITATION;
import static com.pkb.notification.entity.Activity.Action.SENT_MESSAGE;
import static com.pkb.service.notification.impl.tolven.AccessUpdate.ACCESS_GRANT;
import static com.pkb.util.AppResourceBundle.MISCELLANEOUS_LABELS_BUNDLE_NAME;
import static io.vavr.API.unchecked;
import static io.vavr.collection.List.ofAll;
import static java.lang.Boolean.FALSE;
import static java.lang.Boolean.TRUE;
import static org.apache.commons.lang3.StringUtils.defaultString;
import static org.apache.commons.lang3.StringUtils.isNotBlank;


public class PKBEmailMessageManager {

<span class="fc" id="L107">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

<span class="fc" id="L109">    private static final Pattern LINUX_NEWLINE_PATTERN = Pattern.compile(&quot;\n&quot;);</span>

<span class="fc" id="L111">    private static final DateTimeFormatter SUPPORT_CODE_FORMATTER = DateTimeFormatter.ofPattern(&quot;yyyyMMddHHmmss&quot;).withLocale(Locale.UK).withZone(Constants.APPLICATION_TZ);</span>
<span class="fc" id="L112">    private static final DateTimeFormatter DATE_FORMAT = DateTimeFormatter.ofPattern(&quot;dd MMM yyyy&quot;).withLocale(Locale.UK).withZone(Constants.APPLICATION_TZ);</span>

<span class="fc" id="L114">    static int REMINDER_BATCH_SIZE = 200;</span>

<span class="fc" id="L116">    private static final Counter REMINDER_EMAIL_COUNTER = Counter.build()</span>
<span class="fc" id="L117">            .name(&quot;pkb_phr_reminder_email&quot;)</span>
<span class="fc" id="L118">            .labelNames(&quot;type&quot;)</span>
<span class="fc" id="L119">            .help(&quot;Reminder email count&quot;)</span>
<span class="fc" id="L120">            .register();</span>

<span class="fc" id="L122">    private static final Summary EMAIL_SENDING_METRICS = Summary.build()</span>
<span class="fc" id="L123">            .name(&quot;pkb_phr_email_sending_duration&quot;)</span>
<span class="fc" id="L124">            .labelNames(&quot;type&quot;)</span>
<span class="fc" id="L125">            .help(&quot;duration of sending notification email&quot;)</span>
<span class="fc" id="L126">            .quantile(0.5, 0.05)</span>
<span class="fc" id="L127">            .quantile(0.95, 0.01)</span>
<span class="fc" id="L128">            .register();</span>

    private final PhrConfig config;
    private final EmailManager emailManager;
    private final ReminderManager reminderManager;
    private final TeamUserManager teamUserManager;
    private final TeamManager teamManager;
    private final IAddressInfoProvider formatter;
    private TemplateParamsFactory paramsFactory;
    private final DateTimeService dateTimeService;
    private final PatientConsentManager patientConsentManager;

    public PKBEmailMessageManager(PhrConfig config, EmailManager emailManager, ReminderManager reminderManager,
                                  TeamUserManager teamUserManager, TeamManager teamManager,IAddressInfoProvider formatter,

                                  TemplateParamsFactory paramsFactory, DateTimeService dateTimeService,
<span class="fc" id="L144">                                  PatientConsentManager patientConsentManager) {</span>
<span class="fc" id="L145">        this.config = config;</span>
<span class="fc" id="L146">        this.emailManager = emailManager;</span>
<span class="fc" id="L147">        this.reminderManager = reminderManager;</span>
<span class="fc" id="L148">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L149">        this.teamManager = teamManager;</span>
<span class="fc" id="L150">        this.formatter = formatter;</span>
<span class="fc" id="L151">        this.paramsFactory = paramsFactory;</span>
<span class="fc" id="L152">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L153">        this.patientConsentManager = patientConsentManager;</span>
<span class="fc" id="L154">    }</span>

    //Integration tests fiddle with it...
    @VisibleForTesting
    public void setParamsFactory(TemplateParamsFactory paramsFactory) {
<span class="nc" id="L159">        this.paramsFactory = paramsFactory;</span>
<span class="nc" id="L160">    }</span>

    public void sendSymptomReminders() {
<span class="fc" id="L163">        LOGGER.debug(&quot;Entering sendSymptomsReminders&quot;);</span>
<span class="fc" id="L164">        boolean enabled = config.getSendReminderEmailsEnabled();</span>
<span class="pc bpc" id="L165" title="1 of 2 branches missed.">        if (!enabled) {</span>
<span class="nc" id="L166">            return;</span>
        }
<span class="fc" id="L168">        doSendSymptomReminders();</span>
<span class="fc" id="L169">    }</span>

    /**
     * Notify user that there is an unread message (Web) from the previous day.
     */
    public void sendUnreadMessageReminder() {
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if (config.isUnreadMessageReminderEnabled()) {</span>
<span class="fc" id="L176">            sendReminders(reminderManager::getUnreadMessageReminderEmailAddressBatch, this::sendReminderToPatient, Message.UNREAD_MESSAGE_REMINDER);</span>
        }
<span class="fc" id="L178">    }</span>

    /**
     * Notify user that there is an unread HL7 document from the previous day.
     */
    public void sendUnreadDocumentReminder() {
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">        if (config.isUnreadDocumentReminderEnabled()) {</span>
<span class="fc" id="L185">            sendReminders(reminderManager::getUnreadDocumentReminderEmailAddressBatch, this::sendReminderToPatient, Message.UNREAD_DOCUMENT_REMINDER);</span>
        }
<span class="fc" id="L187">    }</span>

    private void sendReminders(BiFunction&lt;Integer, Integer, List&lt;EHRMessageDTO&gt;&gt; getBatch, BiConsumer&lt;EHRMessageDTO, Message&gt; sendReminder, Message messageType) {
<span class="fc" id="L190">        LOGGER.debug(&quot;searching for email recipients&quot;);</span>
<span class="fc" id="L191">        int offset = 0;</span>
        List&lt;EHRMessageDTO&gt; emailBatch;

        do {
<span class="fc" id="L195">            emailBatch = getBatch.apply(REMINDER_BATCH_SIZE, offset);</span>
<span class="fc" id="L196">            offset += emailBatch.size();</span>
<span class="fc" id="L197">            LOGGER.info(&quot;found {} recipients&quot;, emailBatch.size());</span>
<span class="fc" id="L198">            emailBatch.forEach(p -&gt; sendReminder.accept(p, messageType));</span>
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">        } while (emailBatch.size() == REMINDER_BATCH_SIZE);</span>
<span class="fc" id="L200">    }</span>

    private void sendReminderToPatient(EHRMessageDTO messageDTO, Message messageType) {
<span class="fc" id="L203">        REMINDER_EMAIL_COUNTER.labels(messageType.name()).inc();</span>
<span class="fc" id="L204">        PKBPerson person = messageDTO.getReceiver();</span>
<span class="fc" id="L205">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L206">        properties.put(PKBConstants.FIRST_NAME, person.getFirstName());</span>
<span class="fc" id="L207">        properties.put(PKBConstants.LAST_NAME, person.getLastName());</span>
<span class="fc" id="L208">        properties.put(PKBConstants.USER_ID, person.getId());</span>
<span class="fc" id="L209">        properties.put(PKBConstants.TITLE, person.getTitle());</span>
<span class="fc" id="L210">        properties.put(PKBConstants.SENDER_TITLE, messageDTO.getSourceTitle());</span>
<span class="fc" id="L211">        properties.put(PKBConstants.SENDER_FIRST_NAME, messageDTO.getSourceFirstName());</span>
<span class="fc" id="L212">        properties.put(PKBConstants.SENDER_LAST_NAME, messageDTO.getSourceLastName());</span>
<span class="fc" id="L213">        properties.put(PKBConstants.ORGANIZATION_NAME, messageDTO.getSourceOrg());</span>
<span class="fc" id="L214">        properties.put(PKBConstants.CONVERSATION_ID, messageDTO.getConversationId());</span>
<span class="fc" id="L215">        properties.put(PKBConstants.MESSAGE_ID, messageDTO.getMessageId());</span>
<span class="fc" id="L216">        properties.put(PKBConstants.EMAIL_RECEIVED_DATE,</span>
<span class="fc" id="L217">                DateTimeFormatter.ofPattern(&quot;dd/MM/YY&quot;).format(messageDTO.getReceived()));// TODO? using the patients timezone?</span>

<span class="fc" id="L219">        Summary.Timer reminderTimer = EMAIL_SENDING_METRICS.labels(&quot;reminder_email&quot;).startTimer();</span>
        try {
<span class="fc bfc" id="L221" title="All 2 branches covered.">            BiPredicate&lt;Message, EHRMessageDTO&gt; isNotADocumentReminderOrItWasReceivedLessThanOneWeekAgo = (type, dto) -&gt; type != UNREAD_DOCUMENT_REMINDER ||</span>
<span class="pc bpc" id="L222" title="1 of 2 branches missed.">                    new Activity(dto.getReceived().toInstant(ZoneOffset.UTC), DOCUMENT_RECEIVED).sendHistorical(dateTimeService.now());</span>

<span class="pc bpc" id="L224" title="1 of 2 branches missed.">            if (isNotADocumentReminderOrItWasReceivedLessThanOneWeekAgo.test(messageType, messageDTO)) {</span>
                // note - for now we only send the reminder email to the patient, not to carers.
<span class="fc" id="L226">                emailManager.sendSystemMessage(messageType, null, formatter.getContact(person.getEmail()).getOrNull(), person, properties,</span>
<span class="fc" id="L227">                        person.getLocale(), null, messageDTO.getOrg().getOrNull(), messageDTO.getTeam());</span>
            }
<span class="nc" id="L229">        } catch (MailException e) {</span>
<span class="nc" id="L230">            LOGGER.error(&quot;Error sending message to person id: {}&quot;, person.getId(), e);</span>
        } finally {
<span class="fc" id="L232">            reminderTimer.observeDuration();</span>
        }
<span class="fc" id="L234">    }</span>

    public void doSendSymptomReminders() {
<span class="fc" id="L237">        LOGGER.debug(&quot;searching for email recipients&quot;);</span>
<span class="fc" id="L238">        long minPersonId = -1L;</span>
        List&lt;PKBPerson&gt; emailBatch;

        do {
<span class="fc" id="L242">            emailBatch = reminderManager.getSymptomReminderEmailAddressBatch(REMINDER_BATCH_SIZE, minPersonId);</span>

<span class="pc bpc" id="L244" title="1 of 2 branches missed.">            if (!emailBatch.isEmpty()) {</span>
<span class="fc" id="L245">                minPersonId = emailBatch.get(emailBatch.size() - 1).getId();</span>
            }

<span class="fc" id="L248">            LOGGER.info(&quot;found {} recipients&quot;, emailBatch.size());</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">            for (PKBPerson person : emailBatch) {</span>

                try {
<span class="fc" id="L252">                    sendSymptomsReminderMessage(person);</span>
<span class="nc" id="L253">                } catch (PKBException e) {</span>
<span class="nc" id="L254">                    LOGGER.error(&quot;Error sending message to person id: {}&quot;, person.getId(), e);</span>
<span class="fc" id="L255">                }</span>
<span class="fc" id="L256">            }</span>
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">        } while (emailBatch.size() == REMINDER_BATCH_SIZE);</span>
<span class="fc" id="L258">    }</span>

    private void sendSymptomsReminderMessage(PKBPerson person) {

<span class="fc" id="L262">        LOGGER.info(&quot;Entering sendSymptomsReminderMessage&quot;);</span>
<span class="fc" id="L263">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L264">        properties.put(PKBConstants.FIRST_NAME, person.getFirstName());</span>
<span class="fc" id="L265">        properties.put(PKBConstants.LAST_NAME, person.getLastName());</span>
<span class="fc" id="L266">        properties.put(PKBConstants.USER_ID, person.getId());</span>
<span class="fc" id="L267">        properties.put(PKBConstants.TITLE, person.getTitle());</span>

        try {
            //note - for now we only send the reminder email to the patient, not to carers.
<span class="fc" id="L271">            emailManager.sendSystemMessage(Message.SYMPTOMS_REMINDER, null, formatter.getContact(person.getEmail()).getOrNull(), person, properties,</span>
<span class="fc" id="L272">                    person.getLocale(), null, null, null);</span>
<span class="nc" id="L273">        } catch (MailException e) {</span>
<span class="nc" id="L274">            LOGGER.error(&quot;Error sending message to person id: {}&quot;, person.getId(), e);</span>
<span class="fc" id="L275">        }</span>
<span class="fc" id="L276">    }</span>

    /**
     * Send email verification to verify email provided by patient to complete letter invitation process
     */
    public void sendEmailVerificationMessage(@NotNull PKBPerson patient, Email claimedEmail, @NotNull String verificationCode,
                                             @Nullable Team team, String actorId) {
<span class="fc" id="L283">        checkArgument(isNotBlank(verificationCode));</span>
        try {
<span class="fc" id="L285">            LOGGER.info(&quot;Entering sendEmailVerificationMessage&quot;);</span>
<span class="fc" id="L286">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L287">            addNameDetails(patient, properties);</span>

<span class="fc" id="L289">            List&lt;String&gt; queryParams = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L290">            queryParams.add(&quot;verificationCode=&quot; + verificationCode);</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">            String teamCode = team != null ? team.getCode() : null;</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">            if (StringUtils.isNotBlank(teamCode)) {</span>
<span class="fc" id="L293">                queryParams.add(&quot;clue=&quot; + teamCode.trim());</span>
            }

<span class="fc" id="L296">            properties.put(PKBConstants.QUERY_STRING, StringUtils.join(queryParams, '&amp;'));</span>
<span class="fc" id="L297">            emailManager.sendMessage(Message.EMAIL_VERIFICATION, null,</span>
<span class="fc" id="L298">                    formatter.getContact(patient.getFirstName(), patient.getLastName(), claimedEmail).getOrNull(), patient,</span>
<span class="fc" id="L299">                    properties, patient.getLocale(), null, actorId, getOrg(team), team);</span>

<span class="nc" id="L301">        } catch (MailException exception) {</span>
<span class="nc" id="L302">            LOGGER.error(&quot;Error while sending email verification message &quot;, exception);</span>
<span class="nc" id="L303">            String eMessage = exception.getMessage();</span>
<span class="nc bnc" id="L304" title="All 2 branches missed.">            if (eMessage.contains(&quot;invalid email address&quot;)) {</span>
<span class="nc" id="L305">                throw new InvalidEmailAddressException(exception);</span>
            }
<span class="nc" id="L307">            throw new PKBException(&quot;Unable to send activation mail to: &quot; + patient.getId(), exception);</span>
<span class="fc" id="L308">        }</span>
<span class="fc" id="L309">        LOGGER.info(&quot;Exiting sendEmailVerificationMessage&quot;);</span>
<span class="fc" id="L310">    }</span>

    /**
     * Send confirmation email to registered user to notify them that they can now access their account after having
     * been previously locked-out by the out-of-area problem
     */
    public void sendOutOfAreaDeferredActivationMessage(@NotNull PKBPerson patient) {
        try {
<span class="fc" id="L318">            LOGGER.info(&quot;Entering sendOutOfAreaDeferredActivationMessage&quot;);</span>
<span class="fc" id="L319">            Map&lt;String, Object&gt; properties = getPropertiesWithPatient(patient);</span>

<span class="fc" id="L321">            emailManager.sendSystemMessage(</span>
                    Message.OUT_OF_AREA_DEFERRED_ACTIVATION,
                    null,
<span class="fc" id="L324">                    formatter.getPrimaryAndSecondaryContacts(patient, new NoConsentsRequired()),</span>
                    patient,
                    properties,
<span class="fc" id="L327">                    patient.getLocale(),null, null, null);</span>

<span class="nc" id="L329">        } catch (MailException exception) {</span>
<span class="nc" id="L330">            LOGGER.error(&quot;Error while sending out-of-area deferred activation message &quot;, exception);</span>
<span class="nc" id="L331">            String eMessage = exception.getMessage();</span>
<span class="nc bnc" id="L332" title="All 2 branches missed.">            if (StringUtils.containsIgnoreCase(eMessage, &quot;invalid email address&quot;)) {</span>
<span class="nc" id="L333">                throw new InvalidEmailAddressException(exception);</span>
            }
<span class="nc" id="L335">            throw new PKBException(&quot;Unable to send activation mail to: &quot; + patient.getId(), exception);</span>
<span class="fc" id="L336">        }</span>
<span class="fc" id="L337">        LOGGER.info(&quot;Exiting sendOutOfAreaDeferredActivationMessage&quot;);</span>
<span class="fc" id="L338">    }</span>

    /**
     * Send email confirmation email to registered user to complete the registration process
     *
     * @param requestContext the request context
     * @param user           {@link PKBPerson} object
     * @param team           team code
     * @param specialtyId    clinician's chosen specialty (null for other users)
     */
    public void sendActivationMessage(PKBPerson user, Team team, Long specialtyId) {
        try {
<span class="fc" id="L350">            LOGGER.debug(&quot;Entering sendActivationMessage &quot;);</span>
<span class="fc" id="L351">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L352">            addNameDetails(user, properties);</span>

            // query string = uid, plus (if needed) institute code and specialty id
            // do not include &quot;?&quot; here.
<span class="fc" id="L356">            List&lt;String&gt; queryParams = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L357">            queryParams.add(&quot;uid=&quot; + user.getId());</span>
<span class="pc bpc" id="L358" title="1 of 2 branches missed.">            if (StringUtils.isNotBlank(team.getCode())) {</span>
<span class="fc" id="L359">                queryParams.add(&quot;icode=&quot; + team.getCode().trim());</span>
            }
<span class="pc bpc" id="L361" title="3 of 4 branches missed.">            if ((specialtyId != null) &amp;&amp; (specialtyId &gt; 0)) {</span>
<span class="nc" id="L362">                queryParams.add(&quot;sid=&quot; + specialtyId);</span>
            }
<span class="fc" id="L364">            properties.put(PKBConstants.QUERY_STRING, StringUtils.join(queryParams, '&amp;'));</span>

<span class="fc" id="L366">            emailManager.sendSystemMessage(Message.ACTIVATION, null,</span>
<span class="fc" id="L367">                    formatter.getPrimaryAndSecondaryContacts(user, new NoConsentsRequired()), user, properties,</span>
<span class="fc" id="L368">                    user.getLocale(), null, getOrg(team), team);</span>

<span class="nc" id="L370">        } catch (MailException exception) {</span>
<span class="nc" id="L371">            LOGGER.error(&quot;Error while sendingActivationMessage &quot;, exception);</span>
<span class="nc" id="L372">            String eMessage = exception.getMessage();</span>
<span class="nc bnc" id="L373" title="All 2 branches missed.">            if (eMessage.contains(&quot;invalid email address&quot;)) {</span>
<span class="nc" id="L374">                throw new InvalidEmailAddressException(exception);</span>
            }
<span class="nc" id="L376">            throw new PKBException(&quot;Unable to send activation mail to: &quot; + user.getId(), exception);</span>
<span class="fc" id="L377">        }</span>
<span class="fc" id="L378">        LOGGER.debug(&quot;Exiting sendActivationMessage &quot;);</span>
<span class="fc" id="L379">    }</span>

    /**
     * sends invitation from clinician to clinician
     */
    public void sendInviteClinicianMessage(PKBPerson patient, PKBInvitation invitation, TeamWithOrg teamWithOrg) {
<span class="fc" id="L385">        LOGGER.debug(&quot;Enter sendInviteClinicianMessage&quot;);</span>
        try {
<span class="fc" id="L387">            PKBPerson clinician = invitation.getTargetUser();</span>
<span class="fc" id="L388">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L389">            String content = invitation.getInvitationDetail().getContent();</span>
<span class="pc bpc" id="L390" title="1 of 2 branches missed.">            properties.put(PKBConstants.MESSAGE, content == null ? &quot;&quot; : content);</span>
<span class="fc" id="L391">            properties.put(PKBConstants.CLINICIAN_FIRST_NAME, clinician.getFirstName());</span>
<span class="fc" id="L392">            properties.put(PKBConstants.CLINICIAN_LAST_NAME, clinician.getLastName());</span>
<span class="fc" id="L393">            properties.put(PKBConstants.CLINICIAN_TITLE, clinician.getTitle());</span>
<span class="fc" id="L394">            properties.put(PKBConstants.INVITATION_ID, invitation.getPublicId().toString());</span>
<span class="fc" id="L395">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L396">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L397">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L398">            properties.put(PKBConstants.USER_ID, clinician.getId());</span>
<span class="fc" id="L399">            properties.put(PKBConstants.INSTITUTE_NAME, teamWithOrg.getOrg().getName());</span>
<span class="fc" id="L400">            String actorId = patient.getId().toString();</span>
<span class="fc bfc" id="L401" title="All 2 branches covered.">            if (UserStatus.INVITED.compareTo(clinician.getStatus()) == 0) {</span>
<span class="fc" id="L402">                properties.put(PKBConstants.ENCODED_SECRET_KEY, invitation.getAccountKeyAccessToken());</span>
<span class="fc" id="L403">                emailManager.sendMessage(Message.INVITE_CLINICIAN, patient,</span>
<span class="fc" id="L404">                        formatter.getPrimaryAndSecondaryContacts(clinician, new NoConsentsRequired()),</span>
<span class="fc" id="L405">                        clinician, properties, patient.getLocale(), SENT_INVITATION, actorId, null, null);</span>
            } else {
<span class="fc" id="L407">                emailManager.sendMessage(Message.INVITE_REG_CLINICIAN, patient,</span>
<span class="fc" id="L408">                        formatter.getContact(clinician.getEmail()).getOrNull(),</span>
<span class="fc" id="L409">                        clinician, properties, patient.getLocale(), SENT_INVITATION, actorId, null, null);</span>

            }
<span class="nc" id="L412">        } catch (MailException exception) {</span>
<span class="nc" id="L413">            throw new PKBException(&quot;Unable to send tolven message&quot;, exception);</span>
<span class="fc" id="L414">        }</span>
<span class="fc" id="L415">        LOGGER.debug(&quot;Exiting sendInviteClinicianMessage&quot;);</span>
<span class="fc" id="L416">    }</span>

    // Refactored invites (Began May2015)

    /**
     * @param patient
     * @param author
     * @param authorTeam
     * @param clinician
     * @param teamWithOrg
     * @param invitation
     * @param encodedSecretKey
     */
    public void proInvitesClinicianForPatient(PKBPerson patient, PKBPerson author, Team authorTeam, PKBPerson clinician,
                                              TeamWithOrg teamWithOrg, PKBInvitation invitation, String encodedSecretKey) {
        try {
<span class="fc" id="L432">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L433">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L434">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L435">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L436">            properties.put(PKBConstants.AUTHOR_TITLE, author.getTitle());</span>
<span class="fc" id="L437">            properties.put(PKBConstants.AUTHOR_FIRST_NAME, author.getFirstName());</span>
<span class="fc" id="L438">            properties.put(PKBConstants.AUTHOR_LAST_NAME, author.getLastName());</span>
<span class="fc" id="L439">            properties.put(PKBConstants.AUTHOR_TEAM, authorTeam.getName());</span>
<span class="fc" id="L440">            properties.put(PKBConstants.AUTHOR_ORG, authorTeam.getOrg().getName());</span>
<span class="fc" id="L441">            addClinicianNameDetails(clinician, properties);</span>
<span class="fc" id="L442">            properties.put(PKBConstants.LOGIN_EMAIL, clinician.findEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L443">            properties.put(PKBConstants.INVITATION_ID, invitation.getPublicId().toString());</span>
<span class="fc" id="L444">            properties.put(PKBConstants.VERIFYING_TEAM, teamWithOrg.getName());</span>
<span class="fc" id="L445">            properties.put(PKBConstants.VERIFYING_ORG, teamWithOrg.getOrg().getName());</span>
<span class="fc" id="L446">            properties.put(PKBConstants.MESSAGE, invitation.getInvitationDetail().getContent());</span>
<span class="fc" id="L447">            properties.put(PKBConstants.ENCODED_SECRET_KEY, encodedSecretKey);</span>

<span class="fc" id="L449">            emailManager.sendMessage(Message.PRO_INVITES_CLINICIAN_FOR_PATIENT, author,</span>
<span class="fc" id="L450">                    formatter.getContact(clinician.getEmail()).getOrNull(), clinician, properties,</span>
<span class="fc" id="L451">                    clinician.getLocale(), SENT_INVITATION, author.getId().toString(), authorTeam.getOrg(), authorTeam);</span>

<span class="nc" id="L453">        } catch (MailException exception) {</span>
<span class="nc" id="L454">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="fc" id="L455">        }</span>
<span class="fc" id="L456">    }</span>

    public void proInvitesNonTeamClinicianForPatient(PKBPerson patient, PKBPerson author, Team authorTeam, PKBPerson clinician,
                                                     TeamWithOrg teamWithOrg, PKBInvitation invitation, String encodedSecretKey) {
        try {
<span class="fc" id="L461">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L462">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L463">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L464">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L465">            properties.put(PKBConstants.AUTHOR_TITLE, author.getTitle());</span>
<span class="fc" id="L466">            properties.put(PKBConstants.AUTHOR_FIRST_NAME, author.getFirstName());</span>
<span class="fc" id="L467">            properties.put(PKBConstants.AUTHOR_LAST_NAME, author.getLastName());</span>
<span class="fc" id="L468">            addTeamAndOrgNameIfPresent(authorTeam, properties);</span>
<span class="fc" id="L469">            addClinicianNameDetails(clinician, properties);</span>
<span class="fc" id="L470">            properties.put(PKBConstants.LOGIN_EMAIL, clinician.findEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L471">            properties.put(PKBConstants.INVITATION_ID, invitation.getPublicId().toString());</span>
<span class="fc" id="L472">            properties.put(PKBConstants.VERIFYING_TEAM, teamWithOrg.getName());</span>
<span class="fc" id="L473">            properties.put(PKBConstants.VERIFYING_ORG, teamWithOrg.getOrg().getName());</span>
<span class="fc" id="L474">            properties.put(PKBConstants.MESSAGE, invitation.getInvitationDetail().getContent());</span>
<span class="fc" id="L475">            properties.put(PKBConstants.ENCODED_SECRET_KEY, encodedSecretKey);</span>

<span class="fc" id="L477">            emailManager.sendMessage(Message.PRO_INVITES_NON_TEAM_CLINICIAN_FOR_PATIENT, author,</span>
<span class="fc" id="L478">                    formatter.getContact(clinician.getEmail()).getOrNull(), clinician, properties,</span>
<span class="fc" id="L479">                    clinician.getLocale(), SENT_INVITATION, author.getId().toString(), getOrg(authorTeam), authorTeam);</span>

<span class="nc" id="L481">        } catch (MailException exception) {</span>
<span class="nc" id="L482">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="fc" id="L483">        }</span>
<span class="fc" id="L484">    }</span>

    public void patientInvitesClinician(PKBPerson patient, PKBPerson clinician, @Nullable TeamWithOrg teamWithOrg,
                                        PKBInvitation invitation, String encodedSecretKey) {
        try {
<span class="fc" id="L489">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L490">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L491">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L492">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L493">            addClinicianNameDetails(clinician, properties);</span>
<span class="fc" id="L494">            properties.put(PKBConstants.LOGIN_EMAIL, clinician.findEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L495">            properties.put(PKBConstants.INVITATION_ID, invitation.getPublicId().toString());</span>
<span class="fc bfc" id="L496" title="All 2 branches covered.">            if (teamWithOrg != null) {</span>
<span class="fc" id="L497">                properties.put(PKBConstants.VERIFYING_TEAM, teamWithOrg.getName());</span>
<span class="fc" id="L498">                properties.put(PKBConstants.VERIFYING_ORG, teamWithOrg.getOrg().getName());</span>
            }
<span class="fc" id="L500">            properties.put(PKBConstants.MESSAGE, invitation.getInvitationDetail().getContent());</span>
<span class="fc" id="L501">            properties.put(PKBConstants.ENCODED_SECRET_KEY, encodedSecretKey);</span>

<span class="fc" id="L503">            emailManager.sendMessage(Message.PATIENT_INVITES_CLINICIAN, patient, formatter.getContact(clinician.getEmail()).getOrNull(), clinician,</span>
<span class="fc" id="L504">                    properties, clinician.getLocale(), SENT_INVITATION, patient.getId().toString(), null, null);</span>

<span class="nc" id="L506">        } catch (MailException exception) {</span>
<span class="nc" id="L507">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="fc" id="L508">        }</span>
<span class="fc" id="L509">    }</span>

    /**
     * @param patient
     * @param author
     * @param clinician
     * @param teamWithOrg
     * @param invitation
     * @param encodedSecretKey
     */
    public void carerInvitesClinicianForPatient(PKBPerson patient, PKBPerson author, PKBPerson clinician,
                                                TeamWithOrg teamWithOrg, PKBInvitation invitation, String encodedSecretKey) {
        try {
<span class="fc" id="L522">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L523">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L524">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L525">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L526">            properties.put(PKBConstants.AUTHOR_TITLE, author.getTitle());</span>
<span class="fc" id="L527">            properties.put(PKBConstants.AUTHOR_FIRST_NAME, author.getFirstName());</span>
<span class="fc" id="L528">            properties.put(PKBConstants.AUTHOR_LAST_NAME, author.getLastName());</span>
<span class="fc" id="L529">            addClinicianNameDetails(clinician, properties);</span>
<span class="fc" id="L530">            properties.put(PKBConstants.LOGIN_EMAIL, clinician.findEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L531">            properties.put(PKBConstants.INVITATION_ID, invitation.getPublicId().toString());</span>
<span class="fc" id="L532">            properties.put(PKBConstants.VERIFYING_TEAM, teamWithOrg.getName());</span>
<span class="fc" id="L533">            properties.put(PKBConstants.VERIFYING_ORG, teamWithOrg.getOrg().getName());</span>
<span class="fc" id="L534">            properties.put(PKBConstants.MESSAGE, invitation.getInvitationDetail().getContent());</span>
<span class="fc" id="L535">            properties.put(PKBConstants.ENCODED_SECRET_KEY, encodedSecretKey);</span>

<span class="fc" id="L537">            emailManager.sendMessage(Message.CARER_INVITES_CLINICIAN_FOR_PATIENT, author,</span>
<span class="fc" id="L538">                    formatter.getContact(clinician.getEmail()).getOrNull(), clinician, properties, clinician.getLocale(),</span>
<span class="fc" id="L539">                    SENT_INVITATION, author.getId().toString(), null, null);</span>

<span class="nc" id="L541">        } catch (MailException exception) {</span>
<span class="nc" id="L542">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="fc" id="L543">        }</span>
<span class="fc" id="L544">    }</span>

    /**
     * @param patient
     * @param carer
     * @param message
     */
    public void patientInvitesNonTeamCarerForSelf(PKBPerson patient, PKBPerson carer, String message) {
        try {
<span class="fc" id="L553">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L554">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L555">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L556">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L557">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="fc" id="L558">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="fc" id="L559">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="fc" id="L560">            properties.put(PKBConstants.USER_ID, carer.getId());</span>
<span class="fc" id="L561">            properties.put(PKBConstants.TEMP_PASSWORD, carer.getPassword());</span>
<span class="fc" id="L562">            properties.put(PKBConstants.MESSAGE, message);</span>
<span class="fc" id="L563">            properties.put(PKBConstants.INHIBIT_CARER_FOOTER, true);</span>

<span class="fc" id="L565">            emailManager.sendMessage(Message.PATIENT_INVITES_NON_TEAM_CARER_FOR_SELF, patient, formatter.getContact(carer.getEmail()).getOrNull(),</span>
<span class="fc" id="L566">                    carer, properties, patient.getLocale(), SENT_INVITATION, patient.getId().toString(), null, null);</span>

<span class="nc" id="L568">        } catch (MailException exception) {</span>
<span class="nc" id="L569">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="fc" id="L570">        }</span>
<span class="fc" id="L571">    }</span>

    /**
     * @param patient
     * @param author
     * @param carer
     */
    public void otherUserInvitesCarerNotifyPatient(PKBPerson patient, PKBPerson author, PKBPerson carer) {
        try {
<span class="fc" id="L580">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L581">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L582">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L583">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L584">            properties.put(PKBConstants.AUTHOR_TITLE, author.getTitle());</span>
<span class="fc" id="L585">            properties.put(PKBConstants.AUTHOR_FIRST_NAME, author.getFirstName());</span>
<span class="fc" id="L586">            properties.put(PKBConstants.AUTHOR_LAST_NAME, author.getLastName());</span>
<span class="fc" id="L587">            properties.put(PKBConstants.AUTHOR_ORG, author.getOrganizationName());</span>
<span class="fc" id="L588">            properties.put(PKBConstants.INVITED_CARER_TITLE, carer.getTitle());</span>
<span class="fc" id="L589">            properties.put(PKBConstants.INVITED_CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="fc" id="L590">            properties.put(PKBConstants.INVITED_CARER_LAST_NAME, carer.getLastName());</span>
<span class="fc" id="L591">            properties.put(PKBConstants.CONTEXT_USER_ID, patient.getId());</span>
<span class="fc" id="L592">            properties.put(PKBConstants.LOGIN_EMAIL, patient.findEmail().map(Email::address).getOrNull());</span>

<span class="fc" id="L594">            emailManager.sendMessage(Message.OTHER_USER_INVITES_CARER_NOTIFY_PATIENT, author,</span>
<span class="fc" id="L595">                    formatter.getPrimaryAndSecondaryContacts(patient, false, Optional.of(carer), new NoConsentsRequired()),</span>
<span class="fc" id="L596">                    patient, properties, patient.getLocale(), SENT_INVITATION, author.getId().toString(), null, null);</span>

<span class="nc" id="L598">        } catch (MailException exception) {</span>
<span class="nc" id="L599">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="fc" id="L600">        }</span>
<span class="fc" id="L601">    }</span>

    /**
     * @param patient
     * @param author
     * @param carer
     * @param message
     */
    public void carerInvitesNonTeamCarerForPatient(PKBPerson patient, PKBPerson author, PKBPerson carer, String message) {
        try {
<span class="nc" id="L611">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="nc" id="L612">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="nc" id="L613">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="nc" id="L614">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="nc" id="L615">            properties.put(PKBConstants.AUTHOR_TITLE, author.getTitle());</span>
<span class="nc" id="L616">            properties.put(PKBConstants.AUTHOR_FIRST_NAME, author.getFirstName());</span>
<span class="nc" id="L617">            properties.put(PKBConstants.AUTHOR_LAST_NAME, author.getLastName());</span>
<span class="nc" id="L618">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="nc" id="L619">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="nc" id="L620">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="nc" id="L621">            properties.put(PKBConstants.USER_ID, carer.getId());</span>
<span class="nc" id="L622">            properties.put(PKBConstants.TEMP_PASSWORD, carer.getPassword());</span>
<span class="nc" id="L623">            properties.put(PKBConstants.MESSAGE, message);</span>
<span class="nc" id="L624">            properties.put(PKBConstants.INHIBIT_CARER_FOOTER, true);</span>

<span class="nc" id="L626">            emailManager.sendMessage(Message.CARER_INVITES_NON_TEAM_CARER_FOR_PATIENT, author,</span>
<span class="nc" id="L627">                    formatter.getContact(carer.getEmail()).getOrNull(), carer, properties,</span>
<span class="nc" id="L628">                    patient.getLocale(), SENT_INVITATION, author.getId().toString(), null, null);</span>

<span class="nc" id="L630">        } catch (MailException exception) {</span>
<span class="nc" id="L631">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="nc" id="L632">        }</span>
<span class="nc" id="L633">    }</span>

    /**
     * @param patient
     * @param author
     * @param carer
     * @param message
     */
    public void proInvitesNonTeamCarerForPatient(PKBPerson patient, PKBPerson author, PKBPerson carer,
                                                 String message, Team team) {
        try {
<span class="fc" id="L644">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L645">            properties.put(PKBConstants.AUTHOR_TITLE, author.getTitle());</span>
<span class="fc" id="L646">            properties.put(PKBConstants.AUTHOR_FIRST_NAME, author.getFirstName());</span>
<span class="fc" id="L647">            properties.put(PKBConstants.AUTHOR_LAST_NAME, author.getLastName());</span>
<span class="fc" id="L648">            properties.put(PKBConstants.ORGANIZATION_NAME, author.getOrganizationName());</span>
<span class="fc" id="L649">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L650">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L651">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L652">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="fc" id="L653">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="fc" id="L654">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="fc" id="L655">            properties.put(PKBConstants.USER_ID, carer.getId());</span>
<span class="fc" id="L656">            properties.put(PKBConstants.TEMP_PASSWORD, carer.getPassword());</span>
<span class="fc" id="L657">            properties.put(PKBConstants.MESSAGE, message);</span>
<span class="fc" id="L658">            properties.put(PKBConstants.INHIBIT_CARER_FOOTER, true);</span>

<span class="fc" id="L660">            emailManager.sendMessage(Message.PRO_INVITES_NON_TEAM_CARER_FOR_PATIENT, author,</span>
<span class="fc" id="L661">                    formatter.getContact(carer.getEmail()).getOrNull(), carer, properties, patient.getLocale(),</span>
<span class="fc" id="L662">                    SENT_INVITATION, author.getId().toString(), getOrg(team), team);</span>

<span class="nc" id="L664">        } catch (MailException exception) {</span>
<span class="nc" id="L665">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="fc" id="L666">        }</span>
<span class="fc" id="L667">    }</span>

    public void patientInvitesTeamCarerForSelf(PKBPerson patient, PKBPerson carer, PKBInvitation invitation) {
        try {
<span class="fc" id="L671">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L672">            String content = invitation.getInvitationDetail().getContent();</span>
<span class="pc bpc" id="L673" title="1 of 2 branches missed.">            properties.put(PKBConstants.MESSAGE, content == null ? &quot;&quot; : content);</span>
<span class="fc" id="L674">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L675">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L676">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L677">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="fc" id="L678">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="fc" id="L679">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="fc" id="L680">            properties.put(PKBConstants.CARER_EMAIL, carer.findEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L681">            properties.put(PKBConstants.INVITATION_ID, invitation.getPublicId().toString());</span>

<span class="fc" id="L683">            emailManager.sendMessage(Message.PATIENT_INVITES_TEAM_CARER_FOR_SELF, patient,</span>
<span class="fc" id="L684">                    formatter.getContact(carer.getEmail()).getOrNull(), carer,</span>
<span class="fc" id="L685">                    properties, patient.getLocale(), SENT_INVITATION, patient.getId().toString(), null, null);</span>

<span class="nc" id="L687">        } catch (MailException exception) {</span>
<span class="nc" id="L688">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="fc" id="L689">        }</span>
<span class="fc" id="L690">    }</span>

    public void carerInvitesTeamCarerForPatient(PKBPerson patient, PKBPerson author, PKBPerson carer, PKBInvitation invitation) {
        try {
<span class="nc" id="L694">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="nc" id="L695">            String content = invitation.getInvitationDetail().getContent();</span>
<span class="nc bnc" id="L696" title="All 2 branches missed.">            properties.put(PKBConstants.MESSAGE, content == null ? &quot;&quot; : content);</span>
<span class="nc" id="L697">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="nc" id="L698">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="nc" id="L699">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="nc" id="L700">            properties.put(PKBConstants.AUTHOR_TITLE, author.getTitle());</span>
<span class="nc" id="L701">            properties.put(PKBConstants.AUTHOR_FIRST_NAME, author.getFirstName());</span>
<span class="nc" id="L702">            properties.put(PKBConstants.AUTHOR_LAST_NAME, author.getLastName());</span>
<span class="nc" id="L703">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="nc" id="L704">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="nc" id="L705">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="nc" id="L706">            properties.put(PKBConstants.CARER_EMAIL, carer.findEmail().map(Email::address).getOrNull());</span>
<span class="nc" id="L707">            properties.put(PKBConstants.INVITATION_ID, invitation.getPublicId().toString());</span>

<span class="nc" id="L709">            emailManager.sendMessage(Message.CARER_INVITES_TEAM_CARER_FOR_PATIENT, author,</span>
<span class="nc" id="L710">                    formatter.getContact(carer.getEmail()).getOrNull(), carer,</span>
<span class="nc" id="L711">                    properties, patient.getLocale(), SENT_INVITATION, author.getId().toString(), null, null);</span>

<span class="nc" id="L713">        } catch (MailException exception) {</span>
<span class="nc" id="L714">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="nc" id="L715">        }</span>
<span class="nc" id="L716">    }</span>

    public void proInvitesTeamCarerForPatient(PKBPerson patient, PKBPerson author, PKBPerson carer,
                                              PKBInvitation invitation, Team team) {
        try {
<span class="fc" id="L721">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L722">            String content = invitation.getInvitationDetail().getContent();</span>
<span class="pc bpc" id="L723" title="1 of 2 branches missed.">            properties.put(PKBConstants.MESSAGE, content == null ? &quot;&quot; : content);</span>
<span class="fc" id="L724">            properties.put(PKBConstants.AUTHOR_TITLE, author.getTitle());</span>
<span class="fc" id="L725">            properties.put(PKBConstants.AUTHOR_FIRST_NAME, author.getFirstName());</span>
<span class="fc" id="L726">            properties.put(PKBConstants.AUTHOR_LAST_NAME, author.getLastName());</span>
<span class="fc" id="L727">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L728">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L729">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L730">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="fc" id="L731">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="fc" id="L732">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="fc" id="L733">            properties.put(PKBConstants.CARER_EMAIL, carer.findEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L734">            properties.put(PKBConstants.INVITATION_ID, invitation.getPublicId().toString());</span>

<span class="fc" id="L736">            emailManager.sendMessage(Message.PRO_INVITES_TEAM_CARER_FOR_PATIENT, author,</span>
<span class="fc" id="L737">                    formatter.getContact(carer.getEmail()).getOrNull(), carer,</span>
<span class="fc" id="L738">                    properties, patient.getLocale(), SENT_INVITATION, author.getId().toString(), getOrg(team), team);</span>

<span class="nc" id="L740">        } catch (MailException exception) {</span>
<span class="nc" id="L741">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="fc" id="L742">        }</span>
<span class="fc" id="L743">    }</span>

    public void patientInvitesRegisteringCarerForSelf(PKBPerson patient, PKBPerson carer, String message) {
        try {
<span class="nc" id="L747">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">            properties.put(PKBConstants.MESSAGE, message == null ? &quot;&quot; : message);</span>
<span class="nc" id="L749">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="nc" id="L750">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="nc" id="L751">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="nc" id="L752">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="nc" id="L753">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="nc" id="L754">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="nc" id="L755">            properties.put(PKBConstants.CARER_EMAIL, carer.findEmail().map(Email::address).getOrNull());</span>
<span class="nc" id="L756">            properties.put(PKBConstants.USER_ID, carer.getId());</span>
<span class="nc" id="L757">            properties.put(PKBConstants.TEMP_PASSWORD, carer.getPassword());</span>
<span class="nc" id="L758">            properties.put(PKBConstants.INHIBIT_CARER_FOOTER, true);</span>

<span class="nc" id="L760">            emailManager.sendMessage(Message.PATIENT_INVITES_REGISTERING_CARER_FOR_SELF,</span>
<span class="nc" id="L761">                    patient, formatter.getContact(carer.getEmail()).getOrNull(), carer, properties,</span>
<span class="nc" id="L762">                    patient.getLocale(), SENT_INVITATION, patient.getId().toString(), null, null);</span>

<span class="nc" id="L764">        } catch (MailException exception) {</span>
<span class="nc" id="L765">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="nc" id="L766">        }</span>
<span class="nc" id="L767">    }</span>

    /**
     * @param patient
     * @param author
     * @param carer
     * @param message
     * @param carerRegisteringTeam
     */
    public void carerInvitesRegisteringCarerForPatient(PKBPerson patient, PKBPerson author, PKBPerson carer, String message,
                                                       Team carerRegisteringTeam) throws PKBException {
        try {
<span class="nc" id="L779">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="nc bnc" id="L780" title="All 2 branches missed.">            properties.put(PKBConstants.MESSAGE, message == null ? &quot;&quot; : message);</span>
<span class="nc" id="L781">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="nc" id="L782">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="nc" id="L783">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="nc" id="L784">            properties.put(PKBConstants.AUTHOR_TITLE, author.getTitle());</span>
<span class="nc" id="L785">            properties.put(PKBConstants.AUTHOR_FIRST_NAME, author.getFirstName());</span>
<span class="nc" id="L786">            properties.put(PKBConstants.AUTHOR_LAST_NAME, author.getLastName());</span>
<span class="nc" id="L787">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="nc" id="L788">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="nc" id="L789">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="nc" id="L790">            properties.put(PKBConstants.CARER_EMAIL, carer.findEmail().map(Email::address).getOrNull());</span>
<span class="nc" id="L791">            properties.put(PKBConstants.USER_ID, carer.getId());</span>
<span class="nc" id="L792">            properties.put(PKBConstants.TEMP_PASSWORD, carer.getPassword());</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">            if (carerRegisteringTeam != null) {</span>
<span class="nc" id="L794">                properties.put(PKBConstants.ORGANIZATION_NAME, carerRegisteringTeam.getOrg().getName());</span>
            }
<span class="nc" id="L796">            properties.put(PKBConstants.INHIBIT_CARER_FOOTER, true);</span>

<span class="nc" id="L798">            emailManager.sendMessage(Message.CARER_INVITES_REGISTERING_CARER_FOR_PATIENT, author,</span>
<span class="nc" id="L799">                    formatter.getContact(carer.getEmail()).getOrNull(), carer, properties,</span>
<span class="nc" id="L800">                    patient.getLocale(), SENT_INVITATION, author.getId().toString(), null, null);</span>

<span class="nc" id="L802">        } catch (MailException exception) {</span>
<span class="nc" id="L803">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="nc" id="L804">        }</span>
<span class="nc" id="L805">    }</span>

    /**
     * @param patient
     * @param author
     * @param carer
     * @param message
     * @param carerRegisteringTeam
     */
    public void proInvitesRegisteringCarerForPatient(PKBPerson patient, PKBPerson author, PKBPerson carer, String message,
                                                     Team carerRegisteringTeam) {
        try {
<span class="fc" id="L817">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="pc bpc" id="L818" title="1 of 2 branches missed.">            properties.put(PKBConstants.MESSAGE, message == null ? &quot;&quot; : message);</span>
<span class="fc" id="L819">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L820">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L821">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L822">            properties.put(PKBConstants.AUTHOR_TITLE, author.getTitle());</span>
<span class="fc" id="L823">            properties.put(PKBConstants.AUTHOR_FIRST_NAME, author.getFirstName());</span>
<span class="fc" id="L824">            properties.put(PKBConstants.AUTHOR_LAST_NAME, author.getLastName());</span>
<span class="fc" id="L825">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="fc" id="L826">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="fc" id="L827">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="fc" id="L828">            properties.put(PKBConstants.CARER_EMAIL, carer.findEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L829">            properties.put(PKBConstants.USER_ID, carer.getId());</span>
<span class="fc" id="L830">            properties.put(PKBConstants.TEMP_PASSWORD, carer.getPassword());</span>
<span class="fc" id="L831">            Org org = null;</span>
<span class="pc bpc" id="L832" title="1 of 2 branches missed.">            if (carerRegisteringTeam != null) {</span>
<span class="fc" id="L833">                org = carerRegisteringTeam.getOrg();</span>
<span class="fc" id="L834">                properties.put(PKBConstants.TEAM_NAME, carerRegisteringTeam.getName());</span>
<span class="fc" id="L835">                properties.put(PKBConstants.ORGANIZATION_NAME, org.getName());</span>
            }

<span class="fc" id="L838">            emailManager.sendMessage(Message.PRO_INVITES_REGISTERING_CARER_FOR_PATIENT, author,</span>
<span class="fc" id="L839">                    formatter.getContact(carer.getEmail()).getOrNull(), carer, properties,</span>
<span class="fc" id="L840">                    patient.getLocale(), SENT_INVITATION, author.getId().toString(), org, carerRegisteringTeam);</span>

<span class="nc" id="L842">        } catch (MailException exception) {</span>
<span class="nc" id="L843">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="fc" id="L844">        }</span>
<span class="fc" id="L845">    }</span>

    /**
     * @param patient
     * @param carer
     */
    public void carerAcceptsInvitationFromPatient(PKBPerson patient, PKBPerson carer) {
        try {
<span class="fc" id="L853">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L854">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L855">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L856">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L857">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="fc" id="L858">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="fc" id="L859">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="fc" id="L860">            properties.put(PKBConstants.CARER_EMAIL, carer.findEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L861">            properties.put(PKBConstants.CONTEXT_USER_ID, patient.getId());</span>

<span class="fc" id="L863">            emailManager.sendMessage(Message.CARER_ACCEPTS_INVITATION_FROM_PATIENT, carer,</span>
<span class="fc" id="L864">                    formatter.getContact(patient.getEmail()).getOrNull(), patient, properties,</span>
<span class="fc" id="L865">                    patient.getLocale(), ACCEPTED_INVITATION, carer.getId().toString(), null, null);</span>

<span class="nc" id="L867">        } catch (MailException exception) {</span>
<span class="nc" id="L868">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="fc" id="L869">        }</span>
<span class="fc" id="L870">    }</span>

    /**
     * @param patient
     * @param author
     * @param carer
     */
    public void carerAcceptsInvitationFromOtherUserNotifyPatient(PKBPerson patient, PKBPerson author, PKBPerson carer) {
        try {
<span class="fc" id="L879">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L880">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L881">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L882">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L883">            properties.put(PKBConstants.INVITED_CARER_TITLE, carer.getTitle());</span>
<span class="fc" id="L884">            properties.put(PKBConstants.INVITED_CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="fc" id="L885">            properties.put(PKBConstants.INVITED_CARER_LAST_NAME, carer.getLastName());</span>
<span class="fc" id="L886">            properties.put(PKBConstants.CONTEXT_USER_ID, patient.getId());</span>
<span class="fc" id="L887">            properties.put(PKBConstants.LOGIN_EMAIL, patient.findEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L888">            properties.put(PKBConstants.AUTHOR_TITLE, author.getTitle());</span>
<span class="fc" id="L889">            properties.put(PKBConstants.AUTHOR_FIRST_NAME, author.getFirstName());</span>
<span class="fc" id="L890">            properties.put(PKBConstants.AUTHOR_LAST_NAME, author.getLastName());</span>
<span class="fc" id="L891">            properties.put(PKBConstants.AUTHOR_ORG, author.getOrganizationName());</span>

<span class="fc" id="L893">            emailManager.sendMessage(Message.CARER_ACCEPTS_INVITATION_FROM_OTHER_USER_NOTIFY_PATIENT, carer,</span>
<span class="fc" id="L894">                    formatter.getPrimaryAndSecondaryContacts(patient, false, Optional.of(carer), new NoConsentsRequired()),</span>
<span class="fc" id="L895">                    patient, properties, patient.getLocale(), ACCEPTED_INVITATION, carer.getId().toString(), null, null);</span>

<span class="nc" id="L897">        } catch (MailException exception) {</span>
<span class="nc" id="L898">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="fc" id="L899">        }</span>
<span class="fc" id="L900">    }</span>

    /**
     * @param patient
     * @param author
     * @param carer
     */
    public void carerAcceptsInvitationFromPro(PKBPerson patient, PKBPerson professional, PKBPerson carer) {
        try {
<span class="fc" id="L909">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L910">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L911">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L912">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L913">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="fc" id="L914">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="fc" id="L915">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="fc" id="L916">            properties.put(PKBConstants.CARER_EMAIL, carer.findEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L917">            properties.put(PKBConstants.CONTEXT_USER_ID, patient.getId());</span>
<span class="fc" id="L918">            properties.put(PKBConstants.LOGIN_EMAIL, patient.findEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L919">            properties.put(PKBConstants.CLINICIAN_TITLE, professional.getTitle());</span>
<span class="fc" id="L920">            properties.put(PKBConstants.CLINICIAN_FIRST_NAME, professional.getFirstName());</span>
<span class="fc" id="L921">            properties.put(PKBConstants.CLINICIAN_LAST_NAME, professional.getLastName());</span>

<span class="fc" id="L923">            emailManager.sendMessage(Message.CARER_ACCEPTS_INVITATION_FROM_PRO, carer,</span>
<span class="fc" id="L924">                    formatter.getContact(professional.getEmail()).getOrNull(), professional,</span>
<span class="fc" id="L925">                    properties, patient.getLocale(), null, carer.getId().toString(), null, null);</span>

<span class="nc" id="L927">        } catch (MailException exception) {</span>
<span class="nc" id="L928">            throw new PKBException(&quot;Unable to send email message&quot;, exception);</span>
<span class="fc" id="L929">        }</span>
<span class="fc" id="L930">    } // End May 2015 refactoring</span>

    private Map&lt;String, Object&gt; getPropertiesForNotifyingReceiverAboutPatient(PKBPerson sender, PKBPerson receiver,
                                                                              PKBPerson patient, UUID conversationId) {
<span class="fc" id="L934">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L935">        properties.put(PKBConstants.SENDER_TITLE, sender.getTitle());</span>
<span class="fc" id="L936">        properties.put(PKBConstants.SENDER_FIRST_NAME, sender.getFirstName());</span>
<span class="fc" id="L937">        properties.put(PKBConstants.SENDER_LAST_NAME, sender.getLastName());</span>
<span class="fc" id="L938">        properties.put(PKBConstants.ORGANIZATION_NAME, sender.getOrganizationName());</span>
<span class="fc" id="L939">        properties.put(PKBConstants.RECEIVER_TITLE, receiver.getTitle());</span>
<span class="fc" id="L940">        properties.put(PKBConstants.RECEIVER_FIRST_NAME, receiver.getFirstName());</span>
<span class="fc" id="L941">        properties.put(PKBConstants.RECEIVER_LAST_NAME, receiver.getLastName());</span>
<span class="fc" id="L942">        properties.put(PKBConstants.ON_BEHALF_AUTHOR_NAME, &quot;&quot;);</span>
<span class="fc" id="L943">        properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L944">        properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L945">        properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L946">        properties.put(PKBConstants.CONVERSATION_ID, conversationId);</span>
<span class="fc" id="L947">        properties.put(PKBConstants.CONTEXT_USER_ID, receiver.getId());</span>
<span class="pc bpc" id="L948" title="1 of 2 branches missed.">        if (receiver.isPro()) {</span>
<span class="fc" id="L949">            properties.put(PKBConstants.TITLE, receiver.getTitle());</span>
        } else {
<span class="nc" id="L951">            properties.put(PKBConstants.TITLE, &quot;&quot;);</span>
        }

<span class="fc" id="L954">        return properties;</span>
    }

    /**
     * Sends notification to receiver, informing that a message is waiting to be read.
     *
     * @param sender sender user
     * @param person
     */

    private void notifyUserOnly(Message message, PKBPerson sender, PKBPerson person, UUID conversationId) {
<span class="fc bfc" id="L965" title="All 2 branches covered.">        if (person.getStatus() == UserStatus.NOCONTACT) {</span>
<span class="fc" id="L966">            LOGGER.warn(&quot;receiver-{} is a NOCONTACT person; Notification cannot be sent&quot;, person.getId());</span>
<span class="fc" id="L967">            return;</span>
        }

        // do not support on behalf person anymore
        // pass parameter onBehalfAuthor = null;
<span class="fc" id="L972">        Map&lt;String, Object&gt; properties = getPropertiesForNotifyingReceiver(sender, person, conversationId);</span>

<span class="fc" id="L974">        getPrimaryContactOnly(person).ifPresent(addressInfo -&gt; sendEmail(message, sender,</span>
<span class="fc" id="L975">                addressInfo, person, properties, person.getLocale()));</span>
<span class="fc" id="L976">    }</span>

    private void sendEmail(Message message, PKBPerson sender, AddressInfo addressInfo, PKBPerson receiver, Map&lt;String, Object&gt; properties, Locale locale) {
        try {
<span class="fc" id="L980">            emailManager.sendMessage(message, sender, addressInfo, receiver, properties, locale,</span>
<span class="fc bfc" id="L981" title="All 2 branches covered.">                    SENT_MESSAGE, sender != null ? sender.getId().toString() : null, null, null);</span>
<span class="nc" id="L982">        } catch (MailException exception) {</span>
<span class="nc" id="L983">            throw new IllegalArgumentException(</span>
<span class="nc" id="L984">                    &quot;Unable to send notification to receiver-&quot; + receiver.findEmail().map(Email::address).getOrNull(), exception);</span>
<span class="fc" id="L985">        }</span>
<span class="fc" id="L986">    }</span>

    /**
     * Sends notification to receiver, informing that a message is waiting to be read.
     *
     * @param sender   sender user
     * @param receiver
     */

    public void notifyReceiverOnly(PKBPerson sender, PKBPerson receiver, UUID conversationId) {
<span class="fc" id="L996">        LOGGER.debug(&quot;Enter sendNotificationToReceiver&quot;);</span>
<span class="fc" id="L997">        notifyUserOnly(Message.NOTIFICATION_TO_RECEIVER, sender, receiver, conversationId);</span>
<span class="fc" id="L998">        LOGGER.debug(&quot;Exiting sendNotificationToReceiver&quot;);</span>
<span class="fc" id="L999">    }</span>

    /**
     * Sends notification to receiver, informing that a message is waiting to be read.
     *
     * @param sender sender user
     * @param carer
     */
    public void notifyCarerOnly(PKBPerson sender, PKBPerson carer, UUID conversationId) {
<span class="fc" id="L1008">        LOGGER.debug(&quot;Enter sendNotificationToCarer&quot;);</span>
<span class="fc" id="L1009">        notifyUserOnly(Message.NOTIFICATION_TO_CARER, sender, carer, conversationId);</span>
<span class="fc" id="L1010">        LOGGER.debug(&quot;Exiting sendNotificationToCarer&quot;);</span>
<span class="fc" id="L1011">    }</span>

    private Map&lt;String, Object&gt; getPropertiesForNotifyingReceiver(PKBPerson sender, PKBPerson receiver,
                                                                  UUID conversationId) {
<span class="fc" id="L1015">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1016">        properties.put(PKBConstants.SENDER_TITLE, sender.getTitle());</span>
<span class="fc" id="L1017">        properties.put(PKBConstants.SENDER_FIRST_NAME, sender.getFirstName());</span>
<span class="fc" id="L1018">        properties.put(PKBConstants.SENDER_LAST_NAME, sender.getLastName());</span>
<span class="fc" id="L1019">        properties.put(PKBConstants.ORGANIZATION_NAME, sender.getOrganizationName());</span>
<span class="fc" id="L1020">        properties.put(PKBConstants.RECEIVER_TITLE, receiver.getTitle());</span>
<span class="fc" id="L1021">        properties.put(PKBConstants.RECEIVER_FIRST_NAME, receiver.getFirstName());</span>
<span class="fc" id="L1022">        properties.put(PKBConstants.RECEIVER_LAST_NAME, receiver.getLastName());</span>
<span class="fc" id="L1023">        properties.put(PKBConstants.ON_BEHALF_AUTHOR_NAME, &quot;&quot;);</span>
<span class="fc" id="L1024">        properties.put(PKBConstants.PATIENT_TITLE, &quot;&quot;);</span>
<span class="fc" id="L1025">        properties.put(PKBConstants.PATIENT_FIRST_NAME, &quot;&quot;);</span>
<span class="fc" id="L1026">        properties.put(PKBConstants.PATIENT_LAST_NAME, &quot;&quot;);</span>

<span class="fc" id="L1028">        properties.put(PKBConstants.CONVERSATION_ID, conversationId);</span>
<span class="fc" id="L1029">        properties.put(PKBConstants.CONTEXT_USER_ID, receiver.getId());</span>
<span class="fc bfc" id="L1030" title="All 2 branches covered.">        if (receiver.isPro()) {</span>
<span class="fc" id="L1031">            properties.put(PKBConstants.TITLE, receiver.getTitle());</span>
        } else {
<span class="fc" id="L1033">            properties.put(PKBConstants.TITLE, &quot;&quot;);</span>
        }

<span class="fc" id="L1036">        return properties;</span>
    }

    /**
     * Send notification to receiver, informing that a message is waiting to be read,
     * INCLUDING the name of the patient whom the message is about
     */
    public void notifyReceiverOnlyAboutPatient(PKBPerson sender, PKBPerson receiver, PKBPerson patient, UUID conversationId) {
<span class="fc" id="L1044">        LOGGER.debug(&quot;Enter sendNotificationToReceiverAboutPatient&quot;);</span>
<span class="fc" id="L1045">        Map&lt;String, Object&gt; properties = getPropertiesForNotifyingReceiverAboutPatient(sender,</span>
                receiver, patient, conversationId);

<span class="fc" id="L1048">        getPrimaryContactOnly(receiver).ifPresent(addressInfo -&gt; sendEmail(Message.NOTIFICATION_TO_RECEIVER, sender,</span>
<span class="fc" id="L1049">                addressInfo, receiver, properties, receiver.getLocale()));</span>

<span class="fc" id="L1051">        LOGGER.debug(&quot;Exiting sendNotificationToReceiverAboutPatient&quot;);</span>
<span class="fc" id="L1052">    }</span>

    private Optional&lt;AddressInfo&gt; getPrimaryContactOnly(PKBPerson receiver) {
<span class="fc" id="L1055">        Optional&lt;AddressInfo&gt; result = formatter.getPrimaryContactOnly(receiver);</span>
<span class="pc bpc" id="L1056" title="1 of 2 branches missed.">        if (!result.isPresent()) {</span>
<span class="nc" id="L1057">            LOGGER.warn(&quot;Primary contact not found for person {}&quot;, receiver.getId());</span>
        }
<span class="fc" id="L1059">        return result;</span>
    }

    /**
     * Send notification to carer that a message has been sent by their patient
     */
    public void sendNotificationToCarerOfSentMessage(PKBPerson sender, PKBPerson patient, PKBPerson carer, UUID conversationId) {
<span class="fc" id="L1066">        LOGGER.debug(&quot;Enter sendNotificationToCarerOfSentMessage&quot;);</span>

        try {
<span class="fc" id="L1069">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1070">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L1071">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L1072">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L1073">            properties.put(PKBConstants.SENDER_TITLE, sender.getTitle());</span>
<span class="fc" id="L1074">            properties.put(PKBConstants.SENDER_FIRST_NAME, sender.getFirstName());</span>
<span class="fc" id="L1075">            properties.put(PKBConstants.SENDER_LAST_NAME, sender.getLastName());</span>
<span class="fc" id="L1076">            properties.put(PKBConstants.ORGANIZATION_NAME, defaultString(sender.getOrganizationName()));</span>
<span class="fc" id="L1077">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="fc" id="L1078">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="fc" id="L1079">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="fc" id="L1080">            properties.put(PKBConstants.CONVERSATION_ID, conversationId);</span>
<span class="fc" id="L1081">            properties.put(PKBConstants.CONTEXT_USER_ID, patient.getId());</span>

<span class="fc bfc" id="L1083" title="All 2 branches covered.">            if (sender.isPro()) {</span>
<span class="fc" id="L1084">                properties.put(PKBConstants.TITLE, sender.getTitle());</span>
            } else {
<span class="fc" id="L1086">                properties.put(PKBConstants.TITLE, &quot;&quot;);</span>
            }
<span class="fc bfc" id="L1088" title="All 2 branches covered.">            if (patient.getId().equals(sender.getId())) {</span>
<span class="fc" id="L1089">                properties.put(PKBConstants.MSG_BY_PATIENT, &quot;1&quot;);</span>
            } else {
<span class="fc" id="L1091">                properties.put(PKBConstants.MSG_BY_PATIENT, &quot;0&quot;);</span>
            }

            // This method is already being called from a separate thread
            //taskExecutor.execute(new NotificationTask(emailManager, Message.NOTIFICATION_TO_CARER_OF_SENT_MESSAGE, sender,
            //        formatter.getSenderContact(carer), properties, new Locale(carer.getLanguageCode())));

<span class="fc" id="L1098">            var locale = new Locale(carer.getLanguageCode());</span>
<span class="fc" id="L1099">            var toAddress = getAddressInfo(carer).getOrNull();</span>
<span class="fc" id="L1100">            emailManager.sendMessage(Message.NOTIFICATION_TO_CARER_OF_SENT_MESSAGE, sender, toAddress, carer,</span>
<span class="fc" id="L1101">                    properties, locale, SENT_MESSAGE, sender.getId().toString(), null, null);</span>

<span class="nc" id="L1103">        } catch (MailException exception) {</span>
<span class="nc" id="L1104">            throw new PKBException(</span>
<span class="nc" id="L1105">                    &quot;Unable to send notification to carer-&quot; + carer.findEmail().map(Email::address).getOrNull(), exception);</span>
<span class="fc" id="L1106">        }</span>
<span class="fc" id="L1107">        LOGGER.debug(&quot;Exiting sendNotificationToCarerOfSentMessage&quot;);</span>
<span class="fc" id="L1108">    }</span>

    /**
     * @param person
     * @return
     * @throws FormattingException
     */
    private Option&lt;AddressInfo&gt; getAddressInfo(@Nullable PKBPerson nullablePerson) throws FormattingException {
<span class="fc" id="L1116">        return Option.of(nullablePerson)</span>
<span class="fc" id="L1117">                .flatMap(unchecked(person -&gt;</span>
<span class="fc" id="L1118">                        formatter.getContact(person.getFirstName(), person.getLastName(), person.getEmail())));</span>
    }

    /**
     * Sends patient a message reminding them to document the call that has just finished
     */
    public void sendDocumentCallReminderToPatient(PKBPerson clinician, PKBPerson patient, UUID conversationId,
                                                  RequiresConsent consentRequired, Optional&lt;Long&gt; teamId) {
<span class="fc" id="L1126">        LOGGER.debug(&quot;Enter sendNotificationToReceiver&quot;);</span>

        try {
<span class="fc" id="L1129">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1130">            addClinicianNameDetails(clinician, properties);</span>
<span class="fc" id="L1131">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L1132">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L1133">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L1134">            properties.put(PKBConstants.CONVERSATION_ID, conversationId);</span>
<span class="fc" id="L1135">            properties.put(PKBConstants.TITLE, &quot;&quot;);</span>
<span class="pc bpc" id="L1136" title="1 of 2 branches missed.">            boolean sendBrandedEmail = !clinician.isPatient();</span>
<span class="fc" id="L1137">            Team team = getTeam(teamId);</span>

<span class="fc" id="L1139">            emailManager.sendMessage(Message.PATIENT_DOCUMENT_CALL_REMINDER, clinician,</span>
<span class="fc" id="L1140">                    formatter.getPrimaryAndSecondaryContacts(patient, consentRequired), patient, properties,</span>
<span class="pc bpc" id="L1141" title="2 of 4 branches missed.">                    patient.getLocale(), null, clinician.getId().toString(), sendBrandedEmail ? getOrg(team) : null, sendBrandedEmail ? team : null);</span>

<span class="nc" id="L1143">        } catch (MailException exception) {</span>
<span class="nc" id="L1144">            throw new PKBException(</span>
<span class="nc" id="L1145">                    &quot;Unable to send document call reminder to receiver-&quot; + patient.findEmail().map(Email::address).getOrNull(), exception);</span>
<span class="fc" id="L1146">        }</span>
<span class="fc" id="L1147">        LOGGER.debug(&quot;Exiting sendNotificationToReceiver&quot;);</span>
<span class="fc" id="L1148">    }</span>

    /**
     * Sends clinician a message reminding them to document the call that has just finished
     */
    public void sendDocumentCallReminderToClinician(PKBPerson clinician, PKBPerson patient, UUID conversationId,
                                                    RequiresConsent consentRequired, Optional&lt;Long&gt; teamId) {
<span class="fc" id="L1155">        LOGGER.debug(&quot;Enter sendNotificationToReceiver&quot;);</span>
        try {
<span class="fc" id="L1157">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1158">            addClinicianNameDetails(clinician, properties);</span>
<span class="fc" id="L1159">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L1160">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L1161">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L1162">            properties.put(PKBConstants.CONVERSATION_ID, conversationId);</span>
<span class="fc" id="L1163">            properties.put(PKBConstants.TITLE, &quot;&quot;);</span>
<span class="fc" id="L1164">            Team team = getTeam(teamId);</span>

            // this is technically an email from the system, which we don't have a PKBPerson for, thus the null parameter
<span class="fc" id="L1167">            emailManager.sendSystemMessage(Message.CLINICIAN_DOCUMENT_CALL_REMINDER, null,</span>
<span class="fc" id="L1168">                    formatter.getPrimaryAndSecondaryContacts(clinician, consentRequired), clinician, properties,</span>
<span class="fc" id="L1169">                    clinician.getLocale(), null, getOrg(team), team);</span>

<span class="nc" id="L1171">        } catch (MailException exception) {</span>
<span class="nc" id="L1172">            throw new PKBException(</span>
<span class="nc" id="L1173">                    &quot;Unable to send document call reminder to clinician-&quot; + clinician.findEmail().map(Email::address).getOrNull(), exception);</span>
<span class="fc" id="L1174">        }</span>
<span class="fc" id="L1175">        LOGGER.debug(&quot;Exiting sendNotificationToReceiver&quot;);</span>
<span class="fc" id="L1176">    }</span>

    /**
     * Send notification email to new user that a discussion has been handed over to him
     */
    public void sendDiscussionHandoverNotificationToNewPerson(PKBPerson oldPerson, PKBPerson newPerson, UUID conversationId,
                                                              RequiresConsent consentRequired, Optional&lt;Long&gt; teamId) {
<span class="fc" id="L1183">        LOGGER.debug(&quot;Enter sendHandoverDiscussionNotificationToNewPerson&quot;);</span>
        try {
<span class="fc" id="L1185">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1186">            properties.put(PKBConstants.OLD_USER_TITLE, oldPerson.getTitle());</span>
<span class="fc" id="L1187">            properties.put(PKBConstants.OLD_USER_FIRST_NAME, oldPerson.getFirstName());</span>
<span class="fc" id="L1188">            properties.put(PKBConstants.OLD_USER_LAST_NAME, oldPerson.getLastName());</span>
<span class="fc" id="L1189">            properties.put(PKBConstants.NEW_USER_TITLE, newPerson.getTitle());</span>
<span class="fc" id="L1190">            properties.put(PKBConstants.NEW_USER_FIRST_NAME, newPerson.getFirstName());</span>
<span class="fc" id="L1191">            properties.put(PKBConstants.NEW_USER_LAST_NAME, newPerson.getLastName());</span>
<span class="fc" id="L1192">            properties.put(PKBConstants.CONVERSATION_ID, conversationId);</span>
<span class="fc" id="L1193">            properties.put(PKBConstants.TITLE, &quot;&quot;);</span>
<span class="pc bpc" id="L1194" title="1 of 2 branches missed.">            boolean sendBrandedEmail = !oldPerson.isPatient();</span>
<span class="fc" id="L1195">            Team team = getTeam(teamId);</span>

<span class="fc" id="L1197">            emailManager.sendMessage(Message.HANDOVER_DISCUSSION_NOTIFICATION_TO_NEW_PERSON, oldPerson,</span>
<span class="fc" id="L1198">                    formatter.getPrimaryAndSecondaryContacts(newPerson, consentRequired), newPerson, properties, newPerson.getLocale(),</span>
<span class="pc bpc" id="L1199" title="2 of 4 branches missed.">                    null, oldPerson.getId().toString(), sendBrandedEmail ? team.getOrg() : null, sendBrandedEmail ? team : null);</span>

<span class="nc" id="L1201">        } catch (MailException exception) {</span>
<span class="nc" id="L1202">            throw new PKBException(</span>
<span class="nc" id="L1203">                    &quot;Unable to send discussion handover notification to receiver-&quot; + newPerson.findEmail().map(Email::address).getOrNull(), exception);</span>
<span class="fc" id="L1204">        }</span>
<span class="fc" id="L1205">        LOGGER.debug(&quot;Exiting sendHandoverDiscussionNotificationToNewPerson&quot;);</span>
<span class="fc" id="L1206">    }</span>

    /**
     * Send notification email to user that the other party has handed the discussion over to a new person
     */
    public void sendDiscussionHandoverNotificationToOtherPerson(PKBPerson oldPerson, PKBPerson newPerson, PKBPerson otherPerson,
                                                                UUID conversationId, RequiresConsent consentRequired, Optional&lt;Long&gt; teamId) {
<span class="fc" id="L1213">        LOGGER.debug(&quot;Enter sendHandoverDiscussionNotificationToOtherPerson&quot;);</span>
        try {
<span class="fc" id="L1215">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1216">            properties.put(PKBConstants.OLD_USER_TITLE, oldPerson.getTitle());</span>
<span class="fc" id="L1217">            properties.put(PKBConstants.OLD_USER_FIRST_NAME, oldPerson.getFirstName());</span>
<span class="fc" id="L1218">            properties.put(PKBConstants.OLD_USER_LAST_NAME, oldPerson.getLastName());</span>
<span class="fc" id="L1219">            properties.put(PKBConstants.ORGANIZATION_NAME, oldPerson.getOrganizationName());</span>
<span class="fc" id="L1220">            properties.put(PKBConstants.NEW_USER_TITLE, newPerson.getTitle());</span>
<span class="fc" id="L1221">            properties.put(PKBConstants.NEW_USER_FIRST_NAME, newPerson.getFirstName());</span>
<span class="fc" id="L1222">            properties.put(PKBConstants.NEW_USER_LAST_NAME, newPerson.getLastName());</span>
<span class="fc" id="L1223">            properties.put(PKBConstants.OTHER_USER_TITLE, otherPerson.getTitle());</span>
<span class="fc" id="L1224">            properties.put(PKBConstants.OTHER_USER_FIRST_NAME, otherPerson.getFirstName());</span>
<span class="fc" id="L1225">            properties.put(PKBConstants.OTHER_USER_LAST_NAME, otherPerson.getLastName());</span>
<span class="fc" id="L1226">            properties.put(PKBConstants.CONVERSATION_ID, conversationId);</span>
<span class="fc" id="L1227">            properties.put(PKBConstants.CONTEXT_USER_ID, otherPerson.getId());</span>
<span class="fc" id="L1228">            properties.put(PKBConstants.TITLE, &quot;&quot;);</span>
<span class="pc bpc" id="L1229" title="1 of 2 branches missed.">            boolean sendBrandedEmail = !oldPerson.isPatient();</span>
<span class="fc" id="L1230">            Team team = getTeam(teamId);</span>

<span class="fc" id="L1232">            emailManager.sendMessage(Message.HANDOVER_DISCUSSION_NOTIFICATION_TO_OTHER_PERSON, oldPerson,</span>
<span class="fc" id="L1233">                    formatter.getPrimaryAndSecondaryContacts(otherPerson, consentRequired), otherPerson, properties, otherPerson.getLocale(),</span>
<span class="pc bpc" id="L1234" title="2 of 4 branches missed.">                    null, oldPerson.getId().toString(), sendBrandedEmail ? team.getOrg() : null, sendBrandedEmail ? team : null);</span>

<span class="nc" id="L1236">        } catch (MailException exception) {</span>
<span class="nc" id="L1237">            throw new PKBException(</span>
<span class="nc" id="L1238">                    &quot;Unable to send discussion handover notification to receiver-&quot; + otherPerson.findEmail().map(Email::address).getOrNull(), exception);</span>
<span class="fc" id="L1239">        }</span>
<span class="fc" id="L1240">        LOGGER.debug(&quot;Exiting sendHandoverDiscussionNotificationToOtherPerson&quot;);</span>
<span class="fc" id="L1241">    }</span>

    /**
     * Clinician asks Patient to take a questionnaire
     */
    public void invitePatientToTakeQuestionnaire(PKBPerson clinician, PKBPerson patient, UUID questionnaireRequestId,
                                                 boolean massQuestionnaire, RequiresConsent consentRequired, Team team) {
<span class="fc" id="L1248">        LOGGER.debug(&quot;Enter invitePatientToTakeQuestionnaire&quot;);</span>
        try {
<span class="fc" id="L1250">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc bfc" id="L1251" title="All 2 branches covered.">            if (!massQuestionnaire) {</span>
<span class="fc" id="L1252">                addClinicianNameDetails(clinician, properties);</span>
            }
<span class="fc" id="L1254">            properties.put(PKBConstants.ORGANIZATION_NAME, defaultString(clinician.getOrganizationName()));</span>
<span class="fc" id="L1255">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L1256">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L1257">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L1258">            properties.put(PKBConstants.CONTEXT_USER_ID, patient.getId());</span>
<span class="fc" id="L1259">            properties.put(PKBConstants.QUESTIONNAIRE_REQUEST_ID, questionnaireRequestId);</span>
<span class="fc bfc" id="L1260" title="All 2 branches covered.">            properties.put(PKBConstants.MASS_QUESTIONNAIRE, massQuestionnaire ? &quot;true&quot; : &quot;false&quot;);</span>

<span class="fc" id="L1262">            emailManager.sendMessage(Message.INVITE_PATIENT_TO_TAKE_QUESTIONNAIRE, clinician,</span>
<span class="fc" id="L1263">                    formatter.getPrimaryAndSecondaryContacts(patient, consentRequired), patient,</span>
<span class="fc" id="L1264">                    properties, patient.getLocale(), null, clinician.getId().toString(), getOrg(team), team);</span>
<span class="nc" id="L1265">        } catch (MailException exception) {</span>
<span class="nc" id="L1266">            throw new RuntimeException(&quot;Unable to send notification to receiver-&quot; + patient.findEmail().map(Email::address).getOrNull(), exception);</span>
<span class="fc" id="L1267">        }</span>
<span class="fc" id="L1268">        LOGGER.debug(&quot;Exiting invitePatientToOnlineConsultation&quot;);</span>
<span class="fc" id="L1269">    }</span>

    /**
     * sent when the clinician registers &amp; auto-accepts the invitation
     */
    public void sendNotificationClinicianAcceptedInvitation(PKBPerson clinician, PKBPerson patient) {
        try {
<span class="fc" id="L1276">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1277">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L1278">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L1279">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L1280">            properties.put(PKBConstants.USER_ID, patient.getId());</span>
<span class="fc" id="L1281">            addClinicianNameDetails(clinician, properties);</span>

<span class="fc" id="L1283">            emailManager.sendMessage(Message.NOTIFICATION_CLINICIAN_ACCEPTED_INVITATION, clinician,</span>
<span class="fc" id="L1284">                    formatter.getPrimaryAndSecondaryContacts(patient, new NoConsentsRequired()), patient, properties,</span>
<span class="fc" id="L1285">                    patient.getLocale(), ACCEPTED_INVITATION, clinician.getId().toString(), null, null);</span>

<span class="nc" id="L1287">        } catch (MailException exception) {</span>
<span class="nc" id="L1288">            throw new PKBException(&quot;Unable to build/send message&quot;, exception);</span>
<span class="fc" id="L1289">        }</span>
<span class="fc" id="L1290">    }</span>

    /**
     * @param requestContext
     * @param clinician
     * @param author
     * @param patient
     */
    public void sendNotificationClinicianAcceptedInvitation(PKBPerson clinician, PKBPerson author, PKBPerson patient) {
        try {
<span class="fc" id="L1300">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1301">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L1302">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L1303">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L1304">            properties.put(PKBConstants.AUTHOR_TITLE, author.getTitle());</span>
<span class="fc" id="L1305">            properties.put(PKBConstants.AUTHOR_FIRST_NAME, author.getFirstName());</span>
<span class="fc" id="L1306">            properties.put(PKBConstants.AUTHOR_LAST_NAME, author.getLastName());</span>
<span class="fc" id="L1307">            addClinicianNameDetails(clinician, properties);</span>
<span class="fc" id="L1308">            properties.put(PKBConstants.USER_ID, patient.getId());</span>
<span class="fc" id="L1309">            properties.put(PKBConstants.LOGIN_EMAIL, patient.findEmail().map(Email::address).getOrNull());</span>

<span class="fc" id="L1311">            emailManager.sendMessage(Message.NOTIFY_PATIENT_THAT_CLINICIAN_ACCEPTED_INVITATION, clinician,</span>
<span class="fc" id="L1312">                    formatter.getPrimaryAndSecondaryContacts(patient, new NoConsentsRequired()), patient, properties,</span>
<span class="fc" id="L1313">                    patient.getLocale(), ACCEPTED_INVITATION, clinician.getId().toString(), null, null);</span>
<span class="nc" id="L1314">        } catch (MailException exception) {</span>
<span class="nc" id="L1315">            throw new PKBException(&quot;Unable to build/send message&quot;, exception);</span>
<span class="fc" id="L1316">        }</span>
<span class="fc" id="L1317">    }</span>

    /**
     * Notify carer that patient has accepted offer of care
     */
    public void sendNotificationPatientAcceptedOfferedCare(PKBPerson patient, PKBPerson carer) {
        try {
<span class="fc" id="L1324">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1325">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L1326">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L1327">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L1328">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="fc" id="L1329">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="fc" id="L1330">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="fc" id="L1331">            properties.put(PKBConstants.USER_ID, patient.getId());</span>

<span class="fc" id="L1333">            emailManager.sendMessage(Message.NOTIFICATION_PATIENT_ACCEPTED_OFFERED_CARE, patient,</span>
<span class="fc" id="L1334">                    formatter.getPrimaryAndSecondaryContacts(carer, new NoConsentsRequired()), carer, properties,</span>
<span class="fc" id="L1335">                    carer.getLocale(), null, patient.getId().toString(), null, null);</span>

<span class="nc" id="L1337">        } catch (MailException exception) {</span>
<span class="nc" id="L1338">            throw new PKBException(&quot;Unable to build/send message&quot;, exception);</span>
<span class="fc" id="L1339">        }</span>
<span class="fc" id="L1340">    }</span>

    /**
     * Notify carer that person has accepted offer of care on behalf of patient
     */
    public void sendNotificationOfferedCareAcceptedOnBehalfOfPatient(PKBPerson patient, PKBPerson sender, PKBPerson actor) {
        try {
<span class="nc" id="L1347">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="nc" id="L1348">            addPatientAndActorNameDetails(patient, actor, properties);</span>
<span class="nc bnc" id="L1349" title="All 2 branches missed.">            properties.put(PKBConstants.PATIENT_HIS_OR_HER, patient.getGender() == 1 ? &quot;his&quot; : &quot;her&quot;);</span>
<span class="nc" id="L1350">            properties.put(PKBConstants.SENDER_TITLE, sender.getTitle());</span>
<span class="nc" id="L1351">            properties.put(PKBConstants.SENDER_FIRST_NAME, sender.getFirstName());</span>
<span class="nc" id="L1352">            properties.put(PKBConstants.SENDER_LAST_NAME, sender.getLastName());</span>
<span class="nc" id="L1353">            properties.put(PKBConstants.USER_ID, patient.getId());</span>

<span class="nc" id="L1355">            emailManager.sendMessage(Message.NOTIFICATION_OFFERED_CARE_ACCEPTED_ON_BEHALF_OF_PATIENT, patient,</span>
<span class="nc" id="L1356">                    formatter.getPrimaryAndSecondaryContacts(sender, new NoConsentsRequired()), sender, properties,</span>
<span class="nc" id="L1357">                    sender.getLocale(), null, patient.getId().toString(), null, null);</span>
<span class="nc" id="L1358">        } catch (MailException exception) {</span>
<span class="nc" id="L1359">            throw new PKBException(&quot;Unable to build/send message&quot;, exception);</span>
<span class="nc" id="L1360">        }</span>
<span class="nc" id="L1361">    }</span>

    /**
     * Notify patient that a clinician has created an account for them (all set up,
     * with temporary password).
     */
    public void notifyPatientOfCreatedAccount(PKBPerson creatorUser, PKBPerson patient, Team team,
                                              String personalMsg)
            throws MailException {
<span class="fc" id="L1370">        LOGGER.debug(&quot;Enter notifyPatientOfAccountCreation&quot;);</span>

<span class="fc" id="L1372">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="pc bpc" id="L1373" title="1 of 2 branches missed.">        if (patient.getFirstName().equals(PKBConstants.DEFAULT_PATIENT_FIRSTNAME)</span>
<span class="pc bpc" id="L1374" title="1 of 2 branches missed.">                || patient.getLastName().equals(PKBConstants.DEFAULT_PATIENT_LASTNAME)) {</span>
<span class="nc" id="L1375">            properties.put(PKBConstants.PATIENT_FIRST_NAME, &quot;Caregiver&quot;);</span>
        } else {
<span class="fc" id="L1377">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L1378">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L1379">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
        }
<span class="fc bfc" id="L1381" title="All 2 branches covered.">        if (creatorUser != null) {</span>
<span class="fc" id="L1382">            addClinicianNameDetails(creatorUser, properties);</span>
        }
<span class="fc" id="L1384">        properties.put(PKBConstants.INSTITUTE_CODE, team.getCode());</span>
<span class="fc" id="L1385">        properties.put(PKBConstants.INSTITUTE_NAME, team.getOrg().getName());</span>
<span class="fc" id="L1386">        properties.put(PKBConstants.USER_ID, patient.getId());</span>
<span class="pc bpc" id="L1387" title="1 of 2 branches missed.">        properties.put(PKBConstants.TEMP_PASSWORD, patient.getPassword() == null ? &quot;&quot; : patient.getPassword());</span>
<span class="fc bfc" id="L1388" title="All 2 branches covered.">        properties.put(PKBConstants.MESSAGE, personalMsg == null ? &quot;&quot; : personalMsg);</span>

<span class="fc" id="L1390">        emailManager.sendMessage(Message.NOTIFY_PATIENT_OF_CREATED_ACCOUNT, creatorUser,</span>
<span class="fc" id="L1391">                formatter.getPrimaryAndSecondaryContacts(patient, new NoConsentsRequired()), patient, properties,</span>
<span class="fc bfc" id="L1392" title="All 2 branches covered.">                team.getLocale(), CREATED_ACCOUNT, creatorUser != null ? creatorUser.getId().toString() : null, team.getOrg(), team);</span>

<span class="fc" id="L1394">        LOGGER.debug(&quot;Exiting notifyPatientOfAccountCreation&quot;);</span>
<span class="fc" id="L1395">    }</span>

    public void notifyClinicianOfCreatedAccount(PKBPerson creatorUser, PKBPerson clinician, Team team,
                                                String personalMsg)
            throws MailException {
<span class="fc" id="L1400">        LOGGER.debug(&quot;Enter notifyPatientOfAccountCreation&quot;);</span>

<span class="fc" id="L1402">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1403">        addClinicianNameDetails(clinician, properties);</span>
<span class="fc" id="L1404">        addAdminNameDetails(creatorUser, properties);</span>
<span class="fc" id="L1405">        properties.put(PKBConstants.INSTITUTE_CODE, team.getCode());</span>
<span class="fc" id="L1406">        properties.put(PKBConstants.INSTITUTE_NAME, team.getOrg().getName());</span>
<span class="fc" id="L1407">        properties.put(PKBConstants.USER_ID, clinician.getId());</span>
<span class="pc bpc" id="L1408" title="1 of 2 branches missed.">        properties.put(PKBConstants.TEMP_PASSWORD, clinician.getPassword() == null ? &quot;&quot; : clinician.getPassword());</span>
<span class="pc bpc" id="L1409" title="1 of 2 branches missed.">        properties.put(PKBConstants.MESSAGE, personalMsg == null ? &quot;&quot; : personalMsg);</span>

<span class="fc" id="L1411">        emailManager.sendMessage(Message.NOTIFY_CLINICIAN_OF_CREATED_ACCOUNT, creatorUser,</span>
<span class="fc" id="L1412">                formatter.getPrimaryAndSecondaryContacts(clinician, new NoConsentsRequired()), clinician, properties,</span>
<span class="fc" id="L1413">                creatorUser.getLocale(), null, creatorUser.getId().toString(), team.getOrg(), team);</span>

<span class="fc" id="L1415">        LOGGER.debug(&quot;Exiting notifyPatientOfAccountCreation&quot;);</span>
<span class="fc" id="L1416">    }</span>

    /**
     * Notify a new coordinator that he has been added to an existing team
     */
    public void notifyCoordinatorOfCreatedAccount(PKBPerson creatorUser, PKBPerson coordinator, Team team)
            throws MailException {
<span class="fc" id="L1423">        LOGGER.debug(&quot;Enter notifyCoordinatorOfAccountCreation&quot;);</span>

<span class="fc" id="L1425">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1426">        addAdminNameDetails(coordinator, properties);</span>
<span class="fc" id="L1427">        addClinicianNameDetails(creatorUser, properties);</span>
<span class="fc" id="L1428">        addTeamBasicDetails(team, properties);</span>
<span class="fc" id="L1429">        properties.put(PKBConstants.USER_ID, coordinator.getId());</span>
<span class="fc" id="L1430">        properties.put(PKBConstants.TEMP_PASSWORD, coordinator.getPassword());</span>

<span class="fc" id="L1432">        emailManager.sendMessage(Message.NOTIFY_COORDINATOR_OF_CREATED_ACCOUNT, creatorUser,</span>
<span class="fc" id="L1433">                formatter.getPrimaryAndSecondaryContacts(coordinator, new NoConsentsRequired()), coordinator, properties,</span>
<span class="fc" id="L1434">                coordinator.getLocale(), CREATED_ACCOUNT, creatorUser.getId().toString(), team.getOrg(), team);</span>

<span class="fc" id="L1436">        LOGGER.debug(&quot;Exiting notifyPatientOfAccountCreation&quot;);</span>
<span class="fc" id="L1437">    }</span>

    /**
     * Slightly different wording for the initial creator of a new team
     */
    public void inviteInitialTeamCoord(Team team, PKBPerson newCoord, PKBPerson pkbAdmin) {
<span class="pc bpc" id="L1443" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1444">            LOGGER.debug(&quot;Enter inviteInstituteAdmin&quot;);</span>
        }
        try {
<span class="fc" id="L1447">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1448">            addAdminNameDetails(newCoord, properties);</span>
<span class="fc" id="L1449">            properties.put(PKBConstants.PKB_HELP_PHONE, config.getHelpPhone());</span>
<span class="fc" id="L1450">            addTeamDetails(team, properties);</span>
<span class="fc" id="L1451">            properties.put(PKBConstants.USER_ID, newCoord.getId());</span>
<span class="fc" id="L1452">            properties.put(PKBConstants.TEMP_PASSWORD, newCoord.getPassword());</span>

<span class="fc" id="L1454">            emailManager.sendMessage(Message.INVITE_INSTITUTE_ADMIN, pkbAdmin,</span>
<span class="fc" id="L1455">                    formatter.getPrimaryAndSecondaryContacts(newCoord, new NoConsentsRequired()), newCoord,</span>
<span class="fc" id="L1456">                    properties, pkbAdmin.getLocale(), SENT_INVITATION, pkbAdmin.getId().toString(), team.getOrg(), team);</span>

<span class="nc" id="L1458">        } catch (MailException exception) {</span>
<span class="nc" id="L1459">            LOGGER.error(&quot;Unable to send message &quot;, exception);</span>
<span class="nc" id="L1460">            throw new PKBException(&quot;Unable to send invitation to admin -&quot;</span>
<span class="nc" id="L1461">                    + newCoord.getId(), exception);</span>
<span class="fc" id="L1462">        }</span>
<span class="pc bpc" id="L1463" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1464">            LOGGER.debug(&quot;Exit inviteInstituteAdmin&quot;);</span>
        }
<span class="fc" id="L1466">    }</span>

    public void inviteInitialOrgCoord(Org org, PKBPerson newCoord, PKBPerson pkbAdmin) {
<span class="pc bpc" id="L1469" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1470">            LOGGER.debug(&quot;Enter inviteOrgCoord&quot;);</span>
        }
        try {
<span class="fc" id="L1473">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1474">            addAdminNameDetails(newCoord, properties);</span>
<span class="fc" id="L1475">            properties.put(PKBConstants.PKB_HELP_PHONE, config.getHelpPhone());</span>
<span class="fc" id="L1476">            properties.put(PKBConstants.INSTITUTE_NAME, org.getName());</span>
<span class="fc" id="L1477">            properties.put(PKBConstants.INSTITUTE_CODE, org.getCode());</span>
<span class="fc" id="L1478">            properties.put(PKBConstants.USER_ID, newCoord.getId());</span>
<span class="fc" id="L1479">            properties.put(PKBConstants.TEMP_PASSWORD, newCoord.getPassword());</span>

<span class="fc" id="L1481">            emailManager.sendMessage(Message.INVITE_ORG_COORD, pkbAdmin,</span>
<span class="fc" id="L1482">                    formatter.getPrimaryAndSecondaryContacts(newCoord, new NoConsentsRequired()), newCoord, properties,</span>
<span class="fc" id="L1483">                    pkbAdmin.getLocale(), SENT_INVITATION, pkbAdmin.getId().toString(), org, null);</span>

<span class="nc" id="L1485">        } catch (MailException exception) {</span>
<span class="nc" id="L1486">            throw new PKBException(&quot;Unable to send invitation to org-coord--&quot;</span>
<span class="nc" id="L1487">                    + newCoord.getId(), exception);</span>
<span class="fc" id="L1488">        }</span>
<span class="pc bpc" id="L1489" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1490">            LOGGER.debug(&quot;Exit inviteOrgCoord&quot;);</span>
        }
<span class="fc" id="L1492">    }</span>

    /**
     * @param requestContext
     * @param org
     * @param privacyOfficer
     * @param pkbAdmin
     */
    public void invitePrivacyOfficer(@NotNull Org org, @NotNull PKBPerson privacyOfficer, @NotNull PKBPerson pkbAdmin) {

<span class="fc" id="L1502">        LOGGER.debug(&quot;Enter invitePrivacyOfficer&quot;);</span>

        try {
<span class="fc" id="L1505">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1506">            properties.put(PKBConstants.ADMIN_TITLE, privacyOfficer.getTitle());</span>
<span class="fc" id="L1507">            properties.put(PKBConstants.ADMIN_FIRST_NAME, privacyOfficer.getFirstName());</span>
<span class="fc" id="L1508">            properties.put(PKBConstants.ADMIN_LAST_NAME, privacyOfficer.getLastName());</span>
<span class="fc" id="L1509">            properties.put(PKBConstants.PKB_HELP_PHONE, config.getHelpPhone());</span>
<span class="fc" id="L1510">            properties.put(PKBConstants.INSTITUTE_NAME, org.getName());</span>
<span class="fc" id="L1511">            properties.put(PKBConstants.INSTITUTE_CODE, org.getCode());</span>
<span class="fc" id="L1512">            properties.put(PKBConstants.USER_ID, privacyOfficer.getId());</span>
<span class="fc" id="L1513">            properties.put(PKBConstants.TEMP_PASSWORD, privacyOfficer.getPassword());</span>

<span class="fc" id="L1515">            emailManager.sendMessage(Message.INVITE_PRIVACY_OFFICER, pkbAdmin,</span>
<span class="fc" id="L1516">                    formatter.getPrimaryAndSecondaryContacts(privacyOfficer, new NoConsentsRequired()), privacyOfficer,</span>
<span class="fc" id="L1517">                    properties, pkbAdmin.getLocale(), SENT_INVITATION, pkbAdmin.getId().toString(), org, null);</span>

<span class="nc" id="L1519">        } catch (MailException exception) {</span>
<span class="nc" id="L1520">            throw new PKBException(&quot;Unable to send invitation to privacy officer &quot;</span>
<span class="nc" id="L1521">                    + privacyOfficer.getId(), exception);</span>
<span class="fc" id="L1522">        }</span>

<span class="fc" id="L1524">        LOGGER.debug(&quot;Exit invitePrivacyOfficer&quot;);</span>

<span class="fc" id="L1526">    }</span>

    /**
     * Send notification email to institute administrator about the newly registered user
     *
     * @param requestContext the request context
     * @param registeredUser registered user
     * @param team           team object
     * @param instituteAdmin institute administrator
     * @throws MailException
     */
    public void sendNotificationToInstituteAdmin(PKBPerson registeredUser, Team team,
                                                 PKBPerson instituteAdmin, boolean hasVerification) throws MailException {
<span class="pc bpc" id="L1539" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1540">            LOGGER.debug(&quot;Enter sendNotificationToInstituteAdmin&quot;);</span>
        }
<span class="fc" id="L1542">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1543">        addNameDetails(registeredUser, properties);</span>
<span class="fc" id="L1544">        addAdminNameDetails(instituteAdmin, properties);</span>
<span class="fc" id="L1545">        properties.put(PKBConstants.INSTITUTE_NAME, team.getOrg().getName());</span>
<span class="fc" id="L1546">        properties.put(PKBConstants.INSTITUTE_TEAM, team.getName());</span>
<span class="fc" id="L1547">        properties.put(PKBConstants.USER_ID, registeredUser.getId());</span>

<span class="fc" id="L1549">        emailManager.sendMessage(Message.NOTIFICATION_TO_INST_ADMIN, registeredUser,</span>
<span class="fc" id="L1550">                formatter.getPrimaryAndSecondaryContacts(instituteAdmin, new NoConsentsRequired()), instituteAdmin,</span>
<span class="fc" id="L1551">                properties, instituteAdmin.getLocale(), null, registeredUser.getId().toString(), team.getOrg(), team);</span>

<span class="pc bpc" id="L1553" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1554">            LOGGER.debug(&quot;Exiting sendNotificationToInstituteAdmin&quot;);</span>
        }
<span class="fc" id="L1556">    }</span>

    private Map&lt;String, String&gt; getTranslatedPrivacyLabels(PatientConsentBaseDTO patientConsent, Locale locale) {
<span class="fc" id="L1559">        Map&lt;Boolean, List&lt;String&gt;&gt; translatedMap = new HashMap&lt;&gt;();</span>
<span class="fc" id="L1560">        translatedMap.put(TRUE, new ArrayList&lt;&gt;());</span>
<span class="fc" id="L1561">        translatedMap.put(FALSE, new ArrayList&lt;&gt;());</span>

<span class="fc" id="L1563">        translatedMap.get(patientConsent.generalHealthConsentGranted()).add(AppResourceBundle.getPropertyValue(&quot;GENERAL&quot;, locale, MISCELLANEOUS_LABELS_BUNDLE_NAME));</span>
<span class="fc" id="L1564">        translatedMap.get(patientConsent.socialCareConsentGranted()).add(AppResourceBundle.getPropertyValue(&quot;SOCIAL&quot;, locale, MISCELLANEOUS_LABELS_BUNDLE_NAME));</span>
<span class="fc" id="L1565">        translatedMap.get(patientConsent.mentalHealthConsentGranted()).add(AppResourceBundle.getPropertyValue(&quot;MENTAL&quot;, locale, MISCELLANEOUS_LABELS_BUNDLE_NAME));</span>
<span class="fc" id="L1566">        translatedMap.get(patientConsent.sexualHealthConsentGranted()).add(AppResourceBundle.getPropertyValue(&quot;SEXUAL&quot;, locale, MISCELLANEOUS_LABELS_BUNDLE_NAME));</span>

<span class="fc" id="L1568">        return translatedMap.entrySet()</span>
<span class="fc" id="L1569">                .stream()</span>
<span class="fc" id="L1570">                .map(entry -&gt; ofAll(entry.getValue())</span>
<span class="fc" id="L1571">                        .zipWithIndex()</span>
<span class="fc" id="L1572">                        .toLinkedMap(k -&gt; entry.getKey().toString().toLowerCase() + &quot;Label&quot; + (k._2 + 1), v -&gt; v._1)</span>
<span class="fc" id="L1573">                        .toJavaMap())</span>
<span class="fc" id="L1574">                .collect(HashMap::new, Map::putAll, Map::putAll);</span>
    }

    /**
     * Send email request to the user to give access to records to the institute administrator
     *
     * @param requestContext the request context
     * @param user           user to which the request is sent
     * @param team          {@link Team}
     * @param instituteAdmin institute administrator
     * @throws MailException
     */
    public void sendAccessRequest(PKBPerson user, Team team, PKBPerson instituteAdmin)
            throws MailException {
<span class="nc bnc" id="L1588" title="All 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1589">            LOGGER.debug(&quot;Enter sendAccessRequest&quot;);</span>
        }
<span class="nc" id="L1591">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="nc" id="L1592">        addNameDetails(user, properties);</span>
<span class="nc" id="L1593">        properties.put(PKBConstants.EMAIL, user.findEmail().map(Email::address).getOrNull());</span>
<span class="nc" id="L1594">        addAdminNameDetails(instituteAdmin, properties);</span>
<span class="nc" id="L1595">        properties.put(PKBConstants.INSTITUTE_NAME, team.getOrg().getName());</span>
<span class="nc" id="L1596">        properties.put(PKBConstants.INSTITUTE_TEAM, team.getName());</span>
<span class="nc" id="L1597">        properties.put(PKBConstants.INSTITUTE_CODE, team.getCode());</span>

<span class="nc" id="L1599">        emailManager.sendMessage(Message.REQUEST_ACCESS, instituteAdmin,</span>
<span class="nc" id="L1600">                formatter.getPrimaryAndSecondaryContacts(user, new NoConsentsRequired()), user,</span>
<span class="nc" id="L1601">                properties, user.getLocale(), null, instituteAdmin.getId().toString(), team.getOrg(), team);</span>

<span class="nc bnc" id="L1603" title="All 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1604">            LOGGER.debug(&quot;Exiting sendAccessRequest&quot;);</span>
        }

<span class="nc" id="L1607">    }</span>

    public void inviteClinicianToUpgrade(Team team, PKBPerson admin, PKBPerson clinician,
                                         UUID invitationPublicId) throws MailException {
<span class="pc bpc" id="L1611" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1612">            LOGGER.debug(&quot;Enter inviteClinicianToUpgrade&quot;);</span>
        }
<span class="fc" id="L1614">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1615">        addClinicianNameDetails(clinician, properties);</span>
<span class="fc" id="L1616">        addAdminNameDetails(admin, properties);</span>
<span class="fc" id="L1617">        addTeamDetails(team, properties);</span>
<span class="fc" id="L1618">        properties.put(PKBConstants.INVITATION_ID, invitationPublicId.toString());</span>
<span class="fc" id="L1619">        properties.put(PKBConstants.USER_ID, clinician.getId());</span>

<span class="fc" id="L1621">        emailManager.sendMessage(Message.INVITE_CLINICIAN_TO_UPGRADE, admin,</span>
<span class="fc" id="L1622">                formatter.getPrimaryAndSecondaryContacts(clinician, new NoConsentsRequired()),</span>
<span class="fc" id="L1623">                clinician, properties, clinician.getLocale(), null, admin.getId().toString(), team.getOrg(), team);</span>

<span class="pc bpc" id="L1625" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1626">            LOGGER.debug(&quot;Exit inviteClinicianToUpgrade&quot;);</span>
        }
<span class="fc" id="L1628">    }</span>

    public void inviteClinicianToUpgradeWithTeamWithOrg(TeamWithOrg teamWithOrg, PKBPerson admin, PKBPerson clinician,
                                                        UUID invitationId) throws MailException {
<span class="nc bnc" id="L1632" title="All 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1633">            LOGGER.debug(&quot;Enter inviteClinicianToUpgrade&quot;);</span>
        }
<span class="nc" id="L1635">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="nc" id="L1636">        addClinicianNameDetails(clinician, properties);</span>
<span class="nc" id="L1637">        addAdminNameDetails(admin, properties);</span>
<span class="nc" id="L1638">        addTeamDetailsWithTeamWithOrg(teamWithOrg, properties);</span>
<span class="nc" id="L1639">        properties.put(PKBConstants.INVITATION_ID, invitationId);</span>
<span class="nc" id="L1640">        properties.put(PKBConstants.USER_ID, clinician.getId());</span>

<span class="nc" id="L1642">        emailManager.sendMessage(Message.INVITE_CLINICIAN_TO_UPGRADE, admin,</span>
<span class="nc" id="L1643">                formatter.getPrimaryAndSecondaryContacts(clinician, new NoConsentsRequired()), clinician, properties,</span>
<span class="nc" id="L1644">                clinician.getLocale(), null, admin.getId().toString(), getOrg(teamWithOrg), getTeam(teamWithOrg));</span>

<span class="nc bnc" id="L1646" title="All 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1647">            LOGGER.debug(&quot;Exit inviteClinicianToUpgrade&quot;);</span>
        }
<span class="nc" id="L1649">    }</span>

    /**
     * Send the link to user for password reset
     *
     * @param user      {@link PKBPerson} object for person whose password needs to be reset
     * @param resetCode included in the URL; this is the answer to the security question
     * @throws MailException thrown when failed to send email
     */
    public void sendPasswordResetMail(PKBPerson user, String resetCode, Team team, PKBPerson admin)
            throws MailException {
<span class="fc" id="L1660">        LOGGER.debug(&quot;Enter sendPasswordReset&quot;);</span>

<span class="fc" id="L1662">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1663">        addNameDetails(user, properties);</span>
<span class="fc" id="L1664">        properties.put(PKBConstants.USER_ID, user.getId());</span>
<span class="fc" id="L1665">        properties.put(PKBConstants.ACTIVATION_CODE, resetCode);</span>
<span class="fc" id="L1666">        addAdminNameDetails(admin, properties);</span>
<span class="fc" id="L1667">        properties.put(PKBConstants.ADMIN_EMAIL, admin.findEmail().map(Email::address).getOrNull());</span>

<span class="fc bfc" id="L1669" title="All 2 branches covered.">        Message messageType = UserType.SUPER_ADMIN == admin.getUserType() ? RESET_PASSWORD_BY_SUPER_ADMIN : RESET_PASSWORD;</span>

<span class="fc bfc" id="L1671" title="All 2 branches covered.">        if (UserType.SUPER_ADMIN != admin.getUserType()) {</span>
<span class="fc" id="L1672">            properties.put(PKBConstants.INSTITUTE_NAME, team.getOrg().getName());</span>
        }

<span class="fc" id="L1675">        emailManager.sendMessage(messageType, admin,</span>
                // Reset password should go only the intended user and not the carers
<span class="fc" id="L1677">                formatter.getSenderContact(user), user, properties,</span>
<span class="fc" id="L1678">                user.getLocale(), null, admin.getId().toString(), getOrg(team), team);</span>

<span class="fc" id="L1680">        LOGGER.debug(&quot;Exit sendPasswordReset&quot;);</span>
<span class="fc" id="L1681">    }</span>

    /**
     * Send the notification to revoked-person about their revoked access to patient
     *
     * @throws MailException
     */
    public void sendRevokeAccessNotificationToRevokedPerson(PKBPerson patient, PKBPerson revokedPerson, PKBPerson accessingUser)
            throws MailException {
<span class="pc bpc" id="L1690" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1691">            LOGGER.debug(&quot;Enter sendRevokeAccessNotificationToRevokedPerson&quot;);</span>
        }
<span class="fc" id="L1693">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1694">        properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L1695">        properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L1696">        properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc bfc" id="L1697" title="All 2 branches covered.">        if (accessingUser != null) {</span>
<span class="fc" id="L1698">            properties.put(PKBConstants.ACTOR_TITLE, accessingUser.getTitle());</span>
<span class="fc" id="L1699">            properties.put(PKBConstants.ACTOR_FIRST_NAME, accessingUser.getFirstName());</span>
<span class="fc" id="L1700">            properties.put(PKBConstants.ACTOR_LAST_NAME, accessingUser.getLastName());</span>
        }
<span class="fc" id="L1702">        addClinicianNameDetails(revokedPerson, properties);</span>
<span class="fc" id="L1703">        properties.put(PKBConstants.BASE_URL, config.getBaseURL());</span>

<span class="fc" id="L1705">        emailManager.sendMessage(Message.NOTIFY_PERSON_THEIR_ACCESS_HAS_BEEN_REVOKED, patient,</span>
<span class="fc" id="L1706">                formatter.getPrimaryAndSecondaryContacts(revokedPerson, new NoConsentsRequired()), revokedPerson, properties,</span>
<span class="fc" id="L1707">                revokedPerson.getLocale(), null, patient.getId().toString(), null, null);</span>

<span class="pc bpc" id="L1709" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1710">            LOGGER.debug(&quot;Exiting sendRevokeAccessNotificationToRevokedPerson&quot;);</span>
        }
<span class="fc" id="L1712">    }</span>

    public void sendRevokeAccessNotificationToRevokedPerson(PKBPerson patient, PKBPerson revokedPerson)
            throws MailException {
<span class="fc" id="L1716">        sendRevokeAccessNotificationToRevokedPerson(patient, revokedPerson, null);</span>
<span class="fc" id="L1717">    }</span>

    /**
     * Send the notification to patient about revoked access to person
     *
     * @throws MailException
     */
    public void sendRevokeAccessNotificationToPatient(PKBPerson patient, PKBPerson person)
            throws MailException {
<span class="pc bpc" id="L1726" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1727">            LOGGER.debug(&quot;Enter sendRevokeAccessNotificationToPatient&quot;);</span>
        }
<span class="fc" id="L1729">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1730">        properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L1731">        properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L1732">        properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc bfc" id="L1733" title="All 2 branches covered.">        if (person.isPatient()) {</span>
<span class="fc" id="L1734">            addNameDetails(person, properties);</span>
        } else {
<span class="fc" id="L1736">            addClinicianNameAndInstituteNameDetails(person, properties);</span>
        }
<span class="fc" id="L1738">        properties.put(PKBConstants.USER_ID, patient.getId());</span>
<span class="fc" id="L1739">        properties.put(PKBConstants.BASE_URL, config.getBaseURL());</span>

<span class="fc" id="L1741">        emailManager.sendMessage(Message.REVOKE_ACCESS_NOTIFICATION_TO_PATIENT, person,</span>
<span class="fc" id="L1742">                formatter.getPrimaryAndSecondaryContacts(patient, new NoConsentsRequired()), patient, properties,</span>
<span class="fc" id="L1743">                patient.getLocale(), null, person.getId().toString(), null, null);</span>

<span class="pc bpc" id="L1745" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1746">            LOGGER.debug(&quot;Exiting sendRevokeAccessNotificationToPatient&quot;);</span>
        }

<span class="fc" id="L1749">    }</span>

    public void sendRevokeIndivAccessNotificationToPatient(PKBPerson patient, PKBPerson actor, PKBPerson indiv,
                                                           PKBPerson accessingUser, Org org, Long teamId)
            throws MailException {
<span class="pc bpc" id="L1754" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1755">            LOGGER.debug(&quot;Enter sendRevokeIndivAccessNotificationToPatient&quot;);</span>
        }
<span class="fc" id="L1757">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>

<span class="fc" id="L1759">        addPatientAndActorNameDetails(patient, actor, properties);</span>
<span class="fc" id="L1760">        properties.put(PKBConstants.USER_ID, patient.getId());</span>
<span class="fc" id="L1761">        properties.put(PKBConstants.ACTOR_TITLE, accessingUser.getTitle());</span>
<span class="fc" id="L1762">        properties.put(PKBConstants.ACTOR_FIRST_NAME, accessingUser.getFirstName());</span>
<span class="fc" id="L1763">        properties.put(PKBConstants.ACTOR_LAST_NAME, accessingUser.getLastName());</span>
<span class="fc" id="L1764">        properties.put(PKBConstants.CLINICIAN_TITLE, indiv.getTitle());</span>
<span class="fc" id="L1765">        properties.put(PKBConstants.CLINICIAN_FIRST_NAME, indiv.getFirstName());</span>
<span class="fc" id="L1766">        properties.put(PKBConstants.CLINICIAN_LAST_NAME, indiv.getLastName());</span>
<span class="fc" id="L1767">        properties.put(PKBConstants.BASE_URL, config.getBaseURL());</span>
<span class="fc bfc" id="L1768" title="All 2 branches covered.">        boolean sendBrandedEmail = !actor.isPatient();</span>

<span class="fc" id="L1770">        emailManager.sendMessage(Message.INDIV_ACCESS_REVOKED_NOTIFICATION_TO_PATIENT, actor,</span>
<span class="fc" id="L1771">                formatter.getPrimaryAndSecondaryContacts(patient, new NoConsentsRequired()), patient, properties, patient.getLocale(),</span>
<span class="fc bfc" id="L1772" title="All 4 branches covered.">                null, actor.getId().toString(), sendBrandedEmail ? org : null, sendBrandedEmail ? teamManager.getTeam(teamId) : null);</span>

<span class="pc bpc" id="L1774" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1775">            LOGGER.debug(&quot;Exiting sendRevokeIndivAccessNotificationToPatient&quot;);</span>
        }
<span class="fc" id="L1777">    }</span>

    /**
     * Send notification email to institute administrator to activate the newly registered user
     *
     * @param requestContext the request context
     * @param registeredUser registered user
     * @param team           team object
     * @param instituteAdmin institute administrator
     * @throws MailException
     */
    public void requestActivationToInstituteAdmin(PKBPerson registeredUser, Team team, PKBPerson instituteAdmin)
            throws MailException {
<span class="pc bpc" id="L1790" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1791">            LOGGER.debug(&quot;Enter sendNotificationToInstituteAdmin&quot;);</span>
        }
<span class="fc" id="L1793">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1794">        addNameDetails(registeredUser, properties);</span>
<span class="fc" id="L1795">        addAdminNameDetails(instituteAdmin, properties);</span>
<span class="fc" id="L1796">        addTeamDetails(team, properties);</span>
<span class="fc" id="L1797">        properties.put(PKBConstants.USER_ID, registeredUser.getId());</span>
<span class="pc bpc" id="L1798" title="1 of 2 branches missed.">        boolean sendBrandedEmail = !registeredUser.isPatient();</span>

<span class="fc" id="L1800">        emailManager.sendMessage(Message.ACTIVATION_REQUEST_TO_INST_ADMIN,</span>
                registeredUser,
<span class="fc" id="L1802">                formatter.getPrimaryAndSecondaryContacts(instituteAdmin, new NoConsentsRequired()),</span>
                instituteAdmin,
                properties,
<span class="fc" id="L1805">                instituteAdmin.getLocale(), null,</span>
<span class="fc" id="L1806">                registeredUser.getId().toString(),</span>
<span class="pc bpc" id="L1807" title="1 of 2 branches missed.">                sendBrandedEmail ? team.getOrg() : null,</span>
<span class="pc bpc" id="L1808" title="1 of 2 branches missed.">                sendBrandedEmail ? team : null);</span>
<span class="pc bpc" id="L1809" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1810">            LOGGER.debug(&quot;Exiting sendNotificationToInstituteAdmin&quot;);</span>
        }
<span class="fc" id="L1812">    }</span>

    /**
     * Send notification email to user that institute administrator has activate the account
     *
     * @param requestContext the request context
     * @param activatedUser  activated user
     * @param team           team object
     * @param instituteAdmin institute administrator
     * @throws MailException
     */
    public void notifyAccountActivationToUser(PKBPerson activatedUser, Team team, PKBPerson verifier)
            throws MailException {
<span class="pc bpc" id="L1825" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1826">            LOGGER.debug(&quot;Enter notifyAccountActivationToUser&quot;);</span>
        }
<span class="fc" id="L1828">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1829">        addNameDetails(activatedUser, properties);</span>
<span class="fc" id="L1830">        properties.put(PKBConstants.USER_TYPE, activatedUser.getUserType().toString().toLowerCase());</span>
<span class="fc" id="L1831">        addAdminNameDetails(verifier, properties);</span>
<span class="fc" id="L1832">        addTeamDetails(team, properties);</span>

<span class="fc" id="L1834">        emailManager.sendMessage(Message.ACCOUNT_ACTIVATION_NOTIFICATION, verifier,</span>
<span class="fc" id="L1835">                formatter.getPrimaryAndSecondaryContacts(activatedUser, new NoConsentsRequired()), activatedUser,</span>
<span class="fc" id="L1836">                properties, activatedUser.getLocale(), null, verifier.getId().toString(), team.getOrg(), team);</span>

<span class="pc bpc" id="L1838" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1839">            LOGGER.debug(&quot;Exiting notifyAccountActivationToUser&quot;);</span>
        }
<span class="fc" id="L1841">    }</span>

    /**
     * Send email to user confirm the new contact added
     */
    public void sendEmailToConfirmNewContact(PersonContact contact) throws MailException {
<span class="pc bpc" id="L1847" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1848">            LOGGER.debug(&quot;Enter sendEmailToConfirmNewContact&quot;);</span>
        }
<span class="fc" id="L1850">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1851">        PKBPerson person = contact.getPerson();</span>
<span class="fc" id="L1852">        addNameDetails(person, properties);</span>
<span class="fc" id="L1853">        properties.put(PKBConstants.CONTACT_PUBLIC_ID, contact.getPublicId());</span>
<span class="fc" id="L1854">        properties.put(PKBConstants.USER_TYPE, person.getUserType().toString().toUpperCase());</span>
<span class="fc" id="L1855">        properties.put(PKBConstants.NEW_CONTACT_VALUE, contact.getContactIfEmail().map(Email::address).getOrNull());</span>

<span class="fc" id="L1857">        var toAddress = formatter.getContact(person.getFirstName(), person.getLastName(),</span>
<span class="fc" id="L1858">                contact.getContactIfEmail().getOrNull());</span>
<span class="fc" id="L1859">        emailManager.sendSystemMessage(Message.CONFIRM_NEW_CONTACT, null, toAddress.getOrNull(),</span>
<span class="fc" id="L1860">                person, properties, person.getLocale(), null, null, null);</span>

<span class="pc bpc" id="L1862" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1863">            LOGGER.debug(&quot;Exiting sendEmailToConfirmNewContact&quot;);</span>
        }
<span class="fc" id="L1865">    }</span>

    /**
     * Notify patient that a clinician has created an account for them (all set up,
     * with temporary password).
     */
    public void notifyPrimaryContactChange(PersonContact oldPrimaryContact, PersonContact newPrimaryContact,
                                           PKBPerson actor, Optional&lt;Long&gt; teamId)
            throws MailException {
<span class="pc bpc" id="L1874" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1875">            LOGGER.debug(&quot;Enter notifyPrimaryContactChange&quot;);</span>
        }

<span class="fc" id="L1878">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1879">        PKBPerson person = oldPrimaryContact.getPerson();</span>
<span class="fc" id="L1880">        properties.put(PKBConstants.FIRST_NAME, person.getFirstName());</span>
<span class="fc" id="L1881">        properties.put(PKBConstants.OLD_CONTACT_VALUE, oldPrimaryContact.getContactIfEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L1882">        properties.put(PKBConstants.NEW_CONTACT_VALUE, newPrimaryContact.getContactIfEmail().map(Email::address).getOrNull());</span>
<span class="pc bpc" id="L1883" title="2 of 4 branches missed.">        boolean sendBrandedEmail = actor == null ? false : (!actor.isPatient());</span>
<span class="fc" id="L1884">        Team team = getTeam(teamId);</span>

        // Send notification to new primary contact
<span class="fc" id="L1887">        var toAddress = formatter.getContact(person.getFirstName(), person.getLastName(),</span>
<span class="fc" id="L1888">                newPrimaryContact.getContactIfEmail().getOrNull());</span>
<span class="fc" id="L1889">        emailManager.sendMessage(Message.PRIMARY_CONTACT_CHANGE, null, toAddress.getOrNull(), newPrimaryContact.getPerson(), properties,</span>
<span class="pc bpc" id="L1890" title="3 of 6 branches missed.">                person.getLocale(), null, actor != null ? actor.getId().toString() : null, sendBrandedEmail ? getOrg(team) : null, sendBrandedEmail ? team : null);</span>

        // Send notification to old primary contact
<span class="fc" id="L1893">        toAddress = formatter.getContact(person.getFirstName(), person.getLastName(),</span>
<span class="fc" id="L1894">                oldPrimaryContact.getContactIfEmail().getOrNull());</span>
<span class="fc" id="L1895">        emailManager.sendMessage(Message.PRIMARY_CONTACT_CHANGE, null, toAddress.getOrNull(), oldPrimaryContact.getPerson(), properties,</span>
<span class="pc bpc" id="L1896" title="3 of 6 branches missed.">                person.getLocale(), null, actor != null ? actor.getId().toString() : null, sendBrandedEmail ? getOrg(team) : null, sendBrandedEmail ? team : null);</span>

<span class="pc bpc" id="L1898" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1899">            LOGGER.debug(&quot;Exiting notifyPrimaryContactChange&quot;);</span>
        }
<span class="fc" id="L1901">    }</span>

    /**
     * @param oldPrimaryContact {@link PersonContact}
     * @param newPrimaryContact {@link PersonContact}
     * @param actor             {@link PKBPerson}
     * @param carer             {@link PKBPerson}
     */
    public void notifyCarerOfPrimaryContactChange(PersonContact oldPrimaryContact, PersonContact newPrimaryContact,
                                                  PKBPerson actor, PKBPerson carer, Optional&lt;Long&gt; teamId) {
<span class="pc bpc" id="L1911" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1912">            LOGGER.debug(&quot;Enter notifyCarerOfPrimaryContactChange&quot;);</span>
        }

        try {
<span class="fc" id="L1916">            Optional&lt;AddressInfo&gt; addressInfoOpt = getPrimaryContactOnly(carer);</span>
<span class="pc bpc" id="L1917" title="1 of 2 branches missed.">            if (addressInfoOpt.isPresent()) {</span>

<span class="fc" id="L1919">                Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1920">                PKBPerson patient = oldPrimaryContact.getPerson();</span>
<span class="fc" id="L1921">                addPatientAndActorNameDetails(patient, actor, properties);</span>
<span class="fc" id="L1922">                properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="fc" id="L1923">                properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="fc" id="L1924">                properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="fc" id="L1925">                properties.put(PKBConstants.ORGANIZATION_NAME, StringUtils.defaultString(actor.getOrganizationName()));</span>
<span class="fc" id="L1926">                properties.put(PKBConstants.OLD_CONTACT_VALUE, oldPrimaryContact.getContactIfEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L1927">                properties.put(PKBConstants.NEW_CONTACT_VALUE, newPrimaryContact.getContactIfEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L1928">                properties.put(PKBConstants.LOGIN_EMAIL, addressInfoOpt.get().getPrimaryAddress().getAddress());</span>
<span class="fc" id="L1929">                properties.put(PKBConstants.CONTEXT_USER_ID, patient.getId());</span>
<span class="pc bpc" id="L1930" title="1 of 2 branches missed.">                boolean sendBrandedEmail = !actor.isPatient();</span>
<span class="fc" id="L1931">                Team team = getTeam(teamId);</span>

<span class="fc" id="L1933">                emailManager.sendMessage(Message.PRIMARY_CONTACT_CHANGE_CARER_NOTIFICATION, actor,</span>
<span class="fc" id="L1934">                        addressInfoOpt.get(), carer, properties, carer.getLocale(), null,</span>
<span class="pc bpc" id="L1935" title="2 of 4 branches missed.">                        actor.getId().toString(), sendBrandedEmail ? getOrg(team) : null, sendBrandedEmail ? team : null);</span>
            }
<span class="nc" id="L1937">        } catch (MailException e) {</span>
<span class="nc" id="L1938">            throw new RuntimeException(e);</span>
<span class="fc" id="L1939">        }</span>

<span class="pc bpc" id="L1941" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1942">            LOGGER.debug(&quot;Exiting notifyCarerOfPrimaryContactChange&quot;);</span>
        }
<span class="fc" id="L1944">    }</span>

    /**
     * Send invitation to patient
     *
     * @param requestContext           the request context
     * @param inviterUser              {@link PKBPerson}
     * @param invitation               {@link PKBInvitation}
     * @param patient                  {@link PKBPerson}
     * @param invitePatientAsCaregiver true if the invited patient should be a caregiver
     */
    public void sendInvitePatientMessage(EHRRequestContext requestContext, PKBPerson inviterUser,
                                         PKBInvitation invitation, PKBPerson patient, boolean invitePatientAsCaregiver) {
<span class="pc bpc" id="L1957" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L1958">            LOGGER.debug(&quot;Enter sendInvitePatientMessage&quot;);</span>
        }
        try {
<span class="fc" id="L1961">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L1962">            String content = invitation.getInvitationDetail().getContent();</span>
<span class="pc bpc" id="L1963" title="1 of 2 branches missed.">            properties.put(PKBConstants.MESSAGE, content == null ? &quot;&quot; : content);</span>
<span class="fc" id="L1964">            properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L1965">            properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L1966">            properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L1967">            properties.put(PKBConstants.SENDER_TITLE, inviterUser.getTitle());</span>
<span class="fc" id="L1968">            properties.put(PKBConstants.SENDER_FIRST_NAME, inviterUser.getFirstName());</span>
<span class="fc" id="L1969">            properties.put(PKBConstants.SENDER_LAST_NAME, inviterUser.getLastName());</span>
<span class="fc" id="L1970">            properties.put(PKBConstants.INVITATION_ID, invitation.getPublicId().toString());</span>
<span class="fc" id="L1971">            properties.put(PKBConstants.TEMP_PASSWORD, patient.getPassword());</span>
<span class="fc" id="L1972">            properties.put(PKBConstants.USER_ID, patient.getId());</span>
<span class="fc bfc" id="L1973" title="All 2 branches covered.">            if (patient.getStatus() == UserStatus.EMAIL_CONFIRMED) {</span>
<span class="fc" id="L1974">                properties.put(PKBConstants.IS_INVITED, 1);</span>
            } else {
<span class="fc" id="L1976">                properties.put(PKBConstants.IS_INVITED, 0);</span>
            }

<span class="fc" id="L1979">            Team team = null;</span>
            // by default send empty string for institute code
<span class="fc" id="L1981">            properties.put(PKBConstants.INSTITUTE_CODE, &quot;&quot;);</span>
<span class="fc bfc" id="L1982" title="All 2 branches covered.">            if (!inviterUser.isPatient()) {</span>

<span class="fc" id="L1984">                List&lt;Team&gt; list = teamUserManager.getUserTeams(requestContext, inviterUser.getId(), true/*activeOnly*/);</span>
<span class="pc bpc" id="L1985" title="1 of 2 branches missed.">                if (!list.isEmpty()) {</span>
<span class="fc" id="L1986">                    team = list.get(0);</span>
<span class="pc bpc" id="L1987" title="2 of 4 branches missed.">                    if (team != null &amp;&amp; inviterUser.isPro()) {</span>
<span class="fc" id="L1988">                           properties.put(PKBConstants.INSTITUTE_CODE, team.getCode());</span>
                    }
                }
            }

<span class="fc bfc" id="L1993" title="All 2 branches covered.">            if (invitePatientAsCaregiver) {</span>
<span class="fc" id="L1994">                properties.put(PKBConstants.INHIBIT_CARER_FOOTER, true);</span>
<span class="fc" id="L1995">                emailManager.sendMessage(Message.INVITE_CARER, inviterUser,</span>
<span class="fc" id="L1996">                        formatter.getPrimaryAndSecondaryContacts(patient, new NoConsentsRequired()), patient, properties,</span>
<span class="fc" id="L1997">                        patient.getLocale(), SENT_INVITATION, inviterUser.getId().toString(), getOrg(team), team);</span>
            } else {
<span class="fc" id="L1999">                emailManager.sendMessage(Message.ASK_FOR_ACCESS, inviterUser,</span>
<span class="fc" id="L2000">                        formatter.getPrimaryAndSecondaryContacts(patient, new NoConsentsRequired()), patient, properties,</span>
<span class="fc" id="L2001">                        patient.getLocale(), null, inviterUser.getId().toString(), getOrg(team), team);</span>
            }
<span class="nc" id="L2003">        } catch (MailException exception) {</span>
<span class="nc" id="L2004">            throw new PKBException(&quot;Unable to send tolven message&quot;, exception);</span>
<span class="fc" id="L2005">        }</span>
<span class="pc bpc" id="L2006" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L2007">            LOGGER.debug(&quot;Exiting sendInvitePatientMessage&quot;);</span>
        }
<span class="fc" id="L2009">    }</span>

    /**
     * Send the registration invite to employee
     *
     * @param requestContext the request context
     * @param employee       {@link PKBPerson} object
     * @param inviterUser    {@link PKBPerson}
     * @param invitation     {@link PKBInvitation}
     * @throws MailException
     */
    public void inviteEmployee(PKBPerson employee, PKBPerson inviterUser, PKBInvitation invitation)
            throws MailException {
<span class="pc bpc" id="L2022" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L2023">            LOGGER.debug(&quot;Enter inviteEmployee&quot;);</span>
        }
        try {
<span class="fc" id="L2026">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2027">            String content = invitation.getInvitationDetail().getContent();</span>
<span class="pc bpc" id="L2028" title="1 of 2 branches missed.">            properties.put(PKBConstants.MESSAGE, content == null ? &quot;&quot; : content);</span>
<span class="fc" id="L2029">            addNameDetails(employee, properties);</span>
<span class="fc" id="L2030">            properties.put(PKBConstants.SENDER_TITLE, inviterUser.getTitle());</span>
<span class="fc" id="L2031">            properties.put(PKBConstants.SENDER_FIRST_NAME, inviterUser.getFirstName());</span>
<span class="fc" id="L2032">            properties.put(PKBConstants.SENDER_LAST_NAME, inviterUser.getLastName());</span>
<span class="fc" id="L2033">            properties.put(PKBConstants.TEMP_PASSWORD, employee.getPassword());</span>
<span class="fc" id="L2034">            properties.put(PKBConstants.USER_ID, employee.getId());</span>

<span class="fc" id="L2036">            emailManager.sendMessage(Message.INVITE_EMPLOYEE, inviterUser,</span>
<span class="fc" id="L2037">                    formatter.getPrimaryAndSecondaryContacts(employee, new NoConsentsRequired()), employee, properties,</span>
<span class="fc" id="L2038">                    inviterUser.getLocale(), SENT_INVITATION, inviterUser.getId().toString(), null, null);</span>

<span class="nc" id="L2040">        } catch (MailException exception) {</span>
<span class="nc" id="L2041">            throw new PKBException(&quot;Unable to send invitation to employee&quot;, exception);</span>
<span class="fc" id="L2042">        }</span>
<span class="pc bpc" id="L2043" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L2044">            LOGGER.debug(&quot;Exiting inviteEmployee&quot;);</span>
        }
<span class="fc" id="L2046">    }</span>

    public void sendTeamAccessNotificationToPatient(String actionText, EmailInfo emailInfo, PatientConsentBaseDTO patientConsent) {
        try {
<span class="pc bpc" id="L2050" title="1 of 2 branches missed.">            if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L2051">                LOGGER.debug(&quot;Enter sentTeamAccessNotificationToPatient&quot;);</span>
            }
<span class="fc" id="L2053">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2054">            properties.put(PKBConstants.PATIENT_TITLE, emailInfo.recipient().getTitle());</span>
<span class="fc" id="L2055">            properties.put(PKBConstants.PATIENT_FIRST_NAME, emailInfo.recipient().getFirstName());</span>
<span class="fc" id="L2056">            properties.put(PKBConstants.PATIENT_LAST_NAME, emailInfo.recipient().getLastName());</span>
<span class="fc" id="L2057">            properties.put(PKBConstants.ORGANIZATION_NAME, emailInfo.getOrgName());</span>
<span class="pc" id="L2058">            properties.put(PKBConstants.TEAM_NAME, emailInfo.team().orElseThrow(() -&gt; new IllegalStateException(&quot;Missing team needed for sendTeamAccessNotificationToPatient email&quot;)).getName());</span>
<span class="fc" id="L2059">            properties.put(PKBConstants.CONTEXT_USER_ID, emailInfo.recipient().getId());</span>
<span class="fc" id="L2060">            properties.putAll(getTranslatedPrivacyLabels(patientConsent, emailInfo.recipient().getLocale()));</span>
<span class="fc" id="L2061">            PKBPerson sender = emailInfo.sender().orElse(null);</span>
<span class="fc bfc" id="L2062" title="All 2 branches covered.">            Team team = sender == null ? null : emailInfo.team().orElse(null);</span>

<span class="pc bpc" id="L2064" title="1 of 2 branches missed.">            if (actionText.equals(ACCESS_GRANT)) {</span>
<span class="fc" id="L2065">                emailManager.sendMessage(Message.TEAM_ACCESS_GRANTED_NOTIFICATION_TO_PATIENT, sender,</span>
<span class="fc" id="L2066">                        formatter.getPrimaryAndSecondaryContacts(emailInfo.recipient(), new NoConsentsRequired()), emailInfo.recipient(),</span>
<span class="fc bfc" id="L2067" title="All 2 branches covered.">                        properties, emailInfo.recipient().getLocale(), null, sender != null ? sender.getId().toString() : null, getOrg(team), team);</span>
<span class="nc bnc" id="L2068" title="All 2 branches missed.">            } else if (actionText.equals(AccessUpdate.ACCESS_REVOKE)) {</span>
<span class="nc" id="L2069">                LOGGER.warn(&quot;Revoke notification not implemented&quot;);</span>
            }
<span class="nc" id="L2071">        } catch (MailException e) {</span>
<span class="nc" id="L2072">            throw new RuntimeException(e);</span>
        } finally {
<span class="pc bpc" id="L2074" title="1 of 2 branches missed.">            if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L2075">                LOGGER.debug(&quot;Exiting sendAccessUpdateNotificationToPatient&quot;);</span>
            }
        }
<span class="fc" id="L2078">    }</span>

    /**
     * notifies a team coordinator that a plan export has completed
     *
     * @param requestContext           the request context
     * @param coordinator              the coordinator
     * @param team                the team the coordinator belongs to
     * @param phPlanTemplate           the plan template the export applies to
     * @param planLimitExceeded        indicates whether the plan limit has been exceeded
     * @param date
     * @param inaccessiblePatientCount the number of inaccessible patients
     * @param consentRequired          specifies what level of consent is required to be able to view (or receive notifications about) the data point
     * @throws MailException
     */
    public void notifyCoordinatorPlanExportComplete(PKBPerson coordinator, Team team, PHPlanTemplate phPlanTemplate,
                                                    boolean planLimitExceeded, Instant date, long inaccessiblePatientCount,
                                                    RequiresConsent consentRequired)
            throws MailException {

<span class="fc" id="L2098">        LOGGER.debug(&quot;Enter notifyCoordinatorPlanExportComplete&quot;);</span>

<span class="fc" id="L2100">        String supportCode = null;</span>
<span class="pc bpc" id="L2101" title="1 of 2 branches missed.">        if (inaccessiblePatientCount &gt; 0) {</span>
<span class="nc" id="L2102">            supportCode = coordinator.getId() + &quot;a&quot; + SUPPORT_CODE_FORMATTER.format(date);</span>
        }

<span class="fc" id="L2105">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2106">        addAdminNameDetails(coordinator, properties);</span>
<span class="fc" id="L2107">        addTeamBasicDetails(team, properties);</span>
<span class="fc" id="L2108">        properties.put(PKBConstants.PLAN_EXPORT_DATE, DATE_FORMAT.format(date));</span>
<span class="fc" id="L2109">        properties.put(PKBConstants.PLAN_EXPORT_LIMIT, PlanExportManager.PLAN_EXPORT_LIMIT);</span>
<span class="pc bpc" id="L2110" title="1 of 2 branches missed.">        properties.put(PKBConstants.PLAN_LIMIT_EXECEEDED, planLimitExceeded ? &quot;1&quot; : &quot;0&quot;);</span>
<span class="fc" id="L2111">        properties.put(PKBConstants.PLAN_TEMPLATE_NAME, phPlanTemplate.getName());</span>
<span class="fc" id="L2112">        properties.put(PKBConstants.INACCESSIBLE_PATIENT_COUNT, inaccessiblePatientCount);</span>
<span class="fc" id="L2113">        properties.put(PKBConstants.SUPPORT_CODE, supportCode);</span>

<span class="fc" id="L2115">        emailManager.sendMessage(Message.NOTIFY_COORDINATOR_PLAN_EXPORT_COMPLETED, null,</span>
<span class="fc" id="L2116">                formatter.getPrimaryAndSecondaryContacts(coordinator, consentRequired), coordinator, properties,</span>
<span class="fc" id="L2117">                coordinator.getLocale(), EXPORTED_PLANS, coordinator.getId().toString(), team.getOrg(), team);</span>

<span class="fc" id="L2119">        LOGGER.debug(&quot;Exiting notifyCoordinatorPlanExportComplete&quot;);</span>

<span class="fc" id="L2121">    }</span>

    /**
     * notify a team coord that a bulk account creation task has completed
     *
     * @param requestContext the request context
     * @param coordinator    the coord to notify
     * @param teamName       the team name the coord belongs to
     */
    public void notifyCoordinatorBulkAccountCreationCompleted(PKBPerson coordinator, Team team, long actorId) {
<span class="fc" id="L2131">        LOGGER.debug(&quot;Enter notifyCoordinatorBulkAccountCreationComplete&quot;);</span>
<span class="fc" id="L2132">        notifyCoordinatorBulkAccountCreationResult(coordinator, team, actorId,</span>
                NOTIFY_COORDINATOR_BULK_ACCOUNT_CREATION_COMPLETED);

<span class="fc" id="L2135">        LOGGER.debug(&quot;Exiting notifyCoordinatorBulkAccountCreationComplete&quot;);</span>
<span class="fc" id="L2136">    }</span>

    /**
     * notify a team coord that a bulk account creation task failed
     *
     * @param requestContext the request context
     * @param coordinator    the team coord to notify
     * @param teamName       the team name the coord belongs to
     */
    public void notifyCoordinatorBulkAccountCreationFailed(PKBPerson coordinator, Team team, long actorId) {
<span class="nc" id="L2146">        LOGGER.debug(&quot;Enter notifyCoordinatorBulkAccountCreationFailed&quot;);</span>
<span class="nc" id="L2147">        notifyCoordinatorBulkAccountCreationResult(coordinator, team, actorId, NOTIFY_COORDINATOR_BULK_ACCOUNT_CREATION_FAILED);</span>
<span class="nc" id="L2148">        LOGGER.debug(&quot;Exiting notifyCoordinatorBulkAccountCreationFailed&quot;);</span>
<span class="nc" id="L2149">    }</span>

    /**
     * @param requestContext
     * @param coordinator
     * @param team
     * @param recordsProcessed
     * @param accountsCreated
     * @param existingCliniciansInvited
     * @param existingCliniciansReminded
     * @param existingCliniciansAlreadyLinked
     * @param existingCliniciansInvitedElsewhere
     * @param recordsRejected
     * @param recordErrors
     * @throws MailException
     */
    public void notifyCoordinatorClinicianBulkAccountCreationCompleted(PKBPerson coordinator, Team team, int recordsProcessed,
            int accountsCreated, int existingCliniciansInvited, int existingCliniciansReminded, int existingCliniciansAlreadyLinked,
            int existingCliniciansInvitedElsewhere, int recordsRejected, String recordErrors, String actorId) throws MailException {

<span class="fc" id="L2169">        LOGGER.debug(&quot;Enter notifyCoordinatorBulkAccountCreationComplete&quot;);</span>

<span class="fc" id="L2171">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2172">        addAdminNameDetails(coordinator, properties);</span>
<span class="fc" id="L2173">        properties.put(PKBConstants.TEAM_CODE, team.getCode());</span>
<span class="fc" id="L2174">        properties.put(PKBConstants.TEAM_NAME, team.getName());</span>
<span class="fc" id="L2175">        properties.put(PKBConstants.RECORDS_PROCESSED, Integer.toString(recordsProcessed));</span>
<span class="fc" id="L2176">        properties.put(PKBConstants.ACCOUNTS_CREATED, Integer.toString(accountsCreated));</span>
<span class="fc" id="L2177">        properties.put(PKBConstants.EXISTING_CLINICIANS_INVITED, Integer.toString(existingCliniciansInvited));</span>
<span class="fc" id="L2178">        properties.put(PKBConstants.EXISTING_CLINICIANS_REMINDED, Integer.toString(existingCliniciansReminded));</span>
<span class="fc" id="L2179">        properties.put(PKBConstants.EXISTING_CLINICIANS_ALREADY_LINKED, Integer.toString(existingCliniciansAlreadyLinked));</span>
<span class="fc" id="L2180">        properties.put(PKBConstants.EXISTING_CLINICIANS_INVITED_ELSEWHERE, Integer.toString(existingCliniciansInvitedElsewhere));</span>
<span class="fc" id="L2181">        properties.put(PKBConstants.RECORDS_REJECTED, recordsRejected);</span>
<span class="fc" id="L2182">        properties.put(PKBConstants.RECORD_ERRORS_PLAIN, recordErrors);</span>
<span class="fc" id="L2183">        properties.put(PKBConstants.RECORD_ERRORS_HTML, LINUX_NEWLINE_PATTERN.matcher(recordErrors).replaceAll(&quot;&lt;br/&gt;&quot;));</span>

<span class="fc" id="L2185">        emailManager.sendMessage(Message.NOTIFY_COORDINATOR_BULK_CLINICIAN_ACCOUNT_CREATION_COMPLETED, null,</span>
<span class="fc" id="L2186">                formatter.getPrimaryAndSecondaryContacts(coordinator, new NoConsentsRequired()), coordinator, properties,</span>
<span class="fc" id="L2187">                coordinator.getLocale(), CREATED_ACCOUNT, actorId, team.getOrg(), team);</span>

<span class="fc" id="L2189">        LOGGER.debug(&quot;Exiting notifyCoordinatorBulkAccountCreationComplete&quot;);</span>
<span class="fc" id="L2190">    }</span>

    /**
     * notifiy the coordinator that there were no plans to export
     *
     * @param requestContext           the request context
     * @param coordinator              the team coord to notify
     * @param team                the team the coord belongs to
     * @param phPlanTemplate           the template that has no plans to explrt
     * @param date
     * @param inaccessiblePatientCount
     * @throws MailException
     */
    public void notifyCoordinatorNoPlansToExport(PKBPerson coordinator, Team team, PHPlanTemplate phPlanTemplate,
                                                 Instant date, long inaccessiblePatientCount) throws MailException {

<span class="nc" id="L2206">        LOGGER.debug(&quot;Enter notifyCoordinatorNoPlansToExport&quot;);</span>

<span class="nc" id="L2208">        String supportCode = null;</span>
<span class="nc bnc" id="L2209" title="All 2 branches missed.">        if (inaccessiblePatientCount &gt; 0) {</span>
<span class="nc" id="L2210">            supportCode = coordinator.getId() + &quot;a&quot; + SUPPORT_CODE_FORMATTER.format(date);</span>
        }

<span class="nc" id="L2213">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="nc" id="L2214">        addAdminNameDetails(coordinator, properties);</span>
<span class="nc" id="L2215">        addTeamBasicDetails(team, properties);</span>
<span class="nc" id="L2216">        properties.put(PKBConstants.PLAN_EXPORT_DATE, DATE_FORMAT.format(date));</span>
<span class="nc" id="L2217">        properties.put(PKBConstants.PLAN_EXPORT_LIMIT, PlanExportManager.PLAN_EXPORT_LIMIT);</span>
<span class="nc" id="L2218">        properties.put(PKBConstants.NO_PLANS_TO_EXPORT, &quot;1&quot;);</span>
<span class="nc" id="L2219">        properties.put(PKBConstants.PLAN_TEMPLATE_NAME, phPlanTemplate.getName());</span>
<span class="nc" id="L2220">        properties.put(PKBConstants.PLAN_LIMIT_EXECEEDED, &quot;0&quot;);</span>
<span class="nc" id="L2221">        properties.put(PKBConstants.INACCESSIBLE_PATIENT_COUNT, inaccessiblePatientCount);</span>
<span class="nc" id="L2222">        properties.put(PKBConstants.SUPPORT_CODE, supportCode);</span>

<span class="nc" id="L2224">        emailManager.sendMessage(Message.NOTIFY_COORDINATOR_PLAN_EXPORT_COMPLETED, null,</span>
<span class="nc" id="L2225">                formatter.getPrimaryAndSecondaryContacts(coordinator, new NoConsentsRequired()), coordinator, properties,</span>
<span class="nc" id="L2226">                coordinator.getLocale(), EXPORTED_PLANS, coordinator.getId().toString(), team.getOrg(), team);</span>

<span class="nc" id="L2228">        LOGGER.debug(&quot;Exiting notifyCoordinatorNoPlansToExport&quot;);</span>

<span class="nc" id="L2230">    }</span>

    /**
     * notifies a clinician that a plan has been exported
     *
     * @param requestContext    the request context
     * @param coordinator
     * @param clinician         the clinician to notify
     * @param team              the team
     * @param phPlanTemplate    the plan template exported
     * @param planLimitExceeded indicates whether the plan limit has been exceeded
     * @param date
     * @param consentRequired   specifies what level of consent is required to be able to view (or receive notifications about) the data point
     * @throws MailException
     */
    public void notifyClinicianOfPlanExported(PKBPerson coordinator, PKBPerson clinician, Team team,
                                              PHPlanTemplate phPlanTemplate, Instant date, RequiresConsent consentRequired)
            throws MailException {

<span class="fc" id="L2249">        LOGGER.debug(&quot;Enter notifyCliniicanOfPlanExported&quot;);</span>

<span class="fc" id="L2251">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2252">        addAdminNameDetails(coordinator, properties);</span>
<span class="fc" id="L2253">        addClinicianNameDetails(clinician, properties);</span>
<span class="fc" id="L2254">        addTeamBasicDetails(team, properties);</span>
<span class="fc" id="L2255">        properties.put(PKBConstants.PLAN_EXPORT_DATE, DATE_FORMAT.format(date));</span>
<span class="fc" id="L2256">        properties.put(PKBConstants.PLAN_TEMPLATE_NAME, phPlanTemplate.getName());</span>

<span class="fc" id="L2258">        emailManager.sendMessage(Message.NOTIFY_CLINICIAN_PLAN_EXPORTED, null,</span>
<span class="fc" id="L2259">                formatter.getPrimaryAndSecondaryContacts(clinician, consentRequired), clinician, properties,</span>
<span class="fc" id="L2260">                clinician.getLocale(), EXPORTED_PLANS, coordinator.getId().toString(), team.getOrg(), team);</span>

<span class="fc" id="L2262">        LOGGER.debug(&quot;Exiting notifyCliniicanOfPlanExported&quot;);</span>
<span class="fc" id="L2263">    }</span>

    /**
     * @param requestContext
     * @param orgCoord
     * @param orgNetwork
     * @throws MailException
     */
    public void notifyOrgCoordOfNewOrgNetwork(PKBPerson orgCoord, OrgNetworkExisting orgNetwork, String actorId)
            throws MailException {

<span class="fc" id="L2274">        LOGGER.debug(&quot;Enter notifyOrgCoordOfNewOrgNetwork&quot;);</span>

<span class="fc" id="L2276">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2277">        addAdminNameDetails(orgCoord, properties);</span>
<span class="fc" id="L2278">        properties.put(PKBConstants.ORGANIZATION_NAME, orgNetwork.getLeadingOrg().getName());</span>
<span class="fc" id="L2279">        properties.put(PKBConstants.ORG_NETWORK_NAME, orgNetwork.getName());</span>

<span class="fc" id="L2281">        emailManager.sendMessage(Message.ORG_NETWORK_CREATED, null /* fromPerson */,</span>
<span class="fc" id="L2282">                formatter.getPrimaryAndSecondaryContacts(orgCoord, new NoConsentsRequired()), orgCoord, properties,</span>
<span class="fc" id="L2283">                orgCoord.getLocale(), null, actorId, null, null);</span>

<span class="fc" id="L2285">        LOGGER.debug(&quot;Exiting notifyOrgCoordOfNewOrgNetwork&quot;);</span>
<span class="fc" id="L2286">    }</span>

    public void notifyOrgCoordOfInvitationToOrgNetwork(PKBPerson orgCoord, OrgNetworkExisting orgNetwork, String actorId)
            throws MailException {

<span class="fc" id="L2291">        LOGGER.debug(&quot;Enter notifyOrgCoordOfInvitationToOrgNetwork&quot;);</span>

<span class="fc" id="L2293">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2294">        addAdminNameDetails(orgCoord, properties);</span>
<span class="fc" id="L2295">        properties.put(PKBConstants.ORG_NETWORK_NAME, orgNetwork.getName());</span>
<span class="fc" id="L2296">        properties.put(PKBConstants.ORGANIZATION_NAME, orgNetwork.getLeadingOrg().getName());</span>

<span class="fc" id="L2298">        emailManager.sendMessage(Message.ORG_INVITED_TO_NETWORK, null /* fromPerson */,</span>
<span class="fc" id="L2299">                formatter.getPrimaryAndSecondaryContacts(orgCoord, new NoConsentsRequired()), orgCoord, properties,</span>
<span class="fc" id="L2300">                orgCoord.getLocale(), null, actorId, null, null);</span>

<span class="fc" id="L2302">        LOGGER.debug(&quot;Exiting notifyOrgCoordOfInvitationToOrgNetwork&quot;);</span>
<span class="fc" id="L2303">    }</span>

    /**
     * @param requestContext
     * @param leadingOrgCoord
     * @param approvingOrg
     * @param orgNetwork
     * @throws MailException
     */
    public void notifyOrgCoordOfOrgNetworkApproval(PKBPerson leadingOrgCoord, Org approvingOrg, Team team,
                                                   OrgNetwork orgNetwork, long actorId) throws MailException {

<span class="fc" id="L2315">        LOGGER.debug(&quot;Enter notifyOrgCoordOfOrgNetworkApproval&quot;);</span>

<span class="fc" id="L2317">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2318">        addAdminNameDetails(leadingOrgCoord, properties);</span>
<span class="fc" id="L2319">        properties.put(PKBConstants.ORG_NETWORK_NAME, orgNetwork.getName());</span>
<span class="fc" id="L2320">        properties.put(PKBConstants.ORGANIZATION_NAME, approvingOrg.getName());</span>

<span class="fc" id="L2322">        emailManager.sendMessage(Message.ORG_APPROVED_NETWORK, null /* fromPerson */,</span>
<span class="fc" id="L2323">                formatter.getPrimaryAndSecondaryContacts(leadingOrgCoord, new NoConsentsRequired()), leadingOrgCoord,</span>
<span class="fc" id="L2324">                properties, leadingOrgCoord.getLocale(), null, String.valueOf(actorId), approvingOrg, team);</span>

<span class="fc" id="L2326">        LOGGER.debug(&quot;Exiting notifyOrgCoordOfOrgNetworkApproval&quot;);</span>
<span class="fc" id="L2327">    }</span>

    /**
     * @param requestContext
     * @param orgCoord
     * @param activatedOrg
     * @param orgNetwork
     * @throws MailException
     */
    public void notifyOrgCoordOfOrgNetworkActivation(PKBPerson orgCoord, OrgNetworkMemberView activatedOrg,
                                                     OrgNetwork orgNetwork, long actorId) throws MailException {

<span class="fc" id="L2339">        LOGGER.debug(&quot;Enter notifyOrgCoordOfOrgNetworkActivation&quot;);</span>

<span class="fc" id="L2341">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2342">        addAdminNameDetails(orgCoord, properties);</span>
<span class="fc" id="L2343">        properties.put(PKBConstants.LOGIN_EMAIL, orgCoord.findEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L2344">        properties.put(PKBConstants.ORG_NETWORK_NAME, orgNetwork.getName());</span>
<span class="fc" id="L2345">        properties.put(PKBConstants.ORGANIZATION_NAME, activatedOrg.getOrgName());</span>

<span class="fc" id="L2347">        emailManager.sendMessage(Message.ORG_ACTIVATED_IN_NETWORK, null /* fromPerson */,</span>
<span class="fc" id="L2348">                formatter.getPrimaryAndSecondaryContacts(orgCoord, new NoConsentsRequired()), orgCoord, properties,</span>
<span class="fc" id="L2349">                orgCoord.getLocale(), null, String.valueOf(actorId), teamManager.getOrg(activatedOrg.getOrgId()).orElse(null), null);</span>

<span class="fc" id="L2351">        LOGGER.debug(&quot;Exiting notifyOrgCoordOfOrgNetworkActivation&quot;);</span>
<span class="fc" id="L2352">    }</span>

    /**
     * @param requestContext
     * @param orgCoord
     * @param orgNetwork
     * @param rejectingOrg
     * @throws MailException
     */
    public void notifyLeaderOrgCoordOfInvitationRejection(PKBPerson orgCoord, OrgNetwork orgNetwork,
                                                          String rejectingOrgName, long actorId) throws MailException {

<span class="fc" id="L2364">        LOGGER.debug(&quot;Enter notifyLeaderOrgCoordOfInvitationRejection&quot;);</span>

<span class="fc" id="L2366">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2367">        addAdminNameDetails(orgCoord, properties);</span>
<span class="fc" id="L2368">        properties.put(PKBConstants.LOGIN_EMAIL, orgCoord.findEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L2369">        properties.put(PKBConstants.ORG_NETWORK_NAME, orgNetwork.getName());</span>
<span class="fc" id="L2370">        properties.put(PKBConstants.ORGANIZATION_NAME, rejectingOrgName);</span>

<span class="fc" id="L2372">        emailManager.sendMessage(Message.ORG_REJECTED_NETWORK, null /* fromPerson */,</span>
<span class="fc" id="L2373">                formatter.getPrimaryAndSecondaryContacts(orgCoord, new NoConsentsRequired()), orgCoord, properties,</span>
<span class="fc" id="L2374">                orgCoord.getLocale(), null, String.valueOf(actorId), null, null);</span>

<span class="fc" id="L2376">        LOGGER.debug(&quot;Exiting notifyLeaderOrgCoordOfInvitationRejection&quot;);</span>
<span class="fc" id="L2377">    }</span>

    /**
     * @param context The EHRRequest context
     * @param actor   The person who changed privacy level on patient's account.
     * @param patient The owner of the account.
     * @param org     The org which is affected by the change.
     */
    public void sendChangePrivacyLevelNotificationToPatient(EHRRequestContext context, PKBPerson actor, PKBPerson patient,
                                                            Org org, Team team) {
<span class="fc" id="L2387">        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L2388">        properties.put(PKBConstants.ORGANIZATION_NAME, org.getName());</span>
<span class="fc" id="L2389">        sendChangePrivacyLevelNotificationToPatient(context, actor, patient, properties, org, team);</span>
<span class="fc" id="L2390">    }</span>

    /**
     * @param context    The EHRRequest context
     * @param actor      The person who changed privacy level on patient's account.
     * @param patient    The owner of the account.
     * @param individual The person who is affected by the change.
     */
    public void sendChangePrivacyLevelNotificationToPatient(EHRRequestContext context, PKBPerson actor, PKBPerson patient,
                                                            PKBPerson individual) {

<span class="fc" id="L2401">        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L2402">        properties.put(PKBConstants.ORGANIZATION_NAME, &quot;&quot;);</span>
<span class="fc" id="L2403">        properties.put(PKBConstants.INDIVIDUAL_TITLE, individual.getTitle());</span>
<span class="fc" id="L2404">        properties.put(PKBConstants.INDIVIDUAL_FIRST_NAME, individual.getFirstName());</span>
<span class="fc" id="L2405">        properties.put(PKBConstants.INDIVIDUAL_LAST_NAME, individual.getLastName());</span>
<span class="fc" id="L2406">        sendChangePrivacyLevelNotificationToPatient(context, actor, patient, properties, null, null);</span>
<span class="fc" id="L2407">    }</span>

    private void sendChangePrivacyLevelNotificationToPatient(EHRRequestContext context, PKBPerson actor, PKBPerson patient,
                                                             Map&lt;String, Object&gt; properties, Org org, Team team) {
        try {
<span class="pc bpc" id="L2412" title="1 of 2 branches missed.">            if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L2413">                LOGGER.debug(&quot;Enter sendChangePrivacyLevelNotificationToPatient&quot;);</span>
            }
<span class="fc" id="L2415">            addPatientAndActorNameDetails(patient, actor, properties);</span>
<span class="fc" id="L2416">            addOrgNameIfActorNotPatientOrIndividualPro(context, actor, properties);</span>
<span class="fc" id="L2417">            properties.putAll(paramsFactory.createWithSiteProps());</span>
<span class="fc bfc" id="L2418" title="All 2 branches covered.">            boolean sendBrandedEmail = !actor.isPatient();</span>

<span class="fc" id="L2420">            Optional&lt;AddressInfo&gt; addressInfoOpt = getPrimaryContactOnly(patient);</span>
<span class="pc bpc" id="L2421" title="1 of 2 branches missed.">            if (addressInfoOpt.isPresent()) {</span>
                //Russell: I figure if someone changes privacy level, that isn't itself related to the privacy level and is something you want people to be notified about:
<span class="fc" id="L2423">                emailManager.sendMessage(Message.NOTIFY_PATIENT_PRIVACY_LEVEL_CHANGED, actor, addressInfoOpt.get(), patient, properties,</span>
<span class="fc bfc" id="L2424" title="All 4 branches covered.">                        patient.getLocale(), null, actor.getId().toString(), sendBrandedEmail ? org : null, sendBrandedEmail ? team : null);</span>
            }

<span class="nc" id="L2427">        } catch (MailException e) {</span>
<span class="nc" id="L2428">            throw new RuntimeException(e.getMessage(), e);</span>
<span class="fc" id="L2429">        }</span>

<span class="pc bpc" id="L2431" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L2432">            LOGGER.debug(&quot;Exiting sendAccessUpdateNotificationToPatient&quot;);</span>
        }
<span class="fc" id="L2434">    }</span>

    public void notifyChangeOfPrivacy(@NotNull PKBPerson patient, @NotNull PKBPerson actor, @NotNull IBaseDTO dto,
                                      @NotNull MenuDataType type, @NotNull PrivacyFlag flag) {
<span class="fc" id="L2438">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2439">        addNameDetails(patient, properties);</span>
<span class="fc" id="L2440">        properties.put(PKBConstants.ACTOR_TITLE, actor.getTitle());</span>
<span class="fc" id="L2441">        properties.put(PKBConstants.ACTOR_FIRST_NAME, actor.getFirstName());</span>
<span class="fc" id="L2442">        properties.put(PKBConstants.ACTOR_LAST_NAME, actor.getLastName());</span>
<span class="fc" id="L2443">        properties.put(PKBConstants.ACTOR_ORGANIZATION_NAME, actor.getOrganizationName());</span>
<span class="fc" id="L2444">        properties.put(PKBConstants.LOGIN_EMAIL, patient.findEmail().map(Email::address).getOrNull());</span>
<span class="fc" id="L2445">        properties.put(PKBConstants.CONTEXT_USER_ID, patient.getId());</span>
<span class="fc" id="L2446">        properties.put(PKBConstants.DATA_POINT, EmailUtil.getTypeString(type, dto));</span>
<span class="fc" id="L2447">        properties.put(PKBConstants.USER_QUERY_PATH, EmailUtil.getTypeUrl(type, dto));</span>
<span class="fc" id="L2448">        properties.put(PKBConstants.USER_QUERY_PARAMS, EmailUtil.getTypeUrlParams(type, dto));</span>
        try {
<span class="fc" id="L2450">            emailManager.sendMessage(PRIVACY_LABEL_NOTIFICATION_TO_PATIENT, actor, getCarersWithConsent(patient, dto, flag),</span>
<span class="fc" id="L2451">                    patient, properties, patient.getLocale(), null, actor.getId().toString(), null, null);</span>
<span class="nc" id="L2452">        } catch (MailException e) {</span>
<span class="nc" id="L2453">            throw new RuntimeException(e.getMessage(), e);</span>
<span class="fc" id="L2454">        }</span>
<span class="fc" id="L2455">    }</span>

    private AddressInfo getCarersWithConsent(PKBPerson patient, IBaseDTO dto, PrivacyFlag flag) {
<span class="fc" id="L2458">        AddressInfo info = formatter.getConfirmedOnlyPrimaryAndSecondaryContacts(patient, dto);</span>
<span class="fc" id="L2459">        return new AddressInfo(info.getPrimaryAddress(),</span>
<span class="fc" id="L2460">                Stream.ofAll(info.getSecondaryAddressesAndPersons()</span>
<span class="fc" id="L2461">                                .entrySet())</span>
<span class="fc" id="L2462">                        .filter(entry -&gt; hasConsent(</span>
<span class="fc" id="L2463">                                patientConsentManager.findPatientConsent(patient.getId(), entry.getValue().getId(), AccessingEntityType.CARER).orElse(null), flag))</span>
<span class="fc" id="L2464">                        .toMap(Map.Entry::getKey, Map.Entry::getValue).toJavaMap());</span>
    }

    private boolean hasConsent(PatientConsentDTO consent, PrivacyFlag flag) {
<span class="pc bpc" id="L2468" title="1 of 2 branches missed.">        if (consent == null) {</span>
<span class="nc" id="L2469">            return false;</span>
        }
<span class="fc" id="L2471">        return consent.hasConsent(flag);</span>
    }

    public void sendNotificationToCarersOfPatient(
            PKBPerson actor,
            PKBPerson patient,
            Consumer&lt;PKBPerson&gt; notificationFunction) {
<span class="fc" id="L2478">        patientConsentManager</span>
<span class="fc" id="L2479">                .getCaregivers(patient.getId())</span>
<span class="fc" id="L2480">                .stream()</span>
<span class="pc bpc" id="L2481" title="1 of 2 branches missed.">                .filter(carerPerson -&gt; !carerPerson.getId().equals(actor.getId()))</span>
<span class="fc" id="L2482">                .forEach(notificationFunction);</span>
<span class="fc" id="L2483">    }</span>

    /**
     * @param context    The EHRRequestContext
     * @param actor      The person who changed privacy level on patient's account.
     * @param patient    The owner of the account.
     * @param carer      The Carer of the patient
     * @param individual The person who is affected by the change.
     */
    public void sendChangePrivacyLevelNotificationToCarer(EHRRequestContext context, PKBPerson actor, PKBPerson patient,
                                                          PKBPerson carer, PKBPerson individual) {
<span class="fc" id="L2494">        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L2495">        properties.put(PKBConstants.INDIVIDUAL_TITLE, individual.getTitle());</span>
<span class="fc" id="L2496">        properties.put(PKBConstants.INDIVIDUAL_FIRST_NAME, individual.getFirstName());</span>
<span class="fc" id="L2497">        properties.put(PKBConstants.INDIVIDUAL_LAST_NAME, individual.getLastName());</span>
<span class="fc" id="L2498">        properties.put(PKBConstants.ORGANIZATION_NAME, &quot;&quot;);</span>
<span class="fc" id="L2499">        sendChangePrivacyLevelNotificationToCarer(context, actor, patient, carer, properties);</span>
<span class="fc" id="L2500">    }</span>

    /**
     * @param context The EHRRequestContext
     * @param actor   The person who changed privacy level on patient's account.
     * @param patient The owner of the account.
     * @param carer   The Carer of the patient
     * @param org     The org which is affected by the change.
     */
    public void sendChangePrivacyLevelNotificationToCarer(EHRRequestContext context, PKBPerson actor, PKBPerson patient,
                                                          PKBPerson carer, Org org) {
<span class="fc" id="L2511">        Map&lt;String, Object&gt; properties = new HashMap&lt;&gt;();</span>
<span class="fc" id="L2512">        properties.put(PKBConstants.ORGANIZATION_NAME, org.getName());</span>
<span class="fc" id="L2513">        sendChangePrivacyLevelNotificationToCarer(context, actor, patient, carer, properties);</span>
<span class="fc" id="L2514">    }</span>

    private String getOrgName(PKBPerson actor, Team team) {
<span class="pc bpc" id="L2517" title="3 of 6 branches missed.">        if (team != null &amp;&amp; team.getOrg() != null &amp;&amp; StringUtils.isNotEmpty(team.getOrg().getName())) {</span>
<span class="fc" id="L2518">            return team.getOrg().getName();</span>
        } else {
<span class="nc" id="L2520">            return StringUtils.defaultString(actor.getOrganizationName());</span>
        }
    }

    private void sendChangePrivacyLevelNotificationToCarer(EHRRequestContext requestContext, PKBPerson actor, PKBPerson patient,
                                                           PKBPerson carer, Map&lt;String, Object&gt; properties) {
        try {
<span class="pc bpc" id="L2527" title="1 of 2 branches missed.">            if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L2528">                LOGGER.debug(&quot;Enter sendChangePrivacyLevelNotificationToCarer&quot;);</span>
            }
<span class="fc" id="L2530">            addPatientAndActorNameDetails(patient, actor, properties);</span>
<span class="fc" id="L2531">            addOrgNameIfActorNotPatientOrIndividualPro(requestContext, actor, properties);</span>
<span class="fc" id="L2532">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="fc" id="L2533">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="fc" id="L2534">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="fc" id="L2535">            properties.put(PKBConstants.CONTEXT_USER_ID, patient.getId());</span>

            //todo: do we want to add reasons or more details about the change?
<span class="fc" id="L2538">            properties.putAll(paramsFactory.createWithSiteProps());</span>

<span class="fc" id="L2540">            Team team = getTeam(requestContext.getTeamId());</span>
<span class="fc" id="L2541">            Optional&lt;AddressInfo&gt; addressInfoOpt = getPrimaryContactOnly(carer);</span>
<span class="pc bpc" id="L2542" title="1 of 2 branches missed.">            if (addressInfoOpt.isPresent()) {</span>
<span class="fc" id="L2543">                emailManager.sendMessage(Message.NOTIFY_CARER_PRIVACY_LEVEL_CHANGED, actor, addressInfoOpt.get(),</span>
<span class="fc" id="L2544">                        carer, properties, carer.getLocale(), null, actor.getId().toString(), getOrg(team), team);</span>
            }
<span class="nc" id="L2546">        } catch (MailException e) {</span>
<span class="nc" id="L2547">            throw new RuntimeException(e.getMessage(), e);</span>
<span class="fc" id="L2548">        }</span>

<span class="pc bpc" id="L2550" title="1 of 2 branches missed.">        if (LOGGER.isDebugEnabled()) {</span>
<span class="nc" id="L2551">            LOGGER.debug(&quot;Exiting sendAccessUpdateNotificationToPatient&quot;);</span>
        }
<span class="fc" id="L2553">    }</span>

    private void addOrgNameIfActorNotPatientOrIndividualPro(EHRRequestContext context, PKBPerson actor, Map&lt;String, Object&gt; properties) {
<span class="fc bfc" id="L2556" title="All 2 branches covered.">        String actorOrgName = notPatientOrIndividualPro(context, actor) ? getOrgNameOrEmpty(actor) : &quot;&quot;;</span>
<span class="fc" id="L2557">        properties.put(PKBConstants.ACTOR_ORGANIZATION_NAME, actorOrgName);</span>
<span class="fc" id="L2558">    }</span>

    private String getOrgNameOrEmpty(PKBPerson actor) {
<span class="fc" id="L2561">        return Option.of(actor.getOrganizationName()).getOrElse(&quot;&quot;);</span>
    }

    private boolean notPatientOrIndividualPro(EHRRequestContext context, PKBPerson pkbPerson) {
<span class="fc" id="L2565">        UserType userType = pkbPerson.getUserType();</span>
<span class="fc bfc" id="L2566" title="All 4 branches covered.">        return userType != PATIENT &amp;&amp; !teamUserManager.isIndividualPro(context, pkbPerson);</span>
    }

    /**
     * @param actor
     * @param patient
     */
    public void sendDischargeNotificationToPatient(PKBPerson actor, PKBPerson patient, Org org, Team team) {
        try {
<span class="fc" id="L2575">            LOGGER.debug(&quot;Enter sendDischargeNotificationToPatient&quot;);</span>

<span class="fc" id="L2577">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2578">            addPatientAndActorNameDetails(patient, actor, properties);</span>
<span class="fc" id="L2579">            properties.put(PKBConstants.CONTEXT_USER_ID, patient.getId());</span>
<span class="fc" id="L2580">            properties.put(PKBConstants.ORGANIZATION_NAME, actor.getOrganizationName());</span>
<span class="pc bpc" id="L2581" title="1 of 2 branches missed.">            boolean sendBrandedEmail = !actor.isPatient();</span>

<span class="fc" id="L2583">            Optional&lt;AddressInfo&gt; addressInfoOpt = getPrimaryContactOnly(patient);</span>
<span class="pc bpc" id="L2584" title="1 of 2 branches missed.">            if (addressInfoOpt.isPresent()) {</span>
<span class="fc" id="L2585">                emailManager.sendMessage(Message.NOTIFY_PATIENT_DISCHARGE, actor, addressInfoOpt.get(), patient, properties,</span>
<span class="pc bpc" id="L2586" title="2 of 4 branches missed.">                        patient.getLocale(), null, actor.getId().toString(), sendBrandedEmail ? org : null, sendBrandedEmail ? team : null);</span>
            }
<span class="nc" id="L2588">        } catch (MailException e) {</span>
<span class="nc" id="L2589">            throw new PKBException(e.getMessage(), e);</span>
<span class="fc" id="L2590">        }</span>

<span class="fc" id="L2592">        LOGGER.debug(&quot;Exiting sendDischargeNotificationToPatient&quot;);</span>
<span class="fc" id="L2593">    }</span>

    /**
     * @param actor
     * @param patient
     * @param carer
     */
    public void sendDischargeNotificationToCarer(PKBPerson actor, PKBPerson patient, PKBPerson carer, Org org, Team team) {
        try {
<span class="fc" id="L2602">            LOGGER.debug(&quot;Enter sendDischargeNotificationToCarer&quot;);</span>

<span class="fc" id="L2604">            Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2605">            addPatientAndActorNameDetails(patient, actor, properties);</span>
<span class="fc" id="L2606">            properties.put(PKBConstants.CARER_TITLE, carer.getTitle());</span>
<span class="fc" id="L2607">            properties.put(PKBConstants.CARER_FIRST_NAME, carer.getFirstName());</span>
<span class="fc" id="L2608">            properties.put(PKBConstants.CARER_LAST_NAME, carer.getLastName());</span>
<span class="fc" id="L2609">            properties.put(PKBConstants.ORGANIZATION_NAME, org.getName());</span>
<span class="fc" id="L2610">            properties.put(PKBConstants.CONTEXT_USER_ID, patient.getId());</span>
<span class="pc bpc" id="L2611" title="1 of 2 branches missed.">            boolean sendBrandedEmail = !actor.isPatient();</span>

<span class="fc" id="L2613">            Optional&lt;AddressInfo&gt; addressInfoOpt = getPrimaryContactOnly(carer);</span>
<span class="pc bpc" id="L2614" title="1 of 2 branches missed.">            if (addressInfoOpt.isPresent()) {</span>
<span class="fc" id="L2615">                emailManager.sendMessage(Message.NOTIFY_CARER_DISCHARGE, actor, addressInfoOpt.get(), carer, properties,</span>
<span class="pc bpc" id="L2616" title="2 of 4 branches missed.">                        carer.getLocale(), null, actor.getId().toString(), sendBrandedEmail ? org : null, sendBrandedEmail ? team : null);</span>
            }
<span class="nc" id="L2618">        } catch (MailException e) {</span>
<span class="nc" id="L2619">            throw new PKBException(e.getMessage(), e);</span>
<span class="fc" id="L2620">        }</span>

<span class="fc" id="L2622">        LOGGER.debug(&quot;Exiting sendDischargeNotificationToCarer&quot;);</span>
<span class="fc" id="L2623">    }</span>

    /**
     * @param requestContext
     * @param privacyOfficer
     * @param patient
     * @param org
     * @param date
     */
    public void sendSharingDisabledNotificationToPatient(PKBPerson privacyOfficer, PKBPerson patient, Org org,
                                                         Team team, ZonedDateTime zdt) {
        try {
<span class="fc" id="L2635">            LOGGER.debug(&quot;Enter sendSharingDisabledNotificationToPatient&quot;);</span>
<span class="fc" id="L2636">            Map&lt;String, Object&gt; properties = getPatientProperties(privacyOfficer, patient, org, zdt);</span>
<span class="fc" id="L2637">            emailManager.sendMessage(Message.NOTIFY_PATIENT_SHARING_DISABLED, privacyOfficer, formatter.getSenderContact(patient),</span>
<span class="fc" id="L2638">                    patient, properties, patient.getLocale(), null, privacyOfficer.getId().toString(), org, team);</span>

<span class="fc" id="L2640">        } catch (NoEmailAddressException neae) {</span>
<span class="fc" id="L2641">            LOGGER.debug(&quot;Not sending sharing disabled notification to patient, no email address&quot;, neae);</span>
<span class="nc" id="L2642">        } catch (MailException e) {</span>
<span class="nc" id="L2643">            throw new PKBException(e.getMessage(), e);</span>
<span class="fc" id="L2644">        }</span>

<span class="fc" id="L2646">        LOGGER.debug(&quot;Exiting sendSharingDisabledNotificationToPatient&quot;);</span>
<span class="fc" id="L2647">    }</span>

    /**
     * @param requestContext
     * @param privacyOfficer
     * @param patient
     * @param org
     * @param date
     */
    public void sendSharingEnabledNotificationToPatient(PKBPerson privacyOfficer, PKBPerson patient, Org org,
                                                        Team team, ZonedDateTime zdt) {
        try {
<span class="fc" id="L2659">            LOGGER.debug(&quot;Enter sendSharingEnabledNotificationToPatient&quot;);</span>
<span class="fc" id="L2660">            Map&lt;String, Object&gt; properties = getPatientProperties(privacyOfficer, patient, org, zdt);</span>
<span class="fc" id="L2661">            emailManager.sendMessage(Message.NOTIFY_PATIENT_SHARING_ENABLED, privacyOfficer, formatter.getSenderContact(patient),</span>
<span class="fc" id="L2662">                    patient, properties, patient.getLocale(), null, privacyOfficer.getId().toString(), org, team);</span>

<span class="nc" id="L2664">        } catch (NoEmailAddressException neae) {</span>
<span class="nc" id="L2665">            LOGGER.debug(&quot;Not sending sharing enabled notification to patient, no email address&quot;, neae);</span>
<span class="nc" id="L2666">        } catch (MailException e) {</span>
<span class="nc" id="L2667">            throw new PKBException(e.getMessage(), e);</span>
<span class="pc" id="L2668">        }</span>

<span class="fc" id="L2670">        LOGGER.debug(&quot;Exiting sendSharingEnabledNotificationToPatient&quot;);</span>
<span class="fc" id="L2671">    }</span>

    public void sendBreakTheGlassNotificationToPatient(PKBPerson btgActor, PKBPerson patient, Team team) {
<span class="fc" id="L2674">        Map&lt;String, Object&gt; properties = getPropertiesWithPatientAndClinician(btgActor, patient, team);</span>
        try {
<span class="fc" id="L2676">            emailManager.sendMessage(Message.BREAK_THE_GLASS_PATIENT_NOTIFICATION, btgActor,</span>
<span class="fc" id="L2677">                    formatter.getPrimaryAndSecondaryContacts(patient, new NoConsentsRequired()), patient,</span>
<span class="fc" id="L2678">                    properties, patient.getLocale(), null, btgActor.getId().toString(), getOrg(team), team);</span>
<span class="nc" id="L2679">        } catch (NoEmailAddressException neae) {</span>
<span class="nc" id="L2680">            LOGGER.debug(&quot;Not sending break the glass notification to patient, no email address&quot;, neae);</span>
<span class="nc" id="L2681">        } catch (MailException e) {</span>
<span class="nc" id="L2682">            throw new RuntimeException(e.getMessage(), e);</span>
<span class="pc" id="L2683">        }</span>
<span class="fc" id="L2684">    }</span>

    public void notifyNhsLoginPatientOfClaimedRecord(@NotNull PKBPerson person) {
<span class="fc" id="L2687">        var properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2688">        addNameDetails(person, properties);</span>
<span class="fc" id="L2689">        getPrimaryContactOnly(person)</span>
<span class="fc" id="L2690">                .ifPresent(addressInfo -&gt; sendEmail(Message.NOTIFY_NHS_LOGIN_PATIENT_OF_CLAIMED_RECORD, null, addressInfo, person, properties, person.getLocale()));</span>
<span class="fc" id="L2691">    }</span>

    private Map&lt;String, Object&gt; getPatientProperties(PKBPerson privacyOfficer, PKBPerson patient, Org org, ZonedDateTime zdt) {
<span class="fc" id="L2694">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2695">        addPatientAndActorNameDetails(patient, privacyOfficer, properties);</span>
<span class="fc" id="L2696">        properties.put(PKBConstants.ORGANIZATION_NAME, org.getName());</span>
<span class="fc" id="L2697">        properties.put(PKBConstants.SHARING_ENABLED_DISABLED_DATE, DATE_FORMAT.format(zdt));</span>

<span class="fc" id="L2699">        return properties;</span>
    }

    private Map&lt;String, Object&gt; getPropertiesWithPatientAndClinician(PKBPerson clinician, PKBPerson patient, Team team) {
<span class="fc" id="L2703">        Map&lt;String, Object&gt; properties = getPropertiesWithPatient(patient);</span>
<span class="fc" id="L2704">        addClinicianNameDetails(clinician, properties);</span>
<span class="fc" id="L2705">        properties.put(PKBConstants.ORGANIZATION_NAME, getOrgName(clinician, team));</span>
<span class="fc" id="L2706">        return properties;</span>
    }

    private Map&lt;String, Object&gt; getPropertiesWithPatient(PKBPerson patient) {
<span class="fc" id="L2710">        Map&lt;String, Object&gt; properties = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L2711">        properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L2712">        properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L2713">        properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L2714">        return properties;</span>
    }


    private void notifyCoordinatorBulkAccountCreationResult(PKBPerson coordinator, Team team, @Nullable long actorId,
                                                            Message notifyCoordinatorBulkAccountCreationFailed) {
        try {
<span class="fc" id="L2721">            EmailTemplateParams params = paramsFactory.createWithSiteProps()</span>
<span class="fc" id="L2722">                    .param(PKBConstants.TEAM_NAME, team.getName())</span>
<span class="fc" id="L2723">                    .urlParam(&quot;outcomesTabUrl&quot;, &quot;admin/listOutcomesOfBulkUploads.action&quot;);</span>
<span class="fc" id="L2724">            addAdminNameDetails(coordinator, params);</span>

<span class="fc" id="L2726">            emailManager.sendMessage(notifyCoordinatorBulkAccountCreationFailed, null,</span>
<span class="fc" id="L2727">                    formatter.getPrimaryAndSecondaryContacts(coordinator, new NoConsentsRequired()), coordinator,</span>
<span class="fc" id="L2728">                    params, coordinator.getLocale(), null, String.valueOf(actorId), team.getOrg(), team);</span>
<span class="nc" id="L2729">        } catch (MailException cause) {</span>
<span class="nc" id="L2730">            throw new IllegalStateException(cause);</span>
<span class="fc" id="L2731">        }</span>
<span class="fc" id="L2732">    }</span>

    private void addNameDetails(PKBPerson user, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L2735">        properties.put(PKBConstants.TITLE, user.getTitle());</span>
<span class="fc" id="L2736">        properties.put(PKBConstants.FIRST_NAME, user.getFirstName());</span>
<span class="fc" id="L2737">        properties.put(PKBConstants.LAST_NAME, user.getLastName());</span>
<span class="fc" id="L2738">    }</span>

    private void addPatientAndActorNameDetails(PKBPerson patient, PKBPerson actor, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L2741">        properties.put(PKBConstants.PATIENT_TITLE, patient.getTitle());</span>
<span class="fc" id="L2742">        properties.put(PKBConstants.PATIENT_FIRST_NAME, patient.getFirstName());</span>
<span class="fc" id="L2743">        properties.put(PKBConstants.PATIENT_LAST_NAME, patient.getLastName());</span>
<span class="fc" id="L2744">        properties.put(PKBConstants.ACTOR_TITLE, actor.getTitle());</span>
<span class="fc" id="L2745">        properties.put(PKBConstants.ACTOR_FIRST_NAME, actor.getFirstName());</span>
<span class="fc" id="L2746">        properties.put(PKBConstants.ACTOR_LAST_NAME, actor.getLastName());</span>
<span class="fc" id="L2747">    }</span>

    private void addTeamDetails(Team team, Map&lt;String, Object&gt; properties) {
        // TODO: add ORG_NAME constant?
<span class="fc" id="L2751">        properties.put(PKBConstants.INSTITUTE_NAME, team.getOrg().getName());</span>
<span class="fc" id="L2752">        properties.put(PKBConstants.INSTITUTE_CODE, team.getCode());</span>
<span class="fc" id="L2753">        properties.put(PKBConstants.INSTITUTE_TEAM, team.getName());</span>
<span class="fc" id="L2754">    }</span>

    private void addTeamDetailsWithTeamWithOrg(TeamWithOrg team, Map&lt;String, Object&gt; properties) {
<span class="nc" id="L2757">        properties.put(PKBConstants.INSTITUTE_NAME, team.getOrg().getName());</span>
<span class="nc" id="L2758">        properties.put(PKBConstants.INSTITUTE_CODE, team.getCode());</span>
<span class="nc" id="L2759">        properties.put(PKBConstants.INSTITUTE_TEAM, team.getName());</span>
<span class="nc" id="L2760">    }</span>

    private void addTeamBasicDetails(Team team, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L2763">        properties.put(PKBConstants.INSTITUTE_NAME, team.getName());</span>
<span class="fc" id="L2764">        properties.put(PKBConstants.INSTITUTE_CODE, team.getCode());</span>
<span class="fc" id="L2765">    }</span>

    private void addAdminNameDetails(PKBPerson inviter, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L2768">        properties.put(PKBConstants.ADMIN_TITLE, inviter.getTitle());</span>
<span class="fc" id="L2769">        properties.put(PKBConstants.ADMIN_FIRST_NAME, inviter.getFirstName());</span>
<span class="fc" id="L2770">        properties.put(PKBConstants.ADMIN_LAST_NAME, inviter.getLastName());</span>
<span class="fc" id="L2771">    }</span>

    private void addClinicianNameDetails(PKBPerson clinician, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L2774">        properties.put(PKBConstants.CLINICIAN_TITLE, clinician.getTitle());</span>
<span class="fc" id="L2775">        properties.put(PKBConstants.CLINICIAN_FIRST_NAME, clinician.getFirstName());</span>
<span class="fc" id="L2776">        properties.put(PKBConstants.CLINICIAN_LAST_NAME, clinician.getLastName());</span>
<span class="fc" id="L2777">    }</span>

    private void addClinicianNameAndInstituteNameDetails(PKBPerson clinician, Map&lt;String, Object&gt; properties) {
<span class="fc" id="L2780">        addClinicianNameDetails(clinician, properties);</span>
<span class="fc" id="L2781">        properties.put(PKBConstants.INSTITUTE_NAME, clinician.getOrganizationName());</span>
<span class="fc" id="L2782">    }</span>

    private void addTeamAndOrgNameIfPresent(Team authorTeam, Map&lt;String, Object&gt; properties) {
<span class="fc bfc" id="L2785" title="All 2 branches covered.">        if (authorTeam != null) {</span>
<span class="fc" id="L2786">            properties.put(PKBConstants.AUTHOR_TEAM, authorTeam.getName());</span>
<span class="fc" id="L2787">            properties.put(PKBConstants.AUTHOR_ORG, authorTeam.getOrg().getName());</span>
        }
<span class="fc" id="L2789">    }</span>

    private Team getTeam(Optional&lt;Long&gt; teamId) {
<span class="fc" id="L2792">        return teamManager.getTeam(teamId.orElse(null));</span>
    }

    private Team getTeam(TeamWithOrg teamWithOrg) {
<span class="nc bnc" id="L2796" title="All 2 branches missed.">        return teamWithOrg != null ? teamManager.getTeamByCode(teamWithOrg.getCode()) : null;</span>
    }

    private Org getOrg(Team team) {
<span class="fc bfc" id="L2800" title="All 2 branches covered.">        return team != null ? team.getOrg() : null;</span>
    }

    private Org getOrg(TeamWithOrg teamWithOrg) {
<span class="nc bnc" id="L2804" title="All 2 branches missed.">        return teamWithOrg != null ? teamManager.getOrgByCode(teamWithOrg.getOrg().getCode()).orElse(null) : null;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>