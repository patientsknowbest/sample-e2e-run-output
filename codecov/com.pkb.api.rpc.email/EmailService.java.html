<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmailService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.rpc.email</a> &gt; <span class="el_source">EmailService.java</span></div><h1>EmailService.java</h1><pre class="source lang-java linenums">package com.pkb.api.rpc.email;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.core.type.TypeReference;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.pkb.client.email.EmailDetails;
import com.pkb.client.email.EmailSent;
import com.pkb.client.email.ReactorEmailGrpc;
import com.pkb.client.email.exception.EmailServiceException;
import com.pkb.client.email.exception.InvalidParameterException;
import com.pkb.client.email.exception.UnexpectedException;
import com.pkb.client.email.util.EmailDetailsValidation;
import com.pkb.common.config.PhrConfig;
import com.pkb.consent.model.NoConsentsRequired;
import com.pkb.datamodel.consent.RequiresConsent;
import com.pkb.entities.enums.Message;
import com.pkb.exception.MailException;
import com.pkb.service.emailmessage.IAddressInfoProvider;
import com.pkb.service.emailmessage.impl.EmailManager;
import com.pkb.service.emailmessage.impl.EmailTemplateParams;
import com.pkb.service.emailmessage.impl.TemplateParamsFactory;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import io.vavr.Tuple;
import io.vavr.control.Either;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import reactor.core.publisher.Flux;

import java.lang.invoke.MethodHandles;
import java.time.Duration;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import static io.vavr.control.Either.left;
import static io.vavr.control.Either.right;


public class EmailService extends ReactorEmailGrpc.EmailImplBase {
    
<span class="fc" id="L45">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>
    private static final String QUESTIONNAIRE_REQUEST_TEMPLATE = &quot;questionnaire-request-template&quot;;

<span class="fc" id="L48">    private final Map&lt;String,Message&gt; emailTemplates = new HashMap&lt;&gt;();</span>
    
    private final EmailManager emailManager;
    private final UserManager userManager;
    private final IAddressInfoProvider formatter;
    private final TemplateParamsFactory paramsFactory;
    private final ObjectMapper objectMapper;
    private final PhrConfig phrConfig;

    public EmailService(EmailManager emailManager, UserManager userManager, IAddressInfoProvider formatter, TemplateParamsFactory paramsFactory,
<span class="fc" id="L58">                        ObjectMapper objectMapper, PhrConfig phrConfig) {</span>
<span class="fc" id="L59">        this.emailManager = emailManager;</span>
<span class="fc" id="L60">        this.userManager = userManager;</span>
<span class="fc" id="L61">        this.formatter = formatter;</span>
<span class="fc" id="L62">        this.paramsFactory = paramsFactory;</span>
<span class="fc" id="L63">        this.objectMapper = objectMapper;</span>
<span class="fc" id="L64">        this.phrConfig = phrConfig;</span>
<span class="fc" id="L65">        emailTemplates.put(QUESTIONNAIRE_REQUEST_TEMPLATE, Message.INVITE_PATIENT_TO_TAKE_QUESTIONNAIRE);</span>
<span class="fc" id="L66">    }</span>
    
    @Override
    public Flux&lt;EmailSent&gt; sendEmailStream(Flux&lt;EmailDetails&gt; emailDetailsFlux) {
<span class="fc" id="L70">        return emailDetailsFlux.bufferTimeout(phrConfig.getGrpcServerMessageBatchSize(), Duration.ofMillis(phrConfig.getGrpcServerMessageBufferTimeout()))</span>
<span class="fc" id="L71">                .flatMap(this::sendEmailsFromDetails)</span>
<span class="pc" id="L72">                .doOnError(err -&gt; LOGGER.error(&quot;error sendEmailStream&quot;, err));</span>
    }
    
    private Flux&lt;EmailSent&gt; sendEmailsFromDetails(List&lt;EmailDetails&gt; emailDetails) {
<span class="fc" id="L76">        var validated  = emailDetails.stream().map(EmailDetailsValidation::validate).collect(Collectors.toUnmodifiableList());</span>
<span class="fc" id="L77">        var personUUIDs = validated.stream()</span>
<span class="fc" id="L78">                .filter(Either::isRight)</span>
<span class="fc" id="L79">                .map(Either::get)</span>
<span class="fc" id="L80">                .flatMap(valid -&gt; Stream.of(valid.getMetadata().getSenderId(), valid.getMetadata().getRecipientId()))</span>
<span class="fc" id="L81">                .map(UUID::fromString)</span>
<span class="fc" id="L82">                .collect(Collectors.toUnmodifiableList());</span>
<span class="fc" id="L83">        var personMap = userManager.getPKBPersonMapByPublicId(personUUIDs);</span>

<span class="fc" id="L85">        return Flux.fromStream(validated.stream().map(validationResult -&gt; validationResult.flatMap(validDetails -&gt; sendEmail(personMap, validDetails))</span>
<span class="fc" id="L86">                    .fold(EmailServiceException::toEmailSent,</span>
<span class="fc" id="L87">                            details -&gt; EmailSent.newBuilder().setDetails(details).build())</span>
        ));
    }

    private Either&lt;EmailServiceException, EmailDetails&gt; sendEmail(Map&lt;UUID, PKBPerson&gt; personMap, EmailDetails validDetails) {
<span class="fc" id="L92">        return getTemplateParams(validDetails).map(params -&gt; Tuple.of(personMap, validDetails, params))</span>
<span class="fc" id="L93">                .flatMap(t -&gt; getTemplatePath(t._2).map(t::append))</span>
<span class="fc" id="L94">                .flatMap(t -&gt; t.apply(this::sendEmail));</span>
    }

    private Either&lt;EmailServiceException, EmailDetails&gt; sendEmail(Map&lt;UUID, PKBPerson&gt; personMap, EmailDetails emailDetails, EmailTemplateParams params, Message template) {
<span class="fc" id="L98">        var senderUUID = UUID.fromString(emailDetails.getMetadata().getSenderId());</span>
<span class="fc" id="L99">        var recipientUUID = UUID.fromString(emailDetails.getMetadata().getRecipientId());</span>

<span class="fc" id="L101">        PKBPerson sender = personMap.get(senderUUID);</span>
<span class="fc" id="L102">        PKBPerson recipient = personMap.get(recipientUUID);</span>
<span class="fc" id="L103">        RequiresConsent consentRequired = new NoConsentsRequired();</span>
        try {
<span class="fc" id="L105">            emailManager.sendMessage(template, sender,</span>
<span class="fc" id="L106">                    formatter.getPrimaryAndSecondaryContacts(recipient, consentRequired), recipient,</span>
<span class="fc" id="L107">                    params, recipient.getLocale(), null, sender.getId().toString(), null, null);</span>
<span class="fc" id="L108">            return right(emailDetails);</span>
<span class="fc" id="L109">        } catch (MailException e) {</span>
<span class="fc" id="L110">            String error = &quot;Error while sending email from user &quot; + emailDetails.getMetadata().getSenderId() +</span>
<span class="fc" id="L111">                    &quot; to user &quot; + emailDetails.getMetadata().getRecipientId();</span>
<span class="fc" id="L112">            LOGGER.error(error, e);</span>
<span class="pc bpc" id="L113" title="1 of 2 branches missed.">            String issue = e.getMessage() == null ? error : e.getMessage();</span>
<span class="fc" id="L114">            return left(new UnexpectedException(issue, emailDetails));</span>
        }
    }

    private Either&lt;EmailServiceException, EmailTemplateParams&gt; getTemplateParams(EmailDetails emailDetails) {
<span class="fc" id="L119">        return parseVariables(emailDetails)</span>
<span class="fc" id="L120">                .map(parsed -&gt; {</span>
<span class="fc" id="L121">                    var params = paramsFactory.createWithSiteProps();</span>
<span class="fc" id="L122">                    params.putAll(parsed);</span>
<span class="fc" id="L123">                    return params;</span>
                });
    }

    private Either&lt;EmailServiceException, Map&lt;String, Object&gt;&gt; parseVariables(EmailDetails emailDetails) {
        try {
<span class="fc" id="L129">            TypeReference&lt;HashMap&lt;String, Object&gt;&gt; typeRef = new TypeReference&lt;&gt;() {};</span>
<span class="fc" id="L130">            return right(objectMapper.readValue(emailDetails.getVariables().getJsonPayload(), typeRef));</span>
<span class="nc" id="L131">        } catch (JsonProcessingException e) {</span>
<span class="nc" id="L132">            return left(new InvalidParameterException(&quot;Unreadable template variables: &quot; + e.getMessage(), emailDetails));</span>
        }
    }

    private Either&lt;EmailServiceException, Message&gt; getTemplatePath(EmailDetails emailDetails){
<span class="fc" id="L137">        Message templatePath = emailTemplates.get(emailDetails.getTemplate());</span>
<span class="pc bpc" id="L138" title="1 of 2 branches missed.">        if (templatePath == null) {</span>
<span class="nc" id="L139">            return left(new InvalidParameterException(&quot;Unknown template name: '&quot; + emailDetails.getTemplate() + &quot;'&quot;, emailDetails));</span>
        }
<span class="fc" id="L141">        return right(templatePath);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>