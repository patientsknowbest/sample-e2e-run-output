<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TestResultHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.dataupload.emis.esv2.batch.impl.observation</a> &gt; <span class="el_source">TestResultHandler.java</span></div><h1>TestResultHandler.java</h1><pre class="source lang-java linenums">package com.pkb.service.dataupload.emis.esv2.batch.impl.observation;

import com.pkb.app.dto.DataPointSaveResult;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.coding.entity.CodeableConcept;
import com.pkb.coding.entity.CodingReceived;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.crypto.dto.AccountKeysDTO;
import com.pkb.dataupload.emis.esv2.EmisEsProcessedRow;
import com.pkb.emis.es.dto.DeduplicationCandidateDto;
import com.pkb.entities.enums.CodingDataType;
import com.pkb.institute.entity.Org;
import com.pkb.service.dataupload.emis.esv2.batch.impl.CareRecordProblemCache;
import com.pkb.service.dataupload.emis.esv2.model.AdminPatient;
import com.pkb.service.dataupload.emis.esv2.model.AdminUserInRole;
import com.pkb.service.dataupload.emis.esv2.model.CareRecordObservation;
import com.pkb.service.dataupload.emis.esv2.model.CareRecordProblem;
import com.pkb.service.dataupload.emis.esv2.sorting.ResultWithId;
import com.pkb.service.test.EHRTestManager;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.test.entity.LoincMapping;
import com.pkb.test.entity.TestResultDTO;
import com.pkb.util.tolven.TolvenBeanFactory;
import io.vavr.Tuple3;
import io.vavr.collection.List;
import io.vavr.collection.Map;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.util.Set;
import java.util.UUID;

@Component
public class TestResultHandler extends ObservationHandler&lt;TestResultDTO&gt;{

    private CareRecordProblemCache problemCache;

    private EHRTestManager ehrTestManager;

    @Autowired
    TestResultHandler(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider, EHRTestManager ehrTestManager, CareRecordProblemCache careRecordProblemCache) {
<span class="fc" id="L45">        super(config, beanFactory, dateTimeService, uuidProvider);</span>
<span class="fc" id="L46">        this.ehrTestManager = ehrTestManager;</span>
<span class="fc" id="L47">        this.problemCache = careRecordProblemCache;</span>
<span class="fc" id="L48">    }</span>

    @Override
    public CodingDataType getHandledDataType() {
<span class="fc" id="L52">        return CodingDataType.TEST;</span>
    }

    @Override
    protected Set&lt;UUID&gt; checkForDuplicates(List&lt;DeduplicationCandidateDto&lt;TestResultDTO&gt;&gt; candidates,
                                           Map&lt;Long, AccountKeysDTO&gt; accountIdToAccountKeys) {
<span class="nc" id="L58">        return ehrTestManager.checkForDuplicates(candidates, accountIdToAccountKeys);</span>
    }

    @Override
    protected @Nullable DataPointSaveResult&lt;TestResultDTO&gt; saveWithExternalIds(java.util.@NotNull List&lt;Tuple3&lt;TestResultDTO, CodingReceived, EHRRequestContext&gt;&gt; observationsToSave) {
<span class="nc" id="L63">        return ehrTestManager.addToMultipleAccountsNoCodingLookup(observationsToSave);</span>
    }

    @Override
    protected TestResultDTO create(CareRecordObservation observation,
                                             UUID uniqueId, Org org,
                                             long patientId,
                                             @Nullable AdminPatient adminPatient,
                                             long defaultAccountId,
                                             @Nullable AdminUserInRole enteredBy,
                                             CodingReceived codingReceived,
                                             CodeableConcept codeableConcept,
                                             EmisEsProcessedRow fileState,
                                             EHRRequestContext recordContext,
                                             @Nullable LoincMapping loincMapping) {

<span class="nc" id="L79">        TestResultDTO testResultDTO = new TestResultDTO(initializeSourceDetails(recordContext, enteredBy));</span>
<span class="nc" id="L80">        testResultDTO.getBaseFields().setUniqueId(uniqueId);</span>
<span class="nc" id="L81">        testResultDTO.getBaseFields().setPrivacyFlag(codingReceived.getCodingMatch().getPrivacyFlag());</span>

<span class="nc bnc" id="L83" title="All 2 branches missed.">        if (loincMapping == null) {</span>
<span class="nc" id="L84">            throw new IllegalStateException(&quot;No loincMapping for record: &quot; + observation);</span>
        }

<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (loincMapping.getLoincTest() == null) {</span>
<span class="nc" id="L88">            throw new IllegalStateException(&quot;No loincTest for loincMapping: &quot; + loincMapping + &quot; at record: &quot; + observation);</span>
        }

<span class="nc" id="L91">        testResultDTO.setLoincTestId(loincMapping.getLoincTest().getId());</span>

<span class="nc" id="L93">        testResultDTO.setLoincMappingId(loincMapping.getId());</span>

<span class="nc" id="L95">        testResultDTO.setPatientAccountId(defaultAccountId);</span>

<span class="nc" id="L97">        testResultDTO.setTestCodeFromSource(codingReceived.getCodingMatch().getCode());</span>
<span class="nc" id="L98">        testResultDTO.setTestCodingSystemFromSource(codingReceived.getCodingMatch().getCodeSystem());</span>

<span class="nc" id="L100">        testResultDTO.setCodingReceivedId(codingReceived.getId());</span>
<span class="nc" id="L101">        testResultDTO.setCoding(codeableConcept);</span>

<span class="nc" id="L103">        testResultDTO.setTestDate(parseDate(observation.effectiveDate(), org).orElseThrow(</span>
<span class="nc" id="L104">                () -&gt; new IllegalStateException(&quot;No effective date provided for CareRecordObservation: &quot; + observation)));</span>

<span class="nc" id="L106">        testResultDTO.setValue(observation.value().orElseThrow(</span>
<span class="nc" id="L107">                () -&gt; new IllegalStateException(&quot;No value provided for CareRecordObservation: &quot; + observation)));</span>

        // Slack thread: https://patientsknowbest.slack.com/archives/C582GGUP2/p1662131709477609?thread_ts=1662108326.615229&amp;cid=C582GGUP2
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (observation.numericRangeLow().isPresent()) {</span>
<span class="nc" id="L111">            testResultDTO.setRangeLow(observation.numericRangeLow().getAsDouble());</span>
<span class="nc" id="L112">            testResultDTO.setRangeLowInclusive(false);</span>
        }
<span class="nc bnc" id="L114" title="All 2 branches missed.">        if (observation.numericRangeHigh().isPresent()) {</span>
<span class="nc" id="L115">            testResultDTO.setRangeHigh(observation.numericRangeHigh().getAsDouble());</span>
<span class="nc" id="L116">            testResultDTO.setRangeHighInclusive(false);</span>
        }

        // You can find the details about this in ticket description: https://pkbdev.atlassian.net/browse/PHR-11013
<span class="nc" id="L120">        testResultDTO.setComments(null);</span>

        // Do nothing with problems, find the details about this in ticket description: https://pkbdev.atlassian.net/browse/PHR-11013
<span class="nc" id="L123">        ResultWithId&lt;CareRecordProblem, Long&gt; problem = problemCache.get(fileState.getBatchId(), observation);</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        if (problem != null) {</span>
<span class="nc" id="L125">            problemCache.markProcessed(fileState.getBatchId(), observation);</span>
        }

<span class="nc" id="L128">        return testResultDTO;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>