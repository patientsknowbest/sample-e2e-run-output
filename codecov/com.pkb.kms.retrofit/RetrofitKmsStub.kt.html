<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RetrofitKmsStub.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.kms.retrofit</a> &gt; <span class="el_source">RetrofitKmsStub.kt</span></div><h1>RetrofitKmsStub.kt</h1><pre class="source lang-java linenums">package com.pkb.kms.retrofit

import com.fasterxml.jackson.databind.ObjectMapper
import com.fasterxml.jackson.datatype.guava.GuavaModule
import com.fasterxml.jackson.module.kotlin.KotlinModule
import com.pkb.crypto.dto.AccountKeysDTO
import com.pkb.crypto.dto.AccountSymmetricKeyDTO
import com.pkb.crypto.dto.DplKeyDTO
import com.pkb.crypto.dto.UserPrivateKeyDTO
import com.pkb.entities.enums.SSOType
import com.pkb.kms.shared.KMS_CLIENT_ID_HEADER
import com.pkb.kms.shared.KMS_REQUEST_ID_HEADER
import com.pkb.kms.shared.representation.AccountIds
import com.pkb.kms.shared.representation.AccountKeyAvailability
import com.pkb.kms.shared.representation.AccountPrivateId
import com.pkb.kms.shared.representation.AccountPublicId
import com.pkb.kms.shared.representation.DplKeyId
import com.pkb.kms.shared.representation.DplKeyRequest
import com.pkb.kms.shared.representation.EncryptionRequest
import com.pkb.kms.shared.representation.EncryptionResponse
import com.pkb.kms.shared.representation.GrantOrgAccessToAccountRequest
import com.pkb.kms.shared.representation.GrantUserAccessToAccountRequest
import com.pkb.kms.shared.representation.KmsError
import com.pkb.kms.shared.representation.LoginRequest
import com.pkb.kms.shared.representation.NhsLoginRequest
import com.pkb.kms.shared.representation.OrgPublicId
import com.pkb.kms.shared.representation.PersonPublicId
import com.pkb.kms.shared.representation.SSOLoginRequest
import com.pkb.kms.shared.representation.SsoCredentialsCreateRequest
import com.pkb.kms.shared.representation.SymmetricKeyRequest
import com.pkb.kms.shared.representation.TeamPublicId
import io.micrometer.core.instrument.binder.okhttp3.OkHttpMetricsEventListener
import io.vavr.control.Either
import io.vavr.control.Either.left
import io.vavr.control.Either.right
import okhttp3.OkHttpClient
import retrofit2.Call
import retrofit2.CallAdapter
import retrofit2.Retrofit
import retrofit2.converter.jackson.JacksonConverterFactory
import retrofit2.create
import retrofit2.http.Body
import retrofit2.http.DELETE
import retrofit2.http.GET
import retrofit2.http.Header
import retrofit2.http.Headers
import retrofit2.http.POST
import retrofit2.http.Path
import retrofit2.http.Query
import java.lang.reflect.ParameterizedType
import java.lang.reflect.Type
import java.util.UUID
import javax.annotation.Nullable

private const val APPLICATION_JSON_HEADER = &quot;Accept: application/json&quot;

/**
 * Implementation of a Kms client library using Retrofit
 *
 * This should extend the core Kms interface once retrofit 2.7.0 is released
 * https://github.com/square/retrofit/issues/504
 */
internal interface RetrofitKmsStub {
    companion object {
        @JvmStatic
<span class="nc" id="L66">        fun kmsClient(baseUrl: String = &quot;http://localhost:48081&quot;,</span>
                      client: OkHttpClient): RetrofitKmsStub {
<span class="fc" id="L68">            return Retrofit.Builder()</span>
<span class="fc" id="L69">                    .baseUrl(baseUrl)</span>
<span class="fc" id="L70">                    .client(client)</span>
<span class="fc" id="L71">                    .addCallAdapterFactory(ErrorHandlingCallAdapterFactory())</span>
<span class="fc" id="L72">                    .addConverterFactory(JacksonConverterFactory.create(</span>
<span class="fc" id="L73">                            ObjectMapper().registerModules(GuavaModule(), KotlinModule.Builder().build())</span>
                    ))
<span class="fc" id="L75">                    .build()</span>
<span class="fc" id="L76">                    .create()</span>
        }
    }

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /login&quot;)
    @POST(&quot;/login&quot;)
    fun login(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
              @Header(KMS_CLIENT_ID_HEADER) clientId: String,
              @Body request: LoginRequest): Either&lt;KmsError, Void&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /login/nhs&quot;)
    @POST(&quot;/login/nhs&quot;)
    fun nhsLogin(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                 @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                 @Body request: NhsLoginRequest): Either&lt;KmsError, UserPrivateKeyDTO&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /login/sso&quot;)
    @POST(&quot;/login/sso&quot;)
    fun ssoLogin(@Header(KMS_REQUEST_ID_HEADER)requestId: String?,
                 @Header(KMS_CLIENT_ID_HEADER)  clientId: String,
                 @Body request: SSOLoginRequest): Either&lt;KmsError, UserPrivateKeyDTO&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /credentials/nhs&quot;)
    @POST(&quot;/credentials/nhs&quot;)
    fun addNhsLoginCredentials(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                               @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                               @Body request: NhsLoginRequest): Either&lt;KmsError, Void&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /credentials/nhs&quot;)
    @DELETE(&quot;/credentials/nhs/{person_public_ids}&quot;)
    fun expireNhsLoginCredentials(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                                  @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                                  @Path(&quot;person_public_ids&quot;) accountPublicIds: String): Either&lt;KmsError, Void&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /credentials/external_recovery&quot;)
    @POST(&quot;/credentials/external_recovery/{person_public_id}&quot;)
    fun addExternalCredentialRecovery(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                                      @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                                      @Path(&quot;person_public_id&quot;) personPublicId: PersonPublicId): Either&lt;KmsError, Void&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /credentials/external_recovery&quot;)
    @GET(&quot;/credentials/external_recovery/{person_public_id}&quot;)
    fun recoverCredentials(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                            @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                            @Path(&quot;person_public_id&quot;) personPublicId: PersonPublicId): Either&lt;KmsError, UserPrivateKeyDTO&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /credentials/external_recovery&quot;)
    @DELETE(&quot;/credentials/external_recovery/{person_public_id}&quot;)
    fun expireExternalCredentialRecovery(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                                         @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                                         @Path(&quot;person_public_id&quot;) personPublicId: PersonPublicId): Either&lt;KmsError, Void&gt;


    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /credentials/sso/credential&quot;)
    @POST(&quot;/credentials/sso/credential&quot;)
    fun createSSOCredential(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                            @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                            @Body ssoCredentialsCreateRequest: SsoCredentialsCreateRequest): Either&lt;KmsError, Void&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /credentials/sso/auth_record&quot;)
    @POST(&quot;/credentials/sso/auth_record&quot;)
    fun createSSOAuthRecord(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                            @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                            @Body ssoCredentialsCreateRequest: SsoCredentialsCreateRequest): Either&lt;KmsError, Void&gt;


    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /credentials/sso/auth_record_exists&quot;)
    @GET(&quot;/credentials/sso/auth_record_exists/{person_public_id}&quot;)
    fun ssoAuthRecordExists(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                            @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                            @Path(&quot;person_public_id&quot;) personPublicId: PersonPublicId,
                            @Query(&quot;ssoType&quot;)ssoType: SSOType): Either&lt;KmsError, Boolean&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /credentials/sso/status&quot;)
    @GET(&quot;/credentials/sso/status/{person_public_id}&quot;)
    fun getSSOCredentialStatus(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                               @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                               @Path(&quot;person_public_id&quot;) personPublicId: PersonPublicId): Either&lt;KmsError, Set&lt;SSOType&gt;&gt; // Comma separated list of username

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: sso/emis_key_valid&quot;)
    @GET(&quot;/credentials/sso/emis_key_valid/{person_public_id}&quot;)
    fun emisKeyValid(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                     @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                     @Path(&quot;person_public_id&quot;) personPublicId: PersonPublicId,
                     @Query(&quot;password_hash&quot;) passwordHash: String): Either&lt;KmsError, Boolean&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /account_keys&quot;)
    @GET(&quot;/account_keys/{account_ids}&quot;)
    fun getAccountKeys(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                       @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                       @Path(&quot;account_ids&quot;) accountPublicIds: String, // Comma separated list of account_id
                       @Query(&quot;ref_person_id&quot;) personPublicId: UUID,
                       @Query(&quot;force_verify&quot;) forceReload: Boolean): Either&lt;KmsError, List&lt;AccountKeysDTO&gt;&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /account_keys&quot;)
    @GET(&quot;/account_keys/{account_ids}&quot;)
    fun getAccountKeysAsOrg(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                            @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                            @Path(&quot;account_ids&quot;) accountPublicIds: String, // Comma separated list of account_id
                            @Query(&quot;ref_org_id&quot;) orgPublicId: OrgPublicId,
                            @Query(&quot;force_verify&quot;) forceReload: Boolean): Either&lt;KmsError, List&lt;AccountKeysDTO&gt;&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /trusted/account_keys&quot;)
    @GET(&quot;/trusted/account_keys/{account_ids}&quot;)
    fun getAccountKeysTrusted(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                              @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                              @Path(&quot;account_ids&quot;) accountPublicIds: String): Either&lt;KmsError, List&lt;AccountKeysDTO&gt;&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /trusted/account_keys/ignore_missing&quot;)
    @GET(&quot;/trusted/account_keys/ignore_missing/{account_ids}&quot;)
    fun getAccountKeysTrustedIgnoreMissing(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                                           @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                                           @Path(&quot;account_ids&quot;) accountPublicIds: String): Either&lt;KmsError, List&lt;AccountKeysDTO&gt;&gt;


    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /user_keys/cache&quot;)
    @DELETE(&quot;/user_keys/cache/{user_id}&quot;)
    fun evictUserKeys(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                      @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                      @Path(&quot;user_id&quot;) personPublicId: UUID): Either&lt;KmsError, Void&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /org_account_keys/cache&quot;)
    @DELETE(&quot;/org_account_keys/cache/{org_id}&quot;)
    fun evictOrgKeys(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                     @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                     @Path(&quot;org_id&quot;) orgId: Long): Either&lt;KmsError, Void&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /account_keys/cache&quot;)
    @DELETE(&quot;/account_keys/cache/{account_id}&quot;)
    fun evictAccountKeys(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                         @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                         @Path(&quot;account_id&quot;) accountPublicId: AccountPublicId,
                         @Query(&quot;include_unauthenticated_key&quot;) includeUnauthenticatedKey: Boolean): Either&lt;KmsError, Void&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /cache&quot;)
    @DELETE(&quot;/cache&quot;)
    fun evictKeys(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                  @Header(KMS_CLIENT_ID_HEADER) clientId: String): Either&lt;KmsError, Void&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /account_keys/symmetric_key_request&quot;)
    @POST(&quot;/account_keys/symmetric_key_request&quot;)
    fun generateSymmetricKey(@Header(KMS_REQUEST_ID_HEADER) requestID: String?,
                             @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                             @Body request: SymmetricKeyRequest): Either&lt;KmsError, AccountSymmetricKeyDTO&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}:  /account_keys/symmetric_key_request&quot;)
    @GET(&quot;/account_keys/symmetric_key_request/{account_ids}&quot;)
    fun getSymmetricKeys(@Header(KMS_REQUEST_ID_HEADER) requestID: String?,
                         @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                         @Path(&quot;account_ids&quot;) request: String) // Comma separated list
            : Either&lt;KmsError, Map&lt;AccountPublicId, AccountSymmetricKeyDTO&gt;&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /account_keys/cache/status&quot;)
    @GET(&quot;/account_keys/cache/status/{account_ids}&quot;)
    fun getAccountKeyCacheStatus(@Header(KMS_REQUEST_ID_HEADER) requestID: String?,
                                 @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                                 @Path(&quot;account_ids&quot;) accountPublicIds: String) // Comma separated list
            : Either&lt;KmsError, List&lt;AccountPublicId&gt;&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /account_keys/cache/status_for_user&quot;)
    @GET(&quot;/account_keys/cache/status_for_user/{person_public_id}&quot;)
    fun checkAccountKeyAvailabilityForUser(@Header(KMS_REQUEST_ID_HEADER) requestID: String?,
                                 @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                                 @Path(&quot;person_public_id&quot;) personPublicId: PersonPublicId)
            : Either&lt;KmsError, AccountKeyAvailability&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /org_account_keys/cache/list&quot;)
    @GET(&quot;/org_account_keys/cache/list&quot;)
    fun getOrgAccountKeysCacheStatus(@Header(KMS_REQUEST_ID_HEADER) requestID: String,
                                     @Header(KMS_CLIENT_ID_HEADER) clientId: String): Either&lt;KmsError, List&lt;Long&gt;&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /user_keys/cache/status&quot;)
    @GET(&quot;user_keys/cache/status/{user_ids}&quot;)
    fun getUserPrivateKeyCacheStatus(@Header(KMS_REQUEST_ID_HEADER) requestID: String?,
                                     @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                                     @Path(&quot;user_ids&quot;) personPublicIDs: String): Either&lt;KmsError, List&lt;PersonPublicId&gt;&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /user_keys/exists&quot;)
    @GET(&quot;user_keys/{user_id}/exists&quot;)
    fun userKeyExists(@Header(KMS_REQUEST_ID_HEADER) requestID: String?,
                      @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                      @Path(&quot;user_id&quot;) personPublicId: String): Either&lt;KmsError, Boolean&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /trusted/user_keys&quot;)
    @GET(&quot;/trusted/user_keys/{person_public_id}&quot;)
    fun getUserPrivateKeyTrusted(@Header(KMS_REQUEST_ID_HEADER) requestID: String?,
                                 @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                                 @Path(&quot;person_public_id&quot;) personPublicID: String): Either&lt;KmsError, UserPrivateKeyDTO&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /encryption&quot;)
    @POST(&quot;/encryption&quot;)
    fun encrypt(
        @Header(KMS_REQUEST_ID_HEADER) requestID: String?,
        @Header(KMS_CLIENT_ID_HEADER) clientId: String,
        @Body request: EncryptionRequest
    ): Either&lt;KmsError, EncryptionResponse&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /access/account/self&quot;)
    @POST(&quot;/access/account/self&quot;)
    fun grantAccessToAccountOwner(
        @Header(KMS_REQUEST_ID_HEADER) requestID: String?,
        @Header(KMS_CLIENT_ID_HEADER) clientId: String,
        @Body request: GrantUserAccessToAccountRequest
    ): Either&lt;KmsError, Void&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /trusted/access/account&quot;)
    @POST(&quot;/trusted/access/account&quot;)
    fun grantAccessToAccountTrusted(
        @Header(KMS_REQUEST_ID_HEADER) requestId: String?,
        @Header(KMS_CLIENT_ID_HEADER) clientId: String,
        @Body request: GrantUserAccessToAccountRequest
    ): Either&lt;KmsError, Void&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /trusted/access/account&quot;)
    @DELETE(&quot;/trusted/access/account/{account_id}/{person_public_id}&quot;)
    fun revokeAccessToAccountTrusted(
        @Header(KMS_REQUEST_ID_HEADER)requestId: String?,
        @Header(KMS_CLIENT_ID_HEADER)clientId: String?,
        @Path(&quot;account_id&quot;) accountPublicId: AccountPublicId,
        @Path(&quot;person_public_id&quot;) personPublicId: PersonPublicId): Either&lt;KmsError, Void&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /access/account&quot;)
    @POST(&quot;/access/account/{account_id}/org/{org_id}&quot;)
    fun grantOrgAccess(
        @Header(KMS_REQUEST_ID_HEADER) requestId: String?,
        @Header(KMS_CLIENT_ID_HEADER) clientId: String,
        @Path(&quot;account_id&quot;) accountPublicId: AccountPublicId,
        @Path(&quot;org_id&quot;) orgPublicId: OrgPublicId
    ): Either&lt;KmsError, Void&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /access/account&quot;)
    @POST(&quot;/access/account/&quot;)
    fun grantOrgAccess(
        @Header(KMS_REQUEST_ID_HEADER) requestId: String?,
        @Header(KMS_CLIENT_ID_HEADER) clientId: String,
        @Body request: GrantOrgAccessToAccountRequest,
    ): Either&lt;KmsError, List&lt;AccountPublicId&gt;&gt;


    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /dpl/keys&quot;)
    @POST(&quot;/dpl_keys&quot;)
    fun createDplKey(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                     @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                     @Body dplKeyRequest: DplKeyRequest): Either&lt;KmsError, DplKeyDTO&gt;


    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /dpl/keys&quot;)
    @GET(&quot;/dpl_keys/{key_ids}&quot;)
    fun getDplKeysForUser(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                          @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                          @Path(&quot;key_ids&quot;) keyIds: String, //Comma separated list of key_ids
                          @Query(&quot;ref_person_id&quot;) requesterPersonId: PersonPublicId,
                          @Query(&quot;target_person_id&quot;) targetPersonId: PersonPublicId): Either&lt;KmsError, List&lt;DplKeyDTO&gt;&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /dpl/keys&quot;)
    @GET(&quot;/dpl_keys/{key_ids}&quot;)
    fun getDplKeysForUserAsOrg(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                               @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                               @Path(&quot;key_ids&quot;) keyIds: String, //Comma separated list of key_ids
                               @Query(&quot;ref_org_id&quot;) requesterOrgId: OrgPublicId,
                               @Query(&quot;target_person_id&quot;) targetPersonId: PersonPublicId): Either&lt;KmsError, List&lt;DplKeyDTO&gt;&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /dpl/keys&quot;)
    @GET(&quot;/dpl_keys/{key_ids}&quot;)
    fun getDplKeysForTeam(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                          @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                          @Path(&quot;key_ids&quot;) keyIds: String, //Comma separated list of key_ids
                          @Query(&quot;ref_person_id&quot;) requesterPersonId: PersonPublicId,
                          @Query(&quot;target_team_id&quot;) targetTeamId: TeamPublicId): Either&lt;KmsError, List&lt;DplKeyDTO&gt;&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /dpl/keys&quot;)
    @GET(&quot;/dpl_keys/{key_ids}&quot;)
    fun getDplKeysForTeamAsOrg(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                               @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                               @Path(&quot;key_ids&quot;) keyIds: String, //Comma separated list of key_ids
                               @Query(&quot;ref_org_id&quot;) requesterOrgId: OrgPublicId,
                               @Query(&quot;target_team_id&quot;) targetTeamId: TeamPublicId): Either&lt;KmsError, List&lt;DplKeyDTO&gt;&gt;


    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /trusted/accounts&quot;)
    @POST(&quot;/trusted/accounts/create_and_grant_org_access/{org_id}&quot;)
    fun createAccountAndGrantOrgAccess(@Header(KMS_REQUEST_ID_HEADER)requestId: String?,
                                       @Path(&quot;org_id&quot;) orgPublicId: OrgPublicId): Either&lt;KmsError, AccountIds&gt;

    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /accounts&quot;)
    @POST(&quot;/accounts/create&quot;)
    fun createAccount(@Header(KMS_REQUEST_ID_HEADER) requestId: String?): Either&lt;KmsError, AccountIds&gt;

    @Suppress(&quot;FunctionName&quot;)
    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /kmstest/account_keys/cache/status&quot;)
    @GET(&quot;/kmstest/account_keys/cache/status/{account_ids}&quot;)
    fun TEST_ONLY_getAccountKeyCacheStatus(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                                           @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                                           @Path(&quot;account_ids&quot;) accountPublicIds: String): Either&lt;KmsError, Map&lt;String, Set&lt;AccountPublicId&gt;&gt;&gt;

    @Suppress(&quot;FunctionName&quot;)
    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /kmstest/symmetric_keys/cache/status&quot;)
    @GET(&quot;/kmstest/symmetric_keys/cache/status/{account_ids}&quot;)
    fun TEST_ONLY_getAccountSymmetricKeyCacheStatus(@Header(KMS_REQUEST_ID_HEADER) requestId: String?,
                                                    @Header(KMS_CLIENT_ID_HEADER) clientId: String,
                                                    @Path(&quot;account_ids&quot;) accountPublicIds: String): Either&lt;KmsError, Map&lt;String, Set&lt;AccountPublicId&gt;&gt;&gt;

    @Suppress(&quot;FunctionName&quot;)
    @Headers(APPLICATION_JSON_HEADER, &quot;${OkHttpMetricsEventListener.URI_PATTERN}: /kmstest/dpl_keys/cache/status&quot;)
    @GET(&quot;/kmstest/dpl_keys/cache/status/{dpl_key_ids}&quot;)
    fun TEST_ONLY_getDplKeyCacheStatus(
            @Header(KMS_REQUEST_ID_HEADER) requestId: String?,
            @Header(KMS_CLIENT_ID_HEADER) clientId: String,
            @Path(&quot;dpl_key_ids&quot;) dplKeyOds: String,
            @Query(&quot;account_id&quot;) accountPrivateId: AccountPrivateId): Either&lt;KmsError, List&lt;DplKeyId&gt;&gt;


}

/**
 * Adapts Retrofit's Call&lt;&gt; type to an Either&lt;E, R&gt; representing a success or a failure.
 * This also handles checking if the KMS is disabled and short circuiting the call.
 */
<span class="fc" id="L394">private class ErrorHandlingCallAdapterFactory : CallAdapter.Factory() {</span>
    @Nullable
    override fun get(returnType: Type,
                     annotations: Array&lt;Annotation&gt;,
                     retrofit: Retrofit): CallAdapter&lt;*, *&gt;? {
<span class="pc bpc" id="L399" title="1 of 2 branches missed.">        if (getRawType(returnType) != Either::class.java) {</span>
<span class="nc" id="L400">            return null</span>
        }
<span class="pc bpc" id="L402" title="1 of 2 branches missed.">        check(returnType is ParameterizedType) { &quot;return type must have generic type (e.g., Either&lt;KmsError, SomeDto&gt;)&quot; }</span>
<span class="fc" id="L403">        val responseErrorType = getParameterUpperBound(0, returnType)</span>
<span class="pc bpc" id="L404" title="1 of 2 branches missed.">        if (responseErrorType != KmsError::class.java) {</span>
<span class="nc" id="L405">            return null</span>
        }
<span class="fc" id="L407">        val responseType = getParameterUpperBound(1, returnType)</span>
<span class="fc" id="L408">        return ErrorHandlingCallAdapter&lt;Any&gt;(retrofit, responseType, annotations)</span>
    }
}

<span class="fc" id="L412">private class ErrorHandlingCallAdapter&lt;R&gt;(private val retrofit: Retrofit,</span>
<span class="fc" id="L413">                                          private val responseType: Type,</span>
<span class="fc" id="L414">                                          private val annotations: Array&lt;Annotation&gt;) : CallAdapter&lt;R, Either&lt;KmsError, R&gt;&gt; {</span>
    override fun responseType(): Type {
<span class="fc" id="L416">        return responseType</span>
    }

    override fun adapt(call: Call&lt;R&gt;): Either&lt;KmsError, R&gt; {
<span class="fc" id="L420">        val response = call.execute()</span>
<span class="fc bfc" id="L421" title="All 2 branches covered.">        return if (response.isSuccessful) {</span>
<span class="fc" id="L422">            right(response.body())</span>
<span class="fc" id="L423">        } else {</span>
<span class="fc" id="L424">            left(retrofit.responseBodyConverter&lt;KmsError&gt;(KmsError::class.java, annotations)</span>
<span class="fc" id="L425">                    .convert(response.errorBody()!!))</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>