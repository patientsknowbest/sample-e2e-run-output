<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RetrofitKms.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.kms.retrofit</a> &gt; <span class="el_source">RetrofitKms.kt</span></div><h1>RetrofitKms.kt</h1><pre class="source lang-java linenums">package com.pkb.kms.retrofit

import com.pkb.crypto.dto.AccountKeysDTO
import com.pkb.crypto.dto.AccountSymmetricKeyDTO
import com.pkb.crypto.dto.DplKeyDTO
import com.pkb.crypto.dto.UserPrivateKeyDTO
import com.pkb.entities.enums.SSOType
import com.pkb.kms.client.core.Kms
import com.pkb.kms.client.core.KmsClientConfig
import com.pkb.kms.shared.representation.AccountIds
import com.pkb.kms.shared.representation.AccountKeyAvailability
import com.pkb.kms.shared.representation.AccountPrivateId
import com.pkb.kms.shared.representation.AccountPublicId
import com.pkb.kms.shared.representation.DplKeyId
import com.pkb.kms.shared.representation.DplKeyRequest
import com.pkb.kms.shared.representation.EncryptionRequest
import com.pkb.kms.shared.representation.GrantOrgAccessToAccountRequest
import com.pkb.kms.shared.representation.GrantUserAccessToAccountRequest
import com.pkb.kms.shared.representation.KmsError
import com.pkb.kms.shared.representation.LoginRequest
import com.pkb.kms.shared.representation.NhsLoginRequest
import com.pkb.kms.shared.representation.OrgPublicId
import com.pkb.kms.shared.representation.PersonPublicId
import com.pkb.kms.shared.representation.SSOLoginRequest
import com.pkb.kms.shared.representation.SsoCredentialsCreateRequest
import com.pkb.kms.shared.representation.SymmetricKeyRequest
import com.pkb.kms.shared.representation.TeamPublicId
import io.vavr.control.Either
import io.vavr.control.Either.sequenceRight
import okhttp3.OkHttpClient
import org.slf4j.Logger
import org.slf4j.LoggerFactory
import java.io.IOException
import java.lang.invoke.MethodHandles
import java.util.concurrent.TimeUnit

/**
 * An OkHttpClient-based implementation of the KMS client
 *
 * @param client an OkHttpClient instance to use for communication
 * @param config configuration settings for this client
 */
<span class="pc" id="L43">class RetrofitKms(client: OkHttpClient = OkHttpClient(),</span>
<span class="fc" id="L44">                  private val config: KmsClientConfig) : Kms {</span>

<span class="fc" id="L46">    private val kmsOKHttpClient = client.newBuilder()</span>
<span class="fc" id="L47">            .connectTimeout(config.httpClientConnectTimeout(), TimeUnit.MILLISECONDS)</span>
<span class="fc" id="L48">            .readTimeout(config.httpClientReadTimeout(), TimeUnit.MILLISECONDS)</span>
<span class="fc" id="L49">            .writeTimeout(config.httpClientWriteTimeout(), TimeUnit.MILLISECONDS)</span>
<span class="fc" id="L50">            .build()</span>

<span class="fc" id="L52">    private val log: Logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass())</span>

<span class="fc" id="L54">    private val stub: RetrofitKmsStub = RetrofitKmsStub.kmsClient(config.baseURL, kmsOKHttpClient)</span>

<span class="fc" id="L56">    override fun login(requestId: String?, request: LoginRequest) = stub.login(requestId, config.clientId, request)</span>

    override fun nhsLogin(requestId: String?, request: NhsLoginRequest) =
<span class="fc" id="L59">            stub.nhsLogin(requestId, config.clientId, request)</span>

    override fun ssoLogin(requestId: String?, request: SSOLoginRequest) =
<span class="fc" id="L62">        stub.ssoLogin(requestId, config.clientId, request)</span>

    override fun addNhsLoginCredentials(requestId: String?, request: NhsLoginRequest) =
<span class="fc" id="L65">            stub.addNhsLoginCredentials(requestId, config.clientId, request)</span>

    override fun expireNhsLoginCredentials(requestId: String?, personPublicIds: List&lt;PersonPublicId&gt;) =
<span class="fc" id="L68">            stub.expireNhsLoginCredentials(requestId, config.clientId, personPublicIds.joinToString(&quot;,&quot;))</span>

    override fun addExternalCredentialRecovery(requestId: String?, personPublicId: PersonPublicId) =
<span class="fc" id="L71">            stub.addExternalCredentialRecovery(requestId, config.clientId, personPublicId)</span>

    override fun recoverCredentials(requestId: String?, personPublicId: PersonPublicId) =
<span class="fc" id="L74">            stub.recoverCredentials(requestId, config.clientId, personPublicId)</span>

    override fun expireExternalCredentialRecovery(requestId: String?, personPublicId: PersonPublicId) =
<span class="nc" id="L77">            stub.expireExternalCredentialRecovery(requestId, config.clientId, personPublicId)</span>


    override fun createSSOCredential(requestId: String?, ssoCredentialsCreateRequest: SsoCredentialsCreateRequest) =
<span class="fc" id="L81">        stub.createSSOCredential(requestId, config.clientId, ssoCredentialsCreateRequest)</span>

    override fun createSSOAuthRecord(requestId: String?, ssoCredentialsCreateRequest: SsoCredentialsCreateRequest) =
<span class="fc" id="L84">        stub.createSSOAuthRecord(requestId, config.clientId, ssoCredentialsCreateRequest)</span>

    override fun ssoAuthRecordExists(requestId: String?, personPublicId: PersonPublicId, ssoType: SSOType): Either&lt;KmsError, Boolean&gt; =
<span class="fc" id="L87">        stub.ssoAuthRecordExists(requestId, config.clientId, personPublicId, ssoType)</span>

    override fun getSSOCredentialStatus(requestId: String?, personPublicId: PersonPublicId): Either&lt;KmsError, Set&lt;SSOType&gt;&gt; =
<span class="fc" id="L90">        stub.getSSOCredentialStatus(requestId, config.clientId, personPublicId)</span>



    override fun emisKeyValid(requestId: String?, personPublicId: PersonPublicId, passwordHash: String): Either&lt;KmsError, Boolean&gt; =
<span class="fc" id="L95">        stub.emisKeyValid(requestId, config.clientId, personPublicId, passwordHash)</span>

    override fun getAccountKeys(requestId: String?,
                                accountPublicIds: List&lt;AccountPublicId&gt;,
                                personPublicId: PersonPublicId,
                                forceReload: Boolean): Either&lt;KmsError, List&lt;AccountKeysDTO&gt;&gt; =
<span class="fc" id="L101">            doBatched(accountPublicIds, config.accountKeysBatchSize, { batch -&gt;</span>
<span class="fc" id="L102">                stub.getAccountKeys(requestId, config.clientId, batch, personPublicId, forceReload)</span>
<span class="pc" id="L103">            }, { br1, br2 -&gt; br1.plus(br2) }, { emptyList() }, log)</span>

    override fun getAccountKeysAsOrg(requestId: String?,
                                     accountPublicIds: List&lt;AccountPublicId&gt;,
                                     orgPublicId: OrgPublicId,
                                     forceReload: Boolean): Either&lt;KmsError, List&lt;AccountKeysDTO&gt;&gt; =
<span class="fc" id="L109">            doBatched(accountPublicIds, config.accountKeysBatchSize, { batch -&gt;</span>
<span class="fc" id="L110">                stub.getAccountKeysAsOrg(requestId, config.clientId, batch, orgPublicId, forceReload)</span>
<span class="pc" id="L111">            }, { br1, br2 -&gt; br1.plus(br2) }, { emptyList() }, log)</span>

    override fun getAccountKeysTrusted(requestId: String?, accountPublicIds: List&lt;AccountPublicId&gt;): Either&lt;KmsError, List&lt;AccountKeysDTO&gt;&gt; =
<span class="fc" id="L114">            doBatched(accountPublicIds, config.accountKeysBatchSize, { batch -&gt;</span>
<span class="fc" id="L115">                stub.getAccountKeysTrusted(requestId, config.clientId, batch)</span>
<span class="pc" id="L116">            }, { br1, br2 -&gt; br1.plus(br2) }, { emptyList() }, log)</span>


    override fun getAccountKeysTrustedIgnoreMissing(requestId: String?, accountPublicIds: List&lt;AccountPublicId&gt;): Either&lt;KmsError, List&lt;AccountKeysDTO&gt;&gt; =
<span class="fc" id="L120">            doBatched(accountPublicIds, config.accountKeysBatchSize, { batch -&gt;</span>
<span class="fc" id="L121">                stub.getAccountKeysTrustedIgnoreMissing(requestId, config.clientId, batch)</span>
<span class="pc" id="L122">            }, { br1, br2 -&gt; br1.plus(br2) }, { emptyList() }, log)</span>

    override fun evictUserKeys(requestId: String?, personPublicId: PersonPublicId) =
<span class="fc" id="L125">            stub.evictUserKeys(requestId, config.clientId, personPublicId)</span>

<span class="nc" id="L127">    override fun evictOrgKeys(requestId: String?, orgId: Long) = stub.evictOrgKeys(requestId, config.clientId, orgId)</span>

    override fun evictAccountKeys(requestId: String?, accountPublicId: AccountPublicId) =
<span class="nc" id="L130">            stub.evictAccountKeys(requestId, config.clientId, accountPublicId, false)</span>

    override fun evictAccountKeys(requestId: String?, accountPublicId: AccountPublicId, includeUnauthenticatedKey: Boolean) =
<span class="nc" id="L133">            stub.evictAccountKeys(requestId, config.clientId, accountPublicId, includeUnauthenticatedKey)</span>

<span class="nc" id="L135">    override fun evictKeys(requestId: String?) = stub.evictKeys(requestId, config.clientId)</span>

    override fun generateSymmetricKey(requestID: String?, accountPublicId: SymmetricKeyRequest): Either&lt;KmsError, AccountSymmetricKeyDTO&gt; =
<span class="fc" id="L138">            stub.generateSymmetricKey(requestID, config.clientId, accountPublicId)</span>

    override fun getSymmetricKeys(requestID: String?, accountPublicIds: Collection&lt;AccountPublicId&gt;): Either&lt;KmsError, Map&lt;AccountPublicId, AccountSymmetricKeyDTO&gt;&gt; =
<span class="fc" id="L141">            doBatched(accountPublicIds, config.accountKeysBatchSize, { batch -&gt;</span>
<span class="fc" id="L142">                stub.getSymmetricKeys(requestID, config.clientId, batch)</span>
<span class="pc" id="L143">            }, { br1, br2 -&gt; br1.plus(br2) }, { emptyMap() }, log)</span>

    override fun getAccountKeyCacheStatus(requestID: String?, accountPublicIds: List&lt;AccountPublicId&gt;): Either&lt;KmsError, List&lt;AccountPublicId&gt;&gt; =
<span class="nc" id="L146">            stub.getAccountKeyCacheStatus(requestID, config.clientId, accountPublicIds.joinToString(&quot;,&quot;))</span>

    override fun checkAccountKeyAvailabilityForUser(requestId: String?, personPublicId: PersonPublicId): Either&lt;KmsError, AccountKeyAvailability&gt; =
<span class="fc" id="L149">        stub.checkAccountKeyAvailabilityForUser(requestId, config.clientId, personPublicId)</span>

    override fun getOrgAccountKeysCacheStatus(requestID: String): Either&lt;KmsError, List&lt;Long&gt;&gt; =
<span class="nc" id="L152">            stub.getOrgAccountKeysCacheStatus(requestID, config.clientId)</span>

    override fun getUserPrivateKeyCacheStatus(requestID: String?, personPublicIDs: List&lt;PersonPublicId&gt;): Either&lt;KmsError, List&lt;PersonPublicId&gt;&gt; =
<span class="nc" id="L155">            stub.getUserPrivateKeyCacheStatus(requestID, config.clientId, personPublicIDs.joinToString(&quot;,&quot;))</span>

    override fun userKeyExists(requestID: String?, personPublicID: PersonPublicId): Either&lt;KmsError, Boolean&gt; =
<span class="nc" id="L158">        stub.userKeyExists(requestID, config.clientId, personPublicID.toString())</span>

    override fun getUserPrivateKeyTrusted(requestID: String?, personPublicID: PersonPublicId): Either&lt;KmsError, UserPrivateKeyDTO&gt; =
<span class="nc" id="L161">        stub.getUserPrivateKeyTrusted(requestID, config.clientId, personPublicID.toString())</span>

    override fun encrypt(requestId: String?, request: EncryptionRequest) =
<span class="nc" id="L164">        stub.encrypt(requestId, config.clientId, request)</span>

    override fun grantAccessToAccountOwner(requestId: String?, request: GrantUserAccessToAccountRequest) =
<span class="fc" id="L167">        stub.grantAccessToAccountOwner(requestId, config.clientId, request)</span>

    override fun grantAccessToAccountTrusted(requestId: String?, request: GrantUserAccessToAccountRequest) =
<span class="fc" id="L170">        stub.grantAccessToAccountTrusted(requestId, config.clientId, request)</span>

    override fun revokeAccessToAccountTrusted(requestId: String?, accountPublicId: AccountPublicId, personPublicId: PersonPublicId): Either&lt;KmsError, Void&gt; =
<span class="fc" id="L173">        stub.revokeAccessToAccountTrusted(requestId, config.clientId, accountPublicId, personPublicId)</span>

    override fun grantOrgAccess(requestId: String?, accountPublicId: AccountPublicId, orgPublicId: OrgPublicId): Either&lt;KmsError, Void&gt; =
<span class="fc" id="L176">        stub.grantOrgAccess(requestId, config.clientId, accountPublicId, orgPublicId)</span>

    override fun grantOrgAccessMultiple(requestId: String?, accountPublicIds: List&lt;AccountPublicId&gt;, orgPublicId: OrgPublicId): Either&lt;KmsError, List&lt;AccountPublicId&gt;&gt; =
<span class="nc" id="L179">        stub.grantOrgAccess(requestId, config.clientId, GrantOrgAccessToAccountRequest(accountPublicIds, orgPublicId))</span>

    override fun createDplKey(requestId: String?, dplKeyRequest: DplKeyRequest): Either&lt;KmsError, DplKeyDTO&gt; =
<span class="fc" id="L182">        stub.createDplKey(requestId, config.clientId, dplKeyRequest)</span>

    override fun getDplKeysForUser(
        requestId: String?,
        keyIds: List&lt;DplKeyId&gt;,
        requesterPersonId: PersonPublicId,
        targetPersonId: PersonPublicId
    ): Either&lt;KmsError, List&lt;DplKeyDTO&gt;&gt; =
<span class="nc" id="L190">        doBatched(keyIds, config.accountKeysBatchSize, { batch -&gt;</span>
<span class="nc" id="L191">            stub.getDplKeysForUser(requestId, config.clientId, batch, requesterPersonId, targetPersonId)</span>
<span class="nc" id="L192">            }, { br1, br2 -&gt; br1 + br2 }, { emptyList() }, log)</span>


    override fun getDplKeysForUserAsOrg(
        requestId: String?,
        keyIds: List&lt;DplKeyId&gt;,
        requesterOrgId: OrgPublicId,
        targetPersonId: PersonPublicId
    ): Either&lt;KmsError, List&lt;DplKeyDTO&gt;&gt; =
<span class="nc" id="L201">        doBatched(keyIds, config.accountKeysBatchSize, { batch -&gt;</span>
<span class="nc" id="L202">            stub.getDplKeysForUserAsOrg(requestId, config.clientId, batch, requesterOrgId, targetPersonId)</span>
<span class="nc" id="L203">            }, { br1, br2 -&gt; br1 + br2 }, { emptyList() }, log)</span>

    override fun getDplKeysForTeam(requestId: String?, keyIds: List&lt;DplKeyId&gt;, requesterPersonId: PersonPublicId, targetTeamId: TeamPublicId): Either&lt;KmsError, List&lt;DplKeyDTO&gt;&gt; =
<span class="fc" id="L206">        doBatched(keyIds, config.accountKeysBatchSize, { batch -&gt;</span>
<span class="fc" id="L207">            stub.getDplKeysForTeam(requestId, config.clientId, batch, requesterPersonId, targetTeamId)</span>
<span class="pc" id="L208">            }, { br1, br2 -&gt; br1 + br2 }, { emptyList() }, log)</span>

    override fun getDplKeysForTeamAsOrg(requestId: String?, keyIds: List&lt;DplKeyId&gt;, requesterOrgId: OrgPublicId, targetTeamId: TeamPublicId): Either&lt;KmsError, List&lt;DplKeyDTO&gt;&gt; =
<span class="fc" id="L211">        doBatched(keyIds, config.accountKeysBatchSize, { batch -&gt;</span>
<span class="fc" id="L212">            stub.getDplKeysForTeamAsOrg(requestId, config.clientId, batch, requesterOrgId, targetTeamId)</span>
<span class="pc" id="L213">            }, { br1, br2 -&gt; br1 + br2 }, { emptyList() }, log)</span>


    override fun createAccountAndGrantOrgAccess(requestId: String?, orgPublicId: OrgPublicId): Either&lt;KmsError, AccountIds&gt; =
<span class="nc" id="L217">        stub.createAccountAndGrantOrgAccess(requestId, orgPublicId)</span>

    override fun createAccount(requestId: String?): Either&lt;KmsError, AccountIds&gt; =
<span class="fc" id="L220">        stub.createAccount(requestId)</span>

    override fun TEST_ONLY_getAccountKeyCacheStatus(requestId: String?,
                                                    accountPublicIds: List&lt;AccountPublicId&gt;): Either&lt;KmsError, Map&lt;String, Set&lt;AccountPublicId&gt;&gt;&gt; =
<span class="nc" id="L224">            stub.TEST_ONLY_getAccountKeyCacheStatus(requestId, config.clientId, accountPublicIds.joinToString(&quot;,&quot;))</span>

    override fun TEST_ONLY_getAccountSymmetricKeyCacheStatus(requestId: String?,
                                                             accountPublicIds: List&lt;AccountPublicId&gt;): Either&lt;KmsError, Map&lt;String, Set&lt;AccountPublicId&gt;&gt;&gt; =
<span class="nc" id="L228">            stub.TEST_ONLY_getAccountSymmetricKeyCacheStatus(requestId, config.clientId, accountPublicIds.joinToString(&quot;,&quot;))</span>


    override fun TEST_ONLY_getDplKeyCacheStatus(
        requestId: String?,
        dplKeyIds: List&lt;DplKeyId&gt;,
        accountPrivateId: AccountPrivateId
    ): Either&lt;KmsError, List&lt;DplKeyId&gt;&gt; =
<span class="nc" id="L236">        stub.TEST_ONLY_getDplKeyCacheStatus(requestId, config.clientId, dplKeyIds.joinToString(&quot;,&quot;), accountPrivateId)</span>
<span class="nc" id="L237">}</span>

internal fun &lt;T, R&gt; doBatched(lst: Collection&lt;T&gt;,
                              batchSize: Int,
                              requestFn: (batch: String) -&gt; Either&lt;KmsError, R&gt;,
                              combinator: (batchResult1: R, batchResult2: R) -&gt; R,
                              emptyProvider: () -&gt; R,
                              log: Logger) =
<span class="fc" id="L245">        sequenceRight(lst.chunked(batchSize)</span>
<span class="fc" id="L246">                .map { batchIds -&gt;</span>
<span class="fc" id="L247">                    val requestIds = batchIds.joinToString(&quot;,&quot;)</span>
<span class="fc" id="L248">                    try {</span>
<span class="fc" id="L249">                        requestFn(requestIds)</span>
<span class="nc" id="L250">                    } catch (e: Exception) {</span>
<span class="nc bnc" id="L251" title="All 4 branches missed.">                        if (e !is IOException &amp;&amp; e.cause !is IOException) {</span>
<span class="nc" id="L252">                            throw e</span>
                        }
<span class="nc" id="L254">                        log.warn(&quot;Timeout or other IO exception with batch request, falling back to non-batched. ids were: $requestIds&quot;, e)</span>
<span class="nc" id="L255">                        sequenceRight(batchIds.map { batchId -&gt; requestFn(batchId.toString()) })</span>
<span class="pc bnc" id="L256" title="All 2 branches missed.">                                .map { if (it.nonEmpty()) it.reduce(combinator) else emptyProvider() }</span>
                    }
                })
<span class="pc bfc" id="L259" title="All 2 branches covered.">                .map { if (it.nonEmpty()) it.reduce(combinator) else emptyProvider() }</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>