<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PatientConsent.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.consent.entity</a> &gt; <span class="el_source">PatientConsent.java</span></div><h1>PatientConsent.java</h1><pre class="source lang-java linenums">package com.pkb.consent.entity;

import com.google.common.base.MoreObjects;
import com.pkb.app.entity.SourceDetails;
import com.pkb.consent.model.ProvidesDefaultConsent;
import com.pkb.datamodel.consent.PatientConsentDTO;
import com.pkb.datamodel.consent.RequiresConsent;
import com.pkb.entities.enums.AccessingEntityType;
import com.pkb.entities.enums.ConsentReason;
import com.pkb.entities.enums.PrivacyFlag;
import com.pkb.entities.enums.Route;
import com.pkb.infrastructure.hibernate.id.enhanced.ResettablePooledLoOptimizer;
import org.apache.commons.lang3.SerializationUtils;
import org.apache.commons.lang3.StringUtils;
import org.hibernate.annotations.GenericGenerator;
import org.hibernate.annotations.Type;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.EnumType;
import javax.persistence.Enumerated;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.Table;
import javax.persistence.Transient;
import javax.persistence.UniqueConstraint;
import java.io.Serializable;
import java.time.Instant;
import java.util.Objects;
import java.util.Optional;
import java.util.UUID;

import static io.vavr.API.unchecked;

@Entity
@Table(name = &quot;patientconsent&quot;, uniqueConstraints = @UniqueConstraint(columnNames = { &quot;patientPersonId&quot;, &quot;accessingEntityType&quot;,
        &quot;accessingTeamOrPersonId&quot; }))
public class PatientConsent implements Serializable, Cloneable {

    private static final long serialVersionUID = 8237823851960312980L;

    @Id
    @GenericGenerator(name = &quot;seq_pc_gen&quot;, strategy = &quot;enhanced-sequence&quot;, parameters = {
            @org.hibernate.annotations.Parameter(name = &quot;optimizer&quot;, value = ResettablePooledLoOptimizer.OPTIMIZER_CANONICAL_NAME),
            @org.hibernate.annotations.Parameter(name = &quot;schema&quot;, value = &quot;public&quot;),
            @org.hibernate.annotations.Parameter(name = &quot;sequence_name&quot;, value = &quot;seq_patientconsent&quot;),
            @org.hibernate.annotations.Parameter(name = &quot;increment_size&quot;, value = &quot;50&quot;)
    })
    @GeneratedValue(strategy = GenerationType.SEQUENCE, generator = &quot;seq_pc_gen&quot;)
    private Long id;

    @Column(nullable = false)
    private boolean generalHealthConsentGranted;

    @Column(nullable = false)
    private boolean socialCareConsentGranted;

    @Column(nullable = false)
    private boolean mentalHealthConsentGranted;

    @Column(nullable = false)
    private boolean sexualHealthConsentGranted;

    @Column(nullable = false, name = &quot;accessingTeamOrPersonId&quot;)
    private Long accessingTeamSlashPersonId;

    @Column(nullable = false)
    private Long patientPersonId;

    @Column(nullable = false)
    @Enumerated(EnumType.STRING)
    private AccessingEntityType accessingEntityType;

    @Column(columnDefinition = &quot;boolean default false&quot;, nullable = false)
    private boolean proEditOnlyForChild;

    @Column(columnDefinition = &quot;boolean default false&quot;, nullable = false)
    private boolean discharged;

    @Column
    @Type(type = &quot;pg-uuid&quot;)
    private UUID uniqueId; // Ties together multiple menu_data records for the same consent record (audit trail)

    @Column(nullable = false, updatable = false)
    private Instant added;

    @Column(nullable = false)
    private Instant updated;

    @Transient
    private PatientConsentReason reasons; // Kept encrypted in menu_data

<span class="fc" id="L94">    public PatientConsent() {</span>
<span class="fc" id="L95">        this.uniqueId = UUID.randomUUID();</span>
<span class="fc" id="L96">    }</span>

<span class="fc" id="L98">    private PatientConsent(PatientConsent.Builder builder) {</span>
        // Set granted flags
<span class="fc" id="L100">        generalHealthConsentGranted = builder.generalHealthConsentGranted;</span>
<span class="fc" id="L101">        socialCareConsentGranted = builder.socialCareConsentGranted;</span>
<span class="fc" id="L102">        mentalHealthConsentGranted = builder.mentalHealthConsentGranted;</span>
<span class="fc" id="L103">        sexualHealthConsentGranted = builder.sexualHealthConsentGranted;</span>

        // Store reasons
<span class="fc" id="L106">        reasons = new PatientConsentReason();</span>
<span class="fc" id="L107">        reasons.setGeneralHealthConsentGrantedReason(builder.generalHealthConsentGrantedReason);</span>
<span class="fc" id="L108">        reasons.setSocialCareConsentGrantedReason(builder.socialCareConsentGrantedReason);</span>
<span class="fc" id="L109">        reasons.setMentalHealthConsentGrantedReason(builder.mentalHealthConsentGrantedReason);</span>
<span class="fc" id="L110">        reasons.setSexualHealthConsentGrantedReason(builder.sexualHealthConsentGrantedReason);</span>

        // Unique id
<span class="fc" id="L113">        this.uniqueId = builder.uniqueId;</span>
<span class="fc" id="L114">        reasons.getBaseFields().setUniqueId(builder.uniqueId);</span>

        // Who is making changes?
<span class="fc" id="L117">        reasons.getSource().init(builder.changedBy, builder.teamId, builder.orgId, null, builder.route, builder.responsibleOrganisationIdentifier);</span>

        // Set relation
<span class="fc" id="L120">        accessingTeamSlashPersonId = builder.consentGrantedTo;</span>
<span class="fc" id="L121">        patientPersonId = builder.consentGrantedBy;</span>
<span class="fc" id="L122">        accessingEntityType = builder.accessingEntityType;</span>
<span class="fc" id="L123">        added = builder.added;</span>
<span class="fc" id="L124">        updated = builder.updated;</span>
<span class="fc" id="L125">    }</span>

    @Override
    public String toString() {
<span class="nc" id="L129">        return MoreObjects.toStringHelper(this)</span>
<span class="nc" id="L130">                .omitNullValues()</span>
<span class="nc" id="L131">                .add(&quot;id&quot;, id)</span>
<span class="nc" id="L132">                .add(&quot;generalHealthConsentGranted&quot;, generalHealthConsentGranted)</span>
<span class="nc" id="L133">                .add(&quot;socialCareConsentGranted&quot;, socialCareConsentGranted)</span>
<span class="nc" id="L134">                .add(&quot;mentalHealthConsentGranted&quot;, mentalHealthConsentGranted)</span>
<span class="nc" id="L135">                .add(&quot;sexualHealthConsentGranted&quot;, sexualHealthConsentGranted)</span>
<span class="nc" id="L136">                .add(&quot;discharged&quot;, discharged)</span>
<span class="nc" id="L137">                .add(&quot;accessingTeamOrPersonId&quot;, accessingTeamSlashPersonId)</span>
<span class="nc" id="L138">                .add(&quot;patientPersonId&quot;, patientPersonId)</span>
<span class="nc" id="L139">                .add(&quot;accessingEntityType&quot;, accessingEntityType)</span>
<span class="nc" id="L140">                .toString();</span>
    }

    public String toShortString() {
<span class="nc" id="L144">        String privacyFlags = new StringBuilder()</span>
<span class="nc bnc" id="L145" title="All 2 branches missed.">                .append(generalHealthConsentGranted ? &quot;T&quot; : &quot;F&quot;).append(&quot;/&quot;)</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">                .append(mentalHealthConsentGranted ? &quot;T&quot; : &quot;F&quot;).append(&quot;/&quot;)</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                .append(sexualHealthConsentGranted ? &quot;T&quot; : &quot;F&quot;).append(&quot;/&quot;)</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">                .append(socialCareConsentGranted ? &quot;T&quot; : &quot;F&quot;)</span>
<span class="nc bnc" id="L149" title="All 2 branches missed.">                .append(discharged ? &quot;/D&quot; : &quot;&quot;)</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">                .append(proEditOnlyForChild ? &quot;/ProLock&quot; : &quot;&quot;)</span>
<span class="nc" id="L151">                .toString();</span>

<span class="nc" id="L153">        return MoreObjects.toStringHelper(this)</span>
<span class="nc" id="L154">                .add(&quot;id&quot;, id)</span>
<span class="nc" id="L155">                .add(&quot;GH/MH/SH/SC&quot;, privacyFlags)</span>
<span class="nc" id="L156">                .add(&quot;patient&quot;, patientPersonId)</span>
<span class="nc" id="L157">                .add(&quot;accessor&quot;, accessingEntityType + &quot;/&quot; + accessingTeamSlashPersonId)</span>
<span class="nc" id="L158">                .toString();</span>
    }

    /**
     * Examines the consent granted on {@code other}, and where changes are
     * found updates {@code this} with the consent and reasons.
     *
     * @param other
     * @return True if {@code this} has changed as a result of the merge,
     *         otherwise false.
     */
    public boolean merge(PatientConsent other) {
<span class="fc" id="L170">        boolean changed = false;</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">        if (isGeneralHealthConsentGranted() != other.isGeneralHealthConsentGranted()) {</span>
<span class="fc" id="L172">            setGeneralHealthConsentGranted(other.isGeneralHealthConsentGranted());</span>
<span class="fc" id="L173">            getReasons().setGeneralHealthConsentGrantedReason(other.getReasons().getGeneralHealthConsentGrantedReason());</span>
<span class="fc" id="L174">            getReasons().setGeneralHealthConsentGrantedReasonText(other.getReasons().getGeneralHealthConsentGrantedReasonText());</span>
<span class="fc" id="L175">            changed = true;</span>
        }

<span class="fc bfc" id="L178" title="All 2 branches covered.">        if (isSexualHealthConsentGranted() != other.isSexualHealthConsentGranted()) {</span>
<span class="fc" id="L179">            setSexualHealthConsentGranted(other.isSexualHealthConsentGranted());</span>
<span class="fc" id="L180">            getReasons().setSexualHealthConsentGrantedReason(other.getReasons().getSexualHealthConsentGrantedReason());</span>
<span class="fc" id="L181">            getReasons().setSexualHealthConsentGrantedReasonText(other.getReasons().getSexualHealthConsentGrantedReasonText());</span>
<span class="fc" id="L182">            changed = true;</span>
        }

<span class="fc bfc" id="L185" title="All 2 branches covered.">        if (isMentalHealthConsentGranted() != other.isMentalHealthConsentGranted()) {</span>
<span class="fc" id="L186">            setMentalHealthConsentGranted(other.isMentalHealthConsentGranted());</span>
<span class="fc" id="L187">            getReasons().setMentalHealthConsentGrantedReason(other.getReasons().getMentalHealthConsentGrantedReason());</span>
<span class="fc" id="L188">            getReasons().setMentalHealthConsentGrantedReasonText(other.getReasons().getMentalHealthConsentGrantedReasonText());</span>
<span class="fc" id="L189">            changed = true;</span>
        }

<span class="fc bfc" id="L192" title="All 2 branches covered.">        if (isSocialCareConsentGranted() != other.isSocialCareConsentGranted()) {</span>
<span class="fc" id="L193">            setSocialCareConsentGranted(other.isSocialCareConsentGranted());</span>
<span class="fc" id="L194">            getReasons().setSocialCareConsentGrantedReason(other.getReasons().getSocialCareConsentGrantedReason());</span>
<span class="fc" id="L195">            getReasons().setSocialCareConsentGrantedReasonText(other.getReasons().getSocialCareConsentGrantedReasonText());</span>
<span class="fc" id="L196">            changed = true;</span>
        }

<span class="fc bfc" id="L199" title="All 2 branches covered.">        if (isProEditOnlyForChild() != other.isProEditOnlyForChild()) {</span>
<span class="fc" id="L200">            setProEditOnlyForChild(other.isProEditOnlyForChild());</span>
<span class="fc" id="L201">            getReasons().setProEditOnlyForChildReasonText(other.getReasons().getProEditOnlyForChildReasonText());</span>
<span class="fc" id="L202">            changed = true;</span>
        }

<span class="pc bpc" id="L205" title="1 of 2 branches missed.">        if (!StringUtils.equalsIgnoreCase(getReasons().getEventText(), other.getReasons().getEventText())) {</span>
<span class="fc" id="L206">            getReasons().setEventText(other.getReasons().getEventText());</span>
        }

<span class="pc bpc" id="L209" title="1 of 2 branches missed.">        if (other.getReasons().getSource().isPopulated()) {</span>
<span class="fc" id="L210">            getReasons().getSource().init(other.getReasons().getSource());</span>
        }

<span class="pc bpc" id="L213" title="1 of 2 branches missed.">        if (!Objects.equals(getAdded(), other.getAdded())) {</span>
<span class="fc" id="L214">            setAdded(other.getAdded());</span>
<span class="fc" id="L215">            changed = true;</span>
        }

<span class="pc bpc" id="L218" title="1 of 2 branches missed.">        if (!Objects.equals(getUpdated(), other.getUpdated())) {</span>
<span class="nc" id="L219">            setUpdated(other.getUpdated());</span>
<span class="nc" id="L220">            changed = true;</span>
        }

        // If this object is unpersisted (id is null), always report as changed
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">        if (getId() == null) {</span>
<span class="nc" id="L225">            changed = true;</span>
        }

<span class="fc bfc" id="L228" title="All 2 branches covered.">        if (other.isDischarged() != this.isDischarged()) {</span>
<span class="fc" id="L229">            this.setDischarged(other.isDischarged());</span>
<span class="fc" id="L230">            changed = true;</span>
        }

<span class="pc bpc" id="L233" title="1 of 2 branches missed.">        if (changed) {</span>
            // We'll want to archive the current categories for the audit log
<span class="fc" id="L235">            getReasons().trackConsentCategories(this);</span>
        }

<span class="fc" id="L238">        return changed;</span>
    }

    public boolean anyConsentGranted() {
<span class="fc bfc" id="L242" title="All 8 branches covered.">        return generalHealthConsentGranted</span>
                || mentalHealthConsentGranted
                || sexualHealthConsentGranted
                || socialCareConsentGranted;
    }

    public void setReasons(PatientConsentReason reasons) {
<span class="pc bpc" id="L249" title="1 of 2 branches missed.">        if (reasons != null) {</span>
<span class="fc" id="L250">            reasons.getBaseFields().setUniqueId(uniqueId);</span>
        }
<span class="fc" id="L252">        this.reasons = reasons;</span>
<span class="fc" id="L253">    }</span>

    public void setUniqueId(UUID uniqueId) {
<span class="nc" id="L256">        this.uniqueId = uniqueId;</span>
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (reasons != null) {</span>
<span class="nc" id="L258">            reasons.getBaseFields().setUniqueId(uniqueId);</span>
        }
<span class="nc" id="L260">    }</span>

    @Override
    protected Object clone() throws CloneNotSupportedException {
<span class="nc" id="L264">        return SerializationUtils.clone(this);</span>
    }

    /**
     * Create a new consent object based on the current one so it can be saved for another user. Useful when
     * bulk-applying the same consent categories to many patients.
     *
     * @param patientId
     */
    public PatientConsent cloneForPatient(long patientId, Instant now) {
<span class="nc" id="L274">        PatientConsent clone = unchecked(() -&gt; (PatientConsent) this.clone()).get();</span>

        // Set id to null to force hibernate to store a new row
<span class="nc" id="L277">        clone.setId(null);</span>

        // Update the unique id (used for grouping history)
<span class="nc" id="L280">        UUID newUniqueId = UUID.randomUUID();</span>
<span class="nc" id="L281">        clone.setUniqueId(newUniqueId);</span>
<span class="nc" id="L282">        clone.getReasons().getBaseFields().setUniqueId(newUniqueId);</span>

        // Update the patient this consent applies to
<span class="nc" id="L285">        clone.setPatientPersonId(patientId);</span>

        // Probably unnecessary, but force reason object to track selected categories
<span class="nc" id="L288">        clone.getReasons().trackConsentCategories(this);</span>
<span class="nc" id="L289">        clone.setAdded(now);</span>
        // We leave the consent categories, accessing entity type and id, and change
        // reason the same
<span class="nc" id="L292">        return clone;</span>
    }

    /**
     * Returns true if this consent object covers the specified required consent categories
     */
    public boolean isEntityVisible(RequiresConsent checkable) {
<span class="nc bnc" id="L299" title="All 2 branches missed.">        return checkConsent(checkable.getRequireGeneral(), generalHealthConsentGranted)</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">                &amp;&amp; checkConsent(checkable.getRequireSexualHealth(), sexualHealthConsentGranted)</span>
<span class="nc bnc" id="L301" title="All 2 branches missed.">                &amp;&amp; checkConsent(checkable.getRequireMentalHealth(), mentalHealthConsentGranted)</span>
<span class="nc bnc" id="L302" title="All 2 branches missed.">                &amp;&amp; checkConsent(checkable.getRequireSocialCare(), socialCareConsentGranted);</span>
    }

    /**
     * A carer may only grant consent on behalf of a patient equivalent to what
     * they themselves have been granted by the patient. For example, a carer with
     * only general consent cannot grant mental health consent to a pro on behalf
     * of the patient
     *
     * @param preEditConsent
     *            The consent record prior to any edits by the carer
     * @param carerConsent
     *            The consent record of the carer making this edit
     * @return True if the edit is permitted, otherwise false
     */
    public boolean validateCarerUpdate(PatientConsent preEditConsent, PatientConsentDTO carerConsent) {
        // For each consent value set, it must be either a) set originally,
        // or b) a value that the carer may set
        boolean validGrant;
<span class="fc bfc" id="L321" title="All 2 branches covered.">        if (this.isGeneralHealthConsentGranted()) {</span>
<span class="pc bpc" id="L322" title="1 of 4 branches missed.">            validGrant = ((preEditConsent != null) &amp;&amp; preEditConsent.isGeneralHealthConsentGranted())</span>
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">                    || carerConsent.generalHealthConsentGranted();</span>

<span class="pc bpc" id="L325" title="1 of 2 branches missed.">            if (!validGrant) {</span>
<span class="nc" id="L326">                return false;</span>
            }
        }

<span class="fc bfc" id="L330" title="All 2 branches covered.">        if (this.isMentalHealthConsentGranted()) {</span>
<span class="pc bpc" id="L331" title="1 of 4 branches missed.">            validGrant = ((preEditConsent != null) &amp;&amp; preEditConsent.isMentalHealthConsentGranted())</span>
<span class="pc bpc" id="L332" title="1 of 2 branches missed.">                    || carerConsent.mentalHealthConsentGranted();</span>

<span class="pc bpc" id="L334" title="1 of 2 branches missed.">            if (!validGrant) {</span>
<span class="nc" id="L335">                return false;</span>
            }
        }

<span class="fc bfc" id="L339" title="All 2 branches covered.">        if (this.isSexualHealthConsentGranted()) {</span>
<span class="pc bpc" id="L340" title="2 of 4 branches missed.">            validGrant = ((preEditConsent != null) &amp;&amp; preEditConsent.isSexualHealthConsentGranted())</span>
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">                    || carerConsent.sexualHealthConsentGranted();</span>

<span class="pc bpc" id="L343" title="1 of 2 branches missed.">            if (!validGrant) {</span>
<span class="nc" id="L344">                return false;</span>
            }
        }

<span class="fc bfc" id="L348" title="All 2 branches covered.">        if (this.isSocialCareConsentGranted()) {</span>
<span class="pc bpc" id="L349" title="1 of 4 branches missed.">            validGrant = ((preEditConsent != null) &amp;&amp; preEditConsent.isSocialCareConsentGranted())</span>
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">                    || carerConsent.socialCareConsentGranted();</span>

<span class="pc bpc" id="L352" title="1 of 2 branches missed.">            if (!validGrant) {</span>
<span class="nc" id="L353">                return false;</span>
            }
        }

<span class="fc" id="L357">        return true;</span>
    }

    private boolean checkConsent(boolean required, boolean granted) {
        // If this category isn't required, we're OK
<span class="nc bnc" id="L362" title="All 4 branches missed.">        return (!required) || granted; // If it is required, then it must also be granted</span>
    }

    // &lt;editor-fold desc=&quot;Accessors&quot;&gt;
    public Long getId() {
<span class="fc" id="L367">        return id;</span>
    }

    public void setId(Long id) {
<span class="fc" id="L371">        this.id = id;</span>
<span class="fc" id="L372">    }</span>

    public boolean isGeneralHealthConsentGranted() {
<span class="fc" id="L375">        return generalHealthConsentGranted;</span>
    }

    public void setGeneralHealthConsentGranted(boolean generalHealthConsentGranted) {
<span class="fc" id="L379">        this.generalHealthConsentGranted = generalHealthConsentGranted;</span>
<span class="fc" id="L380">    }</span>

    public boolean isSocialCareConsentGranted() {
<span class="fc" id="L383">        return socialCareConsentGranted;</span>
    }

    public void setSocialCareConsentGranted(boolean socialCareConsentGranted) {
<span class="fc" id="L387">        this.socialCareConsentGranted = socialCareConsentGranted;</span>
<span class="fc" id="L388">    }</span>

    public boolean isMentalHealthConsentGranted() {
<span class="fc" id="L391">        return mentalHealthConsentGranted;</span>
    }

    public void setMentalHealthConsentGranted(boolean mentalHealthConsentGranted) {
<span class="fc" id="L395">        this.mentalHealthConsentGranted = mentalHealthConsentGranted;</span>
<span class="fc" id="L396">    }</span>

    public boolean isSexualHealthConsentGranted() {
<span class="fc" id="L399">        return sexualHealthConsentGranted;</span>
    }

    public void setSexualHealthConsentGranted(boolean sexualHealthConsentGranted) {
<span class="fc" id="L403">        this.sexualHealthConsentGranted = sexualHealthConsentGranted;</span>
<span class="fc" id="L404">    }</span>

    public Long getAccessingTeamSlashPersonId() {
<span class="fc" id="L407">        return accessingTeamSlashPersonId;</span>
    }

    public void setAccessingTeamSlashPersonId(Long accessingTeamOrPersonId) {
<span class="fc" id="L411">        this.accessingTeamSlashPersonId = accessingTeamOrPersonId;</span>
<span class="fc" id="L412">    }</span>

    public Long getPatientPersonId() {
<span class="fc" id="L415">        return patientPersonId;</span>
    }

    public void setPatientPersonId(Long patientPersonId) {
<span class="fc" id="L419">        this.patientPersonId = patientPersonId;</span>
<span class="fc" id="L420">    }</span>

    public PatientConsentReason getReasons() {
<span class="fc" id="L423">        return reasons;</span>
    }

    public AccessingEntityType getAccessingEntityType() {
<span class="fc" id="L427">        return accessingEntityType;</span>
    }

    public void setAccessingEntityType(AccessingEntityType accessingEntityType) {
<span class="fc" id="L431">        this.accessingEntityType = accessingEntityType;</span>
<span class="fc" id="L432">    }</span>

    public UUID getUniqueId() {
<span class="fc" id="L435">        return uniqueId;</span>
    }

    public boolean isProEditOnlyForChild() {
<span class="fc" id="L439">        return proEditOnlyForChild;</span>
    }

    public void setProEditOnlyForChild(boolean proEditOnlyForChild) {
<span class="fc" id="L443">        this.proEditOnlyForChild = proEditOnlyForChild;</span>
<span class="fc" id="L444">    }</span>

    public boolean isDischarged() {
<span class="fc" id="L447">        return discharged;</span>
    }

    public void setDischarged(boolean discharged) {
<span class="fc" id="L451">        this.discharged = discharged;</span>
<span class="fc" id="L452">    }</span>

    public void setSourceDetails(Long personId, Long teamId, Long orgId, Route route, String responsibleOrganisationIdentifier) {
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">        if (reasons == null) {</span>
<span class="nc" id="L456">            reasons = new PatientConsentReason();</span>
        }

<span class="fc" id="L459">        reasons.setSource(new SourceDetails(personId, teamId, orgId, null, route, responsibleOrganisationIdentifier));</span>
<span class="fc" id="L460">    }</span>

    public Instant getAdded() {
<span class="fc" id="L463">        return added;</span>
    }

    public void setAdded(Instant added) {
<span class="fc" id="L467">        this.added = added;</span>
<span class="fc" id="L468">        this.updated = added;</span>
<span class="fc" id="L469">    }</span>

    public Instant getUpdated() {
<span class="fc" id="L472">        return updated;</span>
    }

    public void setUpdated(Instant updated) {
<span class="fc" id="L476">        this.updated = updated;</span>
<span class="fc" id="L477">    }</span>

    public boolean hasConsent(PrivacyFlag flag) {
<span class="pc bpc" id="L480" title="4 of 5 branches missed.">        switch (flag) {</span>
        case GENERAL:
<span class="fc" id="L482">            return generalHealthConsentGranted;</span>
        case SEXUAL_HEALTH:
<span class="nc" id="L484">            return sexualHealthConsentGranted;</span>
        case MENTAL_HEALTH:
<span class="nc" id="L486">            return mentalHealthConsentGranted;</span>
        case SOCIAL_CARE:
<span class="nc" id="L488">            return socialCareConsentGranted;</span>
        default:
<span class="nc" id="L490">            throw new RuntimeException(&quot;Checking non-existing privacy flag&quot;); }</span>
    }

    // &lt;/editor-fold&gt;
    public static class Builder {

<span class="fc" id="L496">        private boolean generalHealthConsentGranted = false;</span>
        private ConsentReason generalHealthConsentGrantedReason;
<span class="fc" id="L498">        private boolean socialCareConsentGranted = false;</span>
        private ConsentReason socialCareConsentGrantedReason;
<span class="fc" id="L500">        private boolean mentalHealthConsentGranted = false;</span>
        private ConsentReason mentalHealthConsentGrantedReason;
<span class="fc" id="L502">        private boolean sexualHealthConsentGranted = false;</span>
        private ConsentReason sexualHealthConsentGrantedReason;
        private Long teamId;
        private Long orgId;
        private Route route;
<span class="fc" id="L507">        private boolean discharged = false;</span>
        private Instant updated;
<span class="fc" id="L509">        private Long id = null;</span>
<span class="fc" id="L510">        private String responsibleOrganisationIdentifier = null;</span>

        // required
        private final Long consentGrantedTo;
        private final Long consentGrantedBy;
        private final Long changedBy;
        private final AccessingEntityType accessingEntityType;
        private final UUID uniqueId;
        private final Instant added;

        public Builder(Long grantedTo, Long grantedBy, Long changedBy,
                AccessingEntityType accessingEntityType, Instant added) {
<span class="fc" id="L522">            this(grantedTo, grantedBy, changedBy, accessingEntityType, added, added);</span>
<span class="fc" id="L523">        }</span>

        public Builder(Long grantedTo, Long grantedBy, Long changedBy,
<span class="fc" id="L526">                AccessingEntityType accessingEntityType, Instant added, Instant updated) {</span>
<span class="fc" id="L527">            consentGrantedTo = grantedTo;</span>
<span class="fc" id="L528">            consentGrantedBy = grantedBy;</span>
<span class="fc" id="L529">            this.changedBy = changedBy;</span>
<span class="fc" id="L530">            this.accessingEntityType = accessingEntityType;</span>
<span class="fc" id="L531">            this.uniqueId = UUID.randomUUID();</span>
<span class="fc" id="L532">            this.added = added;</span>
<span class="fc" id="L533">            this.updated = updated;</span>
<span class="fc" id="L534">        }</span>

        public Builder general(boolean granted, ConsentReason reason) {
<span class="fc" id="L537">            generalHealthConsentGranted = granted;</span>
<span class="fc" id="L538">            generalHealthConsentGrantedReason = reason;</span>
<span class="fc" id="L539">            return this;</span>
        }

        public Builder sexual(boolean granted, ConsentReason reason) {
<span class="fc" id="L543">            sexualHealthConsentGranted = granted;</span>
<span class="fc" id="L544">            sexualHealthConsentGrantedReason = reason;</span>
<span class="fc" id="L545">            return this;</span>
        }

        public Builder mental(boolean granted, ConsentReason reason) {
<span class="fc" id="L549">            mentalHealthConsentGranted = granted;</span>
<span class="fc" id="L550">            mentalHealthConsentGrantedReason = reason;</span>
<span class="fc" id="L551">            return this;</span>
        }

        public Builder social(boolean granted, ConsentReason reason) {
<span class="fc" id="L555">            socialCareConsentGranted = granted;</span>
<span class="fc" id="L556">            socialCareConsentGrantedReason = reason;</span>
<span class="fc" id="L557">            return this;</span>
        }

        public Builder teamId(Long teamId) {
<span class="nc" id="L561">            this.teamId = teamId;</span>
<span class="nc" id="L562">            return this;</span>
        }

        public Builder orgId(Long orgId) {
<span class="nc" id="L566">            this.orgId = orgId;</span>
<span class="nc" id="L567">            return this;</span>
        }

        public Builder route(Route route) {
<span class="fc" id="L571">            this.route = route;</span>
<span class="fc" id="L572">            return this;</span>
        }

        public Builder responsibleOrganisationIdentifier(String responsibleOrganisationIdentifier) {
<span class="nc" id="L576">            this.responsibleOrganisationIdentifier = responsibleOrganisationIdentifier;</span>
<span class="nc" id="L577">            return this;</span>
        }

        public Builder discharged(boolean discharged) {
<span class="nc" id="L581">            this.discharged = discharged;</span>
<span class="nc" id="L582">            return this;</span>
        }

        public Builder setAllCategories(boolean granted, ConsentReason reason) {
<span class="nc" id="L586">            return general(granted, reason)</span>
<span class="nc" id="L587">                    .mental(granted, reason)</span>
<span class="nc" id="L588">                    .sexual(granted, reason)</span>
<span class="nc" id="L589">                    .social(granted, reason);</span>
        }

        public Builder setAllCategories(ProvidesDefaultConsent provider, ConsentReason reason) {
<span class="fc" id="L593">            return general(provider.isDefaultRequestGeneral(), reason)</span>
<span class="fc" id="L594">                    .mental(provider.isDefaultRequestMentalHealth(), reason)</span>
<span class="fc" id="L595">                    .sexual(provider.isDefaultRequestSexualHealth(), reason)</span>
<span class="fc" id="L596">                    .social(provider.isDefaultRequestSocialCare(), reason);</span>
        }

        public Builder setUpdated(Instant updated) {
<span class="nc" id="L600">            this.updated = updated;</span>
<span class="nc" id="L601">            return this;</span>
        }

        public Builder id(long id) {
<span class="nc" id="L605">            this.id = id;</span>
<span class="nc" id="L606">            return this;</span>
        }

        public PatientConsent build() {
<span class="fc" id="L610">            PatientConsent patientConsent = new PatientConsent(this);</span>
<span class="fc" id="L611">            patientConsent.setId(Optional.ofNullable(id).orElse(1L));</span>
<span class="fc" id="L612">            return patientConsent;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>