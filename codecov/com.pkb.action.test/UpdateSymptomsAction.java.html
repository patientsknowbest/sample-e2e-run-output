<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UpdateSymptomsAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.test</a> &gt; <span class="el_source">UpdateSymptomsAction.java</span></div><h1>UpdateSymptomsAction.java</h1><pre class="source lang-java linenums">package com.pkb.action.test;

import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.institute.entity.Team;
import com.pkb.service.symptom.SymptomReportManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.symptom.entity.Symptom;
import com.pkb.symptom.entity.SymptomReportDTO;
import io.vavr.Tuple2;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.tuple.Pair;
import org.jetbrains.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.Serializable;
import java.time.Instant;
import java.time.ZonedDateTime;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import java.util.Map;
import java.util.NavigableMap;
import java.util.Objects;
import java.util.SortedMap;
import java.util.TreeMap;
import java.util.stream.Stream;

import static org.apache.commons.collections4.CollectionUtils.isNotEmpty;

/**
 * Action class to perform List, Add operations on {@link Symptom}
 *
 * @author Ron Newman
 *
 */
<span class="fc" id="L40">public class UpdateSymptomsAction extends BaseAction implements SymptomsListAware {</span>

    private static final long serialVersionUID = 1L;
    private static final String MY_SYMPTOMS = &quot;mySymptoms&quot;;

    private SymptomReportManager symptomReportManager;

    private List&lt;Symptom&gt; symptomTypeList;

    private List&lt;Symptom&gt; howRUsymptomTypeList;

    private List&lt;Long&gt; symptomTypeId;

    private List&lt;String&gt; resultValue;

    private List&lt;String&gt; symptomsResultSet2Value;

    // For prefilling input fields
    private String symptomDate;

    private String symptomTime;

    private Instant date;

<span class="fc" id="L64">    private final String tab = &quot;health&quot;;</span>

<span class="fc" id="L66">    private final String subTab = &quot;symptoms&quot;;</span>

    // For remembering previous display
    private String rangeName;
    private Integer rangeBegin;
    private Integer rangeEnd;
    private Integer rangeSize;
    private TeamUserManager teamUserManager;

    private Map&lt;String, List&lt;String&gt;&gt; symptomResults;

    private NavigableMap&lt;Team, List&lt;Symptom&gt;&gt; symptomsByInstitute;

<span class="fc" id="L79">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    @Override
    public String execute() {
<span class="fc" id="L83">        generateSymptomList();</span>
<span class="fc" id="L84">        return Action.SUCCESS;</span>
    }

    @Override
    public String input() {
        try {
<span class="nc" id="L90">            generateSymptomList();</span>
<span class="nc" id="L91">        } catch (RuntimeException e) {</span>
<span class="nc" id="L92">            LOGGER.error(&quot;&quot;, e);</span>
<span class="nc" id="L93">        }</span>
<span class="nc" id="L94">        return Action.SUCCESS;</span>
    }

    public String cancel() {
        try {
<span class="nc" id="L99">            generateSymptomList();</span>
<span class="nc" id="L100">        } catch (RuntimeException e) {</span>
<span class="nc" id="L101">            LOGGER.error(&quot;&quot;, e);</span>
<span class="nc" id="L102">        }</span>
<span class="nc" id="L103">        return MY_SYMPTOMS;</span>
    }

    public String save() {
<span class="fc" id="L107">        long patientId = contextUserUtil.getContextOrLoggedInUserId();</span>
        try {
<span class="fc" id="L109">            LOGGER.trace(&quot;Called save() in UpdateSymptomsAction for patient-{}&quot;, patientId);</span>
<span class="fc" id="L110">            generateSymptomList();</span>
<span class="fc" id="L111">            var validZonedDateTime = validateSymptomDateTime();</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">            if (validZonedDateTime == null) {</span>
<span class="fc" id="L113">                return Action.SUCCESS;</span>
            }
<span class="fc" id="L115">            date = validZonedDateTime.toInstant();</span>

<span class="pc bpc" id="L117" title="2 of 4 branches missed.">            if (symptomResults == null &amp;&amp; symptomsResultSet2Value == null) {</span>
<span class="nc" id="L118">                addActionError(getText(&quot;updateSymptomsAction.err.select_severity&quot;));</span>
<span class="nc" id="L119">                return Action.SUCCESS;</span>
            }

<span class="fc" id="L122">            List&lt;SymptomReportDTO&gt; dtoList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L123">            processSymptomReportDtoListFromUI(symptomsResultSet2Value, date).forEach(dtoList::add);</span>
            // NOTE: The following method had been commented because
            // any institute specific symptom clicked will reflect in values
            // of other symptoms which is a super set hence just processing
            // resultSet2Value is enough
            //processSymptomReportDtoListFromUI(symptomResults).forEach(dtoList::add);

<span class="fc" id="L130">            symptomReportManager.saveSymptomReports(getLoggedInEHRRequestContext(), dtoList, patientId);</span>

            try {
<span class="fc" id="L133">                boolean once = true;</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">                for (Team team : symptomReportManager.getTeamsWithActiveAlarms(patientId)) {</span>
<span class="pc bpc" id="L135" title="1 of 2 branches missed.">                    if (once) {</span>
<span class="fc" id="L136">                        addActionMessage(getText(&quot;dashboard.txt.check_care_plans&quot;));</span>
<span class="fc" id="L137">                        once = false;</span>
                    }
<span class="fc" id="L139">                    LOGGER.info(&quot;Symptom Alarm triggered for patient-{} being treated by {} at {}&quot;, patientId, team.getName(), team.getOrg().getName());</span>
<span class="fc" id="L140">                }</span>
<span class="nc" id="L141">            } catch (Exception e) {</span>
<span class="nc" id="L142">                LOGGER.error(&quot;Exception while checking for active symptom alarms for patient-{}&quot;, patientId, e);</span>
<span class="fc" id="L143">            }</span>

<span class="nc" id="L145">        } catch (RuntimeException e) {</span>
<span class="nc" id="L146">            LOGGER.error(&quot;Failed saving new symptom report for patient-{}&quot;, patientId, e);</span>
<span class="nc" id="L147">            addActionMessage(getText(&quot;updateSymptomsAction.err.error_saving&quot;));</span>
<span class="nc" id="L148">            throw new RuntimeException(e);</span>
<span class="fc" id="L149">        }</span>
<span class="fc" id="L150">        addActionMessage(getText(&quot;updateSymptomsAction.err.saved_symptoms&quot;));</span>

<span class="fc" id="L152">        return MY_SYMPTOMS;</span>
    }

    private void generateSymptomList() {
<span class="fc" id="L156">        symptomTypeList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L157">        generateOtherSymptoms();</span>
<span class="fc" id="L158">        generateInstituteSymptoms();</span>
<span class="fc" id="L159">    }</span>

    private void generateInstituteSymptoms() {
<span class="fc" id="L162">        long userId = contextUserUtil.getContextOrLoggedInUserId();</span>

        // find the patient welcome message set up by the institute
<span class="fc" id="L165">        List&lt;Team&gt; institutes = teamUserManager.getUserTeams(getEHRRequestContext(), userId, true);</span>
<span class="fc" id="L166">        symptomsByInstitute = new TreeMap&lt;&gt;(new InstituteComparator());</span>

<span class="fc bfc" id="L168" title="All 2 branches covered.">        for (Team team : institutes) {</span>
<span class="fc" id="L169">            List&lt;Symptom&gt; forInstitute = symptomReportManager.getSymptomsMonitoredByTeam(getEHRRequestContext(), team.getCode());</span>
<span class="fc" id="L170">            forInstitute = lexicographicalSortWithI18n(forInstitute);</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">            if (isNotEmpty(forInstitute)) {</span>
<span class="fc" id="L172">                symptomsByInstitute.put(team, forInstitute);</span>
            }
<span class="fc" id="L174">        }</span>

        //if no entries, reset back to null - required by dashboard.jsp
<span class="fc bfc" id="L177" title="All 2 branches covered.">        if (symptomsByInstitute.isEmpty()) {</span>
<span class="fc" id="L178">            symptomsByInstitute = null;</span>
        }
<span class="fc" id="L180">    }</span>

    private void generateOtherSymptoms() {
<span class="fc" id="L183">        Collections.addAll(symptomTypeList, Symptom.values());</span>
<span class="fc" id="L184">        symptomTypeList = lexicographicalSortWithI18n(symptomTypeList);</span>
<span class="fc" id="L185">    }</span>

    private List&lt;Symptom&gt; lexicographicalSortWithI18n(Collection&lt;Symptom&gt; symptoms) {
<span class="fc" id="L188">        SortedMap&lt;String, Symptom&gt; ret = new TreeMap&lt;&gt;(String::compareToIgnoreCase);</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">        for (Symptom s : symptoms) {</span>
<span class="fc" id="L190">            ret.put(getText(s.getName()), s);</span>
<span class="fc" id="L191">        }</span>
<span class="fc" id="L192">        return new ArrayList&lt;&gt;(ret.values());</span>
    }

    @Nullable
    private ZonedDateTime validateSymptomDateTime() {
<span class="fc" id="L197">        return getDateTimeNotInPastOrAddFieldError(Pair.of(&quot;symptomDate&quot;, symptomDate),</span>
<span class="fc" id="L198">                Pair.of(&quot;symptomTime&quot;, symptomTime));</span>
    }

    @Override
    public String getCustomStyle() {
<span class="fc" id="L203">        return MOBILE_OPTIMIZED_STYLE;</span>
    }

    public Instant getDate() {
<span class="nc" id="L207">        return date;</span>
    }

    public void setDate(Instant date) {
<span class="nc" id="L211">        this.date = date;</span>
<span class="nc" id="L212">    }</span>

    public void setSymptomDate(String symptomDate) {
<span class="fc" id="L215">        this.symptomDate = symptomDate;</span>
<span class="fc" id="L216">    }</span>

    public String getSymptomDate() {
<span class="fc" id="L219">        return symptomDate;</span>
    }

    public List&lt;Symptom&gt; getSymptomTypeList() {
<span class="fc" id="L223">        return symptomTypeList;</span>
    }

    public void setSymptomReportManager(SymptomReportManager symptomReportManager) {
<span class="fc" id="L227">        this.symptomReportManager = symptomReportManager;</span>
<span class="fc" id="L228">    }</span>

    public List&lt;String&gt; getResultValue() {
<span class="nc" id="L231">        return resultValue;</span>
    }

    public void setResultValue(List&lt;String&gt; resultValue) {
<span class="nc" id="L235">        this.resultValue = resultValue;</span>
<span class="nc" id="L236">    }</span>

    @Override
    public List&lt;String&gt; getSymptomsResultSet2Value() {
<span class="fc" id="L240">        return symptomsResultSet2Value;</span>
    }

    public void setSymptomsResultSet2Value(List&lt;String&gt; symptomsResultSet2Value) {
<span class="fc" id="L244">        this.symptomsResultSet2Value = symptomsResultSet2Value;</span>
<span class="fc" id="L245">    }</span>

    public List&lt;Long&gt; getSymptomTypeId() {
<span class="nc" id="L248">        return symptomTypeId;</span>
    }

    public void setSymptomTypeId(List&lt;Long&gt; symptomTypeId) {
<span class="nc" id="L252">        this.symptomTypeId = symptomTypeId;</span>
<span class="nc" id="L253">    }</span>

    public String getTab() {
<span class="fc" id="L256">        return tab;</span>
    }

    public String getSubTab() {
<span class="fc" id="L260">        return subTab;</span>
    }

    public String getRangeName() {
<span class="nc" id="L264">        return rangeName;</span>
    }

    public void setRangeName(String rangeName) {
<span class="nc" id="L268">        this.rangeName = rangeName;</span>
<span class="nc" id="L269">    }</span>

    public Integer getRangeBegin() {
<span class="nc" id="L272">        return rangeBegin;</span>
    }

    public void setRangeBegin(Integer rangeBegin) {
<span class="nc" id="L276">        this.rangeBegin = rangeBegin;</span>
<span class="nc" id="L277">    }</span>

    public Integer getRangeEnd() {
<span class="nc" id="L280">        return rangeEnd;</span>
    }

    public void setRangeEnd(Integer rangeEnd) {
<span class="nc" id="L284">        this.rangeEnd = rangeEnd;</span>
<span class="nc" id="L285">    }</span>

    public Integer getRangeSize() {
<span class="nc" id="L288">        return rangeSize;</span>
    }

    public void setRangeSize(Integer rangeSize) {
<span class="nc" id="L292">        this.rangeSize = rangeSize;</span>
<span class="nc" id="L293">    }</span>

    public void setHowRUsymptomTypeList(List&lt;Symptom&gt; howRUsymptomTypeList) {
<span class="nc" id="L296">        this.howRUsymptomTypeList = howRUsymptomTypeList;</span>
<span class="nc" id="L297">    }</span>

    public List&lt;Symptom&gt; getHowRUsymptomTypeList() {
<span class="nc" id="L300">        return howRUsymptomTypeList;</span>
    }

    public NavigableMap&lt;Team, List&lt;Symptom&gt;&gt; getSymptomsByInstitute() {
<span class="fc" id="L304">        return symptomsByInstitute;</span>
    }

    public void setSymptomsByInstitute(NavigableMap&lt;Team, List&lt;Symptom&gt;&gt; symptomsByInstitute) {
<span class="nc" id="L308">        this.symptomsByInstitute = symptomsByInstitute;</span>
<span class="nc" id="L309">    }</span>

    public TeamUserManager getTeamUserManager() {
<span class="nc" id="L312">        return teamUserManager;</span>
    }

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L316">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L317">    }</span>

    public SymptomReportManager getSymptomReportManager() {
<span class="nc" id="L320">        return symptomReportManager;</span>
    }

    public Map&lt;String, List&lt;String&gt;&gt; getSymptomResults() {
<span class="nc" id="L324">        return symptomResults;</span>
    }

    public void setSymptomResults(Map&lt;String, List&lt;String&gt;&gt; symptomResults) {
<span class="nc" id="L328">        this.symptomResults = symptomResults;</span>
<span class="nc" id="L329">    }</span>

    public String getSymptomTime() {
<span class="fc" id="L332">        return symptomTime;</span>
    }

    public void setSymptomTime(String symptomTime) {
<span class="fc" id="L336">        this.symptomTime = symptomTime;</span>
<span class="fc" id="L337">    }</span>

<span class="fc" id="L339">    private class InstituteComparator implements Comparator&lt;Team&gt;, Serializable {</span>

        @Override
        public int compare(Team left, Team right) {
<span class="fc" id="L343">            String name1 = left.getName();</span>
<span class="fc" id="L344">            String name2 = right.getName();</span>
<span class="fc" id="L345">            return name1.compareToIgnoreCase(name2);</span>
        }
    }

    @Override
    public void prepare() throws Exception {
<span class="fc" id="L351">        super.prepare();</span>
<span class="pc bpc" id="L352" title="2 of 4 branches missed.">        if (symptomDate == null &amp;&amp; symptomTime == null) {</span>
<span class="fc" id="L353">            Tuple2&lt;String, String&gt; currentDateAndTime = getCurrentDateAndTime();</span>
<span class="fc" id="L354">            symptomDate = currentDateAndTime._1;</span>
<span class="fc" id="L355">            symptomTime = currentDateAndTime._2;</span>
        }
<span class="fc" id="L357">    }</span>

    private Stream&lt;SymptomReportDTO&gt; processSymptomReportDtoListFromUI(List&lt;String&gt; userInputValues, Instant reportDate) {
<span class="pc bpc" id="L360" title="1 of 2 branches missed.">        if (CollectionUtils.isEmpty(userInputValues)) {</span>
<span class="nc" id="L361">            return Stream.empty();</span>
        }
<span class="fc" id="L363">        return userInputValues.stream()</span>
<span class="fc" id="L364">                .filter(Objects::nonNull)</span>
<span class="fc" id="L365">                .map(value -&gt; convertToSymptomReportDto(value, reportDate));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>