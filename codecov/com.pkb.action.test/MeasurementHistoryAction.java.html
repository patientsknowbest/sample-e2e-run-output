<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MeasurementHistoryAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.test</a> &gt; <span class="el_source">MeasurementHistoryAction.java</span></div><h1>MeasurementHistoryAction.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------

//
// Copyright (c) 2011 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: $
//
//------------------------------------------------------------------------------

package com.pkb.action.test;


import com.pkb.action.BaseAction;
import com.pkb.action.message.ComposeMessageAction;
import com.pkb.action.support.MeasurementHistoryTransformer;
import com.pkb.bean.IMessageWebBean;
import com.pkb.dto.MeasurementEntryDto;
import com.pkb.mappers.EntityDependency;
import com.pkb.mappers.ImmutableEntityDependency;
import com.pkb.mappers.MeasurementEntryMapper;
import com.pkb.service.datapoint.DataWithUIPermissions;
import com.pkb.service.test.MeasurementManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.test.entity.MeasurementDTO;
import com.pkb.test.entity.MeasurementHistoryDTO;
import com.pkb.test.entity.MeasurementTypeId;
import com.pkb.user.entity.PKBPerson;
import io.vavr.control.Option;
import org.jetbrains.annotations.NotNull;
import org.springframework.beans.factory.annotation.Autowired;

import java.util.ArrayList;
import java.util.List;

import static java.util.stream.Collectors.toList;

/**
 * Shows detailed results this user has uploaded into their account for a selected measurement
 *
 * @author robwhelan
 */
<span class="fc" id="L42">public class MeasurementHistoryAction extends BaseAction {</span>

    private static final long serialVersionUID = 1L;

    private static final String BACK_TO_MY_MEASUREMENTS = &quot;backToMyMeasurements&quot;;

    private MeasurementHistoryDTO measurementHistory;

    private long currentTimestamp;

    private boolean moreThanDefaultFetch;
    private boolean moreToCome;

    // This contains the `.toString()` result of a MeasurementTypeId value.
    // As of 2022-03-21, this is a hex-encoded json serialization of the value.
    // One can quickly see the json with hex-decoding the string value,
    // eg ` echo 5b226c656674222c32305d | sed 's/../\\\\x&amp;/g' | xargs echo -e `
    private String measurementTypeId;

    private int gender;

    private Long selectId;

    private Long deleteId;

    private List&lt;MeasurementDTO&gt; deleteMeasurementList;

    private MeasurementManager measurementManager;

    private IMessageWebBean messageWebBean;

<span class="fc" id="L73">    private final String tab = &quot;health&quot;;</span>

<span class="fc" id="L75">    private final String subTab = &quot;measurements&quot;;</span>

<span class="fc" id="L77">    private String customStyle = MOBILE_OPTIMIZED_STYLE;</span>

    private PKBPerson patient;

    private String discussMessage;

    private String discussTopic;

    private MeasurementUtil measurementUtil;

    private List&lt;MeasurementEntryDto&gt; measurementEntryDtos;

    @Autowired
    private MeasurementHistoryTransformer measurementHistoryTransformer;

    @Autowired
    private MeasurementEntryMapper measurementEntryMapper;

    /**
     * get full list of values from Tolven for the given measurement
     */
    @Override
    public String execute() {

<span class="fc" id="L101">        currentTimestamp = dateTimeService.now().toEpochMilli();</span>

<span class="fc" id="L103">        patient = userManager.getPKBPerson(patientId());</span>

<span class="fc" id="L105">        Option&lt;MeasurementHistoryDTO&gt; historyMaybe = measurementManager.getMeasurementHistory(getLoggedInEHRRequestContext(), MeasurementTypeId.ofString(measurementTypeId),</span>
<span class="fc" id="L106">                patientId(), config.getMeasurementHistoryDefaultFetchSize(), loggedInUserUtil.getLoggedInPerson());</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">        if (historyMaybe.isEmpty()) {</span>
<span class="fc" id="L108">            return BACK_TO_MY_MEASUREMENTS;</span>
        } else {
<span class="fc" id="L110">            MeasurementHistoryDTO history = historyMaybe.get();</span>
<span class="fc" id="L111">            setMeasurementHistory(measurementHistoryTransformer.transformMeasurementHistory(history, loggedInUserUtil.getLoggedInUserZoneId()));</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">            moreToCome = (history.getMeasurementList().size() == config.getMeasurementHistoryDefaultFetchSize());</span>
<span class="fc" id="L113">            updateMoreThanDefaultFetch(history);</span>
<span class="fc" id="L114">            updateMeasurementEntryDtos(history.getMeasurementList());</span>
<span class="fc" id="L115">            return SUCCESS;</span>
        }
    }

    private long patientId() {
<span class="fc" id="L120">        return contextUserUtil.getContextOrLoggedInUserId();</span>
    }

    // Quick fix for UMC
    public String loadAll() {

<span class="fc" id="L126">        currentTimestamp = dateTimeService.now().toEpochMilli();</span>

<span class="fc" id="L128">        Option&lt;MeasurementHistoryDTO&gt; historyMaybe = measurementManager.getMeasurementHistory(getLoggedInEHRRequestContext(), MeasurementTypeId.ofString(measurementTypeId),</span>
<span class="fc" id="L129">                patientId(), 0, loggedInUserUtil.getLoggedInPerson());</span>
<span class="fc" id="L130">        setMeasurementHistory(historyMaybe.map(history -&gt; measurementHistoryTransformer.transformMeasurementHistory(history, loggedInUserUtil.getLoggedInUserZoneId())).getOrNull());</span>
<span class="fc" id="L131">        moreToCome = false;</span>
<span class="fc" id="L132">        historyMaybe.forEach(history -&gt; {</span>
<span class="fc" id="L133">            updateMoreThanDefaultFetch(history);</span>
<span class="fc" id="L134">            updateMeasurementEntryDtos(history.getMeasurementList());</span>
<span class="fc" id="L135">        });</span>
<span class="fc" id="L136">        return SUCCESS;</span>
    }

    public String discussMeasurements() {
<span class="fc" id="L140">        Option&lt;MeasurementHistoryDTO&gt; historyMaybe = measurementManager.getMeasurementHistory(getLoggedInEHRRequestContext(), MeasurementTypeId.ofString(measurementTypeId),</span>
<span class="fc" id="L141">                patientId(), 0, loggedInUserUtil.getLoggedInPerson());</span>

<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        if(historyMaybe.isEmpty()) {</span>
<span class="nc" id="L144">            return RELOAD;</span>
        } else {
<span class="fc" id="L146">            MeasurementHistoryDTO history = historyMaybe.get();</span>

<span class="fc" id="L148">            StringBuilder msgBody = new StringBuilder(&quot;\n\n\n&quot; + getText(&quot;measurementHistoryAction.err.selected_measurement&quot;,</span>
<span class="fc" id="L149">                    new String[]{getText(history.getMeasurementType().displayName())}));</span>

<span class="fc" id="L151">            history.findMeasurement(selectId)</span>
<span class="fc" id="L152">                    .ifPresent(measurement -&gt; msgBody.append(&quot;\n&quot;)</span>
<span class="fc" id="L153">                            .append(measurementUtil.measurementToString(measurement, history.getMeasurementType(), getLocale(), loggedInUserUtil.getLoggedInUserZoneId())));</span>

<span class="fc" id="L155">            discussMessage = msgBody.toString();</span>
<span class="fc" id="L156">            discussTopic = ComposeMessageAction.TOPIC_MEASUREMENTS;</span>

            // Future option: attach source file as attachment?  sparkline to give context?

<span class="fc" id="L160">            sessionUtil.setContextRecipientId(getLoggedInEHRRequestContext());</span>

<span class="fc" id="L162">            return DISCUSS;</span>
        }
    }

    public String deleteMeasurements() {
<span class="fc" id="L167">        var historyMaybe = loadHistory();</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">        if(historyMaybe.isEmpty()) {</span>
<span class="nc" id="L169">            return RELOAD;</span>
        } else {
<span class="fc" id="L171">            var history = historyMaybe.get();</span>

<span class="fc" id="L173">            List&lt;Long&gt; idsToDelete = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L174">            idsToDelete.add(selectId);</span>
<span class="fc" id="L175">            idsToDelete.addAll(history.findMeasurement(selectId)</span>
<span class="fc" id="L176">                        .map(measurementToDelete -&gt; history.getHiddenMeasurementList().stream()</span>
<span class="fc" id="L177">                                .filter(measurement -&gt; measurement.isUpdatedBy(measurementToDelete))</span>
<span class="fc" id="L178">                                .map(MeasurementDTO::getId)</span>
<span class="fc" id="L179">                                .collect(toList()))</span>
<span class="fc" id="L180">                    .orElse(new ArrayList&lt;&gt;())</span>
            );
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">            if (!idsToDelete.isEmpty()) {</span>
<span class="fc" id="L183">                measurementManager.deleteMeasurements(idsToDelete, getLoggedInEHRRequestContext());</span>
<span class="fc" id="L184">                LOGGER.info(&quot;Measurements {} deleted for measurement {} and patient {}&quot;, idsToDelete, selectId, contextUserUtil.getContextOrLoggedInUserId());</span>
            }

<span class="fc" id="L187">            addActionMessage(getText(&quot;measurementHistoryAction.txt.deletion_complete&quot;));</span>
<span class="fc" id="L188">            return RELOAD;</span>
        }
    }

    public String deleteMeasurement() {
<span class="pc bpc" id="L193" title="2 of 4 branches missed.">        if ((getDeleteId() != null) &amp;&amp; (getDeleteId() != 0)) {</span>
<span class="fc" id="L194">            var historyMaybe = loadHistory();</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">            if(historyMaybe.isEmpty()) {</span>
<span class="nc" id="L196">                return RELOAD;</span>
            } else {
<span class="fc" id="L198">                var history = historyMaybe.get();</span>
<span class="fc" id="L199">                setMeasurementHistory(measurementHistoryTransformer.transformMeasurementHistory(history, loggedInUserUtil.getLoggedInUserZoneId()));</span>
<span class="fc" id="L200">                setDeleteMeasurementList(history.findMeasurement(getDeleteId()).stream().collect(toList()));</span>
<span class="fc" id="L201">                customStyle = NO_CUSTOM_STYLE;</span>

<span class="fc" id="L203">                return &quot;deleteMeasurementsConfirm&quot;;</span>
            }
        }

<span class="nc" id="L207">        return RELOAD;</span>
    }

    @Override
    public String getCustomStyle() {
<span class="fc" id="L212">        return customStyle;</span>
    }

    private List&lt;DataWithUIPermissions&lt;MeasurementDTO&gt;&gt; getWithUIPermissions(List&lt;MeasurementDTO&gt; measurements) {
<span class="fc" id="L216">        return dataPointManager.getPermissions(measurements, loggedInUserUtil.getLoggedInUser(),</span>
<span class="fc" id="L217">                loggedInUserUtil.getLoggedInUserPrimaryTeam());</span>
    }

    private void updateMoreThanDefaultFetch(MeasurementHistoryDTO history) {
<span class="fc bfc" id="L221" title="All 2 branches covered.">        moreThanDefaultFetch =  history.getMeasurementList().size() &gt;= config.getMeasurementHistoryDefaultFetchSize();</span>
<span class="fc" id="L222">    }</span>

    private void updateMeasurementEntryDtos(List&lt;MeasurementDTO&gt; measurementList) {
<span class="fc" id="L225">        measurementEntryDtos = measurementEntryMapper.entitiesToDtos(getWithUIPermissions(measurementList),</span>
<span class="fc" id="L226">                buildMeasurementEntityDependency());</span>
<span class="fc" id="L227">    }</span>

    @NotNull
    private EntityDependency&lt;MeasurementDTO&gt; buildMeasurementEntityDependency() {
<span class="fc" id="L231">        return ImmutableEntityDependency.&lt;MeasurementDTO&gt; builder()</span>
<span class="fc" id="L232">                .locale(getLocale())</span>
<span class="fc" id="L233">                .loggedInRequestContext(getLoggedInEHRRequestContext())</span>
<span class="fc" id="L234">                .iOSDevice(userAgentAnalyzerBean.isAnIOSDevice())</span>
<span class="fc" id="L235">                .build();</span>
    }

    public String cancelDelete() {

<span class="fc" id="L240">        return RELOAD;</span>
    }

    private Option&lt;MeasurementHistoryDTO&gt; loadHistory() {
<span class="fc" id="L244">        return measurementManager.getMeasurementHistory(getLoggedInEHRRequestContext(), MeasurementTypeId.ofString(measurementTypeId),</span>
<span class="fc" id="L245">                contextUserUtil.getContextOrLoggedInUserId(), 0, loggedInUserUtil.getLoggedInPerson());</span>
    }

    public String getDobString() {
<span class="fc" id="L249">        return patient.getDateOfBirthString();</span>
    }

    public String getTab() {
<span class="fc" id="L253">        return tab;</span>
    }

    public Long getSelectId() {
<span class="nc" id="L257">        return selectId;</span>
    }

    public void setSelectId(Long selectResultId) {
<span class="fc" id="L261">        this.selectId = selectResultId;</span>
<span class="fc" id="L262">    }</span>

    public IMessageWebBean getMessageWebBean() {
<span class="fc" id="L265">        return messageWebBean;</span>
    }

    public void setMessageWebBean(IMessageWebBean messageWebBean) {
<span class="fc" id="L269">        this.messageWebBean = messageWebBean;</span>
<span class="fc" id="L270">    }</span>

    public UserManager getUserManager() {
<span class="nc" id="L273">        return userManager;</span>
    }

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L277">        this.userManager = userManager;</span>
<span class="fc" id="L278">    }</span>

    public MeasurementHistoryDTO getMeasurementHistory() {
<span class="fc" id="L281">        return measurementHistory;</span>
    }

    public void setMeasurementHistory(MeasurementHistoryDTO measurementHistory) {
<span class="fc" id="L285">        this.measurementHistory = measurementHistory;</span>
<span class="fc" id="L286">    }</span>

    public String getMeasurementTypeId() {
<span class="fc" id="L289">        return measurementTypeId;</span>
    }

    public void setMeasurementTypeId(String measurementTypeId) {
<span class="fc" id="L293">        this.measurementTypeId = measurementTypeId;</span>
<span class="fc" id="L294">    }</span>

    public int getGender() {
<span class="fc" id="L297">        return patient.getGender();</span>
    }

    public int getAge() {
<span class="nc" id="L301">        return personHelper.calculateAge(patient).orElse(0);</span>
    }

    public List&lt;MeasurementDTO&gt; getDeleteMeasurementList() {
<span class="fc" id="L305">        return deleteMeasurementList;</span>
    }

    public void setDeleteMeasurementList(List&lt;MeasurementDTO&gt; deleteResultList) {
<span class="fc" id="L309">        this.deleteMeasurementList = deleteResultList;</span>
<span class="fc" id="L310">    }</span>

    public String getSubTab() {
<span class="fc" id="L313">        return subTab;</span>
    }

    public void setMeasurementManager(MeasurementManager measurementManager) {
<span class="fc" id="L317">        this.measurementManager = measurementManager;</span>
<span class="fc" id="L318">    }</span>

    public Long getDeleteId() {
<span class="fc" id="L321">        return deleteId;</span>
    }

    public void setDeleteId(Long deleteId) {
<span class="fc" id="L325">        this.deleteId = deleteId;</span>
<span class="fc" id="L326">    }</span>

    public boolean isMoreToCome() {
<span class="fc" id="L329">        return moreToCome;</span>
    }

    public boolean isMoreThanDefaultFetch() {
<span class="fc" id="L333">        return moreThanDefaultFetch;</span>
    }

    public String getDiscussMessage() {
<span class="fc" id="L337">        return discussMessage;</span>
    }

    public void setDiscussMessage(String discussMessage) {
<span class="nc" id="L341">        this.discussMessage = discussMessage;</span>
<span class="nc" id="L342">    }</span>

    public String getDiscussTopic() {
<span class="fc" id="L345">        return discussTopic;</span>
    }

    public void setDiscussTopic(String discussTopic) {
<span class="nc" id="L349">        this.discussTopic = discussTopic;</span>
<span class="nc" id="L350">    }</span>

    public void setMeasurementUtil(MeasurementUtil measurementUtil) {
<span class="fc" id="L353">        this.measurementUtil = measurementUtil;</span>
<span class="fc" id="L354">    }</span>

    public int getDefaultFetchSize() {
<span class="fc" id="L357">        return getConfig().getMeasurementHistoryDefaultFetchSize();</span>
    }

    public long getCurrentTimestamp() {
<span class="fc" id="L361">        return currentTimestamp;</span>
    }

    public void setCurrentTimestamp(long currentTimestamp) {
<span class="nc" id="L365">        this.currentTimestamp = currentTimestamp;</span>
<span class="nc" id="L366">    }</span>

    public List&lt;MeasurementEntryDto&gt; getMeasurementEntryDtos() {
<span class="fc" id="L369">        return measurementEntryDtos;</span>
    }

    public void setMeasurementEntryDtos(List&lt;MeasurementEntryDto&gt; measurementEntryDtos) {
<span class="nc" id="L373">        this.measurementEntryDtos = measurementEntryDtos;</span>
<span class="nc" id="L374">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>