<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SymptomsAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.test</a> &gt; <span class="el_source">SymptomsAction.java</span></div><h1>SymptomsAction.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------
//
// Copyright (c) 2011 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: $
//
//------------------------------------------------------------------------------

package com.pkb.action.test;

import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.app.dto.DateFilterDTO;
import com.pkb.institute.entity.Team;
import com.pkb.service.symptom.SymptomReportManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.symptom.entity.Symptom;
import com.pkb.symptom.entity.SymptomReportHistoryDTO;
import com.pkb.util.ChartHeading;
import com.pkb.util.SymptomChart;
import com.pkb.util.TimelineChartUtil;
import com.pkb.util.TimelineChartUtil.RangeDetails;
import org.springframework.beans.factory.annotation.Autowired;

import java.time.LocalDate;
import java.time.ZoneId;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.GregorianCalendar;
import java.util.List;

import static com.pkb.util.TimelineChartUtil.Period;
import static java.time.temporal.ChronoUnit.DAYS;

/**
 * Shows overview of symptoms this user has reported.
 *
 * @author ronnewman
 */

<span class="fc" id="L41">public class SymptomsAction extends BaseAction {</span>

    private static final long serialVersionUID = 1L;

    private SymptomReportManager symptomReportManager;

    // Each has a symptom name, and a call getSeverityXdaysAgo()
    private List&lt;SymptomReportHistoryDTO&gt; symptomHistoryList;

    private List&lt;SymptomChart&gt; charts;

<span class="fc" id="L52">    private final String tab = &quot;health&quot;;</span>

<span class="fc" id="L54">    private final String subTab = &quot;symptoms&quot;;</span>

    private String rangeWanted;

    private String rangeName;

    private Period period;

    private Integer periodsToDisplay;

    private Integer periodsBack;

    private RangeDetails rangeDetails;

    private Calendar firstDayOfRange;

    private Calendar lastDayOfRange;

    private LocalDate dateOfLastSymptom;
    @Autowired
    private TimelineChartUtil timelineChartUtil;

    /**
     * grab list of symptoms for the past [time period]
     */
    @Override
    public String execute() {
<span class="fc" id="L81">        long patientId = contextUserUtil.getContextOrLoggedInUserId();</span>

<span class="fc" id="L83">        dateOfLastSymptom = symptomReportManager.getDateOfLatestSymptom(patientId).orElse(null);</span>

<span class="fc" id="L85">        rangeDetails = RangeDetails.base().update(rangeWanted);</span>

<span class="fc" id="L87">        setDateRange(rangeDetails);</span>
<span class="fc" id="L88">        List&lt;ChartHeading&gt; chartHeadings = timelineChartUtil.populateChartHeadings(firstDayOfRange, lastDayOfRange,</span>
<span class="fc" id="L89">                rangeDetails.getRange(), getLocale(), false);</span>

        // there's one history DTO per symptom; inside that is the list of reports.
<span class="fc" id="L92">        symptomHistoryList = symptomReportManager.getSymptomReportHistoryList(getLoggedInEHRRequestContext(), patientId, new DateFilterDTO(firstDayOfRange.toInstant(), null), 0);</span>
<span class="fc" id="L93">        symptomHistoryList.sort((s1, s2) -&gt; getText(s1.getSymptom().getName()).compareToIgnoreCase(getText(s2.getSymptom().getName())));</span>

<span class="fc" id="L95">        charts = new ArrayList&lt;&gt;();</span>
        SymptomChart chart;

<span class="fc" id="L98">        ZoneId localZone = getDateAtTimeOutputFormatter().getZone();</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">        if (isLoggedInUserProfessional()) {</span>
<span class="fc" id="L100">            Team team = loggedInUserUtil.getLoggedInUserPrimaryTeam(getEHRRequestContext());</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">            if (team != null) {</span>
<span class="fc" id="L102">                List&lt;Symptom&gt; teamSymptoms = symptomReportManager.getSymptomsMonitoredByTeam(getEHRRequestContext(), team.getCode());</span>

<span class="pc bpc" id="L104" title="1 of 4 branches missed.">                if ((teamSymptoms != null) &amp;&amp; !teamSymptoms.isEmpty()) {</span>
<span class="fc" id="L105">                    List&lt;SymptomReportHistoryDTO&gt; symptoms = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">                    for (SymptomReportHistoryDTO dto : symptomHistoryList) {</span>
<span class="fc bfc" id="L107" title="All 2 branches covered.">                        if (teamSymptoms.contains(dto.getSymptom())) {</span>
<span class="fc" id="L108">                            symptoms.add(dto);</span>
                        }
<span class="fc" id="L110">                    }</span>

<span class="fc" id="L112">                    chart = new SymptomChart();</span>
<span class="fc" id="L113">                    chart.setTeamName(getText(&quot;mySymptoms.txt.team_symptoms&quot;, new String[]{team.getName()}));</span>
<span class="fc" id="L114">                    chart.setChartHeadings(chartHeadings);</span>
<span class="fc" id="L115">                    chart.setChartRows(</span>
<span class="fc" id="L116">                            timelineChartUtil.populateSymptomRows(firstDayOfRange, lastDayOfRange,</span>
<span class="fc" id="L117">                                    rangeDetails.getRange(), symptoms, getLocale(), localZone));</span>
<span class="fc" id="L118">                    charts.add(chart);</span>
                }
            }
        }

<span class="fc" id="L123">        chart = new SymptomChart();</span>
<span class="fc" id="L124">        chart.setChartHeadings(chartHeadings);</span>
<span class="fc" id="L125">        chart.setChartRows(</span>
<span class="fc" id="L126">                timelineChartUtil.populateSymptomRows(firstDayOfRange, lastDayOfRange, rangeDetails.getRange(),</span>
<span class="fc" id="L127">                        symptomHistoryList, getLocale(), localZone));</span>
<span class="fc" id="L128">        charts.add(chart);</span>

<span class="fc" id="L130">        return Action.SUCCESS;</span>
    }

    public UserManager getUserManager() {
<span class="nc" id="L134">        return userManager;</span>
    }

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L138">        this.userManager = userManager;</span>
<span class="fc" id="L139">    }</span>

    /**
     * @see TimelineChartUtil.getLastDateOfRange and getFirstDayOfRange() ! this should just use those calls...
     * by default: end of range is today (or some offset), not the late reported symptom. Too confusing.
     */
    private void setDateRange(RangeDetails rangeDetails) {
<span class="fc" id="L146">        Calendar today = GregorianCalendar.from(dateTimeService.nowZonedDateTime().truncatedTo(DAYS));</span>

<span class="fc" id="L148">        lastDayOfRange = new GregorianCalendar(today.getTimeZone());</span>
<span class="fc" id="L149">        lastDayOfRange.setTime(today.getTime());</span>

<span class="pc bpc" id="L151" title="2 of 4 branches missed.">        switch (rangeDetails.getPeriod()) {</span>
            case MONTH:
<span class="pc bpc" id="L153" title="1 of 2 branches missed.">                for (int i = 0; i &lt; rangeDetails.getPeriodsBack(); ++i) {</span>
<span class="nc" id="L154">                    lastDayOfRange.add(Calendar.MONTH, -1);</span>
                }
<span class="fc" id="L156">                break;</span>
            case SIXMONTHS:
<span class="fc bfc" id="L158" title="All 2 branches covered.">                for (int i = 0; i &lt; rangeDetails.getPeriodsBack(); ++i) {</span>
<span class="fc" id="L159">                    lastDayOfRange.add(Calendar.MONTH, -6);</span>
                }
<span class="fc" id="L161">                break;</span>
            case YEAR:
<span class="nc bnc" id="L163" title="All 2 branches missed.">                for (int i = 0; i &lt; rangeDetails.getPeriodsBack(); ++i) {</span>
<span class="nc" id="L164">                    lastDayOfRange.add(Calendar.YEAR, -1);</span>
                }
                break;
        }

<span class="fc" id="L169">        firstDayOfRange = new GregorianCalendar(today.getTimeZone());</span>
<span class="fc" id="L170">        firstDayOfRange.setTime(lastDayOfRange.getTime());</span>
<span class="pc bpc" id="L171" title="2 of 4 branches missed.">        switch (rangeDetails.getPeriod()) {</span>
            case MONTH:
<span class="fc" id="L173">                firstDayOfRange.add(Calendar.MONTH, -rangeDetails.getPeriodsToDisplay());</span>
<span class="fc" id="L174">                break;</span>
            case SIXMONTHS:
<span class="fc" id="L176">                firstDayOfRange.add(Calendar.MONTH, -rangeDetails.getPeriodsToDisplay() * 6);</span>
<span class="fc" id="L177">                break;</span>
            case YEAR:
<span class="nc" id="L179">                firstDayOfRange.add(Calendar.YEAR, -rangeDetails.getPeriodsToDisplay());</span>
                break;
        }
<span class="fc" id="L182">    }</span>

    public List&lt;SymptomReportHistoryDTO&gt; getSymptomList() {
<span class="nc" id="L185">        return symptomHistoryList;</span>
    }

    public void setSymptomList(List&lt;SymptomReportHistoryDTO&gt; symptomList) {
<span class="nc" id="L189">        this.symptomHistoryList = symptomList;</span>
<span class="nc" id="L190">    }</span>

    public void setSymptomReportManager(SymptomReportManager symptomReportManager) {
<span class="fc" id="L193">        this.symptomReportManager = symptomReportManager;</span>
<span class="fc" id="L194">    }</span>

    public List&lt;SymptomReportHistoryDTO&gt; getSymptomHistoryList() {
<span class="fc" id="L197">        return symptomHistoryList;</span>
    }

    public String getTab() {
<span class="fc" id="L201">        return tab;</span>
    }

    public String getRangeWanted() {
<span class="nc" id="L205">        return rangeWanted;</span>
    }

    public void setRangeWanted(String rangeWanted) {
<span class="fc" id="L209">        this.rangeWanted = rangeWanted;</span>
<span class="fc" id="L210">    }</span>

    public String getSubTab() {
<span class="fc" id="L213">        return subTab;</span>
    }

    public String getRangeName() {
<span class="nc" id="L217">        return rangeName;</span>
    }

    public void setRangeName(String rangeName) {
<span class="fc" id="L221">        this.rangeName = rangeName;</span>
<span class="fc" id="L222">    }</span>

    public Period getPeriod() {
<span class="nc" id="L225">        return period;</span>
    }

    public void setPeriod(Period period) {
<span class="fc" id="L229">        this.period = period;</span>
<span class="fc" id="L230">    }</span>

    public Integer getPeriodsToDisplay() {
<span class="nc" id="L233">        return periodsToDisplay;</span>
    }

    public void setPeriodsToDisplay(Integer periodsToDisplay) {
<span class="fc" id="L237">        this.periodsToDisplay = periodsToDisplay;</span>
<span class="fc" id="L238">    }</span>

    public Integer getPeriodsBack() {
<span class="nc" id="L241">        return periodsBack;</span>
    }

    public void setPeriodsBack(Integer periodsBack) {
<span class="fc" id="L245">        this.periodsBack = periodsBack;</span>
<span class="fc" id="L246">    }</span>

    public RangeDetails getRangeDetails() {
<span class="fc" id="L249">        return rangeDetails;</span>
    }

    public void setRangeDetails(RangeDetails rangeDetails) {
<span class="nc" id="L253">        this.rangeDetails = rangeDetails;</span>
<span class="nc" id="L254">    }</span>

    public LocalDate getDateOfLastSymptom() {
<span class="fc" id="L257">        return dateOfLastSymptom;</span>
    }

    public void setDateOfLastSymptom(LocalDate dateOfLastSymptom) {
<span class="nc" id="L261">        this.dateOfLastSymptom = dateOfLastSymptom;</span>
<span class="nc" id="L262">    }</span>

    public List&lt;SymptomChart&gt; getCharts() {
<span class="fc" id="L265">        return charts;</span>
    }

    public void setCharts(List&lt;SymptomChart&gt; charts) {
<span class="nc" id="L269">        this.charts = charts;</span>
<span class="nc" id="L270">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>