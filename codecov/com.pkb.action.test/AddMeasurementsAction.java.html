<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AddMeasurementsAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.test</a> &gt; <span class="el_source">AddMeasurementsAction.java</span></div><h1>AddMeasurementsAction.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------
//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: ReplyMessageAction.java Jun 2, 2009 1:14:43 AM mahendera$
//
//------------------------------------------------------------------------------
package com.pkb.action.test;

import com.pkb.action.BaseAction;
import com.pkb.action.plan.ActionHelper;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.notification.entity.Activity;
import com.pkb.service.test.MeasurementManager;
import com.pkb.test.entity.MeasurementCategory;
import com.pkb.test.entity.MeasurementDTO;
import com.pkb.test.entity.MeasurementTypeId;
import com.pkb.test.entity.PredefinedMeasurementType;
import io.vavr.Tuple2;
import io.vavr.control.Option;
import io.vavr.control.Try;
import org.apache.commons.lang3.tuple.Pair;
import org.jetbrains.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.ZonedDateTime;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import static org.apache.commons.lang3.StringUtils.defaultString;

<span class="fc" id="L35">public class AddMeasurementsAction extends BaseAction implements PreselectableAddDataPointPage {</span>

    private static final long serialVersionUID = -6338006964925286293L;

    private String measureDate;

    private String measureTime;

    // the results the user enters
    private List&lt;String&gt; measurementTypeIds;

    // the url parameter used for the measurement whose individual page the user is coming from
    private String measurementTypeId;

    // The parsed ID of the measurement to be shown on page load calculated from measurementTypeId
    private Optional&lt;String&gt; showOnPageLoadDataPointId;

    private Map&lt;String, String&gt; measurementValue;

    private Map&lt;String, String&gt; measurementValue2;

    private List&lt;PredefinedMeasurementType&gt; measurementTypeList;

    private MeasurementManager measurementManager;

<span class="fc" id="L60">    private final String tab = &quot;health&quot;;</span>

<span class="fc" id="L62">    private final String subTab = &quot;measurements&quot;;</span>

<span class="fc" id="L64">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>


    @Override
    public String input() {
<span class="fc" id="L69">        showOnPageLoadDataPointId = convertToShowOnPageLoadDataPointId(measurementTypeId);</span>

        // populate the list of measurements
<span class="fc" id="L72">        measurementTypeList = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L73" title="All 2 branches covered.">        for (PredefinedMeasurementType mt : PredefinedMeasurementType.values()) {</span>
            // skip the pregnancy, drug and alcohol and physical health check categories
<span class="pc bpc" id="L75" title="1 of 4 branches missed.">            if (!mt.getType().derived() &amp;&amp; mt.getType().category() != MeasurementCategory.DRUG_ALCOHOL</span>
<span class="fc bfc" id="L76" title="All 2 branches covered.">                    &amp;&amp; mt.getType().category() != MeasurementCategory.PREGNANCY</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">                    &amp;&amp; mt.getType().category() != MeasurementCategory.PHYSICAL_HEALTH_CHECK) {</span>
<span class="fc" id="L78">                measurementTypeList.add(mt);</span>
            }
        }

<span class="pc bpc" id="L82" title="1 of 4 branches missed.">        if ((measureDate == null) &amp;&amp; (measureTime == null)) {</span>
<span class="fc" id="L83">            Tuple2&lt;String, String&gt; currentDateAndTime = getCurrentDateAndTime();</span>
<span class="fc" id="L84">            measureDate = currentDateAndTime._1;</span>
<span class="fc" id="L85">            measureTime = currentDateAndTime._2;</span>
        }

<span class="fc" id="L88">        return INPUT;</span>
    }

    private ZonedDateTime validateMeasureDate() {
<span class="fc" id="L92">        return getDateTimeNotInPastOrAddFieldError(Pair.of(&quot;measureDate&quot;, measureDate),</span>
<span class="fc" id="L93">                Pair.of(&quot;measureTime&quot;, measureTime));</span>
    }

    /**
     * called automatically for execute()
     * some test values can be missing
     * but if they entered a range value, they need both range values and the test value
     * also return if they didn't enter any values at all
     */

    @Override
    public void validate() {
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        if (measurementValue != null) {</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">            for (PredefinedMeasurementType measurementType : PredefinedMeasurementType.values()) {</span>
<span class="fc" id="L107">                MeasurementTypeId id = measurementType.id();</span>
<span class="fc" id="L108">                String value = measurementValue.get(id.toString());</span>
<span class="pc bpc" id="L109" title="1 of 2 branches missed.">                String value2 = measurementValue2 == null ? null : measurementValue2.get(id.toString());</span>
<span class="fc" id="L110">                validateMeasurement(measurementType, value, value2, &quot;addMeasurementsAction&quot;);</span>
            }
        }
<span class="fc" id="L113">    }</span>

    @Nullable
    private String getStringValue(Long typeId, Map&lt;Long, String&gt; measurementValue) {
<span class="nc bnc" id="L117" title="All 2 branches missed.">        return measurementValue == null ? null : defaultString(measurementValue.get(typeId));</span>
    }

    @Override
    public String execute() {

        // save all entered test values
        // show success message back on myTests screen
<span class="fc" id="L125">        var users = getContextAndLoggedInUsers();</span>

<span class="fc" id="L127">        ZonedDateTime validDate = validateMeasureDate();</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">        if (validDate == null) {</span>
<span class="fc" id="L129">            return INPUT;</span>
        }

<span class="fc" id="L132">        EHRRequestContext context = getEHRRequestContext();</span>
<span class="fc" id="L133">        List&lt;MeasurementDTO&gt; resultList = new ArrayList&lt;&gt;(measurementTypeIds.size());</span>
<span class="fc bfc" id="L134" title="All 2 branches covered.">        for (String typeId : measurementTypeIds) {</span>
<span class="fc" id="L135">            ActionHelper.convertToMeasurement(defaultString(measurementValue.get(typeId)),</span>
<span class="pc bpc" id="L136" title="1 of 2 branches missed.">                    measurementValue2 != null ? defaultString(measurementValue2.get(typeId)) : &quot;&quot;,</span>
<span class="fc" id="L137">                    MeasurementTypeId.ofString(typeId), validDate.toInstant(), context).ifPresent(resultList::add);</span>
<span class="fc" id="L138">        }</span>

<span class="pc bpc" id="L140" title="1 of 2 branches missed.">        if (!resultList.isEmpty()) {</span>
<span class="fc" id="L141">            measurementManager.transactional(() -&gt; {</span>
<span class="fc" id="L142">                measurementManager.saveMeasurements(getEHRRequestContext(), resultList, users.contextUser().getId());</span>

                // consent from first result list is enough
<span class="fc" id="L145">                logActivityByOthers(Activity.Action.UPLOADED_MEASUREMENTS, dateTimeService.now(), true, resultList.get(0));</span>
<span class="fc" id="L146">            });</span>
        }

<span class="fc" id="L149">        addActionMessage(getText(&quot;addMeasurementsAction.text.measurements_uploaded&quot;));</span>
<span class="fc" id="L150">        LOGGER.info(&quot;Exiting execute&quot;);</span>
<span class="fc" id="L151">        return SUCCESS;</span>
    }

    public String cancel() {
        // redirect to myMeasurements; no message
<span class="nc" id="L156">        return CANCEL;</span>
    }

    @Override
    public Optional&lt;String&gt; getShowOnPageLoadDataPointId() {
<span class="fc" id="L161">        return showOnPageLoadDataPointId;</span>
    }

    public String getMeasureDate() {
<span class="fc" id="L165">        return measureDate;</span>
    }

    public void setMeasureDate(String measureDate) {
<span class="fc" id="L169">        this.measureDate = measureDate;</span>
<span class="fc" id="L170">    }</span>

    public Map&lt;String, String&gt; getMeasurementValue() {
<span class="fc" id="L173">        return measurementValue;</span>
    }

    public void setMeasurementValue(Map&lt;String, String&gt; measurementValue) {
<span class="fc" id="L177">        this.measurementValue = measurementValue;</span>
<span class="fc" id="L178">    }</span>

    public List&lt;String&gt; getMeasurementTypeIds() {
<span class="fc" id="L181">        return measurementTypeIds;</span>
    }

    public void setMeasurementTypeIds(List&lt;String&gt; measurementTypeIds) {
<span class="fc" id="L185">        this.measurementTypeIds = measurementTypeIds;</span>
<span class="fc" id="L186">    }</span>

    public String getTab() {
<span class="fc" id="L189">        return tab;</span>
    }

    public String getSubTab() {
<span class="fc" id="L193">        return subTab;</span>
    }

    public Map&lt;String, String&gt; getMeasurementValue2() {
<span class="fc" id="L197">        return measurementValue2;</span>
    }

    public void setMeasurementValue2(Map&lt;String, String&gt; measurementValue2) {
<span class="fc" id="L201">        this.measurementValue2 = measurementValue2;</span>
<span class="fc" id="L202">    }</span>

    public List&lt;PredefinedMeasurementType&gt; getMeasurementTypeList() {
<span class="fc" id="L205">        return measurementTypeList;</span>
    }

    public void setMeasurementManager(MeasurementManager measurementManager) {
<span class="fc" id="L209">        this.measurementManager = measurementManager;</span>
<span class="fc" id="L210">    }</span>

    public String getMeasureTime() {
<span class="fc" id="L213">        return measureTime;</span>
    }

    public void setMeasureTime(String measureTime) {
<span class="fc" id="L217">        this.measureTime = measureTime;</span>
<span class="fc" id="L218">    }</span>

    public String getMeasurementTypeId() {
<span class="fc" id="L221">        return measurementTypeId;</span>
    }

    public void setMeasurementTypeId(String measurementTypeId) {
<span class="fc" id="L225">        this.measurementTypeId = measurementTypeId;</span>
<span class="fc" id="L226">    }</span>

    @Override
    public String getCustomStyle() {
<span class="fc" id="L230">        return MOBILE_OPTIMIZED_STYLE;</span>
    }

    @Override
    public Optional&lt;String&gt; convertToShowOnPageLoadDataPointId(String dataPointID) {
<span class="fc" id="L235">        return Option.of(Try.of(() -&gt;MeasurementTypeId.ofString(dataPointID)).getOrNull())</span>
<span class="fc" id="L236">                .flatMap(MeasurementTypeId::asInternalId)</span>
<span class="fc" id="L237">                .flatMap(id -&gt; Option.of(PredefinedMeasurementType.getById(id)))</span>
<span class="fc" id="L238">                .map(predefinedMeasurementType -&gt;</span>
<span class="fc" id="L239">                        predefinedMeasurementType.getType()</span>
<span class="fc" id="L240">                                .singleInputType()</span>
<span class="fc" id="L241">                                .flatMap(id -&gt; Option.of(PredefinedMeasurementType.getById(id)))</span>
<span class="fc" id="L242">                                .map(singleInputType -&gt; singleInputType.id().toString())</span>
<span class="fc" id="L243">                                .getOrElse(predefinedMeasurementType.id().toString()))</span>
<span class="fc" id="L244">                .toJavaOptional();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>