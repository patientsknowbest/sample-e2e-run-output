<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmisApiClient.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.emis.appointment.service</a> &gt; <span class="el_source">EmisApiClient.java</span></div><h1>EmisApiClient.java</h1><pre class="source lang-java linenums">package com.pkb.emis.appointment.service;

import com.fasterxml.jackson.databind.ObjectMapper;
import com.google.common.collect.ImmutableList;
import com.pkb.integrations.emis.model.EmisJacksonFixes;
import com.pkb.integrations.emis.model.restcalls.EmisEndUserSessionCreateResponse;
import com.pkb.integrations.emis.model.restcalls.EmisRequest;
import com.pkb.integrations.emis.model.restcalls.EmisResponse;
import com.pkb.integrations.emis.model.restcalls.EmisSessionCreateRequest;
import com.pkb.integrations.emis.model.restcalls.EmisSessionCreateResponse;
import com.pkb.integrations.emis.model.restcalls.ImmutableEmisEndUserSessionCreateRequest;
import io.vavr.Tuple;
import io.vavr.Tuple2;
import io.vavr.control.Either;
import io.vavr.control.Try;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.HttpEntity;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.web.client.HttpClientErrorException;
import org.springframework.web.client.HttpServerErrorException;
import org.springframework.web.client.HttpStatusCodeException;
import org.springframework.web.client.ResourceAccessException;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;

import java.lang.invoke.MethodHandles;
import java.net.URI;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.stream.Stream;

import static com.google.common.base.Predicates.instanceOf;
import static com.pkb.emis.appointment.EmisApiLoggingHelper.getRedactedEmisApiRequestMessage;
import static com.pkb.emis.appointment.service.ErrorCode.EMIS_ACCOUNT_CLOSED;
import static com.pkb.emis.appointment.service.ErrorCode.EMIS_PFS_NOT_ENABLED;
import static com.pkb.emis.appointment.service.ErrorCode.EMIS_SESSION_EXPIRED;
import static com.pkb.emis.appointment.service.ErrorCode.INTERNAL_ERROR_DURING_BOOKING;
import static com.pkb.emis.appointment.service.ErrorCode.INTERNAL_ERROR_DURING_CANCEL;
import static com.pkb.emis.appointment.service.ErrorCode.INTERNAL_ERROR_DURING_LINKAGE;
import static com.pkb.emis.appointment.service.ErrorCode.INTERNAL_ERROR_DURING_RETRIEVE;
import static com.pkb.emis.appointment.service.ErrorCode.INTERNAL_ERROR_DURING_SLOTS_REQUEST;
import static com.pkb.emis.appointment.service.ErrorCode.PFS_SERVICE_UNAVAILABLE;
import static com.pkb.emis.appointment.service.ErrorCode.REACHED_UNVERIFIED_USER_MAX_BOOKING_COUNT;
import static com.pkb.emis.appointment.service.ErrorCode.UNLINKED_PATIENT;
import static com.pkb.emis.appointment.service.ImmutableSessionData.sessionData;
import static com.pkb.integrations.emis.model.datatypes.ApplicationLinkLevel.Restricted;
import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.Match;
import static io.vavr.control.Either.left;
import static io.vavr.control.Either.right;
import static java.util.function.Function.identity;
import static org.springframework.http.HttpHeaders.CONTENT_TYPE;
import static org.springframework.http.HttpStatus.I_AM_A_TEAPOT;
import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;

public class EmisApiClient {

<span class="fc" id="L62">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>
<span class="fc" id="L63">    private static final HttpServerErrorException SERVICE_UNAVAILABLE = new HttpServerErrorException(HttpStatus.SERVICE_UNAVAILABLE,</span>
<span class="fc" id="L64">            HttpStatus.SERVICE_UNAVAILABLE.getReasonPhrase());</span>
<span class="fc" id="L65">    private static final ImmutableList&lt;ErrorCode&gt; DEFAULT_ERROR_CODES = ImmutableList.of(</span>
            EMIS_ACCOUNT_CLOSED, UNLINKED_PATIENT, EMIS_PFS_NOT_ENABLED, EMIS_SESSION_EXPIRED, PFS_SERVICE_UNAVAILABLE);
<span class="fc" id="L67">    private static final ImmutableList&lt;ErrorCode&gt; ERROR_SEVERITY_ERROR_CODES = ImmutableList.of(</span>
            PFS_SERVICE_UNAVAILABLE, EMIS_PFS_NOT_ENABLED, INTERNAL_ERROR_DURING_RETRIEVE, ErrorCode.INTERNAL_ERROR,
            INTERNAL_ERROR_DURING_LINKAGE, INTERNAL_ERROR_DURING_BOOKING, INTERNAL_ERROR_DURING_CANCEL,
            INTERNAL_ERROR_DURING_SLOTS_REQUEST, REACHED_UNVERIFIED_USER_MAX_BOOKING_COUNT);
<span class="fc" id="L71">    private static final HttpClientErrorException INTERNAL_ERROR = new HttpClientErrorException(I_AM_A_TEAPOT, I_AM_A_TEAPOT.getReasonPhrase());</span>

    private final URI emisUri;
    private final EmisServiceContext emisContext;
    private final RestTemplate restTemplate;
    private final ObjectMapper objectMapper;

<span class="fc" id="L78">    public EmisApiClient(EmisServiceContext emisContext, RestTemplate restTemplate) {</span>
<span class="fc" id="L79">        this.emisUri = UriComponentsBuilder</span>
<span class="fc" id="L80">                .fromHttpUrl(emisContext.getEmisRestUrl())</span>
<span class="fc" id="L81">                .build().toUri();</span>
<span class="fc" id="L82">        this.emisContext = emisContext;</span>
<span class="fc" id="L83">        this.restTemplate = restTemplate;</span>

<span class="fc" id="L85">        this.objectMapper = EmisJacksonFixes.configureObjectMapper(new ObjectMapper());</span>
<span class="fc" id="L86">    }</span>

    Either&lt;ErrorCode, EmisEndUserSessionCreateResponse&gt; startEndUserSession() {
<span class="fc" id="L89">        HttpHeaders headers = addBaseHeaders(new HttpHeaders());</span>
<span class="fc" id="L90">        headers.add(&quot;content-length&quot;, &quot;0&quot;);</span>
<span class="fc" id="L91">        return callExchange(ImmutableEmisEndUserSessionCreateRequest.builder().build(), headers, ImmutableList.of());</span>
    }

    Either&lt;ErrorCode, SessionData&gt; startEndUserAndServiceUserSessions(EmisSessionCreateRequest request) {
<span class="fc" id="L95">        return startEndUserSession()</span>
<span class="fc" id="L96">                .flatMap(endUserSessionCreateResponse -&gt; startSession(endUserSessionCreateResponse.getEndUserSessionId(), request))</span>
<span class="fc" id="L97">                .flatMap(sessionDetails -&gt; {</span>
<span class="fc" id="L98">                    EmisSessionCreateResponse sessionCreateResponse = sessionDetails._1();</span>
<span class="fc" id="L99">                    String endUserSessionId = sessionDetails._2();</span>
<span class="fc bfc" id="L100" title="All 4 branches covered.">                    if (sessionCreateResponse.getApplicationLinkLevel() == Restricted &amp;&amp; sessionCreateResponse.getUserPatientLinks().isEmpty()) {</span>
<span class="fc" id="L101">                        return left(UNLINKED_PATIENT);</span>
                    } else {
<span class="fc" id="L103">                        SessionData newSessionData = sessionData()</span>
<span class="fc" id="L104">                                .endUserSessionId(endUserSessionId)</span>
<span class="fc" id="L105">                                .sessionId(sessionCreateResponse.getSessionId())</span>
<span class="fc" id="L106">                                .userPatientLinkToken(sessionCreateResponse.getUserPatientLinks().get(0).getUserPatientLinkToken())</span>
<span class="fc" id="L107">                                .sessionType(sessionCreateResponse.getApplicationLinkLevel())</span>
<span class="fc" id="L108">                                .build();</span>
<span class="fc" id="L109">                        return right(newSessionData);</span>
                    }
                });
    }

    @NotNull
    @SuppressWarnings(&quot;unchecked&quot;)
    &lt;T extends EmisResponse, P extends EmisRequest&lt;T&gt;&gt; Either&lt;ErrorCode, T&gt; callExchange(P requestBody, HttpHeaders headers, List&lt;ErrorCode&gt; codes) {
<span class="fc" id="L117">        HttpHeaders httpHeaders = addBaseHeaders(headers);</span>
<span class="fc bfc" id="L118" title="All 2 branches covered.">        HttpEntity&lt;P&gt; entity = requestBody.includeBody() ? new HttpEntity&lt;&gt;(requestBody, httpHeaders) : new HttpEntity&lt;&gt;(httpHeaders);</span>
<span class="fc" id="L119">        URI uri = buildUri(requestBody);</span>
<span class="fc" id="L120">        LOGGER.info(getRedactedEmisApiRequestMessage(uri));</span>
<span class="fc" id="L121">        return Try.of(() -&gt; restTemplate.exchange(uri, requestBody.getMethod(), entity, requestBody.getResponseClass()).getBody())</span>
<span class="fc" id="L122">                .peek(this::logEmisResponseObject)</span>
<span class="fc" id="L123">                .map(Either::&lt;ErrorCode, T&gt; right)</span>
<span class="fc" id="L124">                .recover(Throwable.class, error -&gt; handleError(error, Stream.concat(codes.stream(), DEFAULT_ERROR_CODES.stream())))</span>
<span class="fc" id="L125">                .get();</span>
    }

    private void logEmisResponseObject(EmisResponse response) {
<span class="fc" id="L129">        String simpleName = response.getClass().getSimpleName();</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">        if (simpleName.startsWith(&quot;Immutable&quot;)) {</span>
<span class="fc" id="L131">            simpleName = simpleName.substring(&quot;Immutable&quot;.length());</span>
        }
<span class="fc" id="L133">        LOGGER.info(&quot;EMIS-API-RESPONSE {}&quot;, simpleName);</span>
<span class="fc" id="L134">        LOGGER.debug(&quot;EMIS-API-RESPONSE {}&quot;, response);</span>
<span class="fc" id="L135">    }</span>

    @NotNull
    private &lt;T extends EmisResponse&gt; Either&lt;ErrorCode, T&gt; handleError(Throwable t, Stream&lt;ErrorCode&gt; codes) {
<span class="fc" id="L139">        HttpStatusCodeException exception = Match(t).of(</span>
<span class="fc" id="L140">                Case($(instanceOf(ResourceAccessException.class)), error -&gt; SERVICE_UNAVAILABLE),</span>
<span class="fc" id="L141">                Case($(instanceOf(HttpStatusCodeException.class)), identity()),</span>
<span class="pc" id="L142">                Case($(), error -&gt; INTERNAL_ERROR));</span>
<span class="fc" id="L143">        EmisErrorExtractor emisErrorExtractor = new EmisErrorExtractor(this, exception);</span>
<span class="fc" id="L144">        ErrorCode errorCode = codes.filter(code -&gt; code.test(emisErrorExtractor)).findFirst().orElse(ErrorCode.INTERNAL_ERROR);</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">        if (ERROR_SEVERITY_ERROR_CODES.contains(errorCode)) {</span>
<span class="fc" id="L146">            LOGGER.error(&quot;EMIS-API-ERROR {} {}&quot;, errorCode.name(), exception.getResponseBodyAsString(), t);</span>
        } else {
<span class="fc" id="L148">            LOGGER.info(&quot;EMIS-API-INFO {} {}&quot;, errorCode.name(), exception.getResponseBodyAsString(), t);</span>
        }
<span class="fc" id="L150">        return left(errorCode);</span>
    }

    private Either&lt;ErrorCode, Tuple2&lt;EmisSessionCreateResponse, String&gt;&gt; startSession(String endUserSessionId, EmisSessionCreateRequest request) {
<span class="fc" id="L154">        HttpHeaders headers = getHeadersForEndUserSession(endUserSessionId);</span>
<span class="fc" id="L155">        return callExchange(request, headers, ImmutableList.of())</span>
<span class="fc" id="L156">                .map(response -&gt; Tuple.of(response, endUserSessionId));</span>
    }

    @NotNull
    private &lt;T extends EmisRequest&gt; URI buildUri(T request) {
<span class="fc" id="L161">        UriComponentsBuilder uriBuilder = UriComponentsBuilder.fromUri(emisUri).path(request.getEndPointPath());</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">        if (request.serialiseToQueryString()) {</span>
            //noinspection unchecked
<span class="fc" id="L164">            objectMapper.convertValue(request, LinkedHashMap.class)</span>
<span class="fc" id="L165">                    .forEach((k, v) -&gt; {</span>
<span class="pc bpc" id="L166" title="1 of 4 branches missed.">                        if (v != null &amp;&amp; !v.toString().isEmpty()) {</span>
<span class="fc" id="L167">                            uriBuilder.queryParam(k.toString(), v);</span>
                        }
<span class="fc" id="L169">                    });</span>
        }
<span class="fc" id="L171">        return uriBuilder.build().toUri();</span>
    }

    private HttpHeaders addBaseHeaders(HttpHeaders headers) {
<span class="fc" id="L175">        headers.set(&quot;X-API-ApplicationId&quot;, emisContext.getXapiApplicationId());</span>
<span class="fc" id="L176">        headers.set(&quot;X-API-Version&quot;, emisContext.getXapiVersion());</span>
<span class="fc" id="L177">        headers.set(CONTENT_TYPE, APPLICATION_JSON_VALUE);</span>
<span class="fc" id="L178">        return headers;</span>
    }

    @NotNull
    HttpHeaders getHeadersForEndUserSession(String endUserSessionId) {
<span class="fc" id="L183">        HttpHeaders baseHeaders = new HttpHeaders();</span>
<span class="fc" id="L184">        baseHeaders.set(&quot;X-API-EndUserSessionId&quot;, endUserSessionId);</span>
<span class="fc" id="L185">        return baseHeaders;</span>
    }

    ObjectMapper getObjectMapper() {
<span class="fc" id="L189">        return objectMapper;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>