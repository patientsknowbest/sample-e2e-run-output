<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ErrorCode.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.emis.appointment.service</a> &gt; <span class="el_source">ErrorCode.java</span></div><h1>ErrorCode.java</h1><pre class="source lang-java linenums">package com.pkb.emis.appointment.service;

import com.pkb.integrations.emis.model.restcalls.EmisApiError;
import org.jetbrains.annotations.NotNull;
import org.springframework.http.HttpStatus;

import java.util.Map;
import java.util.Optional;
import java.util.function.Predicate;
import java.util.regex.Pattern;

import static org.springframework.http.HttpStatus.CONFLICT;
import static org.springframework.http.HttpStatus.FORBIDDEN;
import static org.springframework.http.HttpStatus.I_AM_A_TEAPOT;
import static org.springframework.http.HttpStatus.NOT_FOUND;
import static org.springframework.http.HttpStatus.Series.CLIENT_ERROR;
import static org.springframework.http.HttpStatus.Series.SERVER_ERROR;

<span class="fc" id="L19">@SuppressWarnings(&quot;SameParameterValue&quot;)</span>
public enum ErrorCode {

<span class="pc" id="L22">    MISSING_LINK_TO_GP(e -&gt; false, &quot;internal.error&quot;),</span>
<span class="fc" id="L23">    UNLINKED_PATIENT(forCodeStatusAndMessagePattern(&quot;ApiCommandNotPermitted&quot;, Constants.NO_SERVICES_AVAILABLE, FORBIDDEN), &quot;patient.unlinked&quot;),</span>
<span class="pc" id="L24">    RESTRICTED_PATIENT(e -&gt; false, &quot;restricted.session&quot;),</span>
<span class="pc" id="L25">    NO_CACHED_ODS(e -&gt; false, &quot;internal.error&quot;),</span>
<span class="fc" id="L26">    INTERNAL_ERROR(forInternalError(), &quot;internal.error&quot;),</span>
<span class="fc" id="L27">    INTERNAL_ERROR_DURING_BOOKING(forInternalError(), &quot;pkb.booking.issue&quot;),</span>
<span class="fc" id="L28">    INTERNAL_ERROR_DURING_CANCEL(forInternalError(), &quot;pkb.cancel.issue&quot;),</span>
<span class="fc" id="L29">    INTERNAL_ERROR_DURING_RETRIEVE(forInternalError(), &quot;pkb.view.issue&quot;),</span>
<span class="fc" id="L30">    INTERNAL_ERROR_DURING_LINKAGE(forInternalError(), &quot;pkb.linking.issue&quot;),</span>
<span class="fc" id="L31">    INTERNAL_ERROR_DURING_SLOTS_REQUEST(forInternalError(), &quot;pkb.slots.issue&quot;),</span>
<span class="fc" id="L32">    EMIS_SESSION_EXPIRED(forSessionExpiry(), &quot;internal.error&quot;),</span>
<span class="fc" id="L33">    DEMOGRAPHICS_DO_NOT_MATCH(forEmisCode(&quot;DemographicsNotMatch&quot;), &quot;demographics.mismatch&quot;),</span>
<span class="fc" id="L34">    INVALID_LINKAGE_KEY(forEmisCode(&quot;InvalidLinkageKey&quot;), &quot;invalid.linkage.details&quot;),</span>
<span class="fc" id="L35">    ACCOUNT_ALREADY_LINKED(forEmisCode(&quot;AccountAlreadyLinked&quot;), &quot;already.linked&quot;),</span>
<span class="fc" id="L36">    NO_REGISTERED_ONLINE_USER_FOUND(forEmisCode(&quot;NoRegisteredOnlineUserFound&quot;), &quot;invalid.linkage.details&quot;),</span>
<span class="fc" id="L37">    PFS_SERVICE_UNAVAILABLE(forStatusSeries(SERVER_ERROR), &quot;pfs.service.unavailable&quot;),</span>
<span class="fc" id="L38">    EMIS_PFS_NOT_ENABLED(forCodeStatusAndMessagePattern(&quot;ApiCommandNotPermitted&quot;, Pattern.compile(&quot;Patient Facing Services are not enabled by this practice&quot;),</span>
            FORBIDDEN), &quot;pfs.turned.off&quot;),
<span class="fc" id="L40">    REACHED_MAX_BOOKING_COUNT(forEmisCode(&quot;OnlineUserMaxAppointmentBookCount&quot;), &quot;max.booking.limit&quot;),</span>
<span class="fc" id="L41">    APPOINTMENT_SLOT_IN_PAST(forEmisCode(&quot;ProvidedAppointmentSlotInPast&quot;), &quot;slot.nolonger.available&quot;),</span>
<span class="fc" id="L42">    REACHED_UNVERIFIED_USER_MAX_BOOKING_COUNT(forEmisCode(&quot;UnverifiedOnlineUserMaxAppointmentBookCount&quot;), &quot;restricted.session&quot;),</span>
<span class="fc" id="L43">    APPOINTMENT_NO_LONGER_AVAILABLE(forStatus(CONFLICT), &quot;slot.nolonger.available&quot;),</span>
<span class="fc" id="L44">    APPOINTMENT_NOT_FOUND(forStatus(NOT_FOUND), &quot;slot.nolonger.available&quot;),</span>
<span class="fc" id="L45">    APPOINTMENT_COULD_NOT_BE_CANCELLED(forStatus(CONFLICT), &quot;could.not.be.cancelled&quot;),</span>
<span class="fc" id="L46">    INVALID_LINKAGE_DETAIL_ACCOUNT_ID(forFieldError(&quot;LinkageDetails.AccountId&quot;), &quot;account.id.invalid&quot;),</span>
<span class="fc" id="L47">    INVALID_LINKAGE_DETAILS_LINKAGE_KEY(forFieldError(&quot;LinkageDetails.LinkageKey&quot;), &quot;linkage.key.invalid&quot;),</span>
<span class="fc" id="L48">    INVALID_LINKAGE_DETAILS_ODS_CODE(forCodeAndMessagePattern(&quot;GeneralError&quot;, Constants.UNABLE_TO_FIND_ORGANISATION), &quot;ods.code.invalid&quot;),</span>
<span class="fc" id="L49">    EMIS_ACCOUNT_CLOSED(forCodeStatusAndMessagePattern(&quot;ApiCommandNotPermitted&quot;, Constants.ARCHIVED_ACCOUNT, FORBIDDEN), &quot;patient.unlinked&quot;),</span>
<span class="fc" id="L50">    EXPIRED_LINKAGE_DETAILS(forEmisCode(&quot;AccountStatusInvalid&quot;), &quot;linkage.details.expired&quot;);</span>

    private final Predicate&lt;ErrorExtractor&gt; errorTest;
    private final String i18nEmisErrorKey;

<span class="fc" id="L55">    ErrorCode(Predicate&lt;ErrorExtractor&gt; errorTest, String i18nSuffix) {</span>
<span class="fc" id="L56">        this.errorTest = errorTest;</span>
<span class="fc" id="L57">        this.i18nEmisErrorKey = Constants.EMIS_I18N_ERROR_KEY_PREFIX + i18nSuffix;</span>
<span class="fc" id="L58">    }</span>

    public String getI18nEmisErrorKey() {
<span class="fc" id="L61">        return i18nEmisErrorKey;</span>
    }

    public boolean test(ErrorExtractor errorExtractor) {
<span class="fc" id="L65">        return errorTest.test(errorExtractor);</span>
    }

    private static boolean matchesEmisErrorCode(ErrorExtractor extractor, String emisCode) {
<span class="fc" id="L69">        return extractor.getAsErrorObject().map(EmisApiError::getErrorCode).map(emisCode::equals).orElse(false);</span>
    }

    private static boolean matchesEmisErrorMessage(ErrorExtractor extractor, Pattern messagePattern) {
<span class="fc" id="L73">        return extractor.getAsErrorObject()</span>
<span class="fc" id="L74">                .map(error -&gt; messagePattern.matcher(error.getMessage()).find()).orElse(false);</span>
    }

    private static Predicate&lt;ErrorExtractor&gt; forEmisCode(String emisCode) {
<span class="fc" id="L78">        return extractor -&gt; matchesEmisErrorCode(extractor, emisCode);</span>
    }

    private static Predicate&lt;ErrorExtractor&gt; forStatus(HttpStatus statusToMatch) {
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        return extractor -&gt; extractor.getStatus() == statusToMatch;</span>
    }

    private static Predicate&lt;ErrorExtractor&gt; forStatusSeries(HttpStatus.Series seriesToMatch) {
<span class="fc bfc" id="L86" title="All 2 branches covered.">        return extractor -&gt; extractor.getStatus().series() == seriesToMatch;</span>
    }

    private static Predicate&lt;ErrorExtractor&gt; forFieldError(String fieldName) {
<span class="pc bnc" id="L90" title="All 4 branches missed.">        return extractor -&gt; extractor.getStatus() == HttpStatus.BAD_REQUEST &amp;&amp; extractor.getAsMap().containsKey(fieldName);</span>
    }

    private static Predicate&lt;ErrorExtractor&gt; forCodeAndMessagePattern(String emisCode, Pattern messagePattern) {
<span class="pc bnc" id="L94" title="All 2 branches missed.">        return extractor -&gt; extractor.getStatus() == HttpStatus.BAD_REQUEST</span>
<span class="nc bnc" id="L95" title="All 2 branches missed.">                &amp;&amp; matchesEmisErrorCode(extractor, emisCode)</span>
<span class="nc bnc" id="L96" title="All 2 branches missed.">                &amp;&amp; matchesEmisErrorMessage(extractor, messagePattern);</span>
    }

    private static Predicate&lt;ErrorExtractor&gt; forCodeStatusAndMessagePattern(String emisCode, Pattern messagePattern, HttpStatus statusToMatch) {
<span class="fc bfc" id="L100" title="All 2 branches covered.">        return extractor -&gt; extractor.getStatus() == statusToMatch</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">                &amp;&amp; matchesEmisErrorCode(extractor, emisCode)</span>
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">                &amp;&amp; matchesEmisErrorMessage(extractor, messagePattern);</span>
    }

    @NotNull
    private static Predicate&lt;ErrorExtractor&gt; forInternalError() {
<span class="fc" id="L107">        return forStatus(I_AM_A_TEAPOT);</span>
    }

    private static Predicate&lt;ErrorExtractor&gt; forSessionExpiry() {
<span class="fc bfc" id="L111" title="All 2 branches covered.">        return extractor -&gt; extractor.getStatus().series() == CLIENT_ERROR &amp;&amp;</span>
<span class="fc" id="L112">                Constants.SESSION_EXPIRY_PATTERN.matcher(extractor.getAsErrorObject()</span>
<span class="fc" id="L113">                        .map(EmisApiError::getMessage)</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">                        .orElseGet(extractor::getAsString)).find();</span>
    }

    private static class Constants {
<span class="fc" id="L118">        private static final Pattern ARCHIVED_ACCOUNT = Pattern.compile(&quot;Actual account status is 'Archived'&quot;);</span>
<span class="fc" id="L119">        private static final Pattern UNABLE_TO_FIND_ORGANISATION = Pattern.compile(&quot;Unable to find organisation for NationalPracticeCode.*&quot;);</span>
<span class="fc" id="L120">        private static final Pattern NO_SERVICES_AVAILABLE = Pattern.compile(&quot;Available services are 'None'&quot;);</span>
<span class="fc" id="L121">        private static final Pattern SESSION_EXPIRY_PATTERN = Pattern.compile(&quot;User Session not found\\. It may have expired|Missing or invalid EndUserSessionId&quot;);</span>
        private static final String EMIS_I18N_ERROR_KEY_PREFIX = &quot;err.emis.appt.&quot;;
    }

    public interface ErrorExtractor {
        Optional&lt;EmisApiError&gt; getAsErrorObject();

        String getAsString();

        Map&lt;String, Object&gt; getAsMap();

        HttpStatus getStatus();
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>