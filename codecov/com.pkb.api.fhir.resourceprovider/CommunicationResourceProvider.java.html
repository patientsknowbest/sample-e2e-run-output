<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CommunicationResourceProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.fhir.resourceprovider</a> &gt; <span class="el_source">CommunicationResourceProvider.java</span></div><h1>CommunicationResourceProvider.java</h1><pre class="source lang-java linenums">package com.pkb.api.fhir.resourceprovider;

import ca.uhn.fhir.model.api.Include;
import ca.uhn.fhir.model.api.annotation.Description;
import ca.uhn.fhir.rest.annotation.IncludeParam;
import ca.uhn.fhir.rest.annotation.OptionalParam;
import ca.uhn.fhir.rest.annotation.RequiredParam;
import ca.uhn.fhir.rest.annotation.Search;
import ca.uhn.fhir.rest.api.server.RequestDetails;
import ca.uhn.fhir.rest.param.DateRangeParam;
import ca.uhn.fhir.rest.param.ReferenceParam;
import ca.uhn.fhir.rest.server.exceptions.BaseServerResponseException;
import com.pkb.api.fhir.BundleMapper;
import com.pkb.api.fhir.communication.CommunicationResourceService;
import com.pkb.api.fhir.communication.ImmutableCommunicationSearchCriteria;
import com.pkb.api.fhir.converter.DateRangeParamToDateRangeRestrictionConverter;
import com.pkb.api.fhir.converter.ReferenceParamToUUIDConverter;
import com.pkb.api.fhir.converter.ReverseIncludeConverter;
import com.pkb.api.fhir.service.AuthenticationService;
import com.pkb.api.fhir.util.IncludeResource;
import com.pkb.api.fhir.util.Issues;
import com.pkb.api.fhir.util.NamedParam;
import com.pkb.api.fhir.util.NamedParameterFactory;
import com.pkb.authentication.AuthenticatedIdentity;
import com.pkb.domain.criteria.FhirCriteriaResult;
import com.pkb.domain.criteria.TemporalRangeRestriction;
import io.vavr.collection.List;
import io.vavr.collection.Seq;
import io.vavr.control.Either;
import io.vavr.control.Option;
import io.vavr.control.Validation;
import org.hl7.fhir.dstu3.model.Bundle;
import org.hl7.fhir.dstu3.model.Communication;

import java.time.LocalDate;
import java.util.UUID;

import static com.pkb.api.fhir.converter.ReverseIncludeConverter.PROVENANCE_TARGET_STR;
import static com.pkb.api.fhir.util.Fhirs.invalidRequestException;
import static io.vavr.API.Some;
import static io.vavr.API.Stream;
import static io.vavr.control.Either.left;
import static org.hl7.fhir.dstu3.model.Communication.SP_SENT;
import static org.hl7.fhir.dstu3.model.Observation.SP_PATIENT;
import static org.hl7.fhir.dstu3.model.ResourceType.Patient;

/**
 * FHIR endpoint for Communications.
 * Validates inputs and delegates to FHIR service layer.
 */
public class CommunicationResourceProvider extends AbstractResourceProvider {
    private static final String SP_PATIENT_DESCRIPTION = &quot;Required. Multi-value support: none. Modifier support: [&lt;type&gt;].&quot;;
    private static final String SP_SENT_DESCRIPTION = &quot;Optional. Multi-value support: AND. Modifier support: none. Prefixes supported: [eq, gt, lt, ge, le].&quot;;

    private final AuthenticationService authenticationService;
    private final CommunicationResourceService communicationResourceService;
    private final ReferenceParamToUUIDConverter referenceParamToUUIDConverter;
    private final DateRangeParamToDateRangeRestrictionConverter dateRangeParamToDateRangeRestrictionConverter;
    private final NamedParameterFactory namedParameterFactory;
    private final ReverseIncludeConverter reverseIncludeConverter;
    private final BundleMapper bundleMapper;

    public CommunicationResourceProvider(AuthenticationService authenticationService, CommunicationResourceService communicationResourceService,
                                         ReferenceParamToUUIDConverter referenceParamToUUIDConverter,
                                         DateRangeParamToDateRangeRestrictionConverter dateRangeParamToDateRangeRestrictionConverter,
                                         NamedParameterFactory namedParameterFactory,
                                         ReverseIncludeConverter reverseIncludeConverter,
                                         BundleMapper bundleMapper) {
<span class="fc" id="L69">        super(Communication.class);</span>
<span class="fc" id="L70">        this.authenticationService = authenticationService;</span>
<span class="fc" id="L71">        this.communicationResourceService = communicationResourceService;</span>
<span class="fc" id="L72">        this.referenceParamToUUIDConverter = referenceParamToUUIDConverter;</span>
<span class="fc" id="L73">        this.dateRangeParamToDateRangeRestrictionConverter = dateRangeParamToDateRangeRestrictionConverter;</span>
<span class="fc" id="L74">        this.namedParameterFactory = namedParameterFactory;</span>
<span class="fc" id="L75">        this.reverseIncludeConverter = reverseIncludeConverter;</span>
<span class="fc" id="L76">        this.bundleMapper = bundleMapper;</span>
<span class="fc" id="L77">    }</span>

    @SuppressWarnings(&quot;unused&quot;)
    @Search
    public Bundle findCommunication(@RequiredParam(name = SP_PATIENT)
                                    @Description(value = SP_PATIENT_DESCRIPTION)
                                        ReferenceParam patient,
                                    @OptionalParam(name = SP_SENT)
                                    @Description(value = SP_SENT_DESCRIPTION)
                                        DateRangeParam sentDate,
                                    @IncludeParam(reverse = true, allow = { PROVENANCE_TARGET_STR }) java.util.Collection&lt;Include&gt; reverseIncludes,
                                    RequestDetails request) {
<span class="fc" id="L89">        AuthenticatedIdentity authenticatedIdentity = authenticationService.authenticateOrThrow(request);</span>
<span class="fc" id="L90">        NamedParam&lt;ReferenceParam&gt; patientNamedParam = namedParameterFactory.createNamedParam(patient, SP_PATIENT, request);</span>
<span class="fc" id="L91">        NamedParam&lt;DateRangeParam&gt; sentDateNamedParam = namedParameterFactory.createNamedParam(sentDate, SP_SENT, request);</span>
<span class="fc" id="L92">        Validation&lt;Issues, UUID&gt; issuesOrPatientUUID = referenceParamToUUIDConverter.convertRequired(patientNamedParam, Patient);</span>
<span class="fc" id="L93">        Validation&lt;Issues, TemporalRangeRestriction&lt;LocalDate&gt;&gt; issuesOrSentDate = dateRangeParamToDateRangeRestrictionConverter.convert(sentDateNamedParam);</span>
<span class="fc" id="L94">        Validation&lt;Issues, List&lt;IncludeResource&gt;&gt; issuesOrIncludes = reverseIncludeConverter.convert(List.ofAll(reverseIncludes));</span>

<span class="fc" id="L96">        Either&lt;BaseServerResponseException, FhirCriteriaResult&lt;Communication&gt;&gt; result =</span>
<span class="fc" id="L97">                Validation.combine(issuesOrPatientUUID, issuesOrSentDate, issuesOrIncludes)</span>
<span class="fc" id="L98">                 .ap((uuid, sentDateRestriction, includes) -&gt;  ImmutableCommunicationSearchCriteria.builder()</span>
<span class="fc" id="L99">                         .authenticatedIdentity(authenticatedIdentity)</span>
<span class="fc" id="L100">                         .patientId(uuid)</span>
<span class="fc" id="L101">                         .sent(sentDateRestriction)</span>
<span class="fc" id="L102">                         .includes(includes)</span>
<span class="fc" id="L103">                         .build())</span>
<span class="fc" id="L104">                 .map(communicationResourceService::search)</span>
<span class="fc" id="L105">                 .mapError(Issues::flatten)</span>
<span class="fc" id="L106">                 .fold(issues -&gt; left(invalidRequestException(issues)), $ -&gt; $.fold(Either::left, Either::right));</span>

<span class="fc" id="L108">        Seq&lt;String&gt; parameters = Stream(</span>
<span class="fc" id="L109">                Some(patientNamedParam.getName()), // Always include this in the self-link, it's a mandatory param</span>
<span class="fc" id="L110">                Option.when(issuesOrSentDate.isValid(), sentDateNamedParam.getName()),</span>
<span class="pc bpc" id="L111" title="1 of 4 branches missed.">                Option.when(issuesOrIncludes.isValid() &amp;&amp; !reverseIncludes.isEmpty(), ReverseIncludeConverter.PARAM_NAME))</span>
<span class="fc" id="L112">                    .filter(Option::isDefined)</span>
<span class="fc" id="L113">                    .map(Option::get)</span>
<span class="fc" id="L114">                    .toList();</span>

<span class="fc" id="L116">        return result.fold(</span>
<span class="fc" id="L117">                bundleMapper.toEmptyBundle(request, Some(parameters)),</span>
<span class="fc" id="L118">                r -&gt; bundleMapper.toBundleWithIncludes(r, request, Some(parameters))</span>
        );
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>