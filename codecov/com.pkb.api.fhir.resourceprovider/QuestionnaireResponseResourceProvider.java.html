<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuestionnaireResponseResourceProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.fhir.resourceprovider</a> &gt; <span class="el_source">QuestionnaireResponseResourceProvider.java</span></div><h1>QuestionnaireResponseResourceProvider.java</h1><pre class="source lang-java linenums">package com.pkb.api.fhir.resourceprovider;

import ca.uhn.fhir.model.api.Include;
import ca.uhn.fhir.model.api.annotation.Description;
import ca.uhn.fhir.rest.annotation.IncludeParam;
import ca.uhn.fhir.rest.annotation.OptionalParam;
import ca.uhn.fhir.rest.annotation.Search;
import ca.uhn.fhir.rest.api.server.RequestDetails;
import ca.uhn.fhir.rest.param.DateRangeParam;
import ca.uhn.fhir.rest.param.ReferenceParam;
import ca.uhn.fhir.rest.server.exceptions.BaseServerResponseException;
import com.pkb.api.fhir.BundleMapper;
import com.pkb.api.fhir.converter.DateRangeParamToDateRangeRestrictionConverter;
import com.pkb.api.fhir.converter.IncludeConverter;
import com.pkb.api.fhir.converter.ReferenceParamToUUIDConverter;
import com.pkb.api.fhir.questionnaire.QuestionnaireResponseResourceService;
import com.pkb.api.fhir.service.AuthenticationService;
import com.pkb.api.fhir.util.IncludeResource;
import com.pkb.api.fhir.util.Issues;
import com.pkb.api.fhir.util.NamedParam;
import com.pkb.api.fhir.util.NamedParameterFactory;
import com.pkb.domain.criteria.FhirCriteriaResult;
import com.pkb.domain.criteria.TemporalRangeRestriction;
import com.pkb.domain.questionnaire.ImmutableQuestionnaireResponseSearchCriteria;
import io.vavr.collection.List;
import io.vavr.collection.Seq;
import io.vavr.control.Either;
import io.vavr.control.Option;
import io.vavr.control.Validation;
import org.hl7.fhir.dstu3.model.Bundle;
import org.hl7.fhir.dstu3.model.QuestionnaireResponse;
import org.jetbrains.annotations.NotNull;

import java.time.LocalDate;
import java.util.UUID;

import static com.pkb.api.fhir.converter.IncludeConverter.QUESTIONNAIRE_RESPONSE_BASED_ON_STR;
import static com.pkb.api.fhir.converter.IncludeConverter.QUESTIONNAIRE_RESPONSE_SUBJECT_PATIENT_STR;
import static com.pkb.api.fhir.util.Fhirs.invalidRequestException;
import static io.vavr.API.Some;
import static io.vavr.API.Stream;
import static org.hl7.fhir.dstu3.model.Observation.SP_PATIENT;
import static org.hl7.fhir.dstu3.model.QuestionnaireResponse.SP_AUTHORED;
import static org.hl7.fhir.dstu3.model.QuestionnaireResponse.SP_QUESTIONNAIRE;
import static org.hl7.fhir.dstu3.model.ResourceType.Patient;
import static org.hl7.fhir.dstu3.model.ResourceType.Questionnaire;


public class QuestionnaireResponseResourceProvider extends AbstractResourceProvider {

    private static final String SP_AUTHORED_DESCRIPTION = &quot;Optional. Multi-value support: AND. Modifier support: none. Prefix support: [eq, gt, lt, ge, le].&quot;;
    private static final String SP_PATIENT_DESCRIPTION = &quot;Optional. Multi-value support: none. Modifier support: [&lt;type&gt;].&quot;;
    private static final String SP_QUESTIONNAIRE_DESCRIPTION = &quot;Optional. Multi-value support: none. Modifier support: [&lt;type&gt;].&quot;;
    private final BundleMapper bundleMapper;
    private final NamedParameterFactory parameterFactory;
    private final ReferenceParamToUUIDConverter referenceParamToUUIDConverter;
    private final QuestionnaireResponseResourceService questionnaireResponseResourceService;
    private final DateRangeParamToDateRangeRestrictionConverter dateRangeParamToDateRangeRestrictionConverter;
    private final IncludeConverter includeConverter;
    private final AuthenticationService authenticationService;

    public QuestionnaireResponseResourceProvider(
            @NotNull BundleMapper bundleMapper,
            @NotNull NamedParameterFactory parameterFactory,
            @NotNull ReferenceParamToUUIDConverter referenceParamToUUIDConverter,
            @NotNull QuestionnaireResponseResourceService questionnaireResponseResourceService,
            @NotNull DateRangeParamToDateRangeRestrictionConverter dateRangeParamToDateRangeRestrictionConverter,
            @NotNull IncludeConverter includeConverter,
            @NotNull AuthenticationService authenticationService) {
<span class="fc" id="L70">        super(QuestionnaireResponse.class);</span>
<span class="fc" id="L71">        this.bundleMapper = bundleMapper;</span>
<span class="fc" id="L72">        this.parameterFactory = parameterFactory;</span>
<span class="fc" id="L73">        this.referenceParamToUUIDConverter = referenceParamToUUIDConverter;</span>
<span class="fc" id="L74">        this.questionnaireResponseResourceService = questionnaireResponseResourceService;</span>
<span class="fc" id="L75">        this.dateRangeParamToDateRangeRestrictionConverter = dateRangeParamToDateRangeRestrictionConverter;</span>
<span class="fc" id="L76">        this.includeConverter = includeConverter;</span>
<span class="fc" id="L77">        this.authenticationService = authenticationService;</span>
<span class="fc" id="L78">    }</span>

    @Search
    public Bundle searchQuestionnaireResponses(
            @OptionalParam(name = SP_AUTHORED) @Description(value = SP_AUTHORED_DESCRIPTION) DateRangeParam authored,
            @OptionalParam(name = SP_PATIENT) @Description(value = SP_PATIENT_DESCRIPTION) ReferenceParam patient,
            @OptionalParam(name = SP_QUESTIONNAIRE) @Description(value = SP_QUESTIONNAIRE_DESCRIPTION) ReferenceParam questionnaire,
            @IncludeParam(allow = { QUESTIONNAIRE_RESPONSE_SUBJECT_PATIENT_STR, QUESTIONNAIRE_RESPONSE_BASED_ON_STR }) java.util.Collection&lt;Include&gt; includes,
            RequestDetails request) {
<span class="fc" id="L87">        var authenticatedIdentity = authenticationService.authenticateOrThrow(request);</span>
<span class="fc" id="L88">        NamedParam&lt;DateRangeParam&gt; authoredParam = parameterFactory.createNamedParam(authored, SP_AUTHORED, request);</span>
<span class="fc" id="L89">        NamedParam&lt;ReferenceParam&gt; patientNamedParam = parameterFactory.createNamedParam(patient, SP_PATIENT, request);</span>
<span class="fc" id="L90">        NamedParam&lt;ReferenceParam&gt; questionnaireNamedParam = parameterFactory.createNamedParam(questionnaire, SP_QUESTIONNAIRE, request);</span>

<span class="fc" id="L92">        Validation&lt;Issues, TemporalRangeRestriction&lt;LocalDate&gt;&gt; issuesOrAuthored = dateRangeParamToDateRangeRestrictionConverter.convert(authoredParam);</span>
        @NotNull
<span class="fc" id="L94">        Validation&lt;Issues, Option&lt;UUID&gt;&gt; issuesOrPatientUUID = referenceParamToUUIDConverter.convert(patientNamedParam, Patient);</span>
        @NotNull
<span class="fc" id="L96">        Validation&lt;Issues, Option&lt;UUID&gt;&gt; issuesOrQuestionnaireUUID = referenceParamToUUIDConverter.convert(questionnaireNamedParam, Questionnaire);</span>
<span class="fc" id="L97">        Validation&lt;Issues, List&lt;IncludeResource&gt;&gt; issuesOrIncludes = includeConverter.convert(List.ofAll(includes));</span>

<span class="fc" id="L99">        Either&lt;BaseServerResponseException, FhirCriteriaResult&lt;QuestionnaireResponse&gt;&gt; responses = Validation</span>
<span class="fc" id="L100">                .combine(issuesOrAuthored, issuesOrPatientUUID, issuesOrQuestionnaireUUID, issuesOrIncludes)</span>
<span class="fc" id="L101">                .ap((authoredRestriction, patientId, questionnaireId, includeResources) -&gt; ImmutableQuestionnaireResponseSearchCriteria.builder()</span>
<span class="fc" id="L102">                        .authenticatedIdentity(authenticatedIdentity)</span>
<span class="fc" id="L103">                        .authored(authoredRestriction)</span>
<span class="fc" id="L104">                        .patientId(patientId)</span>
<span class="fc" id="L105">                        .questionnaireId(questionnaireId)</span>
<span class="fc" id="L106">                        .includes(includeResources)</span>
<span class="fc" id="L107">                        .build())</span>
<span class="fc" id="L108">                .map(questionnaireResponseResourceService::findQuestionnaireResponses)</span>
<span class="fc" id="L109">                .mapError(Issues::flatten)</span>
<span class="pc" id="L110">                .fold(issues -&gt; Either.&lt;BaseServerResponseException, FhirCriteriaResult&lt;QuestionnaireResponse&gt;&gt; left(invalidRequestException(issues)), Either::right);</span>

<span class="fc" id="L112">        Seq&lt;String&gt; parameters = Stream(</span>
<span class="fc" id="L113">                Option.when(issuesOrAuthored.isValid(), authoredParam.getName()),</span>
<span class="fc" id="L114">                Option.when(issuesOrPatientUUID.isValid(), patientNamedParam.getName()),</span>
<span class="fc" id="L115">                Option.when(issuesOrQuestionnaireUUID.isValid(), questionnaireNamedParam.getName()),</span>
<span class="pc bpc" id="L116" title="1 of 4 branches missed.">                Option.when(issuesOrIncludes.isValid() &amp;&amp; !includes.isEmpty(), IncludeConverter.PARAM_NAME))</span>
<span class="fc" id="L117">                        .filter(Option::isDefined)</span>
<span class="fc" id="L118">                        .map(Option::get)</span>
<span class="fc" id="L119">                        .toList();</span>

<span class="fc" id="L121">        return responses.fold(</span>
<span class="fc" id="L122">                bundleMapper.toEmptyBundle(request, Some(parameters)),</span>
<span class="fc" id="L123">                result -&gt; bundleMapper.toBundleWithIncludes(result, request, Some(parameters)));</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>