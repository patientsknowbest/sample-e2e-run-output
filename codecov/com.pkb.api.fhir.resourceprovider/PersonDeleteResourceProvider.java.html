<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PersonDeleteResourceProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.fhir.resourceprovider</a> &gt; <span class="el_source">PersonDeleteResourceProvider.java</span></div><h1>PersonDeleteResourceProvider.java</h1><pre class="source lang-java linenums">package com.pkb.api.fhir.resourceprovider;

import ca.uhn.fhir.rest.annotation.Operation;
import ca.uhn.fhir.rest.annotation.OperationParam;
import ca.uhn.fhir.rest.api.server.RequestDetails;
import ca.uhn.fhir.rest.param.ReferenceParam;
import ca.uhn.fhir.rest.param.StringParam;
import com.pkb.api.fhir.converter.ReferenceParamToUUIDConverter;
import com.pkb.api.fhir.parameters.ParametersMapper;
import com.pkb.api.fhir.person.PersonResourceService;
import com.pkb.api.fhir.service.AuthenticationService;
import com.pkb.api.fhir.util.Fhirs;
import com.pkb.api.fhir.util.Issues;
import com.pkb.api.fhir.util.NamedParam;
import io.vavr.Tuple;
import io.vavr.collection.Seq;
import io.vavr.control.Option;
import io.vavr.control.Validation;
import org.hl7.fhir.dstu3.model.BooleanType;
import org.hl7.fhir.dstu3.model.Parameters;
import org.hl7.fhir.dstu3.model.Person;
import org.hl7.fhir.dstu3.model.ResourceType;
import org.jetbrains.annotations.NotNull;

import java.util.List;
import java.util.UUID;
import java.util.function.Function;

import static com.pkb.api.fhir.util.Issues.errorFrom;

public class PersonDeleteResourceProvider extends AbstractResourceProvider {

    private final AuthenticationService authenticationService;
    private final PersonResourceService personResourceService;
    private final ReferenceParamToUUIDConverter referenceParamConverter;

    public PersonDeleteResourceProvider(@NotNull AuthenticationService authenticationService,
                                        @NotNull PersonResourceService personResourceService,
                                        @NotNull ReferenceParamToUUIDConverter referenceParamConverter) {
<span class="fc" id="L40">        super(Person.class);</span>
<span class="fc" id="L41">        this.authenticationService = authenticationService;</span>
<span class="fc" id="L42">        this.personResourceService = personResourceService;</span>
<span class="fc" id="L43">        this.referenceParamConverter = referenceParamConverter;</span>
<span class="fc" id="L44">    }</span>

    /**
     * This operation enqueues a deletion operation for the Persons specified
     * by the supplied PersonRefs.
     * &lt;p&gt;
     * Returns an operation id which can be used to check on the status of the
     * deletion via the $delete_status operation below.
     */
    @Operation(name = &quot;$destroy&quot;, type = Parameters.class)
    public Parameters deletePeople(
            @OperationParam(name = &quot;person&quot;) List&lt;ReferenceParam&gt; personRefs,
            @OperationParam(name = &quot;forceDelete&quot;) BooleanType forceDeleteInput,
            RequestDetails request
    ) {

<span class="fc" id="L60">        var authenticatedIdentity = authenticationService.authenticateOrThrow(request);</span>
<span class="fc" id="L61">        var forceDelete = Option.of(forceDeleteInput).map(BooleanType::booleanValue).getOrElse(false);</span>

<span class="fc" id="L63">        return Validation.traverse(personRefs, personRef -&gt; validatePersonRef(personRef, request))</span>
<span class="fc" id="L64">                .mapError(Issues::combine)</span>
<span class="fc" id="L65">                .toEither()</span>
<span class="fc" id="L66">                .mapLeft(Fhirs::invalidRequestException)</span>
<span class="fc" id="L67">                .flatMap(personIds -&gt; personResourceService.requestDeletion(authenticatedIdentity, personIds.toSet(), forceDelete))</span>
<span class="fc" id="L68">                .map(ParametersMapper::deleteOperationIdToParameters)</span>
<span class="fc" id="L69">                .getOrElseThrow(Function.identity());</span>

    }

    /**
     * Get the status of a deletion operation that was enqueued by the $destroy operation above. Note
     * that due to the distributed nature of the processing performed for deletes, calling this endpoint
     * _immediately_ after calling $destroy can sometimes result in a 404 for an unrecognised operationId.
     * Clients should be prepared to retry until they receive a 200 response, and then keep polling
     * until the response body indicates that the operation has completed (succesfully or with errors)
     */
    @Operation(name = &quot;$delete_status&quot;, type = Parameters.class, idempotent = true)
    public Parameters checkDeletionStatus(@OperationParam(name = &quot;operationId&quot;, min = 1, max = 1) StringParam operationIdInput, RequestDetails request) {
<span class="fc" id="L82">        var authenticatedIdentity = authenticationService.authenticateOrThrow(request);</span>
        //TODO PHR-11078 do authz properly
<span class="fc" id="L84">        return validateOperationId(operationIdInput)</span>
<span class="fc" id="L85">                .toEither()</span>
<span class="fc" id="L86">                .mapLeft(Fhirs::invalidRequestException)</span>
<span class="fc" id="L87">                .flatMap(operationId -&gt; personResourceService.getDeleteOperationStatus(operationId).map(complete -&gt; Tuple.of(operationId, complete)))</span>
<span class="fc" id="L88">                .map(status -&gt; ParametersMapper.deleteOperationStatusParameters(status._1, status._2))</span>
<span class="fc" id="L89">                .getOrElseThrow(Function.identity());</span>

    }

    private Validation&lt;Issues, UUID&gt; validateOperationId(StringParam operationIdString) {
<span class="fc" id="L94">        return Option.of(operationIdString.getValue())</span>
<span class="fc" id="L95">                .toValidation(errorFrom(&quot;Missing operation id&quot;))</span>
<span class="fc" id="L96">                .flatMap(ReferenceParamToUUIDConverter::toUUID);</span>
    }

    private Validation&lt;Seq&lt;Issues&gt;, UUID&gt; validatePersonRef(ReferenceParam personRef, RequestDetails request) {
<span class="fc" id="L100">        var namedPersonRef = new NamedParam&lt;&gt;(&quot;person&quot;, personRef, request.getParameters().get(&quot;person&quot;));</span>
<span class="fc" id="L101">        return referenceParamConverter.convertRequired(namedPersonRef, ResourceType.Person).mapError(io.vavr.collection.List::of);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>