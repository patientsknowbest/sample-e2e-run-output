<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QuestionnaireResourceProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.fhir.resourceprovider</a> &gt; <span class="el_source">QuestionnaireResourceProvider.java</span></div><h1>QuestionnaireResourceProvider.java</h1><pre class="source lang-java linenums">package com.pkb.api.fhir.resourceprovider;

import ca.uhn.fhir.rest.annotation.IdParam;
import ca.uhn.fhir.rest.annotation.Operation;
import ca.uhn.fhir.rest.annotation.OperationParam;
import ca.uhn.fhir.rest.annotation.Read;
import ca.uhn.fhir.rest.annotation.Search;
import ca.uhn.fhir.rest.api.server.RequestDetails;
import com.pkb.api.fhir.BundleMapper;
import com.pkb.api.fhir.config.FhirApiProperties;
import com.pkb.api.fhir.converter.IdentifierConverter;
import com.pkb.api.fhir.converter.ReferenceToTypeAndUUIDConverter;
import com.pkb.api.fhir.questionnaire.QuestionnaireResourceService;
import com.pkb.api.fhir.service.AuthenticationService;
import com.pkb.api.fhir.util.Fhirs;
import com.pkb.api.fhir.util.Issues;
import com.pkb.authentication.AuthenticatedIdentity;
import com.pkb.domain.questionnaire.ImmutableQuestionnaireRequestCriteria;
import io.vavr.control.Validation;
import org.apache.commons.lang3.tuple.Pair;
import org.hl7.fhir.dstu3.model.Bundle;
import org.hl7.fhir.dstu3.model.IdType;
import org.hl7.fhir.dstu3.model.Identifier;
import org.hl7.fhir.dstu3.model.Parameters;
import org.hl7.fhir.dstu3.model.Questionnaire;
import org.hl7.fhir.dstu3.model.Reference;
import org.hl7.fhir.dstu3.model.ResourceType;
import org.jetbrains.annotations.NotNull;

import java.util.EnumSet;
import java.util.List;
import java.util.Optional;
import java.util.UUID;
import java.util.function.Function;

import static com.pkb.api.fhir.util.Fhirs.invalidRequestException;
import static com.pkb.api.fhir.util.Fhirs.notFoundDueToInvalidUUIDException;
import static com.pkb.api.fhir.util.Fhirs.uuid;
import static io.vavr.API.None;
import static org.hl7.fhir.dstu3.model.OperationOutcome.IssueType.INVALID;


public class QuestionnaireResourceProvider extends AbstractResourceProvider {

    private final FhirApiProperties fhirConfig;
    private final BundleMapper bundleMapper;
    private final ReferenceToTypeAndUUIDConverter referenceToTypeAndUUIDConverter;
    private final IdentifierConverter identifierConverter;
    private final QuestionnaireResourceService questionnaireResourceService;
    private final AuthenticationService authenticationService;

    public QuestionnaireResourceProvider(
            @NotNull FhirApiProperties fhirConfig,
            @NotNull BundleMapper bundleMapper,
            @NotNull ReferenceToTypeAndUUIDConverter referenceToTypeAndUUIDConverter,
            @NotNull IdentifierConverter identifierConverter,
            @NotNull QuestionnaireResourceService questionnaireResourceService,
            @NotNull AuthenticationService authenticationService) {
<span class="fc" id="L59">        super(Questionnaire.class);</span>
<span class="fc" id="L60">        this.fhirConfig = fhirConfig;</span>
<span class="fc" id="L61">        this.bundleMapper = bundleMapper;</span>
<span class="fc" id="L62">        this.referenceToTypeAndUUIDConverter = referenceToTypeAndUUIDConverter;</span>
<span class="fc" id="L63">        this.identifierConverter = identifierConverter;</span>
<span class="fc" id="L64">        this.questionnaireResourceService = questionnaireResourceService;</span>
<span class="fc" id="L65">        this.authenticationService = authenticationService;</span>
<span class="fc" id="L66">    }</span>

    @Search
    public Bundle searchQuestionnaires(RequestDetails request) {
<span class="fc" id="L70">        var authenticatedIdentity = authenticationService.authenticateOrThrow(request);</span>

        //We don't currently accept any search params so no validation to perform
        //note NotFound and NotAuthorised errors should already have been filtered out to return empty results sets. So any errors coming from here are errors we want to communicate
<span class="fc" id="L74">        var questionnaires = questionnaireResourceService.findQuestionnaires(authenticatedIdentity).getOrElseThrow(Function.identity());</span>

<span class="fc" id="L76">        return bundleMapper.toBundle(questionnaires, request, None());</span>

    }

    @Read
    public Questionnaire getResourceById(@IdParam IdType questionnaireId, RequestDetails request) {
<span class="fc" id="L82">        var authenticatedIdentity = authenticationService.authenticateOrThrow(request);</span>
<span class="fc" id="L83">        return uuid(questionnaireId)</span>
<span class="fc" id="L84">                .mapLeft(error -&gt; notFoundDueToInvalidUUIDException(questionnaireId))</span>
<span class="fc" id="L85">                .flatMap(q -&gt; questionnaireResourceService.getQuestionnaire(authenticatedIdentity, q))</span>
<span class="fc" id="L86">                .getOrElseThrow(Function.identity());</span>
    }

    @Operation(type = Parameters.class, name = &quot;$send-questionnaire-request&quot;)
    public Parameters sendQuestionnaireRequests(@IdParam IdType questionnaireId, RequestDetails request,
                                                @OperationParam(name = &quot;target&quot;) List&lt;Reference&gt; targets,
                                                @OperationParam(name = &quot;requestor&quot;) Reference requestor,
                                                @OperationParam(name = &quot;additionalIdentifer&quot;) Identifier additionalIdentifer) {
<span class="fc" id="L94">        AuthenticatedIdentity authenticatedIdentity = authenticationService.authenticateOrThrow(request);</span>

<span class="fc" id="L96">        int maxTargets = fhirConfig.getQuestionnaireRequestOperationMaxNumberOfTargets();</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">        if(targets == null){</span>
<span class="fc" id="L98">            throw invalidRequestException(Issues.errorFrom(&quot;Mandatory target parameter missing&quot;, INVALID));</span>
<span class="fc bfc" id="L99" title="All 2 branches covered.">        } else if (targets.size() &gt; maxTargets) {</span>
<span class="fc" id="L100">            throw invalidRequestException(Issues.errorFrom(String.format(&quot;Too many target parameters, maximum value is: %s&quot;, maxTargets),</span>
                    INVALID));
        }
<span class="fc bfc" id="L103" title="All 2 branches covered.">        if (requestor == null) {</span>
<span class="fc" id="L104">            throw invalidRequestException(Issues.errorFrom(&quot;Mandatory requester parameter missing&quot;, INVALID));</span>
        }
        
<span class="fc" id="L107">        Validation&lt;Issues, List&lt;Pair&lt;ResourceType, UUID&gt;&gt;&gt; issuesOrTypedTarget = referenceToTypeAndUUIDConverter.convertFromAllowedResourceTypes(targets,</span>
<span class="fc" id="L108">                EnumSet.of(ResourceType.Patient, ResourceType.Organization));</span>
<span class="fc" id="L109">        Validation&lt;Issues, UUID&gt; issuesOrQuestionnaireUUID = Validation.fromEither(uuid(questionnaireId)</span>
<span class="fc" id="L110">                .mapLeft(operationOutcome -&gt; Issues.of(io.vavr.collection.List.ofAll(operationOutcome.getIssue()))));</span>
<span class="fc" id="L111">        Validation&lt;Issues, Pair&lt;ResourceType, UUID&gt;&gt; issuesOrRequestor = referenceToTypeAndUUIDConverter.convertFromAllowedResourceTypes(requestor,</span>
<span class="fc" id="L112">                EnumSet.of(ResourceType.Practitioner));</span>
<span class="fc" id="L113">        Validation&lt;Issues, Identifier&gt; issuesOrIdentifier = identifierConverter.validateSystemAndValue(additionalIdentifer);</span>

<span class="fc" id="L115">        return Validation.combine(issuesOrTypedTarget, issuesOrQuestionnaireUUID, issuesOrRequestor, issuesOrIdentifier)</span>
<span class="fc" id="L116">                .ap((typedTargets, questionnaireUUID, typedRequestor, identifier) -&gt; ImmutableQuestionnaireRequestCriteria.builder().targets(typedTargets)</span>
<span class="fc" id="L117">                        .questionnaireId(questionnaireUUID)</span>
<span class="fc" id="L118">                        .authenticatedIdentity(authenticatedIdentity)</span>
<span class="fc" id="L119">                        .requestorId(typedRequestor.getRight())</span>
<span class="fc" id="L120">                        .additionalIdentifier(Optional.ofNullable(additionalIdentifer))</span>
<span class="fc" id="L121">                        .build())</span>
<span class="fc" id="L122">                .mapError(Issues::flatten)</span>
<span class="fc" id="L123">                .mapError(Fhirs::invalidRequestException)</span>
<span class="fc" id="L124">                .flatMap(requestCriteria -&gt; Validation.fromEither(</span>
<span class="fc" id="L125">                        questionnaireResourceService.sendQuestionnaireRequests(requestCriteria)))</span>
<span class="fc" id="L126">                .fold(e -&gt; {</span>
<span class="fc" id="L127">                    throw e;</span>
<span class="fc" id="L128">                }, x -&gt; x);</span>
    }
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>