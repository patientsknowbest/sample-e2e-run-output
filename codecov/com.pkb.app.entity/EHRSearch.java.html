<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EHRSearch.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.app.entity</a> &gt; <span class="el_source">EHRSearch.java</span></div><h1>EHRSearch.java</h1><pre class="source lang-java linenums">package com.pkb.app.entity;

import com.google.common.annotations.VisibleForTesting;
import com.google.common.base.Preconditions;
import com.google.common.collect.Sets;
import com.pkb.entities.enums.MenuDataType;
import com.pkb.messaging.workflow.ConversationWorkflowFilterDTO;
import org.jetbrains.annotations.NotNull;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collection;
import java.util.HashSet;
import java.util.List;
import java.util.Optional;
import java.util.Set;

import static java.util.Collections.emptySet;
import static java.util.Collections.singletonList;
import static org.apache.commons.collections4.CollectionUtils.isEmpty;

/**
 * Params for searching menudata
 * &lt;p&gt;
 * Default filter values on EHRData columns
 * &lt;p&gt;
 * deleted = false
 *
 * @author robwhelan
 * @see EHRBean
 */
public class EHRSearch&lt;D&gt; implements Serializable {
    private static final long serialVersionUID = 1L;

    private EHRRequestContext requestContext;

<span class="fc" id="L38">    public enum OrderByDirection {</span>
<span class="fc" id="L39">        Asc, Desc</span>
    }

    private DTOMapping&lt;D&gt; dtoMapping;
    private final Class&lt;D&gt; dtoClass;
    private Set&lt;MenuDataType&gt; dataTypes;
    private Collection&lt;Long&gt; accountIdList;

<span class="fc" id="L47">    private final List&lt;PKBFilter&gt; filters = new ArrayList&lt;&gt;();</span>

    // the &quot;latest per type field&quot; filter: see #setLatestPerTypeFilter()
<span class="fc" id="L50">    private String latestFilterDateField = null;</span>
<span class="fc" id="L51">    private String latestFilterTypeField = null;</span>
<span class="fc" id="L52">    private OrderByDirection latestFilterOrderBy = null;</span>
<span class="fc" id="L53">    private boolean latestFilterByVisibleOnly = false;</span>

<span class="fc" id="L55">    private boolean includeDeleted = false;</span>

<span class="fc" id="L57">    private int resultsStartPosition = 0; // default: first result (0-based)</span>
<span class="fc" id="L58">    private int resultsMaxReturned = 0; // default: no limit</span>

    private OrderByDirection orderByDirection;
    private String orderByField;

<span class="fc" id="L63">    private Set&lt;String&gt; fieldsRequestedSet = new HashSet&lt;&gt;();</span>

<span class="fc" id="L65">    private boolean useParticipantFilter = false;</span>

<span class="fc" id="L67">    private ConversationWorkflowFilterDTO conversationWorkflowFilter = null;</span>

    /**
     * @param accountId must not be null or &lt;= 0 -- see other constructor to search across multiple accounts.
     */
    public EHRSearch(long accountId, Class&lt;D&gt; dtoClass, MenuDataType dataType) {
<span class="fc" id="L73">        this(singletonList(accountId), dtoClass, Sets.immutableEnumSet(dataType));</span>
<span class="fc" id="L74">    }</span>

    public EHRSearch(Collection&lt;Long&gt; accountIdList, Class&lt;D&gt; dtoClass, MenuDataType dataType) {
<span class="fc" id="L77">        this(accountIdList, dtoClass,</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">                (dataType != null) ? Sets.immutableEnumSet(dataType) : emptySet());</span>
<span class="fc" id="L79">    }</span>

    /**
     * @param accountIdList search across multiple accounts
     * @param dataTypes     by convention this is a constant in the DTO. Some DTOs may support more than one data type.
     */
<span class="fc" id="L85">    public EHRSearch(Collection&lt;Long&gt; accountIdList, Class&lt;D&gt; dtoClass, Set&lt;MenuDataType&gt; dataTypes) {</span>
<span class="fc" id="L86">        this.accountIdList = accountIdList;</span>

<span class="pc bpc" id="L88" title="2 of 4 branches missed.">        if (isEmpty(accountIdList) || accountIdList.iterator().next() &lt;= 0) {</span>
<span class="nc" id="L89">            throw new IllegalArgumentException(&quot;Need at least one accountId; got: &quot; + accountIdList);</span>
        }

<span class="fc" id="L92">        this.dataTypes = dataTypes;</span>
<span class="fc" id="L93">        this.dtoMapping = DTOMapping.get(dtoClass);</span>
<span class="fc" id="L94">        this.dtoClass = dtoClass;</span>
<span class="fc" id="L95">    }</span>

    /**
     * Avoid this constructor unless you must query without an account ID (decryption not possible)
     * E.g. see EHRBean.findEHRData()
     *
     * @param dataTypes by convention this is a constant in the DTO. Some DTOs may support more than one data type.
     */
<span class="fc" id="L103">    public EHRSearch(Class&lt;D&gt; dtoClass, Set&lt;MenuDataType&gt; dataTypes) {</span>
<span class="fc" id="L104">        this.accountIdList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L105">        this.dataTypes = dataTypes;</span>
<span class="fc" id="L106">        this.dtoMapping = DTOMapping.get(dtoClass);</span>
<span class="fc" id="L107">        this.dtoClass = dtoClass;</span>
<span class="fc" id="L108">    }</span>

    public EHRSearch(@NotNull EHRSearch&lt;?&gt; copyFrom, Class&lt;D&gt; dtoClass, MenuDataType dataType) {
<span class="fc" id="L111">        this(copyFrom.getAccountIds(), dtoClass, dataType);</span>

        // copy in the filters
        // ...I'm looking for a way to do this like &quot;BeanUtils.copyPropertiesExcept()&quot; but haven't found it yet
<span class="fc" id="L115">        fieldsRequestedSet = copyFrom.fieldsRequestedSet;</span>

<span class="fc" id="L117">        filters.addAll(copyFrom.filters);</span>

<span class="fc" id="L119">        latestFilterDateField = copyFrom.latestFilterDateField;</span>
<span class="fc" id="L120">        latestFilterTypeField = copyFrom.latestFilterTypeField;</span>
<span class="fc" id="L121">        latestFilterOrderBy = copyFrom.latestFilterOrderBy;</span>
<span class="fc" id="L122">        latestFilterByVisibleOnly = copyFrom.latestFilterByVisibleOnly;</span>

<span class="fc" id="L124">        includeDeleted = copyFrom.includeDeleted;</span>

<span class="fc" id="L126">        resultsStartPosition = copyFrom.resultsStartPosition;</span>
<span class="fc" id="L127">        resultsMaxReturned = copyFrom.resultsMaxReturned;</span>

<span class="fc" id="L129">        orderByDirection = copyFrom.orderByDirection;</span>
<span class="fc" id="L130">        orderByField = copyFrom.orderByField;</span>

<span class="fc" id="L132">        useParticipantFilter = copyFrom.useParticipantFilter;</span>

<span class="fc" id="L134">        conversationWorkflowFilter = copyFrom.conversationWorkflowFilter;</span>
<span class="fc" id="L135">    }</span>

    public Optional&lt;EHRRequestContext&gt; getRequestContext() {
<span class="fc" id="L138">        return Optional.ofNullable(requestContext);</span>
    }

    public void setRequestContext(EHRRequestContext requestContext) {
<span class="fc" id="L142">        this.requestContext = requestContext;</span>
<span class="fc" id="L143">    }</span>

    public DTOMapping&lt;?&gt; map() {
<span class="fc" id="L146">        return dtoMapping;</span>
    }

    public boolean isEncryptedFieldsRequested() {
<span class="fc" id="L150">        return dtoMapping.containsEncryptedField(fieldsRequestedSet);</span>
    }

    /**
     * Special filter: return the single latest record for this data type, grouping by &quot;typeField&quot;.
     * For example: return the latest result for each LoincTest private ID in a list.
     * &lt;p&gt;
     * To limit the values in the &quot;type&quot; field, add a filter.
     * If no fiter is set, this query will return the latest for *all* available typeField values.
     *
     * @param dateField DTO field name; must be annotated with a link to an internal field (like date02); e.g., &quot;enteredDate&quot;
     * @param typeField DTO field name; must be annotated as an internal field (like long02); e.g., &quot;diagnosisPrivateId&quot;
     */
    public EHRSearch&lt;D&gt; setLatestPerTypeFilter(@NotNull String dateField, @NotNull String typeField) {
<span class="fc" id="L164">        latestFilterDateField = dateField;</span>
<span class="fc" id="L165">        latestFilterTypeField = typeField;</span>
<span class="fc" id="L166">        latestFilterOrderBy = OrderByDirection.Desc;</span>
<span class="fc" id="L167">        latestFilterByVisibleOnly = false;</span>
<span class="fc" id="L168">        return this;</span>
    }

    public EHRSearch&lt;D&gt; setLatestPerTypeFilter(@NotNull String dateField, @NotNull String typeField, @NotNull OrderByDirection orderBy) {
<span class="fc" id="L172">        latestFilterDateField = dateField;</span>
<span class="fc" id="L173">        latestFilterTypeField = typeField;</span>
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">        latestFilterOrderBy = orderBy != null ? orderBy : OrderByDirection.Desc;</span>
<span class="fc" id="L175">        latestFilterByVisibleOnly = false;</span>
<span class="fc" id="L176">        return this;</span>
    }

    public EHRSearch&lt;D&gt; setLatestPerTypeFilter(@NotNull String dateField, @NotNull String typeField, @NotNull OrderByDirection orderBy, boolean visibleOnly) {
<span class="fc" id="L180">        latestFilterDateField = dateField;</span>
<span class="fc" id="L181">        latestFilterTypeField = typeField;</span>
<span class="pc bpc" id="L182" title="1 of 2 branches missed.">        latestFilterOrderBy = orderBy != null ? orderBy : OrderByDirection.Desc;</span>
<span class="fc" id="L183">        latestFilterByVisibleOnly = visibleOnly;</span>
<span class="fc" id="L184">        return this;</span>
    }

    public EHRSearch&lt;D&gt; addFilter(PKBFilter filter) {
<span class="fc" id="L188">        filters.add(filter);</span>
<span class="fc" id="L189">        return this;</span>
    }

    // internal only -- for external access, force prep filters first
    @VisibleForTesting
    List&lt;PKBFilter&gt; getFilters() {
<span class="nc" id="L195">        return filters;</span>
    }


    /**
     * see applyWhenChoosingLatest in PKBFilter
     */
    public List&lt;PKBFilter&gt; getDataFilters(boolean choosingLatest) {
<span class="pc bpc" id="L203" title="1 of 2 branches missed.">        if (choosingLatest) {</span>
            // only return filters that apply to choosing latest
<span class="nc" id="L205">            List&lt;PKBFilter&gt; sublist = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L206" title="All 2 branches missed.">            for (PKBFilter f : filters) {</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">                if (f.isApplyWhenChoosingLatest()) {</span>
<span class="nc" id="L208">                    sublist.add(f);</span>
                }
<span class="nc" id="L210">            }</span>
<span class="nc" id="L211">            return sublist;</span>
        } else {
<span class="fc" id="L213">            return filters;</span>
        }
    }


    public boolean containsFilterFor(String field) {
<span class="fc" id="L219">        return filters.stream().anyMatch(f -&gt; f.getField().equals(field));</span>
    }

    /**
     * For EHRBean.queryEHRDataFields() -- select the fields you want returned in the map (generally, DTO field names, though
     * EHRData field names, or database column names, should also be correctly handled).
     */
    public EHRSearch&lt;D&gt; addFields(String... field) {
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">        if (field != null) {</span>
<span class="fc" id="L228">            fieldsRequestedSet.addAll(Arrays.asList(field));</span>
        }
<span class="fc" id="L230">        return this;</span>
    }

    public Collection&lt;Long&gt; getAccountIds() {
<span class="fc" id="L234">        return accountIdList;</span>
    }

    public MenuDataType getSingleDataType() {
<span class="pc bpc" id="L238" title="2 of 4 branches missed.">        Preconditions.checkState(dataTypes != null &amp;&amp; dataTypes.size() == 1, &quot;This EHRSearch does not have a single data type: %s&quot;, dataTypes);</span>

<span class="fc" id="L240">        return dataTypes.iterator().next();</span>
    }

    public Set&lt;MenuDataType&gt; getDataTypes() {
<span class="fc" id="L244">        return dataTypes;</span>
    }

    public EHRSearch&lt;D&gt; setOrderBy(String field, OrderByDirection direction) {
        // this is probably the DTO column: map to EHRData fieldsRequested
<span class="fc" id="L249">        this.orderByField = field;</span>
<span class="fc" id="L250">        this.orderByDirection = direction;</span>
<span class="fc" id="L251">        return this;</span>
    }

    public String getOrderByField() {
<span class="fc" id="L255">        return orderByField;</span>
    }

    public OrderByDirection getOrderByDirection() {
<span class="fc" id="L259">        return orderByDirection;</span>
    }

    public boolean isIncludeDeleted() {
<span class="fc" id="L263">        return includeDeleted;</span>
    }

    public EHRSearch&lt;D&gt; setIncludeDeleted(boolean includeDeleted) {
<span class="fc" id="L267">        this.includeDeleted = includeDeleted;</span>
<span class="fc" id="L268">        return this;</span>
    }

    public String getLatestFilterDateField() {
<span class="fc" id="L272">        return latestFilterDateField;</span>
    }

    public OrderByDirection getLatestFilterOrderBy() {
<span class="fc" id="L276">        return latestFilterOrderBy;</span>
    }

    public boolean getLatestFilterByVisibleOnly() {
<span class="fc" id="L280">        return latestFilterByVisibleOnly;</span>
    }

    public String getLatestFilterTypeField() {
<span class="fc" id="L284">        return latestFilterTypeField;</span>
    }

    public Set&lt;String&gt; getFieldsRequestedSet() {
<span class="fc" id="L288">        return fieldsRequestedSet;</span>
    }

    public int getResultsStartPosition() {
<span class="fc" id="L292">        return resultsStartPosition;</span>
    }

    /**
     * 0-based indexing (so to fetch results skipping the first 10 and starting with the 11th result, pass &quot;10&quot;).
     */
    public EHRSearch&lt;D&gt; setResultsStartPosition(int resultsStartPosition) {
<span class="fc" id="L299">        this.resultsStartPosition = resultsStartPosition;</span>
<span class="fc" id="L300">        return this;</span>
    }

    public int getResultsMaxReturned() {
<span class="fc" id="L304">        return resultsMaxReturned;</span>
    }

    /**
     * Limit the number of results returned.
     */
    public EHRSearch&lt;D&gt; setResultsMaxReturned(int resultsMaxReturned) {
<span class="fc" id="L311">        this.resultsMaxReturned = resultsMaxReturned;</span>
<span class="fc" id="L312">        return this;</span>
    }

    /**
     * @return The class of the entities that the {@link EHRSearch} searches for.
     */
    public Class&lt;D&gt; getDtoClass() {
<span class="fc" id="L319">        return dtoClass;</span>
    }

    public void setUseParticipantFilter() {
<span class="fc" id="L323">        useParticipantFilter = true;</span>
<span class="fc" id="L324">    }</span>

    public boolean getUseParticipantFilter() {
<span class="fc" id="L327">        return useParticipantFilter;</span>
    }

    public ConversationWorkflowFilterDTO getConversationWorkflowFilter() {
<span class="fc" id="L331">        return conversationWorkflowFilter;</span>
    }

    public void setConversationWorkflowFilter(ConversationWorkflowFilterDTO conversationWorkflowFilter) {
<span class="fc" id="L335">        this.conversationWorkflowFilter = conversationWorkflowFilter;</span>
<span class="fc" id="L336">    }</span>

    @Override
    public String toString() {
<span class="nc" id="L340">        return &quot;EHRSearch [dtoMapping=&quot; + dtoMapping + &quot;, dtoClass=&quot; + dtoClass</span>
                + &quot;, dataTypes=&quot; + dataTypes + &quot;, accountIdList=&quot; + accountIdList + &quot;, filters=&quot; + filters
                + &quot;, latestFilterDateField=&quot; + latestFilterDateField + &quot;, latestFilterTypeField=&quot;
                + latestFilterTypeField + &quot;, includeDeleted=&quot; + includeDeleted + &quot;, resultsStartPosition=&quot; + resultsStartPosition
                + &quot;, resultsMaxReturned=&quot; + resultsMaxReturned + &quot;, orderByDirection=&quot; + orderByDirection + &quot;, orderByField=&quot; + orderByField
                + &quot;, fieldsRequestedSet=&quot; + fieldsRequestedSet + &quot;]&quot;;
    }

    @SuppressWarnings(&quot;OverlyComplexMethod&quot;)
    @Override
    public boolean equals(Object o) {
<span class="nc bnc" id="L351" title="All 2 branches missed.">        if (this == o) {</span>
<span class="nc" id="L352">            return true;</span>
        }
<span class="nc bnc" id="L354" title="All 4 branches missed.">        if (o == null || getClass() != o.getClass()) {</span>
<span class="nc" id="L355">            return false;</span>
        }

<span class="nc" id="L358">        EHRSearch&lt;?&gt; ehrSearch = (EHRSearch&lt;?&gt;) o;</span>

<span class="nc bnc" id="L360" title="All 2 branches missed.">        if (includeDeleted != ehrSearch.includeDeleted) {</span>
<span class="nc" id="L361">            return false;</span>
        }
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (resultsStartPosition != ehrSearch.resultsStartPosition) {</span>
<span class="nc" id="L364">            return false;</span>
        }
<span class="nc bnc" id="L366" title="All 2 branches missed.">        if (resultsMaxReturned != ehrSearch.resultsMaxReturned) {</span>
<span class="nc" id="L367">            return false;</span>
        }
<span class="nc bnc" id="L369" title="All 6 branches missed.">        if (dataTypes != null ? !dataTypes.equals(ehrSearch.dataTypes) : ehrSearch.dataTypes != null) {</span>
<span class="nc" id="L370">            return false;</span>
        }
<span class="nc bnc" id="L372" title="All 6 branches missed.">        if (accountIdList != null ? !accountIdList.equals(ehrSearch.accountIdList) : ehrSearch.accountIdList != null) {</span>
<span class="nc" id="L373">            return false;</span>
        }
<span class="nc bnc" id="L375" title="All 2 branches missed.">        if (filters.equals(ehrSearch.filters)) {</span>
<span class="nc" id="L376">            return false;</span>
        }
<span class="nc bnc" id="L378" title="All 2 branches missed.">        if (latestFilterDateField != null ?</span>
<span class="nc bnc" id="L379" title="All 4 branches missed.">                !latestFilterDateField.equals(ehrSearch.latestFilterDateField) :</span>
                ehrSearch.latestFilterDateField != null) {
<span class="nc" id="L381">            return false;</span>
        }
<span class="nc bnc" id="L383" title="All 2 branches missed.">        if (latestFilterTypeField != null ?</span>
<span class="nc bnc" id="L384" title="All 4 branches missed.">                !latestFilterTypeField.equals(ehrSearch.latestFilterTypeField) :</span>
                ehrSearch.latestFilterTypeField != null) {
<span class="nc" id="L386">            return false;</span>
        }
<span class="nc bnc" id="L388" title="All 2 branches missed.">        if (orderByDirection != ehrSearch.orderByDirection) {</span>
<span class="nc" id="L389">            return false;</span>
        }
<span class="nc bnc" id="L391" title="All 6 branches missed.">        if (orderByField != null ? !orderByField.equals(ehrSearch.orderByField) : ehrSearch.orderByField != null) {</span>
<span class="nc" id="L392">            return false;</span>
        }
<span class="nc bnc" id="L394" title="All 4 branches missed.">        return fieldsRequestedSet != null ? fieldsRequestedSet.equals(ehrSearch.fieldsRequestedSet) : ehrSearch.fieldsRequestedSet == null;</span>
    }

    @SuppressWarnings(&quot;OverlyComplexMethod&quot;)
    @Override
    public int hashCode() {
<span class="nc bnc" id="L400" title="All 2 branches missed.">        int result = (dataTypes != null ? dataTypes.hashCode() : 0);</span>
<span class="nc bnc" id="L401" title="All 2 branches missed.">        result = 31 * result + (accountIdList != null ? accountIdList.hashCode() : 0);</span>
<span class="nc" id="L402">        result = 31 * result + filters.hashCode();</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">        result = 31 * result + (latestFilterDateField != null ? latestFilterDateField.hashCode() : 0);</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">        result = 31 * result + (latestFilterTypeField != null ? latestFilterTypeField.hashCode() : 0);</span>
<span class="nc bnc" id="L405" title="All 2 branches missed.">        result = 31 * result + (includeDeleted ? 1 : 0);</span>
<span class="nc" id="L406">        result = 31 * result + resultsStartPosition;</span>
<span class="nc" id="L407">        result = 31 * result + resultsMaxReturned;</span>
<span class="nc bnc" id="L408" title="All 2 branches missed.">        result = 31 * result + (orderByDirection != null ? orderByDirection.hashCode() : 0);</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">        result = 31 * result + (orderByField != null ? orderByField.hashCode() : 0);</span>
<span class="nc bnc" id="L410" title="All 2 branches missed.">        result = 31 * result + (fieldsRequestedSet != null ? fieldsRequestedSet.hashCode() : 0);</span>
<span class="nc" id="L411">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>