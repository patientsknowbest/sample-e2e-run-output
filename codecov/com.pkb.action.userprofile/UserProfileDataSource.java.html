<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserProfileDataSource.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.userprofile</a> &gt; <span class="el_source">UserProfileDataSource.java</span></div><h1>UserProfileDataSource.java</h1><pre class="source lang-java linenums">package com.pkb.action.userprofile;

import com.google.common.annotations.VisibleForTesting;
import com.pkb.VersionDetails;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.common.base.Error;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.datamodel.Email;
import com.pkb.domain.OrgNetworkService;
import com.pkb.entities.enums.NationalIdType;
import com.pkb.entities.enums.UserType;
import com.pkb.exception.ApiCallMalformedException;
import com.pkb.exception.MailException;
import com.pkb.exception.PKBException;
import com.pkb.institute.entity.Team;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.patientconsent.PatientConsentManager;
import com.pkb.service.reminders.ReminderManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.PersonContactManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.NationalId;
import com.pkb.user.entity.OrgLevelId;
import com.pkb.user.entity.OrgLevelIdType;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PersonContact;
import com.pkb.user.entity.TeamLevelId;
import com.pkb.user.entity.TeamLevelIdType;
import com.pkb.util.ContextUserUtil;
import com.pkb.util.FormValidationErrors;
import com.pkb.util.FormValidator;
import com.pkb.util.InvalidUIDateException;
import com.pkb.util.LoggedInUserUtil;
import com.pkb.util.PKBServiceUtil;
import com.pkb.util.PersonAmbiguityHandler;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.invoke.MethodHandles;
import java.util.ArrayList;
import java.util.Date;
import java.util.EnumSet;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.SortedSet;
import java.util.function.Supplier;

import static com.google.common.base.Suppliers.memoize;
import static com.pkb.entities.enums.UserType.PATIENT;
import static com.pkb.entities.enums.UserType.REG_CLINICIAN;
import static com.pkb.user.entity.PKBPerson.Lazy.CONTACTS_DEEP;
import static com.pkb.user.entity.PKBPerson.Lazy.NATIONAL_AND_LOCAL_IDS;
import static com.pkb.util.Validators.maxLength;
import static com.pkb.util.Validators.minLength;
import static com.pkb.util.Validators.phoneNumberMandatory;
import static com.pkb.util.Validators.phoneNumberOptional;
import static com.pkb.util.Validators.required;
import static java.util.Arrays.asList;
import static java.util.Collections.emptyList;
import static java.util.stream.Collectors.toList;
import static org.apache.commons.collections4.CollectionUtils.isNotEmpty;
import static org.apache.commons.lang3.StringUtils.isBlank;
import static org.apache.commons.lang3.StringUtils.isNotBlank;
import static org.apache.commons.lang3.StringUtils.trimToEmpty;


public class UserProfileDataSource {

<span class="fc" id="L71">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

    @VisibleForTesting
    static boolean setPrimaryEmailOnPerson(PKBPerson person, @NotNull Email newPrimaryEmail) {
        // To be safe, assume that other PKBPerson instances might not have a matching email address
        // In that case, leave the existing primary contact unmodified
<span class="fc" id="L77">        return person.flipPrimaryFlagIfPresent(newPrimaryEmail);</span>
    }

    private final LoggedInUserUtil loggedInUserUtil;

    private final ContextUserUtil contextUserUtil;

    private final UserManager userManager;

    private final TeamUserManager teamUserManager;

    private final ReminderManager reminderManager;

    private final PersonContactManager personContactManager;

    private final PKBEmailMessageManager emailMessageManager;

    private final PatientConsentManager patientConsentManager;

    private final OrgNetworkService orgNetworkManager;

    private final DateTimeService dateTimeService;

    private final EHRRequestContext requestContext;

    private final Supplier&lt;PKBPerson&gt; personUnderEdit;

    private final Supplier&lt;List&lt;TeamLevelIdType&gt;&gt; handledTeamLevelIdTypes;

    private final Supplier&lt;UserProfile&gt; profile;

    private final Supplier&lt;List&lt;OrgLevelIdType&gt;&gt; handledOrgLevelIdTypes;

    private final Supplier&lt;Boolean&gt; viewingProfileOfTeamUser;

    private final Supplier&lt;String&gt; teamCountryCode;

    private final Supplier&lt;Team&gt; loggedInUserTeam;

    UserProfileDataSource(
            @NotNull LoggedInUserUtil loggedInUserUtil,
            @NotNull ContextUserUtil contextUserUtil,
            @NotNull UserManager userManager,
            @NotNull TeamUserManager teamUserManager,
            @NotNull ReminderManager reminderManager,
            @NotNull PersonContactManager personContactManager,
            @NotNull PKBEmailMessageManager emailMessageManager,
            @NotNull PatientConsentManager patientConsentManager,
            @NotNull DateTimeService dateTimeService,
            @NotNull OrgNetworkService orgNetworkManager,
<span class="fc" id="L127">            @NotNull EHRRequestContext requestContext) {</span>
<span class="fc" id="L128">        this.loggedInUserUtil = loggedInUserUtil;</span>
<span class="fc" id="L129">        this.contextUserUtil = contextUserUtil;</span>
<span class="fc" id="L130">        this.userManager = userManager;</span>
<span class="fc" id="L131">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L132">        this.reminderManager = reminderManager;</span>
<span class="fc" id="L133">        this.personContactManager = personContactManager;</span>
<span class="fc" id="L134">        this.patientConsentManager = patientConsentManager;</span>
<span class="fc" id="L135">        this.emailMessageManager = emailMessageManager;</span>
<span class="fc" id="L136">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L137">        this.orgNetworkManager = orgNetworkManager;</span>
<span class="fc" id="L138">        this.requestContext = requestContext;</span>
<span class="fc" id="L139">        personUnderEdit = memoize(this::computePersonUnderEdit);</span>
<span class="fc" id="L140">        loggedInUserTeam = memoize(loggedInUserUtil::getLoggedInUserPrimaryTeam);</span>
<span class="fc" id="L141">        handledTeamLevelIdTypes = memoize(this::computeHandledTeamLevelIdTypes);</span>
<span class="fc" id="L142">        profile = memoize(this::computeProfile);</span>
<span class="fc" id="L143">        handledOrgLevelIdTypes = memoize(this::computeHandledOrgLevelIdTypes);</span>
<span class="fc" id="L144">        viewingProfileOfTeamUser = memoize(this::computeViewingProfileOfTeamUser);</span>
<span class="fc" id="L145">        teamCountryCode = memoize(this::computeTeamCountryCode);</span>
<span class="fc" id="L146">    }</span>

    private String computeTeamCountryCode() {
<span class="fc bfc" id="L149" title="All 2 branches covered.">        if (!viewingAsPatient()) {</span>
<span class="fc" id="L150">            Team team = loggedInUserTeam.get();</span>
<span class="fc bfc" id="L151" title="All 2 branches covered.">            if (team != null) {</span>
<span class="fc" id="L152">                return team.getCountry();</span>
            }
        }
<span class="fc" id="L155">        return null;</span>
    }

    private PKBPerson computePersonUnderEdit() {
<span class="fc" id="L159">        return Optional.ofNullable(contextUserUtil.getContextUser())</span>
<span class="fc" id="L160">                .orElseGet(() -&gt; userManager.getPKBPerson(loggedInUserUtil.getLoggedInUserId(), CONTACTS_DEEP, NATIONAL_AND_LOCAL_IDS));</span>
    }

    private UserProfile computeProfile() {
<span class="fc" id="L164">        UserProfile profile = new UserProfile(personUnderEdit.get());</span>
<span class="fc bfc" id="L165" title="All 2 branches covered.">        if (viewingProfileOfHealthcareWorker()) {</span>
<span class="fc" id="L166">            profile.setSpecialtyId(userManager.getClinicianSpecialty(profile.getId()));</span>
        }
<span class="fc" id="L168">        populateIdentifiers(profile);</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">        if (viewingProfileOfTeamProfessional()) {</span>
<span class="fc" id="L170">            populateOrgDetails(profile);</span>
        }
<span class="fc" id="L172">        profile.setSymptomsReminder(computeSymptomsReminderStatus());</span>
<span class="fc" id="L173">        profile.setContactList(personContactManager.getContactListDirect(personUnderEdit.get().getId()));</span>
<span class="fc" id="L174">        profile.setNationalIds(getNationalIds());</span>
<span class="fc" id="L175">        profile.setInstituteCountry(teamCountryCode.get());</span>
<span class="fc" id="L176">        return profile;</span>
    }

    private void populateIdentifiers(UserProfile profile) {
<span class="fc" id="L180">        profile.setGroupedTeamLevelIds(getHandledTeamLevelIdTypes().stream()</span>
<span class="fc" id="L181">                .map(TeamLevelIdType::getId)</span>
<span class="fc" id="L182">                .map(personUnderEdit.get()::getTeamLevelIdsByTypeAsCSV)</span>
<span class="fc" id="L183">                .collect(toList()));</span>
<span class="fc" id="L184">        profile.setGroupedOrgLevelIds(getHandledOrgLevelIdTypes().stream()</span>
<span class="fc" id="L185">                .map(OrgLevelIdType::getId)</span>
<span class="fc" id="L186">                .map(personUnderEdit.get()::getOrgLevelIdsByTypeAsCSV)</span>
<span class="fc" id="L187">                .collect(toList()));</span>
<span class="fc" id="L188">    }</span>

    private void populateOrgDetails(UserProfile profile) {
        try {
<span class="fc" id="L192">            Team team = teamUserManager.getClinicianTeam(requestContext, profile.getId());</span>
<span class="fc" id="L193">            profile.setOrganizationName(team.getOrg().getName());</span>
<span class="fc" id="L194">            profile.setOrganizationUnit(team.getName());</span>
<span class="nc" id="L195">        } catch (PKBException e) {</span>
<span class="nc" id="L196">            LOGGER.info(&quot;clinician does not have an active institute yet&quot;, e);</span>
<span class="fc" id="L197">        }</span>
<span class="fc" id="L198">    }</span>

    private List&lt;NationalId&gt; getNationalIds() {
        try {
<span class="fc" id="L202">            PKBPerson patient = personUnderEdit.get();</span>
<span class="fc" id="L203">            List&lt;NationalId&gt; nationalIds = patient.getNationalIds().stream().filter(nid -&gt; isNotBlank(nid.getValue())).collect(toList());</span>

<span class="fc" id="L205">            Optional&lt;NationalIdType&gt; maybeTeamNationalIdType = NationalIdType.getPrimaryNationalIdTypeFromCountryCode(teamCountryCode.get());</span>
<span class="fc" id="L206">            maybeTeamNationalIdType.ifPresent(teamNationalIdType -&gt; {</span>
<span class="fc" id="L207">                Optional&lt;NationalId&gt; maybeNationalIdForTeam = patient.getNationalIdByExactType(teamNationalIdType)</span>
<span class="fc" id="L208">                        .filter(nid -&gt; isNotBlank(nid.getValue()));</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">                if (maybeNationalIdForTeam.isEmpty()) {</span>
<span class="fc" id="L210">                    NationalId instituteNationalId = new NationalId(teamNationalIdType, &quot;&quot;, new VersionDetails());</span>
<span class="fc" id="L211">                    instituteNationalId.setPerson(contextUserUtil.getContextUser());</span>
<span class="fc" id="L212">                    nationalIds.add(instituteNationalId);</span>
                }
<span class="fc" id="L214">            });</span>
<span class="fc" id="L215">            return nationalIds;</span>
<span class="nc" id="L216">        } catch (Exception exception) {</span>
<span class="nc" id="L217">            LOGGER.error(&quot;Error getting nationalId for patient&quot;, exception);</span>
        }
<span class="nc" id="L219">        return emptyList();</span>
    }

    private SymptomsReminderCheckboxStatus computeSymptomsReminderStatus() {
<span class="fc bfc" id="L223" title="All 2 branches covered.">        if (!viewingProfileOfPatient()) {</span>
<span class="fc" id="L224">            return new SymptomsReminderCheckboxStatus();</span>
        }

<span class="fc" id="L227">        return new SymptomsReminderCheckboxStatus(emailRemindersEnabled(), reminderManager.isOptedIn(personUnderEdit.get().getId()));</span>
    }

    private boolean emailRemindersEnabled() {
<span class="fc" id="L231">        return teamUserManager.getUserTeams(requestContext, loggedInUserUtil.getLoggedInUserId(), true)</span>
<span class="fc" id="L232">                .stream().anyMatch(Team::isSendSymptomReminders);</span>
    }

    private boolean viewingProfileOfPatient() {
<span class="fc" id="L236">        return personUnderEdit.get().isPatient();</span>
    }

    public UserProfile getProfile() {
<span class="fc" id="L240">        return profile.get();</span>
    }

    /**
     * professional or teamcoord
     */
    private boolean viewingProfileOfHealthcareWorker() {
<span class="fc" id="L247">        PKBPerson person = personUnderEdit.get();</span>
<span class="fc bfc" id="L248" title="All 4 branches covered.">        return person.isPro() || person.isTeamCoordinator();</span>
    }

    private boolean viewingProfileOfProfessional() {
<span class="fc" id="L252">        return personUnderEdit.get().isPro();</span>
    }

    private boolean computeViewingProfileOfTeamUser() {
<span class="fc" id="L256">        return isTeamUser(personUnderEdit.get().getId());</span>
    }

    private boolean isTeamUser(long personId) {
<span class="fc" id="L260">        return teamUserManager.isTeamUser(personId);</span>
    }

    private boolean viewingProfileOfTeamProfessional() {
<span class="fc bfc" id="L264" title="All 4 branches covered.">        return viewingProfileOfProfessional() &amp;&amp; viewingProfileOfTeamUser.get();</span>
    }

    public FormValidationErrors updateProfile(EHRRequestContext requestContext, UserProfile updatedProfile)
            throws InvalidUIDateException {
<span class="fc" id="L269">        FormValidationErrors errors = validateBaseProperties(updatedProfile)</span>
<span class="fc" id="L270">                .plus(authenticateUser(updatedProfile.getCurrentPassword()));</span>

<span class="pc bpc" id="L272" title="1 of 6 branches missed.">        if (updatedProfile.getDob() != null &amp;&amp; !loggedInUserUtil.isLoggedInUserIndividualProfessional() &amp;&amp; !loggedInUserUtil.isLoggedInUserPatient()) {</span>
            try {
<span class="fc" id="L274">                updatedProfile.getDob().toFormattedDate();</span>
<span class="fc" id="L275">            } catch (InvalidUIDateException ignored) {</span>
<span class="fc" id="L276">                errors = errors.addFieldError(&quot;user.dob&quot;, new Error(&quot;user.not.valid.dob&quot;, &quot;invalid date format&quot;));</span>
<span class="fc" id="L277">            }</span>
        }

<span class="fc bfc" id="L280" title="All 2 branches covered.">        if (!errors.isEmpty()) {</span>
<span class="fc" id="L281">            return errors;</span>
        }
<span class="fc" id="L283">        long personId = personUnderEdit.get().getId();</span>
<span class="fc" id="L284">        PKBPerson person = userManager.getPKBPerson(personId, PKBPerson.Lazy.CONTACTS,</span>
                PKBPerson.Lazy.NATIONAL_AND_LOCAL_IDS);

<span class="fc" id="L287">        applyChanges(person, updatedProfile);</span>

<span class="fc" id="L289">        errors = updatePersonIdentifiers(updatedProfile, errors, person)</span>
<span class="fc" id="L290">                .plus(validateNationalIds(updatedProfile));</span>

<span class="fc" id="L292">        Long newPrimaryContactId = updatedProfile.getPrimaryContactId();</span>
<span class="pc bpc" id="L293" title="1 of 4 branches missed.">        if (errors.isEmpty() &amp;&amp; newPrimaryContactId != null) {</span>
<span class="fc" id="L294">            errors = updatePrimaryContact(person, newPrimaryContactId, errors);</span>
        }

<span class="pc bpc" id="L297" title="1 of 2 branches missed.">        if (errors.isEmpty()) {</span>
<span class="fc bfc" id="L298" title="All 4 branches covered.">            if ((teamCountryCode.get() != null) &amp;&amp; isNotEmpty(updatedProfile.getNationalIdNumbers())) {</span>
<span class="fc" id="L299">                populateNationalIds(requestContext, person, updatedProfile);</span>
            }
<span class="fc" id="L301">            userManager.updateUser(requestContext, person);</span>

            // If we had no national ids before the edit, but have one now,
            // we just verified! Sync up
<span class="fc bfc" id="L305" title="All 4 branches covered.">            if (viewingProfileOfPatient() &amp;&amp; didVerify(person)) {</span>
<span class="fc" id="L306">                Team team = loggedInUserTeam.get();</span>
<span class="pc bpc" id="L307" title="1 of 2 branches missed.">                if (team != null) {</span>
<span class="fc" id="L308">                    Long accountId = userManager.getDefaultAccountId(personUnderEdit.get().getId());</span>
<span class="fc" id="L309">                    orgNetworkManager.syncVerifiedPatientToOrgNetwork(person.getId());</span>
                }
            }
        }

<span class="fc bfc" id="L314" title="All 2 branches covered.">        if (viewingProfileOfHealthcareWorker()) {</span>
<span class="fc" id="L315">            userManager.saveClinicianSpecialty(person.getId(), updatedProfile.getSpecialtyId());</span>
        }

<span class="fc" id="L318">        SymptomsReminderCheckboxStatus symptomsReminderInput = updatedProfile.getSymptomsReminder();</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">        if (viewingProfileOfPatient() &amp;&amp;</span>
<span class="pc bpc" id="L320" title="1 of 2 branches missed.">                emailRemindersEnabled() &amp;&amp;</span>
<span class="nc bnc" id="L321" title="All 4 branches missed.">                loggedInUserUtil.isLoggedInUserActiveTeamMember() &amp;&amp;</span>
                symptomsReminderInput != null) {
<span class="nc" id="L323">            handleSymptomReminderOptUpdate(symptomsReminderInput);</span>
        }
<span class="fc" id="L325">        return errors;</span>
    }

    private FormValidationErrors updatePersonIdentifiers(UserProfile updatedProfile, FormValidationErrors errors, PKBPerson person) {
<span class="fc bfc" id="L329" title="All 2 branches covered.">        if (!loggedInUserUtil.isLoggedInUserActiveTeamMember()) {</span>
<span class="fc" id="L330">            return errors;</span>
        }

<span class="fc" id="L333">        return errors.addErrors(updateTeamLevelIdList(updatedProfile, person))</span>
<span class="fc" id="L334">                .addErrors(updateOrgLevelIdList(updatedProfile, person));</span>
    }

    private FormValidationErrors authenticateUser(String currentPassword) {
        try {
<span class="fc" id="L339">            userManager.authenticateUser(loggedInUserUtil.getLoggedInUserId(), currentPassword);</span>
<span class="fc" id="L340">        } catch (PKBException ignored) {</span>
<span class="fc" id="L341">            return new FormValidationErrors().addFieldError(&quot;currentPassword&quot;, new Error(&quot;user.notCorrect.password&quot;, &quot;incorrect password&quot;));</span>
<span class="fc" id="L342">        }</span>
<span class="fc" id="L343">        return FormValidationErrors.EMPTY;</span>
    }

    private boolean didVerify(PKBPerson postEditUser) {
<span class="fc" id="L347">        PKBPerson preEditUser = personUnderEdit.get();</span>
        // Detect if we a new national ID has been added
        // Checking of the country of a new national ID applies to any org networks happens at sync time
<span class="pc bpc" id="L350" title="1 of 2 branches missed.">        int previousCount = (preEditUser.getNationalIds() != null) ? preEditUser.getNationalIds().size() : 0;</span>
<span class="pc bpc" id="L351" title="1 of 2 branches missed.">        int newCount = (postEditUser.getNationalIds() != null) ? postEditUser.getNationalIds().size() : 0;</span>
<span class="fc bfc" id="L352" title="All 2 branches covered.">        return newCount &gt; previousCount;</span>
    }

    @VisibleForTesting
    void populateNationalIds(EHRRequestContext requestContext, PKBPerson person, UserProfile updatedProfile) {
<span class="fc" id="L357">        List&lt;NationalIdType&gt; originalNationalIdTypes = updatedProfile.getNationalIdTypes();</span>
<span class="fc" id="L358">        List&lt;String&gt; nationalIdNumbers = updatedProfile.getNationalIdNumbers();</span>
<span class="fc" id="L359">        Set&lt;NationalIdType&gt; wantedNationalIdTypes = EnumSet.noneOf(NationalIdType.class);</span>
<span class="fc" id="L360">        NationalIdType.getPrimaryNationalIdTypeFromCountryCode(teamCountryCode.get()).ifPresent(nationalIdForTeam -&gt; {</span>
<span class="fc bfc" id="L361" title="All 2 branches covered.">            for (int i = 0; i &lt; originalNationalIdTypes.size(); i++) {</span>
<span class="fc" id="L362">                NationalIdType nationalIdType = originalNationalIdTypes.get(i);</span>
<span class="fc bfc" id="L363" title="All 2 branches covered.">                if (nationalIdType.areUsedInSameCountry(nationalIdForTeam)) {</span>
<span class="fc" id="L364">                    String nationalIdNumber = trimToEmpty(nationalIdNumbers.get(i));</span>
<span class="fc bfc" id="L365" title="All 2 branches covered.">                    if (isNotBlank(nationalIdNumber)) {</span>
<span class="fc" id="L366">                        NationalId setId = new NationalId(nationalIdType, null, VersionDetails.of(requestContext));</span>
<span class="fc" id="L367">                        setId.setPerson(person);</span>
<span class="fc" id="L368">                        setId.setEditDate(Date.from(dateTimeService.now()));</span>
<span class="fc" id="L369">                        nationalIdType.getValidNationalIdAndType(nationalIdNumber).ifPresent(setId::setNationalId);</span>
<span class="fc" id="L370">                        person.addOrUpdateNationalId(requestContext,setId,dateTimeService.now());</span>
<span class="fc" id="L371">                        wantedNationalIdTypes.add(setId.getType());</span>
                    }

<span class="fc bfc" id="L374" title="All 2 branches covered.">                    if (!wantedNationalIdTypes.contains(nationalIdType)) {</span>
<span class="fc" id="L375">                        person.deleteNationalId(nationalIdType);</span>
                    }
                }
            }
<span class="fc" id="L379">        });</span>
<span class="fc" id="L380">    }</span>

    private FormValidationErrors validateNationalIds(UserProfile updatedProfile) {
<span class="fc" id="L383">        FormValidationErrors errors = new FormValidationErrors();</span>
<span class="fc bfc" id="L384" title="All 2 branches covered.">        if (loggedInUserUtil.getLoggedInUserType() != UserType.PATIENT) {</span>
            // only clinician or coordinator can change patient's national and local-level IDs
<span class="fc" id="L386">            Optional&lt;NationalIdType&gt; maybeNationalIdForTeam = NationalIdType.getPrimaryNationalIdTypeFromCountryCode(teamCountryCode.get());</span>
<span class="fc bfc" id="L387" title="All 4 branches covered.">            if (maybeNationalIdForTeam.isPresent() &amp;&amp; isNotEmpty(updatedProfile.getNationalIdNumbers())) {</span>
<span class="fc bfc" id="L388" title="All 2 branches covered.">                for (int i = 0; i &lt; updatedProfile.getNationalIdNumbers().size(); i++) {</span>
<span class="fc" id="L389">                    String nId = updatedProfile.getNationalIdNumbers().get(i);</span>
<span class="fc" id="L390">                    NationalIdType nationalIdType = updatedProfile.getNationalIdTypes().get(i);</span>
<span class="fc" id="L391">                    errors = errors.addErrors(validateNationalId(nationalIdType, nId));</span>
                }
            }
        }
<span class="fc" id="L395">        return errors;</span>
    }

    private List&lt;Error&gt; validateNationalId(NationalIdType nIdType, String nId) {
<span class="fc bfc" id="L399" title="All 2 branches covered.">        if (isBlank(nId)) {</span>
<span class="fc" id="L400">            return emptyList();</span>
        }
<span class="fc" id="L402">        List&lt;Error&gt; errors = new ArrayList&lt;&gt;(2);</span>
        try {
<span class="fc" id="L404">            nIdType.getValidNationalIdAndType(nId).ifPresentOrElse(vnid -&gt; {</span>
<span class="fc" id="L405">                PersonAmbiguityHandler.getMaybePersonOrNone(userManager.getPKBPersonByNationalId(vnid), &quot;nationalId&quot;)</span>
<span class="fc" id="L406">                            .peek(other -&gt; {</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">                                if (!other.getId().equals(personUnderEdit.get().getId())) {</span>
<span class="nc" id="L408">                                    errors.add(new Error(&quot;manageprofile.duplicate.national.id&quot;, &quot;national ID is already assigned&quot;, vnid.type().getName(), nId,</span>
<span class="nc" id="L409">                                            other.getTitle(), other.getFirstName(),</span>
<span class="nc" id="L410">                                            other.getLastName()));</span>
                                }
<span class="fc" id="L412">                            });</span>

                    try {
<span class="fc" id="L415">                        PKBServiceUtil.checkSandboxNationalID(loggedInUserUtil.getLoggedInUserOrg(), vnid.type(), vnid.value());</span>
<span class="nc" id="L416">                    } catch (ApiCallMalformedException ignored) {</span>
<span class="nc" id="L417">                        errors.add(new Error(&quot;manageprofile.invalid.sandbox.national.id&quot;, &quot;Sandbox only supports NHS numbers starting with 5 or 9&quot;));</span>
<span class="fc" id="L418">                    }</span>
<span class="fc" id="L419">                },</span>
<span class="nc" id="L420">                () -&gt; errors.add(new Error(&quot;manageprofile.invalid.national.id&quot;, &quot;invalid national ID&quot;, nId, nIdType.getName())));</span>

<span class="nc" id="L422">        } catch (Exception e) {</span>
<span class="nc" id="L423">            LOGGER.error(&quot;problem validating national ID&quot;, e);</span>
<span class="nc" id="L424">            errors.add(new Error(&quot;validation.error&quot;, &quot;error during national id validation&quot;));</span>
<span class="fc" id="L425">        }</span>
<span class="fc" id="L426">        return errors;</span>
    }

    private void handleSymptomReminderOptUpdate(SymptomsReminderCheckboxStatus symptomsReminderInput) {
<span class="nc" id="L430">        boolean optedIn = reminderManager.isOptedIn(personUnderEdit.get().getId());</span>
<span class="nc bnc" id="L431" title="All 4 branches missed.">        if (!optedIn &amp;&amp; symptomsReminderInput.isChecked()) {</span>
<span class="nc" id="L432">            reminderManager.optInSymptomReminder(personUnderEdit.get().getId());</span>
<span class="nc bnc" id="L433" title="All 4 branches missed.">        } else if (optedIn &amp;&amp; !symptomsReminderInput.isChecked()) {</span>
<span class="nc" id="L434">            reminderManager.optOutSymptomReminder(personUnderEdit.get().getId());</span>
        }
<span class="nc" id="L436">    }</span>

    private FormValidationErrors updatePrimaryContact(PKBPerson person, Long newPrimaryContactId, FormValidationErrors errors) {
<span class="fc" id="L439">        var preEditPrimaryContactMaybe = personContactManager.findPrimaryContact(person.getId());</span>
<span class="fc" id="L440">        person.setPrimaryContact(newPrimaryContactId);</span>
<span class="fc" id="L441">        PersonContact newPrimaryContact = personContactManager.getPersonContact(person.getId(), newPrimaryContactId);</span>

<span class="pc bpc" id="L443" title="1 of 2 branches missed.">        if(preEditPrimaryContactMaybe.isDefined()) {</span>
<span class="fc" id="L444">            var preEditPrimaryContact = preEditPrimaryContactMaybe.get();</span>
<span class="fc" id="L445">            preEditPrimaryContact.setPerson(person); // set this for later reference (no need to re-get from DB)</span>


<span class="pc bpc" id="L448" title="1 of 2 branches missed.">            boolean primaryContactChanged =</span>
                    newPrimaryContact != null
<span class="fc bfc" id="L450" title="All 2 branches covered.">                            &amp;&amp; !preEditPrimaryContact.getId().equals(newPrimaryContact.getId());</span>

<span class="fc bfc" id="L452" title="All 2 branches covered.">            if (primaryContactChanged) {</span>
<span class="pc bpc" id="L453" title="1 of 2 branches missed.">                if (!newPrimaryContact.isConfirmed()) {</span>
<span class="nc" id="L454">                    errors = errors.addFieldError(&quot;user.email&quot;,</span>
                            new Error(&quot;user.primary.contact.not.confirmed&quot;, &quot;unconfirmed email address cannot be primary&quot;));
<span class="nc" id="L456">                    return errors;</span>
                }
<span class="fc bfc" id="L458" title="All 2 branches covered.">                if (isNotBlank(person.getHumanUUID())) {</span>
<span class="fc" id="L459">                    syncPersonsForHuman(person, newPrimaryContact.getContactIfEmail().get());</span>
                }
<span class="fc" id="L461">                patientConsentManager.getCaregivers(person.getId())</span>
<span class="fc" id="L462">                        .stream()</span>
<span class="pc bpc" id="L463" title="1 of 2 branches missed.">                        .filter(carerPerson -&gt; !carerPerson.getId().equals(person.getId()))</span>
<span class="fc" id="L464">                        .forEach(carerPerson -&gt; emailMessageManager</span>
<span class="fc" id="L465">                                .notifyCarerOfPrimaryContactChange(preEditPrimaryContact, newPrimaryContact,</span>
<span class="fc" id="L466">                                        loggedInUserUtil.getLoggedInUser(), carerPerson, requestContext.getTeamId()));</span>
                try {
<span class="fc" id="L468">                    PKBPerson actor = null;</span>
<span class="pc bpc" id="L469" title="1 of 2 branches missed.">                    if (requestContext.getMaybeAccessingUserId().isPresent()) {</span>
<span class="fc" id="L470">                        Long actorId = requestContext.getMaybeAccessingUserId().get();</span>
<span class="fc" id="L471">                        actor = userManager.getPKBPerson(actorId);</span>
                    }
<span class="fc" id="L473">                    emailMessageManager.notifyPrimaryContactChange(preEditPrimaryContact, newPrimaryContact, actor, requestContext.getTeamId());</span>
<span class="nc" id="L474">                } catch (MailException e) {</span>
<span class="nc" id="L475">                    LOGGER.error(&quot;MailException while updating profile-{}&quot;, e.getMessage());</span>
<span class="fc" id="L476">                }</span>
            }
        }

<span class="fc" id="L480">        return errors;</span>
    }

    private void syncPersonsForHuman(PKBPerson person, Email newPrimaryEmail) {
<span class="fc" id="L484">        List&lt;PKBPerson&gt; equivalentPersons = userManager.getPersonsByHumanUuid(person.getHumanUUID(), PKBPerson.Lazy.CONTACTS);</span>
<span class="fc bfc" id="L485" title="All 2 branches covered.">        for (PKBPerson equivalentPerson : equivalentPersons) {</span>
<span class="pc bpc" id="L486" title="1 of 2 branches missed.">            if (setPrimaryEmailOnPerson(equivalentPerson, newPrimaryEmail)) {</span>
<span class="fc" id="L487">                userManager.updateUser(requestContext, equivalentPerson);</span>
            }
<span class="fc" id="L489">        }</span>
<span class="fc" id="L490">    }</span>

    private FormValidationErrors validateBaseProperties(UserProfile updatedProfile) {
<span class="fc" id="L493">        FormValidator.Builder&lt;UserProfile&gt; baseFormValidatorBuilder = baseFormValidatorBuilder(updatedProfile);</span>
<span class="fc bfc" id="L494" title="All 2 branches covered.">        if (viewingProfileOfProfessional()) {</span>
<span class="fc" id="L495">            appendValidationRulesForProfessionalProfile(baseFormValidatorBuilder);</span>
        }
<span class="fc" id="L497">        return baseFormValidatorBuilder.build().validate(updatedProfile);</span>
    }

    private void appendValidationRulesForProfessionalProfile(
            FormValidator.Builder&lt;UserProfile&gt; baseFormValidatorBuilder) {
<span class="fc" id="L502">        baseFormValidatorBuilder.addFieldValidators(&quot;user.jobTitle&quot;, UserProfile::getJobTitle, asList(</span>
<span class="pc" id="L503">                required(() -&gt; new Error(&quot;user.required.jobTitle&quot;, &quot;job title is required&quot;)),</span>
<span class="pc" id="L504">                minLength(2, minLength -&gt; new Error(&quot;user.err.jobTitle.short&quot;, &quot;job title is too short&quot;, minLength)),</span>
<span class="pc" id="L505">                maxLength(255, maxLength -&gt; new Error(&quot;user.err.jobTitle.long&quot;, &quot;job title is too long&quot;, maxLength))));</span>
<span class="fc bfc" id="L506" title="All 2 branches covered.">        if (!viewingProfileOfTeamProfessional()) {</span>
<span class="fc" id="L507">            baseFormValidatorBuilder</span>
<span class="fc" id="L508">                    .addFieldValidators(&quot;user.organizationName&quot;, UserProfile::getOrganizationName, asList(</span>
<span class="pc" id="L509">                            required(() -&gt; new Error(&quot;user.required.orgname&quot;, &quot;org name is required&quot;)),</span>
<span class="pc" id="L510">                            maxLength(100, maxLength -&gt; new Error(&quot;user.length.orgname&quot;, &quot;org name is too long&quot;, maxLength))))</span>
<span class="fc" id="L511">                    .addFieldValidators(&quot;user.organizationUnit&quot;, UserProfile::getOrganizationUnit, asList(</span>
<span class="pc" id="L512">                            required(() -&gt; new Error(&quot;user.required.orgunit&quot;, &quot;org unit is required&quot;)),</span>
<span class="pc" id="L513">                            maxLength(100, maxLength -&gt; new Error(&quot;user.length.orgunit&quot;, &quot;org unit is too long&quot;, maxLength))));</span>
        }
<span class="fc" id="L515">    }</span>

    private FormValidator.Builder&lt;UserProfile&gt; baseFormValidatorBuilder(UserProfile updatedProfile) {
<span class="fc" id="L518">        FormValidator.Builder&lt;UserProfile&gt; builder = FormValidator.builder();</span>
<span class="fc" id="L519">        Supplier&lt;Error&gt; phoneNumErrorSupplier = () -&gt; new Error(&quot;user.error.phone&quot;, &quot;phone number should be in ^[+]?[\\d ()\\-]+$ format&quot;);</span>
<span class="fc bfc" id="L520" title="All 2 branches covered.">        if (updatedProfile.isPatient()) {</span>
<span class="fc" id="L521">            builder.addFieldValidator(&quot;user.phone&quot;, UserProfile::getPhone,</span>
<span class="fc" id="L522">                    phoneNumberOptional(phoneNumErrorSupplier));</span>
        } else {
<span class="fc" id="L524">            builder.addFieldValidators(&quot;user.phone&quot;, UserProfile::getPhone, asList(</span>
<span class="fc" id="L525">                    required(() -&gt; new Error(&quot;user.required.phone&quot;, &quot;phone number is required&quot;)),</span>
<span class="fc" id="L526">                    phoneNumberMandatory(phoneNumErrorSupplier)));</span>
        }

<span class="fc" id="L529">        builder.addFieldValidator(&quot;user.phone&quot;, UserProfile::getPhone,</span>
<span class="fc" id="L530">                maxLength(40, maxLength -&gt; new Error(&quot;user.err.phone.length&quot;, &quot;phone number is too long&quot;, maxLength)))</span>
<span class="fc" id="L531">                .addFieldValidator(&quot;user.skypeId&quot;, UserProfile::getSkypeId,</span>
<span class="fc" id="L532">                        maxLength(100, maxLength -&gt; new Error(&quot;user.err.skypeid.length&quot;, &quot;skype id is too long&quot;, maxLength)));</span>
<span class="fc bfc" id="L533" title="All 2 branches covered.">        if (!loggedInUserUtil.isLoggedInUserIndividualProfessional()) {</span>
<span class="fc" id="L534">            builder.addFieldValidators(&quot;user.title&quot;, UserProfile::getTitle, asList(</span>
<span class="pc" id="L535">                    required(() -&gt; new Error(&quot;user.required.title&quot;, &quot;title is required&quot;)),</span>
<span class="fc" id="L536">                    maxLength(50, maxLength -&gt; new Error(&quot;user.title.err.length&quot;, &quot;title is too long&quot;, maxLength))))</span>
<span class="fc" id="L537">                    .addFieldValidators(&quot;user.firstName&quot;, UserProfile::getFirstName, asList(</span>
<span class="pc" id="L538">                            required(() -&gt; new Error(&quot;user.required.firstName&quot;, &quot;first name is required&quot;)),</span>
<span class="fc" id="L539">                            maxLength(50, maxLength -&gt; new Error(&quot;user.err.firstName&quot;, &quot;first name is too long&quot;, maxLength))))</span>
<span class="fc" id="L540">                    .addFieldValidator(&quot;user.middleName&quot;, UserProfile::getMiddleName,</span>
<span class="fc" id="L541">                            maxLength(100, maxLength -&gt; new Error(&quot;user.err.middleName&quot;, &quot;middle name is too long&quot;, maxLength)))</span>
<span class="fc" id="L542">                    .addFieldValidators(&quot;user.lastName&quot;, UserProfile::getLastName, asList(</span>
<span class="pc" id="L543">                            required(() -&gt; new Error(&quot;user.required.lastName&quot;, &quot;last name is required&quot;)),</span>
<span class="fc" id="L544">                            maxLength(50, maxLength -&gt; new Error(&quot;user.err.lastName&quot;, &quot;last name is too long&quot;, maxLength))))</span>
<span class="fc" id="L545">                    .addFieldValidators(&quot;user.city&quot;, UserProfile::getCity, asList(</span>
<span class="pc" id="L546">                            required(() -&gt; new Error(&quot;user.required.city&quot;, &quot;city is required&quot;)),</span>
<span class="pc" id="L547">                            minLength(2, minLength -&gt; new Error(&quot;user.err.city.short&quot;, &quot;city is too short&quot;, minLength)),</span>
<span class="fc" id="L548">                            maxLength(50, maxLength -&gt; new Error(&quot;user.err.city.long&quot;, &quot;city is too long&quot;, maxLength))))</span>
<span class="fc" id="L549">                    .addFieldValidators(&quot;user.state&quot;, UserProfile::getState, asList(</span>
<span class="pc" id="L550">                            required(() -&gt; new Error(&quot;user.required.state&quot;, &quot;state is required&quot;)),</span>
<span class="pc" id="L551">                            minLength(2, minLength -&gt; new Error(&quot;user.err.state.short&quot;, &quot;state is too short&quot;, minLength)),</span>
<span class="fc" id="L552">                            maxLength(50, maxLength -&gt; new Error(&quot;user.err.state.long&quot;, &quot;state is too long&quot;, maxLength))))</span>
<span class="fc" id="L553">                    .addFieldValidators(&quot;user.postalCode&quot;, UserProfile::getPostalCode, asList(</span>
<span class="pc" id="L554">                            required(() -&gt; new Error(&quot;user.required.postalCode.required&quot;, &quot;postal code is required&quot;)),</span>
<span class="fc" id="L555">                            maxLength(10, maxLength -&gt; new Error(&quot;user.required.postalCode.invalid.length&quot;, &quot;postal code is too long&quot;, maxLength))))</span>
<span class="fc" id="L556">                    .addFieldValidators(&quot;user.country&quot;, UserProfile::getCountry, asList(</span>
<span class="pc" id="L557">                            required(() -&gt; new Error(&quot;user.required.country&quot;, &quot;country is required&quot;)),</span>
<span class="pc" id="L558">                            maxLength(50, maxLength -&gt; new Error(&quot;user.err.country&quot;, &quot;country is too long&quot;, maxLength))))</span>
<span class="fc" id="L559">                    .addFieldValidators(&quot;user.address1&quot;, UserProfile::getAddress1, asList(</span>
<span class="pc" id="L560">                            required(() -&gt; new Error(&quot;user.required.address1&quot;,</span>
                                    &quot;address1 required&quot;)),
<span class="pc" id="L562">                            minLength(3, minLength -&gt; new Error(&quot;user.err.address.short&quot;, &quot;address line 1 is too short&quot;, minLength)),</span>
<span class="fc" id="L563">                            maxLength(100, maxLength -&gt; new Error(&quot;user.err.address.long&quot;, &quot;address line 1 is too long&quot;, maxLength))))</span>
<span class="fc" id="L564">                    .addFieldValidator(&quot;user.address2&quot;, UserProfile::getAddress2,</span>
<span class="fc" id="L565">                            maxLength(100, maxLength -&gt; new Error(&quot;user.err.address.long&quot;, &quot;address line 2 is too long&quot;, maxLength)));</span>
        }
<span class="fc" id="L567">        return builder;</span>
    }

    private List&lt;Error&gt; updateTeamLevelIdList(UserProfile updatedProfile, PKBPerson person) {
<span class="fc" id="L571">        List&lt;TeamLevelIdType&gt; teamLevelIdTypes = getHandledTeamLevelIdTypes();</span>
<span class="fc" id="L572">        SortedSet&lt;TeamLevelId&gt; updatedTLIds = TeamLevelId</span>
<span class="fc" id="L573">                .combineTeamLevelIds(teamLevelIdTypes, updatedProfile.getGroupedTeamLevelIds());</span>
<span class="fc" id="L574">        List&lt;Error&gt; errors = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L575" title="All 2 branches covered.">        for (TeamLevelId tlid : updatedTLIds) {</span>
<span class="fc" id="L576">            PersonAmbiguityHandler.getMaybePersonOrNone(userManager.getPKBPersonByTeamLevelId(tlid), &quot;teamLevelId&quot;)</span>
<span class="fc" id="L577">                    .onEmpty(() -&gt; person.addTeamLevelId(requestContext, tlid, dateTimeService.now()))</span>
<span class="fc" id="L578">                    .peek(existingPerson -&gt; {</span>
<span class="pc bpc" id="L579" title="1 of 2 branches missed.">                        if (!existingPerson.getId().equals(person.getId())) {</span>
<span class="nc" id="L580">                            errors.add(new DuplicateTeamLevelIdError(tlid.getType().getName(), tlid.getValue(),</span>
<span class="nc" id="L581">                                    existingPerson.getTitle(),</span>
<span class="nc" id="L582">                                    existingPerson.getFirstName(),</span>
<span class="nc" id="L583">                                    existingPerson.getLastName()));</span>
                        }
<span class="fc" id="L585">                    });</span>
<span class="fc" id="L586">        }</span>

<span class="fc" id="L588">        person.getTeamLevelIds().stream()</span>
<span class="fc bfc" id="L589" title="All 2 branches covered.">                .filter(oldTlid -&gt; !updatedTLIds.contains(oldTlid))</span>
<span class="fc" id="L590">                .filter(oldTlid -&gt; teamLevelIdTypes.contains(oldTlid.getType()))</span>
<span class="fc" id="L591">                .forEach(oldTlid -&gt; oldTlid.setPersonId(null));</span>
<span class="fc" id="L592">        return errors;</span>
    }

    private List&lt;Error&gt; updateOrgLevelIdList(UserProfile updatedProfile, PKBPerson person) {
<span class="fc" id="L596">        List&lt;OrgLevelIdType&gt; orgLevelIdTypes = getHandledOrgLevelIdTypes();</span>
<span class="fc" id="L597">        SortedSet&lt;OrgLevelId&gt; updatedOrgLevelIds = OrgLevelId</span>
<span class="fc" id="L598">                .combineOrgLevelIds(orgLevelIdTypes, updatedProfile.getGroupedOrgLevelIds());</span>
<span class="fc" id="L599">        List&lt;Error&gt; errors = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L601" title="All 2 branches covered.">        for (OrgLevelId olid : updatedOrgLevelIds) {</span>
<span class="fc" id="L602">            PersonAmbiguityHandler.getMaybePersonOrNone(userManager.getPKBPersonByOrgLevelId(olid), &quot;orgLevellId&quot;)</span>
<span class="fc" id="L603">                    .onEmpty(() -&gt; person.addOrgLevelId(requestContext, olid, dateTimeService.now()))</span>
<span class="fc" id="L604">                    .peek(existingPerson -&gt; {</span>
<span class="pc bpc" id="L605" title="1 of 2 branches missed.">                        if (!existingPerson.getId().equals(person.getId())) {</span>
<span class="nc" id="L606">                            errors.add(new DuplicateOrgLevelIdError(olid.getType().getName(), olid.getValue(),</span>
<span class="nc" id="L607">                                    existingPerson.getTitle(),</span>
<span class="nc" id="L608">                                    existingPerson.getFirstName(),</span>
<span class="nc" id="L609">                                    existingPerson.getLastName()));</span>
                        }
<span class="fc" id="L611">                    });</span>
<span class="fc" id="L612">        }</span>

<span class="fc" id="L614">        person.getOrgLevelIds().stream()</span>
<span class="fc bfc" id="L615" title="All 2 branches covered.">                .filter(oldOlid -&gt; !updatedOrgLevelIds.contains(oldOlid))</span>
<span class="fc" id="L616">                .filter(oldOlid -&gt; orgLevelIdTypes.contains(oldOlid.getType()))</span>
<span class="fc" id="L617">                .forEach(oldOlid -&gt; oldOlid.setPersonId(null));</span>
<span class="fc" id="L618">        return errors;</span>
    }

    private List&lt;TeamLevelIdType&gt; computeHandledTeamLevelIdTypes() {
<span class="fc bfc" id="L622" title="All 2 branches covered.">        if (viewingAsPatient()) {</span>
<span class="fc" id="L623">            return personUnderEdit.get().getTeamLevelIds().stream()</span>
<span class="fc" id="L624">                    .map(TeamLevelId::getType)</span>
<span class="fc" id="L625">                    .distinct()</span>
<span class="fc" id="L626">                    .collect(toList());</span>
        } else {
<span class="fc" id="L628">            Team team = loggedInUserTeam.get();</span>
<span class="fc bfc" id="L629" title="All 4 branches covered.">            if (team != null &amp;&amp; team.getPatientIdSupport() != Team.PatientIdSupport.ORG_LEVEL_ONLY) {</span>
<span class="fc" id="L630">                return new ArrayList&lt;&gt;(team.getTeamLevelIdTypes());</span>
            }
        }
<span class="fc" id="L633">        return emptyList();</span>
    }

    List&lt;TeamLevelIdType&gt; getHandledTeamLevelIdTypes() {
<span class="fc" id="L637">        return handledTeamLevelIdTypes.get();</span>
    }

    private boolean viewingAsPatient() {
<span class="fc bfc" id="L641" title="All 2 branches covered.">        return loggedInUserUtil.getLoggedInUserType() == PATIENT;</span>
    }

    private boolean viewingAsProfessional() {
<span class="fc bfc" id="L645" title="All 2 branches covered.">        return loggedInUserUtil.getLoggedInUserType() == REG_CLINICIAN;</span>
    }

    @VisibleForTesting
    void applyChanges(PKBPerson original, UserProfile profileUpdate) throws InvalidUIDateException {
<span class="fc bfc" id="L650" title="All 2 branches covered.">        if (!loggedInUserUtil.isLoggedInUserIndividualProfessional()) {</span>
<span class="fc" id="L651">            original.setTitle(profileUpdate.getTitle());</span>
<span class="fc" id="L652">            original.setFirstName(profileUpdate.getFirstName());</span>
<span class="fc" id="L653">            original.setMiddleName(profileUpdate.getMiddleName());</span>
<span class="fc" id="L654">            original.setLastName(profileUpdate.getLastName());</span>
<span class="fc" id="L655">            original.setAddress1(profileUpdate.getAddress1());</span>
<span class="fc" id="L656">            original.setAddress2(profileUpdate.getAddress2());</span>
<span class="fc" id="L657">            original.setCity(profileUpdate.getCity());</span>
<span class="fc" id="L658">            original.setState(profileUpdate.getState());</span>
<span class="fc" id="L659">            original.setPostalCode(profileUpdate.getPostalCode());</span>
<span class="fc" id="L660">            original.setCountry(profileUpdate.getCountry());</span>
        }
<span class="fc bfc" id="L662" title="All 4 branches covered.">        if (!loggedInUserUtil.isLoggedInUserIndividualProfessional() &amp;&amp; !loggedInUserUtil.isLoggedInUserPatient()) {</span>
<span class="fc" id="L663">            original.setDateOfBirthString(profileUpdate.getDob().toFormattedDate());</span>
<span class="fc" id="L664">            original.setGender(profileUpdate.getGender());</span>
        }
<span class="fc" id="L666">        original.setSkypeId(profileUpdate.getSkypeId());</span>
<span class="fc" id="L667">        original.setPhone(profileUpdate.getPhone());</span>

<span class="fc" id="L669">        original.setTimeZoneId(profileUpdate.getTimeZoneId());</span>
<span class="fc" id="L670">        original.setLanguageCode(profileUpdate.getLanguageCode());</span>

<span class="fc bfc" id="L672" title="All 4 branches covered.">        if (loggedInUserUtil.isLoggedInUserIndividualProfessional() &amp;&amp; viewingProfileOfProfessional()) {</span>
<span class="fc" id="L673">            original.setOrganizationName(profileUpdate.getOrganizationName());</span>
<span class="fc" id="L674">            original.setOrganizationUnit(profileUpdate.getOrganizationUnit());</span>
        }

<span class="fc bfc" id="L677" title="All 4 branches covered.">        if (viewingAsProfessional() &amp;&amp; !viewingProfileOfPatient()) {</span>
<span class="fc" id="L678">            original.setJobTitle(profileUpdate.getJobTitle());</span>
        }
<span class="fc" id="L680">    }</span>

    private List&lt;OrgLevelIdType&gt; computeHandledOrgLevelIdTypes() {
<span class="fc bfc" id="L683" title="All 2 branches covered.">        if (viewingAsPatient()) {</span>
<span class="fc" id="L684">            return personUnderEdit.get().getOrgLevelIds().stream()</span>
<span class="fc" id="L685">                    .map(OrgLevelId::getType)</span>
<span class="fc" id="L686">                    .distinct()</span>
<span class="fc" id="L687">                    .collect(toList());</span>
        } else {
<span class="fc" id="L689">            Team team = loggedInUserTeam.get();</span>
<span class="pc bpc" id="L690" title="1 of 4 branches missed.">            if (team != null &amp;&amp; team.getPatientIdSupport() != Team.PatientIdSupport.TEAM_LEVEL_ONLY) {</span>
<span class="fc" id="L691">                return new ArrayList&lt;&gt;(team.getOrg().getOrgLevelIdTypes());</span>
            }
        }
<span class="fc" id="L694">        return emptyList();</span>
    }

    List&lt;OrgLevelIdType&gt; getHandledOrgLevelIdTypes() {
<span class="fc" id="L698">        return handledOrgLevelIdTypes.get();</span>
    }

    public void prepareForDisplay(UserProfile profile) {
<span class="fc" id="L702">        PKBPerson person = personUnderEdit.get();</span>
<span class="fc" id="L703">        profile.setId(person.getId());</span>
<span class="fc" id="L704">        profile.setUserType(person.getUserType());</span>
<span class="fc" id="L705">        profile.setContactList(personContactManager.getContactListDirect(personUnderEdit.get().getId()));</span>
<span class="fc bfc" id="L706" title="All 2 branches covered.">        if (loggedInUserUtil.isLoggedInUserIndividualProfessional()) {</span>
<span class="fc" id="L707">            profile.populateLimitedEditFields(person);</span>
        }
<span class="fc bfc" id="L709" title="All 2 branches covered.">        if (loggedInUserUtil.isLoggedInUserPatient()) {</span>
<span class="fc" id="L710">            profile.populateLimitedEditFieldsForPatient(person);</span>
        }
<span class="fc bfc" id="L712" title="All 4 branches covered.">        if (profile.isProfessional() &amp;&amp; viewingProfileOfTeamProfessional()) {</span>
<span class="fc" id="L713">            populateOrgDetails(profile);</span>
        }
<span class="fc" id="L715">        profile.setInstituteCountry(teamCountryCode.get());</span>
<span class="fc" id="L716">        populateIdentifiers(profile);</span>
<span class="fc" id="L717">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>