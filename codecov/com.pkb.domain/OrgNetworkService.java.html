<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OrgNetworkService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.domain</a> &gt; <span class="el_source">OrgNetworkService.java</span></div><h1>OrgNetworkService.java</h1><pre class="source lang-java linenums">package com.pkb.domain;

import com.google.common.collect.Streams;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.datamodel.ImmutableOrgNetworkMemberNew;
import com.pkb.datamodel.ImmutableOrgNetworkMemberView;
import com.pkb.datamodel.Org;
import com.pkb.datamodel.OrgNetworkExisting;
import com.pkb.datamodel.OrgNetworkMemberExisting;
import com.pkb.datamodel.OrgNetworkMemberNew;
import com.pkb.datamodel.OrgNetworkMemberView;
import com.pkb.datamodel.OrgNetworkNew;
import com.pkb.datamodel.OrgWithOrgAccountId;
import com.pkb.datamodel.entity.mapper.OrgMapper;
import com.pkb.datamodel.entity.mapper.OrgNetworkMapper;
import com.pkb.datamodel.entity.mapper.OrgNetworkMemberMapper;
import com.pkb.domain.CryptoModelSynchronisationService.SyncCounts;
import com.pkb.domain.duplicate.person.PersonService;
import com.pkb.domain.exception.OrgNetworkException;
import com.pkb.entities.enums.OrgNetworkMemberStatus;
import com.pkb.entities.pub.PublicOrgNetworkMember;
import com.pkb.repository.OrgNetworkMemberRepository;
import com.pkb.repository.OrgNetworkRepository;
import com.pkb.repository.OrgRepository;
import io.vavr.Tuple;
import io.vavr.control.Option;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.transaction.annotation.Transactional;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;

import java.util.EnumSet;
import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import static com.pkb.domain.exception.OrgNetworkException.INVITED_ORG_NO_COORD;
import static com.pkb.domain.exception.OrgNetworkException.INVITED_ORG_NO_COORD_CODE;
import static com.pkb.domain.exception.OrgNetworkException.ORG_ALREADY_IN_NETWORK;
import static com.pkb.domain.exception.OrgNetworkException.ORG_ALREADY_IN_NETWORK_CODE;

public class OrgNetworkService {
    private final OrgNetworkRepository orgNetworkRepository;
    private final OrgNetworkMemberRepository orgNetworkMemberRepository;
    private final OrgRepository orgRepository;
    private final OrgMapper orgMapper;
    private final OrgNetworkMapper orgNetworkMapper;
    private final OrgNetworkMemberMapper orgNetworkMemberMapper;
    private final PersonService personService;
    private final DateTimeService dateTimeService;
    private final CryptoModelSynchronisationService cryptoSyncService;

<span class="fc" id="L56">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

<span class="fc" id="L58">    public OrgNetworkService(OrgNetworkRepository orgNetworkRepository, OrgNetworkMemberRepository orgNetworkMemberRepository, OrgRepository orgRepository, OrgMapper orgMapper, OrgNetworkMapper orgNetworkMapper, OrgNetworkMemberMapper orgNetworkMemberMapper, PersonService personService, DateTimeService dateTimeService, CryptoModelSynchronisationService cryptoSyncService) {</span>
<span class="fc" id="L59">        this.orgNetworkRepository = orgNetworkRepository;</span>
<span class="fc" id="L60">        this.orgNetworkMemberRepository = orgNetworkMemberRepository;</span>
<span class="fc" id="L61">        this.orgRepository = orgRepository;</span>
<span class="fc" id="L62">        this.orgMapper = orgMapper;</span>
<span class="fc" id="L63">        this.orgNetworkMapper = orgNetworkMapper;</span>
<span class="fc" id="L64">        this.orgNetworkMemberMapper = orgNetworkMemberMapper;</span>
<span class="fc" id="L65">        this.personService = personService;</span>
<span class="fc" id="L66">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L67">        this.cryptoSyncService = cryptoSyncService;</span>
<span class="fc" id="L68">    }</span>

    public List&lt;OrgNetworkExisting&gt; getOrgNetworkList() {
<span class="fc" id="L71">        return orgNetworkRepository.findAll().stream().map(orgNetworkMapper::entityToDataModel).collect(Collectors.toUnmodifiableList());</span>
    }

    public List&lt;Org&gt; getOrgsNotInAnyNetwork() {
<span class="fc" id="L75">        return orgRepository.getOrgsNotInAnyNetwork().stream().map(orgMapper::entityToDataModel).collect(Collectors.toUnmodifiableList());</span>
    }

    @Transactional
    public void approveMember(long orgToApproveId, long orgNetworkId, long approvingUserId) {
<span class="fc" id="L80">        var orgNetworkMember = orgNetworkMemberRepository.findByOrgNetworkIdAndOrgId(orgNetworkId, orgToApproveId);</span>
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">        if (orgNetworkMember.getMemberStatus() != OrgNetworkMemberStatus.PENDING_APPROVAL) {</span>
<span class="nc" id="L82">            throw new IllegalStateException(&quot;Attempting to approve org &quot; + orgToApproveId + &quot; for org network &quot; + orgNetworkMember.getOrgNetwork().getId() + &quot; but it has wrong status &quot; + orgNetworkMember.getMemberStatus());</span>
        }
<span class="fc" id="L84">        orgNetworkMember.approve(approvingUserId, dateTimeService.now());</span>
<span class="fc" id="L85">    }</span>

    @Transactional
    public Mono&lt;Boolean&gt; activateOrgInOrgNetwork(long orgToActivateId, long orgNetworkId, long activatingUserId) {
<span class="fc" id="L89">        var orgNetworkMember = orgNetworkMemberRepository.findByOrgNetworkIdAndOrgId(orgNetworkId, orgToActivateId);</span>
<span class="pc bpc" id="L90" title="1 of 3 branches missed.">        switch (orgNetworkMember.getMemberStatus()) {</span>
            case ACTIVE:
<span class="fc" id="L92">                LOGGER.info(&quot;Org {} is already active in org network {}&quot;, orgToActivateId, orgNetworkMember.getOrgNetwork().getId());</span>
<span class="fc" id="L93">                return Mono.just(false);</span>
            case PENDING_ACTIVATION:
<span class="fc" id="L95">                orgNetworkMember.beginActivation(activatingUserId, dateTimeService.now());</span>
<span class="fc" id="L96">                return syncNewMemberToOrgNetwork(orgNetworkMember)</span>
<span class="fc" id="L97">                        .then(Mono.just(true));</span>
            default:
<span class="nc" id="L99">                return Mono.error(new IllegalStateException(&quot;Tried to activate org &quot; + orgToActivateId + &quot; that wasn't PENDING_ACTIVATION in org network &quot; + orgNetworkMember.getOrgNetwork().getId()));</span>
        }
    }


    private Mono&lt;SyncCounts&gt; syncNewMemberToOrgNetwork(PublicOrgNetworkMember orgNetworkMember) {
<span class="fc" id="L105">        var orgStream = Streams.concat(</span>
<span class="fc" id="L106">                Stream.of(Tuple.of(orgNetworkMember.getOrgNetwork().getLeadingOrg().getId(), orgNetworkMember.getOrgId())),</span>
<span class="fc" id="L107">                getOtherOrgsInNetwork(orgNetworkMember).map(it -&gt; Tuple.of(orgNetworkMember.getOrgId(), it))</span>
        );

<span class="fc" id="L110">        return Flux.fromStream(orgStream)</span>
<span class="fc" id="L111">                .flatMap(it -&gt;cryptoSyncService.syncAccountsFromOrgToOrg(it._1, it._2), 1)</span>
<span class="fc" id="L112">                .reduce(ImmutableSyncCounts.of(0,0), SyncCounts::add)</span>
<span class="fc" id="L113">                .doOnSuccess((syncCounts) -&gt; {</span>
<span class="fc" id="L114">                        orgNetworkMember.completeActivation();</span>
<span class="fc" id="L115">                        orgNetworkMemberRepository.save(orgNetworkMember);</span>
<span class="fc" id="L116">                });</span>
    }

    @NotNull
    private Stream&lt;Long&gt; getOtherOrgsInNetwork(PublicOrgNetworkMember orgNetworkMember) {
<span class="fc" id="L121">        return orgNetworkMemberRepository.findByOrgNetworkId(orgNetworkMember.getOrgNetwork().getId()).stream()</span>
<span class="fc" id="L122">                .map(PublicOrgNetworkMember::getOrgId)</span>
<span class="fc bfc" id="L123" title="All 2 branches covered.">                .filter(it -&gt; it != orgNetworkMember.getOrgId());</span>
    }


    public OrgNetworkExisting getOrgNetworkById(long id) {
<span class="fc" id="L128">        return orgNetworkRepository.findById(id).map(orgNetworkMapper::entityToDataModel).orElseThrow();</span>
    }

    @Transactional
    public OrgNetworkExisting createOrgNetwork(OrgNetworkNew newNetwork) {


<span class="fc" id="L135">        var orgNetwork = orgNetworkRepository.save(orgNetworkMapper.dataModelToEntity(newNetwork));</span>

<span class="fc" id="L137">        OrgNetworkMemberNew networkMember = ImmutableOrgNetworkMemberNew.builder()</span>
<span class="fc" id="L138">                .orgId(newNetwork.getLeadingOrgId())</span>
<span class="fc" id="L139">                .createdByPersonId(newNetwork.getCreatedByPersonId())</span>
<span class="fc" id="L140">                .approvedByPersonId(newNetwork.getCreatedByPersonId())</span>
<span class="fc" id="L141">                .approvedDate(dateTimeService.now())</span>
<span class="fc" id="L142">                .activatedByPersonId(newNetwork.getCreatedByPersonId())</span>
<span class="fc" id="L143">                .activatedDate(dateTimeService.now())</span>
<span class="fc" id="L144">                .orgNetworkId(orgNetwork.getId())</span>
<span class="fc" id="L145">                .memberStatus(OrgNetworkMemberStatus.ACTIVE)</span>
<span class="fc" id="L146">                .build();</span>
<span class="fc" id="L147">        validateNewOrgNetworkMember(networkMember);</span>

<span class="fc" id="L149">        orgNetworkMemberRepository.save(orgNetworkMemberMapper.dataModelToEntity(networkMember));</span>

<span class="fc" id="L151">        var createdNetwork = orgNetworkMapper.entityToDataModel(orgNetwork);</span>
<span class="fc" id="L152">        LOGGER.info(&quot;New org network created {} &quot;, createdNetwork);</span>

<span class="fc" id="L154">        return createdNetwork;</span>
    }

    @Transactional
    public OrgNetworkMemberExisting addOrgNetworkMember(OrgNetworkMemberNew newMember) {
<span class="fc" id="L159">        validateNewOrgNetworkMember(newMember);</span>
<span class="fc" id="L160">        var createdMember = orgNetworkMemberMapper.entityToDataModel(orgNetworkMemberRepository.save(orgNetworkMemberMapper.dataModelToEntity(newMember)));</span>
<span class="fc" id="L161">        LOGGER.info(&quot;New org network member added{} &quot;, createdMember);</span>
<span class="fc" id="L162">        return createdMember;</span>
    }

    private void validateNewOrgNetworkMember(OrgNetworkMemberNew newMember) {
<span class="fc" id="L166">        getOrgNetworkOfMember(newMember.getOrgId(), false)</span>
<span class="fc" id="L167">                .peek(existingNetwork -&gt; {</span>
<span class="nc" id="L168">                    throw new OrgNetworkException(ORG_ALREADY_IN_NETWORK_CODE, ORG_ALREADY_IN_NETWORK, newMember.getOrgId());</span>
                });

<span class="fc bfc" id="L171" title="All 2 branches covered.">        if (personService.countOrgCoordsWithAccessToOrg(newMember.getOrgId()) == 0) {</span>
<span class="fc" id="L172">            throw new OrgNetworkException(INVITED_ORG_NO_COORD_CODE, INVITED_ORG_NO_COORD, newMember.getOrgId());</span>
        }
<span class="fc" id="L174">    }</span>

    @Transactional
    public Org removeMemberOrg(long orgNetworkId, long orgId) {
<span class="fc" id="L178">        orgNetworkMemberRepository.delete(orgNetworkMemberRepository.findByOrgNetworkIdAndOrgId(orgNetworkId, orgId));</span>
<span class="fc" id="L179">        return orgRepository.findById(orgId)</span>
<span class="fc" id="L180">                .map(orgMapper::entityToDataModel)</span>
<span class="fc" id="L181">                .orElseThrow();</span>
    }

    public Option&lt;OrgNetworkExisting&gt; getOrgNetworkOfMember(long memberOrgId, boolean activeOnly) {
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">        EnumSet&lt;OrgNetworkMemberStatus&gt; statuses = activeOnly ? EnumSet.of(OrgNetworkMemberStatus.ACTIVE) : EnumSet.allOf(OrgNetworkMemberStatus.class);</span>
<span class="fc" id="L186">        return Option.ofOptional(orgNetworkMapper.entityToDataModel(orgNetworkRepository.findFirstNetworkForMemberWithStatuses(memberOrgId, statuses)));</span>
    }


    @Transactional
    public void syncVerifiedPatientToOrgNetwork(long patientId) {
<span class="fc" id="L192">        cryptoSyncService.syncCryptoAccessForPerson(patientId);</span>
<span class="fc" id="L193">    }</span>

    public List&lt;OrgNetworkMemberView&gt; getOrgNetworkMembers(long orgNetworkId) {
<span class="fc" id="L196">        return orgNetworkMemberRepository.findByOrgNetworkId(orgNetworkId).stream()</span>
<span class="fc" id="L197">                .map(entity -&gt; {</span>
<span class="fc" id="L198">                    var org = orgRepository.findById(entity.getOrgId()).orElseThrow();</span>
<span class="fc" id="L199">                    return ImmutableOrgNetworkMemberView.builder()</span>
<span class="fc" id="L200">                            .activatedDate(entity.getActivatedDate())</span>
<span class="fc" id="L201">                            .activatedBy(Option.of(entity.getActivatedByPersonId()).map(personService::findPerson).getOrNull())</span>
<span class="fc" id="L202">                            .memberStatus(entity.getMemberStatus())</span>
<span class="fc" id="L203">                            .orgId(entity.getOrgId())</span>
<span class="fc" id="L204">                            .orgName(org.getName())</span>
<span class="fc" id="L205">                            .orgNetworkId(entity.getOrgNetwork().getId())</span>
<span class="fc" id="L206">                            .build();</span>
                })
<span class="fc" id="L208">                .collect(Collectors.toUnmodifiableList());</span>
    }

    public Org getOrg(long orgId) {
<span class="nc" id="L212">        return orgRepository.findById(orgId)</span>
<span class="nc" id="L213">                .map(orgMapper::entityToDataModel)</span>
<span class="nc" id="L214">                .orElseThrow();</span>
    }

    public Optional&lt;OrgWithOrgAccountId&gt; getOrgWithOrgAccountId(long orgId) {
<span class="nc" id="L218">        return orgRepository.findById(orgId)</span>
<span class="nc" id="L219">                .map(orgMapper::entityToDataModelWithOrgAccountId);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>