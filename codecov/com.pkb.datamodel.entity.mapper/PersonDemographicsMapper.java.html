<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PersonDemographicsMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.datamodel.entity.mapper</a> &gt; <span class="el_source">PersonDemographicsMapper.java</span></div><h1>PersonDemographicsMapper.java</h1><pre class="source lang-java linenums">package com.pkb.datamodel.entity.mapper;

import com.pkb.datamodel.contact.EmailContact;
import com.pkb.datamodel.user.Demographics;
import com.pkb.datamodel.user.ImmutableDemographics;
import com.pkb.entities.enums.Gender;
import com.pkb.entities.enums.UserStatus;
import com.pkb.entities.pub.PublicNationalId;
import com.pkb.entities.pub.PublicOrgLevelId;
import com.pkb.entities.pub.PublicPKBPerson;
import com.pkb.entities.pub.PublicPatientOptOut;
import com.pkb.entities.pub.PublicPersonContact;
import com.pkb.entities.pub.PublicTeamLevelId;
import io.prometheus.client.Histogram;
import io.vavr.collection.List;
import io.vavr.control.Option;
import org.mapstruct.Mapper;

import javax.inject.Inject;

import static io.vavr.API.List;
import static java.util.Optional.ofNullable;
import static javax.persistence.Persistence.getPersistenceUtil;
import static org.apache.commons.lang3.StringUtils.EMPTY;

@Mapper
<span class="fc" id="L27">public abstract class PersonDemographicsMapper implements TimedMapper {</span>

    @Inject
    private PostalAddressMapper addressMapper;

    @Inject
    private LocalDateTimeMapper dobMapper;

    @Inject
    private LocalDateTimeMapper ddMapper;

    @Inject
    private NationalIdMapper nidMapper;

    @Inject
    private OrgLevelIdMapper olidMapper;

    @Inject
    private TeamLevelIdMapper tlidMapper;

    @Inject
    private PersonContactMapper personContactMapper;

    public Demographics entityToDataModel(PublicPKBPerson person) {
<span class="fc" id="L51">        try (Histogram.Timer ignored = MAP_TIMER.labels(&quot;person_demographics&quot;, &quot;person&quot;).startTimer()) {</span>
<span class="fc" id="L52">            return buildCommon(person)</span>
<span class="fc" id="L53">                    .withTeamLevelId(tlidMapper.entityToDataModel(unproxyTeamIds(person)))</span>
<span class="fc" id="L54">                    .withOrgLevelId(olidMapper.entityToDataModel(unproxyOrgIds(person)));</span>
        }
    }

    public Demographics entityToDataModel(PublicPKBPerson person, Option&lt;List&lt;PublicOrgLevelId&gt;&gt; orgLevelIds, Option&lt;List&lt;PublicTeamLevelId&gt;&gt; teamLevelIds) {
<span class="fc" id="L59">        try (Histogram.Timer ignored = MAP_TIMER.labels(&quot;person_demographics&quot;, &quot;person&quot;).startTimer()) {</span>
<span class="fc" id="L60">            return buildCommon(person)</span>
<span class="fc" id="L61">                    .withTeamLevelId(tlidMapper.entityToDataModel(teamLevelIds.getOrElse(List.empty())))</span>
<span class="fc" id="L62">                    .withOrgLevelId(olidMapper.entityToDataModel(orgLevelIds.getOrElse(List.empty())));</span>
        }
    }

    public Demographics entityToDataModel(PublicPKBPerson person, long teamId, long orgId) {
<span class="fc" id="L67">        try (Histogram.Timer ignored = MAP_TIMER.labels(&quot;person_demographics&quot;, &quot;person_with_ids&quot;).startTimer()) {</span>
<span class="fc" id="L68">            return buildCommon(person)</span>
<span class="fc" id="L69">                    .withTeamLevelId(tlidMapper.entityToDataModel(unproxyTeamIds(person), teamId))</span>
<span class="fc" id="L70">                    .withOrgLevelId(olidMapper.entityToDataModel(unproxyOrgIds(person), orgId));</span>
        }
    }

    public Demographics entityToDataModel(PublicPKBPerson person, long orgId) {
<span class="fc" id="L75">        try (Histogram.Timer ignored = MAP_TIMER.labels(&quot;person_demographics&quot;, &quot;person_with_ids&quot;).startTimer()) {</span>
<span class="fc" id="L76">            return buildCommon(person)</span>
<span class="fc" id="L77">                    .withOrgLevelId(olidMapper.entityToDataModel(unproxyOrgIds(person), orgId));</span>
        }
    }

    public boolean isSharingDisabled(PublicPKBPerson person) {
<span class="pc bpc" id="L82" title="1 of 2 branches missed.">        if (getPersistenceUtil().isLoaded(person, &quot;optoutDetails&quot;)) {</span>
<span class="fc" id="L83">            boolean sharingEnabled = ofNullable(person.getOptoutDetails())</span>
<span class="fc" id="L84">                    .map(PublicPatientOptOut::isSharingEnabled)</span>
<span class="fc" id="L85">                    .orElse(true);</span>

            // Inverted logic - this method returns true if _disabled_
<span class="fc bfc" id="L88" title="All 2 branches covered.">            return !sharingEnabled;</span>
        }

        // Sharing not disabled by default
<span class="nc" id="L92">        return false;</span>
    }

    private ImmutableDemographics buildCommon(PublicPKBPerson person) {
<span class="fc" id="L96">        return ImmutableDemographics.builder()</span>
<span class="fc" id="L97">                .id(person.getId())</span>
<span class="fc" id="L98">                .publicId(person.getPublicId())</span>
<span class="fc" id="L99">                .address(addressMapper.personEntityToAddress(person))</span>
<span class="fc" id="L100">                .gender(Gender.getById(person.getGender()))</span>
<span class="fc bfc" id="L101" title="All 2 branches covered.">                .isDeceased(person.getStatus() == UserStatus.DEAD)</span>
<span class="fc" id="L102">                .isSharingDisabled(isSharingDisabled(person))</span>
<span class="fc" id="L103">                .build()</span>
<span class="fc" id="L104">                .withTitle(Option.of(person.getTitle()).getOrElse(EMPTY))</span>
<span class="fc" id="L105">                .withNationalId(nidMapper.entityToDataModel(unproxyNationalIds(person)))</span>
<span class="fc" id="L106">                .withEmail(personContactMapper.entityToDataModel(unproxyContacts(person)).map(contact -&gt; (EmailContact) contact))</span>
<span class="fc" id="L107">                .withPhone(personContactMapper.personEntityToPhoneContact(person).toList())</span>
<span class="fc" id="L108">                .withFirstName(person.getFirstName())</span>
<span class="fc" id="L109">                .withMiddleName(Option.of(person.getMiddleName()))</span>
<span class="fc" id="L110">                .withLastName(person.getLastName())</span>
<span class="fc" id="L111">                .withDateOfBirth(dobMapper.getDateOfBirth(person.getDateOfBirthString()))</span>
<span class="fc" id="L112">                .withDeceasedDate(ddMapper.getDeceasedDate(person.getDeathTimestamp()));</span>
    }

    private List&lt;PublicNationalId&gt; unproxyNationalIds(PublicPKBPerson person) {
<span class="fc bfc" id="L116" title="All 2 branches covered.">        return getPersistenceUtil().isLoaded(person, &quot;nationalIds&quot;)</span>
<span class="fc" id="L117">                ? List.ofAll(person.getNationalIds())</span>
<span class="fc" id="L118">                : List();</span>
    }

    private List&lt;PublicTeamLevelId&gt; unproxyTeamIds(PublicPKBPerson person) {
<span class="fc bfc" id="L122" title="All 2 branches covered.">        return getPersistenceUtil().isLoaded(person, &quot;teamLevelIds&quot;)</span>
<span class="fc" id="L123">                ? List.ofAll(person.getTeamLevelIds())</span>
<span class="fc" id="L124">                : List();</span>
    }

    private List&lt;PublicOrgLevelId&gt; unproxyOrgIds(PublicPKBPerson person) {
<span class="fc bfc" id="L128" title="All 2 branches covered.">        return getPersistenceUtil().isLoaded(person, &quot;orgLevelIds&quot;)</span>
<span class="fc" id="L129">                ? List.ofAll(person.getOrgLevelIds())</span>
<span class="fc" id="L130">                : List();</span>
    }

    private List&lt;PublicPersonContact&gt; unproxyContacts(PublicPKBPerson person) {
<span class="fc bfc" id="L134" title="All 2 branches covered.">        return getPersistenceUtil().isLoaded(person, &quot;contacts&quot;)</span>
<span class="fc" id="L135">                ? List.ofAll(person.getContacts())</span>
<span class="fc" id="L136">                : List();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>