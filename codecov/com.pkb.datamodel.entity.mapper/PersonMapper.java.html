<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PersonMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.datamodel.entity.mapper</a> &gt; <span class="el_source">PersonMapper.java</span></div><h1>PersonMapper.java</h1><pre class="source lang-java linenums">package com.pkb.datamodel.entity.mapper;

import com.google.common.collect.ImmutableMap;
import com.google.common.collect.Maps;
import com.pkb.datamodel.team.ImmutableTeamUser;
import com.pkb.datamodel.team.TeamUser;
import com.pkb.datamodel.user.ImmutableEmployee;
import com.pkb.datamodel.user.ImmutableOrgCoordinator;
import com.pkb.datamodel.user.ImmutablePatient;
import com.pkb.datamodel.user.ImmutablePrivacyOfficer;
import com.pkb.datamodel.user.ImmutableProfessional;
import com.pkb.datamodel.user.ImmutableSuperAdmin;
import com.pkb.datamodel.user.ImmutableTeamCoordinator;
import com.pkb.datamodel.user.ImmutableTechSupportUser;
import com.pkb.datamodel.user.Patient;
import com.pkb.datamodel.user.Person;
import com.pkb.datamodel.user.PersonBuilder;
import com.pkb.datamodel.user.Professional;
import com.pkb.datamodel.user.TeamCoordinator;
import com.pkb.entities.enums.UserType;
import com.pkb.entities.pub.PublicInstituteUser;
import com.pkb.entities.pub.PublicOrg;
import com.pkb.entities.pub.PublicOrgLevelId;
import com.pkb.entities.pub.PublicPKBPerson;
import com.pkb.entities.pub.PublicTeamLevelId;
import io.prometheus.client.Histogram;
import io.vavr.collection.List;
import io.vavr.control.Option;
import org.apache.commons.lang3.StringUtils;
import org.mapstruct.Mapper;

import javax.inject.Inject;
import java.util.UUID;
import java.util.function.Function;

import static io.vavr.control.Option.none;
import static io.vavr.control.Option.some;
import static java.text.MessageFormat.format;
import static java.util.UUID.fromString;
import static org.apache.commons.lang3.StringUtils.isBlank;
import static org.mapstruct.ReportingPolicy.IGNORE;

@Mapper(unmappedTargetPolicy = IGNORE)
<span class="fc" id="L44">public abstract class PersonMapper implements TimedMapper, OptionAwareMapper {</span>

<span class="fc" id="L46">    private final ImmutableMap&lt;UserType, Function&lt;PublicPKBPerson, Person&gt;&gt; userTypeToMappingFunction =</span>
<span class="fc" id="L47">            Maps.immutableEnumMap(ImmutableMap.&lt;UserType, Function&lt;PublicPKBPerson, Person&gt;&gt;builder()</span>
<span class="fc" id="L48">                    .put(UserType.PATIENT, (this::entityToPatient))</span>
<span class="fc" id="L49">                    .put(UserType.REG_CLINICIAN, (this::entityToProfessional))</span>
<span class="fc" id="L50">                    .put(UserType.INSTITUTE_ADMIN, (entity -&gt; entityToOtherUserType(entity, ImmutableTeamCoordinator.builder(), &quot;coord&quot;)))</span>
<span class="fc" id="L51">                    .put(UserType.PRIVACY_OFFICER, (entity -&gt; entityToOtherUserType(entity, ImmutablePrivacyOfficer.builder(), &quot;privacyofficer&quot;)))</span>
<span class="fc" id="L52">                    .put(UserType.EMPLOYEE, (entity -&gt; entityToOtherUserType(entity, ImmutableEmployee.builder(), &quot;employee&quot;)))</span>
<span class="fc" id="L53">                    .put(UserType.TECH_SUPPORT, (entity -&gt; entityToOtherUserType(entity, ImmutableTechSupportUser.builder(), &quot;techsupport&quot;)))</span>
<span class="fc" id="L54">                    .put(UserType.ORG_COORD, (entity -&gt; entityToOtherUserType(entity, ImmutableOrgCoordinator.builder(), &quot;orgcoord&quot;)))</span>
<span class="fc" id="L55">                    .put(UserType.SUPER_ADMIN, (entity -&gt; entityToOtherUserType(entity, ImmutableSuperAdmin.builder(), &quot;superadmin&quot;)))</span>
<span class="fc" id="L56">                    .build());</span>

    @Inject
    private TeamWithOrgMapper teamWithOrgMapper;

    @Inject
    private PersonDemographicsMapper demographicsMapper;

    @Inject
    private OrgMapper orgMapper;

    public abstract PublicPKBPerson personToEntity(Person person);

    String map(Option&lt;UUID&gt; value) {
<span class="fc" id="L70">        return value.map(UUID::toString).getOrElse((String)null);</span>
    }

    public Person entityToDataModel(PublicPKBPerson entity) {

<span class="fc" id="L75">        return userTypeToMappingFunction.getOrDefault(entity.getUserType(),</span>
                (e -&gt; {
<span class="nc" id="L77">                    throw new RuntimeException(format(&quot;Unknown userType {0}&quot;, e));</span>
                }))
<span class="fc" id="L79">                .apply(entity);</span>

    }


    public Patient entityToPatient(PublicPKBPerson entity) {
<span class="fc" id="L85">        return entityToPatient(entity, List.of());</span>
    }

    public Patient entityToPatient(PublicPKBPerson entity, List&lt;PublicInstituteUser&gt; instituteUsers) {
<span class="fc" id="L89">        return entityToPatient(entity, instituteUsers, none(), none(), none());</span>
    }

    public Patient entityToPatient(PublicPKBPerson entity, List&lt;PublicInstituteUser&gt; instituteUsers, PublicOrg sourceOrg) {
<span class="fc" id="L93">        return entityToPatient(entity, instituteUsers, none(), none(), some(sourceOrg));</span>
    }

    public Patient entityToPatient(PublicPKBPerson entity, List&lt;PublicInstituteUser&gt; instituteUsers,
                                   Option&lt;io.vavr.collection.List&lt;PublicOrgLevelId&gt;&gt; orgLevelIds,
                                   Option&lt;io.vavr.collection.List&lt;PublicTeamLevelId&gt;&gt; teamLevelIds, Option&lt;PublicOrg&gt; sourceOrg) {
<span class="fc" id="L99">        try (Histogram.Timer ignored = MAP_TIMER.labels(&quot;person&quot;, &quot;patient&quot;).startTimer()) {</span>
<span class="fc" id="L100">            ImmutablePatient.Builder builder = ImmutablePatient.builder();</span>
<span class="fc" id="L101">            buildPerson(builder, entity, instituteUsers, orgLevelIds, teamLevelIds, sourceOrg);</span>
<span class="fc" id="L102">            return builder</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">                    .accessFrozen(entity.getFrozenByTeamId() != null)</span>
<span class="fc" id="L104">                    .sharingDisabled(demographicsMapper.isSharingDisabled(entity))</span>
<span class="fc" id="L105">                    .defaultAccountId(Option.of(entity.getDefaultAccountId()))</span>
<span class="fc" id="L106">                    .build();</span>
        }
    }

    public Professional entityToProfessional(PublicPKBPerson entity) {
<span class="fc" id="L111">        try (Histogram.Timer ignored = MAP_TIMER.labels(&quot;person&quot;, &quot;pro&quot;).startTimer()) {</span>
<span class="fc" id="L112">            ImmutableProfessional.Builder builder = ImmutableProfessional.builder();</span>
<span class="fc" id="L113">            buildPerson(builder, entity);</span>
<span class="fc" id="L114">            return builder</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">                    .humanUUID(isBlank(entity.getHumanUUID()) ? none() : Option.of(fromString(entity.getHumanUUID())))</span>
<span class="fc" id="L116">                    .jobTitle(Option.of(entity.getJobTitle()).filter(StringUtils::isNotBlank))</span>
<span class="fc" id="L117">                    .build();</span>
        }
    }


    public Professional entityToProfessional(PublicPKBPerson entity, List&lt;PublicInstituteUser&gt; instituteUsers) {
<span class="fc" id="L123">        try (Histogram.Timer ignored = MAP_TIMER.labels(&quot;person&quot;, &quot;pro&quot;).startTimer()) {</span>
<span class="fc" id="L124">            ImmutableProfessional.Builder builder = ImmutableProfessional.builder();</span>
<span class="fc" id="L125">            buildPerson(builder, entity, instituteUsers, none(), none(), none());</span>
<span class="fc" id="L126">            return builder</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">                    .humanUUID(isBlank(entity.getHumanUUID()) ? none() : Option.of(fromString(entity.getHumanUUID())))</span>
<span class="fc" id="L128">                    .jobTitle(Option.of(entity.getJobTitle()).filter(StringUtils::isNotBlank))</span>
<span class="fc" id="L129">                    .build();</span>
        }
    }

    public TeamCoordinator entityToTeamCoordinator(PublicPKBPerson entity, List&lt;PublicInstituteUser&gt; instituteUsers) {

<span class="fc" id="L135">        try (Histogram.Timer ignored = MAP_TIMER.labels(&quot;person&quot;, &quot;team_coord&quot;).startTimer()) {</span>
<span class="fc" id="L136">            ImmutableTeamCoordinator.Builder builder = ImmutableTeamCoordinator.builder();</span>
<span class="fc" id="L137">            buildPerson(builder, entity, instituteUsers, none(), none(), none());</span>
<span class="fc" id="L138">            return builder</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">                    .humanUUID(isBlank(entity.getHumanUUID()) ? none() : Option.of(fromString(entity.getHumanUUID())))</span>
<span class="fc" id="L140">                    .build();</span>
        }
    }

    public Person entityToOtherUserType(PublicPKBPerson entity, PersonBuilder builder, String label) {
<span class="fc" id="L145">        try (Histogram.Timer ignored = MAP_TIMER.labels(&quot;person&quot;, label).startTimer()) {</span>
<span class="fc" id="L146">            buildPerson(builder, entity);</span>
<span class="fc" id="L147">            return builder.build();</span>
        }
    }

    private PersonBuilder buildPerson(PersonBuilder builder, PublicPKBPerson entity) {
<span class="fc" id="L152">        return buildPerson(builder, entity, List.of());</span>
    }

    private PersonBuilder buildPerson(PersonBuilder builder, PublicPKBPerson entity, List&lt;PublicInstituteUser&gt; instituteUsers) {
<span class="fc" id="L156">        return buildPerson(builder, entity, instituteUsers, none(), none(), none());</span>
    }

    private PersonBuilder buildPerson(PersonBuilder builder, PublicPKBPerson entity,
                                      List&lt;PublicInstituteUser&gt; instituteUsers,
                                      Option&lt;io.vavr.collection.List&lt;PublicOrgLevelId&gt;&gt; orgLevelIds,
                                      Option&lt;io.vavr.collection.List&lt;PublicTeamLevelId&gt;&gt; teamLevelIds,
                                      Option&lt;PublicOrg&gt; sourceOrg) {
<span class="fc" id="L164">        Long personId = entity.getId();</span>

        // Map instituteUsers
<span class="fc" id="L167">        List&lt;TeamUser&gt; teams = instituteUsers</span>
<span class="fc" id="L168">                .map(instituteUser -&gt; ImmutableTeamUser.builder()</span>
<span class="fc" id="L169">                        .id(instituteUser.getTeam().getId())</span>
<span class="fc" id="L170">                        .sponsorshipStatus(instituteUser.getSponsorshipStatus())</span>
<span class="fc" id="L171">                        .teamWithOrg(teamWithOrgMapper.entityToDataModel(instituteUser.getTeam())).build());</span>
<span class="fc" id="L172">        builder.teams(io.vavr.collection.HashSet.ofAll(teams));</span>

<span class="fc" id="L174">        builder</span>
<span class="fc" id="L175">                .demographics(demographicsMapper.entityToDataModel(entity, orgLevelIds, teamLevelIds))</span>
<span class="fc" id="L176">                .id(personId)</span>
<span class="fc" id="L177">                .publicId(entity.getPublicId())</span>
<span class="fc" id="L178">                .userType(entity.getUserType())</span>
<span class="fc" id="L179">                .userStatus(entity.getStatus())</span>
<span class="fc" id="L180">                .languageCode(Option.of(entity.getLanguageCode()));</span>

<span class="fc" id="L182">        sourceOrg.map( o-&gt; builder.sourceOrg(orgMapper.entityToDataModel(o)));</span>

<span class="fc" id="L184">        return builder;</span>

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>