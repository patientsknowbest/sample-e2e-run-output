<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ServerResponseExceptionMapper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.fhir.exception</a> &gt; <span class="el_source">ServerResponseExceptionMapper.java</span></div><h1>ServerResponseExceptionMapper.java</h1><pre class="source lang-java linenums">package com.pkb.api.fhir.exception;

import ca.uhn.fhir.rest.server.exceptions.BaseServerResponseException;
import ca.uhn.fhir.rest.server.exceptions.ForbiddenOperationException;
import ca.uhn.fhir.rest.server.exceptions.InternalErrorException;
import ca.uhn.fhir.rest.server.exceptions.ResourceNotFoundException;
import com.pkb.authentication.principal.user.AuthenticatedPatient;
import com.pkb.authentication.principal.user.AuthenticatedProfessional;
import com.pkb.authentication.principal.user.AuthenticatedSystemUser;
import com.pkb.authentication.principal.user.AuthenticatedTeamCoordinator;
import com.pkb.authz.NotAuthorizedException;
import com.pkb.authz.NotFoundException;
import com.pkb.authz.condition.AccessFrozenInward;
import com.pkb.authz.condition.AccessFrozenOutward;
import com.pkb.authz.condition.InvalidUserType;
import com.pkb.authz.condition.NoAssociation;
import com.pkb.authz.condition.NoConsentRecord;
import com.pkb.datamodel.usertype.UserType;
import com.pkb.domain.criteria.OperationOutcomeFactory;
import org.apache.commons.lang3.exception.ExceptionUtils;
import org.hl7.fhir.dstu3.model.BaseResource;
import org.hl7.fhir.dstu3.model.CodeableConcept;
import org.hl7.fhir.dstu3.model.Coding;
import org.hl7.fhir.dstu3.model.OperationOutcome;
import org.hl7.fhir.dstu3.model.OperationOutcome.OperationOutcomeIssueComponent;
import org.jetbrains.annotations.NotNull;

import java.util.function.Function;

import static com.pkb.api.fhir.CanonicalCodeSystemURLs.responseCode;
import static com.pkb.api.fhir.exception.ServerResponseExceptionMapper.ResponseCodes.USER_TYPE_NOT_PERM;
import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.Match;
import static io.vavr.Predicates.instanceOf;
import static java.lang.String.format;
import static java.util.stream.Collectors.joining;
import static org.hl7.fhir.dstu3.model.OperationOutcome.IssueSeverity.ERROR;
import static org.hl7.fhir.dstu3.model.OperationOutcome.IssueType.NOTFOUND;
import static org.hl7.fhir.dstu3.model.OperationOutcome.IssueType.SECURITY;

<span class="fc" id="L42">public class ServerResponseExceptionMapper {</span>
    public static OperationOutcome operationOutcome(String code, String display, String diagnostics) {
<span class="fc" id="L44">        return OperationOutcomeFactory.operationOutcome()</span>
<span class="fc" id="L45">                .addIssue(new OperationOutcomeIssueComponent()</span>
<span class="fc" id="L46">                        .setSeverity(ERROR)</span>
<span class="fc" id="L47">                        .setCode(SECURITY)</span>
<span class="fc" id="L48">                        .setDiagnostics(diagnostics)</span>
<span class="fc" id="L49">                        .setDetails(new CodeableConcept()</span>
<span class="fc" id="L50">                                .addCoding(new Coding()</span>
<span class="fc" id="L51">                                        .setCode(code)</span>
<span class="fc" id="L52">                                        .setSystem(responseCode())</span>
<span class="fc" id="L53">                                        .setDisplay(display))));</span>
    }

    public static final String USER_TYPE_NOT_PERM_PATTERN = &quot;This operation requires a user type of: %s. Your connection is of user type: %s&quot;;
    public static final String SYSTEM_USER_TYPE_NOT_PERM_PATTERN = &quot;Your user type is not permitted to call this endpoint.&quot;;

    public static final String NOT_FOUND_INSTANCE_PATTERN = &quot;Could not find %s with ID=[%s]&quot;;
    public static final String NOT_FOUND_PATTERN = &quot;Could not find %s&quot;;

    public static final String NO_ASSOCIATION = &quot;No association&quot;;
    public static final String NO_ASSOCIATION_DIAGNOSTICS = &quot;You have no association with this data.&quot;;

    public static final String NO_CONSENT = &quot;No consent&quot;;
    public static final String NO_CONSENT_DIAGNOSTICS = &quot;You have not been granted the required privacy label to see this data, and BTG is not active.&quot;;

    public static final String USER_TYPE_NOT_PERMITTED = &quot;User type not permitted&quot;;

    public static final String ACCESS_FROZEN_OUTWARD = &quot;Access frozen outward&quot;;
    public static final String ACCESS_FROZEN_INWARD = &quot;Access frozen inward&quot;;
    public static final String ACCESS_FROZEN_OUTWARD_DIAGNOSTICS = &quot;Your access has been frozen.&quot;;
    public static final String ACCESS_FROZEN_INWARD_DIAGNOSTICS = &quot;Access to the target medical record has been frozen.&quot;;

<span class="nc" id="L75">    public static class ResponseCodes {</span>
        public static final String USER_TYPE_NOT_PERM = &quot;USER_TYPE_NOT_PERM&quot;;
        public static final String NO_ASSOCIATION = &quot;NO_ASSOCIATION&quot;;
        public static final String NO_CONSENT = &quot;NO_CONSENT&quot;;
        public static final String ACCESS_FROZEN_INWARD = &quot;ACCESS_FROZEN_INWARD&quot;;
        public static final String ACCESS_FROZEN_OUTWARD = &quot;ACCESS_FROZEN_OUTWARD&quot;;

    }

    public &lt;R extends BaseResource&gt; BaseServerResponseException minimalFlow(@NotNull Throwable cause, @NotNull Class&lt;R&gt; resourceType) {
<span class="nc" id="L85">        return Match(cause).of(</span>
                // TODO Remove handling VirtualMachineError once we update to vavr 1.0
<span class="nc" id="L87">                Case($(instanceOf(VirtualMachineError.class)), ExceptionUtils::rethrow),</span>
<span class="nc" id="L88">                Case($(instanceOf(NotAuthorizedException.class)), this::notAuthorized),</span>
<span class="nc" id="L89">                Case($(instanceOf(NotFoundException.class)), toNotFound(resourceType)),</span>
<span class="nc" id="L90">                Case($(instanceOf(Throwable.class)), this::toInternalError));</span>
    }

    public BaseServerResponseException notAuthorized(NotAuthorizedException notAuthorized) {
<span class="fc" id="L94">        return notAuthorized</span>
<span class="fc" id="L95">                .findFirst(InvalidUserType.class)</span>
<span class="fc" id="L96">                .map(this::userTypeNotPermitted)</span>
<span class="fc" id="L97">                .getOrElse(() -&gt; {</span>
<span class="fc bfc" id="L98" title="All 2 branches covered.">                    if (notAuthorized.contains(NoAssociation.class)) {</span>
<span class="fc" id="L99">                        return toForbidden(ResponseCodes.NO_ASSOCIATION, NO_ASSOCIATION, NO_ASSOCIATION, NO_ASSOCIATION_DIAGNOSTICS);</span>
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">                    } else if (notAuthorized.contains(NoConsentRecord.class)) {</span>
<span class="nc" id="L101">                        return toForbidden(ResponseCodes.NO_CONSENT, NO_CONSENT, NO_CONSENT, NO_CONSENT_DIAGNOSTICS);</span>
<span class="pc bpc" id="L102" title="1 of 2 branches missed.">                    } else if (notAuthorized.contains(AccessFrozenOutward.class)) {</span>
<span class="nc" id="L103">                        return toForbidden(ResponseCodes.ACCESS_FROZEN_OUTWARD, ACCESS_FROZEN_OUTWARD, ACCESS_FROZEN_OUTWARD, ACCESS_FROZEN_OUTWARD_DIAGNOSTICS);</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">                    } else if (notAuthorized.contains(AccessFrozenInward.class)) {</span>
<span class="nc" id="L105">                        return toForbidden(ResponseCodes.ACCESS_FROZEN_INWARD, ACCESS_FROZEN_INWARD, ACCESS_FROZEN_INWARD, ACCESS_FROZEN_INWARD_DIAGNOSTICS);</span>
                    } else {
<span class="fc" id="L107">                        return unspecifiedUserTypeNotPermitted();</span>
                    }
                });
    }

    public BaseServerResponseException userTypeNotPermitted(InvalidUserType&lt;?&gt; invalidUserType) {
        try {
<span class="nc" id="L114">            String allowedUserTypes = invalidUserType.allowedUserTypes()</span>
<span class="nc" id="L115">                    .map(this::toUserType)</span>
<span class="nc" id="L116">                    .distinct()</span>
<span class="nc" id="L117">                    .toSortedSet()</span>
<span class="nc" id="L118">                    .collect(joining(&quot;,&quot;));</span>
<span class="nc" id="L119">            String currentUserType = toUserType(invalidUserType.userType());</span>

<span class="nc" id="L121">            String diagnostics = format(USER_TYPE_NOT_PERM_PATTERN, allowedUserTypes, currentUserType);</span>

<span class="nc" id="L123">            return toForbidden(USER_TYPE_NOT_PERM, USER_TYPE_NOT_PERMITTED, USER_TYPE_NOT_PERMITTED, diagnostics);</span>
<span class="nc" id="L124">        } catch (IllegalStateException e) {</span>
<span class="nc" id="L125">            return toInternalError(e);</span>
        }
    }

    public BaseServerResponseException systemUserTypeNotPermitted() {
<span class="fc" id="L130">        return toForbidden(USER_TYPE_NOT_PERM, USER_TYPE_NOT_PERMITTED, USER_TYPE_NOT_PERMITTED, SYSTEM_USER_TYPE_NOT_PERM_PATTERN);</span>
    }

    public BaseServerResponseException unspecifiedUserTypeNotPermitted() {
        try {
<span class="fc" id="L135">            OperationOutcome outcome = OperationOutcomeFactory.operationOutcome()</span>
<span class="fc" id="L136">                    .addIssue(new OperationOutcomeIssueComponent()</span>
<span class="fc" id="L137">                            .setSeverity(ERROR)</span>
<span class="fc" id="L138">                            .setCode(SECURITY));</span>
<span class="fc" id="L139">            return new ForbiddenOperationException(&quot;&quot;, outcome); // No more helpful messages</span>
<span class="nc" id="L140">        } catch (IllegalStateException e) {</span>
<span class="nc" id="L141">            return toInternalError(e);</span>
        }
    }

    public &lt;R extends BaseResource&gt; Function&lt;NotFoundException, BaseServerResponseException&gt; toNotFound(Class&lt;R&gt; resourceType) {
<span class="fc" id="L146">        return notFound -&gt; {</span>
<span class="fc" id="L147">            Object id = notFound.getTargetId();</span>

<span class="pc bpc" id="L149" title="1 of 2 branches missed.">            String message = id == null ?</span>
<span class="nc" id="L150">                    format(NOT_FOUND_PATTERN, resourceType.getSimpleName()) :</span>
<span class="fc" id="L151">                    format(NOT_FOUND_INSTANCE_PATTERN, resourceType.getSimpleName(), id);</span>

<span class="fc" id="L153">            OperationOutcome outcome = OperationOutcomeFactory.operationOutcome()</span>
<span class="fc" id="L154">                    .addIssue(new OperationOutcomeIssueComponent()</span>
<span class="fc" id="L155">                            .setSeverity(ERROR)</span>
<span class="fc" id="L156">                            .setCode(NOTFOUND)</span>
<span class="fc" id="L157">                            .setDiagnostics(message));</span>

<span class="fc" id="L159">            return new ResourceNotFoundException(message, outcome);</span>
        };
    }

    private &lt;R&gt; BaseServerResponseException toInternalError(Throwable reason) {
<span class="nc" id="L164">        return new InternalErrorException(reason);</span>
    }

    private ForbiddenOperationException toForbidden(String code, String display, String message, String diagnostics) {
<span class="fc" id="L168">        OperationOutcome operationOutcome = operationOutcome(code, display, diagnostics);</span>

<span class="fc" id="L170">        ForbiddenOperationException forbiddenOperationException = new ForbiddenOperationException(message);</span>
<span class="fc" id="L171">        forbiddenOperationException.setOperationOutcome(operationOutcome);</span>

<span class="fc" id="L173">        return forbiddenOperationException;</span>
    }

    private String toUserType(Class&lt;? extends UserType&gt; userType) {
<span class="nc bnc" id="L177" title="All 2 branches missed.">        if (AuthenticatedPatient.class.isAssignableFrom(userType)) {</span>
<span class="nc" id="L178">            return &quot;Patient&quot;;</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">        } else if (AuthenticatedProfessional.class.isAssignableFrom(userType)) {</span>
<span class="nc" id="L180">            return &quot;Professional&quot;;</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">        } else if (AuthenticatedTeamCoordinator.class.isAssignableFrom(userType)) {</span>
<span class="nc" id="L182">            return &quot;Team Coordinator&quot;;</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">        } else if (AuthenticatedSystemUser.class.isAssignableFrom(userType)){</span>
<span class="nc" id="L184">            return &quot;System User&quot;;</span>
        } else {
<span class="nc" id="L186">            throw new IllegalStateException(format(&quot;Class %s cannot be mapped to FHIR representation.&quot;, userType.getName()));</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>