<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DiagnosisManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.diagnosis</a> &gt; <span class="el_source">DiagnosisManager.java</span></div><h1>DiagnosisManager.java</h1><pre class="source lang-java linenums">package com.pkb.service.diagnosis;

import com.pkb.app.dto.PageFilterDTO;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.common.base.Error;
import com.pkb.common.config.PhrConfig;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.dataupload.entity.UploadedData;
import com.pkb.diagnosis.entity.Diagnosis;
import com.pkb.emis.es.entity.EmisEsObservationDelta;
import com.pkb.entities.enums.DiagnosisClinicalStatus;
import com.pkb.exception.PKBException;
import com.pkb.service.SynchableManager;
import com.pkb.service.code.CodeManager;
import com.pkb.service.dataupload.emis.esv2.EmisEsDeltaManager;
import com.pkb.service.dataupload.emis.esv2.EmisEsManager;
import com.pkb.service.dataupload.emis.esv2.batch.impl.EmisEsProblemStatusDescriptionHelperMixin;
import com.pkb.service.dataupload.processor.UploadedDataService;
import com.pkb.service.uuid.UUIDProvider;
import com.pkb.util.tolven.TolvenBeanFactory;
import io.vavr.control.Either;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.Instant;
import java.util.Collection;
import java.util.LinkedList;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

import static com.pkb.entities.enums.ConditionCategory.PROBLEM_LIST_ITEM;
import static com.pkb.service.dataupload.processor.ImmutableLoggedInUploadedDataProcessingContext.loggedInUploadedDataProcessingContext;
import static java.lang.invoke.MethodHandles.lookup;

public class DiagnosisManager extends EmisEsDeltaManager&lt;Diagnosis&gt; implements EmisEsProblemStatusDescriptionHelperMixin, SynchableManager {

<span class="fc" id="L41">    private static final Logger LOGGER = LoggerFactory.getLogger(lookup().lookupClass());</span>

    private final UploadedDataService uploadedDataService;
    private final CodeManager codeManager;
    private final EHRDiagnosisManager ehrDiagnosisManager;

    public DiagnosisManager(PhrConfig config, TolvenBeanFactory beanFactory, DateTimeService dateTimeService, UUIDProvider uuidProvider, EmisEsManager emisEsManager,
                            UploadedDataService uploadedDataService, CodeManager codeManager, EHRDiagnosisManager ehrDiagnosisManager) {
<span class="fc" id="L49">        super(config, beanFactory, dateTimeService, uuidProvider, emisEsManager);</span>
<span class="fc" id="L50">        this.uploadedDataService = uploadedDataService;</span>
<span class="fc" id="L51">        this.codeManager = codeManager;</span>
<span class="fc" id="L52">        this.ehrDiagnosisManager = ehrDiagnosisManager;</span>
<span class="fc" id="L53">    }</span>

    /**
     * Persist a diagnosis
     *
     * @return Either[reason for not saving the diagnosis, uniqueId of the new diagnosis]
     */
    public Either&lt;String, UUID&gt; saveDiagnosis(Diagnosis diagnosis, EHRRequestContext requestContext) {
        try {
<span class="fc" id="L62">            return ehrDiagnosisManager.save(requestContext, diagnosis);</span>
<span class="nc" id="L63">        } catch (Exception exception) {</span>
<span class="nc" id="L64">            throw new PKBException(&quot;Error while saving Diagnosis&quot;, exception);</span>
        }
    }

    /**
     * @param diagnosisList
     */
    public void addDiagnoses(List&lt;Diagnosis&gt; diagnosisList, EHRRequestContext requestContext) {
        try {
<span class="fc" id="L73">            ehrDiagnosisManager.save(requestContext, diagnosisList);</span>
<span class="nc" id="L74">        } catch (Exception exception) {</span>
<span class="nc" id="L75">            throw new PKBException(&quot;Error while adding diagosis list&quot;, exception);</span>
<span class="fc" id="L76">        }</span>
<span class="fc" id="L77">    }</span>

    /**
     * Update a diagnosis record
     *
     * @return Either
     *         Either.left = Error message if update detects that datapoint is excluded via CodingMatch entry
     *         Either.right = uniqueId of the diagnosis
     */
    /**
     * @return Either
     *         Either.left = Error message if update detects that datapoint is excluded via CodingMatch entry
     *         Either.right = uniqueId of the diagnosis
     */
    public Either&lt;String, UUID&gt; updateDiagnosis(long patientId, Diagnosis diagnosis, EHRRequestContext requestContext) {
        try {
<span class="fc" id="L93">            return ehrDiagnosisManager.update(requestContext, diagnosis);</span>
<span class="nc" id="L94">        } catch (Exception exception) {</span>
<span class="nc" id="L95">            throw new PKBException(&quot;Error while updating Diagnosis&quot;, exception);</span>
        }
    }

    /**
     * Retrieve a full list of diagnoses for the given patient
     *
     * @param patientLdapId
     * @param patientAccountId
     * @param offset
     * @param pageSize
     * @param context
     * @return
     */
    public List&lt;Diagnosis&gt; getDiagnoses(Long patientId, Long patientAccountId, PageFilterDTO pageFilterOrNull,
            @NotNull LoggedInEHRRequestContext requestContext, boolean includeNegativeConditions) {
        try {

<span class="fc" id="L113">            syncData(patientAccountId, requestContext, patientId);</span>

<span class="fc" id="L115">            boolean includeNonProblems = false;</span>
<span class="fc" id="L116">            return ehrDiagnosisManager.getDiagnoses(requestContext, patientAccountId, pageFilterOrNull,</span>
                    includeNegativeConditions, includeNonProblems);
<span class="nc" id="L118">        } catch (Exception exception) {</span>
<span class="nc" id="L119">            throw new PKBException(&quot;Error while getting Diagnosis list&quot;, exception);</span>
        }
    }

    private void syncData(Long patientAccountId, @NotNull LoggedInEHRRequestContext requestContext, long patientId) {
<span class="fc" id="L124">        synchUploadedData(patientId, requestContext);</span>
<span class="fc" id="L125">        applyEmisEsDeltas(requestContext, patientId, patientAccountId);</span>
<span class="fc" id="L126">    }</span>

    /**
     * Retrieve a list of selected diagnoses
     *
     * @param patientLdapId
     * @param patientAccountId
     * @param diagnosisIds
     * @return
     */
    public List&lt;Diagnosis&gt; getDiagnoses(long patientId, Long patientAccountId, List&lt;Long&gt; diagnosisIds,
            @NotNull LoggedInEHRRequestContext requestContext, boolean includeNegativeConditions) {
        try {

<span class="fc" id="L140">            syncData(patientAccountId, requestContext, patientId);</span>
<span class="fc" id="L141">            return ehrDiagnosisManager.getDiagnoses(requestContext, patientAccountId, new LinkedList&lt;&gt;(diagnosisIds),</span>
                    includeNegativeConditions);
<span class="nc" id="L143">        } catch (Exception exception) {</span>
<span class="nc" id="L144">            throw new PKBException(&quot;Error while getting Diagnosis list&quot;, exception);</span>
        }
    }

    /**
     * Currently only used for testing: these are diagnoses that EMIS submits that are not currently on the problem list
     *
     * @param patientLdapId
     * @param patientAccountId
     * @param requestContext
     * @return
     */
    public List&lt;Diagnosis&gt; getDiagnosesIncludingNonProblems(long patientId, Long patientAccountId, @NotNull LoggedInEHRRequestContext requestContext) {
        try {

<span class="nc" id="L159">            syncData(patientAccountId, requestContext, patientId);</span>
<span class="nc" id="L160">            PageFilterDTO pageFilterOrNull = null;</span>
<span class="nc" id="L161">            boolean includeNegativeConditions = true;</span>
<span class="nc" id="L162">            boolean includeNonProblems = true;</span>
<span class="nc" id="L163">            return ehrDiagnosisManager.getDiagnoses(requestContext, patientAccountId,</span>
                    pageFilterOrNull,
                    includeNegativeConditions,
                    includeNonProblems);
<span class="nc" id="L167">        } catch (Exception exception) {</span>
<span class="nc" id="L168">            throw new PKBException(&quot;Error while getting Diagnosis list&quot;, exception);</span>
        }
    }

    /**
     * Retrieve a single diagnosis
     *
     * @param patientLdapId
     * @param patientAccountId
     * @param diagnosisId
     * @return
     */
    public Optional&lt;Diagnosis&gt; findDiagnosis(long patientAccountId, Long diagnosisId, @NotNull LoggedInEHRRequestContext requestContext) {
<span class="fc" id="L181">        return Optional.ofNullable(ehrDiagnosisManager.getById(requestContext, diagnosisId));</span>
    }

    /**
     * Retrieve a single diagnosis, throws exception in case it cannot be found
     *
     * @param patientLdapId
     * @param diagnosisId
     * @param requestContext
     * @return
     */
    public Diagnosis getDiagnosis(long patientAccountId, long diagnosisId, @NotNull LoggedInEHRRequestContext requestContext) {
<span class="fc" id="L193">        return findDiagnosis(patientAccountId, diagnosisId, requestContext).orElseThrow(() -&gt; new IllegalStateException(&quot;Can't find diagnosis for id: &quot; + diagnosisId));</span>
    }

    /**
     * Delete a list of selected diagnoses
     *
     * @param patientLdapId
     * @param patientAccountId
     * @param diagnosisIds
     */
    public List&lt;Diagnosis&gt; deleteDiagnoses(Long patientAccountId, List&lt;Long&gt; diagnosisIds,
            SourceDetails deletedBy, Instant updatedSinceDateOrNull, LoggedInEHRRequestContext requestContext) {
        try {
<span class="fc" id="L206">            return ehrDiagnosisManager.deleteByIds(requestContext, patientAccountId, new LinkedList&lt;&gt;(diagnosisIds), deletedBy, updatedSinceDateOrNull</span>
            );
<span class="nc" id="L208">        } catch (Exception exception) {</span>
<span class="nc" id="L209">            throw new PKBException(&quot;Error while deleting Diagnosis list&quot;, exception);</span>
        }
    }

    /**
     * Get Diagnoses by code and updated Since date
     *
     * @param patientId
     * @param accountId
     * @param apiRefsOrNull
     *            - optional list of apiRefs to search on
     * @param updatedSinceDate
     *            - if present, only include results that have been recorded since this date
     * @return
     */
    public List&lt;Diagnosis&gt; getDiagnoses(long patientId, Long patientAccountId, List&lt;String&gt; apiRefsOrNull,
            Instant updatedSinceDateOrNull, @NotNull LoggedInEHRRequestContext requestContext,
            boolean includeNegativeConditions) {
        try {
<span class="fc" id="L228">            List&lt;String&gt; codes = null;</span>
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">            if (apiRefsOrNull != null) {</span>
<span class="nc" id="L230">                codes = DiagnosisApiRef.getCodesByApiRef(apiRefsOrNull);</span>
            }


<span class="fc" id="L234">            syncData(patientAccountId, requestContext, patientId);</span>
<span class="fc" id="L235">            boolean includeNonProblems = false;</span>

<span class="fc" id="L237">            return ehrDiagnosisManager.getDiagnoses(patientAccountId, codeManager.getCodeIds(codes), updatedSinceDateOrNull, requestContext,</span>
                    includeNegativeConditions, includeNonProblems);
<span class="nc" id="L239">        } catch (Exception exception) {</span>
<span class="nc" id="L240">            throw new PKBException(</span>
                    &quot;Error while fetching Diagnosis list by codes&quot;, exception);
        }
    }

    /**
     * Uses transactions, and commits after each UploadedData is processed... if this needs to be called from within a
     * transaction in the action, we'll need some fancier coding here (maybe programmatically merge the messages and submit
     * at once?).
     *
     * Doesn't catch/handle any exceptions; just logs errors and sometimes lets them flow out (but more often just logs)
     */
    private void synchUploadedData(long patientId, @NotNull LoggedInEHRRequestContext requestContext) {
<span class="fc" id="L253">        uploadedDataService.synchUploadedData(</span>
<span class="fc" id="L254">                loggedInUploadedDataProcessingContext()</span>
<span class="fc" id="L255">                        .requestContext(requestContext.withPiggyback(true))</span>
<span class="fc" id="L256">                        .patientId(patientId)</span>
<span class="fc" id="L257">                        .destination(UploadedData.Destination.DIAGNOSIS_UPDATE)</span>
<span class="fc" id="L258">                        .build());</span>
<span class="fc" id="L259">    }</span>

    /**
     * Retrieve a single diagnosis by unique Id
     *
     * @param patientLdapId
     * @param patientAccountId
     * @param uniqueId
     * @return
     */
    public Diagnosis getDiagnosisByUniqueId(long patientAccountId, UUID uniqueId, @NotNull LoggedInEHRRequestContext requestContext) {
<span class="fc" id="L270">        return ehrDiagnosisManager.getByUniqueId(requestContext, patientAccountId, uniqueId);</span>
    }

    @Override
    public Either&lt;Error, Diagnosis&gt; applyDelta(@NotNull LoggedInEHRRequestContext ehrRequestContext, long patientId, long patientAccountId,
            EmisEsObservationDelta delta) {
<span class="fc" id="L276">        Diagnosis diagnosis = getDiagnosisByUniqueId(patientAccountId, delta.getParentUniqueId(), ehrRequestContext);</span>
<span class="fc" id="L277">        diagnosis.setId(null);</span>
<span class="fc bfc" id="L278" title="All 2 branches covered.">        if (delta.isProblemDeleted()) {</span>
<span class="fc" id="L279">            diagnosis.setEndDate(null);</span>
<span class="fc" id="L280">            diagnosis.setClinicalStatus(DiagnosisClinicalStatus.ACTIVE);</span>
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">            if (diagnosis.getStartDate() != null) {</span>
<span class="fc" id="L282">                diagnosis.setDateAsserted(diagnosis.getStartDate());</span>
            }
<span class="fc" id="L284">            diagnosis.setStartDate(null);</span>
<span class="fc" id="L285">            diagnosis.setCategory(null);</span>
        } else {
<span class="fc" id="L287">            diagnosis.setEndDate(delta.getEndDate());</span>
<span class="fc" id="L288">            handleProblemStatusDescription(delta,</span>
<span class="fc" id="L289">                    status -&gt; diagnosis.setClinicalStatus(DiagnosisClinicalStatus.ACTIVE),</span>
<span class="fc" id="L290">                    status -&gt; diagnosis.setClinicalStatus(DiagnosisClinicalStatus.INACTIVE));</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">            if (diagnosis.getDateAsserted() != null) {</span>
<span class="fc" id="L292">                diagnosis.setStartDate(diagnosis.getDateAsserted());</span>
<span class="fc" id="L293">                diagnosis.setDateAsserted(null);</span>
            }
<span class="fc" id="L295">            diagnosis.setCategory(PROBLEM_LIST_ITEM);</span>
        }
<span class="fc" id="L297">        Either&lt;String, UUID&gt; result = updateDiagnosis(patientId, diagnosis, ehrRequestContext);</span>
<span class="pc" id="L298">        return result.map(uniqueId -&gt; diagnosis).mapLeft(errorMessage -&gt; new Error(ERROR_APPLYING_DELTA, result.getLeft()));</span>
    }

    @Override
    public EmisEsObservationDelta.DeltaType getDeltaType() {
<span class="fc" id="L303">        return EmisEsObservationDelta.DeltaType.DIAGNOSIS;</span>
    }

    @Override public void syncUploadedData(LoggedInEHRRequestContext requestContext, Collection&lt;Long&gt; targetPersonIds) {
<span class="fc" id="L307">        targetPersonIds.forEach(patientId -&gt; {</span>
            try {
<span class="fc" id="L309">                synchUploadedData(patientId, requestContext);</span>
<span class="nc" id="L310">            } catch (Exception e) {</span>
<span class="nc" id="L311">                LOGGER.error(&quot;Error syncing uploaded data for patient: {}&quot;, patientId, e);</span>
<span class="fc" id="L312">            }</span>
<span class="fc" id="L313">        });</span>
<span class="fc" id="L314">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>