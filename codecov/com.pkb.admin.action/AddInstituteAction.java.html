<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AddInstituteAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.admin.action</a> &gt; <span class="el_source">AddInstituteAction.java</span></div><h1>AddInstituteAction.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------
//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
// $Id: AddInstituteAction.java Jun 18, 2010 11:57:57 AM anamikac$
//
//------------------------------------------------------------------------------
package com.pkb.admin.action;

import com.opensymphony.xwork2.Action;
import com.pkb.datamodel.Email;
import com.pkb.entities.enums.UserType;
import com.pkb.exception.PKBException;
import com.pkb.exception.UserAlreadyExistsException;
import com.pkb.institute.entity.InstituteUser;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import com.pkb.institute.entity.Team.PatientIdSupport;
import com.pkb.model.PKBPersonDTO;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.util.StringUtil;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.naming.NamingException;
import java.io.File;
import java.io.IOException;

import static org.apache.commons.lang3.StringUtils.isBlank;


<span class="fc" id="L34">public class AddInstituteAction extends InstituteBaseAction {</span>

    private static final long serialVersionUID = 1L;

<span class="fc" id="L38">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private InstituteUser instituteUser;

    private Email instAdminEmail;

    private TeamUserManager teamUserManager;


    private File logo;

    public File getOrgLogo() {
<span class="fc" id="L50">        return orgLogo;</span>
    }

    public void setOrgLogo(File orgLogo) {
<span class="fc" id="L54">        this.orgLogo = orgLogo;</span>
<span class="fc" id="L55">    }</span>

    public String getOrgLogoFileName() {
<span class="nc" id="L58">        return orgLogoFileName;</span>
    }

    public void setOrgLogoFileName(String orgLogoFileName) {
<span class="fc" id="L62">        this.orgLogoFileName = orgLogoFileName;</span>
<span class="fc" id="L63">    }</span>

    private File orgLogo;

    private String logoContentType;

    private String logoFileName;

    private String orgLogoFileName;

    private File headerImg;

    private String headerImgContentType;

    private String headerImgFileName;

    private File footerImg;

    private String footerImgContentType;

    private String footerImgFileName;

    private Long specialtyId;

    private String patientIdSupport;

    private String timeZoneId;

    private long instituteUserId;

    private boolean cancerTeam;

<span class="fc" id="L95">    private final String tab = &quot;customers&quot;;</span>

<span class="fc" id="L97">    private final String subTab = &quot;addCustomer&quot;;</span>

<span class="fc" id="L99">    private boolean mandatoryNationalId = true;</span>

    private boolean defaultNewProsContactable;

    /**
     * Save an institute and its associated administrator after validating admin
     * user name and institute code.
     */
    @Override
    public String execute() {
        try {
<span class="fc" id="L110">            Team team = teamManager.getTeamByCode(instituteUser.getInstitute().getCode());</span>
<span class="pc bpc" id="L111" title="1 of 2 branches missed.">            if (team != null) {</span>
<span class="nc" id="L112">                addFieldError(&quot;instituteUser.team.code&quot;,</span>
<span class="nc" id="L113">                        getText(&quot;err.institute.code.already.exist&quot;));</span>
<span class="nc" id="L114">                return Action.INPUT;</span>
            }

<span class="pc bpc" id="L117" title="1 of 2 branches missed.">            if (checkRequiredImages()) {</span>
<span class="nc" id="L118">                return Action.INPUT;</span>
            } else {
<span class="fc" id="L120">                addInstitute();</span>
            }

<span class="nc" id="L123">        } catch (UserAlreadyExistsException ignored) {</span>
<span class="nc" id="L124">            addFieldError(&quot;instAdminEmail&quot;,</span>
<span class="nc" id="L125">                    getText(&quot;user.err.alreadyexist&quot;));</span>
<span class="nc" id="L126">            return INPUT;</span>
<span class="nc" id="L127">        } catch (PKBException | IOException e) {</span>
<span class="nc" id="L128">            LOGGER.error(&quot;Error while creating institute&quot;, e);</span>
<span class="nc" id="L129">            addActionError(getText(&quot;err.create.institute&quot;));</span>
<span class="nc" id="L130">            return INPUT;</span>
<span class="fc" id="L131">        }</span>
<span class="fc" id="L132">        return SUCCESS;</span>
    }

    /**
     * Required field validation of images.
     */
    private boolean checkRequiredImages() throws IOException {
<span class="fc" id="L139">        boolean flag = false;</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">        if (logo == null) {</span>
<span class="nc" id="L141">            addFieldError(&quot;logo&quot;, getText(&quot;err.required.logo.image&quot;));</span>
<span class="nc" id="L142">            flag = true;</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        } else if (!validateImage(logo, logoFileName, &quot;logo&quot;)) {</span>
<span class="nc" id="L144">            flag = true;</span>
        }
<span class="pc bpc" id="L146" title="1 of 2 branches missed.">        if (headerImg != null) {</span>
<span class="pc bpc" id="L147" title="1 of 2 branches missed.">            if (!validateImage(headerImg, headerImgFileName, &quot;header&quot;)) {</span>
<span class="nc" id="L148">                flag = true;</span>
            }
        }
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">        if (footerImg != null) {</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">            if (!validateImage(footerImg, footerImgFileName, &quot;footer&quot;)) {</span>
<span class="nc" id="L153">                flag = true;</span>
            }
        }
<span class="fc bfc" id="L156" title="All 2 branches covered.">        if (orgLogo != null) {</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">            if (!validateImage(orgLogo, orgLogoFileName, &quot;orgLogo&quot;)) {</span>
<span class="nc" id="L158">                flag = true;</span>
            }
        }
<span class="fc" id="L161">        return flag;</span>
    }

    /**
     * Set the image file name and create an institute and administrator. Send
     * an invitation to administrator to register. Associate this admin to the
     * newly created institute by making an entry in institute user table.
     *
     * @throws NamingException
     */
    private void addInstitute() {
<span class="fc" id="L172">        Team team = instituteUser.getInstitute();</span>
<span class="fc" id="L173">        team.setLogoFileName(logoFileName);</span>
<span class="fc" id="L174">        team.setHeaderFileName(headerImgFileName);</span>
<span class="fc" id="L175">        team.setFooterFileName(footerImgFileName);</span>
<span class="fc" id="L176">        team.setMandatoryNationalId(mandatoryNationalId);</span>
        //Code should be case insensitive hence store it in lower case
<span class="fc" id="L178">        team.setCode(instituteUser.getInstitute().getCode().toLowerCase());</span>
<span class="fc" id="L179">        team.setSpecialtyId(specialtyId);</span>
<span class="fc" id="L180">        team.setCancerTeam(cancerTeam);</span>
<span class="fc" id="L181">        team.setPatientIdSupport(PatientIdSupport.valueOf(patientIdSupport));</span>
<span class="fc" id="L182">        team.setTimeZoneId(timeZoneId);</span>
        // Consent required to see this team if you're not the account owner
<span class="fc" id="L184">        setConsentCategoriesOnEntity(team);</span>

<span class="fc" id="L186">        team.setDefaultNewProsContactable(this.isDefaultNewProsContactable());</span>
<span class="fc" id="L187">        team.setId(null);</span>


<span class="fc" id="L190">        Org formOrg = team.getOrg();</span>
<span class="pc bpc" id="L191" title="1 of 4 branches missed.">        if ((formOrg.getId() != null) &amp;&amp; (formOrg.getId() &gt; 0L)) {</span>
            // selected existing.  Shouldn't ALSO have a name entered...
<span class="pc bpc" id="L193" title="1 of 2 branches missed.">            if (!StringUtils.isEmpty(formOrg.getName())) {</span>
<span class="nc" id="L194">                throw new PKBException(&quot;Org &quot; + formOrg.getId() + &quot; is selected but name ALSO entered &quot; + formOrg.getName());</span>
            }

        }
        else {
<span class="fc" id="L199">            formOrg.setLogoFileName(orgLogoFileName);</span>
<span class="fc" id="L200">            formOrg.setId(null); // clear out the &quot;-1&quot; from the form</span>
        }

<span class="fc" id="L203">        PKBPerson admin = instituteUser.getPerson();</span>
<span class="fc" id="L204">        PKBPersonDTO adminDTO = PKBPersonDTO.of(</span>
<span class="fc" id="L205">                admin.getTitle(),</span>
<span class="fc" id="L206">                admin.getFirstName(),</span>
<span class="fc" id="L207">                admin.getLastName(),</span>
                instAdminEmail,
                UserType.INSTITUTE_ADMIN,
<span class="fc" id="L210">                getContextAndLoggedInUsers().loggedInUser().getLanguageCode(),</span>
<span class="fc" id="L211">                team.getTimeZoneId());</span>
<span class="fc" id="L212">        instituteUser = teamUserManager.createTeamWithInitialCoordinator(getLoggedInEHRRequestContext(), team, formOrg, adminDTO, getContextAndLoggedInUsers().loggedInUser());</span>
<span class="fc" id="L213">    }</span>

    @Override
    public String input() {
<span class="fc" id="L217">        return SUCCESS;</span>
    }

    public InstituteUser getInstituteUser() {
<span class="fc" id="L221">        return instituteUser;</span>
    }

    public void setInstituteUser(InstituteUser instituteUser) {
<span class="fc" id="L225">        this.instituteUser = instituteUser;</span>
<span class="fc" id="L226">    }</span>

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L229">        this.userManager = userManager;</span>
<span class="fc" id="L230">    }</span>

    public File getLogo() {
<span class="fc" id="L233">        return logo;</span>
    }

    public void setLogo(File logo) {
<span class="fc" id="L237">        this.logo = logo;</span>
<span class="fc" id="L238">    }</span>

    public String getLogoContentType() {
<span class="nc" id="L241">        return logoContentType;</span>
    }

    public void setLogoContentType(String logoContentType) {
<span class="fc" id="L245">        this.logoContentType = logoContentType;</span>
<span class="fc" id="L246">    }</span>

    public String getLogoFileName() {
<span class="nc" id="L249">        return logoFileName;</span>
    }

    public void setLogoFileName(String logoFileName) {
<span class="fc" id="L253">        this.logoFileName = logoFileName;</span>
<span class="fc" id="L254">    }</span>

    public String getHeaderImgFileName() {
<span class="nc" id="L257">        return headerImgFileName;</span>
    }

    public void setHeaderImgFileName(String headerImgFileName) {
<span class="fc" id="L261">        this.headerImgFileName = headerImgFileName;</span>
<span class="fc" id="L262">    }</span>

    public String getFooterImgFileName() {
<span class="nc" id="L265">        return footerImgFileName;</span>
    }

    public void setFooterImgFileName(String footerImgFileName) {
<span class="fc" id="L269">        this.footerImgFileName = footerImgFileName;</span>
<span class="fc" id="L270">    }</span>

    public File getHeaderImg() {
<span class="fc" id="L273">        return headerImg;</span>
    }

    public void setHeaderImg(File headerImg) {
<span class="fc" id="L277">        this.headerImg = headerImg;</span>
<span class="fc" id="L278">    }</span>

    public String getHeaderImgContentType() {
<span class="nc" id="L281">        return headerImgContentType;</span>
    }

    public void setHeaderImgContentType(String headerImgContentType) {
<span class="fc" id="L285">        this.headerImgContentType = headerImgContentType;</span>
<span class="fc" id="L286">    }</span>

    public File getFooterImg() {
<span class="fc" id="L289">        return footerImg;</span>
    }

    public void setFooterImg(File footerImg) {
<span class="fc" id="L293">        this.footerImg = footerImg;</span>
<span class="fc" id="L294">    }</span>

    public String getFooterImgContentType() {
<span class="nc" id="L297">        return footerImgContentType;</span>
    }

    public void setFooterImgContentType(String footerImgContentType) {
<span class="fc" id="L301">        this.footerImgContentType = footerImgContentType;</span>
<span class="fc" id="L302">    }</span>

    public long getInstituteUserId() {
<span class="nc" id="L305">        return instituteUserId;</span>
    }

    public void setInstituteUserId(long instituteUserId) {
<span class="nc" id="L309">        this.instituteUserId = instituteUserId;</span>
<span class="nc" id="L310">    }</span>

    @Override
    public void validate() {
<span class="pc bpc" id="L314" title="1 of 2 branches missed.">        if ((instituteUser.getPerson().getTitle() == null)</span>
<span class="pc bpc" id="L315" title="1 of 4 branches missed.">                || ((instituteUser.getPerson().getTitle().trim() != null) &amp;&amp; instituteUser.getPerson().getTitle().trim().isEmpty())</span>
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">                || &quot;-1&quot;.equals(instituteUser.getPerson().getTitle().trim())) {</span>
<span class="fc" id="L317">            addFieldError(&quot;instituteUser.person.title&quot;, getText(&quot;user.required.title&quot;));</span>
        }

<span class="fc" id="L320">        String teamCode = instituteUser.getInstitute().getCode();</span>
<span class="pc bpc" id="L321" title="1 of 2 branches missed.">        if (!StringUtils.containsOnly(teamCode, StringUtil.ALPHA_NUMERIC + &quot;-_&quot;)) {</span>
<span class="nc" id="L322">            addFieldError(&quot;instituteUser.institute.code&quot;, getText(&quot;addInstitute.err.bad_code&quot;));</span>
        }
<span class="fc" id="L324">        String orgCode = instituteUser.getInstitute().getOrg().getCode();</span>
<span class="pc bpc" id="L325" title="1 of 2 branches missed.">        if (!StringUtils.containsOnly(orgCode, StringUtil.ALPHA_NUMERIC + &quot;-_&quot;)) {</span>
<span class="nc" id="L326">            addFieldError(&quot;instituteUser.institute.org.code&quot;, getText(&quot;addInstitute.err.bad_code&quot;));</span>
        }

        // either org ID must be selected, OR org fields must be filled in
<span class="fc" id="L330">        Org newOrg = instituteUser.getInstitute().getOrg();</span>
<span class="pc bpc" id="L331" title="1 of 4 branches missed.">        if ((newOrg.getId() == null) || (newOrg.getId() &lt;= 0)) {</span>
<span class="fc bfc" id="L332" title="All 2 branches covered.">            if (isBlank(newOrg.getName()) ||</span>
<span class="pc bpc" id="L333" title="1 of 2 branches missed.">                    isBlank(newOrg.getCode()) ||</span>
<span class="pc bpc" id="L334" title="1 of 2 branches missed.">                    isBlank(newOrg.getCountry())) {</span>
<span class="fc" id="L335">                addFieldError(&quot;instituteUser.institute.org.code&quot;, getText(&quot;addInstitute.err.org_req_fields&quot;));</span>
            }
        }
<span class="fc" id="L338">    }</span>

    public String getTab() {
<span class="fc" id="L341">        return tab;</span>
    }

    public String getSubTab() {
<span class="fc" id="L345">        return subTab;</span>
    }

    public Email getInstAdminEmail() {
<span class="fc" id="L349">        return instAdminEmail;</span>
    }

    public void setInstAdminEmail(Email instAdminEmail) {
<span class="fc" id="L353">        this.instAdminEmail = instAdminEmail;</span>
<span class="fc" id="L354">    }</span>


    public Long getSpecialtyId() {
<span class="fc" id="L358">        return specialtyId;</span>
    }

    public void setSpecialtyId(Long specialtyId) {
<span class="fc" id="L362">        this.specialtyId = specialtyId;</span>
<span class="fc" id="L363">    }</span>


    public String getPatientIdSupport() {
<span class="fc" id="L367">        return patientIdSupport;</span>
    }

    public void setPatientIdSupport(String patientIdSupport) {
<span class="fc" id="L371">        this.patientIdSupport = patientIdSupport;</span>
<span class="fc" id="L372">    }</span>

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L375">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L376">    }</span>

    public String getTimeZoneId() {
<span class="fc" id="L379">        return timeZoneId;</span>
    }

    public void setTimeZoneId(String timeZoneId) {
<span class="fc" id="L383">        this.timeZoneId = timeZoneId;</span>
<span class="fc" id="L384">    }</span>

    public boolean isCancerTeam() {
<span class="fc" id="L387">        return cancerTeam;</span>
    }

    public void setCancerTeam(boolean cancerTeam) {
<span class="fc" id="L391">        this.cancerTeam = cancerTeam;</span>
<span class="fc" id="L392">    }</span>

    public boolean isMandatoryNationalId() {
<span class="fc" id="L395">        return mandatoryNationalId;</span>
    }

    public void setMandatoryNationalId(boolean mandatoryNationalId) {
<span class="fc" id="L399">        this.mandatoryNationalId = mandatoryNationalId;</span>
<span class="fc" id="L400">    }</span>

    public boolean isDefaultNewProsContactable() {
<span class="fc" id="L403">        return defaultNewProsContactable;</span>
    }

    public void setDefaultNewProsContactable(boolean defaultNewProsContactable) {
<span class="fc" id="L407">        this.defaultNewProsContactable = defaultNewProsContactable;</span>
<span class="fc" id="L408">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>