<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PersonalHealthPlanTemplateAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.admin.action</a> &gt; <span class="el_source">PersonalHealthPlanTemplateAction.java</span></div><h1>PersonalHealthPlanTemplateAction.java</h1><pre class="source lang-java linenums">package com.pkb.admin.action;

import com.fasterxml.jackson.databind.ObjectReader;
import com.google.common.annotations.VisibleForTesting;
import com.google.common.base.Predicates;
import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.bean.impl.MessageWebBean;
import com.pkb.datamodel.plantemplate.AutoSavePHPlanTemplate;
import com.pkb.datamodel.plantemplate.ImmutableAutoSavePHPlanTemplate;
import com.pkb.datamodel.plantemplate.ImmutableAutoSaveTemplateMetric;
import com.pkb.datamodel.plantemplate.ImmutableNewPHPlanTemplate;
import com.pkb.datamodel.plantemplate.ImmutableNewTemplateAttachment;
import com.pkb.datamodel.plantemplate.ImmutableNewTemplateField;
import com.pkb.datamodel.plantemplate.ImmutableNewTemplateMetric;
import com.pkb.datamodel.plantemplate.NewPHPlanTemplate;
import com.pkb.datamodel.plantemplate.NewTemplateAttachment;
import com.pkb.datamodel.plantemplate.NewTemplateField;
import com.pkb.datamodel.plantemplate.NewTemplateMetric;
import com.pkb.datamodel.plantemplate.PHPlanTemplate;
import com.pkb.datamodel.plantemplate.TemplateField;
import com.pkb.datamodel.plantemplate.TemplateMetric;
import com.pkb.entities.enums.MetricType;
import com.pkb.entities.enums.TemplateFieldLabel;
import com.pkb.entities.enums.TemplateStatus;
import com.pkb.institute.entity.Team;
import com.pkb.service.phplan.PHPlanDTO;
import com.pkb.service.phplan.PlanManager;
import com.pkb.service.phplan.PlanTemplateManager;
import com.pkb.service.team.TeamManager;
import com.pkb.service.test.LoincManager;
import com.pkb.service.test.TestManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.symptom.entity.Symptom;
import com.pkb.test.entity.LoincTest;
import com.pkb.test.entity.MeasurementType;
import com.pkb.test.entity.PredefinedMeasurementType;
import com.pkb.util.PKBConstants;
import com.pkb.util.StringUtil;
import com.pkb.util.security.CustomStyledHtmlFilter;
import io.vavr.control.Option;
import org.apache.commons.io.FileUtils;
import org.apache.commons.io.FilenameUtils;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.xml.sax.SAXException;

import javax.xml.parsers.ParserConfigurationException;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.lang.invoke.MethodHandles;
import java.sql.Date;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Collections;
import java.util.LinkedHashSet;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.SortedSet;
import java.util.Stack;
import java.util.TreeSet;
import java.util.UUID;
import java.util.function.Predicate;
import java.util.stream.Collectors;

import static com.pkb.entities.enums.MetricType.LAB_TEST;
import static com.pkb.entities.enums.MetricType.MEASUREMENT;
import static com.pkb.entities.enums.MetricType.SYMPTOM;
import static java.nio.charset.StandardCharsets.UTF_8;
import static java.util.Comparator.comparing;
import static java.util.stream.Collectors.toCollection;

@SuppressWarnings({&quot;StrutsI18nError&quot;, &quot;SSBasedInspection&quot;})
<span class="fc" id="L79">public class PersonalHealthPlanTemplateAction extends BaseAction {</span>

    private static final long serialVersionUID = -1;
<span class="fc" id="L82">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>
<span class="fc" id="L83">    private static final ObjectReader PLAN_READER = OBJECT_MAPPER.readerFor(AutoSavePHPlanTemplate.class);</span>

    private PlanTemplateManager planTemplateManager;
    private TeamManager teamManager;
    private MessageWebBean messageWebBean;
    private TestManager testManager;
    private PlanManager planManager;
    private CustomStyledHtmlFilter customStyledHtmlFilter;

    @Autowired
    private LoincManager loincManager;

    private String json;

    private String instituteCode;

    // List of all templates for managePersonalHealthPlanTemplates.jsp
    private Long instituteId;
    private List&lt;PHPlanDTO&gt; pHPlanTemplateSummaries;

    public List&lt;PHPlanDTO&gt; getPHPlanTemplateSummaries() {
<span class="fc" id="L104">        return pHPlanTemplateSummaries;</span>
    }

    public void setPHPlanTemplateSummaries(List&lt;PHPlanDTO&gt; pHPlanTemplateSummaries) {
<span class="nc" id="L108">        this.pHPlanTemplateSummaries = pHPlanTemplateSummaries;</span>
<span class="nc" id="L109">    }</span>

    // Local copy
    private PHPlanTemplate pHPlanTemplate;
    private NewPHPlanTemplate pHPlanTemplateToPersist;

    // Uploaded from viewCustomerDetails.jsp
    private Long pHPlanTemplateId;
    private Long actionPlanFieldId;
    private Long greenFieldId;
    private Long redFieldId;
    private Long amberFieldId;

    // To and from editPersonalHealthPlanTemplate.jsp
    private String planDescription;
    private Long reviewPeriodDays;
    private String actionPlan;
    private String greenText;
    private String amberText;
    private String redText;
    private List&lt;NewTemplateAttachment&gt; attachments;

    private Set&lt;String&gt; symptomTypeList; // out
    private List&lt;String&gt; symptomTypeName; //in

    private Set&lt;String&gt; measurementTypeList; // out
    private List&lt;String&gt; measurementTypeName; //in

    private List&lt;NewTemplateMetric&gt; testMetricList; // in &amp; out
    private List&lt;Boolean&gt; testMetricWanted; // in &amp; out

    // Attachments
    private File attachment;
    private String fileLabel;
    private String fileUploadErrorMessage;
    private String attachmentFileName;
    private String attachmentContentType;
    private String unwantedAttachment;
    private InputStream autoSaveResult;

    // Where to find unencrypted images
    private String imageDownloadDirName;

    public String getPlanTemplateList() {
<span class="fc" id="L153">        Team team = teamManager.getTeam(getLoggedInEHRRequestContext().getTeamId().orElse(null));</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if (team != null) {</span>
<span class="fc" id="L155">            instituteCode = team.getCode();</span>
<span class="fc" id="L156">            instituteId = team.getId();</span>
        }

<span class="fc" id="L159">        pHPlanTemplateSummaries = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L160">        List&lt;PHPlanTemplate&gt; templateList = planTemplateManager.getTemplateList(instituteId);</span>
<span class="fc" id="L161">        LOGGER.info(&quot;displaying {} templates&quot;, templateList.size());</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">        for (PHPlanTemplate planTemplate : templateList) {</span>
<span class="fc" id="L163">            PHPlanDTO planDTO = new PHPlanDTO();</span>
<span class="fc" id="L164">            planDTO.setId(planTemplate.getId());</span>
<span class="fc" id="L165">            planDTO.setName(planTemplate.getName());</span>
<span class="fc" id="L166">            planDTO.setStatus(planTemplate.getStatus());</span>
<span class="fc" id="L167">            planDTO.setCreationDate(Date.from(planTemplate.getCreationDate()));</span>
<span class="fc" id="L168">            pHPlanTemplateSummaries.add(planDTO);</span>
<span class="fc" id="L169">        }</span>

<span class="fc" id="L171">        return Action.SUCCESS;</span>
    }

    public boolean isTemplateListEmpty() {
<span class="pc bpc" id="L175" title="1 of 4 branches missed.">        return pHPlanTemplateSummaries == null || pHPlanTemplateSummaries.isEmpty();</span>
    }

    public String viewPlanTemplate() {
<span class="fc" id="L179">        retrieveTemplate(true);</span>
<span class="pc bpc" id="L180" title="2 of 4 branches missed.">        if ((actionPlan != null) &amp;&amp; !actionPlan.startsWith(&quot;&lt;div&quot;)) {</span>
<span class="fc" id="L181">            actionPlan = StringUtil.textToHtml(actionPlan);</span>
        }

<span class="pc bpc" id="L184" title="2 of 4 branches missed.">        if ((greenText != null) &amp;&amp; !greenText.startsWith(&quot;&lt;div&quot;)) {</span>
<span class="fc" id="L185">            greenText = StringUtil.textToHtml(greenText);</span>
        }

<span class="pc bpc" id="L188" title="2 of 4 branches missed.">        if ((amberText != null) &amp;&amp; !amberText.startsWith(&quot;&lt;div&quot;)) {</span>
<span class="fc" id="L189">            amberText = StringUtil.textToHtml(amberText);</span>
        }

<span class="pc bpc" id="L192" title="2 of 4 branches missed.">        if ((redText != null) &amp;&amp; !redText.startsWith(&quot;&lt;div&quot;)) {</span>
<span class="fc" id="L193">            redText = StringUtil.textToHtml(redText);</span>
        }
<span class="fc" id="L195">        return Action.SUCCESS;</span>
    }

    public String addForm() {
<span class="fc" id="L199">        pHPlanTemplateId = 0L;</span>
<span class="fc" id="L200">        planDescription = &quot;&quot;;</span>
<span class="fc" id="L201">        reviewPeriodDays = 365L;</span>

<span class="fc" id="L203">        actionPlan = &quot;&quot;;</span>
<span class="fc" id="L204">        setupMetrics();</span>
<span class="fc" id="L205">        greenText = &quot;&quot;;</span>
<span class="fc" id="L206">        amberText = &quot;&quot;;</span>
<span class="fc" id="L207">        redText = &quot;&quot;;</span>
<span class="fc" id="L208">        session.remove(PKBConstants.PHPLAN_TEMPLATE_ATTACHMENTS);</span>
<span class="fc" id="L209">        return Action.SUCCESS;</span>
    }

    private static SortedSet&lt;String&gt; displayNames(Predicate&lt;MeasurementType&gt; predicate) {
<span class="fc" id="L213">        return Collections.unmodifiableSortedSet(</span>
<span class="fc" id="L214">                Arrays.stream(PredefinedMeasurementType.values())</span>
<span class="fc" id="L215">                        .map(PredefinedMeasurementType::getType)</span>
<span class="fc" id="L216">                        .filter(predicate)</span>
<span class="fc" id="L217">                        .map(MeasurementType::displayName)</span>
<span class="fc" id="L218">                        .collect(Collectors.toCollection(TreeSet::new)));</span>
    }


<span class="fc" id="L222">    private static final SortedSet&lt;String&gt; DISPLAY_NAMES_OF_PREDEFINED_MEASUREMENT_TYPES_WITHOUT_PARENT_TYPE =</span>
<span class="fc" id="L223">            displayNames(pmt -&gt; pmt.parentType().isEmpty());</span>

<span class="fc" id="L225">    private static final SortedSet&lt;String&gt; DISPLAY_NAMES_OF_PREDEFINED_MEASUREMENT_TYPES =</span>
<span class="fc" id="L226">            displayNames(Predicates.alwaysTrue());</span>

    private void setupMetrics() {
<span class="fc" id="L229">        symptomTypeList = buildSortedSymptomTypeList();</span>

<span class="fc" id="L231">        measurementTypeList = DISPLAY_NAMES_OF_PREDEFINED_MEASUREMENT_TYPES_WITHOUT_PARENT_TYPE;</span>
<span class="fc" id="L232">        testMetricList = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L233" title="All 2 branches covered.">        for (LoincTest loincTest : loincManager.getAllLoincTests()) {</span>
<span class="fc" id="L234">            String unit = &quot;&quot;;</span>
<span class="fc bfc" id="L235" title="All 2 branches covered.">            if (StringUtils.isNotBlank(loincTest.getUnit())) {</span>
<span class="fc" id="L236">                unit = &quot; (&quot; + loincTest.getUnit() + &quot;)&quot;;</span>
            }
<span class="fc" id="L238">            NewTemplateMetric tm = ImmutableNewTemplateMetric.builder()</span>
<span class="fc" id="L239">                    .metricId(loincTest.getId())</span>
<span class="fc" id="L240">                    .metricType(LAB_TEST)</span>
<span class="fc" id="L241">                    .metricName(getText(loincTest.getNameKey()) + unit)</span>
<span class="fc" id="L242">                    .build();</span>
<span class="fc" id="L243">            testMetricList.add(tm);</span>
<span class="fc" id="L244">        }</span>

<span class="fc" id="L246">        testMetricList.sort((l, r) -&gt; l.getMetricName().compareToIgnoreCase(r.getMetricName()));</span>
<span class="fc" id="L247">    }</span>

    public String editForm() {
<span class="fc" id="L250">        retrieveTemplate(false);</span>
<span class="fc" id="L251">        attachment = null;</span>
<span class="fc" id="L252">        return Action.SUCCESS;</span>
    }

    public String duplicateForm() {
<span class="fc" id="L256">        retrieveTemplate(false);</span>
<span class="fc" id="L257">        planDescription = &quot;Copy of &quot; + planDescription;</span>
<span class="fc" id="L258">        pHPlanTemplateId = null;</span>

<span class="fc" id="L260">        return Action.SUCCESS;</span>
    }

    private void retrieveTemplate(boolean selectedLabTestsOnly) {

<span class="fc" id="L265">        pHPlanTemplate = planTemplateManager.getPHPlanTemplate(pHPlanTemplateId);</span>
<span class="fc" id="L266">        pHPlanTemplateId = pHPlanTemplate.getId();</span>
<span class="fc" id="L267">        planDescription = pHPlanTemplate.getName();</span>
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">        if (pHPlanTemplate.getReviewPeriodDays() == null) {</span>
<span class="nc" id="L269">            reviewPeriodDays = 365L;</span>
        } else {
<span class="fc" id="L271">            reviewPeriodDays = pHPlanTemplate.getReviewPeriodDays().orElse(null);</span>
        }
<span class="fc" id="L273">        instituteCode = teamManager.getTeam(pHPlanTemplate.getInstituteId()).getCode();</span>

<span class="fc bfc" id="L275" title="All 2 branches covered.">        for (TemplateField templateField : pHPlanTemplate.getFields()) {</span>
<span class="pc bpc" id="L276" title="1 of 5 branches missed.">            switch (templateField.getLabel()) {</span>
                case ACTION_PLAN:
<span class="fc" id="L278">                    actionPlan = templateField.getText();</span>
<span class="fc" id="L279">                    actionPlanFieldId = templateField.getId();</span>
<span class="fc" id="L280">                    break;</span>
                case GREEN:
<span class="fc" id="L282">                    greenText = templateField.getText();</span>
<span class="fc" id="L283">                    greenFieldId = templateField.getId();</span>
<span class="fc" id="L284">                    break;</span>
                case AMBER:
<span class="fc" id="L286">                    amberText = templateField.getText();</span>
<span class="fc" id="L287">                    amberFieldId = templateField.getId();</span>
<span class="fc" id="L288">                    break;</span>
                case RED:
<span class="fc" id="L290">                    redText = templateField.getText();</span>
<span class="fc" id="L291">                    redFieldId = templateField.getId();</span>
                    break;
            }
<span class="fc" id="L294">        }</span>

<span class="fc" id="L296">        imageDownloadDirName = getConfig().getPHPlanTemplateImageBaseDir();</span>

<span class="fc" id="L298">        attachments = new ArrayList&lt;&gt;(pHPlanTemplate.getAttachments().stream()</span>
<span class="fc" id="L299">                .map(attachemnt -&gt; ImmutableNewTemplateAttachment.builder()</span>
<span class="fc" id="L300">                        .checked(attachemnt.getChecked())</span>
<span class="fc" id="L301">                        .mediaType(attachemnt.getMediaType())</span>
<span class="fc" id="L302">                        .label(attachemnt.getLabel())</span>
<span class="fc" id="L303">                        .name(attachemnt.getName())</span>
<span class="fc" id="L304">                        .build()).collect(Collectors.toList()));</span>

<span class="fc" id="L306">        symptomTypeList = buildSortedSymptomTypeList();</span>

<span class="fc" id="L308">        symptomTypeName = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L309" title="All 2 branches covered.">        symptomTypeName.addAll(pHPlanTemplate.getMetrics().stream().filter(metric -&gt; metric.getMetricType() == SYMPTOM)</span>
<span class="fc" id="L310">                .map(TemplateMetric::getMetricName).collect(Collectors.toList()));</span>

<span class="fc" id="L312">        measurementTypeList = DISPLAY_NAMES_OF_PREDEFINED_MEASUREMENT_TYPES;</span>
<span class="fc" id="L313">        measurementTypeName = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L314">        measurementTypeName</span>
<span class="fc bfc" id="L315" title="All 2 branches covered.">                .addAll(pHPlanTemplate.getMetrics().stream().filter(metric -&gt; metric.getMetricType() == MEASUREMENT)</span>
<span class="fc" id="L316">                        .map(TemplateMetric::getMetricName).collect(Collectors.toList()));</span>

<span class="fc" id="L318">        testMetricList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L319">        testMetricWanted = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L321" title="All 2 branches covered.">        if (selectedLabTestsOnly) {</span>
<span class="fc" id="L322">            pHPlanTemplate</span>
<span class="fc" id="L323">                    .getMetrics()</span>
<span class="fc" id="L324">                    .stream()</span>
<span class="fc bfc" id="L325" title="All 2 branches covered.">                    .filter(tm -&gt; tm.getMetricType() == LAB_TEST).forEach(tm -&gt; {</span>
<span class="fc" id="L326">                        testMetricList.add(ImmutableNewTemplateMetric.builder()</span>
<span class="fc" id="L327">                                .metricName(tm.getMetricName())</span>
<span class="fc" id="L328">                                .metricType(tm.getMetricType())</span>
<span class="fc" id="L329">                                .metricId(tm.getMetricId())</span>
<span class="fc" id="L330">                                .build());</span>
<span class="fc" id="L331">                        testMetricWanted.add(true);</span>
<span class="fc" id="L332">                    });</span>

<span class="fc" id="L334">            testMetricList.sort((l, r) -&gt; l.getMetricName().compareToIgnoreCase(r.getMetricName()));</span>
        } else {
<span class="fc bfc" id="L336" title="All 2 branches covered.">            for (LoincTest loincTest : loincManager.getAllLoincTests()) {</span>
<span class="fc" id="L337">                String unit = &quot;&quot;;</span>
<span class="fc bfc" id="L338" title="All 2 branches covered.">                if (StringUtils.isNotBlank(loincTest.getUnit())) {</span>
<span class="fc" id="L339">                    unit = &quot; (&quot; + loincTest.getUnit() + &quot;)&quot;;</span>
                }
<span class="fc" id="L341">                NewTemplateMetric tm = ImmutableNewTemplateMetric.builder()</span>
<span class="fc" id="L342">                        .metricId(loincTest.getId())</span>
<span class="fc" id="L343">                        .metricType(LAB_TEST)</span>
<span class="fc" id="L344">                        .metricName(getText(loincTest.getNameKey()) + unit)</span>
<span class="fc" id="L345">                        .build();</span>
<span class="fc" id="L346">                testMetricList.add(tm);</span>
<span class="fc" id="L347">            }</span>

<span class="fc" id="L349">            testMetricList.sort((l, r) -&gt; l.getMetricName().compareToIgnoreCase(r.getMetricName()));</span>

<span class="fc bfc" id="L351" title="All 2 branches covered.">            for (NewTemplateMetric tm : testMetricList) {</span>
<span class="fc" id="L352">                boolean wanted = false;</span>
<span class="fc bfc" id="L353" title="All 2 branches covered.">                for (TemplateMetric selected : pHPlanTemplate.getMetrics()) {</span>
<span class="fc bfc" id="L354" title="All 4 branches covered.">                    if ((selected.getMetricType() == MetricType.LAB_TEST) &amp;&amp; (tm.getMetricId() == selected.getMetricId())) {</span>
<span class="fc" id="L355">                        wanted = true;</span>
<span class="fc" id="L356">                        break;</span>
                    }
<span class="fc" id="L358">                }</span>
<span class="fc" id="L359">                testMetricWanted.add(wanted);</span>
<span class="fc" id="L360">            }</span>
        }

<span class="fc" id="L363">        session.put(PKBConstants.PHPLAN_TEMPLATE_ATTACHMENTS, attachments);</span>
<span class="fc" id="L364">    }</span>

    private Set&lt;String&gt; buildSortedSymptomTypeList() {
<span class="fc" id="L367">        return Arrays.stream(Symptom.values())</span>
<span class="fc" id="L368">                .map(Symptom::getName)</span>
<span class="fc" id="L369">                .sorted(comparing(this::getText))</span>
<span class="fc" id="L370">                .collect(toCollection(LinkedHashSet::new));</span>
    }

    public String delete() {
<span class="nc" id="L374">        return &quot;confirmDelete&quot;;</span>
    }

    public String confirmedDelete() {
<span class="nc bnc" id="L378" title="All 2 branches missed.">        if (pHPlanTemplateId != null) {</span>
<span class="nc" id="L379">            planTemplateManager.deleteTemplate(pHPlanTemplateId);</span>
        }
<span class="nc" id="L381">        return Action.SUCCESS;</span>
    }

    public String cancelDelete() {
<span class="nc" id="L385">        return Action.SUCCESS;</span>
    }

    public String autoSavePlanTemplate() {
<span class="fc" id="L389">        LOGGER.info(&quot;autoSavePlanTemplate:start&quot;);</span>

        try {
<span class="fc" id="L392">            AutoSavePHPlanTemplate template = PLAN_READER.readValue(json);</span>

<span class="fc" id="L394">            template = ImmutableAutoSavePHPlanTemplate</span>
<span class="fc" id="L395">                    .copyOf(template)</span>
<span class="fc" id="L396">                    .withMetrics(template</span>
<span class="fc" id="L397">                            .getMetrics()</span>
<span class="fc" id="L398">                            .stream()</span>
<span class="fc" id="L399">                            .map(metric -&gt; {</span>
<span class="fc bfc" id="L400" title="All 2 branches covered.">                                if (metric.getMetricType().equals(MEASUREMENT.toString())) {</span>
<span class="fc" id="L401">                                    return ImmutableAutoSaveTemplateMetric</span>
<span class="fc" id="L402">                                            .copyOf(metric)</span>
<span class="fc" id="L403">                                            .withMetricId(PredefinedMeasurementType.getByParentName(metric.getMetricName()).id().asInternalId().get());</span>
<span class="fc bfc" id="L404" title="All 2 branches covered.">                                } else if (metric.getMetricType().equals(SYMPTOM.toString())) {</span>
<span class="fc" id="L405">                                    return ImmutableAutoSaveTemplateMetric</span>
<span class="fc" id="L406">                                            .copyOf(metric)</span>
<span class="fc" id="L407">                                            .withMetricId(Symptom.getByName(metric.getMetricName()).getId());</span>
                                } else {
<span class="fc" id="L409">                                    return metric;</span>
                                }
                            })
<span class="fc" id="L412">                            .collect(Collectors.toList()));</span>

<span class="fc" id="L414">            pHPlanTemplateId = planTemplateManager.autoSaveTemplate(template, loggedInUserUtil.getLoggedInUserId());</span>

<span class="fc" id="L416">            byte[] resultArray = (&quot;&quot; + pHPlanTemplateId).getBytes(UTF_8);</span>
<span class="fc" id="L417">            autoSaveResult = new ByteArrayInputStream(resultArray);</span>
<span class="nc" id="L418">        } catch (Exception e) {</span>
<span class="nc" id="L419">            LOGGER.error(&quot;problem with JSON autosave for {}&quot;, loggedInUserUtil.getLoggedInUserId(), e);</span>
<span class="nc" id="L420">            autoSaveResult = new ByteArrayInputStream(Action.ERROR.getBytes(UTF_8));</span>
<span class="fc" id="L421">        }</span>
<span class="fc" id="L422">        LOGGER.info(&quot;autoSavePlanTemplate:end&quot;);</span>
<span class="fc" id="L423">        return Action.SUCCESS;</span>
    }

    public String save() throws IOException, ParserConfigurationException, SAXException {

<span class="pc bpc" id="L428" title="1 of 2 branches missed.">        if (readTemplate()) {</span>
<span class="fc bfc" id="L429" title="All 4 branches covered.">            if ((pHPlanTemplateId != null) &amp;&amp; (pHPlanTemplateId &gt; 0)) {</span>
<span class="fc" id="L430">                planTemplateManager.deleteTemplate(pHPlanTemplateId);</span>
<span class="fc" id="L431">                pHPlanTemplateId = null;</span>
            }

<span class="fc bfc" id="L434" title="All 2 branches covered.">            List&lt;NewTemplateAttachment&gt; attachmentsToPersist = (attachments != null) ? attachments : Collections.emptyList();</span>

<span class="fc" id="L436">            NewPHPlanTemplate templateToPersist = ImmutableNewPHPlanTemplate.copyOf(pHPlanTemplateToPersist).withAttachments(attachmentsToPersist);</span>
<span class="fc" id="L437">            pHPlanTemplateId = planTemplateManager.saveTemplate(templateToPersist);</span>
<span class="fc" id="L438">            session.remove(PKBConstants.PHPLAN_TEMPLATE_ATTACHMENTS);</span>

<span class="fc" id="L440">            attachments = null;</span>
<span class="fc" id="L441">            return Action.SUCCESS;</span>
        } else {
<span class="nc" id="L443">            return RELOAD;</span>
        }
    }

    public String complete() throws IOException, ParserConfigurationException, SAXException {
<span class="pc bpc" id="L448" title="1 of 4 branches missed.">        if ((actionPlan.startsWith(&quot;&lt;div&quot;) &amp;&amp; !validateHtml(actionPlan, &quot;actionPlan&quot;)) ||</span>
<span class="pc bpc" id="L449" title="3 of 4 branches missed.">                (greenText.startsWith(&quot;&lt;div&quot;) &amp;&amp; !validateHtml(greenText, &quot;greenText&quot;)) ||</span>
<span class="pc bpc" id="L450" title="3 of 4 branches missed.">                (amberText.startsWith(&quot;&lt;div&quot;) &amp;&amp; !validateHtml(amberText, &quot;amberText&quot;)) ||</span>
<span class="pc bpc" id="L451" title="3 of 4 branches missed.">                (redText.startsWith(&quot;&lt;div&quot;) &amp;&amp; !validateHtml(redText, &quot;redText&quot;))) {</span>
<span class="nc" id="L452">            addAttachment();</span>
<span class="nc" id="L453">            return RELOAD;</span>
        }
<span class="pc bpc" id="L455" title="1 of 2 branches missed.">        if (readTemplate()) {</span>
<span class="pc bpc" id="L456" title="1 of 4 branches missed.">            if ((pHPlanTemplateId != null) &amp;&amp; (pHPlanTemplateId &gt; 0)) {</span>
<span class="fc" id="L457">                planTemplateManager.deleteTemplate(pHPlanTemplateId);</span>
<span class="fc" id="L458">                pHPlanTemplateId = null;</span>
            }
<span class="fc bfc" id="L460" title="All 2 branches covered.">            if (attachments != null) {</span>
<span class="fc" id="L461">                pHPlanTemplateToPersist = ImmutableNewPHPlanTemplate.copyOf(pHPlanTemplateToPersist).withAttachments(attachments);</span>
            }
<span class="fc" id="L463">            pHPlanTemplateId = planTemplateManager.completeTemplate(pHPlanTemplateToPersist);</span>
<span class="fc" id="L464">            session.remove(PKBConstants.PHPLAN_TEMPLATE_ATTACHMENTS);</span>

<span class="fc" id="L466">            attachments = null;</span>
<span class="fc" id="L467">            return Action.SUCCESS;</span>
        } else {
<span class="nc" id="L469">            return RELOAD;</span>
        }
    }

    public String validateHtml() throws ParserConfigurationException, SAXException, IOException {
<span class="pc bpc" id="L474" title="2 of 4 branches missed.">        if ((!actionPlan.startsWith(&quot;&lt;div&quot;) || validateHtml(actionPlan, &quot;actionPlan&quot;)) &amp;&amp;</span>
<span class="nc bnc" id="L475" title="All 4 branches missed.">                (!greenText.startsWith(&quot;&lt;div&quot;) || validateHtml(greenText, &quot;greenText&quot;)) &amp;&amp;</span>
<span class="nc bnc" id="L476" title="All 4 branches missed.">                (!amberText.startsWith(&quot;&lt;div&quot;) || validateHtml(amberText, &quot;amberText&quot;)) &amp;&amp;</span>
<span class="nc bnc" id="L477" title="All 4 branches missed.">                (!redText.startsWith(&quot;&lt;div&quot;) || !validateHtml(redText, &quot;redText&quot;))) {</span>
<span class="nc" id="L478">            addActionMessage(&quot;Html validated&quot;);</span>
        }
<span class="fc" id="L480">        setupMetrics(); // Struts bug - upload is broken for Sets</span>
<span class="fc" id="L481">        return &quot;validationCompleted&quot;;</span>
    }

    public String addAttachment() throws IOException {

<span class="fc" id="L486">        attachments = (List&lt;NewTemplateAttachment&gt;) session.get(PKBConstants.PHPLAN_TEMPLATE_ATTACHMENTS);</span>
<span class="fc" id="L487">        addNewAttachment();</span>
<span class="fc" id="L488">        return RELOAD;</span>
    }

    private boolean readTemplate() throws IOException {

<span class="fc" id="L493">        Team team = teamManager.getTeam(getLoggedInEHRRequestContext().getTeamId().orElse(null));</span>
<span class="pc bpc" id="L494" title="3 of 4 branches missed.">        if (instituteCode == null &amp;&amp; team != null) {</span>
<span class="nc" id="L495">            instituteCode = team.getCode();</span>
        } else {
<span class="fc" id="L497">            team = teamManager.getTeamByCode(instituteCode);</span>
        }

<span class="fc" id="L500">        ImmutableNewPHPlanTemplate.Builder templateBuilder = ImmutableNewPHPlanTemplate.builder();</span>
<span class="fc" id="L501">        templateBuilder.name(planDescription);</span>
<span class="fc" id="L502">        templateBuilder.reviewPeriodDays(Optional.of(reviewPeriodDays));</span>
<span class="fc" id="L503">        templateBuilder.creatorId(Optional.of(loggedInUserUtil.getLoggedInUserId()));</span>
<span class="fc" id="L504">        templateBuilder.creationDate(dateTimeService.now());</span>
<span class="pc bpc" id="L505" title="1 of 2 branches missed.">        if (team != null) {</span>
<span class="fc" id="L506">            templateBuilder.instituteId(team.getId());</span>
<span class="fc" id="L507">            templateBuilder.requireMentalHealth(team.getRequireMentalHealth());</span>
<span class="fc" id="L508">            templateBuilder.requireSexualHealth(team.getRequireSexualHealth());</span>
<span class="fc" id="L509">            templateBuilder.requireSocialCare(team.getRequireSocialCare());</span>
<span class="fc" id="L510">            templateBuilder.requireGeneral(team.getRequireGeneral());</span>
        }
<span class="fc" id="L512">        templateBuilder.status(TemplateStatus.INDRAFT);</span>

<span class="fc" id="L514">        List&lt;NewTemplateField&gt; fieldList = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L516" title="All 2 branches covered.">        if (!StringUtils.isEmpty(actionPlan)) {</span>
<span class="fc" id="L517">            fieldList.add(populateTemplateField(0, TemplateFieldLabel.ACTION_PLAN, actionPlan));</span>
        }
<span class="fc bfc" id="L519" title="All 2 branches covered.">        if (!StringUtils.isEmpty(greenText)) {</span>
<span class="fc" id="L520">            fieldList.add(populateTemplateField(1, TemplateFieldLabel.GREEN, greenText));</span>
        }
<span class="fc bfc" id="L522" title="All 2 branches covered.">        if (!StringUtils.isEmpty(amberText)) {</span>
<span class="fc" id="L523">            fieldList.add(populateTemplateField(2, TemplateFieldLabel.AMBER, amberText));</span>
        }
<span class="fc bfc" id="L525" title="All 2 branches covered.">        if (!StringUtils.isEmpty(redText)) {</span>
<span class="fc" id="L526">            fieldList.add(populateTemplateField(3, TemplateFieldLabel.RED, redText));</span>
        }

<span class="fc" id="L529">        templateBuilder.fields(fieldList);</span>
<span class="fc" id="L530">        attachments = (List&lt;NewTemplateAttachment&gt;) session.get(PKBConstants.PHPLAN_TEMPLATE_ATTACHMENTS);</span>

<span class="fc" id="L532">        List&lt;NewTemplateMetric&gt; immutableTemplateMetrics = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L533" title="All 2 branches covered.">        if (symptomTypeName != null) {</span>
<span class="fc" id="L534">            io.vavr.collection.Stream.ofAll(symptomTypeName)</span>
<span class="fc" id="L535">                    .flatMap(name -&gt; Option.of(Symptom.getByName(name)))</span>
<span class="fc" id="L536">                    .forEach(symptom -&gt;</span>
<span class="fc" id="L537">                            immutableTemplateMetrics.add(ImmutableNewTemplateMetric.builder()</span>
<span class="fc" id="L538">                                    .metricType(SYMPTOM)</span>
<span class="fc" id="L539">                                    .metricName(symptom.getName())</span>
<span class="fc" id="L540">                                    .metricId(symptom.getId())</span>
<span class="fc" id="L541">                                    .build()));</span>
        }

<span class="fc bfc" id="L544" title="All 2 branches covered.">        if (measurementTypeName != null) {</span>
<span class="fc" id="L545">            io.vavr.collection.Stream.ofAll(measurementTypeName)</span>
<span class="fc" id="L546">                    .flatMap(name -&gt; Option.of(PredefinedMeasurementType.getByParentName(name)))</span>
<span class="fc" id="L547">                    .forEach(predefinedMeasurementType -&gt;</span>
<span class="fc" id="L548">                            immutableTemplateMetrics.add(ImmutableNewTemplateMetric.builder()</span>
<span class="fc" id="L549">                                    .metricType(MEASUREMENT)</span>
<span class="fc" id="L550">                                    .metricName(predefinedMeasurementType.getType().displayName())</span>
<span class="fc" id="L551">                                    .metricId(predefinedMeasurementType.id().asInternalId().get())</span>
<span class="fc" id="L552">                                    .build()));</span>
        }

<span class="fc" id="L555">        setupMetrics();</span>

<span class="fc bfc" id="L557" title="All 2 branches covered.">        for (int i = 0; i &lt; testMetricWanted.size(); ++i) {</span>
<span class="fc bfc" id="L558" title="All 2 branches covered.">            if (testMetricWanted.get(i)) {</span>
<span class="fc" id="L559">                NewTemplateMetric metric = testMetricList.get(i);</span>
<span class="fc" id="L560">                immutableTemplateMetrics.add(ImmutableNewTemplateMetric.builder()</span>
<span class="fc" id="L561">                        .metricType(LAB_TEST)</span>
<span class="fc" id="L562">                        .metricName(metric.getMetricName())</span>
<span class="fc" id="L563">                        .metricId(metric.getMetricId())</span>
<span class="fc" id="L564">                        .build());</span>
            }
        }

<span class="fc" id="L568">        templateBuilder.metrics(immutableTemplateMetrics);</span>
<span class="fc" id="L569">        pHPlanTemplateToPersist = templateBuilder.build();</span>

<span class="fc" id="L571">        return addNewAttachment();</span>
    }

<span class="fc" id="L574">    enum State {</span>
<span class="fc" id="L575">        SCANNING, START_TAG, READING_OPEN, SCANNING_OPEN, IN_SINGLE_QUOTE, IN_DOUBLE_QUOTE, READING_CLOSE</span>
    }

    @VisibleForTesting
    boolean validateHtml(String html, String fieldName) {
<span class="fc" id="L580">        Stack&lt;String&gt; tags = new Stack&lt;&gt;();</span>
<span class="fc" id="L581">        Stack&lt;Integer&gt; positions = new Stack&lt;&gt;();</span>

<span class="fc" id="L583">        State state = State.SCANNING;</span>
<span class="fc" id="L584">        int lineNum = 0;</span>
<span class="fc" id="L585">        StringBuilder tagName = new StringBuilder();</span>
<span class="fc bfc" id="L586" title="All 2 branches covered.">        for (int i = 0; i &lt; html.length(); ++i) {</span>
<span class="fc" id="L587">            char c = html.charAt(i);</span>
<span class="pc bpc" id="L588" title="1 of 2 branches missed.">            if (c &gt; 0x7F) {</span>
<span class="nc" id="L589">                addFieldError(fieldName, &quot;Invalid html at line &lt;input type='button' value='&quot; + lineNum + &quot;' onclick='selectLine(&quot; + lineNum</span>
                        + &quot;,\&quot;&quot; + fieldName + &quot;\&quot;);'/&gt;&quot; + lineNum + &quot;: &quot; +
                        &quot; non-ascii character '&quot; + c + &quot;' code &quot; + ((int) c));
<span class="nc" id="L592">                return false;</span>
            }
<span class="fc bfc" id="L594" title="All 2 branches covered.">            if (c == '\n') {</span>
<span class="fc" id="L595">                ++lineNum;</span>
            }
<span class="pc bpc" id="L597" title="2 of 8 branches missed.">            switch (state) {</span>
                case SCANNING:
<span class="fc bfc" id="L599" title="All 2 branches covered.">                    if (c == '&lt;') {</span>
<span class="fc" id="L600">                        state = State.START_TAG;</span>
                    }
                    break;

                case START_TAG:
<span class="fc" id="L605">                    tagName.setLength(0);</span>
<span class="fc bfc" id="L606" title="All 2 branches covered.">                    if (c == '/') {</span>
<span class="fc" id="L607">                        state = State.READING_CLOSE;</span>
                    } else {
<span class="fc" id="L609">                        tagName.append(c);</span>
<span class="fc" id="L610">                        state = State.READING_OPEN;</span>
                    }
<span class="fc" id="L612">                    break;</span>

                case READING_OPEN:
<span class="fc bfc" id="L615" title="All 2 branches covered.">                    if (c == '/') {</span>
<span class="fc" id="L616">                        state = State.SCANNING;</span>
<span class="fc bfc" id="L617" title="All 2 branches covered.">                    } else if (c == ' ') {</span>
<span class="fc" id="L618">                        state = State.SCANNING_OPEN;</span>
<span class="fc bfc" id="L619" title="All 2 branches covered.">                    } else if (c == '&gt;') {</span>
<span class="fc" id="L620">                        tags.push(tagName.toString());</span>
<span class="fc" id="L621">                        positions.push(lineNum);</span>
<span class="fc" id="L622">                        state = State.SCANNING;</span>
                    } else {
<span class="fc" id="L624">                        tagName.append(c);</span>
                    }
<span class="fc" id="L626">                    break;</span>

                case SCANNING_OPEN:
<span class="fc bfc" id="L629" title="All 2 branches covered.">                    if (c == '/') {</span>
<span class="fc" id="L630">                        state = State.SCANNING;</span>
<span class="pc bpc" id="L631" title="1 of 2 branches missed.">                    } else if (c == '\'') {</span>
<span class="nc" id="L632">                        state = State.IN_SINGLE_QUOTE;</span>
<span class="fc bfc" id="L633" title="All 2 branches covered.">                    } else if (c == '&quot;') {</span>
<span class="fc" id="L634">                        state = State.IN_DOUBLE_QUOTE;</span>
<span class="fc bfc" id="L635" title="All 2 branches covered.">                    } else if (c == '&gt;') {</span>
<span class="fc" id="L636">                        tags.push(tagName.toString());</span>
<span class="fc" id="L637">                        positions.push(lineNum);</span>
<span class="fc" id="L638">                        state = State.SCANNING;</span>
                    }
                    break;

                case IN_SINGLE_QUOTE:
<span class="nc bnc" id="L643" title="All 2 branches missed.">                    if (c == '\'') {</span>
<span class="nc" id="L644">                        state = State.SCANNING_OPEN;</span>
                    }
                    break;

                case IN_DOUBLE_QUOTE:
<span class="fc bfc" id="L649" title="All 2 branches covered.">                    if (c == '&quot;') {</span>
<span class="fc" id="L650">                        state = State.SCANNING_OPEN;</span>
                    }
                    break;

                case READING_CLOSE:
<span class="pc bpc" id="L655" title="1 of 4 branches missed.">                    if ((c == ' ') || (c == '&gt;')) {</span>
<span class="pc bpc" id="L656" title="1 of 2 branches missed.">                        if (tags.isEmpty()) {</span>
<span class="nc" id="L657">                            addFieldError(fieldName, &quot;Invalid html at line &lt;input type='button' value='&quot; + lineNum + &quot;' onclick='selectLine(&quot;</span>
                                    + lineNum + &quot;,\&quot;&quot; + fieldName + &quot;\&quot;)'/&gt;&quot; + lineNum + &quot;: &quot; +
<span class="nc" id="L659">                                    &quot;&amp;lt;/&quot; + tagName.toString() + &quot;&amp;gt; does not match any opening tag&quot;);</span>
<span class="nc" id="L660">                            return false;</span>

                        }
<span class="fc bfc" id="L663" title="All 2 branches covered.">                        if (tags.peek().equals(tagName.toString())) {</span>
<span class="fc" id="L664">                            tags.pop();</span>
<span class="fc" id="L665">                            positions.pop();</span>
<span class="fc" id="L666">                            state = State.SCANNING;</span>
                        } else {
<span class="fc" id="L668">                            addFieldError(fieldName, &quot;Invalid html at line &lt;input type='button' value='&quot; + lineNum + &quot;' onclick='selectLine(&quot;</span>
                                    + lineNum + &quot;,\&quot;&quot; + fieldName + &quot;\&quot;)'/&gt;&quot; + lineNum + &quot;: &quot; +
<span class="fc" id="L670">                                    &quot;&amp;lt;/&quot; + tagName.toString() + &quot;&amp;gt; does not match &amp;lt;&quot; + tags.pop()</span>
<span class="fc" id="L671">                                    + &quot;&amp;gt; at line &lt;input type='button' value='&quot; + positions.peek() + &quot;' onclick='selectLine(&quot;</span>
<span class="fc" id="L672">                                    + positions.peek() + &quot;,\&quot;&quot; + fieldName + &quot;\&quot;)'/&gt;&quot; + positions.pop());</span>
<span class="fc" id="L673">                            return false;</span>
                        }
                    } else {
<span class="fc" id="L676">                        tagName.append(c);</span>
                    }
                    break;
            }
        }

<span class="pc bpc" id="L682" title="1 of 2 branches missed.">        if (!tags.isEmpty()) {</span>
<span class="nc" id="L683">            addFieldError(fieldName,</span>
<span class="nc" id="L684">                    &quot;Invalid html at end of input: tag &amp;lt;&quot; + tags.pop() + &quot;&amp;gt at line &lt;input type='button' onclick='selectLine(&quot;</span>
<span class="nc" id="L685">                            + positions.peek() + &quot;,\&quot;&quot; + fieldName + &quot;\&quot;)'/&gt;&quot; + positions.pop() + &quot; is still unmatched&quot;);</span>
<span class="nc" id="L686">            return false;</span>
        }

        // Hack - validating without context or dtd catches some things that we miss
        try {
<span class="fc" id="L691">            planManager.validateXml(html);</span>
<span class="nc" id="L692">        } catch (Exception e) {</span>
<span class="nc" id="L693">            addFieldError(fieldName, e.getMessage());</span>
<span class="nc" id="L694">            return false;</span>
<span class="fc" id="L695">        }</span>

        try {
<span class="fc" id="L698">            List&lt;String&gt; fieldErrors = planManager.validateXhtml(html, fieldName, true);</span>
<span class="fc" id="L699">            fieldErrors.addAll(customStyledHtmlFilter.doFilter(html)._2);</span>
<span class="fc bfc" id="L700" title="All 2 branches covered.">            for (String err : fieldErrors) {</span>
<span class="fc" id="L701">                addFieldError(fieldName, err);</span>
<span class="fc" id="L702">            }</span>
<span class="nc" id="L703">        } catch (Exception e) {</span>
<span class="nc" id="L704">            addFieldError(fieldName, e.getMessage());</span>
<span class="nc" id="L705">            return false;</span>
<span class="fc" id="L706">        }</span>

<span class="fc" id="L708">        return getFieldErrors().isEmpty();</span>
    }

    private NewTemplateField populateTemplateField(int sequence, TemplateFieldLabel label, String text) {
<span class="fc" id="L712">        return ImmutableNewTemplateField.builder()</span>
<span class="fc" id="L713">                .label(label)</span>
<span class="fc" id="L714">                .text(text)</span>
<span class="fc" id="L715">                .sequence(sequence)</span>
<span class="fc" id="L716">                .build();</span>
    }

    public String cancel() {
<span class="nc" id="L720">        return Action.SUCCESS;</span>
    }

    private boolean addNewAttachment() throws IOException {

<span class="fc bfc" id="L725" title="All 2 branches covered.">        if (attachment != null) {</span>
<span class="pc bpc" id="L726" title="1 of 2 branches missed.">            if (attachment.length() &lt;= 0) {</span>
<span class="nc" id="L727">                setFileUploadErrorMessage(getText(&quot;struts.messages.error.file.empty&quot;));</span>
<span class="nc" id="L728">                return false;</span>
            }

<span class="fc" id="L731">            byte[] content = getContents(attachment);</span>

<span class="pc bpc" id="L733" title="1 of 2 branches missed.">            if (content.length &gt; PKBConstants.MAX_ATTACHMENT_SIZE) {</span>
<span class="nc" id="L734">                setFileUploadErrorMessage(getText(&quot;struts.messages.error.file.too.large&quot;));</span>
<span class="nc" id="L735">                return false;</span>
            }

<span class="fc bfc" id="L738" title="All 2 branches covered.">            if (attachments != null) {</span>
<span class="fc bfc" id="L739" title="All 2 branches covered.">                for (NewTemplateAttachment ta : attachments) {</span>
<span class="pc bpc" id="L740" title="1 of 2 branches missed.">                    if (fileLabel.equals(ta.getLabel())) {</span>
<span class="nc" id="L741">                        setFileUploadErrorMessage(getText(&quot;phplan.label.in.use&quot;));</span>
<span class="nc" id="L742">                        return false;</span>
                    }
<span class="fc" id="L744">                }</span>
            }

<span class="pc bpc" id="L747" title="2 of 4 branches missed.">            if ((fileLabel == null) || fileLabel.isEmpty()) {</span>
                // label default to file name
<span class="fc" id="L749">                String fileName = FilenameUtils.getName(attachmentFileName);</span>
<span class="fc" id="L750">                fileLabel = FilenameUtils.removeExtension(fileName);</span>
            }

<span class="fc" id="L753">            String imageName = instituteCode + &quot;/&quot; + UUID.randomUUID().toString() + &quot;.&quot; + getExtension(attachmentFileName);</span>
<span class="fc" id="L754">            String filePath = FilenameUtils.concat(getConfig().getImageUploadPHPlanTemplateImageBaseDirectory(), imageName);</span>
<span class="fc" id="L755">            File imageFile = new File(filePath);</span>
<span class="fc" id="L756">            imageFile.delete();</span>
<span class="fc" id="L757">            FileUtils.copyFile(attachment, imageFile);</span>

<span class="fc" id="L759">            NewTemplateAttachment templateAttachment = ImmutableNewTemplateAttachment.builder()</span>
<span class="fc" id="L760">                    .name(imageName)</span>
<span class="fc" id="L761">                    .label(fileLabel)</span>
<span class="fc" id="L762">                    .mediaType(attachmentContentType)</span>
<span class="fc" id="L763">                    .checked(false)</span>
<span class="fc" id="L764">                    .build();</span>

<span class="fc bfc" id="L766" title="All 2 branches covered.">            if (attachments == null) {</span>
<span class="fc" id="L767">                attachments = new ArrayList&lt;&gt;();</span>
            }
<span class="fc" id="L769">            attachments.add(templateAttachment);</span>
<span class="fc" id="L770">            setupMetrics();</span>

<span class="fc" id="L772">            session.put(PKBConstants.PHPLAN_TEMPLATE_ATTACHMENTS, attachments);</span>
<span class="fc" id="L773">            attachment = null;</span>
<span class="fc" id="L774">            fileLabel = null;</span>
        }

<span class="fc" id="L777">        return true;</span>
    }

    private static String getExtension(String name) {
<span class="fc" id="L781">        int pos = name.lastIndexOf('.');</span>
<span class="pc bpc" id="L782" title="1 of 2 branches missed.">        if (pos &lt; 0) {</span>
<span class="nc" id="L783">            return &quot;&quot;;</span>
        } else {
<span class="fc" id="L785">            return name.substring(pos + 1, name.length());</span>
        }
    }

    public String removeAttachment() {
<span class="nc" id="L790">        attachments = (List&lt;NewTemplateAttachment&gt;) session.get(PKBConstants.PHPLAN_TEMPLATE_ATTACHMENTS);</span>
<span class="nc bnc" id="L791" title="All 2 branches missed.">        if (attachments != null) {</span>
<span class="nc bnc" id="L792" title="All 2 branches missed.">            for (NewTemplateAttachment tatt : attachments) {</span>
<span class="nc bnc" id="L793" title="All 2 branches missed.">                if (tatt.getLabel().equals(unwantedAttachment)) {</span>
<span class="nc" id="L794">                    attachments.remove(tatt);</span>
<span class="nc" id="L795">                    session.put(PKBConstants.PHPLAN_TEMPLATE_ATTACHMENTS, attachments);</span>
<span class="nc" id="L796">                    break;</span>
                }
<span class="nc" id="L798">            }</span>
        }
<span class="nc" id="L800">        setupMetrics();</span>
<span class="nc" id="L801">        return RELOAD;</span>
    }

    public String getInstituteCode() {
<span class="fc" id="L805">        return instituteCode;</span>
    }

    public void setInstituteCode(String instituteCode) {
<span class="fc" id="L809">        this.instituteCode = instituteCode;</span>
<span class="fc" id="L810">    }</span>

    public PlanTemplateManager getPlanTemplateManager() {
<span class="nc" id="L813">        return planTemplateManager;</span>
    }

    public void setPlanTemplateManager(PlanTemplateManager planTemplateManager) {
<span class="fc" id="L817">        this.planTemplateManager = planTemplateManager;</span>
<span class="fc" id="L818">    }</span>

    public String getPlanDescription() {
<span class="fc" id="L821">        return planDescription;</span>
    }

    public MessageWebBean getMessageWebBean() {
<span class="nc" id="L825">        return messageWebBean;</span>
    }

    public String getImageDownloadDirName() {
<span class="nc" id="L829">        return imageDownloadDirName;</span>
    }

    public void setMessageWebBean(MessageWebBean messageWebBean) {
<span class="fc" id="L833">        this.messageWebBean = messageWebBean;</span>
<span class="fc" id="L834">    }</span>

    public List&lt;NewTemplateAttachment&gt; getAttachments() {
<span class="fc" id="L837">        return attachments;</span>
    }

    public void setPlanDescription(String planDescription) {
<span class="fc" id="L841">        this.planDescription = planDescription;</span>
<span class="fc" id="L842">    }</span>

    public String getActionPlan() {
<span class="fc" id="L845">        return actionPlan;</span>
    }

    public void setActionPlan(String actionPlan) {
<span class="fc" id="L849">        this.actionPlan = actionPlan;</span>
<span class="fc" id="L850">    }</span>

    public String getGreenText() {
<span class="fc" id="L853">        return greenText;</span>
    }

    public void setGreenText(String greenText) {
<span class="fc" id="L857">        this.greenText = greenText;</span>
<span class="fc" id="L858">    }</span>

    public String getAmberText() {
<span class="fc" id="L861">        return amberText;</span>
    }

    public void setAmberText(String amberText) {
<span class="fc" id="L865">        this.amberText = amberText;</span>
<span class="fc" id="L866">    }</span>

    public String getRedText() {
<span class="fc" id="L869">        return redText;</span>
    }

    public void setRedText(String redText) {
<span class="fc" id="L873">        this.redText = redText;</span>
<span class="fc" id="L874">    }</span>

    public TeamManager getTeamManager() {
<span class="nc" id="L877">        return teamManager;</span>
    }

    public void setTeamManager(TeamManager teamManager) {
<span class="fc" id="L881">        this.teamManager = teamManager;</span>
<span class="fc" id="L882">    }</span>

    public UserManager getUserManager() {
<span class="nc" id="L885">        return userManager;</span>
    }

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L889">        this.userManager = userManager;</span>
<span class="fc" id="L890">    }</span>

    public Long getPHPlanTemplateId() {
<span class="fc" id="L893">        return pHPlanTemplateId;</span>
    }

    public void setPHPlanTemplateId(Long pHPlanTemplateId) {
<span class="fc" id="L897">        this.pHPlanTemplateId = pHPlanTemplateId;</span>
<span class="fc" id="L898">    }</span>

    public File getAttachment() {
<span class="fc" id="L901">        return attachment;</span>
    }

    public void setAttachment(File attachment) {
<span class="fc" id="L905">        this.attachment = attachment;</span>
<span class="fc" id="L906">    }</span>

    public String getFileUploadErrorMessage() {
<span class="fc" id="L909">        return fileUploadErrorMessage;</span>
    }

    public void setFileUploadErrorMessage(String fileUploadErrorMessage) {
<span class="nc" id="L913">        this.fileUploadErrorMessage = fileUploadErrorMessage;</span>
<span class="nc" id="L914">    }</span>

    public String getFileLabel() {
<span class="fc" id="L917">        return fileLabel;</span>
    }

    public void setFileLabel(String fileLabel) {
<span class="fc" id="L921">        this.fileLabel = fileLabel;</span>
<span class="fc" id="L922">    }</span>

    public String getUnwantedAttachment() {
<span class="fc" id="L925">        return unwantedAttachment;</span>
    }

    public void setUnwantedAttachment(String unwantedAttachment) {
<span class="fc" id="L929">        this.unwantedAttachment = unwantedAttachment;</span>
<span class="fc" id="L930">    }</span>

    public String getAttachmentFileName() {
<span class="nc" id="L933">        return attachmentFileName;</span>
    }

    public void setAttachmentFileName(String attachmentFileName) {
<span class="fc" id="L937">        this.attachmentFileName = attachmentFileName;</span>
<span class="fc" id="L938">    }</span>

    public Long getInstituteId() {
<span class="nc" id="L941">        return instituteId;</span>
    }

    public void setInstituteId(Long instituteId) {
<span class="nc" id="L945">        this.instituteId = instituteId;</span>
<span class="nc" id="L946">    }</span>

    public String getTab() {
<span class="fc" id="L949">        return &quot;plans&quot;;</span>
    }

    public InputStream getAutoSaveResult() {
<span class="fc" id="L953">        return autoSaveResult;</span>
    }

    public void setAutoSaveResult(InputStream autoSaveResult) {
<span class="nc" id="L957">        this.autoSaveResult = autoSaveResult;</span>
<span class="nc" id="L958">    }</span>

    public Long getGreenFieldId() {
<span class="nc" id="L961">        return greenFieldId;</span>
    }

    public void setGreenFieldId(Long greenFieldId) {
<span class="nc" id="L965">        this.greenFieldId = greenFieldId;</span>
<span class="nc" id="L966">    }</span>

    public Long getRedFieldId() {
<span class="nc" id="L969">        return redFieldId;</span>
    }

    public void setRedFieldId(Long redFieldId) {
<span class="nc" id="L973">        this.redFieldId = redFieldId;</span>
<span class="nc" id="L974">    }</span>

    public Long getAmberFieldId() {
<span class="nc" id="L977">        return amberFieldId;</span>
    }

    public void setAmberFieldId(Long amberFieldId) {
<span class="nc" id="L981">        this.amberFieldId = amberFieldId;</span>
<span class="nc" id="L982">    }</span>

    public Long getActionPlanFieldId() {
<span class="nc" id="L985">        return actionPlanFieldId;</span>
    }

    public void setActionPlanFieldId(Long actionPlanFieldId) {
<span class="nc" id="L989">        this.actionPlanFieldId = actionPlanFieldId;</span>
<span class="nc" id="L990">    }</span>

    public void setAttachmentContentType(String attachmentContentType) {
<span class="fc" id="L993">        this.attachmentContentType = attachmentContentType;</span>
<span class="fc" id="L994">    }</span>

    public void setJson(String json) {
<span class="fc" id="L997">        this.json = json;</span>
<span class="fc" id="L998">    }</span>

    public Set&lt;String&gt; getMeasurementTypeList() {
<span class="fc" id="L1001">        return measurementTypeList;</span>
    }

    public void setMeasurementTypeList(Set&lt;String&gt; measurementTypeList) {
<span class="nc" id="L1005">        this.measurementTypeList = measurementTypeList;</span>
<span class="nc" id="L1006">    }</span>

    public List&lt;String&gt; getMeasurementTypeName() {
<span class="fc" id="L1009">        return measurementTypeName;</span>
    }

    public void setMeasurementTypeName(List&lt;String&gt; measurementTypeName) {
<span class="fc" id="L1013">        this.measurementTypeName = measurementTypeName;</span>
<span class="fc" id="L1014">    }</span>

    public Set&lt;String&gt; getSymptomTypeList() {
<span class="fc" id="L1017">        return symptomTypeList;</span>
    }

    public void setSymptomTypeList(Set&lt;String&gt; symptomTypeList) {
<span class="nc" id="L1021">        this.symptomTypeList = symptomTypeList;</span>
<span class="nc" id="L1022">    }</span>

    public List&lt;String&gt; getSymptomTypeName() {
<span class="fc" id="L1025">        return symptomTypeName;</span>
    }

    public void setSymptomTypeName(List&lt;String&gt; symptomTypeName) {
<span class="fc" id="L1029">        this.symptomTypeName = symptomTypeName;</span>
<span class="fc" id="L1030">    }</span>

    public TestManager getTestManager() {
<span class="nc" id="L1033">        return testManager;</span>
    }

    public void setTestManager(TestManager testManager) {
<span class="fc" id="L1037">        this.testManager = testManager;</span>
<span class="fc" id="L1038">    }</span>

    public List&lt;NewTemplateMetric&gt; getTestMetricList() {
<span class="fc" id="L1041">        return testMetricList;</span>
    }

    public PHPlanTemplate getpHPlanTemplate() {
<span class="nc" id="L1045">        return pHPlanTemplate;</span>
    }

    public void setpHPlanTemplate(PHPlanTemplate pHPlanTemplate) {
<span class="nc" id="L1049">        this.pHPlanTemplate = pHPlanTemplate;</span>
<span class="nc" id="L1050">    }</span>

    public Long getReviewPeriodDays() {
<span class="fc" id="L1053">        return reviewPeriodDays;</span>
    }

    public void setReviewPeriodDays(Long reviewPeriodDays) {
<span class="fc" id="L1057">        this.reviewPeriodDays = reviewPeriodDays;</span>
<span class="fc" id="L1058">    }</span>

    public List&lt;Boolean&gt; getTestMetricWanted() {
<span class="fc" id="L1061">        return testMetricWanted;</span>
    }

    public void setTestMetricWanted(List&lt;Boolean&gt; testMetricWanted) {
<span class="fc" id="L1065">        this.testMetricWanted = testMetricWanted;</span>
<span class="fc" id="L1066">    }</span>

    public void setTestMetricList(List&lt;NewTemplateMetric&gt; testMetricList) {
<span class="nc" id="L1069">        this.testMetricList = testMetricList;</span>
<span class="nc" id="L1070">    }</span>

    public PlanManager getPlanManager() {
<span class="nc" id="L1073">        return planManager;</span>
    }

    public void setPlanManager(PlanManager planManager) {
<span class="fc" id="L1077">        this.planManager = planManager;</span>
<span class="fc" id="L1078">    }</span>

    public CustomStyledHtmlFilter getCustomStyledHtmlFilter() {
<span class="nc" id="L1081">        return customStyledHtmlFilter;</span>
    }

    public void setCustomStyledHtmlFilter(CustomStyledHtmlFilter customStyledHtmlFilter) {
<span class="fc" id="L1085">        this.customStyledHtmlFilter = customStyledHtmlFilter;</span>
<span class="fc" id="L1086">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>