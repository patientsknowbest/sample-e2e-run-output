<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GetCustomersAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.admin.action</a> &gt; <span class="el_source">GetCustomersAction.java</span></div><h1>GetCustomersAction.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------
//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
// $Id: GetCustomersAction.java Jun 21, 2010 11:57:57 AM anamikac$
//
//------------------------------------------------------------------------------
package com.pkb.admin.action;

import com.opensymphony.xwork2.Action;
import com.pkb.datamodel.Affiliate;
import com.pkb.datamodel.AppointmentMessagingSettings;
import com.pkb.datamodel.plantemplate.PHPlanTemplate;
import com.pkb.datamodel.team.AffiliateTeamWithOrg;
import com.pkb.domain.appointment.AppointmentMessagingSettingsService;
import com.pkb.dto.MonthlyStatsDTO;
import com.pkb.exception.PKBException;
import com.pkb.institute.entity.InstituteUser;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import com.pkb.questionnaires.action.QuestionnaireBaseAction;
import com.pkb.questionnaireservice.modelv2.QuestionnaireTeam;
import com.pkb.service.phplan.PlanTemplateManager;
import com.pkb.service.questionnaire.QuestionnaireManager;
import com.pkb.service.team.AffiliateManager;
import com.pkb.service.team.TeamManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;

import java.time.ZonedDateTime;
import java.time.temporal.ChronoUnit;
import java.time.temporal.TemporalAdjusters;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;

import static org.apache.commons.lang3.StringUtils.isNotBlank;

/**
 * @author pravinam : Added affiliate teams and patient statistics to team page
 */
public class GetCustomersAction extends QuestionnaireBaseAction {

    private static final long serialVersionUID = 1L;

    private static final long NO_TEAM_SELECTED = -1;

<span class="fc" id="L54">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    /**
     * used when viewing a single institution - see viewTeam()
     */
    private String instituteCode;

    private InstituteUser instituteUser;

    private List&lt;PKBPerson&gt; instituteAdmins;

    private int offset;

    private int pagesize;

    private TeamManager teamManager;

    private List&lt;Org&gt; orgList;

    private List&lt;Team&gt; teamList;

    private List&lt;PHPlanTemplate&gt; pHPlanTemplates;

    private List&lt;QuestionnaireTeam&gt; questionnaires;

    private List&lt;PKBPerson&gt; orgCoords;

    private List&lt;PKBPerson&gt; privacyOfficers;

    private int inboxCount;

<span class="fc" id="L85">    private final String tab = &quot;customers&quot;;</span>

<span class="fc" id="L87">    private final String subTab = &quot;customerList&quot;;</span>

    private PlanTemplateManager planTemplateManager;

    private AffiliateManager affiliateManager;

    private QuestionnaireManager questionnaireManager;

    private List&lt;AffiliateTeamWithOrg&gt; affiliateTeamWithOrgs;

    private List&lt;MonthlyStatsDTO&gt; patientsRegisteredThisYear;

    private List&lt;MonthlyStatsDTO&gt; patientsRegisteredLastYear;
    private final boolean privacyOfficerInviteAllowed;

    private boolean appointmentMessagingEnabled;
    private Long appointmentMessagingTeamId;

    private AppointmentMessagingSettingsService appointmentMessagingSettingsService;

    public List&lt;PKBPerson&gt; getOrgCoords() {
<span class="fc" id="L108">        return orgCoords;</span>
    }

    public void setOrgCoords(List&lt;PKBPerson&gt; orgCoords) {
<span class="nc" id="L112">        this.orgCoords = orgCoords;</span>
<span class="nc" id="L113">    }</span>

    private Long orgId;

    private Org org;

    private String hl7User;

    private String hl7Password;

    private boolean passwordAlreadySet;

    @Autowired
<span class="fc" id="L126">    public GetCustomersAction(@Value(&quot;${feature.privacyofficer.registration.enabled}&quot;) boolean privacyOfficerInviteAllowed) {</span>
<span class="fc" id="L127">        this.privacyOfficerInviteAllowed = privacyOfficerInviteAllowed;</span>
<span class="fc" id="L128">    }</span>

    /**
     * Get the list of Orgs
     */
    public String orgList() {
        try {
<span class="fc" id="L135">            orgList = teamManager.getOrgList();</span>

<span class="fc" id="L137">            return Action.SUCCESS;</span>
<span class="nc" id="L138">        } catch (PKBException e) {</span>
<span class="nc" id="L139">            LOGGER.error(&quot;Error while getting the list of orgs&quot;, e);</span>
        }
<span class="nc" id="L141">        return Action.ERROR;</span>
    }

    /**
     * Get the list of Teams
     */
    @Override
    public String execute() {
        try {
<span class="pc bpc" id="L150" title="1 of 2 branches missed.">            if (offset &lt; 0) {</span>
<span class="nc" id="L151">                offset = 0;</span>
            }
<span class="fc" id="L153">            pagesize = getConfig().getInboxPageSize() + 1;</span>

<span class="fc" id="L155">            teamList = teamManager.getTeamsForOrg(orgId);</span>

<span class="pc bpc" id="L157" title="1 of 2 branches missed.">            if (!teamList.isEmpty()) {</span>
<span class="fc" id="L158">                org = teamList.get(0).getOrg();</span>
<span class="fc" id="L159">                passwordAlreadySet = StringUtils.isNotBlank(org.getHl7PasswordHash());</span>
            }

<span class="fc" id="L162">            inboxCount = teamManager.getTeamCount();</span>

<span class="fc" id="L164">            return Action.SUCCESS;</span>
<span class="nc" id="L165">        } catch (RuntimeException e) {</span>
<span class="nc" id="L166">            LOGGER.error(&quot;Error while getting the list of teams for org={}&quot;, orgId, e);</span>
        }
<span class="nc" id="L168">        return Action.ERROR;</span>
    }

    /**
     * Show complete details of an organization
     */
    public String viewOrg() {
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if (orgId != null) {</span>
            try {
<span class="fc" id="L177">                org = teamManager.getOrg(orgId, Org.Lazy.EXTERNAL_IDS, Org.Lazy.TEAMS).orElse(null);</span>
<span class="fc" id="L178">                orgCoords = userManager.findOrgCoords(org.getId());</span>
<span class="fc" id="L179">                privacyOfficers = userManager.findPrivacyOfficers(org);</span>
<span class="fc" id="L180">                passwordAlreadySet = StringUtils.isNotBlank(org.getHl7PasswordHash());</span>

<span class="fc" id="L182">                Optional&lt;AppointmentMessagingSettings&gt; appointmentMessagingSettings = appointmentMessagingSettingsService.getAppointmentMessaging(org.getId());</span>
<span class="fc" id="L183">                appointmentMessagingEnabled = appointmentMessagingSettings.map(AppointmentMessagingSettings::isAppointmentMessagingEnabled).orElse(false);</span>
<span class="fc" id="L184">                appointmentMessagingTeamId = appointmentMessagingSettings.map(AppointmentMessagingSettings::getAppointmentMessagingTeamId).orElse(Optional.empty()).orElse(null);</span>
<span class="nc" id="L185">            } catch (PKBException e) {</span>
<span class="nc" id="L186">                LOGGER.error(&quot;Error while getting org details&quot;, e);</span>
<span class="fc" id="L187">            }</span>
        }
<span class="fc" id="L189">        return Action.SUCCESS;</span>
    }

    /**
     * Show complete details of a team and the associated coordinator list
     */
    public String viewTeam() {
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">        if (instituteCode != null) {</span>
            try {
                /*
                 * List of PKBPerson [instituteAdmins] is used to be flexible
                 * with the case when an institute can have multiple
                 * administrators
                 */
<span class="fc" id="L203">                instituteUser = new InstituteUser();</span>
<span class="fc" id="L204">                Team team = teamManager.getTeamByCode(instituteCode);</span>
<span class="fc" id="L205">                team.setLogoFileName(getConfig()</span>
<span class="fc" id="L206">                        .getInstituteLogoBaseDir()</span>
<span class="fc" id="L207">                        + team.getLogoFileName());</span>
<span class="fc" id="L208">                instituteUser.setInstitute(team);</span>
<span class="fc" id="L209">                instituteAdmins = teamManager.getTeamCoord(team.getId());</span>

                // list of templates

<span class="fc" id="L213">                Long teamId = team.getId();</span>

<span class="fc" id="L215">                pHPlanTemplates = planTemplateManager.getTemplateList(teamId);</span>
<span class="fc" id="L216">                questionnaireManager.getQuestionnaireTeamListForTeam(team.getPublicId(), true)</span>
<span class="fc" id="L217">                        .peek(quests -&gt; questionnaires = quests)</span>
<span class="fc" id="L218">                        .peekLeft(this::handleQuestionnaireException);</span>
                //List of affiliated teams
<span class="fc" id="L220">                Map&lt;Long, Long&gt; affiliateIdMap = affiliateManager.getAffiliates(teamId)</span>
<span class="fc" id="L221">                        .stream()</span>
<span class="fc" id="L222">                        .filter(affiliate -&gt; affiliate.getId().isDefined())</span>
<span class="fc" id="L223">                        .collect(Collectors.toMap(Affiliate::getAffiliateTeamId, affiliate -&gt; affiliate.getId().get()));</span>

<span class="fc" id="L225">                affiliateTeamWithOrgs = affiliateManager.getAffiliateTeamWithOrgsForTeams(teamManager.getTeams(affiliateIdMap.keySet()), affiliateIdMap);</span>

                // Get statistics on patient registered
<span class="fc" id="L228">                getPatientRegistrationStats(teamId);</span>

<span class="nc" id="L230">            } catch (PKBException e) {</span>
<span class="nc" id="L231">                LOGGER.error(&quot;Error while getting team details&quot;, e);</span>
<span class="fc" id="L232">            }</span>
        }
<span class="fc" id="L234">        return Action.SUCCESS;</span>
    }

    private void getPatientRegistrationStats(Long teamId) {
<span class="fc" id="L238">        ZonedDateTime now = dateTimeService.nowZonedDateTime();</span>
<span class="fc" id="L239">        ZonedDateTime lastYear = now.minusYears(1L);</span>
        // Get statistics on patient registered this year
<span class="fc" id="L241">        patientsRegisteredThisYear = getPatientsRegistered(teamId, now);</span>
        // Get statistics on patient registered last year
<span class="fc" id="L243">        patientsRegisteredLastYear = getPatientsRegistered(teamId, lastYear);</span>
<span class="fc" id="L244">    }</span>

    private List&lt;MonthlyStatsDTO&gt; getPatientsRegistered(Long teamId, ZonedDateTime year) {
<span class="fc" id="L247">        List&lt;MonthlyStatsDTO&gt; statsThisYear = new ArrayList&lt;&gt;();</span>
        // Get patient statistics for last month in given year
<span class="fc" id="L249">        ZonedDateTime date1 = year.with(TemporalAdjusters.firstDayOfMonth()).truncatedTo(ChronoUnit.DAYS).minusMonths(1L);</span>
<span class="fc" id="L250">        ZonedDateTime date2 = date1.with(TemporalAdjusters.lastDayOfMonth()).withHour(23).withMinute(59).withSecond(59).withNano(999999999);</span>
<span class="fc" id="L251">        int count = teamManager.getNumOfPatientsRegistered(teamId, date1.toInstant(), date2.toInstant());</span>
<span class="fc" id="L252">        MonthlyStatsDTO statsDTO = new MonthlyStatsDTO();</span>
<span class="fc" id="L253">        statsDTO.setYear(year.getYear());</span>

<span class="fc" id="L255">        statsDTO.setMonth(pkbWebUtil.getMonth(year.getMonthValue()));</span>
<span class="fc" id="L256">        statsDTO.setNoOfPatientsRegistered(count);</span>
<span class="fc" id="L257">        statsThisYear.add(statsDTO);</span>
        //log.info(&quot;date1=&quot;+date1+&quot; date2=&quot;+date2);

        // Get patient statistics for previous  to last month for given year
<span class="fc" id="L261">        ZonedDateTime date3 = date1.minusMonths(1L);</span>
<span class="fc" id="L262">        ZonedDateTime date4 = date2.minusMonths(1L);</span>
<span class="fc" id="L263">        count = teamManager.getNumOfPatientsRegistered(teamId, date3.toInstant(), date4.toInstant());</span>
<span class="fc" id="L264">        statsDTO = new MonthlyStatsDTO();</span>
<span class="fc" id="L265">        statsDTO.setYear(date3.getYear());</span>
<span class="fc" id="L266">        statsDTO.setMonth(pkbWebUtil.getMonth(date3.getMonthValue()));</span>
<span class="fc" id="L267">        statsDTO.setNoOfPatientsRegistered(count);</span>
<span class="fc" id="L268">        statsThisYear.add(statsDTO);</span>
        //log.info(&quot;date3=&quot;+date3+&quot; date4=&quot;+date4);
<span class="fc" id="L270">        return statsThisYear;</span>
    }

    public String viewRegistrationLinks() {
<span class="nc" id="L274">        org = teamManager.getOrg(orgId).orElse(null);</span>
<span class="nc" id="L275">        passwordAlreadySet = StringUtils.isNotBlank(org.getHl7PasswordHash());</span>
<span class="nc" id="L276">        return SUCCESS;</span>
    }

    public int getOffset() {
<span class="fc" id="L280">        return offset;</span>
    }

    public void setOffset(int offset) {
<span class="nc" id="L284">        this.offset = offset;</span>
<span class="nc" id="L285">    }</span>

    public int getPagesize() {
<span class="fc" id="L288">        return pagesize;</span>
    }

    public void setPagesize(int pagesize) {
<span class="nc" id="L292">        this.pagesize = pagesize;</span>
<span class="nc" id="L293">    }</span>

    public int getInboxCount() {
<span class="fc" id="L296">        return inboxCount;</span>
    }

    public void setInboxCount(int inboxCount) {
<span class="nc" id="L300">        this.inboxCount = inboxCount;</span>
<span class="nc" id="L301">    }</span>

    public List&lt;Org&gt; getOrgList() {
<span class="fc" id="L304">        return orgList;</span>
    }

    public List&lt;Team&gt; getTeamList() {
<span class="fc" id="L308">        return teamList;</span>
    }

    public InstituteUser getInstituteUser() {
<span class="fc" id="L312">        return instituteUser;</span>
    }

    public List&lt;PKBPerson&gt; getInstituteAdmins() {
<span class="fc" id="L316">        return instituteAdmins;</span>
    }

    public void setInstituteAdmins(List&lt;PKBPerson&gt; instituteAdmins) {
<span class="nc" id="L320">        this.instituteAdmins = instituteAdmins;</span>
<span class="nc" id="L321">    }</span>

    public String getInstituteCode() {
<span class="nc" id="L324">        return instituteCode;</span>
    }

    public void setInstituteCode(String instituteCode) {
<span class="fc" id="L328">        this.instituteCode = instituteCode;</span>
<span class="fc" id="L329">    }</span>

    public String getTab() {
<span class="fc" id="L332">        return tab;</span>
    }

    public String getSubTab() {
<span class="fc" id="L336">        return subTab;</span>
    }

    public List&lt;QuestionnaireTeam&gt; getQuestionnaires() {
<span class="fc" id="L340">        return questionnaires;</span>
    }

    public void setQuestionnaires(List&lt;QuestionnaireTeam&gt; questionnaires) {
<span class="nc" id="L344">        this.questionnaires = questionnaires;</span>
<span class="nc" id="L345">    }</span>

    public List&lt;PHPlanTemplate&gt; getPHPlanTemplates() {
<span class="fc" id="L348">        return pHPlanTemplates;</span>
    }

    public QuestionnaireManager getQuestionnaireManager() {
<span class="nc" id="L352">        return questionnaireManager;</span>
    }

    public void setQuestionnaireManager(QuestionnaireManager questionnaireManager) {
<span class="fc" id="L356">        this.questionnaireManager = questionnaireManager;</span>
<span class="fc" id="L357">    }</span>

    public void setpHPlanTemplates(
            List&lt;PHPlanTemplate&gt; pHPlanTemplates) {
<span class="nc" id="L361">        this.pHPlanTemplates = pHPlanTemplates;</span>
<span class="nc" id="L362">    }</span>

    public PlanTemplateManager getpHPlanTemplateManager() {
<span class="nc" id="L365">        return planTemplateManager;</span>
    }

    public void setPlanTemplateManager(PlanTemplateManager planTemplateManager) {
<span class="fc" id="L369">        this.planTemplateManager = planTemplateManager;</span>
<span class="fc" id="L370">    }</span>

    public List&lt;PHPlanTemplate&gt; getpHPlanTemplates() {
<span class="nc" id="L373">        return pHPlanTemplates;</span>
    }

    public void setAffiliateManager(AffiliateManager affiliateManager) {
<span class="fc" id="L377">        this.affiliateManager = affiliateManager;</span>
<span class="fc" id="L378">    }</span>

    public List&lt;MonthlyStatsDTO&gt; getPatientsRegisteredThisYear() {
<span class="fc" id="L381">        return patientsRegisteredThisYear;</span>
    }

    public void setPatientsRegisteredThisYear(
            List&lt;MonthlyStatsDTO&gt; patientsRegisteredThisYear) {
<span class="nc" id="L386">        this.patientsRegisteredThisYear = patientsRegisteredThisYear;</span>
<span class="nc" id="L387">    }</span>

    public List&lt;MonthlyStatsDTO&gt; getPatientsRegisteredLastYear() {
<span class="fc" id="L390">        return patientsRegisteredLastYear;</span>
    }

    public void setPatientsRegisteredLastYear(
            List&lt;MonthlyStatsDTO&gt; patientsRegisteredLastYear) {
<span class="nc" id="L395">        this.patientsRegisteredLastYear = patientsRegisteredLastYear;</span>
<span class="nc" id="L396">    }</span>

    public Long getOrgId() {
<span class="nc" id="L399">        return orgId;</span>
    }

    public void setOrgId(Long orgId) {
<span class="fc" id="L403">        this.orgId = orgId;</span>
<span class="fc" id="L404">    }</span>

    public Org getOrg() {
<span class="fc" id="L407">        return org;</span>
    }

    public void setOrg(Org org) {
<span class="nc" id="L411">        this.org = org;</span>
<span class="nc" id="L412">    }</span>

    public TeamManager getTeamManager() {
<span class="nc" id="L415">        return teamManager;</span>
    }

    public void setTeamManager(TeamManager teamManager) {
<span class="fc" id="L419">        this.teamManager = teamManager;</span>
<span class="fc" id="L420">    }</span>

    public UserManager getUserManager() {
<span class="nc" id="L423">        return userManager;</span>
    }

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L427">        this.userManager = userManager;</span>
<span class="fc" id="L428">    }</span>

    public boolean isPrivacyOfficerInviteAllowed() {
<span class="fc" id="L431">        return privacyOfficerInviteAllowed;</span>
    }

    public List&lt;PKBPerson&gt; getPrivacyOfficers() {
<span class="fc" id="L435">        return privacyOfficers;</span>
    }

    public boolean isEmailFooterImageFilenameAvailable() {
<span class="fc" id="L439">        return isNotBlank(org.getEmailFooterImageFilename());</span>
    }

    public String getHl7User() {
<span class="nc" id="L443">        return hl7User;</span>
    }

    public void setHl7User(String hl7User) {
<span class="nc" id="L447">        this.hl7User = hl7User;</span>
<span class="nc" id="L448">    }</span>

    public String getHl7Password() {
<span class="fc" id="L451">        return hl7Password;</span>
    }

    public void setHl7Password(String hl7Password) {
<span class="nc" id="L455">        this.hl7Password = hl7Password;</span>
<span class="nc" id="L456">    }</span>

    public boolean isPasswordAlreadySet() {
<span class="fc" id="L459">        return passwordAlreadySet;</span>
    }

    public void setPasswordAlreadySet(boolean passwordAlreadySet) {
<span class="nc" id="L463">        this.passwordAlreadySet = passwordAlreadySet;</span>
<span class="nc" id="L464">    }</span>

    public List&lt;AffiliateTeamWithOrg&gt; getAffiliateTeamWithOrgs() {
<span class="fc" id="L467">        return affiliateTeamWithOrgs;</span>
    }

    public void setAffiliateTeamWithOrgs(List&lt;AffiliateTeamWithOrg&gt; affiliateTeamWithOrgs) {
<span class="nc" id="L471">        this.affiliateTeamWithOrgs = affiliateTeamWithOrgs;</span>
<span class="nc" id="L472">    }</span>

    public boolean isAppointmentMessagingEnabled() {
<span class="fc" id="L475">        return appointmentMessagingEnabled;</span>
    }

    public void setAppointmentMessagingEnabled(boolean appointmentMessagingEnabled) {
<span class="fc" id="L479">        this.appointmentMessagingEnabled = appointmentMessagingEnabled;</span>
<span class="fc" id="L480">    }</span>

    public Long getAppointmentMessagingTeamId() {
<span class="fc" id="L483">        return appointmentMessagingTeamId;</span>
    }

    public void setAppointmentMessagingTeamId(Long appointmentMessagingTeamId) {
<span class="nc" id="L487">        this.appointmentMessagingTeamId = appointmentMessagingTeamId;</span>
<span class="nc" id="L488">    }</span>

    public void setAppointmentMessagingService(AppointmentMessagingSettingsService appointmentMessagingSettingsService) {
<span class="fc" id="L491">        this.appointmentMessagingSettingsService = appointmentMessagingSettingsService;</span>
<span class="fc" id="L492">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>