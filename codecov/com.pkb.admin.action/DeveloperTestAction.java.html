<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DeveloperTestAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.admin.action</a> &gt; <span class="el_source">DeveloperTestAction.java</span></div><h1>DeveloperTestAction.java</h1><pre class="source lang-java linenums">package com.pkb.admin.action;

import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.action.devices.ManageDevicesAction;
import com.pkb.crypto.util.RandomUtil;
import com.pkb.datamodel.Email;
import com.pkb.encounter.entity.Message;
import com.pkb.entities.enums.PrivacyFlag;
import com.pkb.integration.sciStore.ISciStoreClient;
import com.pkb.integration.sciStore.SciStorePatient;
import com.pkb.service.dataupload.impl.DataUploadManager;
import com.pkb.service.diagnosis.DiagnosisManager;
import com.pkb.service.encounter.impl.tolven.EncounterManager;
import com.pkb.service.radiology.RadiologyManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.test.MeasurementManager;
import com.pkb.service.test.PathologyReportManager;
import com.pkb.service.test.TestManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.test.entity.MeasurementDTO;
import com.pkb.test.entity.TestResultDTO;
import com.pkb.testdatagenerator.ITestDataGenerator;
import com.pkb.user.entity.PKBPerson;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.Instant;
import java.time.LocalDateTime;
import java.util.Collections;
import java.util.List;
import java.util.UUID;

import static com.pkb.datamodel.ImmutableDisclosingEmail.disclosingEmail;
import static com.pkb.util.Constants.APPLICATION_TZ;

/**
 * This Action class backs functionality available to the Super Admin, in the Developers tab.
 */
<span class="fc" id="L40">public class DeveloperTestAction extends BaseAction {</span>

    private static final long serialVersionUID = 1L;

    // Core devices - fake fetched data

<span class="fc" id="L46">    private String coreDevicesUserId = &quot;5304c993f1f70e8528000005&quot;;</span>
<span class="fc" id="L47">    private String category = &quot;routine&quot;;</span>
<span class="fc" id="L48">    private String source = &quot;fitbit&quot;;</span>
<span class="fc" id="L49">    private String coreDevicesJson = &quot;{\&quot;summary\&quot;:{\&quot;status\&quot;:200,\&quot;message\&quot;:\&quot;Ok\&quot;,\&quot;results\&quot;:1,\&quot;start_date\&quot;:\&quot;2014-07-14T03:43:06+00:00\&quot;,\&quot;end_date\&quot;:\&quot;2014-07-14T06:10:09+00:00\&quot;,\&quot;offset\&quot;:0,\&quot;limit\&quot;:100,\&quot;previous\&quot;:null,\&quot;next\&quot;:null,\&quot;params\&quot;:{\&quot;start_date\&quot;:\&quot;2014-07-14T03:43:06+00:00\&quot;,\&quot;end_date\&quot;:\&quot;2014-07-14T06:10:09+00:00\&quot;,\&quot;offset\&quot;:0,\&quot;limit\&quot;:0}},\&quot;routine\&quot;:[{\&quot;_id\&quot;:\&quot;53c32a3f36847d99dc07e640\&quot;,\&quot;timestamp\&quot;:\&quot;2014-07-13T22:00:00+00:00\&quot;,\&quot;utc_offset\&quot;:\&quot;+02:00\&quot;,\&quot;steps\&quot;:5000.0,\&quot;calories_burned\&quot;:392.0,\&quot;distance\&quot;:0.0,\&quot;floors\&quot;:null,\&quot;elevation\&quot;:null,\&quot;source\&quot;:\&quot;fitbit\&quot;,\&quot;source_name\&quot;:\&quot;Fitbit\&quot;,\&quot;last_updated\&quot;:\&quot;2014-07-14T04:14:41+00:00\&quot;}]}&quot;;</span>
<span class="fc" id="L50">    private String coreDevicesCensoredJson = null;</span>

    private ManageDevicesAction manageDevicesAction;
    private TestManager testManager;
    private TeamUserManager teamUserManager;
    private DiagnosisManager diagnosisManager;
    private RadiologyManager radiologyManager;
    private EncounterManager encounterManager;
    private PathologyReportManager pathologyReportManager;
    private MeasurementManager measurementManager;
    private ITestDataGenerator testDataGenerator;

    //
    // SciStore
    //

    private String endPoint;
    private String requestMessage;
    private String responseMessage;
    private String stackTrace;
    private String sessionToken;
    private String CHINumber;
    private SciStorePatient sciStorePatient;
    private String sciStorePatientId;
    private String sciStoreResultId;
    private String sciStoreSubscriptionId;
    private List&lt;PKBPerson&gt; sciStoreUnsyncedPatients;

    private PKBPerson patient;
    private String pkbPatientId;

    private ISciStoreClient sciStoreClient;
    private DataUploadManager dataUploadManager;

    // Test data generator

    private String patientEmail;
    private Integer numResults;

<span class="fc" id="L89">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    // Test data generator

    private Email patientEmail() {
<span class="fc" id="L94">        return disclosingEmail(this.patientEmail);</span>
    }

    public String generateMeasurements() {
<span class="fc" id="L98">        patient = userManager.getSinglePersonByEmail(patientEmail());</span>
<span class="fc" id="L99">        List&lt;MeasurementDTO&gt; testData = testDataGenerator.generateMeasurements(getLoggedInEHRRequestContext(), numResults);</span>
<span class="fc" id="L100">        measurementManager.saveMeasurements(getEHRRequestContext(), testData, patient.getId());</span>
<span class="fc" id="L101">        return Action.SUCCESS;</span>
    }

    public String generateLoincTestData() {
<span class="fc" id="L105">        patient = userManager.getSinglePersonByEmail(patientEmail());</span>
<span class="fc" id="L106">        List&lt;TestResultDTO&gt; testResults = testDataGenerator.generateLoincTestData(getLoggedInEHRRequestContext(), patient.getId(), numResults);</span>
<span class="fc" id="L107">        testManager.saveTestResults(getLoggedInEHRRequestContext(), testResults, patient.getId());</span>
<span class="fc" id="L108">        return Action.SUCCESS;</span>
    }

    public String generateMappingTestData() {
<span class="fc" id="L112">        patient = userManager.getSinglePersonByEmail(patientEmail());</span>
<span class="fc" id="L113">        List&lt;TestResultDTO&gt; testResults = testDataGenerator.generateMappingTestData(getLoggedInEHRRequestContext(), patient.getId(), numResults);</span>
<span class="fc" id="L114">        testManager.saveTestResults(getLoggedInEHRRequestContext(), testResults, patient.getId());</span>
<span class="fc" id="L115">        return Action.SUCCESS;</span>
    }

    public String generateTestMessages() {
<span class="fc" id="L119">        patient = userManager.getSinglePersonByEmail(patientEmail());</span>
<span class="fc" id="L120">        List&lt;String&gt; participants = Collections.singletonList(patient.getId().toString());</span>

<span class="fc" id="L122">        LocalDateTime now = dateTimeService.nowLocalDateTime();</span>
<span class="fc" id="L123">        Instant yearAgo = now.minusYears(1L).atZone(APPLICATION_TZ).toInstant();</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">        for (int i = 0; i &lt; numResults; ++i) {</span>
<span class="fc" id="L125">            encounterManager.transactional(() -&gt; {</span>
<span class="fc" id="L126">                Message message = encounterManager.createMessage(patient.getId().toString(),</span>
<span class="fc" id="L127">                        UUID.randomUUID(),</span>
                        false,
<span class="fc" id="L129">                        Long.toString(loggedInUserUtil.getLoggedInUserId()),</span>
<span class="fc" id="L130">                        &quot;Test message - &quot; + RandomUtil.randomString(10),</span>
<span class="fc" id="L131">                        RandomUtil.randomString(80),</span>
                        PrivacyFlag.GENERAL,
<span class="fc" id="L133">                        getEHRRequestContext());</span>
<span class="fc" id="L134">                message.setMessageTimestamp(yearAgo);</span>
<span class="fc" id="L135">                message.setParticipants(participants);</span>

                // Save bypassing notifications
<span class="fc" id="L138">                encounterManager.saveMessageNewConversation(getLoggedInEHRRequestContext(), message, null /*attachments*/);</span>
<span class="fc" id="L139">            });</span>
        }
<span class="fc" id="L141">        return Action.SUCCESS;</span>
    }

    public String getRequestMessage() {
<span class="nc" id="L145">        return requestMessage;</span>
    }

    public void setRequestMessage(String requestMessage) {
<span class="nc" id="L149">        this.requestMessage = requestMessage;</span>
<span class="nc" id="L150">    }</span>

    public String getResponseMessage() {
<span class="nc" id="L153">        return responseMessage;</span>
    }

    public void setResponseMessage(String responseMessage) {
<span class="nc" id="L157">        this.responseMessage = responseMessage;</span>
<span class="nc" id="L158">    }</span>

    public String getSessionToken() {
<span class="nc" id="L161">        return sessionToken;</span>
    }

    public String getSciStoreSubscriptionId() {
<span class="nc" id="L165">        return sciStoreSubscriptionId;</span>
    }

    public void setSciStoreSubscriptionId(String sciStoreSubscriptionId) {
<span class="nc" id="L169">        this.sciStoreSubscriptionId = sciStoreSubscriptionId;</span>
<span class="nc" id="L170">    }</span>

    public void setSessionToken(String sessionToken) {
<span class="nc" id="L173">        this.sessionToken = sessionToken;</span>
<span class="nc" id="L174">    }</span>

    public SciStorePatient getSciStorePatient() {
<span class="nc" id="L177">        return sciStorePatient;</span>
    }

    public void setSciStorePatient(SciStorePatient sciStorePatient) {
<span class="nc" id="L181">        this.sciStorePatient = sciStorePatient;</span>
<span class="nc" id="L182">    }</span>

    public DataUploadManager getDataUploadManager() {
<span class="nc" id="L185">        return dataUploadManager;</span>
    }

    public List&lt;PKBPerson&gt; getSciStoreUnsyncedPatients() {
<span class="nc" id="L189">        return sciStoreUnsyncedPatients;</span>
    }

    public void setSciStoreUnsyncedPatients(List&lt;PKBPerson&gt; sciStoreUnsyncedPatients) {
<span class="nc" id="L193">        this.sciStoreUnsyncedPatients = sciStoreUnsyncedPatients;</span>
<span class="nc" id="L194">    }</span>

    public void setDataUploadManager(DataUploadManager dataUploadManager) {
<span class="fc" id="L197">        this.dataUploadManager = dataUploadManager;</span>
<span class="fc" id="L198">    }</span>

    public ISciStoreClient getSciStoreClient() {
<span class="nc" id="L201">        return sciStoreClient;</span>
    }

    public void setSciStoreClient(ISciStoreClient sciStoreClient) {
<span class="fc" id="L205">        this.sciStoreClient = sciStoreClient;</span>
<span class="fc" id="L206">    }</span>

    public String getCHINumber() {
<span class="nc" id="L209">        return CHINumber;</span>
    }

    public void setCHINumber(String cHINumber) {
<span class="nc" id="L213">        CHINumber = cHINumber;</span>
<span class="nc" id="L214">    }</span>

    public String getCoreDevicesUserId() {
<span class="nc" id="L217">        return coreDevicesUserId;</span>
    }

    public void setCoreDevicesUserId(String coreDevicesUserId) {
<span class="nc" id="L221">        this.coreDevicesUserId = coreDevicesUserId;</span>
<span class="nc" id="L222">    }</span>

    public String getCategory() {
<span class="nc" id="L225">        return category;</span>
    }

    public void setCategory(String category) {
<span class="nc" id="L229">        this.category = category;</span>
<span class="nc" id="L230">    }</span>

    public String getSource() {
<span class="nc" id="L233">        return source;</span>
    }

    public void setSource(String source) {
<span class="nc" id="L237">        this.source = source;</span>
<span class="nc" id="L238">    }</span>

    public String getCoreDevicesJson() {
<span class="nc" id="L241">        return coreDevicesJson;</span>
    }

    public void setCoreDevicesJson(String coreDevicesJson) {
<span class="nc" id="L245">        this.coreDevicesJson = coreDevicesJson;</span>
<span class="nc" id="L246">    }</span>

    public ManageDevicesAction getManageDevicesAction() {
<span class="nc" id="L249">        return manageDevicesAction;</span>
    }

    public void setManageDevicesAction(ManageDevicesAction manageDevicesAction) {
<span class="nc" id="L253">        this.manageDevicesAction = manageDevicesAction;</span>
<span class="nc" id="L254">    }</span>

    public String getSciStorePatientId() {
<span class="nc" id="L257">        return sciStorePatientId;</span>
    }

    public void setSciStorePatientId(String sciStorePatientId) {
<span class="nc" id="L261">        this.sciStorePatientId = sciStorePatientId;</span>
<span class="nc" id="L262">    }</span>

    public String getEndPoint() {
<span class="nc" id="L265">        return endPoint;</span>
    }

    public void setEndPoint(String endPoint) {
<span class="nc" id="L269">        this.endPoint = endPoint;</span>
<span class="nc" id="L270">    }</span>

    public String getPkbPatientId() {
<span class="nc" id="L273">        return pkbPatientId;</span>
    }

    public void setPkbPatientId(String pkbPatientId) {
<span class="nc" id="L277">        this.pkbPatientId = pkbPatientId;</span>
<span class="nc" id="L278">    }</span>

    public UserManager getUserManager() {
<span class="nc" id="L281">        return userManager;</span>
    }

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L285">        this.userManager = userManager;</span>
<span class="fc" id="L286">    }</span>

    public String getCoreDevicesCensoredJson() {
<span class="nc" id="L289">        return coreDevicesCensoredJson;</span>
    }

    public void setCoreDevicesCensoredJson(String coreDevicesCensoredJson) {
<span class="nc" id="L293">        this.coreDevicesCensoredJson = coreDevicesCensoredJson;</span>
<span class="nc" id="L294">    }</span>

    public String getSciStoreResultId() {
<span class="nc" id="L297">        return sciStoreResultId;</span>
    }

    public void setSciStoreResultId(String sciStoreResultId) {
<span class="nc" id="L301">        this.sciStoreResultId = sciStoreResultId;</span>
<span class="nc" id="L302">    }</span>

    public String getStackTrace() {
<span class="nc" id="L305">        return stackTrace;</span>
    }

    public void setStackTrace(String stackTrace) {
<span class="nc" id="L309">        this.stackTrace = stackTrace;</span>
<span class="nc" id="L310">    }</span>

    public String getPatientEmail() {
<span class="fc" id="L313">        return patientEmail;</span>
    }

    public void setPatientEmail(String patientEmail) {
<span class="fc" id="L317">        this.patientEmail = patientEmail;</span>
<span class="fc" id="L318">    }</span>

    public Integer getNumResults() {
<span class="fc" id="L321">        return numResults;</span>
    }

    public void setNumResults(Integer numResults) {
<span class="fc" id="L325">        this.numResults = numResults;</span>
<span class="fc" id="L326">    }</span>

    public DiagnosisManager getDiagnosisManager() {
<span class="nc" id="L329">        return diagnosisManager;</span>
    }

    public void setDiagnosisManager(DiagnosisManager diagnosisManager) {
<span class="fc" id="L333">        this.diagnosisManager = diagnosisManager;</span>
<span class="fc" id="L334">    }</span>

    public PKBPerson getPatient() {
<span class="nc" id="L337">        return patient;</span>
    }

    public void setPatient(PKBPerson patient) {
<span class="nc" id="L341">        this.patient = patient;</span>
<span class="nc" id="L342">    }</span>

    public RadiologyManager getRadiologyManager() {
<span class="nc" id="L345">        return radiologyManager;</span>
    }

    public void setRadiologyManager(RadiologyManager radiologyManager) {
<span class="fc" id="L349">        this.radiologyManager = radiologyManager;</span>
<span class="fc" id="L350">    }</span>

    public EncounterManager getEncounterManager() {
<span class="nc" id="L353">        return encounterManager;</span>
    }

    public void setEncounterManager(EncounterManager encounterManager) {
<span class="fc" id="L357">        this.encounterManager = encounterManager;</span>
<span class="fc" id="L358">    }</span>

    public PathologyReportManager getPathologyReportManager() {
<span class="nc" id="L361">        return pathologyReportManager;</span>
    }

    public void setPathologyReportManager(
            PathologyReportManager pathologyReportManager) {
<span class="fc" id="L366">        this.pathologyReportManager = pathologyReportManager;</span>
<span class="fc" id="L367">    }</span>

    public void setTestManager(TestManager testManager) {
<span class="fc" id="L370">        this.testManager = testManager;</span>
<span class="fc" id="L371">    }</span>

    public void setMeasurementManager(MeasurementManager measurementManager) {
<span class="fc" id="L374">        this.measurementManager = measurementManager;</span>
<span class="fc" id="L375">    }</span>

    public ITestDataGenerator getTestDataGenerator() {
<span class="nc" id="L378">        return testDataGenerator;</span>
    }

    public void setTestDataGenerator(ITestDataGenerator testDataGenerator) {
<span class="fc" id="L382">        this.testDataGenerator = testDataGenerator;</span>
<span class="fc" id="L383">    }</span>

    public TeamUserManager getTeamUserManager() {
<span class="nc" id="L386">        return teamUserManager;</span>
    }

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L390">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L391">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>