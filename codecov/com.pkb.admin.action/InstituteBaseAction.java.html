<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InstituteBaseAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.admin.action</a> &gt; <span class="el_source">InstituteBaseAction.java</span></div><h1>InstituteBaseAction.java</h1><pre class="source lang-java linenums">package com.pkb.admin.action;

import com.pkb.action.ConsentCategoryBaseAction;
import com.pkb.exception.PKBException;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import com.pkb.service.team.TeamManager;
import com.pkb.util.ImageUtil;
import com.pkb.util.PKBConstants;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;

import static java.lang.String.format;

<span class="fc" id="L21">class InstituteBaseAction extends ConsentCategoryBaseAction {</span>

<span class="fc" id="L23">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private static final int MAX_FILENAME_LENGTH = 100;

    protected TeamManager teamManager;

    /**
     * Validate image with respect to the length and valid extensions.
     */
    boolean validateImage(File file, String fileName, String fieldName)
            throws IOException {
<span class="fc bfc" id="L34" title="All 2 branches covered.">        if (file != null) {</span>
<span class="pc bpc" id="L35" title="1 of 2 branches missed.">            if (file.length() &lt;= 0) {</span>
<span class="nc" id="L36">                addActionError(getText(&quot;struts.messages.error.file.empty&quot;));</span>
<span class="nc" id="L37">                return false;</span>
            }
<span class="pc bpc" id="L39" title="1 of 2 branches missed.">            if (!ImageUtil.isBrowserImageByFilename(fileName)) {</span>
<span class="nc" id="L40">                addActionError(getText(&quot;composeMessage.filetype.invalid&quot;));</span>
<span class="nc" id="L41">                return false;</span>
            }
<span class="fc bfc" id="L43" title="All 2 branches covered.">            if (fileName.length() &gt; MAX_FILENAME_LENGTH) {</span>
<span class="fc" id="L44">                addActionError(getText(&quot;filename.too.long&quot;, new String[] { Integer.toString(MAX_FILENAME_LENGTH) }));</span>
<span class="fc" id="L45">                return false;</span>
            }
<span class="fc" id="L47">            byte[] content = getContents(file);</span>
<span class="pc bpc" id="L48" title="1 of 2 branches missed.">            if (content.length &gt; PKBConstants.MAX_ATTACHMENT_SIZE) {</span>
<span class="nc" id="L49">                addActionError(getText(&quot;attach.document.file.too.large&quot;, new String[] { fieldName }));</span>
<span class="nc" id="L50">                return false;</span>
            }
<span class="fc" id="L52">            uploadImage(file, fileName);</span>
        }
<span class="fc" id="L54">        return true;</span>
    }

    /**
     * Get the location of base directory and copy the physical content of the
     * image.
     */
    protected void uploadImage(File file, String imageName) throws IOException {
<span class="fc" id="L62">        Path imageUploadLogoDir = getImageUploadDirectory();</span>
<span class="fc" id="L63">        Path outFile = imageUploadLogoDir.resolve(imageName);</span>
<span class="fc" id="L64">        Files.deleteIfExists(outFile);</span>
<span class="fc" id="L65">        Files.copy(file.toPath(), outFile);</span>
<span class="fc" id="L66">    }</span>

    protected Path getImageUploadDirectory() throws IOException {
<span class="fc" id="L69">        Path imageUploadLogoDir = getConfig().getImageUploadLogoBaseDirectory();</span>
<span class="fc bfc" id="L70" title="All 2 branches covered.">        if (!Files.isDirectory(imageUploadLogoDir)) {</span>
            // todo: directory should be present and not created
            // throw new RuntimeException(&quot;Image upload directory '&quot; + imageUploadLogoDir + &quot;' does not exist&quot;);
<span class="fc" id="L73">            return Files.createDirectories(imageUploadLogoDir);</span>
        }
<span class="fc" id="L75">        return imageUploadLogoDir;</span>
    }

    /**
     * Get the location of base directory and delete the image.
     */
    protected void deleteImage(String imageName) throws IOException {
<span class="fc" id="L82">        Path imageUploadLogoDir = getImageUploadDirectory();</span>
<span class="fc" id="L83">        Path file = imageUploadLogoDir.resolve(imageName);</span>
<span class="fc" id="L84">        Files.delete(file);</span>
<span class="fc" id="L85">    }</span>

    protected String getHl7UploadSourceMap(Org org) {
        // force valid mappings, and format to CSV
<span class="fc" id="L89">        StringBuilder clean = new StringBuilder();</span>
<span class="fc" id="L90">        String trimmed = StringUtils.trimToEmpty(org.getHl7UploadSourceWhitelist());</span>
<span class="fc" id="L91">        String[] mappings = StringUtils.split(trimmed, &quot;,\t\r\n&quot;);</span>
<span class="fc bfc" id="L92" title="All 2 branches covered.">        for (String map : mappings) {</span>
            // make sure it's a valid mapping
<span class="fc" id="L94">            String[] aliasToSource = StringUtils.split(map, &quot;: &quot;);</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">            if (aliasToSource.length != 2) {</span>
<span class="nc" id="L96">                throw new PKBException(</span>
                        &quot;HL7 source alias invalid: must be formatted like ALIAS:org_ORGCODE or ALIAS:team_TEAMCODE: got &quot; + map);
            }
            // valid team/org code?
<span class="fc bfc" id="L100" title="All 2 branches covered.">            if (aliasToSource[1].startsWith(&quot;org_&quot;)) {</span>
<span class="fc" id="L101">                String orgCode = aliasToSource[1].substring(&quot;org_&quot;.length());</span>
<span class="fc" id="L102">                Org targetOrg = teamManager.getOrgByCode(orgCode).orElse(null);</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">                if (targetOrg == null) {</span>
<span class="fc" id="L104">                    throw new PKBException(&quot;HL7 source alias bad org code &quot; + orgCode + &quot; in mapping &quot; + map);</span>
                }
<span class="fc bfc" id="L106" title="All 2 branches covered.">                if (!targetOrg.equals(org)) {</span>
<span class="fc" id="L107">                    throw new PKBException(format(&quot;It is not possible to alias to a different organisation. &quot; +</span>
<span class="fc" id="L108">                                    &quot;Connecting org: %s, aliased org: %s&quot;, org.getCode(), targetOrg.getCode()));</span>
                }
<span class="pc bpc" id="L110" title="1 of 2 branches missed.">            } else if (aliasToSource[1].startsWith(&quot;team_&quot;)) {</span>
<span class="fc" id="L111">                String teamCode = aliasToSource[1].substring(&quot;team_&quot;.length());</span>
<span class="fc" id="L112">                Team targetTeam = teamManager.getTeamByCode(teamCode);</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">                if (targetTeam == null) {</span>
<span class="fc" id="L114">                    throw new PKBException(&quot;HL7 source alias bad team code &quot; + teamCode + &quot; in mapping &quot; + map);</span>
                }
<span class="fc bfc" id="L116" title="All 2 branches covered.">                if (!targetTeam.getOrg().equals(org)) {</span>
<span class="fc" id="L117">                    throw new PKBException(format(&quot;It is not possible to alias to a team in a different organisation. &quot; +</span>
                                    &quot;Connecting org: %s, org of aliased team: %s, aliased team: %s&quot;,
<span class="fc" id="L119">                            org.getCode(), targetTeam.getOrg().getCode(), targetTeam.getCode()));</span>
                }
<span class="fc" id="L121">            } else {</span>
<span class="nc" id="L122">                throw new PKBException(</span>
                        &quot;HL7 source alias invalid: must be formatted like ALIAS:org_ORGCODE or ALIAS:team_TEAMCODE; got &quot; + map);
            }

<span class="fc" id="L126">            clean.append(aliasToSource[0]).append(&quot;:&quot;).append(aliasToSource[1]).append(&quot;,&quot;);</span>
        }

<span class="fc" id="L129">        return StringUtils.chop(clean.toString()); // chop off trailing , if there is one</span>
    }

    public void setTeamManager(TeamManager teamManager) {
<span class="fc" id="L133">        this.teamManager = teamManager;</span>
<span class="fc" id="L134">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>