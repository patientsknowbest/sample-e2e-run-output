<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdminInstitutionAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.admin.action</a> &gt; <span class="el_source">AdminInstitutionAction.java</span></div><h1>AdminInstitutionAction.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------
//
// Copyright (c) 2009-2013 PatientsKnowBest, Inc. All Rights Reserved.
// $Id: AdminInstituteAction.java Feb 9, 2012 13:44:00 AM Ron$
//
//------------------------------------------------------------------------------
package com.pkb.admin.action;

import com.opensymphony.xwork2.Action;
import com.opensymphony.xwork2.ActionContext;
import com.pkb.action.BaseAction;
import com.pkb.common.api.error.accesstoken.AccessTokenRequestError;
import com.pkb.crypto.util.RandomUtil;
import com.pkb.datamodel.ApiAuthSession;
import com.pkb.datamodel.ApiClient;
import com.pkb.datamodel.ModifiableApiAuthSession;
import com.pkb.institute.entity.Team;
import com.pkb.service.team.TeamManager;
import com.pkb.service.user.impl.ApiAuthManager;
import io.vavr.control.Either;
import org.apache.commons.text.StringEscapeUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextImpl;

import java.util.Map;
import java.util.Optional;

import static com.pkb.datamodel.ApiAuthSession.LOOKUP_LENGTH;
import static com.pkb.datamodel.ApiAuthSession.SECRET_SEPARATOR;
import static com.pkb.entities.enums.api.ApiAuthSessionStatus.AUTHENTICATED;
import static com.pkb.entities.enums.api.ApiClientScope.SITE;
import static com.pkb.util.PKBWebUtil.SPRING_SECURITY_CONTEXT;

/**
 * This action is to list out all the clinicians associated with that particular institute.
 *
 * @author Ron Newman
 */
<span class="fc" id="L41">public class AdminInstitutionAction extends BaseAction {</span>

    private static final long serialVersionUID = 1L;
    public static final String NO_REFRESH = &quot;NO_REFRESH_TOKEN_REQUIRED&quot;;

    private TeamManager teamManager;

    private ApiAuthManager apiAuthManager;

    private String instituteCode;

    private String patientWelcomeText;

    private String patientTeamInformation;

    private String clinicianWelcomeText;

    private String patientMessageFooterText;

    private String patientMessageFooterHTML;

    private boolean sendSymptomReminders;

    private String apiClientId;

<span class="fc" id="L66">    private final String tab = &quot;institution&quot;;</span>

<span class="fc" id="L68">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    @Override
    public String execute() {
<span class="fc" id="L72">        Team team = teamManager.getTeam(getLoggedInEHRRequestContext().getTeamId().orElse(null));</span>

<span class="pc bpc" id="L74" title="1 of 2 branches missed.">        if (team != null) {</span>
            try {
<span class="fc" id="L76">                instituteCode = team.getCode();</span>
<span class="fc" id="L77">                patientWelcomeText = StringEscapeUtils.unescapeHtml4(team.getPatientWelcomeText());</span>
<span class="fc" id="L78">                patientTeamInformation = StringEscapeUtils.unescapeHtml4(team.getPatientTeamInformation());</span>
<span class="fc" id="L79">                clinicianWelcomeText = StringEscapeUtils.unescapeHtml4(team.getClinicianWelcomeText());</span>
<span class="fc" id="L80">                patientMessageFooterText = team.getPatientMessageFooterText();</span>
<span class="fc" id="L81">                patientMessageFooterHTML = team.getPatientMessageFooterHTML();</span>
<span class="fc" id="L82">                sendSymptomReminders = team.isSendSymptomReminders();</span>
<span class="nc" id="L83">            } catch (Exception e) {</span>
<span class="nc" id="L84">                LOGGER.error(&quot;Error while retrieving team&quot;, e);</span>
<span class="nc" id="L85">                addActionError(getText(&quot;err.institute.get.greeting&quot;));</span>
<span class="nc" id="L86">                return Action.SUCCESS;</span>
<span class="fc" id="L87">            }</span>
        }
<span class="fc" id="L89">        return Action.SUCCESS;</span>
    }

    public String save() {
        // this is the cached object: updating it below also updates the cache
<span class="fc" id="L94">        Team team = teamManager.getTeam(getLoggedInEHRRequestContext().getTeamId().orElse(null));</span>
        try {
<span class="fc" id="L96">            instituteCode = team.getCode();</span>

<span class="fc" id="L98">            teamManager.transactional(() -&gt; {</span>
<span class="fc" id="L99">                team.setPatientWelcomeText(patientWelcomeText);</span>
<span class="fc" id="L100">                team.setPatientTeamInformation(patientTeamInformation);</span>
<span class="fc" id="L101">                team.setClinicianWelcomeText(clinicianWelcomeText);</span>
<span class="fc" id="L102">                team.setPatientMessageFooterText(patientMessageFooterText);</span>
<span class="fc" id="L103">                team.setPatientMessageFooterHTML(patientMessageFooterHTML);</span>
<span class="fc" id="L104">                team.setSendSymptomReminders(sendSymptomReminders);</span>

<span class="fc" id="L106">                teamManager.updateTeam(team);</span>
<span class="fc" id="L107">            });</span>
<span class="nc" id="L108">        } catch (Exception e) {</span>
<span class="nc" id="L109">            LOGGER.error(&quot;Error while retrieving team&quot;, e);</span>
<span class="nc" id="L110">            addActionError(getText(&quot;err.institute.save.greeting&quot;));</span>
<span class="nc" id="L111">            return Action.SUCCESS;</span>
<span class="fc" id="L112">        }</span>
<span class="fc" id="L113">        addActionMessage(getText(&quot;success.institute.save.greeting&quot;));</span>
<span class="fc" id="L114">        return Action.SUCCESS;</span>
    }

    @Override
    public String input() {
<span class="nc" id="L119">        return Action.SUCCESS;</span>
    }

    public String cancel() {
<span class="nc" id="L123">        return Action.SUCCESS;</span>
    }

    public String generateRestApiTokens() {
<span class="fc" id="L127">        var apiClient = apiAuthManager.getApiClientByApiId(apiClientId);</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        if (apiClient.isEmpty()) {</span>
<span class="nc" id="L129">            addActionError(getText(&quot;err.api.id.invalid&quot;, new String[]{apiClientId}));</span>
<span class="nc" id="L130">            return SUCCESS; // refresh the page and display message</span>
        }
        // this could be compressed to one step; it'll just need a slightly more flexible backend...
        // session setup part #1: create

<span class="fc" id="L135">        var authSession = ModifiableApiAuthSession.create()</span>
<span class="fc" id="L136">                .setStatus(AUTHENTICATED)</span>
<span class="fc" id="L137">                .setSessionId(RandomUtil.randomString(LOOKUP_LENGTH))</span>
<span class="fc" id="L138">                .setApiClient(apiClient.get())</span>
<span class="fc" id="L139">                .setRedirectionEndpoint(&quot;n/a&quot;)</span>
<span class="fc" id="L140">                .setState(Optional.of(&quot;TeamCoordUI&quot;));</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">        if (apiClient.get().getScopesAllowed().contains(SITE)) {</span>
<span class="fc" id="L142">            authSession.setScope(SITE);</span>
        } else {
<span class="nc" id="L144">            throw new IllegalArgumentException(</span>
<span class="nc" id="L145">                    String.format(&quot;unsupported scope argument supplied by client-id [ %s ]. Valid values are: [SITE, TEAMCOORD]&quot;,</span>
<span class="nc" id="L146">                            apiClient.get().getApiId()));</span>
        }
<span class="fc" id="L148">        authSession.setState(Optional.of(&quot;TeamCoordUI&quot;));</span>

        // session setup part #2: save authentication and get auth code
<span class="fc" id="L151">        String password = &quot;&quot;;</span>
<span class="fc" id="L152">        Map&lt;String, Object&gt; sessionMap = ActionContext.getContext().getSession();</span>
        SecurityContextImpl securityContextImpl;
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">        if (sessionMap != null) {</span>
<span class="fc" id="L155">            securityContextImpl = (SecurityContextImpl) sessionMap.get(SPRING_SECURITY_CONTEXT);</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">            if (securityContextImpl != null) {</span>
<span class="fc" id="L157">                Authentication auth = securityContextImpl.getAuthentication();</span>
<span class="pc bpc" id="L158" title="1 of 2 branches missed.">                if (auth != null) {</span>
<span class="fc" id="L159">                    password = (String) auth.getCredentials();</span>
                }
            }
        }

<span class="fc" id="L164">        authSession.setPersonId(loggedInUserUtil.getLoggedInPerson().getId());</span>
<span class="fc" id="L165">        authSession.setPassword(password);</span>
<span class="fc" id="L166">        authSession.setAuthCodePart(RandomUtil.randomString(LOOKUP_LENGTH));</span>
<span class="fc" id="L167">        authSession.setStatus(AUTHENTICATED);</span>
<span class="fc" id="L168">        authSession.setAuthCodeIssued(dateTimeService.now());</span>

        // sets the new secret back into the session obj
<span class="fc" id="L171">        var updatedSession = apiAuthManager.updateAuthSession(authSession, ApiAuthManager.ReEncryptPassword.YES);</span>

        // session setup part #3: exchange auth code for access &amp; refresh tokens
<span class="fc" id="L174">        var authCode = updatedSession.getAuthCodePart()</span>
<span class="pc" id="L175">                .orElseThrow(() -&gt; new IllegalStateException(&quot;Missing auth code part&quot;))</span>
<span class="fc" id="L176">                + SECRET_SEPARATOR + updatedSession.getNewSecret()</span>
<span class="pc" id="L177">                .orElseThrow(() -&gt; new IllegalStateException(&quot;Missing new secret&quot;));</span>

<span class="fc" id="L179">        Either&lt;AccessTokenRequestError, ApiAuthSession&gt; sessionOrError = apiAuthManager.useAuthCode(apiClientId, authCode);</span>

<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        if (sessionOrError.isRight()) {</span>
<span class="fc" id="L182">            var authCodeUsedSession = ModifiableApiAuthSession.create().from(sessionOrError.get());</span>
            String refreshToken;
<span class="pc bpc" id="L184" title="1 of 2 branches missed.">            if (tokenIsRefreshable(authCodeUsedSession)) {</span>
<span class="nc" id="L185">                refreshToken = authCodeUsedSession.getRefreshTokenPart()</span>
<span class="nc" id="L186">                        .orElseThrow(() -&gt; new IllegalStateException(&quot;Missing refresh token part&quot;))</span>
<span class="nc" id="L187">                        + SECRET_SEPARATOR + authCodeUsedSession.getNewSecret()</span>
<span class="nc" id="L188">                        .orElseThrow(() -&gt; new IllegalStateException(&quot;Missing new secret&quot;));</span>
            } else {
<span class="fc" id="L190">                refreshToken = &quot;&quot;;</span>
            }

<span class="fc" id="L193">            String accessToken = authCodeUsedSession.getAccessTokenPart()</span>
<span class="pc" id="L194">                    .orElseThrow(() -&gt; new IllegalStateException(&quot;Missing access token part&quot;))</span>
<span class="fc" id="L195">                    + SECRET_SEPARATOR + authCodeUsedSession.getNewSecret()</span>
<span class="pc" id="L196">                    .orElseThrow(() -&gt; new IllegalStateException(&quot;Missing new secret&quot;));</span>

<span class="fc" id="L198">            String expires = &quot;&quot; + apiClient.get().getTokenExpirySeconds();</span>

<span class="pc bpc" id="L200" title="1 of 2 branches missed.">            if (getConfig().isDisplayOfSensitiveErrorInformationEnabled()) {</span>
<span class="fc" id="L201">                addActionMessage(getText(&quot;api.access.token&quot;, new String[]{accessToken, expires, refreshToken}));</span>
            } else {
<span class="nc" id="L203">                addActionMessage(getText(&quot;api.refresh.token&quot;, new String[]{refreshToken}));</span>
            }
<span class="fc" id="L205">            return Action.SUCCESS;</span>
        } else {
<span class="nc" id="L207">            LOGGER.error(&quot;Error obtaining auth session code: {} , desc.: {}&quot;, sessionOrError.getLeft().getErrorCode(), sessionOrError.getLeft().getDescription());</span>
<span class="nc" id="L208">            return Action.ERROR;</span>
        }
    }

    /**
     * LOGIC:
     * if token expiry is zero[infinite] =&gt; nonRefreshable [we shouldn't be doing this really] return false
     * if token expiry is greater than zero, then we need to be sure that token issue + token lifetime would still be
     * within the session lifetime unless the session is itself zero
     * otherwise return true
     *
     * @param authSession The auth session to check
     * @return a boolean indicating whether token is refreshable or not
     */
    public static boolean tokenIsRefreshable(ApiAuthSession authSession) {
        boolean refreshable;
<span class="fc" id="L224">        ApiClient client = authSession.getApiClient();</span>

<span class="pc bpc" id="L226" title="1 of 2 branches missed.">        if (client.hasTokenExpiry()) {</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (client.hasSessionExpiry()) {</span>
<span class="nc" id="L228">                long accessEnd = authSession.getAccessTokenIssued()</span>
<span class="nc" id="L229">                        .orElseThrow(() -&gt; new IllegalStateException(&quot;Missing time access token issued&quot;))</span>
<span class="nc" id="L230">                        .toEpochMilli() + (client.getTokenExpirySeconds() * 1000);</span>
<span class="nc" id="L231">                long sessionEnd = authSession.getAuthCodeIssued()</span>
<span class="nc" id="L232">                        .orElseThrow(() -&gt; new IllegalStateException(&quot;Missing time auth code issued&quot;))</span>
<span class="nc" id="L233">                        .toEpochMilli() + (client.getSessionExpirySeconds() * 1000);</span>
<span class="nc bnc" id="L234" title="All 2 branches missed.">                refreshable = sessionEnd &gt; accessEnd;</span>
<span class="nc" id="L235">            } else {</span>
<span class="nc" id="L236">                refreshable = true;</span>
            }
        } else {
<span class="fc" id="L239">            LOGGER.warn(&quot;API client {} seems to be set to issue access tokens that never expire. This is a security risk !!!&quot;,</span>
<span class="fc" id="L240">                    client.getApiId());</span>
<span class="fc" id="L241">            refreshable = false;</span>
        }
<span class="fc" id="L243">        return refreshable;</span>
    }

    public void setTeamManager(TeamManager teamManager) {
<span class="fc" id="L247">        this.teamManager = teamManager;</span>
<span class="fc" id="L248">    }</span>

    public String getNewPatientWelcomeText() {
<span class="nc" id="L251">        return patientWelcomeText;</span>
    }

    public void setPatientWelcomeText(String patientWelcomeText) {
<span class="fc" id="L255">        this.patientWelcomeText = patientWelcomeText;</span>
<span class="fc" id="L256">    }</span>

    public String getClinicianWelcomeText() {
<span class="fc" id="L259">        return clinicianWelcomeText;</span>
    }

    public void setClinicianWelcomeText(String clinicianWelcomeText) {
<span class="fc" id="L263">        this.clinicianWelcomeText = clinicianWelcomeText;</span>
<span class="fc" id="L264">    }</span>

    public String getPatientMessageFooterHTML() {
<span class="fc" id="L267">        return patientMessageFooterHTML;</span>
    }

    public void setPatientMessageFooterHTML(String patientMessageFooterHTML) {
<span class="fc" id="L271">        this.patientMessageFooterHTML = patientMessageFooterHTML;</span>
<span class="fc" id="L272">    }</span>

    public String getPatientMessageFooterText() {
<span class="fc" id="L275">        return patientMessageFooterText;</span>
    }

    public void setPatientMessageFooterText(String patientMessageFooterText) {
<span class="fc" id="L279">        this.patientMessageFooterText = patientMessageFooterText;</span>
<span class="fc" id="L280">    }</span>

    public String getTab() {
<span class="fc" id="L283">        return tab;</span>
    }

    public String getInstituteCode() {
<span class="nc" id="L287">        return instituteCode;</span>
    }

    public void setInstituteCode(String instituteCode) {
<span class="nc" id="L291">        this.instituteCode = instituteCode;</span>
<span class="nc" id="L292">    }</span>

    public boolean isSendSymptomReminders() {
<span class="fc" id="L295">        return sendSymptomReminders;</span>
    }

    public void setSendSymptomReminders(boolean sendSymptomReminders) {
<span class="fc" id="L299">        this.sendSymptomReminders = sendSymptomReminders;</span>
<span class="fc" id="L300">    }</span>

    public String getPatientWelcomeText() {
<span class="fc" id="L303">        return patientWelcomeText;</span>
    }

    public void setApiAuthManager(ApiAuthManager apiAuthManager) {
<span class="fc" id="L307">        this.apiAuthManager = apiAuthManager;</span>
<span class="fc" id="L308">    }</span>

    public String getApiClientId() {
<span class="nc" id="L311">        return apiClientId;</span>
    }

    public void setApiClientId(String apiClientId) {
<span class="fc" id="L315">        this.apiClientId = apiClientId;</span>
<span class="fc" id="L316">    }</span>

    public String getPatientTeamInformation() {
<span class="fc" id="L319">        return patientTeamInformation;</span>
    }

    public void setPatientTeamInformation(String patientTeamInformation) {
<span class="fc" id="L323">        this.patientTeamInformation = patientTeamInformation;</span>
<span class="fc" id="L324">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>