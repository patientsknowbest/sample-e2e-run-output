<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>InstituteLibraryAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.admin.action</a> &gt; <span class="el_source">InstituteLibraryAction.java</span></div><h1>InstituteLibraryAction.java</h1><pre class="source lang-java linenums">package com.pkb.admin.action;

import com.google.common.primitives.Longs;
import com.google.gson.Gson;
import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.action.library.LibraryUtil;
import com.pkb.action.library.ShowLibraryAction;
import com.pkb.institute.entity.InstituteLibraryEntry;
import com.pkb.institute.entity.Team;
import com.pkb.service.institutelibraryentry.InstituteLibraryEntryManager;
import com.pkb.service.storage.IStorageService;
import com.pkb.service.team.TeamManager;
import org.apache.struts2.dispatcher.multipart.MultiPartRequestWrapper;
import org.apache.struts2.dispatcher.multipart.UploadedFile;
import org.jetbrains.annotations.Nullable;

import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.Comparator;
import java.util.EnumMap;
import java.util.LinkedHashMap;
import java.util.List;
import java.util.ListIterator;
import java.util.Map;
import java.util.Optional;
import java.util.UUID;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

import static com.pkb.action.library.ShowLibraryAction.ADMIN_REFERER;
import static com.pkb.institute.entity.Team.Lazy.LIBRARY;
import static org.apache.commons.lang3.StringUtils.isEmpty;
import static org.apache.commons.lang3.StringUtils.isNotBlank;

<span class="fc" id="L40">public class InstituteLibraryAction extends BaseAction {</span>

    private static final long serialVersionUID = 1L;
<span class="fc" id="L43">    private static final Pattern ENTRIES_PATTERN = Pattern.compile(&quot;::&quot;);</span>
<span class="fc" id="L44">    private static final Pattern DASH_PATTERN = Pattern.compile(&quot;-&quot;, Pattern.LITERAL);</span>
    private static final long DEFAULT_HIGHEST_LIB_ENTRY_POSITION = 100L;

    private List&lt;InstituteLibraryEntry&gt; libraryEntries;
    private TeamManager teamManager;
    private String newDescription;
    private String newUrl;
    private String instituteCode;
<span class="fc" id="L52">    private int editingId = -1;</span>
    private Long parentId;
<span class="fc" id="L54">    private String tab = &quot;library&quot;;</span>
    private String editedDescription;
    private String editedUrl;
<span class="fc" id="L57">    private int deleteId = -1;</span>
    private String folderId;
    private String folderName;
    private String tkid;//db id of an ILE
    private InputStream deleteStream;
    private InputStream addEntryStream;
    private InputStream updatePositionStream;
    private InputStream fileUploadStream;
<span class="fc" id="L65">    private LinkedHashMap&lt;String, String&gt; crumbs = new LinkedHashMap&lt;&gt;();</span>
    private String namespace;
    private String referer;
    private IStorageService storageService;
    private InstituteLibraryEntryManager instituteLibraryEntryManager;

    public List&lt;InstituteLibraryEntry&gt; getLibraryEntries() {
<span class="fc" id="L72">        return libraryEntries;</span>
    }

    public void setLibraryEntries(List&lt;InstituteLibraryEntry&gt; libraryEntries) {
<span class="nc" id="L76">        this.libraryEntries = libraryEntries;</span>
<span class="nc" id="L77">    }</span>

    public String getNewDescription() {
<span class="nc" id="L80">        return newDescription;</span>
    }

    public void setNewDescription(String newDescription) {
<span class="nc" id="L84">        this.newDescription = newDescription;</span>
<span class="nc" id="L85">    }</span>

    public String getNewUrl() {
<span class="nc" id="L88">        return newUrl;</span>
    }

    public void setNewUrl(String newUrl) {
<span class="nc" id="L92">        this.newUrl = newUrl;</span>
<span class="nc" id="L93">    }</span>

    public int getEditingId() {
<span class="fc" id="L96">        return editingId;</span>
    }

    public void setEditingId(int editingIndex) {
<span class="fc" id="L100">        this.editingId = editingIndex;</span>
<span class="fc" id="L101">    }</span>

    public IStorageService getStorageService() {
<span class="nc" id="L104">        return storageService;</span>
    }

    public void setStorageService(IStorageService storageService) {
<span class="fc" id="L108">        this.storageService = storageService;</span>
<span class="fc" id="L109">    }</span>

    public int getDeleteId() {
<span class="fc" id="L112">        return deleteId;</span>
    }

    public void setDeleteId(int deleteId) {
<span class="fc" id="L116">        this.deleteId = deleteId;</span>
<span class="fc" id="L117">    }</span>

    public String getEditedDescription() {
<span class="nc" id="L120">        return editedDescription;</span>
    }

    public void setEditedDescription(String editedDescription) {
<span class="fc" id="L124">        this.editedDescription = editedDescription;</span>
<span class="fc" id="L125">    }</span>

    public String getEditedUrl() {
<span class="nc" id="L128">        return editedUrl;</span>
    }

    public void setEditedUrl(String editedUrl) {
<span class="fc" id="L132">        this.editedUrl = editedUrl;</span>
<span class="fc" id="L133">    }</span>

    public Long getParentId() {
<span class="nc" id="L136">        return parentId;</span>
    }

    public void setParentId(Long parentId) {
<span class="nc" id="L140">        this.parentId = parentId;</span>
<span class="nc" id="L141">    }</span>

    public String getFolderId() {
<span class="fc" id="L144">        return folderId;</span>
    }

    public void setFolderId(String folderId) {
<span class="fc" id="L148">        this.folderId = folderId;</span>
<span class="fc" id="L149">    }</span>

    public String getFolderName() {
<span class="fc" id="L152">        return folderName;</span>
    }

    public void setFolderName(String folderName) {
<span class="fc" id="L156">        this.folderName = folderName;</span>
<span class="fc" id="L157">    }</span>

    public String getTkid() {
<span class="fc" id="L160">        return tkid;</span>
    }

    public void setTkid(String tkid) {
<span class="fc" id="L164">        this.tkid = tkid;</span>
<span class="fc" id="L165">    }</span>

    public String getTab() {
<span class="fc" id="L168">        return tab;</span>
    }

    public void setTab(String tab) {
<span class="fc" id="L172">        this.tab = tab;</span>
<span class="fc" id="L173">    }</span>

    public Map&lt;String, String&gt; getCrumbs() {
<span class="fc" id="L176">        return crumbs;</span>
    }

    public void setCrumbs(LinkedHashMap&lt;String, String&gt; crumbs) {
<span class="nc" id="L180">        this.crumbs = crumbs;</span>
<span class="nc" id="L181">    }</span>

    public String getNamespace() {
<span class="nc" id="L184">        return namespace;</span>
    }

    public void setNamespace(String namespace) {
<span class="nc" id="L188">        this.namespace = namespace;</span>
<span class="nc" id="L189">    }</span>

    public String getReferer() {
<span class="fc" id="L192">        return referer;</span>
    }

    public void setReferer(String referer) {
<span class="fc" id="L196">        this.referer = referer;</span>
<span class="fc" id="L197">    }</span>

    public InputStream getAddEntryStream() {
<span class="nc" id="L200">        return addEntryStream;</span>
    }

    public InputStream getDeleteStream() {
<span class="nc" id="L204">        return deleteStream;</span>
    }

    public String getInstituteCode() {
<span class="fc" id="L208">        return instituteCode;</span>
    }

    public void setInstituteCode(String instituteCode) {
<span class="fc" id="L212">        this.instituteCode = instituteCode;</span>
<span class="fc" id="L213">    }</span>

    public TeamManager getTeamManager() {
<span class="fc" id="L216">        return teamManager;</span>
    }

    public void setTeamManager(TeamManager teamManager) {
<span class="fc" id="L220">        this.teamManager = teamManager;</span>
<span class="fc" id="L221">    }</span>

    public InstituteLibraryEntryManager getInstituteLibraryEntryManager() {
<span class="nc" id="L224">        return instituteLibraryEntryManager;</span>
    }

    public void setInstituteLibraryEntryManager(InstituteLibraryEntryManager instituteLibraryEntryManager) {
<span class="fc" id="L228">        this.instituteLibraryEntryManager = instituteLibraryEntryManager;</span>
<span class="fc" id="L229">    }</span>

    public String getDeleteConfirmation() {
<span class="fc" id="L232">        return INPUT;</span>
    }

    public InputStream getUpdatePositionStream() {
<span class="fc" id="L236">        return updatePositionStream;</span>
    }

    public InputStream getFileUploadStream() {
<span class="fc" id="L240">        return fileUploadStream;</span>
    }

    public void setFileUploadStream(InputStream fileUploadStream) {
<span class="nc" id="L244">        this.fileUploadStream = fileUploadStream;</span>
<span class="nc" id="L245">    }</span>

    /**
     * default method for editLibraryAction. usually called before library.jsp is displayed.
     * responsible for setting parentId and editingId
     * the context is determined by the &quot;root&quot; of the query
     *
     * @return struts result
     */
    @Override
    public String input() {

        //get team
<span class="fc" id="L258">        Team team = getInstituteFromCache();</span>

        //create room for library entries after filters have been applied
<span class="fc" id="L261">        List&lt;InstituteLibraryEntry&gt; filteredEntries = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L262">        Long folderContext = getFolderContext();</span>

        //first check if we are in edit mode.

<span class="fc bfc" id="L266" title="All 2 branches covered.">        if (isInEditMode()) { //EDIT MODE</span>

            //PIN edit ID to ensure we maintain folderContext
<span class="fc" id="L269">            InstituteLibraryEntry entry = instituteLibraryEntryManager.getLibraryEntryById(editingId);</span>

<span class="fc bfc" id="L271" title="All 2 branches covered.">            if (entry.getParentId() == null) { //ROOT Context</span>

<span class="fc" id="L273">                filteredEntries</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">                        .addAll(team.getLibraryEntries().stream().filter(e -&gt; e.getParentId() == null).collect(Collectors.toList()));</span>

            } else {

<span class="fc" id="L278">                this.parentId = entry.getParentId();</span>

<span class="fc" id="L280">                filteredEntries.addAll(team.getLibraryEntries().stream()</span>
<span class="fc bfc" id="L281" title="All 4 branches covered.">                        .filter(e -&gt; (e.getParentId() != null) &amp;&amp; e.getParentId().equals(this.parentId)).collect(Collectors.toList()));</span>
            }

<span class="fc" id="L284">        } else { //READ-ONLY MODE</span>

            //if no technical id was specified then assume folderContext to be : library root

<span class="fc bfc" id="L288" title="All 2 branches covered.">            if (folderContext == null) {</span>

<span class="fc" id="L290">                this.parentId = null;</span>

                //filter only for elements with no parents -&gt; root
<span class="fc" id="L293">                filteredEntries.addAll(</span>
<span class="fc bfc" id="L294" title="All 2 branches covered.">                        team.getLibraryEntries().stream().filter(entry -&gt; entry.getParentId() == null).collect(Collectors.toList()));</span>
            } else { //get only elements with same context -&gt; siblings

<span class="fc" id="L297">                filteredEntries.addAll(team.getLibraryEntries().stream()</span>
<span class="fc bfc" id="L298" title="All 4 branches covered.">                        .filter(entry -&gt; (entry.getParentId() != null) &amp;&amp; entry.getParentId().equals(folderContext))</span>
<span class="fc" id="L299">                        .collect(Collectors.toList()));</span>

            }

        }

        //update library entries with filtered options
<span class="fc" id="L306">        this.libraryEntries = filteredEntries;</span>

<span class="fc" id="L308">        checkIfCurrentIsEmployee();</span>
<span class="fc" id="L309">        updateCrumbs();</span>

<span class="fc" id="L311">        return Action.INPUT;</span>
    }

    private void checkIfCurrentIsEmployee() {
<span class="pc bpc" id="L315" title="1 of 2 branches missed.">        if (this.getEHRRequestContext().getMaybeAccessingUser().map(user -&gt; user.isEmployee()).orElse(false)) {</span>
<span class="nc" id="L316">            this.referer = ShowLibraryAction.EMPLOYEE_REFERER;</span>
        }
<span class="fc" id="L318">    }</span>

    /**
     * updates bread crumbs
     * bread crumbs should only be shown from
     */
    private void updateCrumbs() {

<span class="pc bpc" id="L326" title="1 of 2 branches missed.">        if (crumbs == null) {</span>
<span class="nc" id="L327">            crumbs = new LinkedHashMap&lt;&gt;();</span>
        }

<span class="fc" id="L330">        crumbs.clear();</span>

<span class="fc bfc" id="L332" title="All 2 branches covered.">        if (isNotBlank(tkid)) {</span>
<span class="fc" id="L333">            boolean isNotRoot = true;</span>
<span class="fc" id="L334">            InstituteLibraryEntry current = instituteLibraryEntryManager.getLibraryEntryById(Longs.tryParse(splitString(tkid, null, null)));</span>

<span class="fc bfc" id="L336" title="All 2 branches covered.">            while (isNotRoot) {</span>
<span class="fc" id="L337">                this.crumbs.put(current.getDescription(), LibraryUtil.buildLibraryFolderURL(current, ADMIN_REFERER));</span>

<span class="fc bfc" id="L339" title="All 2 branches covered.">                if (current.getParentId() == null) {</span>
<span class="fc" id="L340">                    isNotRoot = false;</span>
                } else {
<span class="fc" id="L342">                    current = instituteLibraryEntryManager.getLibraryEntryById(current.getParentId());</span>
                }
            }
        }

<span class="fc" id="L347">        crumbs = reverse(crumbs);</span>
<span class="fc" id="L348">    }</span>

    public static LinkedHashMap&lt;String, String&gt; reverse(@SuppressWarnings(&quot;CollectionDeclaredAsConcreteClass&quot;) LinkedHashMap&lt;String, String&gt; map) {

<span class="fc" id="L352">        LinkedHashMap&lt;String, String&gt; reverse = new LinkedHashMap&lt;&gt;();</span>
<span class="fc" id="L353">        ListIterator&lt;Map.Entry&lt;String, String&gt;&gt; iterator = new ArrayList&lt;&gt;(map.entrySet()).listIterator(map.size());</span>

<span class="fc bfc" id="L355" title="All 2 branches covered.">        while (iterator.hasPrevious()) {</span>
<span class="fc" id="L356">            Map.Entry&lt;String, String&gt; entry = iterator.previous();</span>
<span class="fc" id="L357">            reverse.put(entry.getKey(), entry.getValue());</span>
<span class="fc" id="L358">        }</span>

<span class="fc" id="L360">        return reverse;</span>
    }

    //returns the context withing which the page must be loaded
    private Long getFolderContext() {

<span class="fc bfc" id="L366" title="All 2 branches covered.">        if (this.tkid == null) {</span>
<span class="fc" id="L367">            return null;</span>
        } else {
<span class="fc" id="L369">            return Longs.tryParse(splitString(this.tkid, null, null));</span>
        }
    }

    //-1 implies read-only mode. any other value implies edit mode
    protected boolean isInEditMode() {
<span class="fc bfc" id="L375" title="All 2 branches covered.">        return editingId != -1;</span>
    }

    public String cancelDelete() {
<span class="nc" id="L379">        return &quot;cancel&quot;;</span>
    }

    /**
     * adds capability to delete multiple links/folders or other media
     * for folders, all child entries are *recursively* deleted as well.
     *
     * @return success string
     */
    public String multipleDelete() throws IOException {

        //todo: degrade multiple items delete to single-item for now
        //final String[] itemIndexes = this.request.getParameter(&quot;itemIndexes&quot;).split(&quot;::&quot;);
<span class="fc" id="L392">        String[] itemIndexes = new String[] { Integer.toString(deleteId) };</span>

<span class="fc" id="L394">        instituteLibraryEntryManager.transactional(() -&gt; {</span>
            //for each item selected in front-end
<span class="fc bfc" id="L396" title="All 2 branches covered.">            for (String item : itemIndexes) {</span>

                //split array into institute code and itemIndex
<span class="fc" id="L399">                Long itemIndex = Long.parseLong(item);</span>

                //get the specified entry
<span class="fc" id="L402">                InstituteLibraryEntry entry = instituteLibraryEntryManager.getLibraryEntryById(itemIndex);</span>

                try {
<span class="fc" id="L405">                    deleteFiles(entry);</span>
<span class="nc" id="L406">                } catch (IOException e) {</span>
<span class="nc" id="L407">                    throw new RuntimeException(e);</span>
<span class="fc" id="L408">                }</span>

                // Deleting any child items is handled by hibernate
<span class="fc" id="L411">                instituteLibraryEntryManager.deleteLibraryEntry(itemIndex);</span>
            }

<span class="fc" id="L414">            deleteStream = new ByteArrayInputStream(&quot;{'message': 'Library entries deleted'}&quot;.getBytes());</span>
<span class="fc" id="L415">        });</span>
<span class="fc" id="L416">        return SUCCESS;</span>
    }

    private void deleteFiles(InstituteLibraryEntry entry) throws IOException {

<span class="pc bpc" id="L421" title="1 of 2 branches missed.">        if (entry.getContentType() != null) {</span>

<span class="fc bfc" id="L423" title="All 2 branches covered.">            if (entry.getContentType() == InstituteLibraryEntry.ContentType.FOLDER) {</span>

<span class="fc" id="L425">                List&lt;InstituteLibraryEntry&gt; entries = instituteLibraryEntryManager.getLibraryEntryChildrenById(entry.getId());</span>

<span class="fc" id="L427">                entries.stream()</span>
<span class="pc bpc" id="L428" title="2 of 4 branches missed.">                        .filter(e2 -&gt; (e2.getContentType() != null) &amp;&amp; e2.getContentType() == InstituteLibraryEntry.ContentType.MEDIA)</span>
<span class="fc" id="L429">                        .forEach(e2 -&gt; {</span>
<span class="nc" id="L430">                            storageService.removeResource(getKeyFromUrl(e2.getUrl()));</span>
<span class="nc" id="L431">                        });</span>

                //delete folder????? todo: is this necesary?
<span class="fc" id="L434">                storageService.removeResource(entry.getUrl());</span>

<span class="pc bpc" id="L436" title="1 of 2 branches missed.">            } else if (entry.getContentType() == InstituteLibraryEntry.ContentType.MEDIA) {</span>

<span class="nc" id="L438">                storageService.removeResource(getKeyFromUrl(entry.getUrl()));</span>

            }
        }
<span class="fc" id="L442">    }</span>

    /**
     * splits a url using the slash as a de-limiter
     * the key is the last element
     *
     * @param url
     *            string url
     * @return returns s3 key
     */
    private String getKeyFromUrl(String url) {

<span class="nc bnc" id="L454" title="All 2 branches missed.">        assert url != null;</span>
<span class="nc bnc" id="L455" title="All 2 branches missed.">        assert !url.isEmpty();</span>

<span class="nc" id="L457">        String[] tokens = url.split(&quot;/&quot;);</span>
<span class="nc" id="L458">        return tokens[tokens.length - 1];</span>
    }

    protected Team getInstituteFromCache() {

<span class="fc bfc" id="L463" title="All 2 branches covered.">        if (this.instituteCode == null) {</span>
<span class="fc" id="L464">            this.instituteCode = loggedInUserUtil.getLoggedInUserPrimaryTeam().getCode();</span>
        }

<span class="fc" id="L467">        return teamManager.getTeamByCode(this.instituteCode, LIBRARY);</span>
    }

    /**
     * parse ajax request string and return one line per row in HTML table
     *
     * @return array of entry positions
     */
    protected String[] getEntriesFromRequest() {

<span class="fc" id="L477">        String links = this.request.getParameter(&quot;links&quot;);</span>

<span class="pc bpc" id="L479" title="2 of 4 branches missed.">        if ((links != null) &amp;&amp; !links.isEmpty()) {</span>
<span class="fc" id="L480">            return ENTRIES_PATTERN.split(links);</span>
        } else {
<span class="nc" id="L482">            return new String[0];</span>
        }
    }

    /**
     * updates the position of an entry
     * assumes all entries are on a single page
     * input is supplied as concat string
     *
     * @return action status
     */
    public String updatePosition() {

<span class="fc" id="L495">        String[] items = getEntriesFromRequest();</span>
<span class="fc" id="L496">        Team team = getInstituteFromCache();</span>
<span class="fc" id="L497">        TeamManager db = getTeamManager();</span>

<span class="pc bpc" id="L499" title="1 of 2 branches missed.">        if (items.length &gt; 0) {</span>
<span class="fc" id="L500">            teamManager.transactional(() -&gt; {</span>
<span class="fc bfc" id="L501" title="All 2 branches covered.">                for (String item : items) {</span>

<span class="fc" id="L503">                    InstituteLibraryEntry entry = null;</span>

<span class="fc" id="L505">                    String[] arrEntry = item.split(&quot;,&quot;);</span>

<span class="pc bpc" id="L507" title="1 of 2 branches missed.">                    for (InstituteLibraryEntry libEntry : team.getLibraryEntries()) {</span>
<span class="fc bfc" id="L508" title="All 2 branches covered.">                        if (libEntry.getId().equals(Long.parseLong(arrEntry[2]))) {</span>
<span class="fc" id="L509">                            entry = libEntry;</span>
<span class="fc" id="L510">                            break;</span>
                        }
<span class="fc" id="L512">                    }</span>
<span class="pc bpc" id="L513" title="1 of 2 branches missed.">                    if (entry != null) {</span>
                        //remove then re-add in order to preserve correct sorting:
<span class="fc" id="L515">                        team.getLibraryEntries().remove(entry);</span>
<span class="fc" id="L516">                        entry.setPosition(Long.parseLong(arrEntry[0]));</span>
<span class="fc" id="L517">                        instituteLibraryEntryManager.updateLibraryEntry(entry);</span>
<span class="fc" id="L518">                        team.getLibraryEntries().add(entry);</span>
                    }

<span class="fc" id="L521">                    db.updateTeam(team);</span>
                }
<span class="fc" id="L523">                updatePositionStream = new ByteArrayInputStream(&quot;{'message': 'Library entry position updated'}&quot;.getBytes());</span>
<span class="fc" id="L524">            });</span>
        }

<span class="fc" id="L527">        return SUCCESS;</span>
    }

    /**
     * adds new Library entry
     * enhanced to handle folders and media in addition to links
     *
     * @return struts action result
     */
    public String add() {

        boolean isValid;

<span class="fc" id="L540">        Map&lt;LibValues, String&gt; values = new EnumMap&lt;&gt;(LibValues.class);</span>
<span class="fc" id="L541">        String desc = this.request.getParameter(&quot;desc&quot;);</span>
<span class="fc" id="L542">        String url = this.request.getParameter(&quot;url&quot;);</span>
<span class="fc" id="L543">        String contentType = this.request.getParameter(&quot;contentType&quot;);</span>
<span class="fc" id="L544">        String folderName = this.request.getParameter(&quot;folderName&quot;);</span>
<span class="fc" id="L545">        String parentId = this.request.getParameter(&quot;tkid&quot;);</span>

<span class="fc" id="L547">        long highestPosition = getHighestLibraryEntryPosition();</span>

<span class="fc" id="L549">        values.put(LibValues.URL, url);</span>
<span class="fc" id="L550">        values.put(LibValues.DESC, desc);</span>
<span class="fc" id="L551">        values.put(LibValues.CONTENT_TYPE, contentType);</span>
<span class="fc" id="L552">        values.put(LibValues.FOLDER_NAME, folderName);</span>
<span class="fc" id="L553">        values.put(LibValues.PARENT_ID, parentId);</span>
<span class="fc" id="L554">        values.put(LibValues.POSITION, Long.toString(highestPosition));</span>

<span class="pc bpc" id="L556" title="2 of 4 branches missed.">        if ((values.get(LibValues.URL) == null) || values.get(LibValues.URL).isEmpty()) {</span>

<span class="nc" id="L558">            addFieldError(&quot;newUrl&quot;, getText(&quot;library.url.required&quot;));</span>
<span class="nc" id="L559">            isValid = false;</span>

        } else {

<span class="fc" id="L563">            isValid = createLibraryEntry(values);</span>

        }

<span class="fc" id="L567">        setAddEntryStream(isValid);</span>

<span class="fc" id="L569">        return SUCCESS;</span>
    }

    private long getHighestLibraryEntryPosition() {
<span class="fc" id="L573">        return getInstituteFromCache()</span>
<span class="fc" id="L574">                .getLibraryEntries()</span>
<span class="fc" id="L575">                .stream()</span>
<span class="fc" id="L576">                .map(InstituteLibraryEntry::getPosition)</span>
<span class="pc bpc" id="L577" title="1 of 2 branches missed.">                .filter(p -&gt; p != null)</span>
<span class="fc" id="L578">                .max(Comparator.naturalOrder())</span>
<span class="fc" id="L579">                .map(foundMax -&gt; foundMax + 1)</span>
<span class="fc" id="L580">                .orElse(DEFAULT_HIGHEST_LIB_ENTRY_POSITION);</span>
    }

    private boolean setAddEntryStream(boolean isValid) {
        String resultStr;
<span class="fc" id="L585">        Gson result = new Gson();</span>

<span class="pc bpc" id="L587" title="1 of 2 branches missed.">        if (isValid) {</span>
<span class="fc" id="L588">            resultStr = result.toJson(&quot;result [outcome='SUCCESS']&quot;);</span>

<span class="fc" id="L590">            addEntryStream = new ByteArrayInputStream(resultStr.getBytes());</span>
        } else {
<span class="nc" id="L592">            resultStr = result.toJson(&quot;result [outcome='FAILURE',&quot; + getFieldErrors() + &quot;])&quot;);</span>

<span class="nc" id="L594">            addEntryStream = new ByteArrayInputStream(resultStr.getBytes());</span>
        }

<span class="fc" id="L597">        return isValid;</span>
    }

    public String save() {
<span class="fc" id="L601">        InstituteLibraryEntry entry = instituteLibraryEntryManager.getLibraryEntryById(editingId);</span>
<span class="pc bpc" id="L602" title="1 of 4 branches missed.">        if (entry.isLink() &amp;&amp; isEmpty(editedUrl)) {</span>
<span class="nc" id="L603">            addFieldError(&quot;editedItem&quot;, getText(&quot;library.url.required&quot;));</span>
        }
<span class="fc bfc" id="L605" title="All 2 branches covered.">        if (isEmpty(editedDescription)) {</span>
<span class="fc" id="L606">            addFieldError(&quot;editedItem&quot;, getText(&quot;library.description.required&quot;));</span>
        }

<span class="fc bfc" id="L609" title="All 2 branches covered.">        if (!hasFieldErrors()) {</span>
<span class="fc" id="L610">            entry.setDescription(editedDescription);</span>
<span class="fc" id="L611">            entry.setPosition(0L); // move up to the first place</span>
<span class="fc bfc" id="L612" title="All 2 branches covered.">            if (entry.isLink()) {</span>
<span class="fc" id="L613">                entry.setUrl(editedUrl);</span>
            }
<span class="fc" id="L615">            instituteLibraryEntryManager.updateLibraryEntry(entry);</span>

<span class="fc" id="L617">            libraryEntries = new ArrayList&lt;&gt;(teamManager.getTeamByCode(instituteCode, LIBRARY).getLibraryEntries());</span>
<span class="fc" id="L618">            editingId = -1;</span>
        }

<span class="fc" id="L621">        input();</span>
<span class="pc bpc" id="L622" title="1 of 2 branches missed.">        if (instituteCode == null) {</span>
<span class="nc" id="L623">            instituteCode = loggedInUserUtil.getLoggedInUserPrimaryTeam().getCode();</span>
        }
<span class="fc" id="L625">        return SUCCESS;</span>
    }

    private boolean createLibraryEntry(Map&lt;LibValues, String&gt; input) {

<span class="fc" id="L630">        boolean isValid = true;</span>

<span class="fc" id="L632">        String newUrl = input.get(LibValues.URL);</span>
<span class="fc" id="L633">        String newDescription = input.get(LibValues.DESC);</span>
<span class="fc" id="L634">        String contentType = input.get(LibValues.CONTENT_TYPE);</span>
<span class="fc" id="L635">        String folderName = input.get(LibValues.FOLDER_NAME);</span>
<span class="fc" id="L636">        String position = input.get(LibValues.POSITION);</span>
<span class="fc" id="L637">        InstituteLibraryEntry.ContentType content = InstituteLibraryEntry.ContentType.valueOf(contentType.toUpperCase());</span>

<span class="pc bnc" id="L639" title="All 2 branches missed.">        assert newUrl != null;</span>

<span class="fc bfc" id="L641" title="All 2 branches covered.">        if (content == InstituteLibraryEntry.ContentType.FOLDER) {</span>

            //for folders auto-generate a link
<span class="fc" id="L644">            String folderID = UUID.randomUUID().toString();</span>

<span class="fc" id="L646">            newUrl += (&quot;?folderName=&quot; + folderName + &quot;&amp;folderId=&quot; + folderID);</span>

        }

<span class="pc bpc" id="L650" title="2 of 4 branches missed.">        if ((newDescription == null) || newDescription.isEmpty()) {</span>
<span class="nc" id="L651">            addFieldError(&quot;newDescription&quot;, getText(&quot;library.description.required&quot;));</span>
<span class="nc" id="L652">            isValid = false;</span>
        }

<span class="pc bpc" id="L655" title="1 of 2 branches missed.">        if (isValid) {</span>
<span class="fc" id="L656">            InstituteLibraryEntry newEntry = new InstituteLibraryEntry();</span>

<span class="fc" id="L658">            newEntry.setDescription(newDescription);</span>
<span class="fc" id="L659">            newEntry.setUrl(newUrl);</span>
<span class="pc bpc" id="L660" title="1 of 2 branches missed.">            if (position != null) {</span>
<span class="fc" id="L661">                newEntry.setPosition(Long.parseLong(position));</span>
            } else {
<span class="nc" id="L663">                newEntry.setPosition(DEFAULT_HIGHEST_LIB_ENTRY_POSITION);</span>
            }

<span class="fc bfc" id="L666" title="All 4 branches covered.">            switch (content) {</span>
            case FOLDER:
<span class="fc" id="L668">                newEntry.setContentType(InstituteLibraryEntry.ContentType.FOLDER);</span>
<span class="fc" id="L669">                break;</span>
            case FILE:
<span class="fc" id="L671">                newEntry.setContentType(InstituteLibraryEntry.ContentType.FILE);</span>
<span class="fc" id="L672">                break;</span>
            case MEDIA:
<span class="fc" id="L674">                newEntry.setContentType(InstituteLibraryEntry.ContentType.MEDIA);</span>
<span class="fc" id="L675">                break;</span>
            default:
<span class="fc" id="L677">                newEntry.setContentType(InstituteLibraryEntry.ContentType.LINK);</span>
            }

<span class="fc" id="L680">            String parentId = splitString(input.get(LibValues.PARENT_ID), null, null);</span>

<span class="pc bpc" id="L682" title="1 of 4 branches missed.">            if ((parentId != null) &amp;&amp; !parentId.trim().isEmpty()) {</span>
<span class="fc" id="L683">                newEntry.setParentId(Long.parseLong(parentId.trim()));</span>
            }
<span class="fc" id="L685">            teamManager.transactional(() -&gt; {</span>
<span class="fc" id="L686">                Team team = getInstituteFromCache();</span>
<span class="fc" id="L687">                newEntry.setInstitute(team);</span>
<span class="fc" id="L688">                instituteLibraryEntryManager.createLibraryEntry(newEntry);</span>
<span class="fc" id="L689">                team.addLibraryEntry(newEntry);</span>
<span class="fc" id="L690">                teamManager.updateTeam(team);</span>
<span class="fc" id="L691">                libraryEntries = new ArrayList&lt;&gt;(team.getLibraryEntries());</span>
<span class="fc" id="L692">            });</span>
        }

<span class="fc" id="L695">        return setAddEntryStream(isValid);</span>
    }

    /**
     * processes uploaded by copying to designated destination folder
     *
     * @return string as success
     * @throws IOException
     */
    public String uploadFiles() throws IOException {

<span class="fc" id="L706">        MultiPartRequestWrapper mp = (MultiPartRequestWrapper) this.request;</span>

<span class="fc" id="L708">        UploadedFile[] files = mp.getFiles(&quot;uploadFiles&quot;);</span>
<span class="fc" id="L709">        String[] fileNames = mp.getFileNames(&quot;uploadFiles&quot;);</span>
<span class="fc" id="L710">        String[] contentTypes = mp.getContentTypes(&quot;uploadFiles&quot;);</span>
<span class="fc" id="L711">        int index = 0;</span>
<span class="fc" id="L712">        long highestPosition = getHighestLibraryEntryPosition();</span>
<span class="fc bfc" id="L713" title="All 2 branches covered.">        for (UploadedFile uploadedFile : files) {</span>
<span class="fc" id="L714">            File file = new File(uploadedFile.getAbsolutePath());</span>
<span class="pc bpc" id="L715" title="1 of 2 branches missed.">            if (file.exists()) {</span>

<span class="fc" id="L717">                Map&lt;LibValues, String&gt; values = new EnumMap&lt;&gt;(LibValues.class);</span>

<span class="fc" id="L719">                String fileId = DASH_PATTERN.matcher(UUID.randomUUID().toString()).replaceAll(Matcher.quoteReplacement(&quot;&quot;));</span>
<span class="fc" id="L720">                String newFileName = fileId + &quot;_&quot; + fileNames[index];</span>
<span class="fc" id="L721">                String rawContentType = contentTypes[index];</span>
                String entryContentType;
<span class="pc bpc" id="L723" title="1 of 4 branches missed.">                if (rawContentType == null || !rawContentType.startsWith(&quot;video&quot;)) {</span>
<span class="fc" id="L724">                    entryContentType = InstituteLibraryEntry.ContentType.FILE.name();</span>
                } else {
<span class="fc" id="L726">                    entryContentType = InstituteLibraryEntry.ContentType.MEDIA.name();</span>
                }

<span class="fc" id="L729">                String fileUrl = storageService.addResource(newFileName, file);</span>

<span class="fc" id="L731">                values.put(LibValues.URL, fileUrl);</span>
<span class="fc" id="L732">                values.put(LibValues.DESC, fileNames[index]);</span>
<span class="fc" id="L733">                values.put(LibValues.CONTENT_TYPE, entryContentType);</span>
<span class="fc" id="L734">                values.put(LibValues.FOLDER_NAME, null);</span>
<span class="fc" id="L735">                values.put(LibValues.PARENT_ID, this.request.getParameter(&quot;tkid&quot;));</span>
<span class="fc" id="L736">                values.put(LibValues.POSITION, Long.toString(highestPosition + index));</span>

<span class="fc" id="L738">                createLibraryEntry(values);</span>
<span class="fc" id="L739">                index++;</span>
            }
        }

<span class="fc" id="L743">        fileUploadStream = new ByteArrayInputStream(&quot;{'status': 'OK'}&quot;.getBytes());</span>
<span class="fc" id="L744">        return &quot;fileUploadStream&quot;;</span>
    }

    /**
     * splits a string and returns the element at specified position
     *
     * @param arrString
     *            string to be parsed
     * @param delimiter
     *            delimiter. if null, we assume a comma [,]
     * @param position
     *            position of element to return. if null we return the last one
     * @return returns element at the last position
     */
    public static @Nullable String splitString(String arrString, String delimiter, Integer position) {

<span class="fc bfc" id="L760" title="All 2 branches covered.">        if (arrString == null) {</span>
<span class="fc" id="L761">            return null;</span>
        }

<span class="pc bpc" id="L764" title="1 of 2 branches missed.">        if (delimiter == null) {</span>
<span class="fc" id="L765">            delimiter = &quot;,&quot;;</span>
        }

<span class="fc" id="L768">        String[] arr = arrString.split(delimiter);</span>
<span class="pc bpc" id="L769" title="1 of 2 branches missed.">        if (position == null) {</span>
<span class="fc" id="L770">            position = arr.length - 1;</span>
        }

<span class="fc" id="L773">        return arr[position].trim();</span>
    }

    public String getFileURL(InstituteLibraryEntry entry) {
<span class="fc" id="L777">        return LibraryUtil.buildLibraryFileURL(entry.getUrl());</span>
    }

    public String getFolderURL(InstituteLibraryEntry entry) {
<span class="fc" id="L781">        return LibraryUtil.buildLibraryFolderURL(entry, ADMIN_REFERER, Optional.of(instituteCode));</span>
    }

<span class="fc" id="L784">    private enum LibValues {</span>
<span class="fc" id="L785">        URL, DESC, CONTENT_TYPE, FOLDER_NAME, PARENT_ID, POSITION</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>