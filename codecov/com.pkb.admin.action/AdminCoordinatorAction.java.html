<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdminCoordinatorAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.admin.action</a> &gt; <span class="el_source">AdminCoordinatorAction.java</span></div><h1>AdminCoordinatorAction.java</h1><pre class="source lang-java linenums">
package com.pkb.admin.action;

import com.google.common.collect.Lists;
import com.opensymphony.xwork2.Action;
import com.pkb.action.BaseAction;
import com.pkb.bean.IUserWebBean;
import com.pkb.consent.model.NoConsentsRequired;
import com.pkb.datamodel.Email;
import com.pkb.dto.InviteeDTO;
import com.pkb.entities.enums.UserType;
import com.pkb.exception.MailException;
import com.pkb.exception.PKBException;
import com.pkb.institute.entity.InstituteUser;
import com.pkb.institute.entity.Team;
import com.pkb.model.PKBPersonDTO;
import com.pkb.notification.entity.Activity;
import com.pkb.service.emailmessage.impl.PKBEmailMessageManager;
import com.pkb.service.invitation.impl.InvitationManager;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.UserAccessManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.user.entity.PasswordAccess;
import com.pkb.user.entity.PersonContact;
import com.pkb.util.Pager;
import org.apache.struts2.interceptor.validation.SkipValidation;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.ArrayList;
import java.util.List;

<span class="fc" id="L35">public class AdminCoordinatorAction extends BaseAction {</span>

    private static final long serialVersionUID = 1L;

<span class="fc" id="L39">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

<span class="fc" id="L41">    private List&lt;InstituteUser&gt; coordinators = new ArrayList&lt;&gt;(); // non-null</span>

    private TeamUserManager teamUserManager;

    private TeamManager teamManager;

    private IUserWebBean userWebBean;

    private PKBEmailMessageManager pkbEmailMessageManager;

    private InvitationManager invitationManager;

    private UserAccessManager userAccessManager;

    private long instituteId;

    private int pageSize;

    private int offset;

    private InviteeDTO coordinatorDTO;

    private boolean showRemindSuccessMessage;

    private boolean showActivationSuccessMessage;

    private String inviteeId;

    private Team institute;

    private Long loggedInCoordId;

    private boolean showResentSuccessMessage;

    private boolean showAutomaticResendSuccessMessage;

<span class="fc" id="L77">    private final String tab = &quot;coordinators&quot;;</span>

<span class="fc" id="L79">    private String subTab = &quot;inviteCoordinator&quot;;</span>

    private Long userId;

    private PKBPerson clinician;

    private String teamCode;

    /**
     * Set to indicate that contact options have been updated
     */
    private boolean contactUpdated;

    public String browse() {

        try {
<span class="fc" id="L95">            loggedInCoordId = loggedInUserUtil.getLoggedInUserId();</span>
<span class="fc" id="L96">            institute = loggedInUserUtil.getLoggedInUserPrimaryTeam();</span>
<span class="fc" id="L97">            instituteId = institute.getId();</span>
<span class="fc" id="L98">            coordinators = teamUserManager.getInstituteUsersByType(</span>
<span class="fc" id="L99">                    instituteId, UserType.INSTITUTE_ADMIN, Pager.ALL, offset);</span>

<span class="fc" id="L101">            getSuccessMessage();</span>
<span class="nc" id="L102">        } catch (PKBException e) {</span>
<span class="nc" id="L103">            LOGGER.error(&quot;Error while getting the list of coordinators&quot;, e);</span>
<span class="fc" id="L104">        }</span>
<span class="fc" id="L105">        return SUCCESS;</span>
    }

    public String inviteCoordinatorForm() {
<span class="fc" id="L109">        coordinatorDTO = new InviteeDTO();</span>
<span class="fc" id="L110">        return SUCCESS;</span>
    }

    // Alternatively, set up and activate the coordinator in one step
    // (Based on CreatePatientAction.execute())

    public String createCoordinator() {
        try {
<span class="fc" id="L118">            userManager.beginTransaction();</span>

<span class="fc" id="L120">            Team team = loggedInUserUtil.getLoggedInUserPrimaryTeam();</span>
<span class="fc" id="L121">            Email emailId = coordinatorDTO.getEmailId();</span>

            // Validation

<span class="pc bpc" id="L125" title="1 of 2 branches missed.">            if (userWebBean.isSameUser(emailId)) {</span>
<span class="nc" id="L126">                addActionError(getText(&quot;error.cannot.invite.yourself&quot;, new String[] { emailId.address() }));</span>
<span class="nc" id="L127">                return INPUT;</span>
            }

<span class="fc" id="L130">            UserType userType = loggedInUserUtil.getLoggedInUserType();</span>
<span class="pc bpc" id="L131" title="2 of 4 branches missed.">            if ((team == null) || userType != UserType.INSTITUTE_ADMIN) {</span>
<span class="nc" id="L132">                addActionError(getText(&quot;error.not.authorized.to.invite&quot;));</span>
<span class="nc" id="L133">                return INPUT;</span>
            }

            // Validate that the other accounts are also coord accounts. We'll validate they're owned
            // by the same person during registration (see ClinicianRegistrationAction)
<span class="fc bfc" id="L138" title="All 2 branches covered.">            for (PKBPerson person : userManager.getPKBPersonByConfirmedOrPrimaryEmail(emailId, PersonContact.Lazy.PERSON_W_CONTACTS)) {</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">                if (!person.isTeamCoordinator()) {</span>
<span class="nc" id="L140">                    addActionError(getText(&quot;error.already.registered.different.type&quot;));</span>
<span class="nc" id="L141">                    return INPUT;</span>
                }
<span class="fc" id="L143">            }</span>

<span class="fc" id="L145">            PKBPerson pkbAdmin = userManager.getPKBPerson(loggedInUserUtil.getLoggedInUserId());</span>
<span class="fc" id="L146">            PKBPerson newCoordinator = teamUserManager.setupCoordinator(getLoggedInEHRRequestContext(),</span>
<span class="fc" id="L147">                    PKBPersonDTO.of(coordinatorDTO.getTitle(),</span>
<span class="fc" id="L148">                    coordinatorDTO.getFirstName(),</span>
<span class="fc" id="L149">                    coordinatorDTO.getLastName(),</span>
                    emailId,
                    UserType.INSTITUTE_ADMIN,
<span class="fc" id="L152">                    pkbAdmin.getLanguageCode(),</span>
<span class="fc" id="L153">                    team.getTimeZoneId()),</span>
                    pkbAdmin,
                    team);

<span class="fc" id="L157">            pkbEmailMessageManager.notifyCoordinatorOfCreatedAccount(pkbAdmin, newCoordinator, team);</span>

<span class="fc" id="L159">            userManager.commitTransaction();</span>

<span class="fc" id="L161">            addActionMessage(getText(&quot;registration.account.create.success&quot;, Lists.newArrayList(newCoordinator.getTitle(), newCoordinator.getLastName())));</span>

            // Log the account creation activity
<span class="fc" id="L164">            logActivity(Activity.Action.CREATED_ACCOUNT, dateTimeService.now(), newCoordinator.getId(), false, new NoConsentsRequired());</span>

<span class="nc" id="L166">        } catch (PKBException e) {</span>
            //noinspection StrutsI18nError,SSBasedInspection
<span class="nc" id="L168">            addActionError(e.getMessage());</span>
<span class="nc" id="L169">            LOGGER.error(&quot;error&quot;, e);</span>
<span class="nc" id="L170">            return Action.ERROR;</span>
<span class="nc" id="L171">        } catch (MailException e) {</span>
            //noinspection StrutsI18nError,SSBasedInspection
<span class="nc" id="L173">            addActionError(e.getMessage());</span>
<span class="nc" id="L174">            LOGGER.error(&quot;Mailer exception: {}&quot;, e.getCause(), e);</span>
<span class="nc" id="L175">            return Action.ERROR;</span>
        } finally {
<span class="fc" id="L177">            userManager.rollbackIfNotCommitted();</span>
        }
<span class="fc" id="L179">        return SUCCESS;</span>

    }

    @SkipValidation
    public String remindCreatedCoordinatorToRegister() {
        try {
<span class="fc" id="L186">            userManager.beginTransaction();</span>

<span class="fc" id="L188">            PKBPerson reminder = userManager.getPKBPerson(loggedInUserUtil.getLoggedInUserId());</span>
<span class="fc" id="L189">            PKBPerson newCoord = userManager.getPKBPerson(Long.parseLong(inviteeId));</span>
<span class="fc" id="L190">            Team team = loggedInUserUtil.getLoggedInUserPrimaryTeam();</span>

<span class="pc bpc" id="L192" title="1 of 2 branches missed.">            if (reminder.isSuperAdmin()) {</span>
<span class="fc" id="L193">                team = teamManager.getTeamByCode(teamCode);</span>
            }

<span class="fc" id="L196">            PasswordAccess passwordAccess = userAccessManager.getPasswordAccess(newCoord.getId(), getLoggedInEHRRequestContext());</span>
<span class="pc bpc" id="L197" title="1 of 2 branches missed.">            if (passwordAccess == null) {</span>
<span class="nc" id="L198">                throw new NullPointerException(&quot;No passwordAccess stored for new coord &quot; + newCoord.getId()); // TODO: handle this (old user) more politely</span>
            }
<span class="fc" id="L200">            newCoord.setPassword(passwordAccess.getPassword());</span>
<span class="fc" id="L201">            pkbEmailMessageManager.notifyCoordinatorOfCreatedAccount(reminder, newCoord, team);</span>

<span class="fc" id="L203">            addActionMessage(getText(&quot;registration.remind.success&quot;, Lists.newArrayList(newCoord.getTitle(), newCoord.getLastName())));</span>

<span class="nc" id="L205">        } catch (PKBException e) {</span>
            //noinspection StrutsI18nError,SSBasedInspection
<span class="nc" id="L207">            addActionError(e.getMessage());</span>
<span class="nc" id="L208">            LOGGER.error(&quot;error&quot;, e);</span>
<span class="nc" id="L209">            return Action.ERROR;</span>
<span class="nc" id="L210">        } catch (MailException e) {</span>
            //noinspection StrutsI18nError,SSBasedInspection
<span class="nc" id="L212">            addActionError(e.getMessage());</span>
<span class="nc" id="L213">            LOGGER.error(&quot;Mailer exception: {}&quot;, e.getCause(), e);</span>
<span class="nc" id="L214">            return Action.ERROR;</span>
        } finally {
<span class="fc" id="L216">            userManager.rollbackIfNotCommitted();</span>
        }
<span class="fc" id="L218">        return SUCCESS;</span>
    }

    public String deactivationForm() {
        try {
<span class="fc" id="L223">            clinician = userManager.getPKBPerson(userId);</span>
<span class="nc" id="L224">        } catch (PKBException e) {</span>
<span class="nc" id="L225">            LOGGER.error(&quot;failed getPKBPerson for {}&quot;, userId, e);</span>
<span class="nc" id="L226">            addActionMessage(getText(&quot;deactivation.process.failure&quot;));</span>
<span class="nc" id="L227">            return INPUT;</span>
<span class="fc" id="L228">        }</span>

<span class="fc" id="L230">        return SUCCESS;</span>
    }

    @SkipValidation
    public String deactivateCoordinator() {
        PKBPerson person;
        try {
<span class="fc" id="L237">            person = userManager.getPKBPerson(userId);</span>
<span class="nc" id="L238">        } catch (Exception e) {</span>
<span class="nc" id="L239">            LOGGER.error(&quot;failed getPKBPerson for {}&quot;, userId, e);</span>
<span class="nc" id="L240">            addActionMessage(getText(&quot;deactivation.process.failure&quot;));</span>

<span class="nc" id="L242">            return INPUT;</span>
<span class="fc" id="L243">        }</span>
        try {
<span class="fc" id="L245">            institute = loggedInUserUtil.getLoggedInUserPrimaryTeam();</span>
<span class="fc" id="L246">            instituteId = institute.getId();</span>
<span class="fc" id="L247">            userAccessManager.deactivateUserAccount(getLoggedInEHRRequestContext(), userId);</span>

<span class="fc" id="L249">            addActionMessage(getText(&quot;deactivation.successful&quot;,</span>
<span class="fc" id="L250">                    new String[]{person.getTitle(), person.getFirstName(), person.getLastName()}));</span>
<span class="fc" id="L251">            logActivity(com.pkb.notification.entity.Activity.Action.ACCOUNT_DEACTIVATED, dateTimeService.now(), person.getId(), true,</span>
                    new NoConsentsRequired());
<span class="fc" id="L253">            return SUCCESS;</span>
<span class="nc" id="L254">        } catch (Exception e) {</span>
<span class="nc" id="L255">            LOGGER.error(&quot;failed deactivation for {}&quot;, userId, e);</span>
<span class="nc" id="L256">            addActionMessage(getText(&quot;account.deactivation.failure&quot;,</span>
<span class="nc" id="L257">                    new String[]{person.getTitle(), person.getFirstName(), person.getLastName()}));</span>

<span class="nc" id="L259">            return SUCCESS;</span>
        }
    }

    /**
     * Get a proper success message in case of reminding an user and account
     * activation.
     */
    // LATER - remove irrelevant
    private void getSuccessMessage() {
<span class="pc bpc" id="L269" title="1 of 2 branches missed.">        if (showRemindSuccessMessage) {</span>
<span class="nc" id="L270">            PKBPerson person = userManager.getPKBPerson(Long.parseLong(inviteeId), PKBPerson.Lazy.CONTACTS);</span>
<span class="nc" id="L271">            addActionMessage(getText(&quot;successfully.remind.invitation&quot;,</span>
<span class="nc" id="L272">                    new String[] { person.findEmail().map(Email::address).getOrNull(), person.getFirstName(),</span>
<span class="nc" id="L273">                            person.getLastName() }));</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">        } else if (showActivationSuccessMessage) {</span>
<span class="nc" id="L275">            PKBPerson person = userManager.getPKBPerson(Long.parseLong(inviteeId), PKBPerson.Lazy.CONTACTS);</span>
<span class="nc" id="L276">            addActionMessage(getText(&quot;admin.successfully.activated.account&quot;,</span>
<span class="nc" id="L277">                    new String[] { person.findEmail().map(Email::address).getOrNull(), person.getFirstName(),</span>
<span class="nc" id="L278">                            person.getLastName(), person.getTitle() }));</span>
<span class="pc bpc" id="L279" title="1 of 2 branches missed.">        } else if (showResentSuccessMessage) {</span>
<span class="nc" id="L280">            PKBPerson person = userManager.getPKBPerson(Long.parseLong(inviteeId), PKBPerson.Lazy.CONTACTS);</span>
<span class="nc" id="L281">            addActionMessage(getText(&quot;successfully.resent.confirmation&quot;,</span>
<span class="nc" id="L282">                    new String[]{person.getTitle(), person.getFirstName(), person.getLastName()}));</span>
<span class="pc bpc" id="L283" title="1 of 2 branches missed.">        } else if (showAutomaticResendSuccessMessage) {</span>
<span class="nc" id="L284">            PKBPerson person = userManager.getPKBPerson(Long.parseLong(inviteeId), PKBPerson.Lazy.CONTACTS);</span>
<span class="nc" id="L285">            addActionMessage(getText(&quot;automatically.resent.invitation&quot;,</span>
<span class="nc" id="L286">                    new String[]{person.getTitle(), person.getFirstName(), person.getLastName()}));</span>
        }
<span class="fc" id="L288">    }</span>

    public List&lt;InstituteUser&gt; getCoordinators() {
<span class="fc" id="L291">        return coordinators;</span>
    }

    public void setTeamUserManager(
            TeamUserManager teamUserManager) {
<span class="fc" id="L296">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L297">    }</span>

    public int getPageSize() {
<span class="nc" id="L300">        return pageSize;</span>
    }

    public void setPageSize(int pageSize) {
<span class="nc" id="L304">        this.pageSize = pageSize;</span>
<span class="nc" id="L305">    }</span>

    public int getOffset() {
<span class="nc" id="L308">        return offset;</span>
    }

    public void setOffset(int offset) {
<span class="nc" id="L312">        this.offset = offset;</span>
<span class="nc" id="L313">    }</span>

    public long getInstituteId() {
<span class="nc" id="L316">        return instituteId;</span>
    }

    public void setInstituteId(long instituteId) {
<span class="nc" id="L320">        this.instituteId = instituteId;</span>
<span class="nc" id="L321">    }</span>

    public void setUserWebBean(IUserWebBean userWebBean) {
<span class="fc" id="L324">        this.userWebBean = userWebBean;</span>
<span class="fc" id="L325">    }</span>

    public InviteeDTO getCoordinatorDTO() {
<span class="fc" id="L328">        return coordinatorDTO;</span>
    }

    public void setCoordinatorDTO(InviteeDTO coordinatorDTO) {
<span class="fc" id="L332">        this.coordinatorDTO = coordinatorDTO;</span>
<span class="fc" id="L333">    }</span>

    public boolean isShowRemindSuccessMessage() {
<span class="nc" id="L336">        return showRemindSuccessMessage;</span>
    }

    public void setShowRemindSuccessMessage(boolean showRemindSuccessMessage) {
<span class="nc" id="L340">        this.showRemindSuccessMessage = showRemindSuccessMessage;</span>
<span class="nc" id="L341">    }</span>

    //	public long getInboxCount() {
    //		return inboxCount;
    //	}
    //
    //	public void setInboxCount(long inboxCount) {
    //		this.inboxCount = inboxCount;
    //	}

    public Team getInstitute() {
<span class="fc" id="L352">        return institute;</span>
    }

    public void setInstitute(Team institute) {
<span class="nc" id="L356">        this.institute = institute;</span>
<span class="nc" id="L357">    }</span>

    public String getInviteeId() {
<span class="nc" id="L360">        return inviteeId;</span>
    }

    public void setInviteeId(String inviteeId) {
<span class="fc" id="L364">        this.inviteeId = inviteeId;</span>
<span class="fc" id="L365">    }</span>

    public boolean isShowActivationSuccessMessage() {
<span class="nc" id="L368">        return showActivationSuccessMessage;</span>
    }

    public Long getLoggedInCoordId() {
<span class="fc" id="L372">        return loggedInCoordId;</span>
    }

    public void setLoggedInCoordId(Long loggedInCoordId) {
<span class="nc" id="L376">        this.loggedInCoordId = loggedInCoordId;</span>
<span class="nc" id="L377">    }</span>

    public void setShowActivationSuccessMessage(
            boolean showActivationSuccessMessage) {
<span class="nc" id="L381">        this.showActivationSuccessMessage = showActivationSuccessMessage;</span>
<span class="nc" id="L382">    }</span>

    public boolean isShowResentSuccessMessage() {
<span class="nc" id="L385">        return showResentSuccessMessage;</span>
    }

    public void setShowResentSuccessMessage(boolean showResentSuccessMessage) {
<span class="nc" id="L389">        this.showResentSuccessMessage = showResentSuccessMessage;</span>
<span class="nc" id="L390">    }</span>

    public boolean isShowAutomaticResendSuccessMessage() {
<span class="nc" id="L393">        return showAutomaticResendSuccessMessage;</span>
    }

    public void setShowAutomaticResendSuccessMessage(boolean showAutomaticResendSuccessMessage) {
<span class="nc" id="L397">        this.showAutomaticResendSuccessMessage = showAutomaticResendSuccessMessage;</span>
<span class="nc" id="L398">    }</span>

    public String getTab() {
<span class="fc" id="L401">        return tab;</span>
    }

    public PKBPerson getClinician() {
<span class="fc" id="L405">        return clinician;</span>
    }

    public void setClinician(PKBPerson clinician) {
<span class="nc" id="L409">        this.clinician = clinician;</span>
<span class="nc" id="L410">    }</span>

    public Long getUserId() {
<span class="fc" id="L413">        return userId;</span>
    }

    public void setUserId(Long userId) {
<span class="fc" id="L417">        this.userId = userId;</span>
<span class="fc" id="L418">    }</span>

    public void setUserManager(UserManager userManager) {
<span class="fc" id="L421">        this.userManager = userManager;</span>
<span class="fc" id="L422">    }</span>

    public boolean isContactUpdated() {
<span class="fc" id="L425">        return contactUpdated;</span>
    }

    public void setContactUpdated(boolean contactUpdated) {
<span class="nc" id="L429">        this.contactUpdated = contactUpdated;</span>
<span class="nc" id="L430">    }</span>

    public String getSubTab() {
<span class="fc" id="L433">        return subTab;</span>
    }

    public void setSubTab(String subTab) {
<span class="fc" id="L437">        this.subTab = subTab;</span>
<span class="fc" id="L438">    }</span>

    public PKBEmailMessageManager getPkbEmailMessageManager() {
<span class="nc" id="L441">        return pkbEmailMessageManager;</span>
    }

    public void setPkbEmailMessageManager(
            PKBEmailMessageManager pkbEmailMessageManager) {
<span class="fc" id="L446">        this.pkbEmailMessageManager = pkbEmailMessageManager;</span>
<span class="fc" id="L447">    }</span>

    public InvitationManager getInvitationManager() {
<span class="nc" id="L450">        return invitationManager;</span>
    }

    public void setInvitationManager(InvitationManager invitationManager) {
<span class="fc" id="L454">        this.invitationManager = invitationManager;</span>
<span class="fc" id="L455">    }</span>

    public UserAccessManager getUserAccessManager() {
<span class="nc" id="L458">        return userAccessManager;</span>
    }

    public void setUserAccessManager(UserAccessManager userAccessManager) {
<span class="fc" id="L462">        this.userAccessManager = userAccessManager;</span>
<span class="fc" id="L463">    }</span>

    public TeamManager getTeamManager() {
<span class="nc" id="L466">        return teamManager;</span>
    }

    public void setTeamManager(TeamManager teamManager) {
<span class="fc" id="L470">        this.teamManager = teamManager;</span>
<span class="fc" id="L471">    }</span>

    public String getTeamCode() {
<span class="fc" id="L474">        return teamCode;</span>
    }

    public void setTeamCode(String teamCode) {
<span class="fc" id="L478">        this.teamCode = teamCode;</span>
<span class="fc" id="L479">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>