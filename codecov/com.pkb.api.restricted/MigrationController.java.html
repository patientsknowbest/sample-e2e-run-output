<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MigrationController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.restricted</a> &gt; <span class="el_source">MigrationController.java</span></div><h1>MigrationController.java</h1><pre class="source lang-java linenums">package com.pkb.api.restricted;


import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.ImmutableLoggedInBgTaskEHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.PersonAuthInfo;
import com.pkb.consent.model.ConsentStatus;
import com.pkb.dto.EhrDataMigrationRequestDTO;
import com.pkb.dto.ImmutableEhrMigrationVersionsDTO;
import com.pkb.entities.enums.Route;
import com.pkb.service.privacy.MigrationService;
import com.pkb.service.user.impl.UserManager;
import com.pkb.util.CorrelationIdUtil;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.RequestBody;

import javax.ws.rs.Consumes;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import java.util.Optional;
import java.util.UUID;

@Controller
@Path(MigrationController.MIGRATIONS)
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
@Api(tags = {&quot;Migrations&quot;}, value = &quot;Api to support triggering various data migrations&quot;)
<span class="fc" id="L36">public class MigrationController {</span>
    static final String MIGRATIONS = &quot;/migrations&quot;;

    @Autowired
    private MigrationService migrationService;

    @Autowired
    private UserManager userManager;

    @Autowired
    private CorrelationIdUtil correlationIdUtil;

    @POST
    @Path(&quot;/ehrData&quot;)
    @ApiOperation(value = &quot;Run ehr data migrations for a set of ehr data ids for an account&quot;)
    public Response ehrDataMigration(@RequestBody EhrDataMigrationRequestDTO migrationRequest) {
<span class="nc" id="L52">        return getRequestContext(migrationRequest.getAccountPrivateId())</span>
<span class="nc" id="L53">                .map(context -&gt; {</span>
<span class="nc" id="L54">                    migrationService.runEhrMigrations(migrationRequest, context);</span>
<span class="nc" id="L55">                    return Response.ok().build();</span>
                })
<span class="nc" id="L57">                .orElseGet(() -&gt; Response.status(404).build());</span>

    }

    private Optional&lt;LoggedInEHRRequestContext&gt; getRequestContext(long accountId) {
<span class="nc" id="L62">        return Optional.ofNullable(userManager.getAccountOwner(accountId))</span>
<span class="nc" id="L63">                .map(owner -&gt;</span>
<span class="nc" id="L64">                        ImmutableLoggedInBgTaskEHRRequestContext.builder()</span>
<span class="nc" id="L65">                                .accessingUser(PersonAuthInfo.of(owner))</span>
<span class="nc" id="L66">                                .consentStatus(ConsentStatus.noConsentRequired())</span>
<span class="nc" id="L67">                                .accessLogSuppressed(true)</span>
<span class="nc" id="L68">                                .accessRoute(Route.SCHED_TASK) // This is safe because we never write new records with this</span>
<span class="nc" id="L69">                                .accountLinkType(EHRRequestContext.AccountLinkType.NO_LINK)</span>
<span class="nc" id="L70">                                .correlationId(correlationIdUtil.maybeGet().orElse(UUID.randomUUID()))</span>
<span class="nc" id="L71">                                .build()</span>
                );
    }

    /**
     * This is a slightly odd endpoint. It exists so that background tasks can determine the latest migration version for
     * the various EhrData types and query the database for rows that might need migrating (not yet at latest version).
     * This is exposed as an endpoint to avoid duplicating this information from PHR
     * This allows background tasks to control and record the progress of the migration rather than PHR having to store
     * this as separate state. The only other alternative would have been to have PHR query for the list of rows to migrate
     * and drive the migration itself, but in order to avoid timeouts, this would have to have run in a background thread,
     * which is exactly what  we wanted to avoid by moving this stuff out to background tasks, because it complicates
     * the exercise of clustering PHR
     */
    @GET
    @Path(&quot;/ehrMigrationVersions&quot;)
    @ApiOperation(value = &quot;Get the currently configured maximum migration version for all EHR Data types&quot;)
    public Response getEhrMigrationVersions() {
<span class="fc" id="L89">        return Response.ok(ImmutableEhrMigrationVersionsDTO.of(migrationService.getEhrMigrationVersions())).build();</span>
    }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>