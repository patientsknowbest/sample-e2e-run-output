<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ParticipantSelectorService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.message</a> &gt; <span class="el_source">ParticipantSelectorService.java</span></div><h1>ParticipantSelectorService.java</h1><pre class="source lang-java linenums">package com.pkb.action.message;

import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.bean.impl.MessageWebBean;
import com.pkb.dto.PersonAvailabilityDTO;
import com.pkb.dto.PersonDto;
import com.pkb.dto.TeamCliniciansDTO;
import com.pkb.dto.TeamDTO;
import com.pkb.entities.enums.SponsorshipStatus;
import com.pkb.entities.enums.UserStatus;
import com.pkb.entities.enums.UserType;
import com.pkb.institute.entity.InstituteUser;
import com.pkb.institute.entity.InstituteUserEntity;
import com.pkb.institute.entity.Team;
import com.pkb.mappers.TeamMapper;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamUserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.util.LocalizedTextProvider;
import com.pkb.util.Pager;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.time.format.DateTimeFormatter;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.LinkedList;
import java.util.List;
import java.util.Map;
import java.util.Optional;
import java.util.Set;
import java.util.TreeSet;
import java.util.stream.Collectors;

import static java.util.Collections.singletonList;
import static java.util.Objects.requireNonNull;
import static java.util.Optional.empty;
import static java.util.stream.Collectors.toList;
import static org.apache.commons.lang3.StringUtils.isNotBlank;

public class ParticipantSelectorService {
<span class="fc" id="L44">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private MessageWebBean messageWebBean;
    private TeamManager teamManager;
    private TeamUserManager teamUserManager;
    private TeamMapper teamMapper;
    private LocalizedTextProvider localizedTextProvider;

    public ParticipantSelectorService(MessageWebBean messageWebBean,
                                      TeamManager teamManager,
                                      TeamUserManager teamUserManager,
                                      TeamMapper teamMapper,
<span class="fc" id="L56">                                      LocalizedTextProvider localizedTextProvider) {</span>
<span class="fc" id="L57">        this.messageWebBean = messageWebBean;</span>
<span class="fc" id="L58">        this.teamManager = teamManager;</span>
<span class="fc" id="L59">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L60">        this.teamMapper = teamMapper;</span>
<span class="fc" id="L61">        this.localizedTextProvider = localizedTextProvider;</span>
<span class="fc" id="L62">    }</span>

    // TODO: For messaging refactor: In the future, this should expect Tuple2 instead of currentUser and referredPatient separately
    public ParticipantSelectorParams setupParticipantSelectorParams(boolean topicConsultTeam, Long consultTeamId,
                                                                    PKBPerson currentUser, PKBPerson referredPatient,
                                                                    boolean isLoggedInUserProfessional, InstituteUserEntity.ContactOptions contactOptions, Team team, LoggedInEHRRequestContext requestContext,
                                                                    LoggedInEHRRequestContext ehrRequestContextSingleAccess, DateTimeFormatter dateFormatter) {
<span class="fc" id="L69">        ParticipantSelectorParams params = new ParticipantSelectorParams();</span>

<span class="pc bpc" id="L71" title="1 of 2 branches missed.">        if (topicConsultTeam) {</span>
<span class="nc" id="L72">            setupConsultTeamCliniciansList(consultTeamId, requestContext, params);</span>
<span class="nc" id="L73">            params.setConsultTeam(teamMapper.teamToTeamDTO(requireNonNull(teamManager.getTeam(consultTeamId))));</span>
        }

<span class="pc bpc" id="L76" title="1 of 4 branches missed.">        if (referredPatient != null &amp;&amp; isNotBlank(referredPatient.getIdString())) {</span>
<span class="fc" id="L77">            setupClinicianLists(currentUser, referredPatient, consultTeamId, isLoggedInUserProfessional, contactOptions, requestContext,</span>
                    ehrRequestContextSingleAccess, dateFormatter, params);
        }
<span class="fc" id="L80">        params.setUserCarersLabel(buildUserCarersLabel(referredPatient));</span>

<span class="fc bfc" id="L82" title="All 2 branches covered.">        if (referredPatient == null) {</span>
<span class="fc" id="L83">            setupColleaguesList(team, contactOptions, requestContext, currentUser, params);</span>
        }

<span class="fc" id="L86">        return params;</span>
    }

    public Optional&lt;ParticipantSelectorParams&gt; setupSingleTeamSelector(LoggedInEHRRequestContext requestContext, @NotNull Long teamId,
                                                                       DateTimeFormatter dateFormatter) throws Exception {

<span class="fc" id="L92">        List&lt;PKBPerson&gt; pros =  teamUserManager.getInstituteUsersByType(teamId, UserType.REG_CLINICIAN, Pager.ALL, 0).stream()</span>
<span class="pc bpc" id="L93" title="1 of 4 branches missed.">                .filter( iu -&gt; iu.getContactable()==InstituteUserEntity.ContactOptions.All ||  iu.getContactable()==InstituteUserEntity.ContactOptions.Messages_Only)</span>
<span class="fc" id="L94">                .map(InstituteUser::getPerson)</span>
<span class="fc" id="L95">                .collect(toList());</span>
<span class="fc bfc" id="L96" title="All 2 branches covered.">        if (pros.isEmpty()) {</span>
<span class="fc" id="L97">            return empty();</span>
        }

<span class="fc" id="L100">        List&lt;PersonAvailabilityDTO&gt; availabilityDTOs = messageWebBean.getClinicianAvailability(requestContext, pros);</span>
<span class="pc bpc" id="L101" title="1 of 2 branches missed.">        if (availabilityDTOs.isEmpty()) {</span>
<span class="nc" id="L102">            return empty();</span>
        }

<span class="fc" id="L105">        TeamDTO teamDto = teamMapper.teamToTeamDTO(teamManager.getTeam(teamId));</span>

<span class="fc" id="L107">        TeamCliniciansDTO teamCliniciansDTO = new TeamCliniciansDTO();</span>
<span class="fc" id="L108">        teamCliniciansDTO.setTeam(teamDto);</span>
<span class="fc" id="L109">        teamCliniciansDTO.setCliniciansList(availabilityDTOs);</span>

<span class="fc" id="L111">        List&lt;TeamCliniciansDTO&gt; dtos = singletonList(teamCliniciansDTO);</span>
<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (teamDto.isTeamBasedMessagingEnabled()) {</span>
<span class="fc" id="L113">            generateTbmData(dtos, dateFormatter);</span>
        }

<span class="fc" id="L116">        ParticipantSelectorParams params = new ParticipantSelectorParams();</span>
<span class="fc" id="L117">        params.setCliniciansByTeam(dtos);</span>
<span class="fc" id="L118">        params.setConsultTeam(teamDto);</span>
<span class="fc" id="L119">        return Optional.of(params);</span>
    }

    public Optional&lt;String&gt; getQuestionnaireRecipientId(EHRRequestContext context, PKBPerson patient) {
<span class="fc" id="L123">        List&lt;PKBPerson&gt; assignedClinicians = messageWebBean.getCliniciansForPatient(context, patient,</span>
                InstituteUserEntity.ContactOptions.Consultations_Only);
<span class="fc" id="L125">        List&lt;Long&gt; assignedCliniciansIds = assignedClinicians.stream().map(PKBPerson::getId).collect(toList());</span>
        
<span class="fc" id="L127">        Map&lt;Long, List&lt;Team&gt;&gt; assignedCliniciansIdToTeamMap = teamUserManager.getUserToTeamMap(assignedCliniciansIds);</span>
        // Quick fix for PHR-2289 - activeOnly=true excludes self-reg patients, while activeOnly=false includes them while still excluding inactive
<span class="fc" id="L129">        List&lt;Team&gt; patientTeams = teamUserManager.getUserTeams(context, patient.getId(), false/*activeOnly*/);</span>
        
<span class="fc" id="L131">        List&lt;PKBPerson&gt; individualClinicians = new LinkedList&lt;&gt;();</span>
<span class="fc" id="L132">        Map&lt;Team, List&lt;PKBPerson&gt;&gt; cliniciansByTeam = new HashMap&lt;&gt;();</span>
        
<span class="fc bfc" id="L134" title="All 2 branches covered.">        for (PKBPerson clinician : assignedClinicians) {</span>
<span class="fc" id="L135">            List&lt;Team&gt; clinicianTeams = assignedCliniciansIdToTeamMap.get(clinician.getId());</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">            if (clinicianTeams.isEmpty()) {</span>
<span class="fc" id="L137">                individualClinicians.add(clinician);</span>
            } else {
<span class="fc bfc" id="L139" title="All 2 branches covered.">                for (Team team : clinicianTeams) {</span>
<span class="pc bpc" id="L140" title="1 of 2 branches missed.">                    if (patientTeams.contains(team)) {</span>
<span class="fc" id="L141">                        cliniciansByTeam.putIfAbsent(team, new LinkedList&lt;&gt;());</span>
<span class="fc" id="L142">                        List&lt;PKBPerson&gt; clinicians = cliniciansByTeam.get(team);</span>
<span class="fc" id="L143">                        clinicians.add(clinician);</span>
                    }
<span class="fc" id="L145">                }</span>
            }
<span class="fc" id="L147">        }</span>
        
<span class="fc bfc" id="L149" title="All 6 branches covered.">        if (individualClinicians.isEmpty() &amp;&amp; (cliniciansByTeam.size() == 1) &amp;&amp; (cliniciansByTeam.values().stream().findFirst().get().size() == 1)) {</span>
            // if there is no individual pro caring for this patient, and only one team caring for them containing exactly one pro,
            // then the recipient is this particular pro
<span class="fc" id="L152">            return Optional.of(cliniciansByTeam.values().stream().findFirst().get().get(0).getId().toString());</span>
<span class="pc bpc" id="L153" title="3 of 4 branches missed.">        } else if (cliniciansByTeam.isEmpty() &amp;&amp; (individualClinicians.size() == 1)) {</span>
            // else if there are no teams caring for this patient, but exactly one individual pro caring for them,
            // then the recipient is this individual pro
<span class="nc" id="L156">            return Optional.of(individualClinicians.get(0).getId().toString());</span>
        }
        // else we don't assign any recipient and the patient has to chose them themself
<span class="fc" id="L159">        return empty();</span>
    }

    public void filterResults(ParticipantSelectorParams params, Set&lt;String&gt; participantSet, DateTimeFormatter dateFormatter) {
<span class="fc" id="L163">        params.setConsultTeamList(params.getConsultTeamList().stream()</span>
<span class="pc bnc" id="L164" title="All 2 branches missed.">                .filter(item -&gt; !participantSet.contains(item.getPerson().getId().toString()))</span>
<span class="fc" id="L165">                .collect(toList()));</span>

<span class="fc" id="L167">        params.getCliniciansByTeam().forEach(team -&gt; {</span>
<span class="fc" id="L168">            team.setCliniciansList(team.getCliniciansList().stream()</span>
<span class="fc bfc" id="L169" title="All 2 branches covered.">                    .filter(item -&gt; !participantSet.contains(item.getPerson().getId().toString()))</span>
<span class="fc" id="L170">                    .collect(toList()));</span>
<span class="fc" id="L171">        });</span>
<span class="fc" id="L172">        generateTbmData(params.getCliniciansByTeam(), dateFormatter);</span>

<span class="fc" id="L174">        params.setNonTeamClinicians(params.getNonTeamClinicians().stream()</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">                .filter(item -&gt; !participantSet.contains(item.getPerson().getId().toString()))</span>
<span class="fc" id="L176">                .collect(toList()));</span>

<span class="fc" id="L178">        params.setColleagues(params.getColleagues().stream()</span>
<span class="pc bnc" id="L179" title="All 2 branches missed.">                .filter(item -&gt; !participantSet.contains(item.getPerson().getId().toString()))</span>
<span class="fc" id="L180">                .collect(toList()));</span>

<span class="fc" id="L182">        params.setCarerList(params.getCarerList().stream()</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">                .filter(item -&gt; !participantSet.contains(item.getId().toString()))</span>
<span class="fc" id="L184">                .collect(toList()));</span>
<span class="fc" id="L185">    }</span>

    private void setupConsultTeamCliniciansList(Long consultTeamId, EHRRequestContext requestContext,
                                                ParticipantSelectorParams params) {
<span class="nc" id="L189">        List&lt;InstituteUser&gt; teamCliniciansIU = teamUserManager.getTeamCliniciansByStatus(consultTeamId,</span>
                UserStatus.EMAIL_CONFIRMED, SponsorshipStatus.ACTIVE, Pager.ALL, 0);

<span class="nc" id="L192">        List&lt;PKBPerson&gt; proList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">        for (InstituteUser iu : teamCliniciansIU) {</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">            if (&quot;true&quot;.equals(iu.getContactableString())) {</span>
<span class="nc" id="L195">                proList.add(iu.getPerson());</span>
            }
<span class="nc" id="L197">        }</span>

<span class="nc" id="L199">        params.setConsultTeamList(messageWebBean.getClinicianAvailability(requestContext, proList));</span>
<span class="nc" id="L200">    }</span>

    private void setupClinicianLists(PKBPerson currentUser, PKBPerson referredPatient, Long consultTeamId,
                                     boolean isLoggedInUserProfessional, InstituteUserEntity.ContactOptions contactOption,
                                     LoggedInEHRRequestContext requestContext, LoggedInEHRRequestContext ehrRequestContextSingleAccess,
                                     DateTimeFormatter dateFormatter, ParticipantSelectorParams params) {
        List&lt;TeamCliniciansDTO&gt; cliniciansByTeam;
        List&lt;PersonAvailabilityDTO&gt; nonTeamClinicians;
<span class="fc" id="L208">        List&lt;PersonDto&gt; carerList = new ArrayList&lt;&gt;();</span>

<span class="pc bpc" id="L210" title="1 of 2 branches missed.">        if (referredPatient == null) {</span>
<span class="nc" id="L211">            throw new NullPointerException(&quot;need referredPatient!&quot;);</span>
        }

<span class="fc" id="L214">        cliniciansByTeam = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L215">        nonTeamClinicians = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L216">        carerList = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">        if (currentUser.isPatient()) {</span>
<span class="fc" id="L218">            messageWebBean.getProGroupsForPatient(requestContext, referredPatient,</span>
                    new TreeSet&lt;&gt;(), contactOption,
                    cliniciansByTeam, nonTeamClinicians, carerList);
        } else {
<span class="fc" id="L222">            messageWebBean.getProGroupsForPatient(ehrRequestContextSingleAccess, referredPatient,</span>
                    new TreeSet&lt;&gt;(), contactOption,
                    cliniciansByTeam, nonTeamClinicians, carerList);
        }

<span class="pc bpc" id="L227" title="1 of 2 branches missed.">        if (!params.getConsultTeamList().isEmpty()) {</span>
            // filter out the team already in consultTeamList
<span class="nc bnc" id="L229" title="All 2 branches missed.">            for (TeamCliniciansDTO tc : cliniciansByTeam) {</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">                if (tc.getTeam().getId().equals(consultTeamId)) {</span>
<span class="nc" id="L231">                    cliniciansByTeam.remove(tc);</span>
<span class="nc" id="L232">                    break;</span>
                }
<span class="nc" id="L234">            }</span>
        }

        // exclude current user (if clinician)
        removeCurrent:
<span class="fc bfc" id="L239" title="All 2 branches covered.">        if (isLoggedInUserProfessional) {</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">            for (PersonAvailabilityDTO avail : nonTeamClinicians) {</span>
<span class="pc bpc" id="L241" title="1 of 2 branches missed.">                if (avail.getPerson().getId().equals(currentUser.getId())) {</span>
<span class="nc" id="L242">                    nonTeamClinicians.remove(avail);</span>
<span class="nc" id="L243">                    break removeCurrent;</span>
                }
<span class="fc" id="L245">            }</span>
<span class="fc bfc" id="L246" title="All 2 branches covered.">            for (TeamCliniciansDTO tc : cliniciansByTeam) {</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">                for (PersonAvailabilityDTO avail : tc.getCliniciansList()) {</span>
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">                    if (avail.getPerson().getId().equals(currentUser.getId())) {</span>
<span class="nc" id="L249">                        nonTeamClinicians.remove(avail);</span>
<span class="nc" id="L250">                        break removeCurrent;</span>
                    }
<span class="fc" id="L252">                }</span>
<span class="fc" id="L253">            }</span>
        }

<span class="fc" id="L256">        generateTbmData(cliniciansByTeam, dateFormatter);</span>
<span class="fc" id="L257">        params.setCliniciansByTeam(cliniciansByTeam);</span>
<span class="fc" id="L258">        params.setNonTeamClinicians(nonTeamClinicians);</span>
<span class="fc" id="L259">        params.setCarerList(carerList);</span>
<span class="fc" id="L260">    }</span>

    private String buildUserCarersLabel(PKBPerson referredPatient) {
<span class="fc" id="L263">        return Optional.ofNullable(referredPatient)</span>
<span class="fc" id="L264">                .map(patient -&gt; localizedTextProvider.getText(&quot;composeMessage.txt.user_carers&quot;, patient.getFirstName(), patient.getLastName()))</span>
<span class="fc" id="L265">                .orElse(localizedTextProvider.getText(&quot;composeMessage.txt.your_carers&quot;));</span>
    }

    private void setupColleaguesList(Team team, InstituteUserEntity.ContactOptions contactOptions, EHRRequestContext requestContext, PKBPerson currentUser, ParticipantSelectorParams params) {
        // gets the current team, and excludes self
<span class="fc" id="L270">        Long currentUserId = currentUser.getId();</span>
<span class="fc" id="L271">        List&lt;PKBPerson&gt; colleaguesList = teamUserManager.getColleagues(requestContext, currentUserId, contactOptions);</span>

<span class="pc bpc" id="L273" title="1 of 2 branches missed.">        if (!params.getConsultTeamList().isEmpty()) {</span>
            // filter out clinicians already in consultTeamList
<span class="nc bnc" id="L275" title="All 2 branches missed.">            for (PersonAvailabilityDTO avail : params.getConsultTeamList()) {</span>
<span class="nc" id="L276">                colleaguesList.remove(avail.getPerson());</span>
<span class="nc" id="L277">            }</span>
        }

        // remove organized team clinicians of patients
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">        if (!params.getCliniciansByTeam().isEmpty()) {</span>
<span class="nc bnc" id="L282" title="All 2 branches missed.">            if (team != null) {</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                for (TeamCliniciansDTO cl : params.getCliniciansByTeam()) {</span>
                    // find the matching team; then remove those clinicians from the colleagues list
<span class="nc bnc" id="L285" title="All 2 branches missed.">                    if (cl.getTeam().getId().equals(team.getId())) {</span>
<span class="nc bnc" id="L286" title="All 2 branches missed.">                        for (PersonAvailabilityDTO avail : cl.getCliniciansList()) {</span>
<span class="nc" id="L287">                            colleaguesList.remove(avail.getPerson());</span>
<span class="nc" id="L288">                        }</span>
<span class="nc" id="L289">                        break;</span>
                    }
<span class="nc" id="L291">                }</span>
            }
        }
        // wrap: avail
<span class="fc" id="L295">        params.setColleagues(messageWebBean.getClinicianAvailability(requestContext, colleaguesList));</span>
<span class="fc" id="L296">    }</span>

    private void generateTbmData(List&lt;TeamCliniciansDTO&gt; cliniciansByTeam, DateTimeFormatter dateFormatter) {
<span class="fc" id="L299">        cliniciansByTeam.forEach(dto -&gt; {</span>
<span class="fc bfc" id="L300" title="All 2 branches covered.">            if (dto.getTeam().isTeamBasedMessagingEnabled()) {</span>
<span class="fc" id="L301">                String id = dto.getCliniciansList().stream()</span>
<span class="fc" id="L302">                        .map(clinician -&gt; clinician.getPerson().getId().toString())</span>
<span class="fc" id="L303">                        .collect(Collectors.joining(&quot;,&quot;));</span>

<span class="fc" id="L305">                String name = dto.getCliniciansList().stream()</span>
<span class="fc" id="L306">                        .map(clinician -&gt; {</span>
<span class="fc" id="L307">                            PersonDto clinicianDTO = clinician.getPerson();</span>
<span class="fc" id="L308">                            String fullName = localizedTextProvider.getText(&quot;composeMessage.txt.full_name_pattern&quot;,</span>
<span class="fc" id="L309">                                    clinicianDTO.getTitle(), clinicianDTO.getFirstName(), clinicianDTO.getLastName());</span>
<span class="fc" id="L310">                            StringBuilder nameBuilder = new StringBuilder(fullName);</span>
<span class="fc bfc" id="L311" title="All 2 branches covered.">                            if (!clinician.getAvailabilityDTO().isAvailableToday()) {</span>
<span class="fc" id="L312">                                nameBuilder.append(&quot; &quot;);</span>
<span class="fc" id="L313">                                nameBuilder.append(localizedTextProvider.getText(&quot;composeMessage.txt.back_on&quot;,</span>
<span class="fc" id="L314">                                        dateFormatter.format(clinician.getAvailabilityDTO().getNextAvailable().toInstant())));</span>
                            }
<span class="fc" id="L316">                            return nameBuilder.toString();</span>
                        })
<span class="fc" id="L318">                        .collect(Collectors.joining(&quot;, &quot;));</span>

<span class="fc" id="L320">                dto.setTbmId(id);</span>
<span class="fc" id="L321">                dto.setTbmName(name);</span>
            }
<span class="fc" id="L323">        });</span>
<span class="fc" id="L324">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>