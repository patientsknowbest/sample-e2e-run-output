<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MessageBaseAction.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.message</a> &gt; <span class="el_source">MessageBaseAction.java</span></div><h1>MessageBaseAction.java</h1><pre class="source lang-java linenums">package com.pkb.action.message;

import com.fasterxml.jackson.databind.ObjectReader;
import com.pkb.action.BaseAction;
import com.pkb.action.file.ChunkedUploadAction;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.bean.impl.AutoSaveService;
import com.pkb.document.entity.Attachment;
import com.pkb.domain.messages.workflow.TrustedConversationWorkflowService;
import com.pkb.encounter.entity.Encounter;
import com.pkb.encounter.entity.Message;
import com.pkb.entities.enums.EncounterClass;
import com.pkb.exception.PKBException;
import com.pkb.service.encounter.impl.tolven.EncounterManager;
import com.pkb.service.phplan.ParticipantManager;
import com.pkb.service.team.TeamUserManager;
import io.prometheus.client.Counter;
import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.UUID;

<span class="fc" id="L30">public class MessageBaseAction extends ChunkedUploadAction {</span>
    protected static final String TYPE_MESSAGE_HERE = &quot;Type message here....&quot;;
<span class="fc" id="L32">    protected static final ObjectReader MESSAGE_READER = OBJECT_MAPPER.readerFor(Message.class);</span>
<span class="fc" id="L33">    protected static final ObjectReader MESSAGE_PATCH_READER = OBJECT_MAPPER.readerFor(MessageAutoSaveModel.class);</span>
<span class="fc" id="L34">    protected static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>
    private static final long serialVersionUID = 1L;
    private static final String NAMESPACE_AUTH = &quot;auth&quot;;
    protected EncounterManager encounterManager;
    protected ParticipantManager participantManager;
    protected String attachmentSubmit;
    protected TeamUserManager teamUserManager;
    protected ParticipantSelectorService participantSelectorService;

    protected EncounterClassLocalizationHelper encounterClassLocalizationHelper;

    protected TrustedConversationWorkflowService trustedConversationWorkflowService;
    protected AutoSaveService autoSaveService;

<span class="fc" id="L48">    protected List&lt;String&gt; tbmSelectedTeam = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L49">    protected static final Counter TBM_SELECTED_TEAMS = Counter.build()</span>
<span class="fc" id="L50">            .name(&quot;pkb_phr_tbm_usage&quot;)</span>
<span class="fc" id="L51">            .labelNames(&quot;team&quot;)</span>
<span class="fc" id="L52">            .help(&quot;Usage of TBM feature for Teams with TBM Active&quot;)</span>
<span class="fc" id="L53">            .register();</span>

    protected LoggedInEHRRequestContext loggedinContext;
    protected MessageScreenDto messageScreenDto;
    private int attachmentJavascriptInstances;

    public Long sendReplyMessage(Message message, List&lt;Attachment&gt; attachments, UUID conversationId) {
<span class="fc" id="L60">        Long messageId = null;</span>

<span class="fc" id="L62">        long currentUserId = loggedInUserUtil.getLoggedInUserId();</span>
<span class="fc" id="L63">        String currentUserIdString = Long.toString(currentUserId);</span>
        //sender is always the current logged in user
<span class="fc" id="L65">        message.setSenderId(currentUserIdString);</span>

<span class="fc" id="L67">        long accountIdForExistingMessages = getAccountIdForExistingMessages(message);</span>

<span class="fc" id="L69">        var conversation = encounterManager.getOptionalConversation(getLoggedInEHRRequestContext().withoutAccessLog(),</span>
                conversationId,
                currentUserId,
                accountIdForExistingMessages);
        // Hack - these should all be the same as for the conversation
<span class="fc" id="L74">        message.setEncounterUniqueId(conversationId);</span>
<span class="fc" id="L75">        message.setMessageTimestamp(dateTimeService.now());</span>
<span class="pc bpc" id="L76" title="1 of 4 branches missed.">        message.setPrivateMessage(conversation.isPresent() &amp;&amp; conversation.get().getLatestMessage().isPrivateMessage());</span>

<span class="fc" id="L78">        message.getBaseFields().setDefaultGeneralConsentIfNoneSet();</span>

<span class="fc" id="L80">        message.initializeUniqueIds(conversation.isEmpty());</span>

        try {
<span class="fc" id="L83">            List&lt;String&gt; newParticipantIds = getDraftParticipantsSinceLastMessageForReply(currentUserId, accountIdForExistingMessages, conversation.orElse(null));</span>
<span class="fc bfc" id="L84" title="All 2 branches covered.">            if (newParticipantIds.isEmpty()) {</span>
<span class="fc" id="L85">                messageId = encounterManager.saveMessage(getLoggedInEHRRequestContext(), loggedInUserUtil.getLoggedInUserId(),</span>
                        message, attachments, contextUserId, false);
            } else {
<span class="fc" id="L88">                messageId = encounterManager.addParticipants(getLoggedInEHRRequestContext(), message,</span>
<span class="fc" id="L89">                        newParticipantIds, attachments, contextUserUtil.getContextUserId());</span>
            }

<span class="nc" id="L92">        } catch (Exception e) {</span>
<span class="nc" id="L93">            throw new PKBException(e);</span>
        } finally {
<span class="fc" id="L95">            encounterManager.rollbackIfNotCommitted();</span>
        }
<span class="fc" id="L97">        return messageId;</span>
    }

    /**
     * The current user might not have any existing messages in their own account, when possible for existing messages
     * we should refer to the patient account instead
     */
    private long getAccountIdForExistingMessages(Message message) {
        long accountIdForExistingMessages;
<span class="fc bfc" id="L106" title="All 2 branches covered.">        if (contextUserUtil.getContextUser() != null) {</span>
            //in patient context
<span class="fc" id="L108">            accountIdForExistingMessages = messageWebBean.getDefaultAccountId(contextUserUtil.getContextUserId());</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">        } else if (StringUtils.isNotEmpty(message.getPatientId())) {</span>
            //not in patient context, but the user still might not have the rest of the conversation (e.g. draft created in patient record but then re-opened in own inbox)
<span class="fc" id="L111">            accountIdForExistingMessages = messageWebBean.getDefaultAccountId(Long.parseLong(message.getPatientId()));</span>
        } else {
            //message not about a patient and not in context, user's own account is fine
<span class="fc" id="L114">            accountIdForExistingMessages = messageWebBean.getDefaultAccountId(loggedInUserUtil.getLoggedInUserId());</span>
        }
<span class="fc" id="L116">        return accountIdForExistingMessages;</span>
    }

    /**
     * Replies sent up from the UI don't currently pass up the participants, they assume the message is going to the same participants.
     * Typically that's correct. However it may be that reply has:
     * - been slowly composed as a draft (including with new participants added in autosaves via the add participant action)
     * - been created by someone not currently in the conversation, by responding to a message in a patient record
     * - fallen into an edge case where really it's a compose message (draft autosaved, reopened from inbox)
     * - in this case there are none since the last message as they're all new (e.g. should be using the save message path rather than add participants path)
     */
    private List&lt;String&gt; getDraftParticipantsSinceLastMessageForReply(Long senderId, Long accountIdForExistingConversation, Encounter existingConversation) {
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">        if (existingConversation == null) {</span>
            //no existing conversation, so none _since_ the last message
<span class="nc" id="L130">            return new ArrayList&lt;&gt;();</span>
        }

<span class="fc" id="L133">        long senderAccountId = messageWebBean.getDefaultAccountId(senderId);</span>

<span class="fc" id="L135">        Message lastMessagePossiblyDraft = existingConversation.getLatestMessage();</span>
<span class="fc bfc" id="L136" title="All 2 branches covered.">        if (senderAccountId != accountIdForExistingConversation) {</span>
            //If the message the sender has is a draft, we need that one so we can check for new participants
<span class="fc" id="L138">            Message lastSendersMessage = encounterManager.getLastMessageOnConversationIncludeDraft(getLoggedInEHRRequestContext(), &quot;&quot; + senderId,</span>
<span class="fc" id="L139">                    senderAccountId, existingConversation.getEncounterUniqueId());</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">            if (lastSendersMessage != null</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">                    &amp;&amp; lastSendersMessage.isDraft()) {</span>
<span class="fc" id="L142">                lastMessagePossiblyDraft = lastSendersMessage;</span>
            }
        }

<span class="fc" id="L146">        Set&lt;String&gt; oldParticipantsSet = new HashSet&lt;&gt;(lastMessagePossiblyDraft.getParticipants());</span>
<span class="fc" id="L147">        Set&lt;String&gt; currentParticipantsSet = new HashSet&lt;&gt;(lastMessagePossiblyDraft.getParticipants());</span>

<span class="fc bfc" id="L149" title="All 2 branches covered.">        if (lastMessagePossiblyDraft.isDraft()) {</span>
            // get old list of participants from last non-draft message
            // draft message will have the newly added participants but these participants will not have any messages copied
<span class="fc" id="L152">            Message nonDraftMessage = encounterManager.getLastMessageOnConversationExcludeDraft(getLoggedInEHRRequestContext(), &quot;&quot; + senderId,</span>
<span class="fc" id="L153">                    accountIdForExistingConversation, existingConversation.getEncounterUniqueId());</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">            if (nonDraftMessage != null) {</span>
<span class="fc" id="L155">                oldParticipantsSet = new HashSet&lt;&gt;(nonDraftMessage.getParticipants());</span>
            }
        }

        // ensure the sender is in the participants. If they're replying to a message from the patient record they might not be.
<span class="fc" id="L160">        currentParticipantsSet.add(&quot;&quot; + senderId);</span>

<span class="fc" id="L162">        Set&lt;String&gt; newParticipantsSet = new HashSet&lt;&gt;();</span>
<span class="fc" id="L163">        newParticipantsSet.addAll(currentParticipantsSet);</span>
<span class="fc" id="L164">        newParticipantsSet.removeAll(oldParticipantsSet);</span>
<span class="fc" id="L165">        return new ArrayList&lt;&gt;(newParticipantsSet);</span>
    }

    /**
     * The Javascript allowing for streamable attachments to display should be added once, and only once, to the page.
     */
    public boolean isFirstAttachmentOnPage() {
<span class="fc bfc" id="L172" title="All 2 branches covered.">        if (attachmentJavascriptInstances &gt; 0) {</span>
<span class="fc" id="L173">            return false;</span>
        }
<span class="fc" id="L175">        attachmentJavascriptInstances++;</span>
<span class="fc" id="L176">        return true;</span>
    }

    String discardDraft(Long messageId, UUID conversationId) {
        try {
<span class="fc" id="L181">            encounterManager.transactional(() -&gt;</span>
<span class="fc" id="L182">                    encounterManager.deleteDraftMessage(</span>
<span class="fc" id="L183">                            getEHRRequestContext(), messageId, conversationId</span>
                    )
            );
<span class="nc" id="L186">        } catch (RuntimeException e) {</span>
<span class="nc" id="L187">            addActionError(getText(&quot;deleteDraftMessageAction.err.unable_to_delete&quot;));</span>
<span class="nc" id="L188">            BaseAction.LOGGER.error(&quot;Error while deleting the draft-&quot;, e);</span>
<span class="nc" id="L189">            throw e;</span>
<span class="fc" id="L190">        }</span>
<span class="fc" id="L191">        return SUCCESS;</span>
    }

    public EncounterManager getEncounterManager() {
<span class="fc" id="L195">        return encounterManager;</span>
    }

    public void setEncounterManager(EncounterManager encounterManager) {
<span class="fc" id="L199">        this.encounterManager = encounterManager;</span>
<span class="fc" id="L200">    }</span>

    public ParticipantManager getParticipantManager() {
<span class="fc" id="L203">        return participantManager;</span>
    }

    public void setParticipantManager(ParticipantManager participantManager) {
<span class="fc" id="L207">        this.participantManager = participantManager;</span>
<span class="fc" id="L208">    }</span>

    public String getAttachmentSubmit() {
<span class="fc" id="L211">        return attachmentSubmit;</span>
    }

    public void setAttachmentSubmit(String attachmentSubmit) {
<span class="fc" id="L215">        this.attachmentSubmit = attachmentSubmit;</span>
<span class="fc" id="L216">    }</span>

    protected String reloadForm() throws Exception {
        //default call input or the sub class can override
<span class="nc" id="L220">        return input();</span>
    }

    public TeamUserManager getTeamUserManager() {
<span class="fc" id="L224">        return teamUserManager;</span>
    }

    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L228">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L229">    }</span>

    public ParticipantSelectorService getParticipantSelectorService() {
<span class="fc" id="L232">        return participantSelectorService;</span>
    }

    public void setParticipantSelectorService(ParticipantSelectorService participantSelectorService) {
<span class="fc" id="L236">        this.participantSelectorService = participantSelectorService;</span>
<span class="fc" id="L237">    }</span>

    public void setAutoSaveService(AutoSaveService autoSaveService) {
<span class="fc" id="L240">        this.autoSaveService = autoSaveService;</span>
<span class="fc" id="L241">    }</span>

    public List&lt;String&gt; getTbmSelectedTeam() {
<span class="fc" id="L244">        return tbmSelectedTeam;</span>
    }

    public void setTbmSelectedTeam(List&lt;String&gt; tbmSelectedTeam) {
<span class="fc" id="L248">        this.tbmSelectedTeam = tbmSelectedTeam;</span>
<span class="fc" id="L249">    }</span>

    public LoggedInEHRRequestContext getLoggedinContext() {
<span class="fc" id="L252">        return loggedinContext;</span>
    }

    public void setLoggedinContext(LoggedInEHRRequestContext loggedinContext) {
<span class="fc" id="L256">        this.loggedinContext = loggedinContext;</span>
<span class="fc" id="L257">    }</span>

    public EncounterClassLocalizationHelper getEncounterClassLocalizationHelper() {
<span class="fc" id="L260">        return encounterClassLocalizationHelper;</span>
    }

    public void setEncounterClassLocalizationHelper(EncounterClassLocalizationHelper encounterClassLocalizationHelper) {
<span class="fc" id="L264">        this.encounterClassLocalizationHelper = encounterClassLocalizationHelper;</span>
<span class="fc" id="L265">    }</span>

    public Map&lt;EncounterClass, String&gt; getEncounterToTextMap() {
<span class="fc" id="L268">        return encounterClassLocalizationHelper.getLocalizedMap(getLocale(), (key, locale) -&gt; getText(key));</span>
    }

    public MessageScreenDto getMessageScreenDto() {
<span class="fc" id="L272">        return messageScreenDto;</span>
    }

    public void setMessageScreenDto(MessageScreenDto messageScreenDto) {
<span class="fc" id="L276">        this.messageScreenDto = messageScreenDto;</span>
<span class="fc" id="L277">    }</span>

    public TrustedConversationWorkflowService getTrustedConversationWorkflowService() {
<span class="fc" id="L280">        return trustedConversationWorkflowService;</span>
    }

    @Inject
    public void setTrustedConversationWorkflowService(TrustedConversationWorkflowService trustedConversationWorkflowService) {
<span class="fc" id="L285">        this.trustedConversationWorkflowService = trustedConversationWorkflowService;</span>
<span class="fc" id="L286">    }</span>

    @Override
    public String getNamespace() {
<span class="fc" id="L290">        return NAMESPACE_AUTH;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>