<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConversationParticipantBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.message</a> &gt; <span class="el_source">ConversationParticipantBuilder.java</span></div><h1>ConversationParticipantBuilder.java</h1><pre class="source lang-java linenums">package com.pkb.action.message;

import com.pkb.app.dto.ParticipantDTO;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.dto.DiscussionNonPkbParticipantDTO;
import com.pkb.dto.DiscussionParticipantDTO;
import com.pkb.dto.DiscussionParticipantsDTO;
import com.pkb.dto.ImmutableDiscussionNonPkbParticipantDTO;
import com.pkb.dto.ImmutableDiscussionParticipantDTO;
import com.pkb.dto.ImmutableDiscussionParticipantsDTO;
import com.pkb.dto.ImmutableDiscussionTbmParticipantDTO;
import com.pkb.dto.ImmutableUrlDto;
import com.pkb.dto.UrlDto;
import com.pkb.institute.entity.Team;
import com.pkb.service.team.TeamUserManager;
import com.pkb.user.entity.PKBPerson;
import com.pkb.util.UrlUtil;
import org.apache.commons.lang3.StringUtils;
import org.jetbrains.annotations.NotNull;
import org.springframework.context.MessageSource;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Optional;
import java.util.function.BiFunction;
import java.util.function.Function;

import static com.google.common.base.Strings.nullToEmpty;
import static com.pkb.util.WebNamespace.AUTH;
import static java.util.stream.Collectors.toList;
import static org.apache.commons.lang3.StringUtils.isNotBlank;

public class ConversationParticipantBuilder {

    private static final String GET_INBOX = &quot;getInbox&quot;;
    private static final String TAB = &quot;tab&quot;;
    private static final String MESSAGES = &quot;messages&quot;;

    private final TeamUserManager teamUserManager;
    private final MessageSource messageSource;

<span class="fc" id="L45">    public ConversationParticipantBuilder(TeamUserManager teamUserManager, MessageSource messageSource) {</span>
<span class="fc" id="L46">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L47">        this.messageSource = messageSource;</span>
<span class="fc" id="L48">    }</span>

    DiscussionParticipantsDTO sortParticipants(LoggedInEHRRequestContext requestContext,
                                               List&lt;PKBPerson&gt; participants,
                                               List&lt;ParticipantDTO&gt; nonPkbParticipants,
                                               Long patientId,
                                               Locale locale) {
<span class="fc" id="L55">        List&lt;DiscussionParticipantDTO&gt; nonTbmParticipantDTOs = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L56">        Map&lt;Long, ImmutableDiscussionTbmParticipantDTO.Builder&gt; tbmParticipants = new HashMap&lt;&gt;();</span>
<span class="fc" id="L57">        List&lt;DiscussionNonPkbParticipantDTO&gt; nonPkbParticipantsDTOs = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L59">        List&lt;Long&gt; participantIds = participants.stream().map(PKBPerson::getId).collect(toList());</span>
<span class="fc" id="L60">        Map&lt;Long, Team&gt; teamMap = teamUserManager.findActivePrimaryTeams(requestContext, participantIds);</span>

<span class="fc" id="L62">        participants.forEach(participant -&gt; {</span>
<span class="fc" id="L63">            Optional&lt;Team&gt; maybeTeam = Optional.ofNullable(teamMap.get(participant.getId()));</span>
<span class="fc" id="L64">            Optional&lt;String&gt; maybeTeamName = maybeTeam.map(Team::getName);</span>
<span class="fc" id="L65">            boolean participantAccountOwner = participant.getId().equals(patientId);</span>
<span class="fc bfc" id="L66" title="All 4 branches covered.">            boolean participantIsCarer = participant.isPatient() &amp;&amp; !participantAccountOwner;</span>
<span class="fc" id="L67">            String fullName = getFullName(locale, participant);</span>

<span class="fc bfc" id="L69" title="All 6 branches covered.">            if (maybeTeam.isPresent() &amp;&amp; maybeTeam.get().isTeamBasedMessagingEnabled() &amp;&amp; participant.isPro()) {</span>
<span class="fc" id="L70">                Team team = maybeTeam.get();</span>
<span class="fc" id="L71">                String teamName = team.getName();</span>
<span class="fc" id="L72">                tbmParticipants.computeIfAbsent(team.getId(), $ -&gt; ImmutableDiscussionTbmParticipantDTO.builder().teamName(teamName))</span>
<span class="fc" id="L73">                        .addParticipants(buildDiscussionParticipantDto(participant, fullName, teamName, participantIsCarer));</span>
<span class="fc" id="L74">            } else {</span>
<span class="fc" id="L75">                Optional&lt;UrlDto&gt; maybeParticipantUrl = buildParticipantUrl(participantAccountOwner, participant, fullName);</span>
<span class="fc" id="L76">                Optional&lt;String&gt; fullNameWithMeta = buildFullNameWithMeta(participant, fullName, maybeTeamName, participantIsCarer, locale);</span>
<span class="fc" id="L77">                DiscussionParticipantDTO participantDTO = buildDiscussionParticipantDto(participant, fullName, fullNameWithMeta, maybeTeamName,</span>
                        participantIsCarer, maybeParticipantUrl);
<span class="fc" id="L79">                nonTbmParticipantDTOs.add(participantDTO);</span>
            }
<span class="fc" id="L81">        });</span>

<span class="fc" id="L83">        nonPkbParticipants.forEach(nonPkbParticipant -&gt; {</span>
<span class="fc" id="L84">            String fullName = nonPkbParticipant.getNonpkbParticipant();</span>
<span class="fc" id="L85">            String role = getText(locale).apply(&quot;discussionCenter.txt.participant_nonpkb_&quot; + nonPkbParticipant.getRole(), null);</span>
<span class="fc" id="L86">            String nameWithMeta = getText(locale).apply(&quot;discussionCenter.txt.name_and_meta&quot;, new String[]{ fullName, role });</span>

<span class="fc" id="L88">            DiscussionNonPkbParticipantDTO discussionNonPkbParticipantDTO = ImmutableDiscussionNonPkbParticipantDTO.builder()</span>
<span class="fc" id="L89">                    .fullName(fullName)</span>
<span class="fc" id="L90">                    .role(role)</span>
<span class="fc" id="L91">                    .fullNameWithMeta(nameWithMeta)</span>
<span class="fc" id="L92">                    .build();</span>
<span class="fc" id="L93">            nonPkbParticipantsDTOs.add(discussionNonPkbParticipantDTO);</span>
<span class="fc" id="L94">        });</span>

<span class="fc" id="L96">        List&lt;ImmutableDiscussionTbmParticipantDTO&gt; tbmParticipantList = tbmParticipants.values().stream()</span>
<span class="fc" id="L97">                .map(ImmutableDiscussionTbmParticipantDTO.Builder::build)</span>
<span class="fc" id="L98">                .collect(toList());</span>
<span class="fc" id="L99">        List&lt;DiscussionParticipantDTO&gt; sortedNonTbmParticipants = sortParticipants(nonTbmParticipantDTOs);</span>

<span class="fc" id="L101">        return ImmutableDiscussionParticipantsDTO.builder()</span>
<span class="fc" id="L102">                .addAllNonTbmParticipants(sortedNonTbmParticipants)</span>
<span class="fc" id="L103">                .addAllTbmParticipants(tbmParticipantList)</span>
<span class="fc" id="L104">                .addAllNonPkbParticipants(nonPkbParticipantsDTOs)</span>
<span class="fc" id="L105">                .build();</span>
    }

    private Optional&lt;String&gt; buildFullNameWithMeta(PKBPerson participant, String fullName, Optional&lt;String&gt; maybeTeamName, boolean participantIsCarer, Locale locale) {
<span class="fc" id="L109">        Optional&lt;String&gt; maybeNameMeta = buildNameMeta(locale, participant, maybeTeamName, participantIsCarer);</span>
<span class="fc" id="L110">        return maybeNameMeta.map(nameMeta -&gt; getText(locale).apply(&quot;discussionCenter.txt.name_and_meta&quot;, new String[]{ fullName, nameMeta }));</span>
    }

    private Optional&lt;String&gt; buildNameMeta(Locale locale, PKBPerson participant, Optional&lt;String&gt; maybeTeamName, boolean participantIsCarer) {
<span class="fc bfc" id="L114" title="All 2 branches covered.">        if (participantIsCarer) {</span>
<span class="fc" id="L115">            return Optional.of(getTextWithoutArgs(locale).apply(&quot;discussionCenter.txt.carer&quot;));</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">        } else if (participant.isPro()) {</span>
<span class="fc" id="L117">            return maybeTeamName.or(() -&gt; Optional.of(getTextWithoutArgs(locale).apply(&quot;discussionCenter.txt.individual_professional&quot;)));</span>
        }
<span class="fc" id="L119">        return Optional.empty();</span>
    }

    private Optional&lt;UrlDto&gt; buildParticipantUrl(boolean participantAccountOwner, PKBPerson participant, String fullName) {
<span class="fc bfc" id="L123" title="All 2 branches covered.">        if (participantAccountOwner) {</span>
<span class="fc" id="L124">            UrlDto participantUrl = ImmutableUrlDto.builder()</span>
<span class="fc" id="L125">                    .href(UrlUtil.buildHref(AUTH, GET_INBOX, Map.of(TAB, MESSAGES), participant.getId()))</span>
<span class="fc" id="L126">                    .content(fullName)</span>
<span class="fc" id="L127">                    .build();</span>
<span class="fc" id="L128">            return Optional.of(participantUrl);</span>
        }
<span class="fc" id="L130">        return Optional.empty();</span>
    }

    private String getFullName(Locale locale, PKBPerson participant) {
<span class="fc" id="L134">        return Optional.ofNullable(participant.getTitle())</span>
<span class="fc" id="L135">                .filter(StringUtils::isNotBlank)</span>
<span class="fc" id="L136">                .map(title -&gt; getText(locale).apply(&quot;discussionCenter.txt.fullName&quot;,</span>
<span class="fc" id="L137">                        new String[]{ title, participant.getFirstName(), participant.getLastName() }))</span>
<span class="fc" id="L138">                .orElse(getText(locale).apply(&quot;discussionCenter.txt.first_name_last_name&quot;,</span>
<span class="fc" id="L139">                        new String[]{ participant.getFirstName(), participant.getLastName() }));</span>
    }

    @NotNull
    private List&lt;DiscussionParticipantDTO&gt; sortParticipants(List&lt;DiscussionParticipantDTO&gt; nonTbmParticipants) {
<span class="fc" id="L144">        return nonTbmParticipants.stream().sorted((a, b) -&gt; {</span>
<span class="fc bfc" id="L145" title="All 4 branches covered.">            if (a.getTeamName().isEmpty() &amp;&amp; b.getTeamName().isEmpty()) {</span>
<span class="pc bpc" id="L146" title="3 of 4 branches missed.">                if (a.isPro() &amp;&amp; b.isPatient()) {</span>
<span class="nc" id="L147">                    return 1;</span>
                }

<span class="pc bpc" id="L150" title="2 of 4 branches missed.">                if (a.isPatient() &amp;&amp; b.isPro()) {</span>
<span class="nc" id="L151">                    return -1;</span>
                }

<span class="fc" id="L154">                return 0;</span>
            }

<span class="fc bfc" id="L157" title="All 4 branches covered.">            if (a.getTeamName().isPresent() &amp;&amp; b.getTeamName().isEmpty()) {</span>
<span class="fc" id="L158">                return 1;</span>
            }

<span class="pc bpc" id="L161" title="1 of 4 branches missed.">            if (a.getTeamName().isEmpty() &amp;&amp; b.getTeamName().isPresent()) {</span>
<span class="fc" id="L162">                return -1;</span>
            }

<span class="fc" id="L165">            return a.getTeamName().get().compareTo(b.getTeamName().get());</span>
<span class="fc" id="L166">        }).collect(toList());</span>
    }

    /**
     * Sanitize the list of NonPKB Participants for a given Message:
     *
     * &lt;ul&gt;
     * &lt;li&gt;Filters out null attributes that contain the literal word &quot;null&quot;.&lt;/li&gt;
     * &lt;li&gt;Filteres out empty string attributes&lt;/li&gt;
     * &lt;li&gt;If the inputList is null, it will return an empty list.&lt;ParticipantDTO&gt;.&lt;/li&gt;
     * &lt;/ul&gt;
     * &lt;p&gt;
     * Format:
     * &lt;code&gt;&quot;[Prefix] [Given Name] [Middle Name] [Family Name] [Suffix]&quot;&lt;/code&gt;
     */
    List&lt;ParticipantDTO&gt; filterParticipantsNonPKB(List&lt;ParticipantDTO&gt; inputList) {
<span class="fc" id="L182">        List&lt;ParticipantDTO&gt; filtered = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L184" title="All 2 branches covered.">        if (inputList != null) {</span>
<span class="fc" id="L185">            inputList</span>
<span class="fc" id="L186">                    .stream()</span>
<span class="fc" id="L187">                    .filter(dto -&gt; isNotBlank(dto.getNonpkbParticipant()))</span>
<span class="fc" id="L188">                    .forEach(dto -&gt; {</span>
<span class="fc" id="L189">                        List&lt;String&gt; fields = new ArrayList&lt;&gt;();</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">                        for (String token : StringUtils.split(dto.getNonpkbParticipant())) {</span>
<span class="pc bpc" id="L191" title="2 of 4 branches missed.">                            if (isNotBlank(token) &amp;&amp; !&quot;null&quot;.equals(token)) {</span>
<span class="fc" id="L192">                                fields.add(token);</span>
                            }
                        }
<span class="fc" id="L195">                        filtered.add(ParticipantDTO.ParticipantDTOBuilder</span>
<span class="fc" id="L196">                                .forNonPkbParticipant(StringUtils.join(fields, ' '))</span>
<span class="fc" id="L197">                                .withRole(dto.getRole())</span>
<span class="fc" id="L198">                                .get());</span>
<span class="fc" id="L199">                    });</span>
        }

<span class="fc" id="L202">        return filtered;</span>
    }

    private DiscussionParticipantDTO buildDiscussionParticipantDto(PKBPerson participant, String fullName, String teamName, boolean participantIsCarer) {
<span class="fc" id="L206">        return buildDiscussionParticipantDto(participant, fullName, Optional.empty(), Optional.of(teamName), participantIsCarer, Optional.empty());</span>
    }

    private DiscussionParticipantDTO buildDiscussionParticipantDto(PKBPerson participant,
                                                                   String fullName,
                                                                   Optional&lt;String&gt; fullNameWithMeta,
                                                                   Optional&lt;String&gt; teamName,
                                                                   boolean participantIsCarer,
                                                                   Optional&lt;UrlDto&gt; participantUrl) {
<span class="fc" id="L215">        return ImmutableDiscussionParticipantDTO.builder()</span>
<span class="fc" id="L216">                .id(participant.getId())</span>
<span class="fc" id="L217">                .title(nullToEmpty(participant.getTitle()))</span>
<span class="fc" id="L218">                .firstName(nullToEmpty(participant.getFirstName()))</span>
<span class="fc" id="L219">                .lastName(nullToEmpty(participant.getLastName()))</span>
<span class="fc" id="L220">                .fullName(fullName)</span>
<span class="fc" id="L221">                .fullNameWithMeta(fullNameWithMeta)</span>
<span class="fc" id="L222">                .teamName(teamName)</span>
<span class="fc" id="L223">                .userType(participant.getUserType())</span>
<span class="fc" id="L224">                .isCarer(participantIsCarer)</span>
<span class="fc" id="L225">                .nameAsAnchor(participantUrl)</span>
<span class="fc" id="L226">                .build();</span>
    }

    private BiFunction&lt;String, String[], String&gt; getText(Locale locale) {
<span class="fc" id="L230">        return (key, args) -&gt; messageSource.getMessage(key, args, locale);</span>
    }

    private Function&lt;String, String&gt; getTextWithoutArgs(Locale locale) {
<span class="fc" id="L234">        return (key) -&gt; messageSource.getMessage(key, null, locale);</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>