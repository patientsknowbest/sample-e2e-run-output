<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConversationActionItemBuilder.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.message</a> &gt; <span class="el_source">ConversationActionItemBuilder.java</span></div><h1>ConversationActionItemBuilder.java</h1><pre class="source lang-java linenums">package com.pkb.action.message;

import com.google.common.collect.ImmutableMap;
import com.pkb.action.message.workflow.ConversationWorkflowFlags;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.datamodel.DataModelStyle;
import com.pkb.dto.DiscussionParticipantsDTO;
import com.pkb.dto.FormActionItemDto;
import com.pkb.dto.ImmutableFormActionItemDto;
import com.pkb.dto.ImmutableMessageConversationFormDto;
import com.pkb.dto.ImmutableUrlDto;
import com.pkb.encounter.entity.Encounter;
import com.pkb.encounter.entity.Message;
import com.pkb.service.datapoint.DataWithUIPermissions;
import com.pkb.util.UrlUtil;
import org.immutables.value.Value;
import org.immutables.value.Value.Immutable;
import org.springframework.context.MessageSource;

import java.util.Collection;
import java.util.LinkedList;
import java.util.List;
import java.util.Locale;
import java.util.Optional;
import java.util.function.Function;
import java.util.function.Supplier;

import static com.pkb.util.WebNamespace.AUTH;
import static java.lang.String.format;
import static java.util.Objects.requireNonNull;

/**
 * Builds the actions the user can take on a conversation.
 */
public class ConversationActionItemBuilder {

    private final MessageSource messageSource;

<span class="fc" id="L39">    public ConversationActionItemBuilder(MessageSource messageSource) {</span>
<span class="fc" id="L40">        this.messageSource = messageSource;</span>
<span class="fc" id="L41">    }</span>

    List&lt;FormActionItemDto&gt; buildActionItems(ActionItemBuilderInputParams inputParams) {
<span class="fc" id="L44">        DataWithUIPermissions&lt;Encounter&gt; dataWithUIPermissions = inputParams.dataWithUIPermissions();</span>
<span class="fc" id="L45">        Encounter actualConversation = dataWithUIPermissions.getData();</span>
<span class="fc" id="L46">        boolean addParticipantsButtonEnabled =</span>
<span class="pc bpc" id="L47" title="3 of 4 branches missed.">                (!actualConversation.getLatestMessage().isMedForApproval() || actualConversation.getLatestMessage().isDraft())</span>
<span class="fc bfc" id="L48" title="All 6 branches covered.">                &amp;&amp; !inputParams.privateMessage() &amp;&amp; !inputParams.leftDiscussion() &amp;&amp; inputParams.loggedinContext().isSharingEnabled()</span>
<span class="fc bfc" id="L49" title="All 4 branches covered.">                &amp;&amp; !inputParams.threadContainsEvents() &amp;&amp; !inputParams.disableAddContacts();</span>
<span class="fc" id="L50">        boolean notDraftAndUserDidntLeave = notDraftAndUserDidntLeave(actualConversation, inputParams.leftDiscussion());</span>
<span class="fc bfc" id="L51" title="All 6 branches covered.">        boolean assignButtonEnabled = !inputParams.conversationAssigned() &amp;&amp; inputParams.workflowFlags().isAssigningEnabled() &amp;&amp; notDraftAndUserDidntLeave;</span>
<span class="pc bpc" id="L52" title="2 of 6 branches missed.">        boolean unAssignButtonEnabled = inputParams.conversationAssigned() &amp;&amp; inputParams.workflowFlags().isAssigningEnabled() &amp;&amp; notDraftAndUserDidntLeave;</span>
<span class="fc bfc" id="L53" title="All 6 branches covered.">        boolean archiveButtonEnabled = !inputParams.conversationArchived() &amp;&amp; inputParams.workflowFlags().isArchivingEnabled() &amp;&amp; notDraftAndUserDidntLeave;</span>
<span class="pc bpc" id="L54" title="2 of 6 branches missed.">        boolean unArchiveButtonEnabled = inputParams.conversationArchived() &amp;&amp; inputParams.workflowFlags().isArchivingEnabled() &amp;&amp; notDraftAndUserDidntLeave;</span>
<span class="fc bfc" id="L55" title="All 4 branches covered.">        boolean changePrivacyButtonEnabled = !inputParams.hidePrivacyLabels() &amp;&amp; dataWithUIPermissions.isPrivacyFlagEditable();</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">        boolean leaveDiscussion = inputParams.conversationHasMessages()</span>
<span class="pc bpc" id="L57" title="1 of 4 branches missed.">                &amp;&amp; !actualConversation.getLatestMessage().isMedForApproval() &amp;&amp; !inputParams.privateMessage()</span>
<span class="fc bfc" id="L58" title="All 4 branches covered.">                &amp;&amp; inputParams.loggedinContext().isPro() &amp;&amp; inputParams.loggedinContext().isUserInOwnAccount()</span>
<span class="pc bpc" id="L59" title="1 of 4 branches missed.">                &amp;&amp; inputParams.participantsDTO().map(DiscussionParticipantsDTO::hasPkbParticipants).orElse(false)</span>
                &amp;&amp; notDraftAndUserDidntLeave;
<span class="fc" id="L61">        String conversationId = actualConversation.getEncounterUniqueId().toString();</span>
<span class="fc" id="L62">        String optimisticLockVersion = inputParams.optimisticLockVersion().map(String::valueOf).orElse(&quot;&quot;);</span>

<span class="fc" id="L64">        List&lt;FormActionItemDto&gt; actionItems = new LinkedList&lt;&gt;();</span>
<span class="fc" id="L65">        addIf(addParticipantsButtonEnabled,</span>
<span class="fc" id="L66">                () -&gt; ImmutableFormActionItemDto.builder()</span>
<span class="fc" id="L67">                        .anchor(ImmutableUrlDto.builder()</span>
<span class="fc" id="L68">                                .href(&quot;#&quot;)</span>
<span class="fc" id="L69">                                .content(getTextWithoutArgs(inputParams.locale()).apply(&quot;discussionCenter.txt.add_participants&quot;))</span>
<span class="fc" id="L70">                                .id(&quot;add-participants&quot;)</span>
<span class="fc" id="L71">                                .onClick(&quot;submitAddParticipant()&quot;)</span>
<span class="fc" id="L72">                                .build())</span>
<span class="fc" id="L73">                        .iconCssClass(&quot;add-participants&quot;)</span>
<span class="fc" id="L74">                        .build(),</span>
                actionItems);
<span class="fc" id="L76">        addIf(leaveDiscussion,</span>
<span class="fc" id="L77">                () -&gt; buildFormActionItem(&quot;leave-discussion&quot;, &quot;leave-discussion&quot;, &quot;removeCurrentUserFromDiscussion&quot;,</span>
                        conversationId, optimisticLockVersion, &quot;discussionCenter.txt.leave_discussion&quot;, &quot;leave-discussion&quot;,
<span class="fc" id="L79">                        inputParams.locale()),</span>
                actionItems);
<span class="fc" id="L81">        addIf(assignButtonEnabled,</span>
<span class="fc" id="L82">                () -&gt; buildFormActionItem(&quot;workflow-assign&quot;, &quot;workflowAssign&quot;, &quot;assignToMe&quot;,</span>
                        conversationId, optimisticLockVersion, &quot;message.workflow.assign.button.do.text&quot;, &quot;assign-to-me&quot;,
<span class="fc" id="L84">                        inputParams.locale()),</span>
                actionItems);

<span class="fc" id="L87">        addIf(unAssignButtonEnabled,</span>
<span class="fc" id="L88">                () -&gt; buildFormActionItem(&quot;workflow-unassign&quot;, &quot;workflowUnassign&quot;, &quot;unAssign&quot;,</span>
                        conversationId, optimisticLockVersion, &quot;message.workflow.assign.button.undo.text&quot;, &quot;assign-to-none&quot;,
<span class="fc" id="L90">                        inputParams.locale()),</span>
                actionItems);
<span class="fc" id="L92">        addIf(archiveButtonEnabled,</span>
<span class="fc" id="L93">                () -&gt; buildFormActionItem(&quot;workflow-archive&quot;, &quot;workflowArchive&quot;, &quot;archive&quot;,</span>
                        conversationId, optimisticLockVersion, &quot;message.workflow.archive.button.do.text&quot;, &quot;archive-message&quot;,
<span class="fc" id="L95">                        inputParams.locale()),</span>
                actionItems);
<span class="fc" id="L97">        addIf(unArchiveButtonEnabled,</span>
<span class="fc" id="L98">                () -&gt; buildFormActionItem(&quot;workflow-unarchive&quot;, &quot;workflowUnarchive&quot;, &quot;unArchive&quot;,</span>
                        conversationId, optimisticLockVersion, &quot;message.workflow.archive.button.undo.text&quot;, &quot;unarchive-message&quot;,
<span class="fc" id="L100">                        inputParams.locale()),</span>
                actionItems);
<span class="fc" id="L102">        addIf(changePrivacyButtonEnabled,</span>
<span class="fc" id="L103">                () -&gt; ImmutableFormActionItemDto.builder()</span>
<span class="fc" id="L104">                        .anchor(ImmutableUrlDto.builder()</span>
<span class="fc" id="L105">                                .href(UrlUtil.buildHref(AUTH, &quot;editEncounterPrivacyForm&quot;, ImmutableMap.of(</span>
<span class="fc" id="L106">                                                &quot;conversationId&quot;, actualConversation.getEncounterUniqueId().toString(),</span>
<span class="fc" id="L107">                                                &quot;encounterEventUniqueId&quot;, requireNonNull(actualConversation.getFirstMessage()).getBaseFields().getUniqueId().toString()),</span>
<span class="fc" id="L108">                                        inputParams.loggedinContext().getContextOrAccessingUserId()))</span>
<span class="fc" id="L109">                                .content(getTextWithoutArgs(inputParams.locale()).apply(&quot;consentcategory.txt.change_privacy&quot;))</span>
<span class="fc" id="L110">                                .id(&quot;edit-privacy&quot;)</span>
<span class="fc" id="L111">                                .build())</span>
<span class="fc" id="L112">                        .iconCssClass(&quot;change-privacy&quot;)</span>
<span class="fc" id="L113">                        .build(),</span>
                actionItems);
<span class="fc" id="L115">        return actionItems;</span>
    }

    private FormActionItemDto buildFormActionItem(String id,
                                                  String formName,
                                                  String formAction,
                                                  String conversationId,
                                                  String optimisticLockVersion,
                                                  String contentKey,
                                                  String iconClass,
                                                  Locale locale) {
<span class="fc" id="L126">        return ImmutableFormActionItemDto.builder()</span>
<span class="fc" id="L127">                .form(ImmutableMessageConversationFormDto.builder()</span>
<span class="fc" id="L128">                        .name(formName)</span>
<span class="fc" id="L129">                        .action(formAction)</span>
<span class="fc" id="L130">                        .conversationId(conversationId)</span>
<span class="fc" id="L131">                        .workflowOptimisticLock(optimisticLockVersion)</span>
<span class="fc" id="L132">                        .build())</span>
<span class="fc" id="L133">                .anchor(ImmutableUrlDto.builder()</span>
<span class="fc" id="L134">                        .href(&quot;#&quot;)</span>
<span class="fc" id="L135">                        .onClick(format(&quot;submitStandardForm('%s')&quot;, formName))</span>
<span class="fc" id="L136">                        .content(getTextWithoutArgs(locale).apply(contentKey))</span>
<span class="fc" id="L137">                        .id(id)</span>
<span class="fc" id="L138">                        .build())</span>
<span class="fc" id="L139">                .iconCssClass(iconClass)</span>
<span class="fc" id="L140">                .build();</span>
    }

    private boolean notDraftAndUserDidntLeave(Encounter conversation, boolean leftDiscussion) {
<span class="fc bfc" id="L144" title="All 4 branches covered.">        return Optional.ofNullable(conversation.getFirstMessage()).filter(Message::isDraft).isEmpty() &amp;&amp; !leftDiscussion;</span>
    }

    private Function&lt;String, String&gt; getTextWithoutArgs(Locale locale) {
<span class="fc" id="L148">        return (key) -&gt; messageSource.getMessage(key, null, locale);</span>
    }

    private &lt;T&gt; void addIf(boolean condition, Supplier&lt;T&gt; actionItemBuilder, Collection&lt;T&gt; actionItems) {
<span class="fc bfc" id="L152" title="All 2 branches covered.">        if (condition) {</span>
<span class="fc" id="L153">            actionItems.add(actionItemBuilder.get());</span>
        }
<span class="fc" id="L155">    }</span>

    @Immutable
    @DataModelStyle
    @Value.Style(stagedBuilder = true)
    public interface ActionItemBuilderInputParams {
        boolean disableAddContacts();

        boolean threadContainsEvents();

        boolean conversationAssigned();

        boolean conversationArchived();

        boolean hidePrivacyLabels();

        boolean privateMessage();

        boolean leftDiscussion();

        boolean conversationHasMessages();

        ConversationWorkflowFlags workflowFlags();

        Optional&lt;DiscussionParticipantsDTO&gt; participantsDTO();

        Optional&lt;Integer&gt; optimisticLockVersion();

        DataWithUIPermissions&lt;Encounter&gt; dataWithUIPermissions();

        Locale locale();

        LoggedInEHRRequestContext loggedinContext();

    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>