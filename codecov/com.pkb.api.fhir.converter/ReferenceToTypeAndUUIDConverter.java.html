<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReferenceToTypeAndUUIDConverter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.fhir.converter</a> &gt; <span class="el_source">ReferenceToTypeAndUUIDConverter.java</span></div><h1>ReferenceToTypeAndUUIDConverter.java</h1><pre class="source lang-java linenums">package com.pkb.api.fhir.converter;

import com.pkb.api.fhir.util.Issues;
import io.vavr.collection.Array;
import io.vavr.control.Validation;
import org.apache.commons.lang3.tuple.Pair;
import org.hl7.fhir.dstu3.model.Reference;
import org.hl7.fhir.dstu3.model.ResourceType;
import org.hl7.fhir.exceptions.FHIRException;
import org.jetbrains.annotations.NotNull;

import java.util.ArrayList;
import java.util.EnumSet;
import java.util.List;
import java.util.Optional;
import java.util.UUID;

import static com.pkb.api.fhir.util.Fhirs.uuid;
import static io.vavr.control.Validation.invalid;
import static io.vavr.control.Validation.valid;
import static java.lang.String.format;
import static org.apache.commons.lang3.StringUtils.isBlank;

<span class="fc" id="L24">public class ReferenceToTypeAndUUIDConverter {</span>

    public @NotNull Validation&lt;Issues, Pair&lt;ResourceType, UUID&gt;&gt; convertFromAllowedResourceTypes(@NotNull Reference reference,
            EnumSet&lt;ResourceType&gt; allowedTypes) {
<span class="fc" id="L28">        return convert(reference).flatMap(pair -&gt; {</span>
<span class="fc bfc" id="L29" title="All 2 branches covered.">            if (allowedTypes.contains(pair.getLeft())) {</span>
<span class="fc" id="L30">                return valid(pair);</span>
            }
<span class="fc" id="L32">            return invalid(Issues.errorFrom(format(&quot;Resource Type '%s' is not allowed for this operation&quot;,pair.getLeft())));</span>
        });
    }

    public @NotNull Validation&lt;Issues, List&lt;Pair&lt;ResourceType, UUID&gt;&gt;&gt; convertFromAllowedResourceTypes(List&lt;Reference&gt; references, 
                                                                                                       EnumSet&lt;ResourceType&gt; allowedTypes) {
<span class="fc" id="L38">        List&lt;Pair&lt;ResourceType,UUID&gt;&gt; resourceIds = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L39">        List&lt;Issues&gt; issues = new ArrayList&lt;&gt;();</span>
       
<span class="fc" id="L41">        references.forEach(ref -&gt; convertFromAllowedResourceTypes(ref, allowedTypes).fold(issues::add, resourceIds::add));</span>

<span class="fc bfc" id="L43" title="All 2 branches covered.">        return issues.isEmpty() ? Validation.valid(resourceIds) : Validation.invalid(Issues.flatten(Array.ofAll(issues)));</span>
    }

    private @NotNull Validation&lt;Issues, Pair&lt;ResourceType, UUID&gt;&gt; convert(@NotNull Reference reference) {
<span class="fc" id="L47">        String referenceURL = reference.getReference();</span>
<span class="pc bpc" id="L48" title="1 of 2 branches missed.">        if (isBlank(referenceURL)) {</span>
<span class="nc" id="L49">            return invalid(Issues.errorFrom(&quot;The reference has no URL value&quot;));</span>
        }
<span class="fc" id="L51">        String urlParts[] = referenceURL.split(&quot;/&quot;);</span>
<span class="fc bfc" id="L52" title="All 2 branches covered.">        if (urlParts.length != 2) {</span>
<span class="fc" id="L53">            return invalid(Issues.errorFrom(&quot;The reference URL needs to match the following pattern: &lt;ResourceType&gt;/&lt;UUID&gt;&quot;));</span>
        }
<span class="fc" id="L55">        Optional&lt;ResourceType&gt; maybeType = toFhirResourceType(urlParts[0]);</span>
<span class="fc bfc" id="L56" title="All 2 branches covered.">        if (maybeType.isEmpty()) {</span>
<span class="fc" id="L57">            return invalid(Issues.errorFrom(format(&quot;The Resource Type '%s' is invalid&quot;, urlParts[0])));</span>
        }
<span class="fc" id="L59">        var maybeUUID = uuid(urlParts[1]);</span>
<span class="pc bpc" id="L60" title="1 of 2 branches missed.">        if (maybeUUID.isLeft()) {</span>
<span class="nc" id="L61">            return invalid(Issues.of(io.vavr.collection.List.ofAll(maybeUUID.getLeft().getIssue())));</span>
        }
<span class="fc" id="L63">        return valid(Pair.of(maybeType.get(), maybeUUID.get()));</span>
    }

    private Optional&lt;ResourceType&gt; toFhirResourceType(String typeString) {
        try {
<span class="fc" id="L68">            return Optional.of(ResourceType.fromCode(typeString));</span>
<span class="fc" id="L69">        } catch (FHIRException ignored) {</span>
<span class="fc" id="L70">            return Optional.empty();</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>