<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DateRangeParamToDateRangeRestrictionConverter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.fhir.converter</a> &gt; <span class="el_source">DateRangeParamToDateRangeRestrictionConverter.java</span></div><h1>DateRangeParamToDateRangeRestrictionConverter.java</h1><pre class="source lang-java linenums">package com.pkb.api.fhir.converter;

import ca.uhn.fhir.rest.param.DateRangeParam;
import ca.uhn.fhir.rest.param.ParamPrefixEnum;
import com.pkb.api.fhir.util.Issues;
import com.pkb.api.fhir.util.NamedParam;
import com.pkb.domain.criteria.Constraint;
import com.pkb.domain.criteria.ImmutableRestriction;
import com.pkb.domain.criteria.ImmutableTemporalRangeRestriction;
import com.pkb.domain.criteria.LowerBound;
import com.pkb.domain.criteria.Restriction;
import com.pkb.domain.criteria.TemporalRangeRestriction;
import com.pkb.domain.criteria.UpperBound;
import io.vavr.control.Option;
import io.vavr.control.Validation;
import org.jetbrains.annotations.NotNull;

import java.time.LocalDate;

import static com.pkb.domain.criteria.ImmutableRestriction.restriction;
import static com.pkb.domain.criteria.ImmutableTemporalRangeRestriction.temporalRangeRestriction;
import static com.pkb.domain.criteria.LowerBound.GREATER_OR_EQUAL;
import static com.pkb.domain.criteria.TemporalRangeRestriction.unbounded;
import static com.pkb.domain.criteria.UpperBound.LESS;
import static io.vavr.control.Validation.valid;
import static java.util.function.Function.identity;

public class DateRangeParamToDateRangeRestrictionConverter {

    private DateParamToDateRestrictionConverter dateParamToRestriction;

<span class="fc" id="L32">    public DateRangeParamToDateRangeRestrictionConverter(DateParamToDateRestrictionConverter dateParamToRestriction) {</span>
<span class="fc" id="L33">        this.dateParamToRestriction = dateParamToRestriction;</span>
<span class="fc" id="L34">    }</span>

    public @NotNull Validation&lt;Issues, TemporalRangeRestriction&lt;LocalDate&gt;&gt; convert(@NotNull NamedParam&lt;DateRangeParam&gt; range) {
<span class="fc bfc" id="L37" title="All 2 branches covered.">        if (!range.successfullyParsed()) {</span>
<span class="fc" id="L38">            return valid(unbounded());</span>
        }

<span class="fc bfc" id="L41" title="All 2 branches covered.">        if (isConsideredAsEqualPseudoRange(range.getParam())) {</span>
<span class="fc" id="L42">            return convertEqualPseudoRange(range);</span>
        } else {
<span class="fc" id="L44">            return convertRegularBoundedOrUnboundedRange(range);</span>
        }
    }

    public @NotNull Validation&lt;Issues, TemporalRangeRestriction&lt;LocalDate&gt;&gt; convertWithEqual(@NotNull NamedParam&lt;DateRangeParam&gt; range) {
<span class="fc bfc" id="L49" title="All 2 branches covered.">        if (!range.successfullyParsed()) {</span>
<span class="fc" id="L50">            return valid(unbounded());</span>
        }
<span class="fc bfc" id="L52" title="All 2 branches covered.">        if (isConsideredAsEqualPseudoRange(range.getParam())) {</span>
<span class="fc" id="L53">            return convertEqualRange(range);</span>
        } else {
<span class="fc" id="L55">            return convertRegularBoundedOrUnboundedRange(range);</span>
        }
    }

    private Validation&lt;Issues, TemporalRangeRestriction&lt;LocalDate&gt;&gt; convertRegularBoundedOrUnboundedRange(@NotNull NamedParam&lt;DateRangeParam&gt; range) {
<span class="fc" id="L60">        Validation&lt;Issues, Option&lt;Restriction&lt;Constraint, LocalDate&gt;&gt;&gt; issuesOrLowerBound = Option.of(range.getParam().getLowerBound())</span>
<span class="fc" id="L61">                .map(lowerBound -&gt; dateParamToRestriction.convert(new NamedParam&lt;&gt;(range.getName(), lowerBound, range.getOriginalValues())))</span>
<span class="fc" id="L62">                .getOrElse(valid(Option.none()));</span>

<span class="fc" id="L64">        Validation&lt;Issues, Option&lt;Restriction&lt;Constraint, LocalDate&gt;&gt;&gt; issuesOrUpperBound = Option.of(range.getParam().getUpperBound())</span>
<span class="fc" id="L65">                .map(upperBound -&gt; dateParamToRestriction.convert(new NamedParam&lt;&gt;(range.getName(), upperBound, range.getOriginalValues())))</span>
<span class="fc" id="L66">                .getOrElse(valid(Option.none()));</span>

<span class="fc" id="L68">        return Validation.combine(issuesOrLowerBound, issuesOrUpperBound).ap((maybeLowerBound, maybeUpperBound) -&gt; {</span>
<span class="fc" id="L69">            ImmutableTemporalRangeRestriction.Builder&lt;LocalDate&gt; builder = ImmutableTemporalRangeRestriction.builder();</span>

<span class="fc" id="L71">            maybeLowerBound.peek(lowerBound -&gt; {</span>
<span class="fc" id="L72">                builder.lowerBound(toLowerBoundRestriction(lowerBound));</span>
<span class="fc" id="L73">            });</span>

<span class="fc" id="L75">            maybeUpperBound.peek(upperBound -&gt; {</span>
<span class="fc" id="L76">                builder.upperBound(toUpperBoundRestriction(upperBound));</span>
<span class="fc" id="L77">            });</span>

<span class="fc" id="L79">            return (TemporalRangeRestriction&lt;LocalDate&gt;) builder.build();</span>
<span class="fc" id="L80">        }).mapError(Issues::flatten);</span>
    }

    /**
     * We treat equal search as a pseudo range where the lower boundary is GE and the upper boundary is LT.
     * Example: FHIR converts eq2017-11-07 to &lt;eq2017-11-07,eq2017-11-07&gt; and we turn it into pseudo range &lt;ge2017-11-07,lt2017-11-08&gt;
     * 
     * @param range
     *            the equal search param that will be converted into a pseudo range.
     * @return the converted ge(x) AND lt(x+1) range.
     */
    private Validation&lt;Issues, TemporalRangeRestriction&lt;LocalDate&gt;&gt; convertEqualPseudoRange(NamedParam&lt;DateRangeParam&gt; range) {
<span class="fc" id="L92">        return convertLowerBoundFrom(range)</span>
<span class="fc" id="L93">                .map(maybeLowerBound -&gt; maybeLowerBound</span>
<span class="fc" id="L94">                        .map(Restriction::getValue)</span>
<span class="fc" id="L95">                        .map(date -&gt; {</span>
<span class="fc" id="L96">                            Option&lt;Restriction&lt;LowerBound, LocalDate&gt;&gt; lowerBound = Option.of(restriction(GREATER_OR_EQUAL, date));</span>
<span class="fc" id="L97">                            Option&lt;Restriction&lt;UpperBound, LocalDate&gt;&gt; upperBound = Option.of(restriction(LESS, date.plusDays(1)));</span>
<span class="fc" id="L98">                            return (TemporalRangeRestriction&lt;LocalDate&gt;) temporalRangeRestriction(lowerBound, upperBound, Option.none());</span>
                        })
<span class="pc" id="L100">                        .getOrElseThrow(() -&gt; new IllegalStateException(&quot;Expecting an equal pseudo-range to be present.&quot;)))</span>
<span class="fc" id="L101">                .mapError(identity());</span>
    }

    private Validation&lt;Issues, TemporalRangeRestriction&lt;LocalDate&gt;&gt; convertEqualRange(NamedParam&lt;DateRangeParam&gt; range) {
<span class="fc" id="L105">        return convertLowerBoundFrom(range)</span>
<span class="fc" id="L106">                .map(maybeLowerBound -&gt; maybeLowerBound</span>
<span class="fc" id="L107">                        .map(Restriction::getValue)</span>
<span class="fc" id="L108">                        .map(date -&gt; (TemporalRangeRestriction&lt;LocalDate&gt;) temporalRangeRestriction(</span>
<span class="fc" id="L109">                                Option.none(), Option.none(), Option.of(date)))</span>
<span class="pc" id="L110">                        .getOrElseThrow(() -&gt; new IllegalStateException(&quot;Expecting an equal pseudo-range to be present.&quot;)))</span>
<span class="fc" id="L111">                .mapError(identity());</span>
    }

    @NotNull
    private Validation&lt;Issues, Option&lt;Restriction&lt;Constraint, LocalDate&gt;&gt;&gt; convertLowerBoundFrom(NamedParam&lt;DateRangeParam&gt; range) {
<span class="fc" id="L116">        return dateParamToRestriction</span>
<span class="fc" id="L117">                .convert(new NamedParam&lt;&gt;(range.getName(), range.getParam().getLowerBound(), range.getOriginalValues()));</span>
    }

    /**
     * FHIR handles the equal prefix by populating both lower and upper range with the same value. This method
     * check the given DateRangeParam if it was an equal search.
     * 
     * @param range
     *            the range to check
     * @return true if the range is an equal search, fales otherwise.
     */
    private boolean isConsideredAsEqualPseudoRange(DateRangeParam range) {
<span class="fc bfc" id="L129" title="All 4 branches covered.">        return range.getLowerBound() != null &amp;&amp; range.getLowerBound().getPrefix() == ParamPrefixEnum.EQUAL &amp;&amp;</span>
<span class="pc bpc" id="L130" title="2 of 4 branches missed.">                range.getUpperBound() != null &amp;&amp; range.getUpperBound().getPrefix() == ParamPrefixEnum.EQUAL;</span>
    }

    private Restriction&lt;LowerBound, LocalDate&gt; toLowerBoundRestriction(Restriction&lt;Constraint, LocalDate&gt; restriction) {
<span class="fc" id="L134">        return ImmutableRestriction.&lt;LowerBound, LocalDate&gt; builder()</span>
<span class="fc" id="L135">                .value(restriction.getValue())</span>
<span class="fc" id="L136">                .constraint(toLowerBound(restriction.getConstraint()))</span>
<span class="fc" id="L137">                .build();</span>
    }

    private LowerBound toLowerBound(Constraint constraint) {
<span class="fc bfc" id="L141" title="All 2 branches covered.">        if (constraint == Constraint.GREATER) {</span>
<span class="fc" id="L142">            return LowerBound.GREATER;</span>
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">        } else if (constraint == Constraint.GREATER_OR_EQUAL) {</span>
<span class="fc" id="L144">            return GREATER_OR_EQUAL;</span>
        } else {
<span class="nc" id="L146">            throw new RuntimeException(String.format(&quot;Unsupported constraint for lower boundary [%s]&quot;, constraint));</span>
        }
    }

    private Restriction&lt;UpperBound, LocalDate&gt; toUpperBoundRestriction(Restriction&lt;Constraint, LocalDate&gt; restriction) {
<span class="fc" id="L151">        return ImmutableRestriction.&lt;UpperBound, LocalDate&gt;builder()</span>
<span class="fc" id="L152">                .value(restriction.getValue())</span>
<span class="fc" id="L153">                .constraint(toUpperBound(restriction.getConstraint()))</span>
<span class="fc" id="L154">                .build();</span>
    }

    private UpperBound toUpperBound(Constraint constraint) {
<span class="fc bfc" id="L158" title="All 2 branches covered.">        if (constraint == Constraint.LESS) {</span>
<span class="fc" id="L159">            return LESS;</span>
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        } else if (constraint == Constraint.LESS_OR_EQUAL) {</span>
<span class="fc" id="L161">            return UpperBound.LESS_OR_EQUAL;</span>
        } else {
<span class="nc" id="L163">            throw new RuntimeException(String.format(&quot;Unsupported constraint for upper boundary [%s]&quot;, constraint));</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>