<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MdmT11Processor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.service.dataupload.hl7.processor</a> &gt; <span class="el_source">MdmT11Processor.java</span></div><h1>MdmT11Processor.java</h1><pre class="source lang-java linenums">package com.pkb.service.dataupload.hl7.processor;

import com.pkb.app.entity.EHRRequestContext;
import com.pkb.consent.model.NoConsentsRequired;
import com.pkb.dataupload.entity.FieldMismatch;
import com.pkb.dataupload.entity.UploadedDataDTO;
import com.pkb.service.dataupload.hl7.HL7ApiHelper;
import com.pkb.service.dataupload.hl7.HL7ConnContext;
import com.pkb.service.dataupload.hl7.HL7SoftMatchService;
import com.pkb.service.dataupload.hl7.HL7XmlDoc;
import com.pkb.service.dataupload.impl.DataUploadManager;
import com.pkb.service.encounter.impl.tolven.EncounterManager;
import com.pkb.user.entity.PKBPerson;
import io.vavr.Tuple2;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.lang.invoke.MethodHandles;
import java.util.List;
import java.util.UUID;

import static com.pkb.dataupload.entity.UploadedData.Destination.DOCUMENT;
import static com.pkb.dataupload.entity.UploadedData.Status.NEW;
import static com.pkb.dataupload.entity.UploadedData.Status.PATIENT_INFO_MISMATCH;
import static com.pkb.dataupload.entity.UploadedData.Status.REJECTED;
import static com.pkb.service.dataupload.hl7.HL7SoftMatchService.ProcessingDecision;

public class MdmT11Processor {

<span class="fc" id="L31">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

    private DataUploadManager dataUploadManager;
    private EncounterManager encounterManager;
    private HL7SoftMatchService hl7SoftMatchService;

<span class="fc" id="L37">    public MdmT11Processor(DataUploadManager dataUploadManager, EncounterManager encounterManager, HL7SoftMatchService hl7SoftMatchService) {</span>
<span class="fc" id="L38">        this.dataUploadManager = dataUploadManager;</span>
<span class="fc" id="L39">        this.encounterManager = encounterManager;</span>
<span class="fc" id="L40">        this.hl7SoftMatchService = hl7SoftMatchService;</span>
<span class="fc" id="L41">    }</span>

    public ProcessingDecision process(@NotNull HL7XmlDoc hl7, @NotNull HL7ConnContext hl7ConnContext, @NotNull PKBPerson patient,
                                                          @NotNull List&lt;FieldMismatch&gt; pidMismatches, @NotNull HL7ApiHelper apiHelper) {

<span class="fc" id="L46">        LOGGER.info(&quot;Processing a document deletion&quot;);</span>

        // Validate the message - this will throw if invalid
<span class="fc" id="L49">        hl7.validateMdmT11DocumentDeletionMessage();</span>

<span class="fc" id="L51">        EHRRequestContext ehrRequestContext = hl7ConnContext.getEHRRequestContext();</span>

<span class="fc" id="L53">        ProcessingDecision processingDecision = hl7SoftMatchService.getProcessingDecision(DOCUMENT,</span>
<span class="fc" id="L54">                hl7ConnContext.getSourceOrgId(), hl7.getMdmDocumentId().getString(), patient.getId(), pidMismatches);</span>
<span class="pc bpc" id="L55" title="4 of 5 branches missed.">        switch(processingDecision) {</span>
            case CONTINUE: {
                // Store into uploaded data
<span class="fc" id="L58">                UploadedDataDTO uploadedDataDTO = dataUploadManager.recordHL7DataUpload(hl7ConnContext, hl7, hl7.getMdmDocumentId().getString(), DOCUMENT,</span>
                        NEW, pidMismatches, patient, null/*subsetOf*/);

                // Process immediately
<span class="fc" id="L62">                Tuple2&lt;UUID, Integer&gt; encounterUniqueIdAndDeletedCount = encounterManager.deleteDocumentByExternalDocumentId(</span>
<span class="fc" id="L63">                        ehrRequestContext.withConsentNotRequired(), hl7.getMdmDocumentId().getString(), uploadedDataDTO, patient);</span>

                // Log and notify
<span class="fc bfc" id="L66" title="All 2 branches covered.">                if (encounterUniqueIdAndDeletedCount._1 != null) {</span>
                    // The deletion was processed, notify the patient
<span class="fc" id="L68">                    apiHelper.logDocumentDeletionReceivedAndNotifyPatient(hl7ConnContext, patient, new NoConsentsRequired(), hl7.getMessageType());</span>
                }
            }
<span class="fc" id="L71">            break;</span>
            case FORCE_NEW: {
<span class="nc" id="L73">                dataUploadManager.recordHL7DataUpload(hl7ConnContext, hl7, hl7.getMdmDocumentId().getString(), DOCUMENT,</span>
                        NEW, pidMismatches, patient, null/*subsetOf*/);
<span class="nc" id="L75">                apiHelper.logDocumentDeletionReceivedAndNotifyPatient(hl7ConnContext, patient, new NoConsentsRequired(), hl7.getMessageType());</span>
            }
<span class="nc" id="L77">            break;</span>
            case QUARANTINE: {
<span class="nc" id="L79">                dataUploadManager.recordHL7DataUpload(hl7ConnContext, hl7, hl7.getMdmDocumentId().getString(), DOCUMENT,</span>
                        PATIENT_INFO_MISMATCH, pidMismatches, patient, null/*subsetOf*/);
            }
<span class="nc" id="L82">            break;</span>
            case REJECT: {
<span class="nc" id="L84">                dataUploadManager.recordHL7DataUpload(hl7ConnContext, hl7, hl7.getMdmDocumentId().getString(), DOCUMENT,</span>
                        REJECTED, pidMismatches, patient, null/*subsetOf*/);
            }
<span class="nc" id="L87">            break;</span>
            default: {
<span class="nc" id="L89">                throw new RuntimeException(String.format(&quot;Unexpected processing decision: %s&quot;, processingDecision));</span>
            }
        }
<span class="fc" id="L92">        return processingDecision;</span>
    }

    public void setDataUploadManager(DataUploadManager dataUploadManager) {
<span class="nc" id="L96">        this.dataUploadManager = dataUploadManager;</span>
<span class="nc" id="L97">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>