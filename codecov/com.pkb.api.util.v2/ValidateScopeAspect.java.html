<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ValidateScopeAspect.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.util.v2</a> &gt; <span class="el_source">ValidateScopeAspect.java</span></div><h1>ValidateScopeAspect.java</h1><pre class="source lang-java linenums">package com.pkb.api.util.v2;

import com.pkb.api.aspect.annotation.RequiresScope;
import com.pkb.datamodel.ApiAuthSession;
import com.pkb.datamodel.RoleHolder;
import com.pkb.entities.enums.api.ApiClientScope;
import com.pkb.exception.RestException;
import com.pkb.service.user.impl.ApiAuthManager;
import org.apache.commons.lang3.StringUtils;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;
import org.springframework.web.context.request.RequestContextHolder;
import org.springframework.web.context.request.ServletRequestAttributes;

import javax.servlet.http.HttpServletRequest;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.HttpHeaders;
import javax.ws.rs.core.Response;
import java.util.Collections;
import java.util.EnumSet;
import java.util.Set;

import static com.pkb.api.util.v2.RestUtil.AUTH_SESSION_VAR;
import static com.pkb.entities.enums.api.ApiClientScope.PUBLIC;

@Aspect
@Order(1000)
@Component
public class ValidateScopeAspect {
<span class="fc" id="L35">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private final RestUtil restUtil;
    private final ApiAuthManager apiAuthManager;
    public ValidateScopeAspect(RestUtil restUtil,
<span class="fc" id="L40">                               ApiAuthManager apiAuthManager) {</span>
<span class="fc" id="L41">        this.restUtil = restUtil;</span>
<span class="fc" id="L42">        this.apiAuthManager = apiAuthManager;</span>
<span class="fc" id="L43">    }</span>

    /**
     * This method is crucial to the working of the authentication process Prior to a method's execution it makes a note of the allowed
     * scopes and then stores that for when the executing REST resource requests the PKBCommonParams
     *
     * @param pjp
     *            join point
     * @param scope
     *            method scope
     * @return returns aspect object
     */
    @Around(&quot;(execution(* com.pkb.api..*.*(..)) || execution(* com.pkb.api.internal..*.*(..))) &amp;&amp; @annotation(scope)&quot;)
    public Object validateScope(ProceedingJoinPoint pjp, RequiresScope scope) throws Throwable {
<span class="fc" id="L57">        Object[] args = pjp.getArgs();</span>
<span class="fc" id="L58">        Set&lt;ApiClientScope&gt; scopes = EnumSet.noneOf(ApiClientScope.class);</span>
<span class="fc" id="L59">        Collections.addAll(scopes, scope.scopes());</span>

<span class="fc" id="L61">        RoleHolder holder = restUtil.getRoleHolder();</span>

        // store allowed roles in request variable
        try {
<span class="pc bpc" id="L65" title="1 of 2 branches missed.">            if (holder.isEmpty()) {</span>
<span class="fc" id="L66">                holder.setAllowedRoles(scopes);</span>
            } else {
<span class="nc" id="L68">                String message = &quot;holder is probably not thread safe as it has elements within it&quot;;</span>

<span class="nc" id="L70">                LOGGER.error(message);</span>
<span class="nc" id="L71">                holder.clear();</span>
<span class="nc" id="L72">                throw new IllegalStateException(message);</span>
            }
<span class="fc" id="L74">            HttpServletRequest request = getRequest();</span>

            //shove the apiauth session into the request object temporarily
<span class="fc bfc" id="L77" title="All 2 branches covered.">            if (!holder.contains(PUBLIC)) {</span>
<span class="fc" id="L78">                String token = getTokenFromText(request.getHeader(HttpHeaders.AUTHORIZATION));</span>
<span class="fc" id="L79">                ApiAuthSession authSession = createSession(token); //this is essentially an authentication of the current request</span>

<span class="fc" id="L81">                request.setAttribute(AUTH_SESSION_VAR, authSession); //store the session in the request object</span>
            }
<span class="fc" id="L83">            return pjp.proceed(args);</span>

        } finally {
<span class="fc" id="L86">            restUtil.removeRoleHolder();</span>

            //purge the auth session object from the request object
<span class="fc bfc" id="L89" title="All 2 branches covered.">            if (!holder.contains(PUBLIC)) {</span>
<span class="fc" id="L90">                getRequest().removeAttribute(AUTH_SESSION_VAR);</span>
            }
        }
    }

    public HttpServletRequest getRequest() {
<span class="fc" id="L96">        return ((ServletRequestAttributes) RequestContextHolder.currentRequestAttributes())</span>
<span class="fc" id="L97">                .getRequest();</span>
    }
    /**
     * extracts tokenHeader from authorization header text
     *
     * @param tokenHeader
     *            auth header
     * @return returns just tokenHeader text
     */
    private String getTokenFromText(String tokenHeader) {

<span class="fc bfc" id="L108" title="All 2 branches covered.">        if (StringUtils.isEmpty(tokenHeader)) {</span>
<span class="fc" id="L109">            String message = &quot;No Authorization header found in request&quot;;</span>
<span class="fc" id="L110">            LOGGER.error(message);</span>
<span class="fc" id="L111">            throw new RestException(new Throwable(message), Response.Status.BAD_REQUEST, tokenHeader);</span>

<span class="fc bfc" id="L113" title="All 2 branches covered.">        } else if (!tokenHeader.startsWith(&quot;Bearer &quot;)) {</span>
<span class="fc" id="L114">            String message = &quot;Authorization header value should start with 'Bearer ' (then append the auth tokenHeader)'}&quot;;</span>
<span class="fc" id="L115">            LOGGER.error(message);</span>
<span class="fc" id="L116">            throw new RestException(new Throwable(message), Response.Status.BAD_REQUEST, tokenHeader);</span>
        }

<span class="fc" id="L119">        return tokenHeader.substring(&quot;Bearer &quot;.length()).trim();</span>
    }

    private ApiAuthSession createSession(String token) {
<span class="fc" id="L123">        var session = apiAuthManager.getAuthSessionByAccessToken(token);</span>
        // confirm session is not null at this point
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        if (session.isEmpty()) {</span>
            // TODO: Does this error message make sense? Not changing now because I can't be certain someone hasn't coded against it.
<span class="nc" id="L127">            var message = &quot;No tokenHeader found for submitted auth value. Token might have expired or is otherwise invalid.&quot;;</span>
<span class="nc" id="L128">            LOGGER.error(message);</span>
<span class="nc" id="L129">            throw new WebApplicationException(message, Response.Status.UNAUTHORIZED);</span>
        }
<span class="fc" id="L131">        return session.get();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>