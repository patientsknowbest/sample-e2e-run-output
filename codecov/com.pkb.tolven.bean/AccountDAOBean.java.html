<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AccountDAOBean.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.tolven.bean</a> &gt; <span class="el_source">AccountDAOBean.java</span></div><h1>AccountDAOBean.java</h1><pre class="source lang-java linenums">package com.pkb.tolven.bean;

import com.pkb.common.config.PkbPluginConfig;
import com.pkb.entities.enums.AccountUserStatus;
import com.pkb.tolven.PKBAccountDAOLocal;
import com.pkb.tolven.PKBAccountDAORemote;
import com.pkb.util.DbUtil;
import io.vavr.control.Option;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.tolven.core.entity.AccountUser;

import javax.ejb.Local;
import javax.ejb.Remote;
import javax.ejb.Stateless;
import javax.inject.Inject;
import javax.persistence.EntityManager;
import javax.persistence.PersistenceContext;
import javax.persistence.TypedQuery;
import java.lang.invoke.MethodHandles;
import java.util.Collection;
import java.util.List;
import java.util.Map;
import java.util.Set;
import java.util.UUID;
import java.util.stream.Stream;

import static com.google.common.collect.ImmutableMap.toImmutableMap;
import static com.pkb.util.DbUtil.getExactlyOneResultOrNull;

@Stateless
@Local({PKBAccountDAOLocal.class})
@Remote(PKBAccountDAORemote.class)
public class AccountDAOBean implements PKBAccountDAOLocal {

<span class="fc" id="L38">    private static final Logger LOGGER = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());</span>

    @PersistenceContext
    private EntityManager em;
    @Inject
    private PkbPluginConfig config;

<span class="fc" id="L45">    public AccountDAOBean() {</span>
<span class="fc" id="L46">    }</span>

    private Stream&lt;javax.persistence.Tuple&gt; findAccountsStream(Collection&lt;Long&gt; accountIds) {
<span class="fc" id="L49">        return DbUtil.getInStreamOfBatches(</span>
                accountIds,
<span class="fc" id="L51">                batchOfIds -&gt; em.createQuery(&quot;SELECT a.id as aid , a.publicId as pid FROM Account a WHERE a.id IN (:batch)&quot;, javax.persistence.Tuple.class)</span>
<span class="fc" id="L52">                        .setParameter(&quot;batch&quot;, batchOfIds)</span>
<span class="fc" id="L53">                        .getResultList());</span>
    }

    @Override
    public UUID getAccountPublicId(long accountId) {
<span class="fc" id="L58">        UUID result = doFindAccountPublicId(accountId);</span>
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        if (result == null) {</span>
<span class="nc" id="L60">            throw new IllegalStateException(&quot;Couldn't find account public id for account id: &quot; + accountId + &quot;!&quot;);</span>
        }
<span class="fc" id="L62">        return result;</span>
    }

    @Override
    public Option&lt;UUID&gt; findAccountPublicId(long accountId) {
<span class="fc" id="L67">        return Option.of(doFindAccountPublicId(accountId));</span>
    }

    @Nullable
    private UUID doFindAccountPublicId(long accountId) {
<span class="fc" id="L72">        return getExactlyOneResultOrNull(em.createQuery(&quot;SELECT publicId FROM Account WHERE id = :accountId&quot;, UUID.class)</span>
<span class="fc" id="L73">                .setParameter(&quot;accountId&quot;, accountId));</span>
    }

    @Override
    public Map&lt;UUID, Long&gt; accountIdByAccountPublicIdMap(Collection&lt;Long&gt; accountIds) {
<span class="fc" id="L78">        return findAccountsStream(accountIds)</span>
<span class="fc" id="L79">                .collect(toImmutableMap(t -&gt; t.get(&quot;pid&quot;, UUID.class), t -&gt; t.get(&quot;aid&quot;, Long.class)));</span>
    }

    @Override
    public Option&lt;AccountUser&gt; findActiveAccountUser(long personId, long accountId) {
<span class="nc" id="L84">        TypedQuery&lt;AccountUser&gt; query = this.em.createQuery(</span>
                        &quot;SELECT au FROM AccountUser au\n&quot; +
                                &quot;JOIN FETCH au.account a\n&quot; +
                                &quot;WHERE a.id = :accountId\n&quot; +
                                &quot;AND au.personId = :personId\n&quot; +
                                &quot;AND au.status = :status&quot;,
                        AccountUser.class)
<span class="nc" id="L91">                .setParameter(&quot;accountId&quot;, accountId)</span>
<span class="nc" id="L92">                .setParameter(&quot;personId&quot;, personId)</span>
<span class="nc" id="L93">                .setParameter(&quot;status&quot;, AccountUserStatus.ACTIVE);</span>

<span class="nc" id="L95">        return DbUtil.findSingleResultForRemote(query);</span>
    }

    @Override
    @Nullable
    public AccountUser getOwnerAccountUser(long accountId) {
<span class="fc" id="L101">        TypedQuery&lt;AccountUser&gt; query = em.createQuery(</span>
                        &quot;SELECT au FROM AccountUser au\n&quot; +
                                &quot;WHERE au.account.id = :accountId\n&quot; +
                                &quot;AND au.defaultAccount = :isDefault\n&quot; +
                                &quot;AND au.status = :status&quot;,
                        AccountUser.class)
<span class="fc" id="L107">                .setParameter(&quot;accountId&quot;, accountId)</span>
<span class="fc" id="L108">                .setParameter(&quot;isDefault&quot;, Boolean.TRUE)</span>
<span class="fc" id="L109">                .setParameter(&quot;status&quot;, AccountUserStatus.ACTIVE);</span>

<span class="fc" id="L111">        return DbUtil.getExactlyOneUniqueResultOrNull(query);</span>
    }

    @Override
    @NotNull
    public List&lt;AccountUser&gt; getOwnerAccountUsers(Collection&lt;Long&gt; accountIds) {
<span class="fc" id="L117">        return DbUtil.getInBatches(accountIds, config.getAccountUserFetchSize(), this::getOwnerAccountUsersBatch);</span>
    }

    @Override
    public @NotNull Map&lt;Long, UUID&gt; accountPublicIdByAccountIdMap(Set&lt;Long&gt; accountIds) {
<span class="fc" id="L122">        return findAccountsStream(accountIds)</span>
<span class="fc" id="L123">                .collect(toImmutableMap(t -&gt; t.get(&quot;aid&quot;, Long.class), t -&gt; t.get(&quot;pid&quot;, UUID.class)));</span>
    }

    private List&lt;AccountUser&gt; getOwnerAccountUsersBatch(Iterable&lt;Long&gt; accountIds) {
<span class="fc" id="L127">        return em.createQuery(</span>
                        &quot;SELECT au FROM AccountUser au\n&quot; +
                                &quot;WHERE au.account.id IN (:accountIds)\n&quot; +
                                &quot;AND au.defaultAccount = :isDefault\n&quot; +
                                &quot;AND au.status = :status&quot;,
                        AccountUser.class)
<span class="fc" id="L133">                .setParameter(&quot;accountIds&quot;, accountIds)</span>
<span class="fc" id="L134">                .setParameter(&quot;isDefault&quot;, Boolean.TRUE)</span>
<span class="fc" id="L135">                .setParameter(&quot;status&quot;, AccountUserStatus.ACTIVE)</span>
<span class="fc" id="L136">                .getResultList();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>