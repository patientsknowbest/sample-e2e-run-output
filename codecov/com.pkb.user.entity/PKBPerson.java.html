<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PKBPerson.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.user.entity</a> &gt; <span class="el_source">PKBPerson.java</span></div><h1>PKBPerson.java</h1><pre class="source lang-java linenums">package com.pkb.user.entity;

import com.google.common.base.MoreObjects;
import com.google.common.base.Strings;
import com.google.common.collect.ImmutableSet;
import com.google.common.collect.Sets;
import com.pkb.HasVersionDetails;
import com.pkb.VersionDetails;
import com.pkb.app.entity.AbstractPersonRoles;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.consent.entity.PatientOptOut;
import com.pkb.datamodel.Email;
import com.pkb.emis.es.entity.EmisEsPersonGuid;
import com.pkb.entities.enums.Gender;
import com.pkb.entities.enums.NationalIdType;
import com.pkb.entities.enums.NotificationOption;
import com.pkb.entities.enums.PropertyName;
import com.pkb.entities.enums.TwoFactorAuthState;
import com.pkb.entities.enums.UserStatus;
import com.pkb.entities.enums.UserType;
import com.pkb.entities.enums.ValidNationalId;
import com.pkb.util.VersionDetailsPersistenceListener;
import io.vavr.control.Option;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.hibernate.Hibernate;
import org.hibernate.annotations.Cache;
import org.hibernate.annotations.CacheConcurrencyStrategy;
import org.hibernate.annotations.Generated;
import org.hibernate.annotations.GenerationTime;
import org.hibernate.annotations.SortNatural;
import org.hibernate.annotations.Type;
import org.jetbrains.annotations.NotNull;
import org.jetbrains.annotations.Nullable;

import javax.persistence.CascadeType;
import javax.persistence.Column;
import javax.persistence.Embedded;
import javax.persistence.Entity;
import javax.persistence.EntityListeners;
import javax.persistence.EnumType;
import javax.persistence.Enumerated;
import javax.persistence.FetchType;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.JoinColumn;
import javax.persistence.NamedAttributeNode;
import javax.persistence.NamedEntityGraph;
import javax.persistence.NamedEntityGraphs;
import javax.persistence.OneToMany;
import javax.persistence.OneToOne;
import javax.persistence.PrePersist;
import javax.persistence.PreUpdate;
import javax.persistence.Table;
import javax.persistence.Temporal;
import javax.persistence.TemporalType;
import javax.persistence.Transient;
import javax.persistence.UniqueConstraint;
import java.io.Serializable;
import java.time.Instant;
import java.time.LocalDate;
import java.time.ZoneId;
import java.time.ZoneOffset;
import java.time.format.DateTimeFormatter;
import java.time.format.DateTimeParseException;
import java.util.Comparator;
import java.util.Date;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Locale;
import java.util.Objects;
import java.util.Optional;
import java.util.Set;
import java.util.SortedSet;
import java.util.TimeZone;
import java.util.TreeSet;
import java.util.UUID;
import java.util.function.Predicate;
import java.util.function.Supplier;
import java.util.stream.Collectors;

import static com.pkb.PKBConstants.DATE_OF_BIRTH_FORMATTER;
import static com.pkb.entities.enums.PropertyName.INVITE_CLINICIAN_TERMS;
import static com.pkb.util.Constants.APPLICATION_TZ;
import static io.vavr.API.None;
import static io.vavr.API.Some;
import static java.util.Collections.singleton;
import static java.util.Optional.empty;
import static org.apache.commons.lang3.StringUtils.isBlank;
import static org.apache.commons.lang3.StringUtils.isNotBlank;
import static org.apache.commons.lang3.StringUtils.trimToNull;

/**
 * Represents an end user of PKB application which has a name, dob and address
 *
 * @author pravinam
 */
@SuppressWarnings(&quot;DeprecatedIsStillUsed&quot;)
@NamedEntityGraphs({
        @NamedEntityGraph(
                name = &quot;graph.pkbPersonNationalIdsAndOrgLevelIdsAndContacts&quot;,
                attributeNodes = {
                        @NamedAttributeNode(value = &quot;nationalIds&quot;),
                        @NamedAttributeNode(value = &quot;orgLevelIds&quot;),
                        @NamedAttributeNode(value = &quot;contacts&quot;)
                }
        )
})
@Entity
@Cache(usage = CacheConcurrencyStrategy.NONSTRICT_READ_WRITE)
@Table(uniqueConstraints = @UniqueConstraint(columnNames = {&quot;id&quot;, &quot;humanUUID&quot;}))
@EntityListeners({VersionDetailsPersistenceListener.class})
<span class="fc" id="L115">public class PKBPerson extends AbstractPersonRoles implements Serializable, HasVersionDetails&lt;VersionDetails&gt; {</span>
<span class="fc" id="L116">    public static final Comparator&lt;PKBPerson&gt; CMP_FIRSTNAME = (left, right) -&gt; left.getFirstName().compareToIgnoreCase(right.getFirstName());</span>

<span class="fc" id="L118">    public static final Comparator&lt;PKBPerson&gt; CMP_LASTNAME = (left, right) -&gt; left.getLastName().compareToIgnoreCase(right.getLastName());</span>

<span class="fc" id="L120">    public static final Comparator&lt;PKBPerson&gt; CMP_DATE_REGISTERED = Comparator.comparing(PKBPerson::getAccountCreation);</span>
<span class="fc" id="L121">    public static final DateTimeFormatter DOB_FORMATTER = DateTimeFormatter.ofPattern(&quot;yyyy-MM-dd&quot;).withZone(ZoneId.of(&quot;UTC&quot;)).withLocale(Locale.UK);</span>

<span class="fc" id="L123">    public static final Comparator&lt;PKBPerson&gt; CMP_DOB = (left, right) -&gt; {</span>
<span class="nc" id="L124">        Optional&lt;LocalDate&gt; maybeLeftDob = left.findDateOfBirth();</span>
<span class="nc" id="L125">        Optional&lt;LocalDate&gt; maybeRightDob = right.findDateOfBirth();</span>
<span class="nc bnc" id="L126" title="All 4 branches missed.">        if (maybeLeftDob.isPresent() &amp;&amp; maybeRightDob.isPresent()) {</span>
<span class="nc" id="L127">            return maybeLeftDob.get().compareTo(maybeRightDob.get());</span>
        } else {
<span class="nc bnc" id="L129" title="All 2 branches missed.">            if (maybeRightDob.isPresent()) {</span>
<span class="nc" id="L130">                return -1;</span>
            }
<span class="nc bnc" id="L132" title="All 2 branches missed.">            if (maybeLeftDob.isPresent()) {</span>
<span class="nc" id="L133">                return 1;</span>
            }
        }
<span class="nc" id="L136">        return 0;</span>
    };

    private static final long serialVersionUID = 1L;

<span class="fc" id="L141">    private static final Set&lt;UserStatus&gt; NOT_CONTACTABLE_STATUSES = Sets.immutableEnumSet(UserStatus.NOCONTACT, UserStatus.DEAD);</span>

    /**
     * @throws IllegalArgumentException if {@code deathTimestamp} is a future time
     * @throws IllegalStateException    if the person is already in {@link UserStatus#DEAD} status
     */
    public void markDeceased(Instant deathTimestamp) {
<span class="fc" id="L148">        setDeathTimestamp(Date.from(deathTimestamp));</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">        if (status == UserStatus.DEAD) {</span>
<span class="nc" id="L150">            throw new IllegalStateException(&quot;person &quot; + id + &quot; is already marked as dead&quot;);</span>
        }
<span class="fc" id="L152">        this.status = UserStatus.DEAD;</span>
<span class="fc" id="L153">    }</span>

    public void markNotDeceased() {
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">        if (status != UserStatus.DEAD) {</span>
<span class="nc" id="L157">            throw new IllegalStateException(&quot;current user status is: &quot; + status);</span>
        }
<span class="fc" id="L159">        this.status = UserStatus.EMAIL_CONFIRMED;</span>
<span class="fc" id="L160">        this.deathTimestamp = null;</span>
<span class="fc" id="L161">    }</span>

    @Id
    @GeneratedValue(strategy = GenerationType.AUTO)
    private Long id;

    /**
     * For users with multiple roles (on multiple teams, or different userTypes on the same team).
     * &lt;p&gt;
     * A team pro may have different job title and email address for each team; or a single user may be both
     * a team pro annd a team coord on a team; etc. To support these options, we have multiple
     * PKBPerson records. This field is used to link those records.
     */
    @Column
    private String humanUUID;

    @Column
    private Long defaultAccountId;

    @Column(length = 50)
    private String firstName;

    @Column(length = 50)
    private String lastName;

    @Column(length = 100)
    private String middleName;

    @Column
    private String jobTitle;

    @Column(length = 50)
    private String title;

    @Column(length = 100)
    private String address1;

    @Column(length = 100)
    private String address2;

    @Column(length = 50)
    private String city;

    @Column(length = 50)
    private String state;

    @Column(length = 50)
    private String country;

    @Column(length = 10)
    private String postalCode;

    /**
     * A {@code String} representation of the date of birth, in the format yyyy-MM-dd.
     */
    @Column(length = 10)
    private String dateOfBirthString;

    @Column
    private Date deathTimestamp;

<span class="fc" id="L222">    @Column</span>
<span class="fc" id="L223">    private int gender = Gender.UNKNOWN.getId();</span>

    @Column
    @Enumerated(EnumType.STRING)
    private UserStatus status;

    /**
     * if patient record is frozen, only professionals may view it
     */
    @Column
    private Long frozenByTeamId;

    @Transient
    private String password;

    @Column
    @Enumerated(EnumType.STRING)
    private UserType userType;

    @OneToMany(fetch = FetchType.LAZY, cascade = CascadeType.ALL, mappedBy = &quot;person&quot;)
    private Set&lt;PKBPersonProperty&gt; properties;

    @OneToMany(fetch = FetchType.LAZY, cascade = CascadeType.ALL, mappedBy = &quot;person&quot;, orphanRemoval=true)
    private Set&lt;NationalId&gt; nationalIds;

    @OneToMany(fetch = FetchType.LAZY, cascade = CascadeType.ALL)
    @JoinColumn(name = &quot;person_id&quot;)
    @SortNatural
    private SortedSet&lt;OrgLevelId&gt; orgLevelIds;

    @OneToMany(fetch = FetchType.LAZY, cascade = CascadeType.ALL)
    @JoinColumn(name = &quot;person_id&quot;)
    @SortNatural
    private SortedSet&lt;TeamLevelId&gt; teamLevelIds;

    @OneToOne(fetch = FetchType.LAZY, mappedBy = &quot;person&quot;, cascade = CascadeType.ALL)
    private EmisEsPersonGuid emisEsPersonGuid;

    @Column(length = 100)
    private String organizationName;

    @Column(length = 100)
    private String organizationUnit;

    @Column(length = 40)
    private String phone;

    @Column(length = 100)
    private String skypeId;

    @Type(type = &quot;pg-uuid&quot;)
    @Column(name = &quot;pwdaccess_document_metadata_id&quot;)
    private UUID pwdAccessDocumentMetadataId;

    @Column
    @Temporal(TemporalType.TIMESTAMP)
    private Date registeredOn;

    @Column
    private Instant statusDate;

    @Column
    private String languageCode;

    @Column(length = 100)
    private String timeZoneId;

    @Transient
    private Date accountCreation;

    @OneToMany(fetch = FetchType.LAZY, mappedBy = &quot;person&quot;, cascade = CascadeType.ALL)
    private Set&lt;PersonContact&gt; contacts;

    @Column
    private String twoFactorSecret;

<span class="fc" id="L299">    @Column(nullable = false)</span>
    @Enumerated(EnumType.STRING)
    private TwoFactorAuthState twoFactorAuthState = TwoFactorAuthState.DISABLED;

    @Column
    private Boolean twoFactorAuthMandatory;

<span class="fc" id="L306">    @Embedded</span>
    private VersionDetails versionDetails = new VersionDetails();

    //only some people will use this
    @Column(nullable = true, length = 50)
    @Enumerated(EnumType.STRING)
    private NotificationOption notificationOption;

    /* Date of last email sent to this pkb person .  */
    @Column(nullable = true)
    @Temporal(TemporalType.TIMESTAMP)
    private Date lastEmailSent;

    @OneToOne(fetch = FetchType.EAGER)
    @JoinColumn(name = &quot;id&quot;)
    private PatientOptOut optoutDetails;

    // TODO: Generate in code, not DB
    @Column(name = &quot;public_id&quot;, nullable = false, updatable = false, unique = true)
    @Type(type = &quot;pg-uuid&quot;)
    @Generated(GenerationTime.INSERT)
    private UUID publicId;

    /**
     * pass these into fetchLazies() method
     */
<span class="fc" id="L332">    public enum Lazy {</span>
<span class="fc" id="L333">        CONTACTS(singleton(&quot;contacts&quot;)),</span>
<span class="fc" id="L334">        CONTACTS_DEEP(singleton(&quot;contacts&quot;)),</span>
<span class="fc" id="L335">        NATIONAL_AND_LOCAL_IDS(ImmutableSet.of(&quot;nationalIds&quot;, &quot;orgLevelIds&quot;, &quot;teamLevelIds&quot;)),</span>
<span class="fc" id="L336">        NATIONAL_AND_LOCAL_IDS_DEEP(ImmutableSet.of(&quot;nationalIds&quot;, &quot;orgLevelIds.org&quot;, &quot;teamLevelIds.team&quot;)),</span>
<span class="fc" id="L337">        PROPERTIES(singleton(&quot;properties&quot;));</span>

        private final Set&lt;String&gt; subgraph;

<span class="fc" id="L341">        Lazy(Set&lt;String&gt; subgraph) {</span>
<span class="fc" id="L342">            this.subgraph = subgraph;</span>
<span class="fc" id="L343">        }</span>

        public Set&lt;String&gt; getSubgraph() {
<span class="fc" id="L346">            return subgraph;</span>
        }
    }

    /**
     * fetch the specified lazy-loaded fields from Hibernate. Special handling
     * for CONTACTS to ALSO_CONTACT links work.
     */
    public PKBPerson fetchLazies(Lazy... fields) {
<span class="fc bfc" id="L355" title="All 2 branches covered.">        for (Lazy lazy : fields) {</span>
<span class="fc bfc" id="L356" title="All 5 branches covered.">            switch (lazy) {</span>
                case CONTACTS:
<span class="fc" id="L358">                    getContacts().size();</span>
<span class="fc" id="L359">                    break;</span>
                case CONTACTS_DEEP:
                    // special handling here... we need to be sure ALSO_CONTACT
                    // email records will work
<span class="fc bfc" id="L363" title="All 2 branches covered.">                    for (PersonContact c : getContacts()) {</span>
<span class="fc" id="L364">                        c.findAlsoContactPerson().peek(refPerson -&gt; refPerson.getContacts().size());</span>
<span class="fc" id="L365">                    }</span>
<span class="fc" id="L366">                    break;</span>
                case NATIONAL_AND_LOCAL_IDS:
<span class="pc bpc" id="L368" title="1 of 2 branches missed.">                    if (getNationalIds() != null) {</span>
<span class="fc" id="L369">                        getNationalIds().size();</span>
                    }
<span class="pc bpc" id="L371" title="1 of 4 branches missed.">                    if ((getOrgLevelIds() != null) &amp;&amp; !getOrgLevelIds().isEmpty()) {</span>
<span class="fc bfc" id="L372" title="All 2 branches covered.">                        for (OrgLevelId olid : getOrgLevelIds()) {</span>
<span class="fc" id="L373">                            olid.getOrg().getName();</span>
<span class="fc" id="L374">                            olid.getType();</span>
<span class="fc" id="L375">                        }</span>
                    }
<span class="fc bfc" id="L377" title="All 4 branches covered.">                    if ((getTeamLevelIds() != null) &amp;&amp; !getTeamLevelIds().isEmpty()) {</span>
<span class="fc bfc" id="L378" title="All 2 branches covered.">                        for (TeamLevelId tlid : getTeamLevelIds()) {</span>
<span class="fc" id="L379">                            tlid.getTeam().getName();</span>
<span class="fc" id="L380">                            tlid.getType();</span>
<span class="fc" id="L381">                        }</span>
                    }
                    break;
                case PROPERTIES:
<span class="fc" id="L385">                    getProperties().size();</span>
                    break;
            }
        }

<span class="fc" id="L390">        return this;</span>
    }

    /**
     * strip out non-functional formatting: parens, space, dash, dot leave + to
     * indicate country code
     */

    /**
     * Strip out non-functional formatting, e.g.:parens, space, dash, dot Leave
     * &quot;+&quot; to indicate country code.
     * &lt;p&gt;
     * This method also allows for comparisons between phone numbers, taken from
     * user input, by providing a method to put them in a common format.
     *
     * @return A cleanly formatted version of the phone number.
     */
    public static String getPhoneClean(String phone) {
<span class="pc bpc" id="L408" title="1 of 2 branches missed.">        if (isBlank(phone)) {</span>
<span class="nc" id="L409">            return phone;</span>
        }

<span class="fc" id="L412">        String whitelist = &quot;1234567890+&quot;;</span>

<span class="fc" id="L414">        StringBuilder clean = new StringBuilder();</span>
<span class="fc bfc" id="L415" title="All 2 branches covered.">        for (int i = 0; i &lt; phone.length(); i++) {</span>
<span class="fc" id="L416">            char c = phone.charAt(i);</span>
<span class="pc bpc" id="L417" title="1 of 2 branches missed.">            if (StringUtils.contains(whitelist, c)) {</span>
<span class="fc" id="L418">                clean.append(c);</span>
            }
        }
<span class="fc" id="L421">        return clean.toString();</span>
    }

    @Nullable
    public String getNationalIdAnyTypeValidForSameCountryAsTypeForDisplay(NationalIdType type) {
<span class="fc" id="L426">        return findNationalIdAnyTypeValidForSameCountryAsTypeForDisplay(type).orElse(null);</span>
    }

    public Optional&lt;String&gt; findNationalIdAnyTypeValidForSameCountryAsTypeForDisplay(NationalIdType type) {
<span class="fc" id="L430">        return getNationalIdAnyTypeValidForSameCountryAsType(type).map(NationalId::getValueFormatted);</span>
    }

    public Optional&lt;NationalId&gt; getNationalIdByExactType(NationalIdType type) {
<span class="pc bpc" id="L434" title="1 of 4 branches missed.">        if (type == null || CollectionUtils.isEmpty(nationalIds)) {</span>
<span class="fc" id="L435">            return Optional.empty();</span>
        }

<span class="fc bfc" id="L438" title="All 2 branches covered.">        for (NationalId id : nationalIds) {</span>
<span class="fc bfc" id="L439" title="All 2 branches covered.">            if (id.getType() == type) {</span>
<span class="fc" id="L440">                return Optional.of(id);</span>
            }
<span class="fc" id="L442">        }</span>
        // not found
<span class="fc" id="L444">        return Optional.empty();</span>
    }

    public Optional&lt;NationalId&gt; getNationalIdAnyTypeValidForSameCountryAsType(NationalIdType type) {
<span class="fc bfc" id="L448" title="All 2 branches covered.">        if (CollectionUtils.isEmpty(nationalIds)) {</span>
<span class="fc" id="L449">            return empty();</span>
        }

<span class="fc" id="L452">        return nationalIds.stream()</span>
<span class="fc bfc" id="L453" title="All 2 branches covered.">                .filter(nid -&gt; nid.getType() == type)</span>
<span class="fc" id="L454">                .findFirst()</span>
<span class="fc" id="L455">                .or(() -&gt; nationalIds.stream().filter(nid -&gt; nid.getType().areUsedInSameCountry(type)).findFirst());</span>
    }

    public boolean hasNationalId(@NotNull ValidNationalId validNationalId) {
<span class="fc" id="L459">        return getNationalId(validNationalId).isPresent();</span>
    }

    public Optional&lt;NationalId&gt; getNationalId(@NotNull ValidNationalId validNationalId) {
<span class="pc bpc" id="L463" title="1 of 2 branches missed.">        if (CollectionUtils.isEmpty(nationalIds)) {</span>
<span class="nc" id="L464">            return Optional.empty();</span>
        }

<span class="pc bpc" id="L467" title="1 of 2 branches missed.">        for (NationalId id : nationalIds) {</span>
<span class="pc bpc" id="L468" title="2 of 4 branches missed.">            if (id.getType() == validNationalId.type() &amp;&amp; validNationalId.value().equals(id.getValue())) {</span>
<span class="fc" id="L469">                return Optional.of(id);</span>
            }
<span class="nc" id="L471">        }</span>
<span class="nc" id="L472">        return Optional.empty();</span>
    }

    public Optional&lt;NationalId&gt; getNationalIdByCountry(String countryCode) {
<span class="fc bfc" id="L476" title="All 2 branches covered.">        if (CollectionUtils.isEmpty(nationalIds)) {</span>
<span class="fc" id="L477">            return empty();</span>
        }

<span class="fc" id="L480">        return NationalIdType.getPrimaryNationalIdTypeFromCountryCode(countryCode)</span>
<span class="fc" id="L481">                .flatMap(nidt -&gt; nationalIds.stream()</span>
<span class="pc bpc" id="L482" title="1 of 2 branches missed.">                        .filter(id -&gt; id.getType() == nidt)</span>
<span class="fc" id="L483">                        .findFirst())</span>
<span class="fc" id="L484">                .or(() -&gt; {</span>
<span class="nc" id="L485">                    Set&lt;NationalIdType&gt; typesInCountry = NationalIdType.getNationalIdTypesFromCountryCode(countryCode);</span>
<span class="nc" id="L486">                    return nationalIds.stream()</span>
<span class="nc" id="L487">                            .filter(id -&gt; typesInCountry.contains(id.getType()))</span>
<span class="nc" id="L488">                            .findFirst();</span>
                });
    }

    /**
     * The returned set might be empty. It will not be null.
     *
     * @param orgId
     * @return
     */
    public SortedSet&lt;OrgLevelId&gt; getOrgLevelIdsByOrg(long orgId) {
<span class="fc" id="L499">        SortedSet&lt;OrgLevelId&gt; olids = new TreeSet&lt;&gt;();</span>
<span class="pc bpc" id="L500" title="1 of 2 branches missed.">        if (orgLevelIds != null) {</span>
<span class="fc bfc" id="L501" title="All 2 branches covered.">            for (OrgLevelId id : orgLevelIds) {</span>
<span class="fc bfc" id="L502" title="All 2 branches covered.">                if (id.getOrg().getId() == orgId) {</span>
<span class="fc" id="L503">                    olids.add(id);</span>
                }
<span class="fc" id="L505">            }</span>
        }
<span class="fc" id="L507">        return olids;</span>
    }

    public String getOrgLevelIdsByOrgAsCSV(long orgId) {
<span class="fc" id="L511">        return getOrgLevelIdsByOrg(orgId).stream().map(OrgLevelId::getValue).collect(Collectors.joining(&quot;, &quot;));</span>
    }

    /**
     * The returned set might be empty. It will not be null.
     *
     * @param typeId
     * @return
     */
    public SortedSet&lt;OrgLevelId&gt; getOrgLevelIdsByType(long typeId) {
<span class="fc" id="L521">        SortedSet&lt;OrgLevelId&gt; olids = new TreeSet&lt;&gt;();</span>
<span class="pc bpc" id="L522" title="1 of 2 branches missed.">        if (orgLevelIds != null) {</span>
<span class="fc bfc" id="L523" title="All 2 branches covered.">            for (OrgLevelId id : orgLevelIds) {</span>
<span class="fc bfc" id="L524" title="All 2 branches covered.">                if (id.getType().getId() == typeId) {</span>
<span class="fc" id="L525">                    olids.add(id);</span>
                }
<span class="fc" id="L527">            }</span>
        }
<span class="fc" id="L529">        return olids;</span>
    }

    /**
     * The returned String might be empty. It will not be null.
     *
     * @param typeId
     * @return
     */
    public String getOrgLevelIdsByTypeAsCSV(long typeId) {
<span class="fc" id="L539">        SortedSet&lt;OrgLevelId&gt; olids = getOrgLevelIdsByType(typeId);</span>
<span class="fc" id="L540">        String csv = &quot;&quot;;</span>
<span class="fc bfc" id="L541" title="All 2 branches covered.">        for (OrgLevelId olid : olids) {</span>
<span class="fc" id="L542">            csv += olid.getValue() + &quot;, &quot;;</span>
<span class="fc" id="L543">        }</span>
<span class="fc bfc" id="L544" title="All 2 branches covered.">        if (isNotBlank(csv)) {</span>
<span class="fc" id="L545">            csv = csv.substring(0, csv.length() - 2);</span>
        }
<span class="fc" id="L547">        return csv;</span>
    }

    /**
     * The returned set might be empty. It will not be null.
     *
     * @param teamId
     * @return
     */
    public SortedSet&lt;TeamLevelId&gt; getTeamLevelIdsByTeam(long teamId) {
<span class="nc" id="L557">        SortedSet&lt;TeamLevelId&gt; tlids = new TreeSet&lt;&gt;();</span>
<span class="nc bnc" id="L558" title="All 2 branches missed.">        if (teamLevelIds != null) {</span>
<span class="nc bnc" id="L559" title="All 2 branches missed.">            for (TeamLevelId id : teamLevelIds) {</span>
<span class="nc bnc" id="L560" title="All 2 branches missed.">                if (id.getTeam().getId() == teamId) {</span>
<span class="nc" id="L561">                    tlids.add(id);</span>
                }
<span class="nc" id="L563">            }</span>
        }
<span class="nc" id="L565">        return tlids;</span>
    }

    /**
     * The returned set might be empty. It will not be null.
     *
     * @param typeId
     * @return
     */
    public SortedSet&lt;TeamLevelId&gt; getTeamLevelIdsByType(long typeId) {
<span class="fc" id="L575">        SortedSet&lt;TeamLevelId&gt; tlids = new TreeSet&lt;&gt;();</span>
<span class="pc bpc" id="L576" title="1 of 2 branches missed.">        if (teamLevelIds != null) {</span>
<span class="fc bfc" id="L577" title="All 2 branches covered.">            for (TeamLevelId id : teamLevelIds) {</span>
<span class="fc bfc" id="L578" title="All 2 branches covered.">                if (id.getType().getId() == typeId) {</span>
<span class="fc" id="L579">                    tlids.add(id);</span>
                }
<span class="fc" id="L581">            }</span>
        }
<span class="fc" id="L583">        return tlids;</span>
    }

    /**
     * The returned String might be empty. It will not be null.
     */
    public String getTeamLevelIdsByTypeAsCSV(long typeId) {
<span class="fc" id="L590">        SortedSet&lt;TeamLevelId&gt; tlids = getTeamLevelIdsByType(typeId);</span>
<span class="fc" id="L591">        String csv = &quot;&quot;;</span>
<span class="fc bfc" id="L592" title="All 2 branches covered.">        for (TeamLevelId tlid : tlids) {</span>
<span class="fc" id="L593">            csv += tlid.getValue() + &quot;, &quot;;</span>
<span class="fc" id="L594">        }</span>
<span class="fc bfc" id="L595" title="All 2 branches covered.">        if (isNotBlank(csv)) {</span>
<span class="fc" id="L596">            csv = csv.substring(0, csv.length() - 2);</span>
        }
<span class="fc" id="L598">        return csv;</span>
    }

    public boolean addOrgLevelId(EHRRequestContext requestContext, OrgLevelId olid, Instant editDate) {
<span class="pc bpc" id="L602" title="1 of 2 branches missed.">        if (orgLevelIds == null) {</span>
<span class="nc" id="L603">            orgLevelIds = new TreeSet&lt;&gt;();</span>
        }
<span class="pc bpc" id="L605" title="1 of 2 branches missed.">        if (olid.getEditDate() == null) {</span>
<span class="fc" id="L606">            olid.setEditDate(Date.from(editDate));</span>
        }
<span class="fc" id="L608">        olid.setPersonId(this.getId());</span>
<span class="fc" id="L609">        olid.setVersionDetails(VersionDetails.of(requestContext, editDate));</span>
<span class="fc" id="L610">        return orgLevelIds.add(olid);</span>
    }

    public int addOrgLevelIds(EHRRequestContext requestContext, SortedSet&lt;OrgLevelId&gt; olids, Instant editDate) {
<span class="fc" id="L614">        int count = 0;</span>
<span class="fc bfc" id="L615" title="All 2 branches covered.">        for (OrgLevelId olid : olids) {</span>
<span class="pc bpc" id="L616" title="1 of 2 branches missed.">            if (addOrgLevelId(requestContext, olid, editDate)) {</span>
<span class="fc" id="L617">                count++;</span>
            }
<span class="fc" id="L619">        }</span>
<span class="fc" id="L620">        return count;</span>
    }

    public boolean addTeamLevelId(EHRRequestContext requestContext, TeamLevelId tlid, Instant editDate) {
<span class="fc bfc" id="L624" title="All 2 branches covered.">        if (teamLevelIds == null) {</span>
<span class="fc" id="L625">            teamLevelIds = new TreeSet&lt;&gt;();</span>
        }
<span class="pc bpc" id="L627" title="1 of 2 branches missed.">        if (tlid.getEditDate() == null) {</span>
<span class="fc" id="L628">            tlid.setEditDate(Date.from(editDate));</span>
        }
<span class="fc" id="L630">        tlid.setPersonId(this.getId());</span>
<span class="fc" id="L631">        tlid.setVersionDetails(VersionDetails.of(requestContext, editDate));</span>
<span class="fc" id="L632">        return teamLevelIds.add(tlid);</span>
    }

    public int addTeamLevelIds(EHRRequestContext requestContext, SortedSet&lt;TeamLevelId&gt; tlids, Instant editDate) {
<span class="fc" id="L636">        int count = 0;</span>
<span class="fc bfc" id="L637" title="All 2 branches covered.">        for (TeamLevelId tlid : tlids) {</span>
<span class="pc bpc" id="L638" title="1 of 2 branches missed.">            if (addTeamLevelId(requestContext, tlid, editDate)) {</span>
<span class="fc" id="L639">                count++;</span>
            }
<span class="fc" id="L641">        }</span>
<span class="fc" id="L642">        return count;</span>
    }

    /**
     * Checks properties for a property with the given name and a
     * boolean-parseable value.
     *
     * @param name
     * @return True if the property exists and has a value of 'true', false in
     * any other circumstance
     */
    public boolean checkPropertyFlag(PropertyName name) {
<span class="fc bfc" id="L654" title="All 2 branches covered.">        for (PKBPersonProperty prop : getProperties()) {</span>
<span class="fc bfc" id="L655" title="All 2 branches covered.">            if (name == prop.getPropertyName()) {</span>
<span class="fc bfc" id="L656" title="All 2 branches covered.">                if (Boolean.parseBoolean(prop.getPropertyValue())) {</span>
<span class="fc" id="L657">                    return true;</span>
                }
            }
<span class="fc" id="L660">        }</span>

<span class="fc" id="L662">        return false;</span>
    }

    /**
     * @return true if the value was changed (new property added, or existing value changed)
     */
    public boolean setProperty(PropertyName name, String value) {
<span class="fc bfc" id="L669" title="All 2 branches covered.">        for (PKBPersonProperty prop : getProperties()) {</span>
<span class="fc bfc" id="L670" title="All 2 branches covered.">            if (name == prop.getPropertyName()) {</span>
<span class="pc bpc" id="L671" title="1 of 2 branches missed.">                if (Objects.equals(prop.getPropertyValue(), value)) {</span>
<span class="nc" id="L672">                    return false; // no change</span>
                } else {
<span class="fc" id="L674">                    prop.setPropertyValue(value);</span>
<span class="fc" id="L675">                    return true; // changed</span>
                }
            }
<span class="fc" id="L678">        }</span>

        // wasn't found: add it
<span class="fc" id="L681">        PKBPersonProperty newProp = new PKBPersonProperty();</span>
<span class="fc" id="L682">        newProp.setPropertyName(name);</span>
<span class="fc" id="L683">        newProp.setPropertyValue(value);</span>
<span class="fc" id="L684">        newProp.setPerson(this);</span>
<span class="fc" id="L685">        addProperty(newProp);</span>
<span class="fc" id="L686">        return true; // changed</span>
    }

    public void deleteNationalId(NationalIdType type) {
<span class="fc" id="L690">        Iterator&lt;NationalId&gt; nit = nationalIds.iterator();</span>
<span class="fc bfc" id="L691" title="All 2 branches covered.">        while (nit.hasNext()) {</span>
<span class="fc" id="L692">            NationalId nid = nit.next();</span>
<span class="fc bfc" id="L693" title="All 2 branches covered.">            if (nid.getType() == type) {</span>
<span class="fc" id="L694">                nid.setType(null); // Stoopid hibernate does inserts &amp; updates ahead of deletes then complains about the (personId,type) constraint</span>
<span class="fc" id="L695">                nit.remove();      // https://forum.hibernate.org/viewtopic.php?t=934483</span>
            }
<span class="fc" id="L697">        }</span>
<span class="fc" id="L698">    }</span>

    /**
     * Unlike other IDs, a patient is only allowed one NationalId for each type.
     * It is therefore possible to offer this convenience method which will
     * update the corresponding NationalId if it exists, else add a new one in.
     *
     * Update - within a country, one subtype can overwrite another, eg an H&amp;C number replacing an English range NHS number
     * @param nationalId
     * @return true if a nationalId was modified or added
     *
     */

    public boolean addOrUpdateNationalId(EHRRequestContext context, NationalId nationalId, Instant editDate) {
<span class="fc" id="L712">        return addOrUpdateNationalId(context, nationalId, nationalId.getType(), editDate);</span>
    }

    public  boolean addOrUpdateNationalId(EHRRequestContext context, NationalId nationalId, NationalIdType originalType, Instant editDate) {
<span class="pc bpc" id="L716" title="1 of 2 branches missed.">        if (nationalId.getType() == null) {</span>
<span class="nc" id="L717">            throw new NullPointerException(&quot;Cannot add national ID with null type&quot;);</span>
        }
        // Assume we aren't making a change
<span class="fc" id="L720">        boolean modified = false;</span>

<span class="fc" id="L722">        Optional&lt;NationalId&gt; maybeNationalId = getNationalIdByExactType(originalType);</span>
<span class="fc bfc" id="L723" title="All 2 branches covered.">        if (maybeNationalId.isPresent()) {</span>
            // Update. We always set the value and edit date even if the value
            // hasn't changed, but if the id is the same type and value we report
            // to the caller that no modification was made
<span class="fc" id="L727">            NationalId found = maybeNationalId.get();</span>
<span class="fc bfc" id="L728" title="All 2 branches covered.">            modified = !found.equals(nationalId);</span>

<span class="fc" id="L730">            found.setEditDate(Date.from(editDate));</span>
<span class="fc" id="L731">            found.setValue(nationalId.getValue());</span>
<span class="fc" id="L732">            found.setType(nationalId.getType());</span>
<span class="fc" id="L733">            found.setVersionDetails(VersionDetails.of(context, editDate));</span>

<span class="pc bpc" id="L735" title="1 of 2 branches missed.">        } else if (isNotBlank(nationalId.getValue())) {</span>
            // add (if the value isn't empty!)
<span class="fc" id="L737">            nationalId.setPerson(this);</span>
<span class="fc bfc" id="L738" title="All 2 branches covered.">            if (nationalId.getEditDate() == null) {</span>
<span class="fc" id="L739">                nationalId.setEditDate(Date.from(editDate));</span>
            }
<span class="fc" id="L741">            nationalId.setVersionDetails(VersionDetails.of(context, editDate));</span>

<span class="fc bfc" id="L743" title="All 2 branches covered.">            if (nationalIds == null) {</span>
<span class="fc" id="L744">                nationalIds = new HashSet&lt;&gt;();</span>
            }
<span class="fc" id="L746">            nationalIds.add(nationalId);</span>
<span class="fc" id="L747">            modified = true;</span>
        }

<span class="fc" id="L750">        return modified;</span>
    }

    public String getAddressMedium() {
<span class="fc" id="L754">        return getAddressStringFromComponentList(address1, address2, postalCode);</span>
    }

    public String getAddressLong() {
<span class="fc" id="L758">        return getAddressStringFromComponentList(address1, address2, city, postalCode, country);</span>
    }

    private String getAddressStringFromComponentList(String... components) {
<span class="fc" id="L762">        StringBuilder sb = new StringBuilder(100);</span>
<span class="fc bfc" id="L763" title="All 2 branches covered.">        for (String component : components) {</span>
<span class="fc bfc" id="L764" title="All 2 branches covered.">            if (isNotBlank(component)) {</span>
<span class="fc" id="L765">                sb.append(component).append(&quot;, &quot;);</span>
            }
        }
<span class="pc bpc" id="L768" title="1 of 4 branches missed.">        if (1 &lt; sb.length() &amp;&amp; sb.charAt(sb.length() - 2) == ',') {</span>
<span class="fc" id="L769">            sb.delete(sb.length() - 2, sb.length());</span>
        }
<span class="fc" id="L771">        return sb.toString();</span>
    }

    // getters/setters

    @Override
    public UserType getUserType() {
<span class="fc" id="L778">        return userType;</span>
    }

    public void setUserType(UserType userType) {
<span class="fc" id="L782">        this.userType = userType;</span>
<span class="fc" id="L783">    }</span>

    public String getPassword() {
<span class="fc" id="L786">        return password;</span>
    }

    public void setPassword(String password) {
<span class="fc" id="L790">        this.password = password;</span>
<span class="fc" id="L791">    }</span>

    public String getFirstName() {
<span class="fc" id="L794">        return firstName;</span>
    }

    public void setFirstName(String firstName) {
<span class="pc bpc" id="L798" title="1 of 2 branches missed.">        this.firstName = firstName == null ? firstName : firstName.trim();</span>
<span class="fc" id="L799">    }</span>

    public String getLastName() {
<span class="fc" id="L802">        return lastName;</span>
    }

    public void setLastName(String lastName) {
<span class="pc bpc" id="L806" title="1 of 2 branches missed.">        this.lastName = lastName == null ? lastName : lastName.trim();</span>
<span class="fc" id="L807">    }</span>

    public String getTitle() {
<span class="fc" id="L810">        return Strings.nullToEmpty(title);</span>
    }

    public void setTitle(String title) {
<span class="fc" id="L814">        this.title = title;</span>
<span class="fc" id="L815">    }</span>

    public String getCountry() {
<span class="fc" id="L818">        return country;</span>
    }

    public void setCountry(String country) {
<span class="fc" id="L822">        this.country = country;</span>
<span class="fc" id="L823">    }</span>

    public String getAddress1() {
<span class="fc" id="L826">        return address1;</span>
    }

    public void setAddress1(String adress1) {
<span class="fc" id="L830">        this.address1 = adress1;</span>
<span class="fc" id="L831">    }</span>

    public String getAddress2() {
<span class="fc" id="L834">        return address2;</span>
    }

    public void setAddress2(String address2) {
<span class="fc" id="L838">        this.address2 = address2;</span>
<span class="fc" id="L839">    }</span>

    public String getCity() {
<span class="fc" id="L842">        return city;</span>
    }

    public void setCity(String city) {
<span class="fc" id="L846">        this.city = city;</span>
<span class="fc" id="L847">    }</span>

    public String getPostalCode() {
<span class="fc" id="L850">        return postalCode;</span>
    }

    public void setPostalCode(String postalCode) {
<span class="fc bfc" id="L854" title="All 2 branches covered.">        this.postalCode = postalCode == null ? postalCode : postalCode.trim();</span>
<span class="fc" id="L855">    }</span>

    /**
     * Returns the user's date of birth in the format yyyy-MM-dd.
     *
     * @return The date of birth in the format yyyy-MM-dd - iff the {@code dateOfBirthString} was present. The empty string - otherwise.
     * @deprecated Use {@link #findDateOfBirth()} instead (and use {@link com.pkb.PKBConstants#DATE_OF_BIRTH_FORMATTER} when needs it in a
     * formatted version).
     */
    @Deprecated
    public String getDateOfBirthString() {
<span class="fc" id="L866">        return StringUtils.trimToEmpty(dateOfBirthString);</span>
    }

    /**
     * Sets the date of birth for this user.
     *
     * @param dateOfBirthString The date of birth. If non-blank, it must be in the format yyyy-MM-dd
     * @throws DateTimeParseException If a non-blank date of birth is provided in an unparseable format
     */
    public void setDateOfBirthString(String dateOfBirthString) {
<span class="fc" id="L876">        String normalizedDateOfBirth = trimToNull(dateOfBirthString);</span>
<span class="fc bfc" id="L877" title="All 2 branches covered.">        if (normalizedDateOfBirth != null) {</span>
            // TODO: Bounds check? For example, see BulkInvitationCliniciansTask.processRow()
<span class="fc" id="L879">            LocalDate.parse(dateOfBirthString, DATE_OF_BIRTH_FORMATTER);</span>
        }
<span class="fc" id="L881">        this.dateOfBirthString = normalizedDateOfBirth;</span>
<span class="fc" id="L882">    }</span>

    /**
     * DO NOT USE THIS, ITS DEPRECATED !!!!!
     *
     * @return A {@code Date} representation - iff {@code dateOfBirthString} is not some form of blank. null - otherwise.
     * @deprecated Use {@link #findDateOfBirth()} instead!!!
     */
    @Deprecated
    public Date getDateOfBirthUTC() {
<span class="fc" id="L892">        return findDateOfBirthInstant()</span>
<span class="fc" id="L893">                .map(Date::from)</span>
<span class="fc" id="L894">                .orElse(null);</span>
    }

    public Optional&lt;Instant&gt; findDateOfBirthInstant() {
<span class="fc" id="L898">        return findDateOfBirth()</span>
<span class="fc" id="L899">                .map(dateOfBirth -&gt; dateOfBirth.atStartOfDay(ZoneOffset.UTC).toInstant());</span>
    }

    /**
     * @return Date of birth as a {@link LocalDate} (so time zone is out of matter).
     */
    public Optional&lt;LocalDate&gt; findDateOfBirth() {
<span class="fc bfc" id="L906" title="All 2 branches covered.">        return isBlank(getDateOfBirthString()) ? empty() : Optional.ofNullable(LocalDate.parse(getDateOfBirthString(), DATE_OF_BIRTH_FORMATTER));</span>
    }

    /**
     * Returns the year component of the {@code dateOfBirthString}
     *
     * @return The DOB year - iff {@code dateOfBirthString} is present. null - otherwise.
     */
    public @Nullable String getDateOfBirthYear() {
<span class="fc" id="L915">        String dobs = getDateOfBirthString();</span>
<span class="pc bpc" id="L916" title="1 of 2 branches missed.">        if (isNotBlank(dobs)) {</span>
<span class="fc" id="L917">            return dobs.substring(0, 4);</span>
        }
<span class="nc" id="L919">        return null;</span>
    }

    public Date getDeathTimestamp() {
<span class="fc" id="L923">        return deathTimestamp;</span>
    }

    public void setDeathTimestamp(Date deathTimestamp) {
<span class="fc" id="L927">        this.deathTimestamp = deathTimestamp;</span>
<span class="fc" id="L928">    }</span>

    public int getGender() {
<span class="fc" id="L931">        return gender;</span>
    }

    public void setGender(int gender) {
<span class="fc" id="L935">        this.gender = gender;</span>
<span class="fc" id="L936">    }</span>

    public String getState() {
<span class="fc" id="L939">        return state;</span>
    }

    public void setState(String state) {
<span class="fc" id="L943">        this.state = state;</span>
<span class="fc" id="L944">    }</span>

    public Long getId() {
<span class="fc" id="L947">        return id;</span>
    }

    /**
     * @return
     * @deprecated Use {@link PKBPerson#getId()} instead!
     */
    @Deprecated
    public String getIdString() {
<span class="fc" id="L956">        return &quot;&quot; + id;</span>
    }

    public void setId(Long id) {
<span class="fc" id="L960">        this.id = id;</span>
<span class="fc" id="L961">    }</span>

    public UserStatus getStatus() {
<span class="fc" id="L964">        return status;</span>
    }

    public boolean isEmailConfirmed() {
<span class="fc bfc" id="L968" title="All 2 branches covered.">        return getStatus() == UserStatus.EMAIL_CONFIRMED;</span>
    }

    public void setStatus(UserStatus status) {
<span class="nc" id="L972">        this.status = status;</span>
<span class="nc" id="L973">    }</span>

    public void setStatus(UserStatus status, @NotNull Instant statusDate) {
<span class="fc" id="L976">        this.status = status;</span>
<span class="fc" id="L977">        this.statusDate = statusDate;</span>
<span class="fc" id="L978">    }</span>

    public Set&lt;PKBPersonProperty&gt; getProperties() {
<span class="fc bfc" id="L981" title="All 2 branches covered.">        if (properties == null) {</span>
<span class="fc" id="L982">            properties = new TreeSet&lt;&gt;();</span>
        }
<span class="fc" id="L984">        return properties;</span>
    }

    public boolean hasPropertiesLoaded() {
<span class="nc" id="L988">        return wasFieldLoaded(properties);</span>
    }

    public void setProperties(Set&lt;PKBPersonProperty&gt; properties) {
<span class="fc" id="L992">        this.properties = properties;</span>
<span class="fc" id="L993">    }</span>

    public void addProperty(PKBPersonProperty property) {
<span class="fc" id="L996">        getProperties().add(property);</span>
<span class="fc" id="L997">    }</span>

    public boolean isUserAcceptedInviteClinicianTerms() {
<span class="nc" id="L1000">        boolean agreed = false;</span>
<span class="nc bnc" id="L1001" title="All 2 branches missed.">        for (PKBPersonProperty property : getProperties()) {</span>
<span class="nc bnc" id="L1002" title="All 2 branches missed.">            if (property.getPropertyName() == INVITE_CLINICIAN_TERMS) {</span>
<span class="nc" id="L1003">                agreed = true;</span>
<span class="nc" id="L1004">                break;</span>
            }
<span class="nc" id="L1006">        }</span>
<span class="nc" id="L1007">        return agreed;</span>
    }

    public String getOrganizationName() {
<span class="fc" id="L1011">        return organizationName;</span>
    }

    public void setOrganizationName(String organizationName) {
<span class="fc" id="L1015">        this.organizationName = organizationName;</span>
<span class="fc" id="L1016">    }</span>

    public String getOrganizationUnit() {
<span class="fc" id="L1019">        return organizationUnit;</span>
    }

    public void setOrganizationUnit(String organizationUnit) {
<span class="fc" id="L1023">        this.organizationUnit = organizationUnit;</span>
<span class="fc" id="L1024">    }</span>

    public String getPhone() {
<span class="fc" id="L1027">        return phone;</span>
    }

    public void setPhone(String phone) {
<span class="fc" id="L1031">        this.phone = phone;</span>
<span class="fc" id="L1032">    }</span>

    public String getPhoneClean() {
<span class="fc" id="L1035">        return PKBPerson.getPhoneClean(phone);</span>
    }

    /**
     * convenience method to getting the primary email from the PersonContact
     * set
     */
    public @Nullable Email getEmail() {
<span class="fc" id="L1043">        return findEmail().getOrNull();</span>
    }

    public Option&lt;Email&gt; findEmail() {
<span class="fc" id="L1047">        return findPrimaryContact()</span>
<span class="fc" id="L1048">                .flatMap(PersonContact::getContactIfEmail);</span>
    }

    public PersonContact getPrimaryContact() {
<span class="fc" id="L1052">        return findPrimaryContact().getOrNull();</span>
    }

    public Option&lt;PersonContact&gt; findPrimaryContact() {
<span class="pc bpc" id="L1056" title="1 of 2 branches missed.">        if (contacts == null) {</span>
<span class="nc" id="L1057">            return None();</span>
        }

<span class="fc bfc" id="L1060" title="All 2 branches covered.">        for (PersonContact contact : contacts) {</span>
<span class="fc bfc" id="L1061" title="All 2 branches covered.">            if (contact.getIsPrimary()) {</span>
<span class="fc" id="L1062">                return Some(contact);</span>
            }
<span class="fc" id="L1064">        }</span>
<span class="fc" id="L1065">        return None(); // no primary contact found</span>
    }

    public void setPrimaryContact(Long primaryContactId) {
<span class="pc bfc" id="L1069" title="All 2 branches covered.">        setPrimaryContactFlag(contact -&gt; contact.getId().compareTo(primaryContactId) == 0, () -&gt; None());</span>
<span class="fc" id="L1070">    }</span>

    public boolean flipPrimaryFlagIfPresent(@NotNull Email email) {
<span class="fc" id="L1073">        var targetEmail = Option.of(email);</span>
<span class="pc" id="L1074">        return setPrimaryContactFlag(contact -&gt; targetEmail.equals(contact.getContactIfEmail()), () -&gt; None());</span>
    }

    public void deleteEmailContact(Long contactId) {
<span class="nc" id="L1078">        Iterator&lt;PersonContact&gt; iter = contacts.iterator();</span>
<span class="nc bnc" id="L1079" title="All 2 branches missed.">        while (iter.hasNext()) {</span>
<span class="nc bnc" id="L1080" title="All 2 branches missed.">            if (iter.next().getId().equals(contactId)) {</span>
<span class="nc" id="L1081">                iter.remove();</span>
<span class="nc" id="L1082">                break;</span>
            }
        }
<span class="nc" id="L1085">    }</span>

    public String getLongEmail() {
<span class="nc" id="L1088">        return firstName + &quot; &quot; + lastName + &quot; &lt;&quot; + findEmail().map(Email::address).getOrNull() + &quot;&gt;&quot;;</span>
    }

    private boolean setPrimaryContactFlag(Predicate&lt;PersonContact&gt; matcher, Supplier&lt;Option&lt;PersonContact&gt;&gt; addWhenMissing) {
<span class="fc" id="L1092">        boolean found = false;</span>
<span class="fc" id="L1093">        boolean changed = false;</span>
<span class="fc bfc" id="L1094" title="All 2 branches covered.">        if (contacts == null) {</span>
<span class="fc" id="L1095">            contacts = new HashSet&lt;&gt;();</span>
        } else {
<span class="fc bfc" id="L1097" title="All 2 branches covered.">            if (contacts.stream().anyMatch(matcher)) {</span>
<span class="fc bfc" id="L1098" title="All 2 branches covered.">                for (PersonContact personContact : contacts) {</span>
<span class="pc bpc" id="L1099" title="1 of 4 branches missed.">                    if (matcher.test(personContact) &amp;&amp; !found) {</span>
<span class="fc bfc" id="L1100" title="All 2 branches covered.">                        if (!personContact.getIsPrimary()) {</span>
<span class="fc" id="L1101">                            changed = true;</span>
                        }
<span class="fc" id="L1103">                        personContact.setPrimary(true);</span>
<span class="fc" id="L1104">                        found = true;</span>
                    } else {
<span class="fc" id="L1106">                        personContact.setPrimary(false);</span>
                    }
<span class="fc" id="L1108">                }</span>
            }
        }

<span class="fc bfc" id="L1112" title="All 2 branches covered.">        if (!found) {</span>
<span class="fc" id="L1113">            addWhenMissing.get().peek(newPrimary -&gt; {</span>
<span class="fc" id="L1114">                contacts.forEach(oldContact -&gt; oldContact.setPrimary(false));</span>
<span class="fc" id="L1115">                contacts.add(newPrimary);</span>
<span class="fc" id="L1116">            });</span>
        }

<span class="fc" id="L1119">        return changed;</span>
    }

    /**
     * utility: set the primary, email contact -- just ignore if the mail is
     * already in the contact list in any state.
     */

    public void setPrimaryEmail(@NotNull Email newPrimaryEmail, VersionDetails versionDetails) {
<span class="fc" id="L1128">        var targetEmail = Option.of(newPrimaryEmail);</span>
<span class="fc" id="L1129">        setPrimaryContactFlag(</span>
<span class="fc" id="L1130">                contact -&gt; contact.getContactIfEmail().equals(targetEmail),</span>
                () -&gt; {
<span class="fc" id="L1132">                    PersonContact newContact = new PersonContact();</span>
<span class="fc" id="L1133">                    newContact.setPublicId(UUID.randomUUID());</span>
<span class="fc" id="L1134">                    newContact.setConfirmed(false);</span>
<span class="fc" id="L1135">                    newContact.setContactAsEmail(newPrimaryEmail);</span>
<span class="fc" id="L1136">                    newContact.setPerson(this);</span>
<span class="fc" id="L1137">                    newContact.setPrimary(true);</span>
<span class="fc" id="L1138">                    newContact.setVersionDetails(versionDetails);</span>
<span class="fc" id="L1139">                    return Some(newContact);</span>
                }
        );
<span class="fc" id="L1142">    }</span>

    public boolean hasContact() {
        // replace the NOCONTACT status
<span class="pc bpc" id="L1146" title="1 of 4 branches missed.">        if ((contacts == null) || contacts.isEmpty()) {</span>
<span class="fc" id="L1147">            return false;</span>
        }
        // search for a valid contact (ALSO_CONTACT doesn't count)
<span class="fc bfc" id="L1150" title="All 2 branches covered.">        for (PersonContact pc : contacts) {</span>
<span class="fc bfc" id="L1151" title="All 2 branches covered.">            if (pc.findAlsoContactPerson().isEmpty()) {</span>
<span class="fc" id="L1152">                return true;</span>
            }
<span class="fc" id="L1154">        }</span>
        // none found
<span class="fc" id="L1156">        return false;</span>
    }

    public boolean isContactable() {
<span class="fc bfc" id="L1160" title="All 4 branches covered.">        return hasContact() &amp;&amp; !NOT_CONTACTABLE_STATUSES.contains(getStatus());</span>
    }

    public Email getUserName() {
<span class="fc" id="L1164">        return findEmail().getOrNull();</span>
    }

    public String getSkypeId() {
<span class="fc" id="L1168">        return skypeId;</span>
    }

    public void setSkypeId(String skypeId) {
<span class="fc bfc" id="L1172" title="All 2 branches covered.">        this.skypeId = skypeId == null ? skypeId : skypeId.trim().toLowerCase();</span>
<span class="fc" id="L1173">    }</span>

    public Set&lt;NationalId&gt; getNationalIds() {
<span class="fc bfc" id="L1176" title="All 2 branches covered.">        if (nationalIds == null) {</span>
<span class="fc" id="L1177">            nationalIds = new HashSet&lt;&gt;();</span>
        }
<span class="fc" id="L1179">        return nationalIds;</span>
    }

    public void setNationalIds(Set&lt;NationalId&gt; nationalIds) {
<span class="fc" id="L1183">        this.nationalIds = nationalIds;</span>
<span class="fc" id="L1184">    }</span>

    public boolean hasNationalIdsLoaded() {
<span class="fc" id="L1187">        return wasFieldLoaded(nationalIds);</span>
    }

    public SortedSet&lt;OrgLevelId&gt; getOrgLevelIds() {
<span class="fc bfc" id="L1191" title="All 2 branches covered.">        if (orgLevelIds == null) {</span>
<span class="fc" id="L1192">            orgLevelIds = new TreeSet&lt;&gt;();</span>
        }
<span class="fc" id="L1194">        return orgLevelIds;</span>
    }

    public boolean hasOrgLevelIdsLoaded() {
<span class="fc" id="L1198">        return wasFieldLoaded(orgLevelIds);</span>
    }

    public void setOrgLevelIds(SortedSet&lt;OrgLevelId&gt; orgLevelIds) {
<span class="fc" id="L1202">        this.orgLevelIds = orgLevelIds;</span>
<span class="fc" id="L1203">    }</span>

    public SortedSet&lt;TeamLevelId&gt; getTeamLevelIds() {
<span class="fc" id="L1206">        return teamLevelIds;</span>
    }

    public boolean hasTeamLevelIdsLoaded() {
<span class="fc" id="L1210">        return wasFieldLoaded(teamLevelIds);</span>
    }

    public void setTeamLevelIds(SortedSet&lt;TeamLevelId&gt; teamLevelIds) {
<span class="fc" id="L1214">        this.teamLevelIds = teamLevelIds;</span>
<span class="fc" id="L1215">    }</span>

    @Override
    public String toString() {
<span class="fc" id="L1219">        return MoreObjects.toStringHelper(&quot;PKBPerson&quot;)</span>
<span class="fc" id="L1220">                .omitNullValues()</span>
<span class="fc" id="L1221">                .add(&quot;id&quot;, id)</span>
<span class="fc" id="L1222">                .add(&quot;userType&quot;, userType)</span>
<span class="fc" id="L1223">                .add(&quot;status&quot;, status)</span>
<span class="fc" id="L1224">                .add(&quot;versionDetails&quot;, versionDetails)</span>
<span class="fc" id="L1225">                .toString();</span>
    }

    public UUID getPwdAccessDocumentMetadataId() {
<span class="fc" id="L1229">        return pwdAccessDocumentMetadataId;</span>
    }

    public void setPwdAccessDocumentMetadataId(UUID pwdAccessDocumentMetadataId) {
<span class="fc" id="L1233">        this.pwdAccessDocumentMetadataId = pwdAccessDocumentMetadataId;</span>
<span class="fc" id="L1234">    }</span>

    public boolean hasContactsLoaded() {
<span class="fc" id="L1237">        return wasFieldLoaded(contacts);</span>
    }

    public Set&lt;PersonContact&gt; getContacts() {
<span class="fc bfc" id="L1241" title="All 2 branches covered.">        if (contacts == null) {</span>
<span class="fc" id="L1242">            contacts = new HashSet&lt;&gt;();</span>
        }
<span class="fc" id="L1244">        return contacts;</span>
    }

    public boolean hasEmail(@NotNull Email email) {
<span class="fc bfc" id="L1248" title="All 2 branches covered.">        for (var personContact : getContacts()) {</span>
<span class="fc bfc" id="L1249" title="All 2 branches covered.">            if (personContact.getContactIfEmail().filter(contactEmail -&gt; contactEmail.equals(email)).isDefined()) {</span>
<span class="fc" id="L1250">                return true;</span>
            }
<span class="fc" id="L1252">        }</span>

<span class="fc" id="L1254">        return false;</span>
    }

    public void setContacts(Set&lt;PersonContact&gt; contacts) {
<span class="fc" id="L1258">        this.contacts = contacts;</span>
<span class="fc" id="L1259">    }</span>

    public String getJobTitle() {
<span class="fc" id="L1262">        return jobTitle;</span>
    }

    public void setJobTitle(String jobTitle) {
<span class="fc" id="L1266">        this.jobTitle = jobTitle;</span>
<span class="fc" id="L1267">    }</span>

    public Date getAccountCreation() {
<span class="fc" id="L1270">        return accountCreation;</span>
    }

    public void setAccountCreation(Date accountCreation) {
<span class="fc" id="L1274">        this.accountCreation = accountCreation;</span>
<span class="fc" id="L1275">    }</span>

    @Deprecated
    /* bad for i18n... */
    public String getFullName() {
<span class="fc bfc" id="L1280" title="All 2 branches covered.">        if (title == null) {</span>
<span class="fc" id="L1281">            return firstName + &quot; &quot; + lastName;</span>
        } else {
<span class="fc" id="L1283">            return title + &quot; &quot; + firstName + &quot; &quot; + lastName;</span>
        }
    }

    public String getNameWithoutTitle() {
<span class="fc" id="L1288">        return firstName + &quot; &quot; + lastName;</span>
    }

    /**
     * never null or blank: defaults to &quot;en&quot; if not populated
     */
    public String getLanguageCode() {
<span class="fc bfc" id="L1295" title="All 2 branches covered.">        if (isBlank(languageCode)) {</span>
<span class="fc" id="L1296">            return Locale.ENGLISH.getLanguage();</span>
        }
<span class="fc" id="L1298">        return languageCode;</span>
    }

    public Locale getLocale() {
        // rely on getLanguageCode() default behavior
<span class="fc" id="L1303">        return new Locale(getLanguageCode());</span>
    }

    public void setLanguageCode(String languageCode) {
<span class="fc" id="L1307">        this.languageCode = languageCode;</span>
<span class="fc" id="L1308">    }</span>

    public String getTimeZoneId() {
<span class="fc" id="L1311">        return timeZoneId;</span>
    }

    /**
     * @return
     * @deprecated Use {@link PKBPerson#getZoneId()}
     */
    @Deprecated
    public @Nullable TimeZone getTimeZone() {
<span class="nc bnc" id="L1320" title="All 2 branches missed.">        if (StringUtils.isEmpty(getTimeZoneId())) {</span>
<span class="nc" id="L1321">            return null;</span>
        } else {
<span class="nc" id="L1323">            return TimeZone.getTimeZone(getTimeZoneId());</span>
        }
    }

    @Nullable
    public ZoneId getZoneId() {
<span class="pc bpc" id="L1329" title="1 of 2 branches missed.">        return isBlank(timeZoneId) ? null : TimeZone.getTimeZone(timeZoneId).toZoneId();</span>
    }

    public void setTimeZoneId(String timeZoneId) {
<span class="fc" id="L1333">        this.timeZoneId = timeZoneId;</span>
<span class="fc" id="L1334">    }</span>

    @Override
    public int hashCode() {
<span class="fc" id="L1338">        int prime = 31;</span>
<span class="fc" id="L1339">        int result = 1;</span>
<span class="pc bpc" id="L1340" title="1 of 2 branches missed.">        result = (prime * result) + ((id == null) ? 0 : id.hashCode());</span>
<span class="pc bpc" id="L1341" title="1 of 2 branches missed.">        result = (prime * result) + ((firstName == null) ? 0 : firstName.hashCode());</span>
<span class="pc bpc" id="L1342" title="1 of 2 branches missed.">        result = (prime * result) + ((lastName == null) ? 0 : lastName.hashCode());</span>
<span class="fc" id="L1343">        return result;</span>
    }

    @Override
    public boolean equals(Object obj) {
<span class="pc bpc" id="L1348" title="1 of 2 branches missed.">        if (this == obj) {</span>
<span class="nc" id="L1349">            return true;</span>
        }
<span class="pc bpc" id="L1351" title="1 of 2 branches missed.">        if (obj == null) {</span>
<span class="nc" id="L1352">            return false;</span>
        }
<span class="pc bpc" id="L1354" title="1 of 2 branches missed.">        if (!(obj instanceof PKBPerson)) {</span>
<span class="nc" id="L1355">            return false;</span>
        }
<span class="fc" id="L1357">        PKBPerson other = (PKBPerson) obj;</span>
<span class="pc bpc" id="L1358" title="1 of 2 branches missed.">        if (id == null) {</span>
<span class="nc bnc" id="L1359" title="All 2 branches missed.">            if (other.getId() != null) {</span>
<span class="nc" id="L1360">                return false;</span>
            }
<span class="fc bfc" id="L1362" title="All 2 branches covered.">        } else if (!id.equals(other.getId())) {</span>
<span class="fc" id="L1363">            return false;</span>
        }

<span class="pc bpc" id="L1366" title="1 of 2 branches missed.">        if (firstName == null) {</span>
<span class="nc bnc" id="L1367" title="All 2 branches missed.">            if (other.getFirstName() != null) {</span>
<span class="nc" id="L1368">                return false;</span>
            }
<span class="pc bpc" id="L1370" title="1 of 2 branches missed.">        } else if (!firstName.equals(other.getFirstName())) {</span>
<span class="nc" id="L1371">            return false;</span>
        }

<span class="pc bpc" id="L1374" title="1 of 2 branches missed.">        if (lastName == null) {</span>
<span class="nc bnc" id="L1375" title="All 2 branches missed.">            if (other.getLastName() != null) {</span>
<span class="nc" id="L1376">                return false;</span>
            }
<span class="pc bpc" id="L1378" title="1 of 2 branches missed.">        } else if (!lastName.equals(other.getLastName())) {</span>
<span class="nc" id="L1379">            return false;</span>
        }

<span class="fc" id="L1382">        return true;</span>
    }

    public Date getRegisteredOn() {
<span class="fc" id="L1386">        return registeredOn;</span>
    }

    public void setRegisteredOn(Date registeredOn) {
<span class="fc" id="L1390">        this.registeredOn = registeredOn;</span>
<span class="fc" id="L1391">    }</span>

    public String getMiddleName() {
<span class="fc" id="L1394">        return middleName;</span>
    }

    public void setMiddleName(String middleName) {
<span class="fc" id="L1398">        this.middleName = middleName;</span>
<span class="fc" id="L1399">    }</span>

    public Long getDefaultAccountId() {
<span class="fc" id="L1402">        return defaultAccountId;</span>
    }

    /**
     * @throws IllegalStateException for an attempt to overwrite a non-null value
     */
    public void setDefaultAccountId(Long newDefaultAccountId) {
<span class="pc bpc" id="L1409" title="3 of 4 branches missed.">        if (defaultAccountId != null &amp;&amp; !Objects.equals(this.defaultAccountId, newDefaultAccountId)) {</span>
<span class="nc" id="L1410">            throw new IllegalStateException(&quot;Cannot overwrite defaultAccountId &quot; + this.defaultAccountId + &quot; already set for person &quot; + id);</span>
        }
<span class="fc" id="L1412">        this.defaultAccountId = newDefaultAccountId;</span>
<span class="fc" id="L1413">    }</span>

    public String getHumanUUID() {
<span class="fc" id="L1416">        return humanUUID;</span>
    }

    public void setHumanUUID(String humanUUID) {
<span class="fc" id="L1420">        this.humanUUID = humanUUID;</span>
<span class="fc" id="L1421">    }</span>

    public boolean isLinkedToHuman(PKBPerson otherPerson) {
<span class="nc bnc" id="L1424" title="All 2 branches missed.">        return otherPerson != null</span>
<span class="nc bnc" id="L1425" title="All 2 branches missed.">                &amp;&amp; isNotBlank(getHumanUUID())</span>
<span class="nc bnc" id="L1426" title="All 2 branches missed.">                &amp;&amp; getHumanUUID().equals(otherPerson.getHumanUUID());</span>
    }

    public Long getFrozenByTeamId() {
<span class="fc" id="L1430">        return frozenByTeamId;</span>
    }

    /**
     * helper method for JSPs
     */
    public boolean isFrozenByTeam() {
<span class="fc bfc" id="L1437" title="All 2 branches covered.">        return getFrozenByTeamId() != null;</span>
    }

    public void setFrozenByTeamId(Long frozenByTeamId) {
<span class="fc" id="L1441">        this.frozenByTeamId = frozenByTeamId;</span>
<span class="fc" id="L1442">    }</span>

    public EmisEsPersonGuid getEmisEsPersonGuid() {
<span class="fc" id="L1445">        return emisEsPersonGuid;</span>
    }

    public void setEmisEsPersonGuid(EmisEsPersonGuid emisEsPersonGuid) {
<span class="fc" id="L1449">        this.emisEsPersonGuid = emisEsPersonGuid;</span>
<span class="fc" id="L1450">    }</span>

    public TwoFactorAuthState getTwoFactorAuthState() {
<span class="fc" id="L1453">        return twoFactorAuthState;</span>
    }

    public void setTwoFactorAuthState(TwoFactorAuthState twoFactorAuthState) {
<span class="fc" id="L1457">        this.twoFactorAuthState = twoFactorAuthState;</span>
<span class="fc" id="L1458">    }</span>

    public String getTwoFactorSecret() {
<span class="fc" id="L1461">        return twoFactorSecret;</span>
    }

    public void setTwoFactorSecret(String twoFactorSecret) {
<span class="fc" id="L1465">        this.twoFactorSecret = twoFactorSecret;</span>
<span class="fc" id="L1466">    }</span>

    public boolean getTwoFactorAuthMandatory() {
<span class="fc bfc" id="L1469" title="All 4 branches covered.">        return twoFactorAuthMandatory != null &amp;&amp; twoFactorAuthMandatory;</span>
    }

    @Override
    public VersionDetails getVersionDetails() {
<span class="fc" id="L1474">        return versionDetails;</span>
    }

    public void setTwoFactorAuthMandatory(Boolean twoFactorAuthMandatory) {
<span class="nc" id="L1478">        this.twoFactorAuthMandatory = twoFactorAuthMandatory;</span>
<span class="nc" id="L1479">    }</span>

    @Override
    public void setVersionDetails(VersionDetails versionDetails) {
<span class="fc" id="L1483">        this.versionDetails = versionDetails;</span>
<span class="fc" id="L1484">    }</span>

    public NotificationOption getNotificationOption() {
<span class="fc" id="L1487">        return notificationOption;</span>
    }

    public void setNotificationOption(NotificationOption notificationOption) {
<span class="fc" id="L1491">        this.notificationOption = notificationOption;</span>
<span class="fc" id="L1492">    }</span>

    public Date getLastEmailSent() {
<span class="nc" id="L1495">        return lastEmailSent;</span>
    }

    public void setLastEmailSent(Date lastEmailSent) {
<span class="fc" id="L1499">        this.lastEmailSent = lastEmailSent;</span>
<span class="fc" id="L1500">    }</span>

    public boolean wantsOneEmailPerDay() {
<span class="fc bfc" id="L1503" title="All 2 branches covered.">        return this.notificationOption == NotificationOption.MAX_ONE_EMAIL_PER_DAY;</span>
    }

    /**
     * Checks if last email was sent today (in person's time zone ).
     */
    public boolean receivedEmailToday(DateTimeService dateTimeService) {
<span class="fc bfc" id="L1510" title="All 2 branches covered.">        if (lastEmailSent == null) {</span>
<span class="fc" id="L1511">            return false;</span>
        }

<span class="fc" id="L1514">        ZoneId zone = getZoneId();</span>

        LocalDate today;
        LocalDate lastSentOn;
<span class="pc bpc" id="L1518" title="1 of 2 branches missed.">        if (zone != null) {</span>
<span class="fc" id="L1519">            today = dateTimeService.todayAtZoneId(zone);</span>
<span class="fc" id="L1520">            lastSentOn = dateTimeService.convertToLocalDateAtZoneId(lastEmailSent, zone);</span>
        } else {
<span class="nc" id="L1522">            today = dateTimeService.todayAtZoneId(APPLICATION_TZ);</span>
<span class="nc" id="L1523">            lastSentOn = dateTimeService.convertToLocalDateAtZoneId(lastEmailSent, APPLICATION_TZ);</span>
        }
<span class="fc" id="L1525">        return today.isEqual(lastSentOn);</span>
    }

    public PatientOptOut getOptoutDetails() {
<span class="fc" id="L1529">        return optoutDetails;</span>
    }

    public void setOptoutDetails(PatientOptOut optoutDetails) {
<span class="fc" id="L1533">        this.optoutDetails = optoutDetails;</span>
<span class="fc" id="L1534">    }</span>

    public boolean isSharingEnabled() {
<span class="fc bfc" id="L1537" title="All 4 branches covered.">        return getOptoutDetails() == null || getOptoutDetails().isSharingEnabled();</span>
    }

    public Instant getStatusDate() {
<span class="fc" id="L1541">        return statusDate;</span>
    }

    public void setStatusDate(Instant statusDate) {
<span class="nc" id="L1545">        this.statusDate = statusDate;</span>
<span class="nc" id="L1546">    }</span>

    @PrePersist
    @PreUpdate
    public void checkStatusDate() {
<span class="pc bpc" id="L1551" title="1 of 2 branches missed.">        if (statusDate == null) {</span>
<span class="nc" id="L1552">            throw new IllegalStateException(&quot;statusDate is not set&quot;);</span>
        }
<span class="fc" id="L1554">    }</span>

    private &lt;T&gt; boolean wasFieldLoaded(T input) {
<span class="fc bfc" id="L1557" title="All 4 branches covered.">        return input != null &amp;&amp; Hibernate.isInitialized(input);</span>
    }

    public UUID getPublicId() {
<span class="fc" id="L1561">        return publicId;</span>
    }

    public void setPublicId(UUID publicId) {
<span class="fc" id="L1565">        this.publicId = publicId;</span>
<span class="fc" id="L1566">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>