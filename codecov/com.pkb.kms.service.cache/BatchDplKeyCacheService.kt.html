<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BatchDplKeyCacheService.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.kms.service.cache</a> &gt; <span class="el_source">BatchDplKeyCacheService.kt</span></div><h1>BatchDplKeyCacheService.kt</h1><pre class="source lang-java linenums">package com.pkb.kms.service.cache

import com.pkb.crypto.SymmetricKey
import com.pkb.crypto.dto.AccountKeysDTO
import com.pkb.crypto.dto.AccountSymmetricKeyDTO
import com.pkb.crypto.dto.DplKeyDTO
import com.pkb.entities.core.DatapointSymmetricKey
import com.pkb.kms.service.repository.DplKeyRepository
import com.pkb.kms.shared.representation.AccountIds
import com.pkb.kms.shared.representation.AccountPrivateId
import com.pkb.kms.shared.representation.DplKeyId
import com.pkb.kms.shared.representation.KmsError
import io.vavr.Tuple2
import io.vavr.collection.Seq
import io.vavr.control.Either
import io.vavr.kotlin.tuple
import org.springframework.stereotype.Service

<span class="fc" id="L19">@Service</span>
<span class="fc" id="L20">class BatchDplKeyCacheService(private val internalService: DplKeyCacheService, private val dplKeyRepository: DplKeyRepository) {</span>


    fun getDplKeysForAccount(accountIds: AccountIds, keyIds: List&lt;DplKeyId&gt;, accountKeys: AccountKeysDTO): Either&lt;KmsError, List&lt;DplKeyDTO&gt;&gt; =
<span class="fc" id="L24">            getKeysFromCache(accountIds.id, keyIds)</span>
<span class="fc" id="L25">                    .map1 { notCached -&gt; loadAndDecryptKeys(accountIds.id, notCached, accountKeys) }</span>
<span class="fc" id="L26">                    .apply { dbLoadResults, cached -&gt;</span>
<span class="fc" id="L27">                        dbLoadResults.map { dbLoaded -&gt; dbLoaded.appendAll(cached).toJavaList() }</span>
<span class="fc" id="L28">                    }</span>


    private fun getKeysFromCache(accountId: AccountPrivateId, keyIds: List&lt;DplKeyId&gt;): Tuple2&lt;List&lt;DplKeyId&gt;, List&lt;DplKeyDTO&gt;&gt; {
<span class="fc" id="L32">        val keys = keyIds.map { keyId -&gt; Pair(accountId, keyId) }</span>
<span class="fc" id="L33">        return internalService.getDplKeysForAccountsFromCache(keys).tuple()</span>
    }

    fun createDplKeyForAccount(dplSymmetricKey: SymmetricKey, dplKeyId: DplKeyId, accountId: AccountPrivateId, accountSymmetricKeyDTO: AccountSymmetricKeyDTO): Either&lt;KmsError, DplKeyDTO&gt; =
<span class="fc" id="L37">            internalService.createDplKeyForAccount(dplSymmetricKey, dplKeyId, accountId, accountSymmetricKeyDTO)</span>


    private fun loadAndDecryptKeys(accountId: AccountPrivateId, keyIds: List&lt;DplKeyId&gt;, accountKeys: AccountKeysDTO): Either&lt;KmsError, Seq&lt;DplKeyDTO&gt;&gt; =
<span class="fc" id="L41">            dplKeyRepository.findDatapointSymmetricKeysByAccountIdAndKeyIdIn(accountId, keyIds).let { dbLoadResults -&gt;</span>
<span class="pc bpc" id="L42" title="1 of 2 branches missed.">                if (dbLoadResults.size != keyIds.size) {</span>
<span class="nc" id="L43">                    Either.left(missingKeyIds(keyIds.subtract(dbLoadResults.map(DatapointSymmetricKey::getKeyId)), accountId))</span>
                } else {
<span class="pc" id="L45">                    Either.sequenceRight(dbLoadResults.map { internalService.decryptAndCacheDplKey(accountKeys, it) })</span>
                }
<span class="fc" id="L47">            }</span>

    private fun missingKeyIds(missingIds: Set&lt;DplKeyId&gt;, accountId: AccountPrivateId) =
<span class="nc" id="L50">            KmsError(&quot;dpl.keys.not.found&quot;, &quot;Could not find the following dpl keys for account $accountId : $missingIds&quot;, KmsError.Type.NOT_FOUND)</span>
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>