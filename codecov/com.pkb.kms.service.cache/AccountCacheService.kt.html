<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AccountCacheService.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.kms.service.cache</a> &gt; <span class="el_source">AccountCacheService.kt</span></div><h1>AccountCacheService.kt</h1><pre class="source lang-java linenums">package com.pkb.kms.service.cache

import com.pkb.common.ClearableInternalState
import com.pkb.entities.core.CoreAccount
import com.pkb.kms.service.MetricsHelper
import com.pkb.kms.service.repository.AccountRepository
import com.pkb.kms.shared.KMS_CACHE_PREFIX
import com.pkb.kms.shared.representation.AccountIds
import com.pkb.kms.shared.representation.AccountPublicId
import com.pkb.kms.shared.representation.KmsError
import com.pkb.kms.shared.representation.PersonPublicId
import io.vavr.control.Either
import io.vavr.control.Try
import io.vavr.kotlin.left
import io.vavr.kotlin.right
import org.slf4j.Logger
import org.slf4j.LoggerFactory
import org.springframework.cache.annotation.CacheEvict
import org.springframework.cache.annotation.CachePut
import org.springframework.cache.annotation.Cacheable
import org.springframework.stereotype.Service
import java.lang.invoke.MethodHandles

<span class="fc" id="L24">@Service</span>
<span class="fc" id="L25">class AccountCacheService(private val accountRepository: AccountRepository,</span>
                          metrics: MetricsHelper,
<span class="fc" id="L27">private val kmsCacheManager: KmsCacheManager) : ClearableInternalState, HasDeprecatedCaches {</span>

<span class="fc" id="L29">    private val log: Logger = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass())</span>

<span class="fc" id="L31">    init {</span>
<span class="fc" id="L32">        metrics.registerCaches(ACCOUNT_CACHE_NAME)</span>
<span class="fc" id="L33">    }</span>

    /**
     * Finds the account with the given public id
     */
    @Cacheable(ACCOUNT_CACHE_NAME, key = &quot;#accountPublicId&quot;, unless = &quot;#result.isLeft()&quot;)
    fun findAccount(accountPublicId: AccountPublicId): Either&lt;KmsError, CoreAccount&gt; =
<span class="fc" id="L40">            accountRepository.findByPublicId(accountPublicId)</span>
<span class="fc" id="L41">                    .map { right&lt;KmsError, CoreAccount&gt;(it) }</span>
<span class="pc" id="L42">                    .orElseGet { left(KmsError.accountNotFound(accountPublicId)) }</span>

    @Cacheable(PERSON_DEFAULT_ACCOUNT_CACHE_NAME, key = &quot;#personPublicId&quot;, unless = &quot;#result.isLeft()&quot;)
    fun findDefaultAccountForPerson(personPublicId: PersonPublicId): Either&lt;KmsError, AccountIds&gt; =
<span class="fc" id="L46">            accountRepository.findDefaultAccountForPerson(personPublicId)</span>
<span class="fc" id="L47">                    .map { right&lt;KmsError, AccountIds&gt;(it) }</span>
<span class="pc" id="L48">                    .orElseGet { left(KmsError(&quot;default.account.not.found&quot;, &quot;Default account not found for person $personPublicId&quot;, KmsError.Type.NOT_FOUND)) }</span>


    @CachePut(ACCOUNT_CACHE_NAME, key = &quot;#result.get().publicId&quot;, unless = &quot;#result.isLeft()&quot;)
    fun saveAccount(account: CoreAccount): Either&lt;KmsError, CoreAccount&gt; =
<span class="fc" id="L53">        Try.of{accountRepository.saveAndFlush(account)}</span>
<span class="fc" id="L54">            .toEither()</span>
<span class="pc bnc" id="L55" title="All 2 branches missed.">            .mapLeft { KmsError(&quot;account.creation.failure&quot;, it.message ?: &quot;&quot;, KmsError.Type.UNEXPECTED)}</span>

    fun findAccounts(accountPublicIds: Collection&lt;AccountPublicId&gt;) : List&lt;CoreAccount&gt; {
<span class="fc" id="L58">        val cachedAccounts = kmsCacheManager.getAll&lt;Any, Either&lt;KmsError, CoreAccount&gt;&gt;(ACCOUNT_CACHE_NAME, accountPublicIds)</span>
<span class="fc" id="L59">            .values</span>
<span class="fc" id="L60">            .flatMap { it.asIterable() }</span>

<span class="fc" id="L62">        val toLoad = accountPublicIds - cachedAccounts.map(CoreAccount::getPublicId)</span>

<span class="fc" id="L64">        return cachedAccounts + accountRepository.findAllByPublicIdIn(toLoad)</span>
<span class="fc" id="L65">            .also {</span>
<span class="fc" id="L66">                kmsCacheManager.putAll(ACCOUNT_CACHE_NAME, it.associateBy(CoreAccount::getPublicId) {Either.right&lt;KmsError, CoreAccount&gt;(it)})</span>
<span class="fc" id="L67">            }</span>
    }

    /**
     * Removes all cached accounts
     */
    @CacheEvict(cacheNames = [ACCOUNT_CACHE_NAME], allEntries = true)
    override fun clearState() {
<span class="fc" id="L75">        log.warn(&quot;Cache cleared&quot;)</span>
<span class="fc" id="L76">    }</span>

    /**
     * Removes the cached account private key for [accountPublicId]
     */
    @CacheEvict(cacheNames = [ACCOUNT_CACHE_NAME], key = &quot;#accountPublicId&quot;)
    fun evictAccount(accountPublicId: AccountPublicId) {
<span class="nc" id="L83">        log.debug(&quot;Evicted account $accountPublicId from cache&quot;)</span>
<span class="nc" id="L84">    }</span>

<span class="fc" id="L86">    override val deprecatedCaches = setOf(DEPRECATED_ACCOUNT_CACHE_NAME, DEPRECATED_ACCOUNT_PRIVATE_KEY_CACHE_NAME)</span>

    companion object {
        const val ACCOUNT_CACHE_NAME = &quot;${KMS_CACHE_PREFIX}_account2&quot;
        const val PERSON_DEFAULT_ACCOUNT_CACHE_NAME = &quot;${KMS_CACHE_PREFIX}_personDefaultAccountId&quot;

        const val DEPRECATED_ACCOUNT_CACHE_NAME = &quot;${KMS_CACHE_PREFIX}_account&quot;
        const val DEPRECATED_ACCOUNT_PRIVATE_KEY_CACHE_NAME = &quot;${KMS_CACHE_PREFIX}_accountPrivateKey&quot;
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>