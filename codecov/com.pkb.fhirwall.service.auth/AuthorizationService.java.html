<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AuthorizationService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.fhirwall.service.auth</a> &gt; <span class="el_source">AuthorizationService.java</span></div><h1>AuthorizationService.java</h1><pre class="source lang-java linenums">package com.pkb.fhirwall.service.auth;

import com.osohq.oso.Exceptions.OsoException;
import com.osohq.oso.Expression;
import com.osohq.oso.Oso;
import com.osohq.oso.Predicate;
import com.osohq.oso.TypeConstraint;
import com.osohq.oso.Variable;
import org.slf4j.Logger;

import java.util.HashMap;
import java.util.List;

import static com.pkb.fhirwall.service.auth.AuthzResult.AuthzDecision.ALLOWED_WITH_RESTRICTION;
import static com.pkb.fhirwall.service.auth.AuthzResult.AuthzDecision.NOT_ALLOWED;
import static java.lang.invoke.MethodHandles.lookup;
import static java.util.stream.Collectors.toList;
import static org.slf4j.LoggerFactory.getLogger;

/**
 * It executes the authorization rules
 */
public class AuthorizationService {

<span class="fc" id="L25">    private static final Logger LOG = getLogger(lookup().lookupClass());</span>
<span class="fc" id="L26">    private static final Predicate ALLOW_SEARCH = new Predicate(&quot;allow&quot;,</span>
<span class="fc" id="L27">            List.of(new Variable(&quot;subject&quot;), &quot;read&quot;, new Variable(&quot;resource&quot;)));</span>

    private final AuthzFilterMapper authzFilterMapper;
    private final Oso oso;

<span class="fc" id="L32">    public AuthorizationService(AuthzFilterMapper authzFilterMapper, Oso oso) {</span>
<span class="fc" id="L33">        this.authzFilterMapper = authzFilterMapper;</span>
<span class="fc" id="L34">        this.oso = oso;</span>
<span class="fc" id="L35">    }</span>

    public AuthzResult authorize(SearchPolicyInformation authzData) {
        try {
<span class="fc" id="L39">            var bindings = new HashMap&lt;String, Object&gt;();</span>
<span class="fc" id="L40">            bindings.put(&quot;subject&quot;, authzData.subject());</span>
<span class="fc" id="L41">            bindings.put(&quot;object&quot;, new TypeConstraint(new Variable(&quot;object&quot;), authzData.object().toString()));</span>

<span class="fc" id="L43">            var results = oso.query(ALLOW_SEARCH, bindings, true).results();</span>

<span class="pc bpc" id="L45" title="1 of 2 branches missed.">            if (results.isEmpty()) {</span>
<span class="nc" id="L46">                return unauthorized();</span>
            }

<span class="fc" id="L49">            var constraints = results.stream()</span>
<span class="fc" id="L50">                    .flatMap(map -&gt; map.values().stream())</span>
<span class="fc" id="L51">                    .filter(value -&gt; value instanceof Expression)</span>
<span class="fc" id="L52">                    .map(expression -&gt; (Expression) expression)</span>
<span class="fc" id="L53">                    .collect(toList());</span>

<span class="fc" id="L55">            return ImmutableAuthzResult.builder()</span>
<span class="fc" id="L56">                    .decision(ALLOWED_WITH_RESTRICTION)</span>
<span class="fc" id="L57">                    .filters(authzFilterMapper.toFilters(constraints))</span>
<span class="fc" id="L58">                    .build();</span>
<span class="nc" id="L59">        } catch (OsoException exception) {</span>
<span class="nc" id="L60">            LOG.error(&quot;Exception while executing authorization rules: {}&quot;, exception.getMessage());</span>
        }

<span class="nc" id="L63">        return unauthorized();</span>
    }

    private AuthzResult unauthorized() {
<span class="nc" id="L67">        return ImmutableAuthzResult.builder()</span>
<span class="nc" id="L68">                .decision(NOT_ALLOWED)</span>
<span class="nc" id="L69">                .build();</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>