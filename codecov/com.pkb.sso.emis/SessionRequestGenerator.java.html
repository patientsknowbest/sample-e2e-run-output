<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SessionRequestGenerator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.sso.emis</a> &gt; <span class="el_source">SessionRequestGenerator.java</span></div><h1>SessionRequestGenerator.java</h1><pre class="source lang-java linenums">package com.pkb.sso.emis;

import com.pkb.common.datetime.DateTimeService;
import com.pkb.crypto.SSOCryptoHelper;
import com.pkb.datamodel.Email;
import com.pkb.entities.enums.ValidNationalId;
import com.pkb.user.entity.PKBPerson;
import org.apache.commons.lang3.NotImplementedException;
import org.jetbrains.annotations.NotNull;
import uk.co.e_mis.integration.portalsdk.entities.CtAddress;
import uk.co.e_mis.integration.portalsdk.entities.CtPersonName;
import uk.co.e_mis.integration.portalsdk.entities.ObjectFactory;
import uk.co.e_mis.integration.portalsdk.entities.SessionRequest;
import uk.co.e_mis.integration.portalsdk.entities.VocAddressUse;
import uk.co.e_mis.integration.portalsdk.entities.VocOrganisationIdentifierType;
import uk.co.e_mis.integration.portalsdk.entities.VocPatientIdentifierType;
import uk.co.e_mis.integration.portalsdk.entities.VocTelecomUse;

import javax.xml.bind.DatatypeConverter;
import javax.xml.datatype.DatatypeConfigurationException;
import javax.xml.datatype.DatatypeFactory;
import javax.xml.datatype.XMLGregorianCalendar;
import java.time.ZoneId;
import java.time.ZonedDateTime;
import java.util.GregorianCalendar;
import java.util.UUID;

/**
 * Utility of this class is in mocking EMIS client to manually test SSO flow on UAT
 * &lt;p&gt;
 * The only useful bits in SessionRequest will be patient NHSNumber &amp; ExternalCredentials containing the hash
 * Rest of the XML will have pretty much hard-coded contents through defined constants
 */
public class SessionRequestGenerator {

    public static final String PATIENT_DOB_STRING = &quot;1935-08-31&quot;;

<span class="fc" id="L38">    private final static byte[] SALT = DatatypeConverter.parseHexBinary(&quot;b8aa30d8f1d398883f0eeb5079777c42&quot;);</span>
    private static final String ORG_NAME = &quot;Partner Programme Test 17&quot;;
    private static final String HOUSE_FLAT_NUMBER = &quot;Fulford Grange, Micklefield Lane&quot;;
    private static final String PORTAL_ID = &quot;2605AD13-D5A5-4EB8-B071-27F261ADAADD&quot;;
    private static final String VIEW_ID = &quot;00000000-0000-0000-0000-000000000000&quot;;
    private static final String VERSION = &quot;V1.0.0.0&quot;;
    private static final int EMIS_USER_ID = 2533;
    private static final String EMIS_USER_IN_ROLE_GUID = &quot;18719e34-4389-427d-b1d0-5781f97a5a09&quot;;
    private static final String APPLICATION_DISPLAY_NAME = &quot;TESTTWO, PKB (Mr)&quot;;
    private static final String APPLICATION_USER_NAME = &quot;PKB2&quot;;
    private static final String EMIS_CDB_VALUE = &quot;28963&quot;;
    private static final String EMIS_ODS_VALUE = &quot;A00005&quot;;
    private static final String ORG_STREET = &quot;Rawdon&quot;;
    private static final String TOWN = &quot;Leeds&quot;;
    private static final String COUNTY = &quot;Yorkshire&quot;;
    private static final String POST_CODE = &quot;LS19 6BA&quot;;
    private static final String WORK_PHONE_NUMBER = &quot;01133800000&quot;;
    private static final String FAX_NUMBER = &quot;0113380002&quot;;
    private static final String ORG_EMAIL = &quot;master@practice.one&quot;;
    private static final String APPLICATION_NAME = &quot;EmisWeb&quot;;
    private static final String APPLICATION_VERSION = &quot;7.1.1.0000&quot;;
    private static final String PATIENT_TOWN = &quot;Clough Foot&quot;;
    private static final int PATIENT_DOB_YEAR = 1935;
    private static final int PATIENT_DOB_MONTH = 10;
    private static final int PATIENT_DOB_DAY = 1;

    private ObjectFactory objectFactory;
    private final DateTimeService dateTimeService;
    private SSOCryptoHelper ssoCryptoHelper;

<span class="fc" id="L68">    public SessionRequestGenerator(@NotNull DateTimeService dateTimeService, @NotNull SSOCryptoHelper ssoCryptoHelper) {</span>
<span class="fc" id="L69">        this.ssoCryptoHelper = ssoCryptoHelper;</span>
<span class="fc" id="L70">        objectFactory = new ObjectFactory();</span>
<span class="fc" id="L71">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L72">    }</span>

    @NotNull
    public SessionRequest generate(PKBPerson testProfessional, PKBPerson testPatient,
                                   String ssoUserName, String ssoPassword, ValidNationalId patientNationalId)
            throws DatatypeConfigurationException {
<span class="fc" id="L78">        SessionRequest sessionRequest = new SessionRequest();</span>
<span class="fc" id="L79">        XMLGregorianCalendar xmlGregorianCalendar = DatatypeFactory.newInstance().newXMLGregorianCalendar(GregorianCalendar.from(dateTimeService.nowZonedDateTime()));</span>
<span class="fc" id="L80">        sessionRequest.setRequestTime(xmlGregorianCalendar);</span>
<span class="fc" id="L81">        sessionRequest.setRequestId(UUID.randomUUID().toString());</span>
<span class="fc" id="L82">        sessionRequest.setPortalId(PORTAL_ID);</span>
<span class="fc" id="L83">        sessionRequest.setViewId(VIEW_ID);</span>
<span class="fc" id="L84">        sessionRequest.setVersion(VERSION);</span>

<span class="fc" id="L86">        SessionRequest.Provenance provenance = generateProvenance(testProfessional, ssoUserName, ssoPassword);</span>
<span class="fc" id="L87">        sessionRequest.setProvenance(provenance);</span>

<span class="fc" id="L89">        SessionRequest.Patient patient = generatePatient(testPatient, patientNationalId);</span>
<span class="fc" id="L90">        sessionRequest.setPatient(patient);</span>

<span class="fc" id="L92">        return sessionRequest;</span>
    }

    @NotNull
    private SessionRequest.Provenance generateProvenance(PKBPerson testProfessional, String ssoUserName,
                                                         String ssoPassword) {
<span class="fc" id="L98">        SessionRequest.Provenance provenance = new SessionRequest.Provenance();</span>
        //User provenance
<span class="fc" id="L100">        SessionRequest.Provenance.User user = generateProfessionalDetails(testProfessional);</span>

        // External credentials
<span class="fc" id="L103">        SessionRequest.Provenance.User.ExternalCredentials externalCredentials = generateExternalCredentials(ssoUserName, ssoPassword);</span>
<span class="fc" id="L104">        user.setExternalCredentials(externalCredentials);</span>

        // Application display
<span class="fc" id="L107">        user.setApplicationDisplayName(APPLICATION_DISPLAY_NAME);</span>
<span class="fc" id="L108">        user.setApplicationUserName(APPLICATION_USER_NAME);</span>
<span class="fc" id="L109">        provenance.setUser(user);</span>

        // Application provenance
<span class="fc" id="L112">        SessionRequest.Provenance.Application application = new SessionRequest.Provenance.Application();</span>
<span class="fc" id="L113">        application.setName(APPLICATION_NAME);</span>
<span class="fc" id="L114">        application.setVersion(APPLICATION_VERSION);</span>
<span class="fc" id="L115">        provenance.setApplication(application);</span>

        // Organisation details
<span class="fc" id="L118">        SessionRequest.Provenance.Organisation organisation = new SessionRequest.Provenance.Organisation();</span>
<span class="fc" id="L119">        SessionRequest.Provenance.Organisation.Identifier orgIdentifier1 = new SessionRequest.Provenance.Organisation.Identifier();</span>
<span class="fc" id="L120">        orgIdentifier1.setType(VocOrganisationIdentifierType.EMIS_CDB);</span>
<span class="fc" id="L121">        orgIdentifier1.setValue(EMIS_CDB_VALUE);</span>

        // Organisation provenance
<span class="fc" id="L124">        SessionRequest.Provenance.Organisation.Identifier orgIdentifier2 = new SessionRequest.Provenance.Organisation.Identifier();</span>
<span class="fc" id="L125">        orgIdentifier2.setType(VocOrganisationIdentifierType.ODS);</span>
<span class="fc" id="L126">        orgIdentifier2.setValue(EMIS_ODS_VALUE);</span>

<span class="fc" id="L128">        organisation.getIdentifier().add(0, orgIdentifier1);</span>
<span class="fc" id="L129">        organisation.getIdentifier().add(1, orgIdentifier2);</span>
<span class="fc" id="L130">        organisation.setName(ORG_NAME);</span>

        // Organisation address &amp; telecom
<span class="fc" id="L133">        CtAddress orgAddress = generateOrgAddress(organisation);</span>
<span class="fc" id="L134">        organisation.getAddress().add(orgAddress);</span>
<span class="fc" id="L135">        addOrgTelecom(organisation);</span>

<span class="fc" id="L137">        provenance.setOrganisation(organisation);</span>
<span class="fc" id="L138">        return provenance;</span>
    }

    @NotNull
    private SessionRequest.Provenance.User.ExternalCredentials generateExternalCredentials(String ssoUserName, String ssoPassword) {
<span class="fc" id="L143">        SessionRequest.Provenance.User.ExternalCredentials externalCredentials = new SessionRequest.Provenance.User.ExternalCredentials();</span>
<span class="fc" id="L144">        externalCredentials.setUsername(ssoUserName.trim());</span>
<span class="fc" id="L145">        SessionRequest.Provenance.User.ExternalCredentials.Password password = new SessionRequest.Provenance.User.ExternalCredentials.Password();</span>
<span class="fc" id="L146">        String hash = ssoCryptoHelper.generateEMISHashWithSuppliedSalt(ssoPassword, SALT)</span>
<span class="pc" id="L147">                .orElseThrow(() -&gt; new IllegalStateException(&quot;Failed to generate EMIS hash&quot;));</span>
<span class="fc" id="L148">        password.setValue(hash);</span>
<span class="fc" id="L149">        externalCredentials.setPassword(password);</span>
<span class="fc" id="L150">        return externalCredentials;</span>
    }

    @NotNull
    private SessionRequest.Patient generatePatient(PKBPerson testPatient, ValidNationalId patientNationalId)
            throws DatatypeConfigurationException {
<span class="fc" id="L156">        SessionRequest.Patient patient = new SessionRequest.Patient();</span>
<span class="fc" id="L157">        CtPersonName patientPersonName = new CtPersonName();</span>
<span class="fc" id="L158">        patientPersonName.setTitle(testPatient.getTitle());</span>
<span class="fc" id="L159">        patientPersonName.setFamilyName(testPatient.getLastName());</span>
<span class="fc" id="L160">        patientPersonName.setPreferredName(testPatient.getFirstName());</span>
<span class="fc" id="L161">        patient.setPersonName(patientPersonName);</span>

        // Patient Identifier
<span class="fc" id="L164">        SessionRequest.Patient.Identifier patientIdentifier = new SessionRequest.Patient.Identifier();</span>
<span class="fc" id="L165">        patientIdentifier.setType(getEmisNationalIdType(patientNationalId));</span>
<span class="fc" id="L166">        patientIdentifier.setValue(patientNationalId.getValue());</span>
<span class="fc" id="L167">        patient.getIdentifier().add(patientIdentifier);</span>

        // Patient DoB
<span class="fc" id="L170">        ZonedDateTime dob = ZonedDateTime.of(PATIENT_DOB_YEAR, PATIENT_DOB_MONTH, PATIENT_DOB_DAY, 0, 0, 0, 0, ZoneId.of(&quot;UTC&quot;));</span>
<span class="fc" id="L171">        XMLGregorianCalendar patientBirthDate = DatatypeFactory.newInstance().newXMLGregorianCalendar(GregorianCalendar.from(dob));</span>
<span class="fc" id="L172">        patient.setBirthDate(patientBirthDate);</span>

        // Patient address
<span class="fc" id="L175">        CtAddress patientAddress = generatePatientAddress(testPatient);</span>
<span class="fc" id="L176">        patient.getAddress().add(patientAddress);</span>

        // Patient telecom
<span class="fc" id="L179">        addPatientTelecom(testPatient, patient);</span>
<span class="fc" id="L180">        return patient;</span>
    }

    private void addOrgTelecom(SessionRequest.Provenance.Organisation organisation) {
<span class="fc" id="L184">        SessionRequest.Provenance.Organisation.Telecom telecom1 = new SessionRequest.Provenance.Organisation.Telecom();</span>
<span class="fc" id="L185">        telecom1.setUse(VocTelecomUse.WORK_PHONE);</span>
<span class="fc" id="L186">        telecom1.setValue(WORK_PHONE_NUMBER);</span>
<span class="fc" id="L187">        organisation.getTelecom().add(telecom1);</span>

        // Organisation telecom
<span class="fc" id="L190">        SessionRequest.Provenance.Organisation.Telecom telecom2 = new SessionRequest.Provenance.Organisation.Telecom();</span>
<span class="fc" id="L191">        telecom2.setUse(VocTelecomUse.FAX);</span>
<span class="fc" id="L192">        telecom2.setValue(FAX_NUMBER);</span>
<span class="fc" id="L193">        organisation.getTelecom().add(telecom2);</span>

<span class="fc" id="L195">        SessionRequest.Provenance.Organisation.Telecom telecom3 = new SessionRequest.Provenance.Organisation.Telecom();</span>
<span class="fc" id="L196">        telecom3.setUse(VocTelecomUse.EMAIL);</span>
<span class="fc" id="L197">        telecom3.setValue(ORG_EMAIL);</span>
<span class="fc" id="L198">        organisation.getTelecom().add(telecom3);</span>
<span class="fc" id="L199">    }</span>

    private void addPatientTelecom(@NotNull PKBPerson testPatient, @NotNull SessionRequest.Patient patient) {
<span class="fc" id="L202">        SessionRequest.Patient.Telecom patientTelecom1 = new SessionRequest.Patient.Telecom();</span>
<span class="fc" id="L203">        patientTelecom1.setUse(VocTelecomUse.HOME_PHONE);</span>
<span class="fc" id="L204">        patientTelecom1.setValue(testPatient.getPhone());</span>
<span class="fc" id="L205">        patient.getTelecom().add(patientTelecom1);</span>

<span class="fc" id="L207">        SessionRequest.Patient.Telecom patientTelecom2 = new SessionRequest.Patient.Telecom();</span>
<span class="fc" id="L208">        patientTelecom2.setUse(VocTelecomUse.EMAIL);</span>
<span class="fc" id="L209">        patientTelecom2</span>
<span class="fc" id="L210">                .setValue(testPatient.getContacts().stream()</span>
<span class="fc" id="L211">                        .flatMap(personContact -&gt; personContact.getContactIfPrimaryEmail().map(Email::address).toJavaStream())</span>
<span class="fc" id="L212">                        .findFirst().orElse(&quot;&quot;));</span>
<span class="fc" id="L213">        patient.getTelecom().add(patientTelecom2);</span>

<span class="fc" id="L215">        SessionRequest.Patient.Telecom patientTelecom3 = new SessionRequest.Patient.Telecom();</span>
<span class="fc" id="L216">        patientTelecom3.setUse(VocTelecomUse.MOBILE_PHONE);</span>
<span class="fc" id="L217">        patientTelecom3.setValue(&quot;&quot;);</span>
<span class="fc" id="L218">        patient.getTelecom().add(patientTelecom3);</span>

<span class="fc" id="L220">        SessionRequest.Patient.Telecom patientTelecom4 = new SessionRequest.Patient.Telecom();</span>
<span class="fc" id="L221">        patientTelecom4.setUse(VocTelecomUse.WORK_PHONE);</span>
<span class="fc" id="L222">        patientTelecom4.setValue(&quot;&quot;);</span>
<span class="fc" id="L223">        patient.getTelecom().add(patientTelecom4);</span>
<span class="fc" id="L224">    }</span>

    @NotNull
    private CtAddress generatePatientAddress(@NotNull PKBPerson testPatient) {
<span class="fc" id="L228">        CtAddress patientAddress = objectFactory.createCtAddress();</span>
<span class="fc" id="L229">        patientAddress.setUse(VocAddressUse.HOME);</span>
<span class="fc" id="L230">        patientAddress.getContent().add(objectFactory.createCtAddressHouseNameFlatNumber(testPatient.getAddress1()));</span>
<span class="fc" id="L231">        patientAddress.getContent().add(objectFactory.createCtAddressStreet(testPatient.getAddress2()));</span>
<span class="fc" id="L232">        patientAddress.getContent().add(objectFactory.createCtAddressTown(PATIENT_TOWN));</span>
<span class="fc" id="L233">        patientAddress.getContent().add(objectFactory.createCtAddressPostCode(testPatient.getPostalCode()));</span>
<span class="fc" id="L234">        return patientAddress;</span>
    }

    @NotNull
    private CtAddress generateOrgAddress(
            SessionRequest.Provenance.Organisation organisation) {
<span class="fc" id="L240">        CtAddress ctAddress1 = objectFactory.createCtAddress();</span>
<span class="fc" id="L241">        ctAddress1.setUse(VocAddressUse.WORK);</span>
<span class="fc" id="L242">        ctAddress1.getContent().add(objectFactory.createCtAddressHouseNameFlatNumber(HOUSE_FLAT_NUMBER));</span>
<span class="fc" id="L243">        ctAddress1.getContent().add(objectFactory.createCtAddressStreet(ORG_STREET));</span>
<span class="fc" id="L244">        ctAddress1.getContent().add(objectFactory.createCtAddressTown(TOWN));</span>
<span class="fc" id="L245">        ctAddress1.getContent().add(objectFactory.createCtAddressCounty(COUNTY));</span>
<span class="fc" id="L246">        ctAddress1.getContent().add(objectFactory.createCtAddressPostCode(POST_CODE));</span>
<span class="fc" id="L247">        return ctAddress1;</span>
    }

    @NotNull
    private SessionRequest.Provenance.User generateProfessionalDetails(PKBPerson testProfessional) {
<span class="fc" id="L252">        SessionRequest.Provenance.User user = new SessionRequest.Provenance.User();</span>
<span class="fc" id="L253">        user.setEmisUserId(EMIS_USER_ID);</span>
<span class="fc" id="L254">        user.setEmisUserInRoleGuid(EMIS_USER_IN_ROLE_GUID);</span>
<span class="fc" id="L255">        CtPersonName personName = new CtPersonName();</span>
<span class="fc" id="L256">        personName.setTitle(testProfessional.getTitle());</span>
<span class="fc" id="L257">        personName.setFamilyName(testProfessional.getLastName());</span>
<span class="fc" id="L258">        personName.getGivenName().add(testProfessional.getFirstName());</span>
<span class="fc" id="L259">        user.setPersonName(personName);</span>
<span class="fc" id="L260">        return user;</span>
    }

    private VocPatientIdentifierType getEmisNationalIdType(ValidNationalId nationalId) {
<span class="pc bpc" id="L264" title="2 of 3 branches missed.">        switch (nationalId.nationalIdType()) {</span>
            case NHS_NUMBER:
<span class="fc" id="L266">                return VocPatientIdentifierType.NHS;</span>
            case CHI_NUMBER:
<span class="nc" id="L268">                return VocPatientIdentifierType.CHI;</span>
            default:
<span class="nc" id="L270">                throw new NotImplementedException(&quot;Support for national ID type &quot; + nationalId.nationalIdType() + &quot; not implemented yet / updated EMIS sdk not pulled in!&quot;);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>