<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EMISSessionRequestValidator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.sso.emis</a> &gt; <span class="el_source">EMISSessionRequestValidator.java</span></div><h1>EMISSessionRequestValidator.java</h1><pre class="source lang-java linenums">package com.pkb.sso.emis;

import com.pkb.entities.enums.NationalIdType;
import uk.co.e_mis.integration.portalsdk.entities.CtPersonName;
import uk.co.e_mis.integration.portalsdk.entities.SessionRequest;
import uk.co.e_mis.integration.portalsdk.entities.SessionRequest.Patient.Identifier;
import uk.co.e_mis.integration.portalsdk.entities.SessionRequest.Provenance.Application;
import uk.co.e_mis.integration.portalsdk.entities.SessionRequest.Provenance.Organisation;
import uk.co.e_mis.integration.portalsdk.entities.SessionRequest.Provenance.User;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.function.Predicate;
import java.util.stream.Collectors;
import java.util.stream.Stream;

import static java.util.Collections.singletonList;
import static org.apache.commons.lang3.StringUtils.isBlank;

/**
 * Validate the presence of vital information like : - requestId - Patient NHS
 * Number - PKB Portal Id - External Credentials (PKB SSO credentials) -
 * Provenance (User , Org , Application)
 * 
 * @author pravina
 *
 */
<span class="fc" id="L29">public class EMISSessionRequestValidator {</span>

    private static final String ID_TYPE_NHS = &quot;Nhs&quot;;
    private static final String ID_TYPE_CHI = &quot;Chi&quot;;

<span class="nc" id="L34">    public enum SessionRequestErrorCode {</span>

<span class="nc" id="L36">        MISSING_REQUEST_ID(&quot;ssoEMISError.err.missing_request_id&quot;),</span>
<span class="nc" id="L37">        MISSING_PORTAL_ID(&quot;ssoEMISError.err.missing_portal_id&quot;),</span>
<span class="nc" id="L38">        MISSING_PATIENT_ID(&quot;ssoEMISError.err.missing_patient_id&quot;),</span>
<span class="nc" id="L39">        MULTIPLE_PATIENT_IDS(&quot;ssoEMISError.err.multiple_patient_ids&quot;),</span>
<span class="nc" id="L40">        MISSING_NHS_NUMBER(&quot;ssoEMISError.err.missing_patient_nhs_number&quot;),</span>
<span class="nc" id="L41">        INVALID_NHS_NUMBER(&quot;ssoEMISError.err.invalid_patient_nhs_number&quot;),</span>
<span class="nc" id="L42">        MISSING_CHI_NUMBER(&quot;ssoEMISError.err.missing_patient_chi_number&quot;),</span>
<span class="nc" id="L43">        INVALID_CHI_NUMBER(&quot;ssoEMISError.err.invalid_patient_chi_number&quot;),</span>
<span class="nc" id="L44">        UNSUPPORTED_PATIENT_ID_TYPE(&quot;ssoEMISError.err.unsupported_patient_id_type&quot;),</span>
<span class="nc" id="L45">        MISSING_APP_PROVENANCE(&quot;ssoEMISError.err.missing_application_provenance&quot;),</span>
<span class="nc" id="L46">        MISSING_APP_NAME(&quot;ssoEMISError.err.missing_application_name&quot;),</span>
<span class="nc" id="L47">        MISSING_APP_VERSION(&quot;ssoEMISError.err.missing_application_version&quot;),</span>
<span class="nc" id="L48">        MISSING_ORG_PROVENANCE(&quot;ssoEMISError.err.missing_org_provenance&quot;),</span>
<span class="nc" id="L49">        MISSING_ORG_NAME(&quot;ssoEMISError.err.missing_org_name&quot;),</span>
<span class="nc" id="L50">        MISSING_ORG_IDS(&quot;ssoEMISError.err.missing_org_identifiers&quot;),</span>
<span class="nc" id="L51">        MISSING_USER_PROVENANCE(&quot;ssoEMISError.err.missing_user_provenance&quot;),</span>
<span class="nc" id="L52">        MISSING_USER_EXT_CREDS(&quot;ssoEMISError.err.missing_user_external_credentials&quot;),</span>
<span class="nc" id="L53">        MISSING_APP_DISPLAY_NAME(&quot;ssoEMISError.err.missing_application_display_name&quot;),</span>
<span class="nc" id="L54">        MISSING_PERSON_NAME(&quot;ssoEMISError.err.missing_person_name&quot;);</span>

        private final String i18nCode;

<span class="nc" id="L58">        SessionRequestErrorCode(String i18nCode) {</span>
<span class="nc" id="L59">            this.i18nCode = i18nCode;</span>
<span class="nc" id="L60">        }</span>

        public String getI18nCode() {
<span class="nc" id="L63">            return i18nCode;</span>
        }

    }

    public List&lt;SessionRequestErrorCode&gt; validate(SessionRequest emisSessionRequest) {
<span class="fc" id="L69">        List&lt;SessionRequestErrorCode&gt; errorMessages = new ArrayList&lt;&gt;();</span>

        // check for request id
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">        if (isBlank(emisSessionRequest.getRequestId())) {</span>
<span class="nc" id="L73">            errorMessages.add(SessionRequestErrorCode.MISSING_REQUEST_ID);</span>
        }

        // check for portal id
<span class="fc" id="L77">        String portalId = emisSessionRequest.getPortalId();</span>
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">        if (isBlank(portalId)) {</span>
<span class="nc" id="L79">            errorMessages.add(SessionRequestErrorCode.MISSING_PORTAL_ID);</span>
        }

<span class="fc" id="L82">        errorMessages.addAll(validatePatientIdentifier(emisSessionRequest));</span>

        // check for presence of Application, Org &amp; User provenance
<span class="fc" id="L85">        errorMessages.addAll(validateApplicationProvenance(emisSessionRequest.getProvenance().getApplication()));</span>
<span class="fc" id="L86">        errorMessages.addAll(validateOrgProvenance(emisSessionRequest.getProvenance().getOrganisation()));</span>
<span class="fc" id="L87">        errorMessages.addAll(validateUserProvenance(emisSessionRequest.getProvenance().getUser()));</span>

<span class="fc" id="L89">        return errorMessages;</span>
    }

    private List&lt;SessionRequestErrorCode&gt; validatePatientIdentifier(SessionRequest emisSessionRequest) {
<span class="fc" id="L93">        List&lt;SessionRequestErrorCode&gt; errorMessages = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L95">        List&lt;Identifier&gt; identifiers = emisSessionRequest.getPatient().getIdentifier();</span>
<span class="pc bpc" id="L96" title="2 of 4 branches missed.">        if (identifiers == null || identifiers.isEmpty()) {</span>
<span class="nc" id="L97">            errorMessages.add(SessionRequestErrorCode.MISSING_PATIENT_ID);</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">        } else if (identifiers.size() &gt; 1) {// only 1 patient id allowed</span>
<span class="nc" id="L99">            errorMessages.add(SessionRequestErrorCode.MULTIPLE_PATIENT_IDS);</span>
        } else {
<span class="fc" id="L101">            Identifier identifier = identifiers.get(0);</span>

            // validate patient NHS number (CHI number is not be considered atleast for first iteration)
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">            if (identifier.getType().value().equals(ID_TYPE_NHS)) {</span>
<span class="fc" id="L105">                errorMessages.addAll(validateNHSNumber(identifier));</span>
            } else {
<span class="nc" id="L107">                errorMessages.add(SessionRequestErrorCode.UNSUPPORTED_PATIENT_ID_TYPE);</span>
            }
        }
<span class="fc" id="L110">        return errorMessages;</span>
    }

    private List&lt;SessionRequestErrorCode&gt; validateNHSNumber(Identifier identifier) {
<span class="pc bpc" id="L114" title="1 of 2 branches missed.">        if (isBlank(identifier.getValue())) {</span>
<span class="nc" id="L115">            return singletonList(SessionRequestErrorCode.MISSING_NHS_NUMBER);</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        } else if (NationalIdType.NHS_NUMBER.getValidNationalIdAndType(identifier.getValue()).isEmpty()) {</span>
<span class="nc" id="L117">            return singletonList(SessionRequestErrorCode.INVALID_NHS_NUMBER);</span>
        }
<span class="fc" id="L119">        return Collections.emptyList();</span>
    }

    private List&lt;SessionRequestErrorCode&gt; validateApplicationProvenance(Application application) {
<span class="fc" id="L123">        List&lt;SessionRequestErrorCode&gt; errorMessages = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">        if (application == null) {</span>
<span class="nc" id="L125">            errorMessages.add(SessionRequestErrorCode.MISSING_APP_PROVENANCE);</span>
        } else {
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">            if (isBlank(application.getName())) {</span>
<span class="nc" id="L128">                errorMessages.add(SessionRequestErrorCode.MISSING_APP_NAME);</span>
            }

<span class="pc bpc" id="L131" title="1 of 2 branches missed.">            if (isBlank(application.getVersion())) {</span>
<span class="nc" id="L132">                errorMessages.add(SessionRequestErrorCode.MISSING_APP_VERSION);</span>
            }
        }

<span class="fc" id="L136">        return errorMessages;</span>
    }

    private List&lt;SessionRequestErrorCode&gt; validateOrgProvenance(Organisation organisation) {
<span class="fc" id="L140">        List&lt;SessionRequestErrorCode&gt; errorMessages = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">        if (organisation == null) {</span>
<span class="nc" id="L142">            errorMessages.add(SessionRequestErrorCode.MISSING_ORG_PROVENANCE);</span>
        } else {
<span class="pc bpc" id="L144" title="1 of 2 branches missed.">            if (isBlank(organisation.getName())) {</span>
<span class="nc" id="L145">                errorMessages.add(SessionRequestErrorCode.MISSING_ORG_NAME);</span>
            }

<span class="pc bpc" id="L148" title="2 of 4 branches missed.">            if (organisation.getIdentifier() == null || organisation.getIdentifier().isEmpty()) {</span>
<span class="nc" id="L149">                errorMessages.add(SessionRequestErrorCode.MISSING_ORG_IDS);</span>
            } else {
<span class="fc" id="L151">                String orgIds = organisation.getIdentifier().stream().map(Organisation.Identifier::getValue)</span>
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">                        .filter(s -&gt; !isBlank(s))</span>
<span class="fc" id="L153">                        .collect(Collectors.joining());</span>
<span class="pc bpc" id="L154" title="1 of 2 branches missed.">                if (isBlank(orgIds)) {</span>
<span class="nc" id="L155">                    errorMessages.add(SessionRequestErrorCode.MISSING_ORG_IDS);</span>
                }
            }
        }
<span class="fc" id="L159">        return errorMessages;</span>
    }

    private List&lt;SessionRequestErrorCode&gt; validateUserProvenance(User user) {
<span class="fc" id="L163">        List&lt;SessionRequestErrorCode&gt; errorMessages = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L164" title="1 of 2 branches missed.">        if (user == null) {</span>
<span class="nc" id="L165">            errorMessages.add(SessionRequestErrorCode.MISSING_USER_PROVENANCE);</span>
        } else {
<span class="pc bpc" id="L167" title="1 of 2 branches missed.">            if (user.getExternalCredentials() == null) {</span>
<span class="nc" id="L168">                errorMessages.add(SessionRequestErrorCode.MISSING_USER_EXT_CREDS);</span>
            } else {
<span class="pc bpc" id="L170" title="1 of 2 branches missed.">                if (isBlank(user.getExternalCredentials().getUsername())</span>
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">                        || isBlank(user.getExternalCredentials().getPassword().getValue())) {</span>
<span class="nc" id="L172">                    errorMessages.add(SessionRequestErrorCode.MISSING_USER_EXT_CREDS);</span>
                }
            }

<span class="pc bpc" id="L176" title="1 of 2 branches missed.">            if (isBlank((String) user.getApplicationDisplayName())) {</span>
<span class="nc" id="L177">                errorMessages.add(SessionRequestErrorCode.MISSING_APP_DISPLAY_NAME);</span>
            }

<span class="fc" id="L180">            CtPersonName personName = user.getPersonName();</span>
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">            if (personName == null) {</span>
<span class="nc" id="L182">                errorMessages.add(SessionRequestErrorCode.MISSING_PERSON_NAME);</span>
            } else {
<span class="pc bpc" id="L184" title="2 of 4 branches missed.">                Predicate&lt;String&gt; isEmpty = s -&gt; s == null || isBlank(s.trim());</span>
<span class="fc" id="L185">                boolean givenNamesAreEmpty = personName.getGivenName().stream().allMatch(isEmpty);</span>
<span class="fc" id="L186">                boolean otherNamesAreEmpty = Stream.of(personName.getTitle(), personName.getFamilyName()).allMatch(isEmpty);</span>
<span class="pc bpc" id="L187" title="3 of 4 branches missed.">                if (givenNamesAreEmpty &amp;&amp; otherNamesAreEmpty) {</span>
<span class="nc" id="L188">                    errorMessages.add(SessionRequestErrorCode.MISSING_PERSON_NAME);</span>
                }
            }
        }
<span class="fc" id="L192">        return errorMessages;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>