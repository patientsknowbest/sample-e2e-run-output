<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PasswordResetService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.registration.reset</a> &gt; <span class="el_source">PasswordResetService.java</span></div><h1>PasswordResetService.java</h1><pre class="source lang-java linenums">package com.pkb.action.registration.reset;

import com.pkb.action.registration.reset.ResetStepFailure.InconsistentDB;
import com.pkb.action.registration.reset.ResetStepFailure.NotRegistered;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.datamodel.Email;
import com.pkb.service.passwordreset.PasswordResetEmailSender;
import com.pkb.service.team.TeamUserManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import io.vavr.API;
import io.vavr.Function1;
import io.vavr.collection.Map;
import io.vavr.control.Either;
import org.slf4j.Logger;

import java.security.MessageDigest;
import java.security.NoSuchAlgorithmException;
import java.time.Instant;
import java.util.Base64;

import static com.pkb.action.registration.reset.ImmutableUserVerificationSuccess.passwordResetSuccess;
import static com.pkb.action.registration.reset.ImmutableVerifiableBits.verifiableBits;
import static com.pkb.action.registration.reset.ResetStepFailure.alreadyResetByTeamMember;
import static com.pkb.action.registration.reset.ResetStepFailure.unexpectedError;
import static com.pkb.action.registration.reset.StartPasswordResetFailure.linkExpired;
import static com.pkb.action.registration.reset.StartPasswordResetFailure.resetCodeMismatch;
import static com.pkb.action.registration.reset.UserVerificationFailure.securityAnswerMismatch;
import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.Match;
import static io.vavr.API.unchecked;
import static io.vavr.Predicates.instanceOf;
import static io.vavr.control.Either.left;
import static io.vavr.control.Either.right;
import static java.lang.String.format;
import static java.lang.invoke.MethodHandles.lookup;
import static java.net.URLEncoder.encode;
import static java.nio.charset.StandardCharsets.UTF_8;
import static java.time.temporal.ChronoUnit.DAYS;
import static java.util.stream.Collectors.joining;
import static org.apache.commons.lang3.StringUtils.isNotBlank;
import static org.slf4j.LoggerFactory.getLogger;

public class PasswordResetService {
<span class="fc" id="L46">    private static final Logger LOGGER = getLogger(lookup().lookupClass());</span>

<span class="fc" id="L48">    private static final Function1&lt;String, String&gt; URL_ENCODER = unchecked(value -&gt; encode(value, UTF_8));</span>

    private static final long DEFAULT_ACCOUNT_CREATION = 87598L;
    private static final long DEFAULT_REGISTERED_ON = 897905L;
<span class="fc" id="L52">    private static final Void NOTHING = null;</span>

    private final PasswordResetEvents passwordResetEvents;
    private final CandidateFinderService candidateFinderService;
    private final UserManager userManager;
    private final TeamUserManager teamUserManager;
    private final DateTimeService dateTimeService;
    private final PasswordResetEmailSender emailSender;

    public PasswordResetService(
            PasswordResetEvents passwordResetEvents,
            CandidateFinderService candidateFinderService,
            UserManager userManager,
            TeamUserManager teamUserManager,
            DateTimeService dateTimeService,
<span class="fc" id="L67">            PasswordResetEmailSender emailSender) {</span>
<span class="fc" id="L68">        this.passwordResetEvents = passwordResetEvents;</span>
<span class="fc" id="L69">        this.candidateFinderService = candidateFinderService;</span>
<span class="fc" id="L70">        this.userManager = userManager;</span>
<span class="fc" id="L71">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L72">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L73">        this.emailSender = emailSender;</span>
<span class="fc" id="L74">    }</span>

    /**
     * Step one - part two (one was to ask user for email).
     */
    public void startPasswordReset(Email email) {
<span class="fc" id="L80">        var eventEmitter = passwordResetEvents.passwordResetStarted(email);</span>
<span class="fc" id="L81">        candidateFinderService.findRegisteredUser(email)</span>
<span class="fc" id="L82">                .peek(userByEmail -&gt; {</span>
<span class="fc" id="L83">                    Instant expiryDate = dateTimeService.now().plus(1, DAYS);</span>
<span class="fc" id="L84">                    String passwordResetLink = resetLink(email.address(), expiryDate, generateResetCode(email, expiryDate, userByEmail));</span>
<span class="fc" id="L85">                    emailSender.sendPasswordResetLinkTo(userByEmail, passwordResetLink);</span>
<span class="fc" id="L86">                    eventEmitter.handleSuccess(userByEmail);</span>
<span class="fc" id="L87">                })</span>
<span class="fc" id="L88">                .peekLeft(failure -&gt; {</span>
<span class="fc" id="L89">                    Match(failure).option(</span>
<span class="fc" id="L90">                            Case($(instanceOf(NotRegistered.class)), () -&gt; {</span>
                                // TODO (utamas): PHR-7143 send a mail saying that registration must first be completed
<span class="nc" id="L92">                                return NOTHING;</span>
                            }),
<span class="fc" id="L94">                            Case($(instanceOf(InconsistentDB.class)), inconsistentDB -&gt; {</span>
<span class="nc" id="L95">                                LOGGER.error(inconsistentDB.message());</span>
                                // TODO (utamas): PHR-7118 send a mail with instructions on how to contact L1 Support.
<span class="nc" id="L97">                                return NOTHING;</span>
                            }));
<span class="fc" id="L99">                    eventEmitter.handleFailure(failure);</span>
<span class="fc" id="L100">                });</span>
<span class="fc" id="L101">    }</span>

    /**
     * Step two - part one.
     */
    public Either&lt;ResetStepFailure, VerifiableBits&gt;  findVerificationCriteria(PasswordResetDetails details) {
<span class="fc" id="L107">        var handlers = passwordResetEvents.passwordResetLinkOpened(details.email());</span>
        // check expiry date and kick out early
<span class="fc bfc" id="L109" title="All 2 branches covered.">        if (details.expiryDate().isBefore(dateTimeService.now())) {</span>
<span class="fc" id="L110">            handlers.linkExpired();</span>
<span class="fc" id="L111">            return left(linkExpired());</span>
        }

<span class="fc" id="L114">        return candidateFinderService.findRegisteredUser(details.email())</span>
<span class="fc" id="L115">                .flatMap(userByEmail -&gt; {</span>
<span class="fc" id="L116">                    String resetCode = generateResetCode(details.email(), details.expiryDate(), userByEmail);</span>
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">                    if (!resetCode.equals(details.resetCode())) {</span>
<span class="nc" id="L118">                        return left(resetCodeMismatch());</span>
                    }

<span class="fc" id="L121">                    return verifyResetState(userByEmail)</span>
<span class="fc" id="L122">                            .map(question -&gt; (VerifiableBits) verifiableBits(</span>
                                    question,
<span class="fc bfc" id="L124" title="All 4 branches covered.">                                    userByEmail.isPatient() &amp;&amp; teamUserManager.isUnaffiliatedUser(userByEmail.getId()),</span>
<span class="fc" id="L125">                                    userByEmail.findDateOfBirth().isPresent(),</span>
<span class="fc" id="L126">                                    isNotBlank(userByEmail.getPostalCode())));</span>
                })
<span class="fc" id="L128">                .peekLeft(handlers::handleFailure)</span>
<span class="fc" id="L129">                .peek(handlers::handleSuccess);</span>
    }

    /**
     * Step two - part two.
     */
    public Either&lt;ResetStepFailure, UserVerificationSuccess&gt; verifyDetails(UserVerificationCriteria criteria) {
<span class="fc" id="L136">        var handlers = passwordResetEvents.verificationStarted(criteria);</span>
        try {
<span class="fc" id="L138">            return candidateFinderService.findRegisteredUserForVerification(criteria)</span>
<span class="fc" id="L139">                    .flatMap(candidate -&gt; verifySecurityQuestionAndResetState(candidate, criteria))</span>
<span class="fc" id="L140">                    .peek(handlers::handleSuccess)</span>
<span class="fc" id="L141">                    .peekLeft(handlers::handleFailure);</span>
<span class="nc" id="L142">        } catch (Exception cause) {</span>
<span class="nc" id="L143">            handlers.handlerUnexpectedFailure(cause);</span>
<span class="nc" id="L144">            return left(unexpectedError(&quot;Something unexpected happened&quot;, cause));</span>
        }
    }

    private String resetLink(String email, Instant expiryDate, String resetCode) {
<span class="fc" id="L149">        Map&lt;String, String&gt; parameters = API.LinkedMap(</span>
<span class="fc" id="L150">                &quot;emailId&quot;, URL_ENCODER.apply(email),</span>
<span class="fc" id="L151">                &quot;expiryDate&quot;, expiryDate.toString(),</span>
<span class="fc" id="L152">                &quot;resetCode&quot;, URL_ENCODER.apply(resetCode));</span>

<span class="fc" id="L154">        return parameters.toStream()</span>
<span class="fc" id="L155">                .map(keyValue -&gt; keyValue.apply((key, value) -&gt; format(&quot;resetPassObj.%s=%s&quot;, key, value)))</span>
<span class="fc" id="L156">                .collect(joining(&quot;&amp;&quot;, &quot;forgotPasswordVerifyEmail.action?&quot;, &quot;&quot;));</span>
    }

    private String generateResetCode(Email emailId, Instant expiryDate, PKBPerson person) {
<span class="pc bpc" id="L160" title="1 of 2 branches missed.">        long accountCreation = person.getAccountCreation() == null ? DEFAULT_ACCOUNT_CREATION : person.getAccountCreation().toInstant().toEpochMilli();</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">        long registeredOn = person.getRegisteredOn() == null ? DEFAULT_REGISTERED_ON : person.getRegisteredOn().toInstant().toEpochMilli();</span>
<span class="fc" id="L162">        String secret = emailId.address() + expiryDate + registeredOn + accountCreation;</span>
<span class="fc" id="L163">        return base64EncodedHash(secret);</span>
    }

    private String base64EncodedHash(String secret) {
        try {
<span class="fc" id="L168">            MessageDigest digest = MessageDigest.getInstance(&quot;SHA-256&quot;);</span>
<span class="fc" id="L169">            byte[] hash = digest.digest(secret.getBytes(UTF_8));</span>
<span class="fc" id="L170">            return Base64.getUrlEncoder().withoutPadding().encodeToString(hash);</span>
<span class="nc" id="L171">        } catch (NoSuchAlgorithmException cause) {</span>
<span class="nc" id="L172">            throw new RuntimeException(cause);</span>
        }
    }

    private Either&lt;ResetStepFailure, UserVerificationSuccess&gt; verifySecurityQuestionAndResetState(PKBPerson candidate, UserVerificationCriteria criteria) {
<span class="fc bfc" id="L177" title="All 2 branches covered.">        if (criteria.answer().isEmpty()) {</span>
<span class="fc" id="L178">            LOGGER.info(&quot;Skipping answer validation for sec question for unaffiliated patient user={}&quot;, candidate);</span>
<span class="fc" id="L179">            return right(passwordResetSuccess(candidate, criteria.question()));</span>
        }

<span class="pc bpc" id="L182" title="1 of 2 branches missed.">        if (!verifyAnswerForSecurityQuestion(candidate.getId(), criteria)) {</span>
<span class="nc" id="L183">            LOGGER.info(&quot;PHR-4507 - sec question validation failed for user={}, type={}, question={}&quot;, candidate, candidate.getUserType(), criteria.question());</span>
<span class="nc" id="L184">            return left(securityAnswerMismatch(candidate.getPublicId()));</span>
        }

<span class="fc" id="L187">        return verifyResetState(candidate)</span>
<span class="fc" id="L188">                .map(question -&gt; passwordResetSuccess(candidate, question));</span>
    }

    private Either&lt;ResetStepFailure, String&gt; verifyResetState(PKBPerson candidate) {
<span class="fc" id="L192">        String question = userManager.getSecurityQuestion(candidate.getId()).orElse(null);</span>
        // password has been reset by coordinator / clinician
<span class="pc bpc" id="L194" title="1 of 2 branches missed.">        if (checkPasswordWasAlreadyResetByTeamMember(question)) {</span>
<span class="nc" id="L195">            return left(alreadyResetByTeamMember(candidate.getPublicId()));</span>
        }

<span class="fc" id="L198">        return right(question);</span>
    }

    private boolean verifyAnswerForSecurityQuestion(long userId, UserVerificationCriteria criteria) {
<span class="fc" id="L202">        return criteria.answer()</span>
<span class="fc" id="L203">                .map(answer -&gt; userManager.verifySecurityQuestionAnswer(userId, criteria.question(), answer))</span>
<span class="fc" id="L204">                .orElse(false);</span>
    }

    private boolean checkPasswordWasAlreadyResetByTeamMember(String question) {
<span class="fc" id="L208">        return TeamUserManager.RESET_CREDENTIALS_SECURITY_QUESTION.equals(question);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>