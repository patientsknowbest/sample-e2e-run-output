<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PasswordResetEvents.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.action.registration.reset</a> &gt; <span class="el_source">PasswordResetEvents.java</span></div><h1>PasswordResetEvents.java</h1><pre class="source lang-java linenums">package com.pkb.action.registration.reset;

import com.google.common.annotations.VisibleForTesting;
import com.pkb.action.registration.reset.ResetStepFailure.AlreadyResetByTeamMember;
import com.pkb.action.registration.reset.ResetStepFailure.InconsistentDB;
import com.pkb.action.registration.reset.ResetStepFailure.NoUserByEmail;
import com.pkb.action.registration.reset.ResetStepFailure.NotRegistered;
import com.pkb.action.registration.reset.ResetStepFailure.TooManyInvalidDOBInputAttempts;
import com.pkb.action.registration.reset.ResetStepFailure.UnexpectedCompositeError;
import com.pkb.action.registration.reset.ResetStepFailure.UnexpectedError;
import com.pkb.action.registration.reset.StartPasswordResetFailure.ResetCodeMismatch;
import com.pkb.action.registration.reset.UserVerificationFailure.DemographicsMismatch;
import com.pkb.action.registration.reset.UserVerificationFailure.SecurityAnswerMismatch;
import com.pkb.action.registration.reset.demographicsvalidator.LenientDateOfBirthValidator;
import com.pkb.action.registration.reset.demographicsvalidator.LenientLastNameValidator;
import com.pkb.action.registration.reset.demographicsvalidator.LenientPostalCodeValidator;
import com.pkb.datamodel.Email;
import com.pkb.user.entity.PKBPerson;
import io.prometheus.client.Counter;
import io.vavr.collection.Map;
import org.slf4j.Logger;

import static io.vavr.API.$;
import static io.vavr.API.Case;
import static io.vavr.API.Map;
import static io.vavr.API.Match;
import static io.vavr.Predicates.instanceOf;
import static java.lang.Math.max;
import static java.lang.invoke.MethodHandles.lookup;
import static org.slf4j.LoggerFactory.getLogger;


<span class="fc" id="L33">public class PasswordResetEvents {</span>
<span class="fc" id="L34">    private static final Logger LOGGER = getLogger(lookup().lookupClass());</span>

    private static final String NOT_FOUND = &quot;notFound&quot;;
    private static final String NOT_REGISTERED = &quot;notRegistered&quot;;
    private static final String INCONSISTENT = &quot;inconsistent&quot;;
    private static final String TOO_MANY_FAILED_DOB_ATTEMPTS = &quot;tooManyFailedDobAttempts&quot;;
    private static final String UNEXPECTED_ERROR_COUNT = &quot;unexpectedErrorCount&quot;;

    @VisibleForTesting
<span class="fc" id="L43">    static final Counter PASSWORD_RESET_STATS = Counter.build()</span>
<span class="fc" id="L44">            .name(&quot;pkb_phr_web_pw_reset_stats&quot;)</span>
<span class="fc" id="L45">            .help(&quot;Non personalized stats&quot;)</span>
<span class="fc" id="L46">            .labelNames(&quot;step&quot;, &quot;property&quot;)</span>
<span class="fc" id="L47">            .register();</span>

    public StepOneEventHandler passwordResetStarted(Email email) {
<span class="fc" id="L50">        return new StepOneEventHandler();</span>
    }

    public StepTwoEventHandlers passwordResetLinkOpened(Email email) {
<span class="fc" id="L54">        return new StepTwoEventHandlers(email);</span>
    }

    public StepThreeEventHandler verificationStarted(UserVerificationCriteria criteria) {
<span class="fc" id="L58">        return new StepThreeEventHandler(criteria);</span>
    }

    public static class StepOneEventHandler {
        private static final String STEP = &quot;stepOne&quot;;

        private static final String PASSWORD_RESET_LINK_REQUESTED = &quot;passwordResetLinkRequested&quot;;
        private static final String PASSWORD_RESET_LINK_SENT = &quot;passwordResetLinkSent&quot;;

<span class="fc" id="L67">        private StepOneEventHandler() {</span>
<span class="fc" id="L68">            PASSWORD_RESET_STATS.labels(STEP, PASSWORD_RESET_LINK_REQUESTED).inc();</span>
<span class="fc" id="L69">        }</span>

        public void handleSuccess(PKBPerson user) {
<span class="fc" id="L72">            LOGGER.info(&quot;Password Reset link was sent to User=[{}]&quot;, user.getPublicId());</span>
<span class="fc" id="L73">            PASSWORD_RESET_STATS.labels(STEP, PASSWORD_RESET_LINK_SENT).inc();</span>
<span class="fc" id="L74">        }</span>

        public void handleFailure(ResetStepFailure failure) {
<span class="fc" id="L77">            Match(failure).of(</span>
<span class="fc" id="L78">                    noUserByEmail(STEP),</span>
<span class="fc" id="L79">                    notRegistered(STEP),</span>
                    // TODO (utamas) PHR-7119
<span class="fc" id="L81">                    inconsistentDatabase(STEP),</span>
<span class="fc" id="L82">                    unexpectedErrors(STEP),</span>
<span class="fc" id="L83">                    unexpectedError(STEP),</span>
<span class="fc" id="L84">                    defaultCase(STEP));</span>
<span class="fc" id="L85">        }</span>
    }

    public static class StepTwoEventHandlers {
        private static final String STEP = &quot;stepTwo&quot;;

        private static final String LINK_OPENED = &quot;linkOpened&quot;;
        private static final String LINK_EXPIRED = &quot;linkExpired&quot;;
        private static final String FORM_DISPLAYED = &quot;linkDisplayed&quot;;
        private static final String DATE_OF_BIRTH_UNKNOWN = &quot;dateOfBirthUnknown&quot;;
        private static final String POSTAL_CODE_UNKNOWN = &quot;postalCodeUnknown&quot;;
        private static final String UNAFFILIATED_PATIENT = &quot;unaffiliatedPatient&quot;;

<span class="fc" id="L98">        public StepTwoEventHandlers(Email email) {</span>
<span class="fc" id="L99">            PASSWORD_RESET_STATS.labels(STEP, LINK_OPENED).inc();</span>
<span class="fc" id="L100">        }</span>

        public void linkExpired() {
<span class="fc" id="L103">            PASSWORD_RESET_STATS.labels(STEP, LINK_EXPIRED).inc();</span>
<span class="fc" id="L104">        }</span>

        public void handleSuccess(VerifiableBits bits) {
<span class="fc bfc" id="L107" title="All 2 branches covered.">            if (bits.unaffiliatedPatient()) {</span>
<span class="fc" id="L108">                PASSWORD_RESET_STATS.labels(STEP, UNAFFILIATED_PATIENT).inc();</span>
            } else {
<span class="fc bfc" id="L110" title="All 2 branches covered.">                if (!bits.hasDateOfBirth()) {</span>
<span class="fc" id="L111">                    PASSWORD_RESET_STATS.labels(STEP, DATE_OF_BIRTH_UNKNOWN).inc();</span>
                }

<span class="fc bfc" id="L114" title="All 2 branches covered.">                if (!bits.hasPostalCode()) {</span>
<span class="fc" id="L115">                    PASSWORD_RESET_STATS.labels(STEP, POSTAL_CODE_UNKNOWN).inc();</span>
                }
            }
<span class="fc" id="L118">            PASSWORD_RESET_STATS.labels(STEP, FORM_DISPLAYED).inc();</span>
<span class="fc" id="L119">        }</span>

        public void handleFailure(ResetStepFailure failure) {
<span class="nc" id="L122">            Match(failure).of(</span>
<span class="nc" id="L123">                    Case($(instanceOf(ResetCodeMismatch.class)), () -&gt; wrap(() -&gt; {</span>
<span class="nc" id="L124">                        PASSWORD_RESET_STATS.labels(STEP, &quot;resetCodeMismatch&quot;).inc();</span>
<span class="nc" id="L125">                    })),</span>
<span class="nc" id="L126">                    noUserByEmail(STEP),</span>
<span class="nc" id="L127">                    notRegistered(STEP),</span>
                    // TODO (utamas) PHR-7119
<span class="nc" id="L129">                    inconsistentDatabase(STEP),</span>
<span class="nc" id="L130">                    unexpectedErrors(STEP),</span>
<span class="nc" id="L131">                    unexpectedError(STEP),</span>
<span class="nc" id="L132">                    defaultCase(STEP));</span>
<span class="nc" id="L133">        }</span>
    }

    public static class StepThreeEventHandler {
        private static final String STEP = &quot;stepThree&quot;;

        // New metrics keys:
        private static final String ATTEMPT_COUNT = &quot;attemptCount&quot;;
        private static final String VERIFIED = &quot;verified&quot;;
        private static final String DEMOGRAPHICS_VERIFICATION_FAILED = &quot;demographicsFailed&quot;;
        private static final String SECURITY_QUESTION_FAILED = &quot;securityQuestionFailed&quot;;

        // Legacy metrics keys:
        private static final String LAST_NAME = &quot;surname&quot;;
        private static final String POSTAL_CODE = &quot;postcode&quot;;
        private static final String DATE_OF_BIRTH = &quot;dob&quot;;
        private static final String EMAIL_NOT_CONFIRMED = &quot;emailnotconfirmed&quot;;
        private static final String SECURITY_QUESTION = &quot;secquestion&quot;;
        private static final String PWD_ALREADY_RESET = &quot;pwdalreadyreset&quot;;

<span class="fc" id="L153">        private static final String SUCCEEDED = Boolean.toString(true);</span>
<span class="fc" id="L154">        private static final String FAILED = Boolean.toString(false);</span>

<span class="fc" id="L156">        private static final Map&lt;String, String&gt; DEMOGRAPHICS_MAPPER = Map(</span>
                LenientPostalCodeValidator.PROPERTY, POSTAL_CODE,
                LenientLastNameValidator.PROPERTY, LAST_NAME,
                LenientDateOfBirthValidator.PROPERTY, DATE_OF_BIRTH);

        @VisibleForTesting
<span class="fc" id="L162">        static final Counter LEGACY_STATS = Counter.build()</span>
<span class="fc" id="L163">                .name(&quot;pkb_phr_web_forgotpasswordformerror&quot;)</span>
<span class="fc" id="L164">                .help(&quot;Errors during filling password reset form &quot;)</span>
<span class="fc" id="L165">                .labelNames(&quot;field&quot;, &quot;success&quot;)</span>
<span class="fc" id="L166">                .register();</span>

        private final UserVerificationCriteria criteria;

<span class="fc" id="L170">        private StepThreeEventHandler(UserVerificationCriteria criteria) {</span>
<span class="fc" id="L171">            this.criteria = criteria;</span>

<span class="fc" id="L173">            PASSWORD_RESET_STATS.labels(STEP, ATTEMPT_COUNT).inc();</span>
<span class="fc" id="L174">        }</span>

        public void handleSuccess(UserVerificationSuccess verified) {
<span class="fc" id="L177">            LOGGER.info(&quot;Submitted details are verified. Allowing actual password reset.&quot;);</span>

<span class="fc" id="L179">            PASSWORD_RESET_STATS.labels(STEP, String.valueOf(verified.user().getUserType())).inc();</span>

<span class="fc" id="L181">            PASSWORD_RESET_STATS.labels(STEP, VERIFIED).inc();</span>

            // Legacy metrics:
<span class="fc" id="L184">            criteria.lastName().ifPresent($ -&gt; LEGACY_STATS.labels(LAST_NAME, SUCCEEDED).inc());</span>
<span class="fc" id="L185">            criteria.dateOfBirth().ifPresent($ -&gt; LEGACY_STATS.labels(DATE_OF_BIRTH, SUCCEEDED).inc());</span>
<span class="fc" id="L186">            criteria.postalCode().ifPresent($ -&gt; LEGACY_STATS.labels(POSTAL_CODE, SUCCEEDED).inc());</span>
<span class="fc" id="L187">            criteria.answer().ifPresent($ -&gt; LEGACY_STATS.labels(SECURITY_QUESTION, SUCCEEDED).inc());</span>
            // due to the label, the value is swapped
<span class="fc" id="L189">            LEGACY_STATS.labels(PWD_ALREADY_RESET, FAILED).inc();</span>
<span class="fc" id="L190">            LEGACY_STATS.labels(EMAIL_NOT_CONFIRMED, FAILED).inc();</span>
<span class="fc" id="L191">        }</span>

        public void handleFailure(ResetStepFailure failure) {
<span class="fc" id="L194">            LOGGER.info(&quot;Email=[{}] failed verification&quot;, criteria.email().address());</span>

<span class="fc" id="L196">            Match(failure).of(</span>
<span class="fc" id="L197">                    Case($(instanceOf(DemographicsMismatch.class)), demographicsMismatch -&gt; wrap(() -&gt; {</span>
<span class="fc" id="L198">                        LOGGER.info(demographicsMismatch.message());</span>
<span class="fc" id="L199">                        PASSWORD_RESET_STATS.labels(STEP, DEMOGRAPHICS_VERIFICATION_FAILED).inc();</span>

<span class="fc" id="L201">                        demographicsMismatch.getProperties()</span>
<span class="fc" id="L202">                                .forEach(property -&gt; LEGACY_STATS.labels(DEMOGRAPHICS_MAPPER.apply(property), FAILED).inc());</span>
<span class="fc" id="L203">                    })),</span>
<span class="pc" id="L204">                    Case($(instanceOf(SecurityAnswerMismatch.class)), securityAnswerMismatch -&gt; wrap(() -&gt; {</span>
<span class="nc" id="L205">                        LOGGER.info(securityAnswerMismatch.message());</span>
<span class="nc" id="L206">                        PASSWORD_RESET_STATS.labels(STEP, SECURITY_QUESTION_FAILED).inc();</span>

                        // demographics verifications passed
<span class="nc" id="L209">                        criteria.lastName().ifPresent($ -&gt; LEGACY_STATS.labels(LAST_NAME, SUCCEEDED).inc());</span>
<span class="nc" id="L210">                        criteria.dateOfBirth().ifPresent($ -&gt; LEGACY_STATS.labels(DATE_OF_BIRTH, SUCCEEDED).inc());</span>
<span class="nc" id="L211">                        criteria.postalCode().ifPresent($ -&gt; LEGACY_STATS.labels(POSTAL_CODE, SUCCEEDED).inc());</span>
<span class="nc" id="L212">                        LEGACY_STATS.labels(SECURITY_QUESTION, FAILED).inc();</span>
<span class="nc" id="L213">                    })),</span>
<span class="pc" id="L214">                    Case($(instanceOf(AlreadyResetByTeamMember.class)), alreadyReset -&gt; wrap(() -&gt; {</span>
<span class="nc" id="L215">                        LOGGER.info(alreadyReset.message());</span>
<span class="nc" id="L216">                        PASSWORD_RESET_STATS.labels(STEP, PWD_ALREADY_RESET).inc();</span>

                        // demographics verifications passed
<span class="nc" id="L219">                        criteria.lastName().ifPresent($ -&gt; LEGACY_STATS.labels(LAST_NAME, SUCCEEDED).inc());</span>
<span class="nc" id="L220">                        criteria.dateOfBirth().ifPresent($ -&gt; LEGACY_STATS.labels(DATE_OF_BIRTH, SUCCEEDED).inc());</span>
<span class="nc" id="L221">                        criteria.postalCode().ifPresent($ -&gt; LEGACY_STATS.labels(POSTAL_CODE, SUCCEEDED).inc());</span>
<span class="nc" id="L222">                        criteria.answer().ifPresent($ -&gt; LEGACY_STATS.labels(SECURITY_QUESTION, SUCCEEDED).inc());</span>
                        // due to the label, tha value is swapped
<span class="nc" id="L224">                        LEGACY_STATS.labels(PWD_ALREADY_RESET, SUCCEEDED).inc();</span>
<span class="nc" id="L225">                    })),</span>
<span class="pc" id="L226">                    Case($(instanceOf(NotRegistered.class)), notRegistered -&gt; wrap(() -&gt; {</span>
<span class="nc" id="L227">                        LOGGER.warn(notRegistered.message());</span>
<span class="nc" id="L228">                        PASSWORD_RESET_STATS.labels(STEP, NOT_REGISTERED).inc();</span>
                        // due to the label, tha value is swapped
<span class="nc" id="L230">                        LEGACY_STATS.labels(EMAIL_NOT_CONFIRMED, SUCCEEDED).inc();</span>
<span class="nc" id="L231">                    })),</span>
<span class="fc" id="L232">                    Case($(instanceOf(TooManyInvalidDOBInputAttempts.class)), invalidAttempts -&gt; wrap(() -&gt; {</span>
<span class="fc" id="L233">                        LOGGER.warn(invalidAttempts.message());</span>
<span class="fc" id="L234">                        PASSWORD_RESET_STATS.labels(STEP, TOO_MANY_FAILED_DOB_ATTEMPTS).inc();</span>
<span class="fc" id="L235">                    })),</span>
<span class="fc" id="L236">                    noUserByEmail(STEP),</span>
<span class="fc" id="L237">                    inconsistentDatabase(STEP),</span>
<span class="fc" id="L238">                    unexpectedErrors(STEP),</span>
<span class="fc" id="L239">                    unexpectedError(STEP),</span>
<span class="fc" id="L240">                    defaultCase(STEP));</span>
<span class="fc" id="L241">        }</span>

        public void handlerUnexpectedFailure(Exception cause) {
<span class="nc" id="L244">            LOGGER.error(&quot;Unexpectedly failed to find candidate for email=[{}]. Root cause:&quot;, criteria.email().address(), cause);</span>
<span class="nc" id="L245">            PASSWORD_RESET_STATS.labels(STEP, UNEXPECTED_ERROR_COUNT).inc();</span>
<span class="nc" id="L246">        }</span>
    }

    private static Void wrap(Runnable task) {
<span class="fc" id="L250">        task.run();</span>
<span class="fc" id="L251">        return null;</span>
    }

    private static Match.Case&lt;NotRegistered, Void&gt; notRegistered(String step) {
<span class="pc" id="L255">        return Case($(instanceOf(NotRegistered.class)), () -&gt; wrap(() -&gt; PASSWORD_RESET_STATS.labels(step, NOT_REGISTERED).inc()));</span>
    }

    private static Match.Case&lt;NoUserByEmail, Void&gt; noUserByEmail(String step) {
<span class="fc" id="L259">        return Case($(instanceOf(NoUserByEmail.class)), noUserByEmail -&gt; wrap(() -&gt; {</span>
<span class="fc" id="L260">            LOGGER.warn(noUserByEmail.message());</span>
<span class="fc" id="L261">            PASSWORD_RESET_STATS.labels(step, NOT_FOUND).inc();</span>
<span class="fc" id="L262">        }));</span>
    }

    private static Match.Case&lt;InconsistentDB, Void&gt; inconsistentDatabase(String step) {
<span class="pc" id="L266">        return Case($(instanceOf(InconsistentDB.class)), inconsistency -&gt; wrap(() -&gt; {</span>
<span class="nc" id="L267">            LOGGER.error(inconsistency.message());</span>
<span class="nc" id="L268">            PASSWORD_RESET_STATS.labels(step, INCONSISTENT).inc();</span>
<span class="nc" id="L269">        }));</span>
    }

    @SuppressWarnings(&quot;NewExceptionWithoutArguments&quot;)
    private static Match.Case&lt;UnexpectedCompositeError, Void&gt; unexpectedErrors(String step) {
<span class="pc" id="L274">        return Case($(instanceOf(UnexpectedCompositeError.class)), compositeError -&gt; wrap(() -&gt; {</span>
<span class="nc" id="L275">            RuntimeException runtimeException = new RuntimeException();</span>

<span class="nc" id="L277">            compositeError.getBits().stream()</span>
<span class="nc" id="L278">                    .filter(error -&gt; UnexpectedError.class.isAssignableFrom(error.getClass()))</span>
<span class="nc" id="L279">                    .map(error -&gt; UnexpectedError.class.cast(error).getCause())</span>
<span class="nc" id="L280">                    .forEach(runtimeException::addSuppressed);</span>

<span class="nc" id="L282">            LOGGER.error(compositeError.message(), runtimeException);</span>

<span class="nc" id="L284">            int errorCount = max(compositeError.getBits().size(), 1);</span>
<span class="nc" id="L285">            PASSWORD_RESET_STATS.labels(step, UNEXPECTED_ERROR_COUNT).inc(errorCount);</span>
<span class="nc" id="L286">        }));</span>
    }

    private static Match.Case&lt;UnexpectedError, Void&gt; unexpectedError(String step) {
<span class="pc" id="L290">        return Case($(instanceOf(UnexpectedError.class)), error -&gt; wrap(() -&gt; {</span>
<span class="nc" id="L291">            LOGGER.error(error.message(), error.getCause());</span>
<span class="nc" id="L292">            PASSWORD_RESET_STATS.labels(step, UNEXPECTED_ERROR_COUNT).inc();</span>
<span class="nc" id="L293">        }));</span>
    }

    private static Match.Case&lt;ResetStepFailure, Void&gt; defaultCase(String step) {
<span class="pc" id="L297">        return Case($(), failure -&gt; wrap(() -&gt; LOGGER.warn(&quot;Unhandled case in step=[{}]: {}: {}&quot;, step, failure.getClass().getSimpleName(), failure.message())));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>