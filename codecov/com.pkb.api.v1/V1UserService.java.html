<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>V1UserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.v1</a> &gt; <span class="el_source">V1UserService.java</span></div><h1>V1UserService.java</h1><pre class="source lang-java linenums">//------------------------------------------------------------------------------
//
// Copyright (c) 2011 PatientsKnowBest, Inc. All Rights Reserved.
//
// $Id: $
//
//------------------------------------------------------------------------------

package com.pkb.api.v1;

import com.pkb.api.aspect.annotation.RequiresScope;
import com.pkb.api.aspect.annotation.Timed;
import com.pkb.api.error.ApiValidationError;
import com.pkb.api.error.RestError;
import com.pkb.api.util.PKBApiHelper;
import com.pkb.api.util.PKBCommonApiParams;
import com.pkb.api.util.UserApiHelper;
import com.pkb.api.util.ValidationRestError;
import com.pkb.api.util.v2.RestUtil;
import com.pkb.api.v1.model.ApiLetterInvitation;
import com.pkb.api.v1.model.ApiReadResponse;
import com.pkb.api.v1.model.ApiUser;
import com.pkb.api.v1.model.ApiUser.ApiUserType;
import com.pkb.api.v1.model.ApiUserPublicId;
import com.pkb.api.v1.model.ApiWriteResponse;
import com.pkb.api.v1.model.ApiWriteResponse.OperationEnum;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.dto.LetterInvitationDTO;
import com.pkb.exception.ValidationException;
import com.pkb.patient.PatientActivationManager;
import com.pkb.service.invitation.impl.InvitationManager;
import com.pkb.service.user.impl.UserManager;
import com.pkb.user.entity.PKBPerson;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import io.swagger.annotations.ApiResponse;
import io.swagger.annotations.ApiResponses;
import io.vavr.control.Try;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import javax.ws.rs.Consumes;
import javax.ws.rs.GET;
import javax.ws.rs.PUT;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.core.MediaType;
import java.util.List;

import static com.pkb.dto.LetterInvitationDTO.EC_DOB;
import static com.pkb.dto.LetterInvitationDTO.EC_IDENTIFIER;
import static com.pkb.dto.LetterInvitationDTO.EC_STATUS;
import static com.pkb.dto.LetterInvitationDTO.EC_SYSTEM_ID;
import static com.pkb.dto.LetterInvitationDTO.EC_USER_TYPE;
import static com.pkb.entities.enums.api.ApiClientScope.CLINICIAN;
import static com.pkb.entities.enums.api.ApiClientScope.PATIENT;
import static com.pkb.entities.enums.api.ApiClientScope.TEAMCOORD;
import static javax.servlet.http.HttpServletResponse.SC_BAD_REQUEST;
import static javax.servlet.http.HttpServletResponse.SC_INTERNAL_SERVER_ERROR;

/**
 * Service to retrieve user (for now, patient) info
 *
 * @author robwhelan
 */
@Path(&quot;/v1/users&quot;)
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
@Component
@Api(tags = { &quot;Users&quot; }, value = &quot;User &amp; Team management service&quot;)
<span class="fc" id="L74">public class V1UserService {</span>

    @Autowired
    private UserManager userManager;

    @Autowired
    private InvitationManager invitationManager;

    @Autowired
    private UserApiHelper userApiHelper;

    @Autowired
    private RestUtil util;

    @Autowired
    private PatientActivationManager patientActivationManager;

    /**
     * Retrieves details of a user, specified by a PKB Id.
     * &lt;p/&gt;
     * &lt;br/&gt;
     * &lt;a href=&quot;http://dev.patientsknowbest.com/home/rest-api/scopes&quot;&gt;&lt;b&gt;Scope&lt;/b&gt;&lt;/a&gt;: PATIENT, CLINICIAN, TEAMCOORD
     *
     * @param userId
     * @param authText
     *            Your bearer token, in the form: Bearer myBearerToken
     */
    @GET
    @Path(&quot;/{userId}&quot;)
    @Timed(hideParams = &quot;userId&quot;)
    @RequiresScope(scopes = { PATIENT, CLINICIAN, TEAMCOORD })
    @ApiOperation(value = &quot;Scope: PATIENT, CLINICIAN, TEAMCOORD&quot;)
    public ApiUser getUserById(
            @PathParam(&quot;userId&quot;) long userId) {

<span class="fc" id="L109">        PKBCommonApiParams params = util.getCommonParams(userId, false);</span>
<span class="fc" id="L110">        PKBPerson loggedInUser = params.getPerson();</span>
        try {
<span class="fc" id="L112">            return userApiHelper.getUser(params.getRequestContext(),</span>
                    userId, loggedInUser);
<span class="nc" id="L114">        } catch (Exception e) {</span>
<span class="nc" id="L115">            throw PKBApiHelper.wrapError(&quot;error getting user&quot;, e);</span>
        }
    }

    /**
     * Patients of the currently logged in user.
     * &lt;p/&gt;
     * &lt;br/&gt;
     * &lt;a href=&quot;http://dev.patientsknowbest.com/home/rest-api/scopes&quot;&gt;&lt;b&gt;Scope&lt;/b&gt;&lt;/a&gt;: CLINICIAN, TEAMCOORD
     *
     * @param authToken
     *            Your bearer token, in the form: Bearer myBearerToken
     */
    @GET
    @Path(&quot;/self/patients&quot;)
    @Timed
    @RequiresScope(scopes = { CLINICIAN, TEAMCOORD })
    @ApiOperation(value = &quot;Scope: CLINICIAN, TEAMCOORD&quot;)
    public ApiReadResponse&lt;ApiUserPublicId&gt; getMyPatients(
            @QueryParam(value = &quot;withMetrics&quot;) Boolean withMetrics,
            @QueryParam(&quot;registeredOnly&quot;) Boolean registeredOnly ) {

<span class="fc" id="L137">        PKBCommonApiParams params = util.getCommonParams();</span>
<span class="fc" id="L138">        PKBPerson loggedInUser = params.getPerson();</span>

<span class="fc bfc" id="L140" title="All 2 branches covered.">        if (withMetrics == null) {</span>
<span class="fc" id="L141">            withMetrics = true;</span>
        }
        try {
            //change link type to ORG
<span class="fc" id="L145">            LoggedInEHRRequestContext context = params.getRequestContext().withAccountLinkType(EHRRequestContext.AccountLinkType.ORG);</span>
<span class="fc" id="L146">            List&lt;ApiUserPublicId&gt; resultList = userApiHelper.getPatientsWithPublicId(</span>
                    context,
                    loggedInUser,
<span class="fc" id="L149">                    withMetrics,</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">                    registeredOnly != null ? registeredOnly : false);</span>

<span class="fc" id="L152">            return PKBApiHelper.buildReadResponse(resultList);</span>

<span class="nc" id="L154">        } catch (Exception e) {</span>
<span class="nc" id="L155">            throw PKBApiHelper.wrapError(&quot;error getting clinician's patients&quot;, e);</span>
        }
    }

    /**
     * This method can be used to perform one of the following actions:
     * &lt;p/&gt;
     * &lt;ul&gt;
     * &lt;li&gt;&lt;b&gt;Create a new user.&lt;/b&gt; A new user will be created if user details
     * are supplied which cannot be found in the database. Note, a national Id
     * is required to create a new patient user. If an email address is
     * supplied, the specified user will be sent a new registration email.&lt;/li&gt;
     * &lt;li&gt;&lt;b&gt;Update an existing user.&lt;/b&gt; An existing user will be updated if
     * user details are supplied which can be found in the database, and the
     * calling user has permission to perform this update.&lt;/li&gt;
     * &lt;li&gt;&lt;b&gt;Invite an existing user to a new team.&lt;/b&gt; An existing patient user
     * will be invited to the team for which the calling user is a coordinator if
     * the specified user exists in the database but has not granted access
     * to the relevant team.&lt;/li&gt;
     * &lt;/ul&gt;
     * &lt;p/&gt;
     * &lt;br/&gt;
     * &lt;a href=&quot;http://dev.patientsknowbest.com/home/rest-api/scopes&quot;&gt;&lt;b&gt;Scope&lt;/b&gt;&lt;/a&gt;: CLINICIAN, TEAMCOORD
     *
     * @param user
     *            The user to be updated, created, or invited to a team.
     * @param authToken
     *            Your bearer token, in the form: Bearer myBearerToken
     * @return The Id of the relevant user, along with the appropriate
     *         action information.
     */
    @PUT
    @Timed
    @RequiresScope(scopes = { CLINICIAN, TEAMCOORD })
    @ApiOperation(value = &quot;Scope: CLINICIAN, TEAMCOORD&quot;, notes = &quot;Creates or Updates a user. A National ID is required to create a patient. If an email address is&quot;
            + &quot; supplied, the specified user will be sent a new registration email.An existing user will be updated if&quot;
            + &quot; user details are supplied which can be found in the database, and the&quot;
            + &quot; calling user has permission to perform this update.&quot;
            + &quot; Invite an existing user to a new team. An existing patient user&quot;
            + &quot; will be invited to the team for which the calling user is a coordinator if&quot;
            + &quot; the specified user exists in the database but has not granted access&quot;
            + &quot; to the relevant team.  If the patient exists but has Sharing Disabled then they will NOT be invited to join the team, NO INDICATION of this&quot;
            + &quot; is returned to the API user to resepect the patients privacy choice.&quot;)
    public ApiWriteResponse updateUser(

            ApiUser user) {
<span class="fc" id="L201">        PKBCommonApiParams params = util.getCommonParams();</span>
<span class="fc" id="L202">        PKBPerson loggedInUser = params.getPerson();</span>
        try {
<span class="fc" id="L204">            ApiWriteResponse response = new ApiWriteResponse();</span>

            // Default to PATIENT for backwards compatibility
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">            if (user.getUserType() == null) {</span>
<span class="nc" id="L208">                user.setUserType(ApiUserType.PATIENT);</span>
            }

            Long userId;
<span class="pc bpc" id="L212" title="1 of 2 branches missed.">            if (!userApiHelper.checkNationalIds(params.getRequestContext(), loggedInUser, user.getNationalIds())) {</span>
<span class="nc" id="L213">                throw new ApiValidationError(&quot;invalid national Id&quot;);</span>
            }
<span class="fc" id="L215">            PKBPerson existingPerson = userApiHelper.searchForUser(params.getRequestContext(), user);</span>
<span class="fc bfc" id="L216" title="All 2 branches covered.">            if (existingPerson != null) {</span>
                // We found someone!
<span class="fc" id="L218">                userId = existingPerson.getId();</span>
                // Helpfully set the PKB Id in case the caller didn't know it.
                // We won't make it here if they exist but differ.
<span class="fc" id="L221">                user.setId(existingPerson.getId());</span>
                // Does the calling user have access to their account?
<span class="fc bfc" id="L223" title="All 2 branches covered.">                if (userApiHelper.hasAccess(params.getRequestContext(), existingPerson.getId())) {</span>
                    // Yes. Update their account information.
<span class="fc" id="L225">                    userApiHelper.updateUser(params.getRequestContext(), loggedInUser, user);</span>
<span class="fc" id="L226">                    response.setOperationPerformed(ApiWriteResponse.OperationEnum.UPDATED);</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">                } else if (existingPerson.isPatient()) {</span>
                    // No, but since this is a patient we can request access instead
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">                    if (existingPerson.isSharingEnabled()){</span>
<span class="fc" id="L230">                        userApiHelper.inviteUser(params.getRequestContext(),loggedInUser,user);</span>
                    }
<span class="fc" id="L232">                    response.setOperationPerformed(ApiWriteResponse.OperationEnum.UPDATED);</span>
                } else {
                    // Cannot invite a clinician yet
<span class="nc" id="L235">                    throw new ApiValidationError(&quot;caller &quot; + loggedInUser.getId() + &quot; does not have access to &quot; + user.getId());</span>
                }
            } else {
<span class="fc bfc" id="L238" title="All 2 branches covered.">                if (user.getUserType() == ApiUserType.PATIENT) {</span>
                    // If we have at least one ID, create a new medical record
<span class="fc bfc" id="L240" title="All 2 branches covered.">                    if (user.hasAnId()) {</span>
<span class="fc" id="L241">                        userId = userApiHelper.createUser(params.getRequestContext(), loggedInUser, user);</span>
<span class="fc" id="L242">                        response.setOperationPerformed(ApiWriteResponse.OperationEnum.CREATED);</span>
                    } else {
                        // We haven't found an existing user and don't have enough information
                        // to create a new patient, so error
<span class="fc" id="L246">                        throw new ApiValidationError(&quot;At least one ID must be provided to create a new medical record&quot;);</span>
                    }
<span class="pc bpc" id="L248" title="1 of 2 branches missed.">                } else if (user.getUserType() == ApiUserType.REG_CLINICIAN) {</span>
                    // Create a new clinician
<span class="fc" id="L250">                    userId = userApiHelper.createUser(params.getRequestContext(), loggedInUser, user);</span>
<span class="fc" id="L251">                    response.setOperationPerformed(ApiWriteResponse.OperationEnum.CREATED);</span>
                } else {
<span class="nc" id="L253">                    throw new ApiValidationError(&quot;invalid user type supplied: &quot; + user.getUserType().name());</span>
                }
            }
<span class="fc" id="L256">            response.setId(&quot;&quot; + userId);</span>

<span class="fc" id="L258">            return response;</span>
<span class="fc" id="L259">        } catch (Exception e) {</span>
<span class="fc" id="L260">            throw PKBApiHelper.wrapError(&quot;error creating, updating or inviting user&quot;, e);</span>
        }
    }

    /**
     * Allows a team coordinator to deactivate a clinician account.
     * &lt;p/&gt;
     * &lt;br/&gt;
     * &lt;a href=&quot;http://dev.patientsknowbest.com/home/rest-api/scopes&quot;&gt;&lt;b&gt;Scope&lt;/b&gt;&lt;/a&gt;: TEAMCOORD
     *
     * @param userId
     * @param authToken
     *            Your bearer token, in the form: Bearer myBearerToken
     * @return
     */
    @PUT
    @Path(&quot;/deactivate&quot;)
    @Timed(hideParams = &quot;userId&quot;)
    @RequiresScope(scopes = TEAMCOORD)
    @ApiOperation(value = &quot;Scope: TEAMCOORD&quot;)
    public ApiWriteResponse deactivateUser(

            @QueryParam(&quot;userId&quot;) long userId) {

        try {
<span class="nc" id="L285">            ApiWriteResponse response = new ApiWriteResponse();</span>

<span class="nc" id="L287">            PKBCommonApiParams params = util.getCommonParams(userId, true);</span>
<span class="nc" id="L288">            PKBPerson user = userManager.getPKBPerson(userId);</span>
<span class="nc bnc" id="L289" title="All 2 branches missed.">            if (user == null) {</span>
<span class="nc" id="L290">                throw new ApiValidationError(&quot;you do not have access to user &quot; + userId);</span>
            }
<span class="nc bnc" id="L292" title="All 2 branches missed.">            if (!userApiHelper.hasAccess(params.getRequestContext(), userId)) {</span>
<span class="nc" id="L293">                throw new ApiValidationError(&quot;you do not have access to user &quot; + userId);</span>
            }
<span class="nc bnc" id="L295" title="All 2 branches missed.">            if (params.getPerson().getIdString().equals(user.getIdString())) {</span>
<span class="nc" id="L296">                throw new ApiValidationError(&quot;you cannot deactivate yourself&quot;);</span>
            }
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (!user.isPro()) {</span>
<span class="nc" id="L299">                throw new ApiValidationError(&quot;you can only deactivate clinicians&quot;);</span>
            }

<span class="nc" id="L302">            userApiHelper.deactivateUser(params.getRequestContext(), params.getPerson(), user);</span>

<span class="nc" id="L304">            response.setOperationPerformed(OperationEnum.UPDATED);</span>
<span class="nc" id="L305">            response.setId(Long.toString(userId));</span>

<span class="nc" id="L307">            return response;</span>

<span class="nc" id="L309">        } catch (Exception e) {</span>
<span class="nc" id="L310">            throw PKBApiHelper.wrapError(&quot;error deactivating user&quot;, e);</span>
        }
    }

    @ApiResponses({
            @ApiResponse(code = SC_BAD_REQUEST, response = ValidationRestError.class, message = &quot;Given patient might not exist or might not fulfill a token registration requirements&quot;
                    + &quot; such as missing DoB, national identifier or local identifier. &quot;
                    + &quot;Token cannot be generated if a patient is already registered. &quot;
                    + &quot;Each error detail consists of error code and list of human readeable messages. &quot;
                    + &quot;Possible error codes: &quot;
                    + &quot;'&quot; + EC_USER_TYPE + &quot;', &quot;
                    + &quot;'&quot; + EC_STATUS + &quot;', &quot;
                    + &quot;'&quot; + EC_IDENTIFIER + &quot;', &quot;
                    + &quot;'&quot; + EC_DOB + &quot;', &quot;
                    + &quot;'&quot; + EC_SYSTEM_ID + &quot;' &quot;),
            @ApiResponse(code = SC_INTERNAL_SERVER_ERROR, response = RestError.class, message = &quot;Error creating access token due to internal server error.&quot;)
    })
    @Path(&quot;/{patientId}/recordAccessToken&quot;)
    @GET
    @Timed(hideParams = &quot;patientId&quot;)
    @RequiresScope(scopes = TEAMCOORD)
    @ApiOperation(value = &quot;Scope: TEAMCOORD&quot;, notes = &quot;Generates an access code and a secret token for a given patient. Generated values are used in postal mail registration.&quot;)
    public ApiLetterInvitation generateLetterInvitation(@PathParam(&quot;patientId&quot;) long patientId) {
        try {
<span class="fc" id="L334">            Try.of(() -&gt; userManager.getPKBPerson(patientId))</span>
<span class="fc" id="L335">                    .getOrElseThrow(() -&gt; new ValidationException(EC_SYSTEM_ID, &quot;No record exists for this patient&quot;));</span>

<span class="fc" id="L337">            PKBCommonApiParams params = util.getCommonParams(patientId);</span>
<span class="fc" id="L338">            LetterInvitationDTO token = patientActivationManager.generateLetterInvitation(params.getRequestContext(), patientId);</span>
<span class="fc" id="L339">            ApiLetterInvitation response = new ApiLetterInvitation();</span>
<span class="fc" id="L340">            response.setInvitationCode(token.getCode());</span>
<span class="fc" id="L341">            response.setStatus(token.getStatus());</span>
<span class="fc" id="L342">            response.setToken(new String(token.getToken()));</span>
<span class="fc" id="L343">            return response;</span>
<span class="fc" id="L344">        } catch (ValidationException e) {</span>
<span class="fc" id="L345">            throw e; // is handled by exception mapper</span>
<span class="nc" id="L346">        } catch (Exception e) {</span>
<span class="nc" id="L347">            throw PKBApiHelper.wrapError(&quot;error creating access token&quot;, e);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>