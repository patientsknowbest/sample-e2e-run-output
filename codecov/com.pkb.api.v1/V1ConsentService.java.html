<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>V1ConsentService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">E2E Tests Coverage Report</a> &gt; <a href="index.source.html" class="el_package">com.pkb.api.v1</a> &gt; <span class="el_source">V1ConsentService.java</span></div><h1>V1ConsentService.java</h1><pre class="source lang-java linenums">package com.pkb.api.v1;

import com.pkb.api.aspect.annotation.RequiresScope;
import com.pkb.api.aspect.annotation.Timed;
import com.pkb.api.util.PKBApiHelper;
import com.pkb.api.util.PKBCommonApiParams;
import com.pkb.api.util.v2.RestUtil;
import com.pkb.api.v1.model.ApiPatientAdditionalConsent;
import com.pkb.api.v1.model.ApiPatientConsent;
import com.pkb.api.v1.model.ApiPatientConsentReason;
import com.pkb.api.v1.model.ApiPatientConsentReason.ApiConsentReason;
import com.pkb.api.v1.model.ApiReadResponse;
import com.pkb.api.v1.model.ApiWriteResponse;
import com.pkb.api.v1.model.ApiWriteResponse.OperationEnum;
import com.pkb.app.entity.EHRRequestContext;
import com.pkb.app.entity.LoggedInEHRRequestContext;
import com.pkb.app.entity.SourceDetails;
import com.pkb.common.datetime.DateTimeService;
import com.pkb.consent.entity.PatientConsent;
import com.pkb.consent.entity.PatientConsentReason;
import com.pkb.datamodel.consent.ImmutablePatientAdditionalConsent;
import com.pkb.datamodel.consent.PatientAdditionalConsent;
import com.pkb.datamodel.consent.PatientAdditionalConsentExisting;
import com.pkb.entities.enums.AccessingEntityType;
import com.pkb.entities.enums.AdditionalConsentId;
import com.pkb.entities.enums.ConsentReason;
import com.pkb.exception.ApiCallMalformedException;
import com.pkb.exception.PKBException;
import com.pkb.institute.entity.Org;
import com.pkb.institute.entity.Team;
import com.pkb.service.patientconsent.DeprecatedPatientConsentManager;
import com.pkb.service.team.TeamManager;
import com.pkb.service.team.TeamUserManager;
import io.swagger.annotations.Api;
import io.swagger.annotations.ApiOperation;
import org.apache.commons.lang3.StringUtils;
import org.jetbrains.annotations.NotNull;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import javax.ws.rs.Consumes;
import javax.ws.rs.GET;
import javax.ws.rs.POST;
import javax.ws.rs.Path;
import javax.ws.rs.PathParam;
import javax.ws.rs.Produces;
import javax.ws.rs.QueryParam;
import javax.ws.rs.WebApplicationException;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.Response;
import java.util.ArrayList;
import java.util.List;

import static com.pkb.entities.enums.api.ApiClientScope.TEAMCOORD;

@Path(&quot;/v1/consents&quot;)
@Produces(MediaType.APPLICATION_JSON)
@Consumes(MediaType.APPLICATION_JSON)
@Component
@Api(tags = {&quot;Consent&quot;}, value = &quot;Consent service&quot;)
<span class="fc" id="L63">public class V1ConsentService {</span>

<span class="fc" id="L65">    private static final Logger LOGGER = LoggerFactory.getLogger(java.lang.invoke.MethodHandles.lookup().lookupClass());</span>

    private TeamUserManager teamUserManager;

    private DeprecatedPatientConsentManager patientConsentManager;

    private TeamManager teamManager;

    private DateTimeService dateTimeService;

    @Autowired
    public void setDeprecatedPatientConsentManager(DeprecatedPatientConsentManager patientConsentManager) {
<span class="fc" id="L77">        this.patientConsentManager = patientConsentManager;</span>
<span class="fc" id="L78">    }</span>

    @Autowired
    public void setTeamUserManager(TeamUserManager teamUserManager) {
<span class="fc" id="L82">        this.teamUserManager = teamUserManager;</span>
<span class="fc" id="L83">    }</span>

    @Autowired
    public void setTeamManager(TeamManager teamManager) {
<span class="fc" id="L87">        this.teamManager = teamManager;</span>
<span class="fc" id="L88">    }</span>

    @Autowired
    public void setDateTimeService(DateTimeService dateTimeService) {
<span class="fc" id="L92">        this.dateTimeService = dateTimeService;</span>
<span class="fc" id="L93">    }</span>

    private RestUtil util;

    @Autowired
    protected void setUtil(RestUtil util) {
<span class="fc" id="L99">        this.util = util;</span>
<span class="fc" id="L100">    }</span>

    /**
     * &lt;br/&gt;
     * &lt;a href=&quot;http://dev.patientsknowbest.com/home/rest-api/scopes&quot;&gt;&lt;b&gt;Scope&lt;/b&gt;&lt;/a&gt;: TEAMCOORD
     *
     * @param teamCode  team code
     * @param patientId patient id
     * @param authToken Your bearer token, in the form: Bearer myBearerToken
     */
    @GET
    @Path(&quot;/byPatient/{patientId}&quot;)
    @Timed(hideParams = &quot;patientId&quot;)
    @RequiresScope(scopes = TEAMCOORD)
    @ApiOperation(value = &quot;Scope: TEAMCOORD&quot;)
    public ApiReadResponse&lt;ApiPatientConsent&gt; getConsentsByPatientId(
            @QueryParam(&quot;teamCode&quot;) String teamCode,
            @PathParam(&quot;patientId&quot;) long patientId) {
<span class="fc" id="L118">        PKBCommonApiParams params = util.getCommonParams(patientId, true);</span>
<span class="fc" id="L119">        Team team = getTeam(teamCode, params);</span>

<span class="fc" id="L121">        ApiReadResponse&lt;ApiPatientConsent&gt; response = new ApiReadResponse&lt;&gt;();</span>
<span class="fc" id="L122">        response.setResults(getConsentsByPatientIdAndTeam(params.getRequestContext(), patientId, team));</span>

<span class="fc" id="L124">        return response;</span>

    }

    /**
     * &lt;br/&gt;
     * &lt;a href=&quot;http://dev.patientsknowbest.com/home/rest-api/scopes&quot;&gt;&lt;b&gt;Scope&lt;/b&gt;&lt;/a&gt;: TEAMCOORD
     *
     * @param teamCode  team code
     * @param patientId patient id
     * @param authToken Your bearer token, in the form: Bearer myBearerToken
     */
    @GET
    @Path(&quot;/additional/byPatient/{patientId}&quot;)
    @Timed(hideParams = &quot;patientId&quot;)
    @RequiresScope(scopes = TEAMCOORD)
    @ApiOperation(value = &quot;Scope: TEAMCOORD&quot;)
    public ApiReadResponse&lt;ApiPatientAdditionalConsent&gt; getAdditionalConsentsByPatientId(
            @QueryParam(&quot;teamCode&quot;) String teamCode,
            @PathParam(&quot;patientId&quot;) long patientId) {
<span class="fc" id="L144">        PKBCommonApiParams params = util.getCommonParams(patientId, true);</span>
<span class="fc" id="L145">        Team team = getTeam(teamCode, params);</span>

<span class="fc" id="L147">        ApiReadResponse&lt;ApiPatientAdditionalConsent&gt; response = new ApiReadResponse&lt;&gt;();</span>
<span class="fc" id="L148">        response.setResults(getAdditionalConsentsByPatientIdAndTeam(params.getRequestContext(), patientId, team));</span>

<span class="fc" id="L150">        return response;</span>

    }

    /**
     * &lt;br/&gt;
     * &lt;a href=&quot;http://dev.patientsknowbest.com/home/rest-api/scopes&quot;&gt;&lt;b&gt;Scope&lt;/b&gt;&lt;/a&gt;: TEAMCOORD
     *
     * @param apiConsent consent
     * @param teamCode   team code
     * @param patientId  patient id
     * @param authToken  Your bearer token, in the form: Bearer myBearerToken
     */
    @POST
    @Path(&quot;/forPatient/{patientId}&quot;)
    @Timed(hideParams = &quot;patientId&quot;)
    @RequiresScope(scopes = TEAMCOORD)
    @ApiOperation(value = &quot;Scope: TEAMCOORD&quot;)
    public ApiWriteResponse setConsentsByPatientId(

            ApiPatientConsent apiConsent,
            @QueryParam(&quot;teamCode&quot;) String teamCode,
            @PathParam(&quot;patientId&quot;) long patientId) {

<span class="fc" id="L174">        PKBCommonApiParams params = util.getCommonParams(patientId, true);</span>
        try {

<span class="fc" id="L177">            ApiWriteResponse response = new ApiWriteResponse();</span>
<span class="fc" id="L178">            Team team = getTeam(teamCode, params);</span>

            // TODO: ID currently ignored; should we error if wrong ID provided?

<span class="fc" id="L182">            PatientConsent existingConsent = patientConsentManager.findPatientConsentWithReasons(params.getRequestContext(), patientId, team.getId(), AccessingEntityType.TEAM).orElse(null);</span>
            Long id;

<span class="pc bpc" id="L185" title="1 of 2 branches missed.">            if (existingConsent == null) {</span>
<span class="nc" id="L186">                PatientConsent consent = new PatientConsent();</span>

                // This operation just for team based consents
<span class="nc" id="L189">                consent.setPatientPersonId(patientId);</span>
<span class="nc" id="L190">                consent.setAccessingEntityType(AccessingEntityType.TEAM);</span>
<span class="nc" id="L191">                consent.setAccessingTeamSlashPersonId(team.getId());</span>
<span class="nc" id="L192">                consent.setGeneralHealthConsentGranted(apiConsent.getGeneralHealthConsentGranted());</span>
<span class="nc" id="L193">                consent.setMentalHealthConsentGranted(apiConsent.getMentalHealthConsentGranted());</span>
<span class="nc" id="L194">                consent.setSexualHealthConsentGranted(apiConsent.getSexualHealthConsentGranted());</span>
<span class="nc" id="L195">                consent.setSocialCareConsentGranted(apiConsent.getSocialCareConsentGranted());</span>
<span class="nc" id="L196">                consent.setDischarged(false);</span>
<span class="nc" id="L197">                consent.setAdded(dateTimeService.now());</span>
<span class="nc" id="L198">                consent.setReasons(convert(apiConsent.getReason(), params.getRequestContext()));</span>

<span class="nc" id="L200">                response.setOperationPerformed(OperationEnum.CREATED);</span>
<span class="nc" id="L201">                id = patientConsentManager.ensureTeamLinkAndUpdatePatientConsentLegacy(params.getRequestContext(), consent);</span>
<span class="nc" id="L202">            } else {</span>

<span class="fc" id="L204">                existingConsent.setGeneralHealthConsentGranted(apiConsent.getGeneralHealthConsentGranted());</span>
<span class="fc" id="L205">                existingConsent.setMentalHealthConsentGranted(apiConsent.getMentalHealthConsentGranted());</span>
<span class="fc" id="L206">                existingConsent.setSexualHealthConsentGranted(apiConsent.getSexualHealthConsentGranted());</span>
<span class="fc" id="L207">                existingConsent.setSocialCareConsentGranted(apiConsent.getSocialCareConsentGranted());</span>

                // TODO: Can patient be discharged via REST API? Would need to add field to ApiPatientConsent
<span class="fc" id="L210">                existingConsent.setDischarged(false);</span>

<span class="fc" id="L212">                PatientConsentReason reason = convert(apiConsent.getReason(), params.getRequestContext());</span>
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">                if (existingConsent.getReasons().getId() != null) {</span>
<span class="fc" id="L214">                    reason.setId(existingConsent.getReasons().getId());</span>
                }

<span class="fc" id="L217">                existingConsent.setReasons(reason);</span>

<span class="fc" id="L219">                id = existingConsent.getId();</span>
<span class="fc" id="L220">                patientConsentManager.ensureTeamLinkAndUpdatePatientConsentLegacy(params.getRequestContext(), existingConsent);</span>
<span class="fc" id="L221">                response.setOperationPerformed(OperationEnum.UPDATED);</span>
            }

<span class="fc" id="L224">            response.setId(&quot;&quot; + id);</span>
<span class="fc" id="L225">            return response;</span>
<span class="nc" id="L226">        } catch (Exception e) {</span>
<span class="nc" id="L227">            throw PKBApiHelper.wrapError(&quot;error setting consents&quot;, e);</span>
        }
    }

    /**
     * &lt;br/&gt;
     * &lt;a href=&quot;http://dev.patientsknowbest.com/home/rest-api/scopes&quot;&gt;&lt;b&gt;Scope&lt;/b&gt;&lt;/a&gt;: TEAMCOORD
     *
     * @param apiAdditionalConsent consent
     * @param teamCode             team code
     * @param patientId            patient id
     * @param authToken            Your bearer token, in the form: Bearer myBearerToken
     */
    @POST
    @Path(&quot;/additional/forPatient/{patientId}&quot;)
    @Timed(hideParams = &quot;patientId&quot;)
    @RequiresScope(scopes = TEAMCOORD)
    @ApiOperation(value = &quot;Scope: TEAMCOORD&quot;)
    public ApiWriteResponse setAdditionalConsentsByPatientId(

            ApiPatientAdditionalConsent apiAdditionalConsent,
            @QueryParam(&quot;teamCode&quot;) String teamCode,
            @PathParam(&quot;patientId&quot;) long patientId) {

<span class="fc" id="L251">        PKBCommonApiParams params = util.getCommonParams(patientId, true);</span>
        try {

<span class="fc" id="L254">            Team team = getTeam(teamCode, params);</span>

<span class="fc" id="L256">            ApiWriteResponse response = new ApiWriteResponse();</span>
<span class="fc" id="L257">            Long id = null;</span>

<span class="fc" id="L259">            boolean found = false;</span>
<span class="fc" id="L260">            List&lt;PatientAdditionalConsentExisting&gt; pacs = teamUserManager.getPatientAdditionalConsentsForTeam(</span>
                    patientId,
<span class="fc" id="L262">                    team.getId());</span>
<span class="pc bpc" id="L263" title="1 of 2 branches missed.">            for (PatientAdditionalConsentExisting pac : pacs) {</span>
<span class="nc bnc" id="L264" title="All 2 branches missed.">                if (pac.getAdditionalConsent().name().equals(apiAdditionalConsent.getAdditionalConsent().name())) {</span>
<span class="nc" id="L265">                    response.setOperationPerformed(OperationEnum.UPDATED);</span>
<span class="nc" id="L266">                    id = pac.getId();</span>
<span class="nc" id="L267">                    found = true;</span>
<span class="nc" id="L268">                    break;</span>
                }
<span class="nc" id="L270">            }</span>

<span class="pc bpc" id="L272" title="1 of 2 branches missed.">            if (!found) {</span>
<span class="fc" id="L273">                PatientAdditionalConsent pac = ImmutablePatientAdditionalConsent.builder()</span>
<span class="fc" id="L274">                        .additionalConsent(AdditionalConsentId.valueOf(apiAdditionalConsent.getAdditionalConsent().name()))</span>
<span class="fc" id="L275">                                .teamId(team.getId())</span>
<span class="fc" id="L276">                                        .patientId(patientId)</span>
<span class="fc" id="L277">                                                .build();</span>

<span class="fc" id="L279">                teamUserManager.updatePatientAdditionalConsentsForTeam(patientId, team.getId(), List.of(pac));</span>
<span class="fc" id="L280">                response.setOperationPerformed(OperationEnum.CREATED);</span>
                // Yuck: re-fetch to get ID
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">                for (PatientAdditionalConsentExisting pac2 : teamUserManager.getPatientAdditionalConsentsForTeam(</span>
<span class="fc" id="L283">                        patientId, team.getId())) {</span>
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">                    if (pac2.getAdditionalConsent().name().equals(apiAdditionalConsent.getAdditionalConsent().name())) {</span>
<span class="fc" id="L285">                        id = pac2.getId();</span>
<span class="fc" id="L286">                        break;</span>
                    }
<span class="nc" id="L288">                }</span>
            }

<span class="fc" id="L291">            response.setId(&quot;&quot; + id);</span>
<span class="fc" id="L292">            return response;</span>
<span class="nc" id="L293">        } catch (Exception e) {</span>
<span class="nc" id="L294">            throw PKBApiHelper.wrapError(&quot;error setting consents&quot;, e);</span>
        }
    }

    private List&lt;ApiPatientConsent&gt; getConsentsByPatientIdAndTeam(@NotNull LoggedInEHRRequestContext requestContext, long patientId,
                                                                  Team team) {

        PatientConsent consent;

        try {
<span class="fc" id="L304">            consent = patientConsentManager.findPatientConsentWithReasons(requestContext, patientId, team.getId(), AccessingEntityType.TEAM).orElse(null);</span>
<span class="nc" id="L305">        } catch (RuntimeException e) {</span>
<span class="nc" id="L306">            throw new WebApplicationException(e.getMessage(), e, Response.Status.INTERNAL_SERVER_ERROR);</span>
<span class="fc" id="L307">        }</span>

<span class="fc" id="L309">        List&lt;ApiPatientConsent&gt; apiConsents = new ArrayList&lt;&gt;();</span>
<span class="pc bpc" id="L310" title="1 of 2 branches missed.">        if (consent != null) {</span>

            // Get primary consents
<span class="fc" id="L313">            ApiPatientConsent apiCon = new ApiPatientConsent();</span>
<span class="fc" id="L314">            apiCon.setId(consent.getId());</span>
<span class="fc" id="L315">            apiCon.setGeneralHealthConsentGranted(consent.isGeneralHealthConsentGranted());</span>
<span class="fc" id="L316">            apiCon.setSexualHealthConsentGranted(consent.isSexualHealthConsentGranted());</span>
<span class="fc" id="L317">            apiCon.setMentalHealthConsentGranted(consent.isMentalHealthConsentGranted());</span>
<span class="fc" id="L318">            apiCon.setSocialCareConsentGranted(consent.isSocialCareConsentGranted());</span>

            // Get primary consent reasons
<span class="fc" id="L321">            PatientConsentReason reason = consent.getReasons();</span>
<span class="pc bpc" id="L322" title="1 of 2 branches missed.">            if (reason != null) {</span>
<span class="fc" id="L323">                ApiPatientConsentReason apiReason = new ApiPatientConsentReason();</span>
<span class="fc" id="L324">                apiReason.setId(reason.getId());</span>

<span class="fc" id="L326">                ConsentReason consentReason = reason.getGeneralHealthConsentGrantedReason();</span>

<span class="pc bpc" id="L328" title="1 of 2 branches missed.">                if (consentReason != null) {</span>
<span class="fc" id="L329">                    apiReason.setGeneralHealthConsentGrantedReason(ApiConsentReason.valueOf(consentReason.name()));</span>
<span class="fc" id="L330">                    apiReason.setGeneralHealthConsentGrantedReasonText(reason.getGeneralHealthConsentGrantedReasonText());</span>
                }

<span class="fc" id="L333">                consentReason = reason.getSexualHealthConsentGrantedReason();</span>

<span class="pc bpc" id="L335" title="1 of 2 branches missed.">                if (consentReason != null) {</span>
<span class="fc" id="L336">                    apiReason.setSexualHealthConsentGrantedReason(ApiConsentReason.valueOf(consentReason.name()));</span>
<span class="fc" id="L337">                    apiReason.setSexualHealthConsentGrantedReasonText(reason.getSexualHealthConsentGrantedReasonText());</span>
                }

<span class="fc" id="L340">                consentReason = reason.getMentalHealthConsentGrantedReason();</span>
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">                if (consentReason != null) {</span>
<span class="fc" id="L342">                    apiReason.setMentalHealthConsentGrantedReason(ApiConsentReason.valueOf(consentReason.name()));</span>
<span class="fc" id="L343">                    apiReason.setMentalHealthConsentGrantedReasonText(reason.getMentalHealthConsentGrantedReasonText());</span>
                }

<span class="fc" id="L346">                consentReason = reason.getSocialCareConsentGrantedReason();</span>
<span class="pc bpc" id="L347" title="1 of 2 branches missed.">                if (consentReason != null) {</span>
<span class="fc" id="L348">                    apiReason.setSocialCareConsentGrantedReason(ApiConsentReason.valueOf(consentReason.name()));</span>
<span class="fc" id="L349">                    apiReason.setSocialCareConsentGrantedReasonText(reason.getSocialCareConsentGrantedReasonText());</span>
                }

<span class="fc" id="L352">                apiCon.setReason(apiReason);</span>
            }

<span class="fc" id="L355">            apiConsents.add(apiCon);</span>
        }

<span class="fc" id="L358">        return apiConsents;</span>
    }

    private List&lt;ApiPatientAdditionalConsent&gt; getAdditionalConsentsByPatientIdAndTeam(EHRRequestContext requestContext,
                                                                                      long patientId, Team team) {

<span class="fc" id="L364">        List&lt;ApiPatientAdditionalConsent&gt; apiAdditionalConsents = new ArrayList&lt;&gt;();</span>

        List&lt;PatientAdditionalConsentExisting&gt; additionalConsents;
        try {
<span class="fc" id="L368">            additionalConsents = teamUserManager.getPatientAdditionalConsentsForTeam(patientId, team.getId());</span>
<span class="nc" id="L369">        } catch (PKBException e) {</span>
<span class="nc" id="L370">            throw new WebApplicationException(e.getMessage(), e, Response.Status.INTERNAL_SERVER_ERROR);</span>
<span class="fc" id="L371">        }</span>

<span class="pc bpc" id="L373" title="1 of 2 branches missed.">        for (PatientAdditionalConsentExisting pac : additionalConsents) {</span>
<span class="nc" id="L374">            ApiPatientAdditionalConsent apiPAC = new ApiPatientAdditionalConsent();</span>
<span class="nc" id="L375">            apiPAC.setId(pac.getId());</span>
<span class="nc" id="L376">            apiPAC.setAdditionalConsent(AdditionalConsentId.valueOf(pac.getAdditionalConsent().name()));</span>
<span class="nc" id="L377">            apiPAC.setTeamCode(team.getCode());</span>
<span class="nc" id="L378">            apiAdditionalConsents.add(apiPAC);</span>
<span class="nc" id="L379">        }</span>

<span class="fc" id="L381">        return apiAdditionalConsents;</span>
    }

    private PatientConsentReason convert(ApiPatientConsentReason apiReason, LoggedInEHRRequestContext requestContext) {
<span class="fc" id="L385">        PatientConsentReason pcr = new PatientConsentReason(new SourceDetails(requestContext));</span>
<span class="fc" id="L386">        pcr.setGeneralHealthConsentGrantedReason(</span>
<span class="fc" id="L387">                ConsentReason.valueOf(apiReason.getGeneralHealthConsentGrantedReason().name()));</span>
<span class="fc" id="L388">        pcr.setGeneralHealthConsentGrantedReasonText(apiReason.getGeneralHealthConsentGrantedReasonText());</span>
<span class="fc" id="L389">        pcr.setSexualHealthConsentGrantedReason(</span>
<span class="fc" id="L390">                ConsentReason.valueOf(apiReason.getSexualHealthConsentGrantedReason().name()));</span>
<span class="fc" id="L391">        pcr.setSexualHealthConsentGrantedReasonText(apiReason.getSexualHealthConsentGrantedReasonText());</span>
<span class="fc" id="L392">        pcr.setMentalHealthConsentGrantedReason(</span>
<span class="fc" id="L393">                ConsentReason.valueOf(apiReason.getMentalHealthConsentGrantedReason().name()));</span>
<span class="fc" id="L394">        pcr.setMentalHealthConsentGrantedReasonText(apiReason.getMentalHealthConsentGrantedReasonText());</span>
<span class="fc" id="L395">        pcr.setSocialCareConsentGrantedReason(</span>
<span class="fc" id="L396">                ConsentReason.valueOf(apiReason.getSocialCareConsentGrantedReason().name()));</span>
<span class="fc" id="L397">        pcr.setSocialCareConsentGrantedReasonText(apiReason.getSocialCareConsentGrantedReasonText());</span>
<span class="fc" id="L398">        return pcr;</span>
    }

    private Team getTeam(String teamCode, PKBCommonApiParams params) {

        try {
<span class="fc" id="L404">            Team team = teamUserManager.getPrimaryTeam(params.getRequestContext(), params.getPerson().getId(), true);</span>
<span class="pc bpc" id="L405" title="1 of 2 branches missed.">            if (StringUtils.isNotBlank(teamCode)) {</span>
<span class="nc" id="L406">                Team requestedTeam = teamManager.getTeamByCode(teamCode);</span>
                // Re-fetch to help Hibernate
<span class="nc" id="L408">                Org org = teamManager.getOrg(team.getOrg().getId(), Org.Lazy.TEAMS).orElse(null);</span>
<span class="nc bnc" id="L409" title="All 2 branches missed.">                if (org.getTeams().contains(requestedTeam)) {</span>
<span class="nc" id="L410">                    team = requestedTeam;</span>
                } else {
<span class="nc" id="L412">                    String message = &quot;requested Team is not available to caller&quot;;</span>
<span class="nc" id="L413">                    LOGGER.error(message);</span>
<span class="nc" id="L414">                    throw new ApiCallMalformedException(message);</span>
                }
            }

<span class="fc" id="L418">            return team;</span>

<span class="nc" id="L420">        } catch (ApiCallMalformedException e) {</span>
<span class="nc" id="L421">            throw new WebApplicationException(e.getMessage(), e, Response.Status.UNAUTHORIZED);</span>
<span class="nc" id="L422">        } catch (Exception e) {</span>
<span class="nc" id="L423">            throw new WebApplicationException(e.getMessage(), e, Response.Status.INTERNAL_SERVER_ERROR);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>